<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成績登錄 - 班級綜合成績紀錄系統</title>
    <style>
        :root { --primary-color: #4a90e2; --secondary-color: #f5f5ff; --font-color: #333; --border-color: #ddd; }
        body { font-family: 'Biaukaifang TC', 'DFKai-SB', 'Kaiti', kai-serif, serif; margin: 0; background-color: var(--secondary-color); color: var(--font-color); }
        /* 【新增此段】強制所有表單元件繼承 body 的字體 */
        button, input, select, textarea {
            font-family: inherit;
        }
		header { background-color: var(--primary-color); color: white; padding: 0.6rem 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        header h1 { font-size: 1.6em; margin: 0; }
        header button { background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 1em; }
        main { padding: 20px; max-width: 1000px; margin: auto; }
        .section { background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h2, h3 { color: #333; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        input, button, textarea { padding: 10px; margin: 5px 0; font-size: 1em; border-radius: 4px; border: 1px solid var(--border-color); box-sizing: border-box; }
        button { background-color: var(--primary-color); color: white; cursor: pointer; border: none; }
        
        /* 【【【版面優化 3】】】: 調整表單佈局 */
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            align-items: flex-end; 
        }
        .form-grid label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .form-grid input {
            width: 100%;
        }
        /* 【【【版面優化 3】】】: 結束 */

        #create-section.disabled { opacity: 0.5; pointer-events: none; }
        #student-scores-container { margin-top: 20px; }
        .score-entry-header, .score-entry { display: grid; grid-template-columns: 40px 1fr 120px 2fr; gap: 15px; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-weight: bold; color: #555;}
        .score-entry { font-weight: normal; }
        .score-entry:last-child { border-bottom: none; }
        .score-entry input { width: 100%; text-align: center; }
        #history-list { list-style-type: none; padding: 0; }
        
        .history-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 6px; /* 【【【版面優化 3】】】: 再次縮小間距 */
            background-color: #f9f9f9;
        }
        .history-item:hover { background-color: #eef; }
        .history-item-content {
            flex-grow: 1;
            display: flex;
            align-items: baseline;
            gap: 10px;
            min-width: 0;
            cursor: pointer;
        }
        .history-item-title {
            font-weight: bold;
            font-size: 1.1em;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .history-item-comment {
            font-size: 0.9em;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-item-meta, .history-item-actions {
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }
        .history-item-stats {
            font-size: 0.9em;
            color: #333;
            white-space: nowrap;
        }
        .history-item-actions .delete-btn {
            background-color: #e74c3c;
            font-size: 0.8em;
            padding: 5px 8px;
            margin-left: 15px;
        }

        @media (max-width: 600px) {
            .score-entry-header, .score-entry {
                grid-template-columns: 30px 1fr 70px 1.5fr;
                gap: 10px;
                font-size: 0.9em;
            }
            .score-entry input {
                padding: 8px 4px;
            }
            main {
                padding: 10px;
            }
            .history-item-stats {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1 id="header-title">成績登錄</h1>
        <div><a href="./teacher.html" style="color: white; text-decoration: none;"><button>返回主頁</button></a><button id="logout-btn">登出</button></div>
    </header>
    <main id="app-container" style="display: none;">
        <div id="create-section" class="section">
            <h2 id="class-header"></h2>
            <div class="form-grid">
                <div>
                    <label for="new-assignment-name">成績項目名稱：</label>
                    <input type="text" id="new-assignment-name" placeholder="例如: 數習 P.10-12">
                </div>
                <div>
                    <label for="new-general-comment">成績說明 (選填)：</label>
                    <input type="text" id="new-general-comment" placeholder="例如: 全班普遍不佳">
                </div>
            </div>
            <button id="create-assignment-btn" style="margin-top: 10px;">建立新成績單</button>
        </div>
        <div class="section"><h3>歷史成績項目 (點擊項目內容可編輯)</h3><ul id="history-list"><li id="history-loading">載入中...</li></ul></div>
        <div id="grade-entry-section" class="section" style="display: none;">
            <h3 id="current-assignment-title"></h3>
            <div class="form-grid">
                <div>
                    <label for="edit-assignment-name">成績項目名稱：</label>
                    <input type="text" id="edit-assignment-name">
                </div>
                <div>
                    <label for="edit-general-comment">成績說明 (選填)：</label>
                    <input type="text" id="edit-general-comment">
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button class="save-grades-btn" style="background-color: #28a745; padding: 12px 25px;">儲存成績</button>
                <button class="cancel-edit-btn" style="background-color: #777; margin-left:10px;">取消</button>
            </div>
            <hr>
            <div id="student-scores-container">
                <div class="score-entry-header"><span>座號</span><span>姓名</span><span>分數</span><span>個別註解 (選填)</span></div>
            </div>
            <div style="margin-top: 20px;">
                <button class="save-grades-btn" style="background-color: #28a745; padding: 12px 25px;">儲存成績</button>
                <button class="cancel-edit-btn" style="background-color: #777; margin-left:10px;">取消</button>
            </div>
        </div>
    </main>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAn17zhvzLRCS3qOb6PWA464cGNu1D7WzA", authDomain: "stu001-e72fa.firebaseapp.com", projectId: "stu001-e72fa", storageBucket: "stu001-e72fa.appspot.com", messagingSenderId: "852359717475", appId: "1:852359717475:web:db9a6a5d737978874c8e56" };
        firebase.initializeApp(firebaseConfig);
// 【【【新增此函式】】】
        function convertClassName(oldClassName) {
            if (typeof oldClassName !== 'string' || oldClassName.length < 3) return oldClassName;
            const firstDigit = oldClassName.charAt(0);
            const restOfName = oldClassName.substring(1);
            switch (firstDigit) {
                case '7': return '1' + restOfName;
                case '8': return '2' + restOfName;
                case '9': return '3' + restOfName;
                default: return oldClassName;
            }
        }
        const db = firebase.firestore(); const auth = firebase.auth();
        let currentUser = null, classId = null, studentsInClass = [], currentAssignmentId = null;
        const appContainer = document.getElementById('app-container'), createSection = document.getElementById('create-section'), createBtn = document.getElementById('create-assignment-btn'), saveBtns = document.querySelectorAll('.save-grades-btn'), cancelBtns = document.querySelectorAll('.cancel-edit-btn'), gradeEntrySection = document.getElementById('grade-entry-section'), scoresContainer = document.getElementById('student-scores-container'), newAssignmentNameInput = document.getElementById('new-assignment-name'), newGeneralCommentInput = document.getElementById('new-general-comment'), editAssignmentNameInput = document.getElementById('edit-assignment-name'), editGeneralCommentInput = document.getElementById('edit-general-comment'), currentAssignmentTitle = document.getElementById('current-assignment-title'), historyList = document.getElementById('history-list');
        auth.onAuthStateChanged(async (user) => { if (user) { currentUser = user; const userDoc = await db.collection('users').doc(user.uid).get(); if (userDoc.exists && userDoc.data().role === 'teacher') { await initializeGradesPage(userDoc.data()); } else { alert('權限不足或帳號設定錯誤。'); window.location.href = 'login.html'; } } else { window.location.href = 'login.html'; } });
        async function initializeGradesPage(userData) { const urlParams = new URLSearchParams(window.location.search); classId = urlParams.get('class'); if (!classId) { appContainer.innerHTML = '<h2>錯誤：未指定班級。</h2>'; appContainer.style.display = 'block'; return; } document.getElementById('class-header').textContent = `${convertClassName(classId)} 班 成績管理`; if (!userData.rosterId) { alert('帳號未綁定名冊'); return; } const rosterDoc = await db.collection('rosters').doc(userData.rosterId).get(); if (!rosterDoc.exists) { alert('找不到名冊'); return; } studentsInClass = rosterDoc.data().students.filter(s => s.id.startsWith(classId)).sort((a,b) => a.id.localeCompare(b.id)); setupKeyboardNavigation(); loadHistory(); appContainer.style.display = 'block'; }
        function setupKeyboardNavigation() { scoresContainer.addEventListener('keydown', (e) => { if (e.key === 'Enter' && e.target.classList.contains('score-input')) { e.preventDefault(); const allScoreInputs = Array.from(scoresContainer.querySelectorAll('.score-input')); const currentIndex = allScoreInputs.indexOf(e.target); if (currentIndex > -1 && currentIndex < allScoreInputs.length - 1) { const nextInput = allScoreInputs[currentIndex + 1]; nextInput.focus(); nextInput.select(); } else { saveBtns[1].focus(); } } }); }
        function toggleCreateSection(enabled) { createSection.style.opacity = enabled ? '1' : '0.5'; createSection.style.pointerEvents = enabled ? 'auto' : 'none'; }
        function displayGradeEntry(assignmentName, generalComment = '', scoresData = {}) { currentAssignmentTitle.textContent = currentAssignmentId ? `編輯成績：${assignmentName}` : `登錄新成績：${assignmentName}`; editAssignmentNameInput.value = assignmentName; editGeneralCommentInput.value = generalComment; scoresContainer.innerHTML = '<div class="score-entry-header"><span>座號</span><span>姓名</span><span>分數</span><span>個別註解 (選填)</span></div>'; studentsInClass.forEach(student => { const scoreInfo = scoresData[student.id] || {}; const entryDiv = document.createElement('div'); entryDiv.className = 'score-entry'; entryDiv.innerHTML = `<span>${student.id.substring(3)}</span><label>${student.name}</label><input type="number" class="score-input" data-student-id="${student.id}" value="${scoreInfo.score ?? ''}" placeholder="分數"><input type="text" class="comment-input" data-student-id="${student.id}" value="${scoreInfo.comment || ''}" placeholder="個別註解">`; scoresContainer.appendChild(entryDiv); }); gradeEntrySection.style.display = 'block'; toggleCreateSection(false); }
        createBtn.addEventListener('click', () => { const newAssignmentName = newAssignmentNameInput.value.trim(); if (!newAssignmentName) { alert('請先輸入成績項目名稱！'); return; } currentAssignmentId = null; displayGradeEntry(newAssignmentName, newGeneralCommentInput.value.trim()); saveBtns.forEach(btn => btn.textContent = '儲存新成績'); });
        cancelBtns.forEach(btn => btn.addEventListener('click', () => { gradeEntrySection.style.display = 'none'; newAssignmentNameInput.value = ''; newGeneralCommentInput.value = ''; currentAssignmentId = null; toggleCreateSection(true); }));
        saveBtns.forEach(btn => { btn.addEventListener('click', async () => { const scoresData = {}; scoresContainer.querySelectorAll('.score-entry').forEach(entry => { const studentId = entry.querySelector('.score-input').dataset.studentId; const score = entry.querySelector('.score-input').value.trim(); const comment = entry.querySelector('.comment-input').value.trim(); if (score !== '' || comment !== '') { scoresData[studentId] = {}; if (score !== '') scoresData[studentId].score = parseFloat(score); if (comment !== '') scoresData[studentId].comment = comment; } }); const assignmentName = editAssignmentNameInput.value.trim(); if (!assignmentName) { alert('成績項目名稱不可為空！'); return; } const assignmentData = { assignmentName, className: classId, date: firebase.firestore.FieldValue.serverTimestamp(), generalComment: editGeneralCommentInput.value.trim(), scores: scoresData, teacherId: currentUser.uid }; try { const assignmentsRef = db.collection('gradebooks').doc(currentUser.uid).collection('assignments'); if (currentAssignmentId) { await assignmentsRef.doc(currentAssignmentId).update(assignmentData); alert(`已更新成績項目：${assignmentName}`); } else { await assignmentsRef.add(assignmentData); alert(`已儲存新成績項目：${assignmentName}`); } cancelBtns[0].click(); } catch (error) { console.error("儲存成績失敗:", error); alert("儲存失敗！"); } }); });
        
        function loadHistory() {
            db.collection('gradebooks').doc(currentUser.uid).collection('assignments')
              .where('className', '==', classId)
              .orderBy('date', 'desc')
              .onSnapshot(snapshot => {
                historyList.innerHTML = '';
                if (snapshot.empty) {
                    historyList.innerHTML = '<li>尚無歷史成績項目。</li>';
                    return;
                }
                snapshot.forEach(doc => {
                    const a = doc.data();
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.dataset.id = doc.id;

                    let studentCount = 0;
                    let totalScore = 0;
                    if (a.scores) {
                        for (const studentId in a.scores) {
                            if (a.scores[studentId].score !== undefined && a.scores[studentId].score !== null) {
                                studentCount++;
                                totalScore += a.scores[studentId].score;
                            }
                        }
                    }
                    const averageScore = studentCount > 0 ? (totalScore / studentCount).toFixed(1) : 'N/A';
                    const dateString = a.date ? a.date.toDate().toLocaleDateString() : '日期未知';
                    const commentText = a.generalComment || '';
                    
                    li.innerHTML = `
                        <div class="history-item-content">
                            <span class="history-item-title">${a.assignmentName} (${dateString})</span>
                            <span class="history-item-comment">${commentText}</span>
                        </div>
                        <div class="history-item-meta">
                            <span class="history-item-stats">人數: <strong>${studentCount}</strong> | 平均: <strong>${averageScore}</strong></span>
                        </div>
                        <div class="history-item-actions">
                            <button class="delete-btn" data-id="${doc.id}">刪除</button>
                        </div>
                    `;
                    
                    li.querySelector('.history-item-content').addEventListener('click', (e) => {
                        currentAssignmentId = doc.id;
                        displayGradeEntry(a.assignmentName, a.generalComment, a.scores);
                        saveBtns.forEach(btn => btn.textContent = '更新儲存');
                    });
                    historyList.appendChild(li);
                });
            }, error => {
                console.error("讀取歷史成績失敗:", error);
                historyList.innerHTML = '<li>讀取歷史紀錄時發生錯誤。</li>';
            });
        }

        historyList.addEventListener('click', async (e) => { if (e.target.closest('.delete-btn')) { e.stopPropagation(); const docId = e.target.closest('.delete-btn').dataset.id; if(confirm('確定要刪除這個成績項目及其所有成績嗎？')) { try { await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').doc(docId).delete(); alert('刪除成功！'); if(currentAssignmentId === docId) { cancelBtns[0].click(); } } catch(error) { alert("刪除失敗！"); } } } });
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut().then(() => { window.location.href = 'login.html'; }); });
    </script>
</body>
</html>
