<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>é€²ä½ç³»çµ±åŸç†ï¼šå‹•æ…‹è¦å‰‡èˆ‡ç²¾æº–é‹ç®—ç‰ˆ</title>
    <style>
        /* Reset & Base */
        body { font-family: 'Microsoft JhengHei', sans-serif; text-align: center; background-color: #121212; color: #e0e0e0; overflow: hidden; margin: 0; }
        
        .container { 
            position: relative; width: 100vw; height: 100vh; 
            display: flex; flex-direction: column; justify-content: flex-start; 
            align-items: center; padding-top: 40px; box-sizing: border-box;
        }
        
        /* æ¨™é¡Œç³»çµ± */
        .title { 
            font-size: 3em; margin: 0 0 10px 0; 
            color: #bb86fc; opacity: 0; transform: translateY(-30px); transition: all 0.5s ease; 
            text-shadow: 0 0 10px rgba(187,134,252,0.3); flex-shrink: 0;
        }
        .subtitle { 
            font-size: 1.5em; color: #03dac6; opacity: 0; transform: translateY(30px); transition: all 0.5s ease; 
            margin-bottom: 20px; height: 1.5em; flex-shrink: 0;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            position: fixed; top: 20px; right: 20px;
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px);
            padding: 15px 25px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center; gap: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.6); z-index: 2000;
        }
        .control-row { display: flex; gap: 10px; align-items: center; justify-content: center; width: 100%; }
        .btn {
            background: transparent; border: 1px solid #fff; color: #fff; padding: 6px 12px;
            border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; white-space: nowrap;
        }
        .btn:hover { background: #fff; color: #121212; }
        .btn.active { background: #03dac6; border-color: #03dac6; color: #000; font-weight: bold;}
        .btn-nav { border-color: #bb86fc; color: #bb86fc; font-weight: bold; min-width: 80px;}
        .btn-nav:hover { background: #bb86fc; color: #000; }
        .page-indicator { font-size: 0.9em; color: #aaa; min-width: 40px; text-align: center; }

        /* é¡¯ç¤ºå€å¡Š */
        .display-area {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            gap: 20px; width: 95%; max-width: 1600px; opacity: 0; transition: opacity 0.5s;
            overflow-y: auto; padding-bottom: 20px;
        }
        .display-area::-webkit-scrollbar { width: 8px; }
        .display-area::-webkit-scrollbar-track { background: #121212; }
        .display-area::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* Phase 1 & 2 æ¨£å¼ */
        .counter-card {
            background: #1f1b24; border: 4px solid #333; border-radius: 20px;
            padding: 40px 50px; min-width: 350px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative;
            display: flex; flex-direction: column; align-items: center; margin: auto;
        }
        .rule-tag {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            background: #cf6679; color: white; padding: 8px 25px; border-radius: 15px;
            font-weight: bold; font-size: 1.4em; box-shadow: 0 5px 10px rgba(0,0,0,0.5); white-space: nowrap; z-index: 10; border: 2px solid #fff;
        }
        .digit-container { display: flex; justify-content: center; align-items: flex-end; gap: 15px; margin: 40px 0; height: 120px; }
        .digit-box {
            width: 80px; height: 100px; background: #333; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            font-size: 4em; font-weight: bold; font-family: 'Courier New', monospace;
            color: #fff; border: 2px solid #555; position: relative; transition: all 0.2s;
        }
        .digit-box.changed { border-color: #03dac6; color: #03dac6; transform: scale(1.1); }
        .digit-box.reset { border-color: #cf6679; color: #cf6679; }
        .carry-particle { position: absolute; top: 0; left: 0; color: #ff5252; font-weight: bold; font-size: 1.5em; pointer-events: none; opacity: 0; z-index: 100; }
        .process-info { font-size: 1.5em; color: #aaa; height: 40px; margin-bottom: 10px;}
        .plus-indicator { color: #03dac6; font-weight: bold; opacity: 0; font-size: 1.5em; position: absolute; bottom: -40px; right: 15px;}

        /* Phase 3 æ¨£å¼ (è¦å‰‡èˆ‡ç¯„ä¾‹) */
        .rule-box { background: #1e1e1e; padding: 40px; border-radius: 20px; border: 2px solid #03dac6; text-align: center; width: 90%; margin: auto; }
        .calc-container { display: flex; justify-content: center; align-items: flex-start; gap: 50px; margin-top: 30px; width: 100%; }
        .digit-column { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        .d-row { padding: 10px; min-width: 80px; text-align: center; height: 60px; display: flex; align-items: center; justify-content: center; }
        
        /* 1. ä¸Šæ–¹æ•¸å­— */
        .d-digit { 
            font-size: 4em; font-weight: bold; font-family: 'Courier New', monospace; 
            background: #333; border: 2px solid #555; border-radius: 10px; color: #fff;
            width: 80px; height: 80px; z-index: 2;
        }
        
        /* 2. ç®­é ­ */
        .d-arrow { font-size: 2em; color: #666; opacity: 0; transition: opacity 0.5s; }
        
        /* 3. å…¬å¼åˆ— */
        .d-formula { 
            font-size: 1.6em; color: #aaa; border-bottom: 1px solid #555; padding-bottom: 5px; white-space: nowrap; font-family: 'Times New Roman', serif; 
            opacity: 0; transition: opacity 0.5s; min-width: 120px;
        }
        .formula-digit-target { display: inline-block; width: 1em; text-align: center; color: transparent; } 
        
        /* 4. çµæœåˆ— */
        .d-val { font-size: 2em; color: #03dac6; font-weight: bold; opacity: 0; transition: opacity 0.5s; }
        
        /* ä¸‹æ‹‰å‹•ç•«ç”¨çš„é£›è¡Œæ•¸å­— */
        .flying-digit {
            position: fixed; font-size: 4em; font-weight: bold; font-family: 'Courier New', monospace;
            color: #fff; pointer-events: none; z-index: 9999; transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1), color 0.8s;
        }

        .total-sum-box { margin-top: 40px; font-size: 2.5em; border-top: 3px double #fff; padding-top: 20px; width: 80%; opacity: 0; transition: opacity 0.5s; }
        .math-base { font-family: 'Times New Roman', serif; font-size: 1.1em; }
        sup.math-exp { font-size: 0.6em; vertical-align: super; position: relative; top: -0.5em; color: #ffb74d; margin-right: 5px; }
        .pos-indicator { font-size: 0.8em; color: #ffb74d; margin-top: 5px; opacity: 0; transition: opacity 0.5s;}

        /* Phase 4: æ¬¡æ–¹è¡¨ */
        .phase4-container { display: flex; width: 100%; justify-content: center; gap: 40px; margin: auto; }
        .power-list-left { background: #1e1e1e; padding: 20px 40px; border-radius: 15px; border: 1px solid #333; text-align: left; font-size: 1.8em; display: flex; flex-direction: column; gap: 10px; height: fit-content; }
        .unit-ladder-right { background: #1e1e1e; padding: 30px; border-radius: 15px; border: 1px solid #333; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 1.8em; }
        .unit-row { display: flex; align-items: center; gap: 20px; padding: 15px; background: #2c2c2c; border-radius: 10px; width: 100%; opacity: 0; transform: translateX(30px); transition: all 0.5s; border: 1px solid #444; }
        .unit-math { color: #90caf9; min-width: 150px; text-align: left; }
        .unit-name { color: #03dac6; font-weight: bold; min-width: 120px; text-align: center; font-size: 1.2em; }
        .unit-example { color: #aaa; font-size: 0.7em; text-align: left; flex-grow: 1; border-left: 2px solid #555; padding-left: 15px; }
        .connector-row { color: #ffb74d; font-size: 0.8em; display: flex; flex-direction: column; align-items: center; opacity: 0; transition: opacity 0.5s; margin: 5px 0; }
        .connector-arrow { font-size: 1.5em; line-height: 0.8em; }
        .connector-text { font-size: 0.8em; background: #121212; padding: 2px 10px; border-radius: 10px; border: 1px solid #555;}

        /* Phase 5 æ¨£å¼ */
        .subtraction-step { display: flex; justify-content: space-between; align-items: center; font-size: 1.6em; width: 100%; margin: 10px 0; opacity: 0; border-bottom: 1px dashed #333; padding-bottom: 5px;}
        .binary-collection { display: flex; gap: 10px; justify-content: center; margin-top: 20px; font-size: 2.5em; font-family: 'Courier New', monospace; min-height: 1.5em; }
        .collected-bit { color: #03dac6; opacity: 0; transform: translateY(-20px); transition: all 0.5s; }

    </style>
</head>
<body>

    <div class="control-panel">
        <div class="control-row">
            <button class="btn btn-nav" onclick="changePage(-1)">â® ä¸Šä¸€ç« </button>
            <span class="page-indicator" id="pageIndicator">1 / 5</span>
            <button class="btn btn-nav" onclick="changePage(1)">ä¸‹ä¸€ç«  â­</button>
        </div>
        <div class="control-row" style="margin-top:5px; border-top:1px solid #555; padding-top:10px;">
            <button class="btn" id="playPauseBtn" onclick="togglePause()" style="width: 100%;">â¸ æš«åœ</button>
        </div>
        <div class="control-row">
            <span style="font-size: 0.8em; color: #aaa;">é€Ÿåº¦:</span>
            <button class="btn" onclick="setSpeed(0.5)">0.5x</button>
            <button class="btn active" onclick="setSpeed(1)">1x</button>
            <button class="btn" onclick="setSpeed(2)">2x</button>
            <button class="btn" onclick="setSpeed(5)">5x</button>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <h1 class="title" id="mainTitle">é€²ä½ç³»çµ±å…¨è§£æ</h1>
        <p class="subtitle" id="subTitle">æœ€å¤§æ•¸å­— = é€²ä½åŸºæ•¸ - 1</p>
        
        <div id="contentArea" class="display-area">
            </div>
    </div>

    <script>
        // === æ ¸å¿ƒæ§åˆ¶ ===
        let isPaused = false;
        let timeScale = 1.0;
        let currentPhase = 1;
        let skipSignal = false;
        const TOTAL_PHASES = 5;

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('playPauseBtn');
            btn.innerText = isPaused ? "â–¶ æ’­æ”¾" : "â¸ æš«åœ";
            btn.style.background = isPaused ? "#03dac6" : "transparent";
            btn.style.color = isPaused ? "#000" : "#fff";
        }

        function setSpeed(speed) {
            timeScale = speed;
            document.querySelectorAll('.control-panel .btn:not(.btn-nav)').forEach(b => {
                if(b.id !== 'playPauseBtn') b.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function changePage(delta) {
            currentPhase += delta;
            if (currentPhase > TOTAL_PHASES) currentPhase = 1;
            if (currentPhase < 1) currentPhase = TOTAL_PHASES;
            skipSignal = true;
            updatePageIndicator();
        }

        function updatePageIndicator() {
            document.getElementById('pageIndicator').innerText = `${currentPhase} / ${TOTAL_PHASES}`;
        }

        function wait(ms) {
            return new Promise(resolve => {
                if (skipSignal) { resolve(true); return; }
                const checkInterval = 50;
                let elapsed = 0;
                const timer = setInterval(() => {
                    if (skipSignal) { clearInterval(timer); resolve(true); } 
                    else if (!isPaused) {
                        elapsed += checkInterval * timeScale;
                        if (elapsed >= ms) { clearInterval(timer); resolve(false); }
                    }
                }, checkInterval);
            });
        }

        const titleEl = document.getElementById('mainTitle');
        const subTitleEl = document.getElementById('subTitle');
        const contentArea = document.getElementById('contentArea');

        function updateHeader(t, s) {
            titleEl.style.opacity = 0; subTitleEl.style.opacity = 0;
            setTimeout(() => { titleEl.innerText = t; subTitleEl.innerText = s; titleEl.style.opacity = 1; subTitleEl.style.opacity = 1; }, 500);
        }

        function clearContent() {
            contentArea.style.opacity = 0;
            return new Promise(resolve => setTimeout(() => { contentArea.innerHTML = ''; contentArea.style.opacity = 1; resolve(); }, 500));
        }

        function numToChar(val) { return (val < 10) ? val : String.fromCharCode(55 + val); }

        // === ä¸»å¾ªç’° ===
        async function masterLoop() {
            updatePageIndicator();
            while(true) {
                skipSignal = false;
                let interrupted = false;
                switch(currentPhase) {
                    case 1: interrupted = await runPhase1(); break;
                    case 2: interrupted = await runPhase2(); break;
                    case 3: interrupted = await runPhase3(); break;
                    case 4: interrupted = await runPhase4(); break;
                    case 5: interrupted = await runPhase5(); break;
                }
                if (!interrupted) {
                    currentPhase++;
                    if (currentPhase > TOTAL_PHASES) currentPhase = 1;
                    updatePageIndicator();
                }
            }
        }

        // === Phase 1: é€²ä½æ³•å‰‡ ===
        async function runPhase1() {
            updateHeader("1. é€²ä½åˆ¶çš„é»ƒé‡‘æ³•å‰‡", "åŸºæ•¸æ˜¯ Xï¼Œæœ€å¤§ç¬¦è™Ÿå°±æ˜¯ X-1");
            await clearContent();
            if(await wait(1000)) return true;

            const ruleDiv = document.createElement('div');
            ruleDiv.style.fontSize = "2.2em"; ruleDiv.style.textAlign = "left"; ruleDiv.style.lineHeight = "1.8em";
            ruleDiv.innerHTML = `
                <div>10 é€²ä½ (0~9) â®• æœ€å¤§ç¬¦è™Ÿ <span style="color:#cf6679; font-weight:bold">9</span></div>
                <div> 2 é€²ä½ (0~1) â®• æœ€å¤§ç¬¦è™Ÿ <span style="color:#cf6679; font-weight:bold">1</span></div>
                <div> 5 é€²ä½ (0~4) â®• æœ€å¤§ç¬¦è™Ÿ <span style="color:#cf6679; font-weight:bold">4</span></div>
                <div> 7 é€²ä½ (0~6) â®• æœ€å¤§ç¬¦è™Ÿ <span style="color:#cf6679; font-weight:bold">6</span></div>
                <div>16 é€²ä½ (0~F) â®• æœ€å¤§ç¬¦è™Ÿ <span style="color:#cf6679; font-weight:bold">F (15)</span></div>
            `;
            contentArea.appendChild(ruleDiv);
            setTimeout(()=>contentArea.style.opacity = 1, 100);
            return await wait(5000);
        }

        // === Phase 2: é€²ä½æ¼”ç¤º ===
        async function runPhase2() {
            updateHeader("2. ä¾åºåŠ  1ï¼Œè§€å¯Ÿé€²ä½", "è«‹æ³¨æ„é€²ä½å¾Œçš„æ•¸å­—è®€æ³•");
            await clearContent();
            const bases = [
                { name: "10 é€²ä½ (Decimal)", base: 10, max: 9, countTo: 11, color: "#90caf9" },
                { name: "2 é€²ä½ (Binary)", base: 2, max: 1, countTo: 4, color: "#cf6679" }, 
                { name: "5 é€²ä½ (Quinary)", base: 5, max: 4, countTo: 6, color: "#fff176" }, 
                { name: "7 é€²ä½ (Septenary)", base: 7, max: 6, countTo: 8, color: "#ffb74d" }, 
                { name: "16 é€²ä½ (Hex)", base: 16, max: 15, countTo: 17, color: "#03dac6" } 
            ];

            for (let bInfo of bases) {
                if(skipSignal) return true;
                await clearContent();
                let maxText = bInfo.base === 16 ? "F (15)" : bInfo.max;
                let readTip = (bInfo.base === 10) ? "ç¿’æ…£è®€æ³•ï¼šåã€åä¸€" : `âš ï¸ æ³¨æ„ï¼šè«‹è®€ä½œã€Œ1 0ã€è€Œéã€Œåã€ï¼`;
                updateHeader(bInfo.name, readTip);
                
                const card = document.createElement('div');
                card.className = 'counter-card'; card.style.borderColor = bInfo.color;
                card.innerHTML = `
                    <div class="rule-tag" style="background:${bInfo.color}; color:#121212">MAX = ${maxText}</div>
                    <div class="digit-container" id="digitBoxContainer"><div class="digit-box" id="digit-0">0</div></div>
                    <div class="process-info" id="processInfo">æº–å‚™é–‹å§‹...</div>
                `;
                contentArea.appendChild(card);
                if(await wait(1000)) return true;

                const digitContainer = document.getElementById('digitBoxContainer');
                const processInfo = document.getElementById('processInfo');
                let currentDigits = [0]; 

                function renderDigits() {
                    digitContainer.innerHTML = '';
                    for(let i = currentDigits.length - 1; i >= 0; i--) {
                        let div = document.createElement('div');
                        div.className = 'digit-box'; div.id = `digit-${i}`;
                        div.innerText = numToChar(currentDigits[i]); div.style.borderColor = bInfo.color;
                        digitContainer.appendChild(div);
                    }
                }

                for(let k = 1; k <= bInfo.countTo; k++) {
                    if(skipSignal) return true;
                    processInfo.innerText = `+1`;
                    if(await wait(500)) return true;

                    let pos = 0; let carry = true;
                    let targetDigit = document.getElementById(`digit-${pos}`);
                    if (!targetDigit) { renderDigits(); targetDigit = document.getElementById(`digit-${pos}`); }

                    let plusInd = document.createElement('div');
                    plusInd.className = 'plus-indicator'; plusInd.innerText = '+1';
                    targetDigit.appendChild(plusInd);
                    setTimeout(() => { plusInd.style.opacity = 1; plusInd.style.transform = 'translateY(0)'; }, 50);
                    if(await wait(800)) return true;

                    while (carry) {
                        if (pos >= currentDigits.length) {
                            currentDigits.push(0);
                            let newDigit = document.createElement('div');
                            newDigit.className = 'digit-box'; newDigit.id = `digit-${pos}`;
                            newDigit.innerText = '0'; newDigit.style.borderColor = bInfo.color;
                            digitContainer.prepend(newDigit);
                            if(await wait(100)) return true;
                        }
                        let currentVal = currentDigits[pos];
                        let dom = document.getElementById(`digit-${pos}`);

                        if (currentVal < bInfo.max) {
                            currentDigits[pos]++;
                            dom.innerText = numToChar(currentDigits[pos]);
                            dom.classList.add('changed');
                            setTimeout(() => dom.classList.remove('changed'), 300);
                            carry = false;
                        } else {
                            processInfo.innerText = "ğŸ’¥ æ»¿äº†ï¼é€²ä½ï¼";
                            dom.classList.add('reset'); 
                            if(await wait(400)) return true;
                            
                            currentDigits[pos] = 0; dom.innerText = '0';
                            if(await wait(200)) return true;
                            dom.classList.remove('reset');

                            let particle = document.createElement('div');
                            particle.className = 'carry-particle'; particle.innerText = '+1';
                            dom.appendChild(particle);
                            particle.animate([
                                { opacity: 1, transform: 'translate(0, 0)' },
                                { opacity: 0, transform: 'translate(-100px, -20px)' } 
                            ], { duration: 600, easing: 'ease-out' });
                            if(await wait(500)) return true;
                            pos++;
                        }
                    }
                    processInfo.innerText = "";
                    if(plusInd && plusInd.parentNode) plusInd.remove();
                    if(await wait(1000)) return true;
                }
                if(await wait(2000)) return true;
            }
            return false;
        }

        // === Phase 3: è½‰å› 10 é€²ä½ (é€šç”¨è¦å‰‡+ç¯„ä¾‹) ===
        async function runPhase3() {
            updateHeader("3. è½‰å› 10 é€²ä½ï¼šé€šç”¨è¦å‰‡", "å°‡æ¯å€‹ä½æ•¸æ‹†é–‹ï¼Œåˆ†åˆ¥è¨ˆç®—");
            await clearContent();
            if(await wait(500)) return true;

            // 1. è¦å‰‡é  (å‹•æ…‹åŒ–)
            const ruleBox = document.createElement('div');
            ruleBox.className = 'rule-box'; ruleBox.style.border = "none";
            contentArea.appendChild(ruleBox);

            let ruleContainer = document.createElement('div');
            ruleContainer.className = 'calc-container';
            ruleBox.appendChild(ruleContainer);

            const vars = ['a', 'b', 'c', 'd', 'e'];
            const varColor = ['#cf6679', '#fff176', '#ffb74d', '#03dac6', '#90caf9'];
            let lenRule = vars.length;
            let ruleColumns = [];

            // Step 1: å»ºç«‹è®Šæ•¸åˆ— (åªé¡¯ç¤ºæœ€ä¸Šæ–¹)
            for(let i=0; i<lenRule; i++) {
                let power = lenRule - 1 - i;
                let col = document.createElement('div');
                col.className = 'digit-column';
                col.style.opacity = 1; col.style.transform = "translateY(0)";
                col.innerHTML = `
                    <div class="d-row d-digit" id="rule-digit-${i}" style="border-color:${varColor[i]}">${vars[i]}</div>
                    <div class="pos-indicator" id="rule-pos-${i}" style="opacity:0">ç¬¬ ${power} ä½</div>
                    <div class="d-arrow" id="rule-arrow-${i}">â¬‡</div>
                    <div class="d-row d-formula" id="rule-formula-${i}">
                        <span class="formula-digit-target" id="rule-target-${i}">${vars[i]}</span> 
                        Ã— N<sup>${power}</sup>
                    </div>
                    <div class="d-arrow" id="rule-arrow2-${i}" style="opacity:0">â¬‡</div>
                    <div class="d-row d-val" id="rule-res-${i}" style="opacity:0">
                        ${vars[i]}Ã—N<sup>${power}</sup>
                    </div>
                `;
                ruleContainer.appendChild(col);
                ruleColumns.push(col);
            }
            setTimeout(()=>contentArea.style.opacity = 1, 100);
            if(await wait(1500)) return true;

            // Step 2: è¦å‰‡ä¸‹æ‹‰å‹•ç•«
            for(let i=0; i<lenRule; i++) {
                if(skipSignal) return true;
                
                // é¡¯ç¤ºä¸‹æ–¹åŸºåº•
                let formulaEl = document.getElementById(`rule-formula-${i}`);
                let posEl = document.getElementById(`rule-pos-${i}`);
                formulaEl.style.opacity = 1;
                posEl.style.opacity = 1;
                if(await wait(500)) return true;

                // é£›è¡Œè®Šæ•¸
                let digitEl = document.getElementById(`rule-digit-${i}`);
                let targetEl = document.getElementById(`rule-target-${i}`);
                let rectStart = digitEl.getBoundingClientRect();
                let rectEnd = targetEl.getBoundingClientRect();

                let flying = document.createElement('div');
                flying.className = 'flying-digit';
                flying.innerText = vars[i];
                flying.style.left = rectStart.left + 'px';
                flying.style.top = rectStart.top + 'px';
                flying.style.color = varColor[i];
                document.body.appendChild(flying);

                requestAnimationFrame(() => {
                    flying.style.transform = `translate(${rectEnd.left - rectStart.left}px, ${rectEnd.top - rectStart.top}px) scale(0.6)`;
                });

                if(await wait(800)) { flying.remove(); return true; }
                
                flying.remove();
                document.getElementById(`rule-arrow-${i}`).style.opacity = 1;
                targetEl.style.color = varColor[i];
                
                if(await wait(300)) return true;
            }

            // é¡¯ç¤ºç¸½å’Œå…¬å¼
            let sumBoxRule = document.createElement('div');
            sumBoxRule.className = 'total-sum-box';
            sumBoxRule.innerHTML = `<div style="font-size:0.5em; color:#aaa; margin-bottom:10px;">ç¸½å’Œï¼š</div>
                <span style="color:#cf6679">a</span>N<sup>4</sup> + 
                <span style="color:#fff176">b</span>N<sup>3</sup> + 
                <span style="color:#ffb74d">c</span>N<sup>2</sup> + 
                <span style="color:#03dac6">d</span>N<sup>1</sup> + 
                <span style="color:#90caf9">e</span>N<sup>0</sup>
            `;
            ruleBox.appendChild(sumBoxRule);
            setTimeout(()=>sumBoxRule.style.opacity = 1, 100);
            if(await wait(6000)) return true;


            // 2. ç¯„ä¾‹æ¼”ç¤º (ä¿®æ­£æœ€å¾Œä¸€ä½æ™‚é–“)
            const examples = [
                { title: "ç¯„ä¾‹ 0ï¼š10 é€²ä½ (3ä½æ•¸) å°ç…§", numStr: "958", base: 10, digits: [9, 5, 8], color: "#90caf9" },
                { title: "ç¯„ä¾‹ 1ï¼š2 é€²ä½ (5ä½æ•¸)", numStr: "10110", base: 2, digits: [1, 0, 1, 1, 0], color: "#cf6679" },
                { title: "ç¯„ä¾‹ 2ï¼š5 é€²ä½ (3ä½æ•¸)", numStr: "123", base: 5, digits: [1, 2, 3], color: "#fff176" },
                { title: "ç¯„ä¾‹ 3ï¼š16 é€²ä½ (2ä½æ•¸)", numStr: "2F", base: 16, digits: ["2", "F"], realValues: [2, 15], color: "#03dac6" }
            ];

            for (let ex of examples) {
                if(skipSignal) return true;
                updateHeader(ex.title, `åŸºåº•ï¼š${ex.base} é€²ä½`);
                await clearContent();
                
                let container = document.createElement('div');
                container.className = 'calc-container';
                contentArea.appendChild(container);
                
                let len = ex.digits.length;
                let calculatedValues = [];

                // Step 1: å»ºç«‹æ‰€æœ‰æ¬„ä½
                for (let i = 0; i < len; i++) {
                    let dSym = ex.digits[i]; 
                    let power = len - 1 - i; 
                    
                    let col = document.createElement('div');
                    col.className = 'digit-column';
                    col.style.opacity = 1; col.style.transform = "translateY(0)";

                    col.innerHTML = `
                        <div class="d-row d-digit" id="col-digit-${i}" style="border-color:${ex.color}">${dSym}</div>
                        <div class="pos-indicator" id="pos-ind-${i}" style="opacity:0">ç¬¬ ${power} ä½</div>
                        <div class="d-arrow" id="arrow-${i}">â¬‡</div>
                        <div class="d-row d-formula" id="formula-${i}">
                            <span class="formula-digit-target" id="target-${i}">0</span> 
                            Ã— <span class="math-base">${ex.base}</span><sup class="math-exp">${power}</sup>
                        </div>
                        <div class="d-arrow" id="arrow2-${i}" style="opacity:0">â¬‡</div>
                        <div class="d-row d-val" id="res-${i}">0</div>
                    `;
                    container.appendChild(col);
                }
                setTimeout(()=>contentArea.style.opacity = 1, 100);
                if(await wait(1500)) return true;

                // Step 2: é€æ¬„å‹•ç•«
                for (let i = 0; i < len; i++) {
                    if(skipSignal) return true;
                    
                    let dSym = ex.digits[i]; 
                    let dVal = ex.realValues ? ex.realValues[i] : dSym; 
                    let power = len - 1 - i; 
                    let colVal = dVal * Math.pow(ex.base, power);
                    calculatedValues.push(colVal);

                    let digitEl = document.getElementById(`col-digit-${i}`);
                    let posIndEl = document.getElementById(`pos-ind-${i}`);
                    let arrowEl = document.getElementById(`arrow-${i}`);
                    let formulaEl = document.getElementById(`formula-${i}`);
                    let targetEl = document.getElementById(`target-${i}`);
                    let arrow2El = document.getElementById(`arrow2-${i}`);
                    let resEl = document.getElementById(`res-${i}`);

                    formulaEl.style.opacity = 1;
                    posIndEl.style.opacity = 1;
                    if(await wait(500)) return true;

                    let rectStart = digitEl.getBoundingClientRect();
                    let rectEnd = targetEl.getBoundingClientRect();

                    let flying = document.createElement('div');
                    flying.className = 'flying-digit';
                    flying.innerText = dSym;
                    flying.style.left = rectStart.left + 'px';
                    flying.style.top = rectStart.top + 'px';
                    flying.style.color = ex.color; 
                    document.body.appendChild(flying); 

                    requestAnimationFrame(() => {
                        flying.style.transform = `translate(${rectEnd.left - rectStart.left}px, ${rectEnd.top - rectStart.top}px) scale(0.6)`;
                    });

                    if(await wait(800)) { flying.remove(); return true; }

                    flying.remove();
                    arrowEl.style.opacity = 1;
                    targetEl.innerText = dVal; 
                    targetEl.style.color = ex.color;
                    
                    if (dSym != dVal) {
                        targetEl.innerText = `${dSym} â†’ ${dVal}`;
                        targetEl.style.width = "auto";
                    }

                    if(await wait(500)) return true;

                    arrow2El.style.opacity = 1;
                    resEl.innerText = colVal;
                    resEl.style.opacity = 1;

                    if(await wait(800)) return true;
                }
                
                // ä¿®æ­£é‡é»ï¼šåœ¨æœ€å¾Œä¸€ä½æ•¸å‹•ç•«å®Œæˆå¾Œï¼Œå¤šç­‰ä¸€ä¸‹æ‰é¡¯ç¤ºç¸½å’Œ
                if(await wait(500)) return true;

                // Step 3: ç¸½å’Œ
                let totalSum = calculatedValues.reduce((a, b) => a + b, 0);
                let sumExp = calculatedValues.join(" + ");
                let sumBox = document.createElement('div');
                sumBox.className = 'total-sum-box';
                sumBox.innerHTML = `<div style="font-size:0.5em; color:#aaa; margin-bottom:10px;">å°‡ä¸‹æ–¹æ•¸å€¼åŠ ç¸½ï¼š</div>${sumExp} = <span style="color:${ex.color}; font-weight:bold">${totalSum}</span>`;
                contentArea.appendChild(sumBox);
                
                // æ²å‹•åˆ°åº•éƒ¨ç¢ºä¿ç¸½å’Œå¯è¦‹
                contentArea.scrollTop = contentArea.scrollHeight;
                
                setTimeout(() => sumBox.style.opacity = 1, 100);
                if(await wait(6000)) return true;
            }
            return false;
        }

        // === Phase 4: æ¬¡æ–¹è¡¨èˆ‡å–®ä½ ===
        async function runPhase4() {
            updateHeader("4. å¿…å‚™å¸¸è­˜ï¼š2 çš„æ¬¡æ–¹", "10é€²ä½è½‰2é€²ä½çš„å¥½å¹«æ‰‹ & å–®ä½æ›ç®—");
            await clearContent();
            if(await wait(500)) return true;

            const container = document.createElement('div');
            container.className = 'phase4-container';
            contentArea.appendChild(container);

            const leftCol = document.createElement('div');
            leftCol.className = 'power-list-left';
            for(let i=0; i<=10; i++) {
                let row = document.createElement('div');
                row.style.opacity = 0;
                row.innerHTML = `2<sup style="color:#ffb74d">${i}</sup> = ${Math.pow(2, i)}`;
                leftCol.appendChild(row);
                setTimeout(()=>row.style.opacity=1, i*100);
            }
            container.appendChild(leftCol);
            if(await wait(2000)) return true;

            const rightCol = document.createElement('div');
            rightCol.className = 'unit-ladder-right';
            const units = [
                { p: 10, val: "1K", name: "(Kilo)", ex: "ç´”æ–‡å­—æª” / å°åœ–ç¤º" },
                { p: 20, val: "1M", name: "(Mega)", ex: "æ‰‹æ©Ÿç…§ç‰‡ / MP3" },
                { p: 30, val: "1G", name: "(Giga)", ex: "é›»å½± / è¨˜æ†¶é«” (RAM)" },
                { p: 40, val: "1T", name: "(Tera)", ex: "é›»è…¦ç¡¬ç¢Ÿ (HDD/SSD)" }
            ];
            container.appendChild(rightCol);

            for(let i=0; i<units.length; i++) {
                if(skipSignal) return true;
                let u = units[i];
                let row = document.createElement('div');
                row.className = 'unit-row';
                row.innerHTML = `
                    <div class="unit-math">2<sup style="color:#ffb74d">${u.p}</sup> â‰ˆ ${u.val}</div>
                    <div class="unit-name">${u.name}</div>
                    <div class="unit-example">å¸¸è¦‹æ–¼ï¼š${u.ex}</div>
                `;
                rightCol.appendChild(row);
                setTimeout(()=> { row.style.opacity=1; row.style.transform='translateX(0)'; }, 100);
                if(await wait(1500)) return true;

                if (i < units.length - 1) {
                    let conn = document.createElement('div');
                    conn.className = 'connector-row';
                    conn.innerHTML = `
                        <div class="connector-arrow">â†“</div>
                        <div class="connector-text">Ã— 2<sup style="font-size:0.7em">10</sup> (ç´„ Ã— 1000)</div>
                        <div class="connector-arrow">â†“</div>
                    `;
                    rightCol.appendChild(conn);
                    setTimeout(()=>conn.style.opacity=1, 100);
                    if(await wait(500)) return true;
                }
            }
            if(await wait(5000)) return true;
            return false;
        }

        // === Phase 5: æ¸›æ³•è½‰æ› ===
        async function runPhase5() {
            updateHeader("5. 10é€²ä½è½‰2é€²ä½ (æ¸›æ³•æ³•)", "å¾æœ€å¤§æ¬¡æ–¹é–‹å§‹æ¸›");
            await clearContent();
            if(await wait(1000)) return true;
            
            let targetNum = 85;
            let steps = [
                { pow: 6, val: 64, bit: 1, rem: 21 }, { pow: 5, val: 32, bit: 0, rem: 21 },
                { pow: 4, val: 16, bit: 1, rem: 5 }, { pow: 3, val: 8,  bit: 0, rem: 5 },
                { pow: 2, val: 4,  bit: 1, rem: 1 }, { pow: 1, val: 2,  bit: 0, rem: 1 },
                { pow: 0, val: 1,  bit: 1, rem: 0 }
            ];

            let calcDiv = document.createElement('div');
            calcDiv.className = 'rule-box';
            calcDiv.innerHTML = `<div style="font-size:2em; margin-bottom:20px;">ç›®æ¨™ï¼š<span style="color:#fff176">${targetNum}</span></div>`;
            
            let resultBox = document.createElement('div');
            resultBox.className = 'binary-collection';
            resultBox.innerHTML = `çµæœï¼š( <span id="bitCollector"></span> )<sub>2</sub>`;

            contentArea.appendChild(calcDiv);
            calcDiv.appendChild(resultBox); 

            for(let s of steps) {
                if(skipSignal) return true;
                let row = document.createElement('div');
                row.className = 'subtraction-step';
                let bitColor = s.bit ? "#03dac6" : "#555";
                let logicText = s.bit ? `${targetNum} - ${s.val} = <span style="color:#fff176">${s.rem}</span>` : `${targetNum} ä¸å¤ æ¸› ${s.val}`;
                
                row.innerHTML = `
                    <span style="font-size:0.8em; color:#aaa">2<sup class="math-exp" style="color:#aaa">${s.pow}</sup> (${s.val})</span>
                    <span>${logicText}</span>
                    <span style="font-size:1.5em; color:${bitColor}; font-weight:bold">${s.bit}</span>
                `;
                
                calcDiv.insertBefore(row, resultBox);
                if(s.bit) targetNum = s.rem; 
                
                setTimeout(()=> row.style.opacity = 1, 100);
                
                let bitSpan = document.createElement('span');
                bitSpan.className = 'collected-bit';
                bitSpan.innerText = s.bit;
                bitSpan.style.color = bitColor;
                document.getElementById('bitCollector').appendChild(bitSpan);
                setTimeout(()=> { bitSpan.style.opacity = 1; bitSpan.style.transform = 'translateY(0)'; }, 500);

                // æ²å‹•ä¿æŒæœ€æ–°è¡Œåœ¨è¦–é‡å…§
                contentArea.scrollTop = contentArea.scrollHeight;

                if(await wait(1200)) return true;
            }
            if(await wait(5000)) return true;
            return false;
        }

        // å•Ÿå‹•
        masterLoop();

    </script>
</body>
</html>
