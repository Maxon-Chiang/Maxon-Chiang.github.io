<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿå¹³æ™‚è¡¨ç¾ç´€éŒ„ç³»çµ±</title>

    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f5f5;
            --font-color: #333;
            --border-color: #ddd;
            --danger-color: #d0021b;
            --success-color: #7ed321;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: var(--secondary-color);
            color: var(--font-color);
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.6rem 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 1.6em;
            margin: 0;
        }

        #app-container {
            padding: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .class-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }

        .class-title {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-size: 1.5em;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .class-score-span {
            font-size: 0.8em;
            font-weight: normal;
            color: #666;
            margin-left: 8px;
        }

        .student-select {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: #fff;
            cursor: pointer;
        }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; position: relative; }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #000; }
        #modal-student-info { font-size: 1.2em; margin-bottom: 1.5rem; padding: 1rem; background-color: var(--secondary-color); border-radius: 5px; }
        .form-container, .records-container { margin-top: 1.5rem; }
        
        #add-record-form { 
            display: flex; 
            gap: 10px; 
        }

        #add-record-form input { 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        #record-points {
            width: 90px;
        }

        #record-text {
            flex-grow: 1;
            width: 100%;
        }

        #add-record-form button { 
            padding: 10px 15px; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }

        #records-list { max-height: 300px; overflow-y: auto; border-top: 1px solid var(--border-color); margin-top: 1rem; }
        .record-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .record-details { flex-grow: 1; }
        .record-points { font-weight: bold; font-size: 1.1em; margin-right: 15px; }
        .record-points.positive { color: var(--success-color); }
        .record-points.negative { color: var(--danger-color); }
        .record-text { color: #555; }
        .record-timestamp { font-size: 0.8em; color: #999; margin-top: 4px; }
        .record-actions button { background: none; border: none; cursor: pointer; margin-left: 8px; font-size: 1em; }
        .delete-btn { color: var(--danger-color); }

        @media (max-width: 600px) {
            #app-container {
                padding: 1rem;
            }
            .class-card {
                padding: 1rem;
            }
            header h1 {
                font-size: 1.3em;
            }
            .class-title {
                font-size: 1.3em;
            }
            .student-select {
                padding: 10px;
                font-size: 0.95em;
            }
            .modal-content {
                margin: 5% auto;
            }
        }
    </style>
    </head>
<body>
    <header>
        <h1>å­¸ç”Ÿå¹³æ™‚è¡¨ç¾ç´€éŒ„ç³»çµ±</h1>
    </header>
    
    <main id="app-container">
        </main>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modal-title">å­¸ç”Ÿç´€éŒ„</h2>
            <div id="modal-student-info"></div>
            
            <div class="form-container">
                <h3>æ–°å¢ç´€éŒ„</h3>
                <form id="add-record-form">
                    <input type="number" id="record-points" placeholder="åŠ /æ¸›åˆ†">
                    <input type="text" id="record-text" placeholder="æ–‡å­—ç´€éŒ„">
                    <button type="submit">æ–°å¢</button>
                </form>
            </div>

            <div class="records-container">
                <h3>æ­·å²ç´€éŒ„</h3>
                <div id="records-list"></div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // =================================================================
        // 1. Firebase è¨­å®š (å·²ä½¿ç”¨æ‚¨æä¾›çš„ Key)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAn17zhvzLRCS3qOb6PWA464cGNu1D7WzA",
            authDomain: "stu001-e72fa.firebaseapp.com",
            projectId: "stu001-e72fa",
            storageBucket: "stu001-e72fa.appspot.com",
            messagingSenderId: "852359717475",
            appId: "1:852359717475:web:db9a6a5d737978874c8e56",
            measurementId: "G-5BHH3R9N2D"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // =================================================================
        // 2. å­¸ç”Ÿè³‡æ–™ (æœ€çµ‚æ­£ç¢ºç‰ˆ)
        // =================================================================
        const studentsData = [
            { id: '70101', name: 'é™³å®¥ç‚˜' }, { id: '70102', name: 'å»–ç¿ŠæšŸ' }, { id: '70103', name: 'é™³ä¿¡å®‰' }, { id: '70104', name: 'è¨±ä¸ç¿”' }, { id: '70105', name: 'ç°¡å»·æ¾”' }, { id: '70106', name: 'æœ±å³»é ¡' }, { id: '70107', name: 'ç°¡è© å“²' }, { id: '70108', name: 'è¨±ç¿æ©' }, { id: '70109', name: 'é«˜å“²å®‡' }, { id: '70110', name: 'ä½™å°šé½Š' }, { id: '70121', name: 'æ—èŠ¯æŸ”' }, { id: '70122', name: 'é‚±è²ç‘œ' }, { id: '70123', name: 'é™³æ˜€å¸Œ' }, { id: '70124', name: 'å³ç¾æ‹‰' }, { id: '70125', name: 'åŠ‰æ¬£é›¨' }, { id: '70126', name: 'ä½™æ¨‚æ¨‚' }, { id: '70127', name: 'éƒ­å“å¦' }, { id: '70128', name: 'å®‹é‡©å›' }, { id: '70129', name: 'é‚±è‰è“‰' }, { id: '70130', name: 'æè‹¡å¯§' },
            { id: '70201', name: 'æ—å®—å°¹' }, { id: '70202', name: 'æ—å®¥ç·¯' }, { id: '70204', name: 'è¬æ˜•éœ–' }, { id: '70205', name: 'é»ƒéœ‡æ­¦' }, { id: '70206', name: 'é»ƒæ£–è‡´' }, { id: '70207', name: 'åš´ç¦¾ç¿”' }, { id: '70208', name: 'æ—å­é¨°' }, { id: '70209', name: 'ç°¡å„€å®‰' }, { id: '70210', name: 'æç¿ç…¬' }, { id: '70221', name: 'é„­ç¾½å½¤' }, { id: '70222', name: 'ç›§æ²›ç‘œ' }, { id: '70223', name: 'ææ¬£ç³' }, { id: '70224', name: 'è•­å¿ƒæ„‰' }, { id: '70225', name: 'æ¸¸å§¿ç´œ' }, { id: '70226', name: 'æå®œæ˜€' }, { id: '70227', name: 'æå®œæ˜•' }, { id: '70228', name: 'æä½³ç©' }, { id: '70229', name: 'è”¡æ˜€å½¤' }, { id: '70230', name: 'æ—è­½æ›¸' }, { id: '70231', name: 'æ—ç´«æ¹„' },
            { id: '70301', name: 'è‘‰éŠ˜æ¿¬' }, { id: '70302', name: 'æä¾‘å®¸' }, { id: '70303', name: 'éƒ­å®¸æ„·' }, { id: '70304', name: 'å¼µä»²å»·' }, { id: '70305', name: 'æ½˜é€¸æ„·' }, { id: '70306', name: 'é»ƒäºˆæ¨‚' }, { id: '70307', name: 'é«˜å£«' }, { id: '70308', name: 'æ—ä¿Šè±ª' }, { id: '70309', name: 'æå¾¡éŠ˜' }, { id: '70310', name: 'éƒ­å…‰æµ©' }, { id: '70311', name: 'éƒ­è‚²ç¶¸' }, { id: '70321', name: 'è”¡åªçµœ' }, { id: '70322', name: 'å³è•¥åŸ' }, { id: '70323', name: 'è¨±å–»åª—' }, { id: '70324', name: 'é»ƒéŸ»æ™¨' }, { id: '70325', name: 'æ±Ÿä½³ç´œ' }, { id: '70326', name: 'é™³ç¿Œæ­†' }, { id: '70327', name: 'ç«¥äºæ©' }, { id: '70328', name: 'ç°¡è‹¡å®‰' }, { id: '70329', name: 'å¼µåªƒæ¶µ' }, { id: '70330', name: 'é»ƒè©©å©·' },
            { id: '70401', name: 'é«˜ç´¹é½Š' }, { id: '70402', name: 'æ—å®å¡' }, { id: '70403', name: 'æ›¹ä»¤ç·¯' }, { id: '70404', name: 'ç°¡éŸ‹ç¿”' }, { id: '70405', name: 'ç¾…æ‰¿å°‰' }, { id: '70406', name: 'é˜®ç‘‹å‡±' }, { id: '70407', name: 'æŸ³å­è¬™' }, { id: '70408', name: 'ææœ‹è«º' }, { id: '70409', name: 'éƒ­å®‡å–†' }, { id: '70410', name: 'é™³ä½•è»’' }, { id: '70411', name: 'é«˜å®¶å¡' }, { id: '70421', name: 'é„§å¿ƒæ¦†' }, { id: '70422', name: 'æ±Ÿè²èª¼' }, { id: '70423', name: 'å¼µæ·³åª—' }, { id: '70424', name: 'è¨±æ·¨è³¢' }, { id: '70425', name: 'ç°¡å­æ™' }, { id: '70426', name: 'æ—ç¦æ©' }, { id: '70427', 'name': 'æèŠ·ç‘„' }, { id: '70428', name: 'é»ƒæ–‡æ€¡' }, { id: '70429', name: 'åŠ‰å¯éš' }, { id: '70430', name: 'æç¾¿è“' },
            { id: '80101', name: 'æè©³ç¿Š' }, { id: '80102', name: 'ç·´çƒœèµ«' }, { id: '80103', name: 'æ—å¥•ä¸' }, { id: '80104', name: 'é™³ä¿¡è‡³' }, { id: '80105', name: 'è”¡æ”¿å³°' }, { id: '80106', name: 'å³å²·æ©' }, { id: '80107', name: 'å¾æ°¸æ¾¤' }, { id: '80108', name: 'æŸ³å®‡æ©' }, { id: '80109', name: 'å‘¨ææ´§' }, { id: '80110', name: 'æå®¶å®' }, { id: '80111', name: 'ç¾…æ˜±é †' }, { id: '80112', name: 'ä½™å´‡è–' }, { id: '80113', name: 'è‘‰è‚²è¾°' }, { id: '80121', name: 'å­£å¯å©•' }, { id: '80123', name: 'é«˜è© ç·¹' }, { id: '80124', name: 'è”¡å®‡æ™´' }, { id: '80125', name: 'æ—è©©å‡¡' }, { id: '80126', name: 'ç°¡å­èŠ¹' }, { id: '80127', name: 'å‘¨èˆ’æ™´' }, { id: '80128', name: 'é„­æ™´å‹»' }, { id: '80129', name: 'ç‹æ¹˜è±' }, { id: '80130', name: 'æ´ªå“æ–‡' }, { id: '80131', name: 'å¾è²é·' }, { id: '80132', name: 'è¨±èŠ¸è“' },
            { id: '80201', name: 'ç‹æµšä¸' }, { id: '80202', name: 'ææ³°ç¿' }, { id: '80203', name: 'ä½•ç¿°æ˜‡' }, { id: '80204', name: 'è³´æŸä¸' }, { id: '80205', name: 'æ—ç†™æ©' }, { id: '80206', name: 'è³´å“ç©' }, { id: '80208', name: 'æ–½éŸ‹å½¤' }, { id: '80209', name: 'è¨±å“²éŠ˜' }, { id: '80210', name: 'å¼µå¤©å®¥' }, { id: '80211', name: 'é™³ä¿ŠéŠ˜' }, { id: '80221', name: 'ç°¡å¦¤äº˜' }, { id: '80222', name: 'æ¸¸é›¨ç¶º' }, { id: '80223', name: 'è³´ç¿äº‘' }, { id: '80224', name: 'è¨±å®‰å„€' }, { id: '80225', name: 'è¨±èŠ¸å©•' }, { id: '80226', name: 'å¼µæå‰' }, { id: '80227', name: 'æé›…é›¯' }, { id: '80228', name: 'éƒ­éƒç©' }, { id: '80229', name: 'è¨±èŠ¯æ…ˆ' }, { id: '80230', name: 'æ¥Šç´«ç¿' }, { id: '80231', name: 'æé›¨å€©' },
            { id: '80301', name: 'æé¾å…' }, { id: '80302', name: 'æ–½éŸ‹å‘ˆ' }, { id: '80303', name: 'é«˜ç¿Šå®¸' }, { id: '80304', name: 'æå­æ—­' }, { id: '80305', name: 'åŠ‰ä¸ç¥' }, { id: '80306', name: 'è¨±æ‰¿æš˜' }, { id: '80307', name: 'å¾ç¿è¬„' }, { id: '80308', name: 'ç°¡æ¥·å€«' }, { id: '80309', name: 'æ—ä»¥æ©' }, { id: '80310', name: 'å³æ˜å€«' }, { id: '80311', name: 'ç¾…æµšç‘‹' }, { id: '80312', name: 'è”¡æ–¯å¸†' }, { id: '80321', name: 'ç°¡ç­±å®œ' }, { id: '80322', name: 'æŸ³ä½©å®œ' }, { id: '80323', name: 'æç¦¹è‘³' }, { id: '80324', name: 'é™³æ˜±åŸ' }, { id: '80325', name: 'ç‹å®‡å®‰' }, { id: '80326', name: 'æœ±æ€¡ç©' }, { id: '80327', name: 'ææŸ”æ¼ª' }, { id: '80328', name: 'ç°¡æ›‰å½¤' }, { id: '80329', name: 'æœ±å·§é¦¨' }, { id: '80330', name: 'å¼µèŠ¸å©•' }, { id: '80331', name: 'è¨±ç‡•å›' }, { id: '80332', name: 'é™³è‹¡é›¯' },
            { id: '80401', name: 'éƒ­å®¥è‰¯' }, { id: '80402', name: 'å¼µå®¸ç‘€' }, { id: '80403', name: 'è¯ç¿Šæ‰¿' }, { id: '80404', name: 'è¨±ç¶­å®¸' }, { id: '80405', name: 'å¼µæ¡€ç´³' }, { id: '80406', name: 'è¨±æ£–ç†™' }, { id: '80407', name: 'æ—è„©æ¡€' }, { id: '80408', name: 'æ—ç¿å½¥' }, { id: '80409', name: 'ä½•å† æ˜±' }, { id: '80410', name: 'ä½•éŸ‹è»' }, { id: '80411', name: 'æ½˜å¤§é‘«' }, { id: '80421', name: 'æ—å­æ™´' }, { id: '80422', name: 'è¨±æ™ç”„' }, { id: '80423', name: 'è¨±è¬¹å®‰' }, { id: '80424', name: 'ç‹å§³' }, { id: '80425', name: 'æè‹¡ç‘„' }, { id: '80426', name: 'æ—æ€¡å¸Œ' }, { id: '80427', name: 'åŠ‰åº­ç‘œ' }, { id: '80428', name: 'åŠ‰å®¸ç‘œ' }, { id: '80429', name: 'å¼µä½³æ¦•' }, { id: '80430', name: 'éƒ­æ©å¦¤' }, { id: '80431', name: 'ä½•é›…èŒ¹' },
            { id: '90102', name: 'æç¦¹å¨' }, { id: '90103', name: 'æ—ä½™ç¥' }, { id: '90104', name: 'è«¶å®¶å½¬' }, { id: '90105', name: 'é«˜ç«‹å´´' }, { id: '90106', name: 'é»ƒå®¶ç‘‹' }, { id: '90107', name: 'æ¸¸æ™ºæ£ ' }, { id: '90108', name: 'ç¾…æ¥·å´´' }, { id: '90109', name: 'è¨±é€¢æ–‡' }, { id: '90110', name: 'é™³å“ç¿”' }, { id: '90111', name: 'é‚±å“æ‰¿' }, { id: '90121', name: 'ç°¡æ£ ç¾½' }, { id: '90122', name: 'å³æ˜€è±ˆ' }, { id: '90123', name: 'æ˜“ä½³æ…§' }, { id: '90124', name: 'å¾å˜‰å¦¤' }, { id: '90125', name: 'é«˜è©©æ™´' }, { id: '90126', name: 'æ—éŸ‹æ‰' }, { id: '90127', name: 'å¼µèŠ å«™' }, { id: '90128', name: 'é™³èªæ¡' }, { id: '90129', name: 'è•­å“å«™' },
            { id: '90201', name: 'è³´æ”¿éŠ˜' }, { id: '90202', name: 'æ—å®¥äº¨' }, { id: '90203', name: 'æå®¥æ‰¿' }, { id: '90204', name: 'è”¡æ‰¿å®¶' }, { id: '90205', name: 'ææŸå¡' }, { id: '90206', name: 'è¨±æ›¸é³´' }, { id: '90207', name: 'è¨±èŒ—æ£¨' }, { id: '90208', name: 'è³´æŸç¿' }, { id: '90209', name: 'é‚±æ¢“å€«' }, { id: '90221', name: 'æ¸¸å‰è•' }, { id: '90222', name: 'æœ±å¥•ç¦' }, { id: '90223', name: 'é„­æ¬£åº­' }, { id: '90224', name: 'è³´æ˜±ç‘„' }, { id: '90225', name: 'è³´ç´«å«£' }, { id: '90226', name: 'ææ¦³æ©' }, { id: '90227', name: 'æå©•å»·' }, { id: '90228', name: 'éƒ­ä¼Šç’‡' },
            { id: '90301', name: 'è¬æ±ç›Š' }, { id: '90302', name: 'é»ƒå£«è»’' }, { id: '90304', name: 'è”¡æ—»å‘ˆ' }, { id: '90305', name: 'æ¥Šç•¯ç¨‹' }, { id: '90306', name: 'ç°¡å»·å®‡' }, { id: '90307', name: 'éƒ­å­æ´‹' }, { id: '90309', name: 'è¬å®—æ´‹' }, { id: '90310', name: 'å¾é¼ç¡¯' }, { id: '90321', name: 'é™³éˆºæ¬£' }, { id: '90322', name: 'å¼µå©ºæ¶µ' }, { id: '90323', name: 'æ±Ÿä½³æ¬£' }, { id: '90324', name: 'è¬è“è‘¶' }, { id: '90325', name: 'æ¥Šæ£ ç”¯' }, { id: '90326', name: 'æ¢è»’ç‘œ' }, { id: '90327', name: 'é™³æ˜€è“³' }, { id: '90328', name: 'å¼µèŠ·ç¶º' }, { id: '90329', name: 'æå®¶å¦¤' }, { id: '90330', name: 'å‘‚ç‡•å¦®' }, { id: '90331', name: 'é™³å–¬è±' },
            { id: '90401', name: 'è¬æ˜Šå‡' }, { id: '90402', name: 'ææ¼¢æ˜‡' }, { id: '90403', 'name': 'æå˜‰å“²' }, { id: '90404', name: 'æ±Ÿé•·æ©' }, { id: '90405', name: 'æå˜‰æ©' }, { id: '90406', name: 'æ—å®¥é ¡' }, { id: '90407', name: 'å³ç‘æ©' }, { id: '90410', name: 'é™³å½¥éœ–' }, { id: '90411', name: 'æ—å¼¦å¡' }, { id: '90421', name: 'æ±Ÿé›¨æ½”' }, { id: '90423', name: 'å¼µç¶ºçœŸ' }, { id: '90424', name: 'æç¿æ¶µ' }, { id: '90427', name: 'æ±ŸåŸ¹ç‘€' }, { id: '90428', name: 'ç‹å“ç”¯' }, { id: '90429', name: 'å³è‚²å½¤' }, { id: '90430', name: 'é™³å¦‚ç­ ' }, { id: '90431', name: 'è‘‰å®¥å²‘' }
        ];
        
        const appContainer = document.getElementById('app-container');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalStudentInfo = document.getElementById('modal-student-info');
        const recordsList = document.getElementById('records-list');
        const addRecordForm = document.getElementById('add-record-form');
        const closeBtn = document.querySelector('.close-btn');

        let currentStudentId = null;
        let studentScores = {}; 

        async function initialize() {
            await fetchAllScores(); 
            renderLayout();         
        }

        async function fetchAllScores() {
            const recordsSnapshot = await db.collection('records').get();
            studentScores = {}; 

            recordsSnapshot.forEach(doc => {
                const record = doc.data();
                if (!studentScores[record.studentId]) {
                    studentScores[record.studentId] = 0;
                }
                studentScores[record.studentId] += record.points || 0;
            });
        }
        
        function renderLayout(selectedStudentId = null) {
            appContainer.innerHTML = ''; 

            const groupedByClass = studentsData.reduce((acc, student) => {
                const className = student.id.substring(0, 3);
                if (!acc[className]) acc[className] = [];
                acc[className].push(student);
                return acc;
            }, {});

            const classScores = {};
            for (const studentId in studentScores) {
                const className = studentId.substring(0, 3);
                if (!classScores[className]) classScores[className] = 0;
                classScores[className] += studentScores[studentId];
            }

            const sortedClasses = Object.keys(groupedByClass).sort();

            sortedClasses.forEach(className => {
                const classCard = document.createElement('div');
                classCard.className = 'class-card';

                const totalScore = classScores[className] || 0;
                const scoreColor = totalScore > 0 ? 'var(--success-color)' : (totalScore < 0 ? 'var(--danger-color)' : '#666');

                const title = document.createElement('h2');
                title.className = 'class-title';
                title.innerHTML = `${className} ç­ <span class="class-score-span" style="color: ${scoreColor}">(ç¸½åˆ†: ${totalScore})</span>`;
                classCard.appendChild(title);

                const select = document.createElement('select');
                select.className = 'student-select';
                select.dataset.className = className;

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '--- è«‹é¸æ“‡å­¸ç”Ÿ ---';
                select.appendChild(defaultOption);

                groupedByClass[className].forEach(student => {
                    const score = studentScores[student.id] || 0;
                    const option = document.createElement('option');
                    option.value = student.id;
                    const seatNumber = student.id.substring(3);
                    
                    let displayText = `${seatNumber} ${student.name}`;
                    if (score !== 0) {
                        displayText += ` (${score}åˆ†)`;
                    }
                    option.textContent = displayText;

                    if (student.id === selectedStudentId) {
                        option.selected = true;
                    }

                    select.appendChild(option);
                });
                
                select.addEventListener('change', (event) => {
                    const selectedStudentId = event.target.value;
                    if (selectedStudentId) {
                        openModal(selectedStudentId);
                    }
                });

                classCard.appendChild(select);
                appContainer.appendChild(classCard);
            });
        }

        function openModal(studentId) {
            currentStudentId = studentId;
            const student = studentsData.find(s => s.id === studentId);
            modalTitle.textContent = `${student.name} (${student.id}) çš„è¡¨ç¾ç´€éŒ„`;
            modalStudentInfo.innerHTML = `ç›®å‰ç¸½åˆ†: <strong>${studentScores[studentId] || 0}</strong>`;
            loadRecords(studentId);
            modal.style.display = 'block';
        }
        
        function closeModal() {
            modal.style.display = 'none';
            addRecordForm.reset();
            renderLayout(); 
            currentStudentId = null;
        }

        function loadRecords(studentId) {
            recordsList.innerHTML = 'è¼‰å…¥ä¸­...';
            db.collection('records')
              .where('studentId', '==', studentId)
              .orderBy('timestamp', 'desc')
              .onSnapshot(snapshot => {
                  recordsList.innerHTML = '';
                  if (snapshot.empty) {
                      recordsList.innerHTML = 'å°šç„¡ç´€éŒ„ã€‚';
                      return;
                  }
                  snapshot.forEach(doc => {
                      const record = doc.data();
                      const recordItem = document.createElement('div');
                      recordItem.className = 'record-item';
                      const pointsClass = record.points > 0 ? 'positive' : (record.points < 0 ? 'negative' : '');
                      
                      recordItem.innerHTML = `
                          <div class="record-details">
                              <div>
                                  <span class="record-points ${pointsClass}">${record.points || 0}åˆ†</span>
                                  <span class="record-text">${record.text || ''}</span>
                              </div>
                              <div class="record-timestamp">${new Date(record.timestamp.seconds * 1000).toLocaleString()}</div>
                          </div>
                          <div class="record-actions">
                              <button class="delete-btn" data-id="${doc.id}">ğŸ—‘ï¸</button>
                          </div>
                      `;
                      recordsList.appendChild(recordItem);
                  });
              });
        }

        async function handleAddRecord(e) {
            e.preventDefault();
            const pointsInput = document.getElementById('record-points');
            const textInput = document.getElementById('record-text');
            const points = parseInt(pointsInput.value, 10) || 0;
            const text = textInput.value.trim();

            if (points === 0 && text === '') {
                alert('è«‹è‡³å°‘è¼¸å…¥åˆ†æ•¸æˆ–æ–‡å­—ç´€éŒ„ï¼');
                return;
            }

            const studentIdToKeepSelected = currentStudentId;

            const newRecord = {
                studentId: currentStudentId,
                points: points,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('records').add(newRecord);
                modal.style.display = 'none';
                addRecordForm.reset();
                await fetchAllScores(); 
                renderLayout(studentIdToKeepSelected);
            } catch (error) {
                console.error("æ–°å¢ç´€éŒ„å¤±æ•—: ", error);
                alert('æ–°å¢å¤±æ•—ï¼');
            }
        }
        
        // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹è™•ã€‘ã€‘ã€‘ - åˆªé™¤å¾Œä¹Ÿé—œé–‰è¦–çª—ä¸¦ä¿æŒé¸å–®
        async function handleDeleteRecord(e) {
            if (e.target.classList.contains('delete-btn')) {
                const recordId = e.target.dataset.id;
                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
                    const studentIdToKeepSelected = currentStudentId; // è¨˜ä¸‹ç•¶å‰å­¸ç”ŸID

                    try {
                        await db.collection('records').doc(recordId).delete();
                        
                        modal.style.display = 'none'; // <<-- æ–°å¢ï¼šåˆªé™¤æˆåŠŸå¾Œé—œé–‰è¦–çª—
                        
                        await fetchAllScores(); 
                        renderLayout(studentIdToKeepSelected); // é‡ç¹ªä¸»ç•«é¢ï¼Œä¸¦ä¿æŒé¸ä¸­ç‹€æ…‹

                    } catch (error) {
                        console.error("åˆªé™¤ç´€éŒ„å¤±æ•—: ", error);
                        alert('åˆªé™¤å¤±æ•—ï¼');
                    }
                }
            }
        }

        closeBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        addRecordForm.addEventListener('submit', handleAddRecord);
        recordsList.addEventListener('click', handleDeleteRecord);

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
    </body>
</html>
