<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆç¸¾ç™»éŒ„ - ç­ç´šç¶œåˆæˆç¸¾ç´€éŒ„ç³»çµ±</title>
  <style>
    :root { --primary-color: #4a90e2; --secondary-color: #f5f5ff; --font-color: #333; --border-color: #ddd; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif; margin: 0; background-color: var(--secondary-color); color: var(--font-color); }
    button, input, select, textarea { font-family: inherit; }
    header { background-color: var(--primary-color); color: white; padding: 0.6rem 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    header h1 { font-size: 1.6em; margin: 0; }
    header button { background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 1em; }
    main { padding: 20px; max-width: 1000px; margin: auto; }
    .section { background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    h2 { color: #333; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-top: 0; }
    .control-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 20px; align-items: flex-end; margin-bottom: 20px; }
    .control-group { display: flex; flex-direction: column; }
    .control-group label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
    .control-group select, .control-group input { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; height: 40px; box-sizing: border-box; }
    #btn-add-grade { background-color: #28a745; color: white; border: none; padding: 0 20px; border-radius: 4px; cursor: pointer; height: 40px; font-size: 1em; font-weight: bold; }
    .grades-list { margin-top: 20px; border-top: 1px solid #eee; }
    .grade-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; transition: background-color 0.2s; }
    .grade-item:hover { background-color: #f9f9f9; }
    .grade-info { flex-grow: 1; }
    .grade-name { font-weight: bold; font-size: 1.1em; color: var(--primary-color); display: block; }
    .grade-meta { font-size: 0.85em; color: #666; margin-top: 4px; }
    .grade-actions button { margin-left: 10px; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: 1px solid #ddd; background-color: white; font-size: 0.9em; }
    .btn-edit { color: var(--primary-color); border-color: var(--primary-color) !important; }
    .btn-delete { color: #dc3545; border-color: #dc3545 !important; }
    #user-email { margin-left: 10px; font-size: 1.0em; }
    @media (max-width: 768px) {
      header h1 { font-size: 1.2em; }
      header button { padding: 4px 8px; font-size: 0.8em; }
      #user-email { font-size: 0.8em; }
      .control-grid { grid-template-columns: 1fr; gap: 10px; }
      .grade-item { flex-direction: column; align-items: flex-start; }
      .grade-actions { margin-top: 10px; width: 100%; display: flex; justify-content: flex-end; }
    }
  </style>
</head>
<body>
  <header>
    <h1>æˆç¸¾ç®¡ç†</h1>
    <div style="display:flex; align-items:center;">
      <button id="manual-reload-btn">ğŸ”„ æ‰‹å‹•æ›´æ–°</button>
      <button onclick="window.location.href='teacher.html'">è¿”å›ä¸»é </button>
      <button id="logout-btn">ç™»å‡º</button>
      <span id="user-email"></span>
    </div>
  </header>
  <main id="app-container" style="display:none;">
    <div class="section">
      <h2>æˆç¸¾é …ç›®åˆ—è¡¨</h2>
      <div class="control-grid">
        <div class="control-group">
          <label for="class-select">ç¯©é¸ç­ç´š</label>
          <select id="class-select"><option value="all">æ‰€æœ‰ç­ç´š</option></select>
        </div>
        <div class="control-group">
          <label for="search-input">æœå°‹é …ç›®åç¨±</label>
          <input type="text" id="search-input" placeholder="è¼¸å…¥é—œéµå­—...">
        </div>
        <button id="btn-add-grade">+ æ–°å¢æˆç¸¾é …ç›®</button>
      </div>
      <div id="grades-list-container" class="grades-list"></div>
    </div>
  </main>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
      authDomain: "classrecords-13902.firebaseapp.com",
      projectId: "classrecords-13902",
      storageBucket: "classrecords-13902.firebasestorage.app",
      messagingSenderId: "431747377367",
      appId: "1:431747377367:web:b157a8f5c59ce38091e892",
      measurementId: "G-JWTQGM9XMP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let currentUser = null, studentsData = [], assignments = [];
    const GRADES_CACHE_KEY = 'teacher_grades_list_cache_v1';
    const USER_AUTH_KEY = 'user_auth_profile_v1';
    const STATIC_CACHE_KEY = 'teacher_static_cache_v6';
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        const displayElement = document.getElementById('user-email');
        let userData = null;
        try {
          const cachedAuthData = localStorage.getItem(USER_AUTH_KEY);
          if (cachedAuthData) {
            userData = JSON.parse(cachedAuthData).userData;
            displayElement.textContent = userData.displayName || user.email;
          }
        } catch (e) {}
        if (!userData) {
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (userDoc.exists) {
            userData = userDoc.data();
            displayElement.textContent = userData.displayName || user.email;
          }
        }
        if (userData && userData.role === 'teacher') {
          initializePage(userData.schoolId);
          document.getElementById('app-container').style.display = 'block';
        } else { window.location.href = 'login.html'; }
      } else { window.location.href = 'login.html'; }
    });
    async function initializePage(schoolId) {
      try {
        const cachedStatic = localStorage.getItem(STATIC_CACHE_KEY);
        if (cachedStatic) {
          const data = JSON.parse(cachedStatic);
          if (data.uid === currentUser.uid) studentsData = data.rosterData || [];
        }
        if (studentsData.length === 0) {
          const rosterDoc = await db.collection('schools').doc(schoolId).collection('rosters').doc('current').get();
          if (rosterDoc.exists) studentsData = rosterDoc.data().students || [];
        }
        const classSelect = document.getElementById('class-select');
        const classes = [...new Set(studentsData.map(s => s.id.substring(0, 3)))].sort();
        classes.forEach(c => classSelect.appendChild(new Option(`${c} ç­`, c)));
        const cachedGrades = localStorage.getItem(GRADES_CACHE_KEY);
        if (cachedGrades) {
          const data = JSON.parse(cachedGrades);
          if (data.uid === currentUser.uid) {
            assignments = data.assignments;
            renderGradesList();
          }
        }
        db.collection('gradebooks').doc(currentUser.uid).collection('assignments')
          .orderBy('date', 'desc')
          .onSnapshot(snapshot => {
            assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            localStorage.setItem(GRADES_CACHE_KEY, JSON.stringify({ assignments, uid: currentUser.uid, timestamp: Date.now() }));
            renderGradesList();
          });
        bindEventListeners();
      } catch (e) { console.error(e); }
    }
    function bindEventListeners() {
      document.getElementById('class-select').addEventListener('change', renderGradesList);
      document.getElementById('search-input').addEventListener('input', renderGradesList);
      document.getElementById('btn-add-grade').addEventListener('click', () => { window.location.href = 'grades-edit.html'; });
      document.getElementById('manual-reload-btn').addEventListener('click', () => {
        if(confirm('ç¢ºå®šè¦å¾é›²ç«¯é‡æ–°ä¸‹è¼‰æˆç¸¾é …ç›®è³‡æ–™å—ï¼Ÿ')) {
          localStorage.removeItem(GRADES_CACHE_KEY);
          localStorage.removeItem(STATIC_CACHE_KEY);
          window.location.reload();
        }
      });
      document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut().then(() => { window.location.href = 'login.html'; }); });
    }
    function renderGradesList() {
      const classFilter = document.getElementById('class-select').value;
      const searchQuery = document.getElementById('search-input').value.toLowerCase();
      const container = document.getElementById('grades-list-container');
      const filtered = assignments.filter(a => {
        const matchClass = classFilter === 'all' || a.className === classFilter;
        const matchSearch = a.assignmentName.toLowerCase().includes(searchQuery);
        return matchClass && matchSearch;
      });
      if (filtered.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">æ‰¾ä¸åˆ°ç¬¦åˆçš„æˆç¸¾é …ç›®</p>';
        return;
      }
      container.innerHTML = filtered.map(a => {
        const dateStr = a.date ? (a.date.seconds ? new Date(a.date.seconds * 1000).toLocaleDateString() : new Date(a.date).toLocaleDateString()) : 'ç„¡æ—¥æœŸ';
        const scoreCount = a.scores ? Object.keys(a.scores).length : 0;
        return `
          <div class="grade-item">
            <div class="grade-info">
              <span class="grade-name">${a.className} ç­ - ${a.assignmentName}</span>
              <div class="grade-meta">å»ºç«‹æ—¥æœŸï¼š${dateStr} | å·²ç™»éŒ„äººæ•¸ï¼š${scoreCount}</div>
            </div>
            <div class="grade-actions">
              <button class="btn-edit" onclick="editAssignment('${a.id}')">ç·¨è¼¯æˆç¸¾</button>
              <button class="btn-delete" onclick="deleteAssignment('${a.id}', '${a.className}', '${a.assignmentName}')">åˆªé™¤</button>
            </div>
          </div>`;
      }).join('');
    }
    function editAssignment(id) { window.location.href = `grades-edit.html?id=${id}`; }
    async function deleteAssignment(docId, classId, assignmentName) {
      if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€${classId} ç­ã€‘çš„æˆç¸¾é …ç›®ï¼š\n\nã€Œ${assignmentName}ã€ï¼Ÿ`) && 
          confirm(`æœ€å¾Œç¢ºèªï¼æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼ŒçœŸçš„ç¢ºå®šå—ï¼Ÿ`)) {
        try {
          await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').doc(docId).delete();
          alert(`å·²æˆåŠŸåˆªé™¤ã€Œ${assignmentName}ã€`);
        } catch (e) { alert("åˆªé™¤å¤±æ•—ï¼"); }
      }
    }
  </script>
</body>
</html>