<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç¸¾ç™»éŒ„ - ç­ç´šç¶œåˆæˆç¸¾ç´€éŒ„ç³»çµ±</title>
    <style>
        :root { --primary-color: #4a90e2; --secondary-color: #f5f5ff; --font-color: #333; --border-color: #ddd; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif; margin: 0; background-color: var(--secondary-color); color: var(--font-color); }
        button, input, select, textarea {
            font-family: inherit;
        }
		header { background-color: var(--primary-color); color: white; padding: 0.6rem 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        header h1 { font-size: 1.6em; margin: 0; }
        header button { background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 1em; }
        main { padding: 20px; max-width: 1000px; margin: auto; }
        .section { background-color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h2, h3 { color: #333; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        input, button, textarea { padding: 10px; margin: 5px 0; font-size: 1em; border-radius: 4px; border: 1px solid var(--border-color); box-sizing: border-box; }
        button { background-color: var(--primary-color); color: white; cursor: pointer; border: none; }
        
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            align-items: flex-end; 
        }
        .form-grid label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .form-grid input {
            width: 100%;
        }
        #create-section.disabled { opacity: 0.5; pointer-events: none; }
        
        #history-list { list-style-type: none; padding: 0; }
        
        .history-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 6px; 
            background-color: #f9f9f9;
        }
        .history-item:hover { background-color: #eef; }
        .history-item-content {
            flex-grow: 1;
            display: flex;
            align-items: baseline;
            gap: 10px;
            min-width: 0;
            cursor: pointer;
            position: relative; 
            padding-left: 30px; 
        }
        .history-item-content::before {
             content: "ğŸ“Š"; 
             position: absolute;
             left: 0;
             top: 50%;
             transform: translateY(-50%);
             font-size: 1.2em;
        }
        .history-item-title {
            font-weight: bold;
            font-size: 1.1em;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .history-item-comment {
            font-size: 0.9em;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-item-meta, .history-item-actions {
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }
        .history-item-stats {
            font-size: 0.9em;
            color: #333;
            white-space: nowrap;
        }
        .history-item-actions .delete-btn {
            background-color: #e74c3c;
            font-size: 0.8em;
            padding: 5px 8px;
            margin-left: 15px;
        }
		header .header-actions {
            display: flex;
            align-items: center;
        }
        #user-email {
            margin-right: 15px;
            font-size: 1.0em;
        }
		.section-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			border-bottom: 2px solid var(--primary-color);
			padding-bottom: 10px;
			margin-bottom: 20px; 
		}

		.section-header h2 {
			border-bottom: none; 
			padding-bottom: 0;
			margin: 0; 
		}
        
        #go-to-create-btn {
            padding: 10px 20px;
        }
        
        #grade-entry-section, #student-scores-container { display: none !important; }
        @media (max-width: 600px) {
			main {
                padding: 8px;
            }
			.section {
				padding: 8px; 
				margin-bottom: 8px; 
			}
			.section button {
				padding: 10px; 
				margin-bottom: 5px; 
			}
			h2, .section-header h2 {
				font-size: 1.5em; 
				padding-bottom: 8px;
			}
			h3, #current-assignment-title {
				font-size: 1.2em; 
				padding-bottom: 8px;
			}
			.history-item {
				padding: 10px; 
				align-items: flex-start; 
			}
			.history-item-content {
				flex-direction: column; 
				align-items: flex-start; 
				gap: 2px; 
			}
            .history-item-content::before {
                 font-size: 1.0em; 
            }
            .history-item-content {
                 padding-left: 20px;
            }
			.history-item-title {
				font-size: 0.9em; 
			}
			.history-item-comment {
				white-space: normal; 
				overflow: visible;
				text-overflow: clip;
				color: #666; 
			}
			.history-item-actions {
				margin-top: 2px; 
			}
			.history-item-stats { 
                display: none; 
            }
			.section-header, .grade-entry-header-bar {
				margin-bottom: 8px; 
				font-size: 1.0em; 
			}
			.form-grid {
				grid-template-columns: 1fr 1fr; 
				gap: 5px; 
				margin-bottom: 10px; 
			}
			.form-grid label { 
				font-size: 0.8em; 
				margin-bottom: 2px;
			}
			.form-grid input {
				padding: 8px; 
			}
        }
    </style>
</head>
<body>
	<header>
        <h1 id="header-title">æˆç¸¾ç™»éŒ„</h1>
        <div class="header-actions">
            <span id="user-email"></span>
			<button id="manual-reload-btn" style="background: transparent; border: 1px solid #fff; margin-right: 5px;">ğŸ”„ æ‰‹å‹•æ›´æ–°</button>
            <button onclick="window.location.href='teacher.html'">è¿”å›ä¸»é </button>
            <button id="logout-btn">ç™»å‡º</button>
        </div>
    </header>
    <main id="app-container" style="display: none;">
        
        <div class="section">
            <div class="section-header">
                <h2 id="class-header">æˆç¸¾é …ç›®æ¸…å–®</h2>
            </div>
            <ul id="history-list"><li id="history-loading">è¼‰å…¥ä¸­...</li></ul>
        </div>
        
		<div id="create-section" class="section">
            <div class="section-header">
				<h2>å»ºç«‹æ–°æˆç¸¾é …ç›®</h2>
				<button id="go-to-create-btn">ä¸‹ä¸€æ­¥ï¼šç™»éŒ„æˆç¸¾</button>
			</div>
			<div class="form-grid">
				<div>
					<label for="new-assignment-name">æˆç¸¾é …ç›®åç¨±ï¼š</label>
					<input type="text" id="new-assignment-name" placeholder="ä¾‹å¦‚: ç¿’ä½œ1-1" list="assignment-suggestions" required>
					<datalist id="assignment-suggestions"></datalist>
				</div>
				<div>
					<label for="new-general-comment">æˆç¸¾èªªæ˜ (é¸å¡«)ï¼š</label>
					<input type="text" id="new-general-comment" placeholder="ä¾‹å¦‚: é²äº¤">
				</div>
			</div>
		</div>
        
		<div id="grade-entry-section" class="section" style="display: none;">
			<div class="grade-entry-header-bar">
				<h3 id="current-assignment-title"></h3>
				<div class="grade-entry-actions">
					<button class="save-grades-btn" style="background-color: #28a745;">æ›´æ–°å„²å­˜</button>
					<button class="cancel-edit-btn" style="background-color: #777;">å–æ¶ˆ</button>
				</div>
			</div>
			<div class="form-grid">
				<div>
					<label for="edit-assignment-name">æˆç¸¾é …ç›®åç¨±ï¼š</label>
					<input type="text" id="edit-assignment-name">
				</div>
				<div>
					<label for="edit-general-comment">æˆç¸¾èªªæ˜ (é¸å¡«)ï¼š</label>
					<input type="text" id="edit-general-comment">
				</div>
			</div>
			<hr>
			<div id="student-scores-container">
				</div>
			<div style="margin-top: 20px;" class="grade-entry-actions">
				<button class="save-grades-btn" style="background-color: #28a745;">æ›´æ–°å„²å­˜</button>
				<button class="cancel-edit-btn" style="background-color: #777;">å–æ¶ˆ</button>
			</div>
		</div>
    </main>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
	  const firebaseConfig = {
		apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
		authDomain: "classrecords-13902.firebaseapp.com",
		projectId: "classrecords-13902",
		storageBucket: "classrecords-13902.firebasestorage.app",
		messagingSenderId: "431747377367",
		appId: "1:431747377367:web:b157a8f5c59ce38091e892",
		measurementId: "G-JWTQGM9XMP"
	  };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); const auth = firebase.auth();
        let currentUser = null, classId = null, studentsInClass = [];
        const appContainer = document.getElementById('app-container');
        const createSection = document.getElementById('create-section');
        const goToCreateBtn = document.getElementById('go-to-create-btn'); 
        const newAssignmentNameInput = document.getElementById('new-assignment-name');
        const newGeneralCommentInput = document.getElementById('new-general-comment');
        const historyList = document.getElementById('history-list');
        const ASSIGNMENT_DATA_KEY = 'assignmentId';
        const ASSIGNMENT_NAME_KEY = 'assignmentName';
        const ASSIGNMENT_COMMENT_KEY = 'assignmentComment';
        const STATIC_CACHE_KEY = 'teacher_static_cache_v6';
		const GRADES_CACHE_KEY = 'grades_cache_v1'
        const CACHE_LIFETIME = 45 * 60 * 1000; 
        const USER_AUTH_KEY = 'user_auth_profile_v1';
        let CACHE_DATA_STATIC = {};
        let CACHE_DATA_GRADES = {};
		
		auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const displayElement = document.getElementById('user-email');
                let userData = null;
                try {
                    const cachedAuthData = localStorage.getItem(USER_AUTH_KEY);
                    if (cachedAuthData) {
                         userData = JSON.parse(cachedAuthData).userData;
                         if (userData.displayName) {
                             displayElement.textContent = userData.displayName;
                         } else {
                             displayElement.textContent = user.email;
                         }
                    }
                } catch (e) {
                     console.error('âŒ è§£æ AUTH å¿«å–å¤±æ•—:', e);
                }
                if (!userData) {
                     const userDoc = await db.collection('users').doc(user.uid).get();
                     console.log('è¼‰å…¥userè³‡æ–™...');
                     if (userDoc.exists) {
                          userData = userDoc.data();
                          if (userData.displayName) {
                              displayElement.textContent = userData.displayName;
                          } else {
                              displayElement.textContent = user.email;
                          }
                     }
                }
                if (userData && userData.role === 'teacher') {
                    await initializeGradesPage(userData);
                } else {
                    alert('æ¬Šé™ä¸è¶³æˆ–å¸³è™Ÿè¨­å®šéŒ¯èª¤ã€‚');
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
		});

		async function initializeGradesPage(userData) {
			const urlParams = new URLSearchParams(window.location.search);
			classId = urlParams.get('class');
            let useStaticCache = false;
			let useGradesCache = false;
            let rosterDataLoaded = false;
            let assignmentsDataLoaded = false;
            let allStudents = [];
			
            try {
                const cachedStatic = localStorage.getItem(STATIC_CACHE_KEY);
                if (cachedStatic) {
                    CACHE_DATA_STATIC = JSON.parse(cachedStatic);
                    if (CACHE_DATA_STATIC.uid === currentUser.uid) {
                        useStaticCache = true;
                    } else {
                        localStorage.removeItem(STATIC_CACHE_KEY);
                    }
                }
            } catch (e) {
                console.error('âŒ è§£æ STATIC å¿«å–å¤±æ•—:', e);
                localStorage.removeItem(STATIC_CACHE_KEY);
            }
			try {
                const cachedGrades = localStorage.getItem(GRADES_CACHE_KEY);
                if (cachedGrades) {
                    CACHE_DATA_GRADES = JSON.parse(cachedGrades);
                    if (CACHE_DATA_GRADES.uid === currentUser.uid) {
                        useGradesCache = true;
                    } else {
                        localStorage.removeItem(STATIC_CACHE_KEY);
                    }
                }
            } catch (e) {
                console.error('âŒ è§£æ STATIC å¿«å–å¤±æ•—:', e);
                localStorage.removeItem(STATIC_CACHE_KEY);
            }

            if (useStaticCache && CACHE_DATA_STATIC.rosterData) {
                allStudents = CACHE_DATA_STATIC.rosterData;
                rosterDataLoaded = true;
                console.log('âœ… å­¸ç”Ÿåå†Šï¼šSTATIC å¿«å–å‘½ä¸­ï¼');
            }

            if (!rosterDataLoaded) {
                if (!userData.schoolId) {
                    alert('éŒ¯èª¤ï¼šæ‚¨çš„å¸³è™Ÿæœªç¶å®šå­¸æ ¡IDï¼Œç„¡æ³•è®€å–åå†Šã€‚');
                    return;
                }
                const rosterDoc = await db.collection('schools').doc(userData.schoolId).collection('rosters').doc('current').get();
                console.log('è¼‰å…¥å­¸ç”Ÿåå†Šè³‡æ–™...');
                if (!rosterDoc.exists) {
                    alert('æ‰¾ä¸åˆ°å­¸æ ¡çš„å­¸ç”Ÿåå†Šï¼Œè«‹è¯ç¹«å­¸æ ¡ç®¡ç†è€…ä¸Šå‚³è³‡æ–™ã€‚');
                    return;
                }
                allStudents = rosterDoc.data().students || [];
                CACHE_DATA_STATIC.rosterData = allStudents;
                CACHE_DATA_STATIC.uid = currentUser.uid; 
            }
            
            
            const now = new Date().getTime();
            if (useGradesCache && CACHE_DATA_GRADES.assignmentNames) {
                var gradeAssignmentNames = new Set(CACHE_DATA_GRADES.assignmentNames);
                assignmentsDataLoaded = true;
                console.log('âœ… æˆç¸¾é …ç›®åç¨±ï¼šSTATIC å¿«å–å‘½ä¸­ï¼(æ‰‹å‹•æ¨¡å¼)');
            }

			if (!classId) {
				appContainer.innerHTML = '<h2>éŒ¯èª¤ï¼šæœªæŒ‡å®šç­ç´šã€‚è«‹è¿”å›ä¸»é é¸æ“‡ç­ç´šå¾Œé‡æ–°é€²å…¥ã€‚</h2>';
				appContainer.style.display = 'block';
				return;
			}
			document.getElementById('class-header').textContent = `${classId} ç­ æˆç¸¾é …ç›®æ¸…å–®`;


            if (!assignmentsDataLoaded) {
				try {
					if (!allStudents || allStudents.length === 0) {
					    console.warn("æœªè¼‰å…¥å­¸ç”Ÿåå†Šï¼Œç„¡æ³•ç¢ºå®šä»»æ•™ç­ç´šï¼Œè·³éæˆç¸¾å»ºè­°è¼‰å…¥ã€‚");
                        return;
					}
					const teacherClasses = [...new Set(allStudents.map(s => s.id.substring(0, 3)))];
					const queryPromises = teacherClasses.map(cId => 
						db.collection('gradebooks').doc(currentUser.uid).collection('assignments')
						  .where('className', '==', cId)
						  .get()
					);
					console.log('è¼‰å…¥ä½œæ¥­æˆç¸¾è³‡æ–™...');
					const snapshots = await Promise.all(queryPromises);
					gradeAssignmentNames = new Set();
					snapshots.forEach(snapshot => {
						snapshot.forEach(doc => {
							gradeAssignmentNames.add(doc.data().assignmentName);
						});
					});
                    
                    CACHE_DATA_GRADES.assignmentNames = Array.from(gradeAssignmentNames);
                    CACHE_DATA_GRADES.lastAssignmentUpdate = now;
                    CACHE_DATA_GRADES.uid = currentUser.uid; 
                    localStorage.setItem(GRADES_CACHE_KEY, JSON.stringify(CACHE_DATA_GRADES));
                    
				} catch (error) {
					console.error("è®€å–æˆç¸¾é …ç›®å»ºè­°æ¸…å–®å¤±æ•—:", error);
				}
			}
            
            if (gradeAssignmentNames) {
				const datalist = document.getElementById('assignment-suggestions');
				datalist.innerHTML = '';
				gradeAssignmentNames.forEach(name => {
					const option = document.createElement('option');
					option.value = name;
					datalist.appendChild(option);
				});
            }
			loadHistory();
			appContainer.style.display = 'block';
		}
		
        function navigateToEditPage(assignmentId = null, assignmentName = '', generalComment = '') {
            if (!classId) {
                alert('ç­ç´šIDéºå¤±ï¼Œç„¡æ³•è·³è½‰ã€‚');
                return;
            }
            const params = new URLSearchParams();
            params.set('class', classId);
            if (assignmentId) {
                params.set(ASSIGNMENT_DATA_KEY, assignmentId);
            }
            if (assignmentName) {
                params.set(ASSIGNMENT_NAME_KEY, encodeURIComponent(assignmentName));
            }
            if (generalComment) {
                 params.set(ASSIGNMENT_COMMENT_KEY, encodeURIComponent(generalComment));
            }
            window.location.href = `grades-edit.html?${params.toString()}`;
        }

		goToCreateBtn.addEventListener('click', () => {
            const newAssignmentName = newAssignmentNameInput.value.trim();
            if (!newAssignmentName) {
                alert('è«‹å…ˆè¼¸å…¥æˆç¸¾é …ç›®åç¨±ï¼');
                newAssignmentNameInput.focus();
                return;
            }
            const historyItems = Array.from(historyList.querySelectorAll('.history-item'));
            const existingItem = historyItems.find(item => {
                const titleElement = item.querySelector('.history-item-title');
                const titleText = titleElement ? titleElement.textContent.split(' (')[0] : '';
                return titleText === newAssignmentName;
            });
            if (existingItem) {
                const existingId = existingItem.dataset.id;
                const existingComment = existingItem.dataset.generalComment || '';
                alert(`æé†’ï¼šå·²å­˜åœ¨åç‚ºã€Œ${newAssignmentName}ã€çš„æˆç¸¾é …ç›®ï¼Œå°‡ç›´æ¥è¼‰å…¥è©²é …ç›®é€²è¡Œç·¨è¼¯ã€‚`);
                navigateToEditPage(existingId, newAssignmentName, existingComment);
            } else {
                navigateToEditPage(null, newAssignmentName, newGeneralCommentInput.value.trim());
            }
        });
        
        
        function loadHistory() {
            db.collection('gradebooks').doc(currentUser.uid).collection('assignments')
              .where('className', '==', classId)
              .orderBy('date', 'desc')
              .onSnapshot(snapshot => {
                historyList.innerHTML = '';
                if (snapshot.empty) {
                    historyList.innerHTML = '<li>å°šç„¡æˆç¸¾é …ç›®ã€‚</li>';
                    return;
                }
                snapshot.forEach(doc => {
                    const a = doc.data();
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.dataset.id = doc.id;
                    li.dataset.assignmentName = a.assignmentName;
                    li.dataset.generalComment = a.generalComment || ''; 
                    let studentCount = 0;
                    let totalScore = 0;
                    if (a.scores) {
                        for (const studentId in a.scores) {
                            if (a.scores[studentId].score !== undefined && a.scores[studentId].score !== null && a.scores[studentId].score !== '') {
                                studentCount++;
                                totalScore += parseFloat(a.scores[studentId].score);
                            }
                        }
                    }
                    const averageScore = studentCount > 0 ? (totalScore / studentCount).toFixed(1) : 'N/A';
                    const dateString = a.date ? a.date.toDate().toLocaleDateString() : 'æ—¥æœŸæœªçŸ¥';
                    const commentText = a.generalComment || '';
                    
                    li.innerHTML = `
                        <div class="history-item-content" data-id="${doc.id}">
                            <span class="history-item-title">${a.assignmentName} (${dateString})</span>
                            <span class="history-item-comment">${commentText}</span>
                        </div>
                        <div class="history-item-meta">
                            <span class="history-item-stats">äººæ•¸: <strong>${studentCount}</strong> | å¹³å‡: <strong>${averageScore}</strong></span>
                        </div>
                        <div class="history-item-actions">
                            <button class="delete-btn" data-id="${doc.id}">åˆªé™¤</button>
                        </div>
                    `;
                    
                    li.querySelector('.history-item-content').addEventListener('click', (e) => {
                        const targetId = e.currentTarget.dataset.id;
                        const assignmentName = e.currentTarget.closest('.history-item').dataset.assignmentName;
                        const generalComment = e.currentTarget.closest('.history-item').dataset.generalComment;
                        navigateToEditPage(targetId, assignmentName, generalComment);
                    });
                    
                    historyList.appendChild(li);
                });
            }, error => {
                console.error("è®€å–æˆç¸¾å¤±æ•—:", error);
                historyList.innerHTML = '<li>è®€å–é …ç›®æ¸…å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</li>';
            });
        }

		historyList.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-btn')) {
                e.stopPropagation();
                const deleteBtn = e.target.closest('.delete-btn');
                const docId = deleteBtn.dataset.id;
                
                const listItem = deleteBtn.closest('.history-item');
                const assignmentName = listItem.dataset.assignmentName || 'æœªå‘½åé …ç›®';
                const className = classId;
                const firstConfirm = confirm(`æ‚¨ç¢ºå®šè¦åˆªé™¤ã€${className} ç­ã€‘çš„æˆç¸¾é …ç›®ï¼š\n\nã€Œ${assignmentName}ã€\n\nåŠå…¶æ‰€æœ‰å­¸ç”Ÿæˆç¸¾å—ï¼Ÿ`);
                
                if (firstConfirm) {
                    const secondConfirm = confirm(`ã€ã€ã€æœ€å¾Œç¢ºèªã€‘ã€‘ã€‘\n\næ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤ã€Œ${assignmentName}ã€çš„æ‰€æœ‰æˆç¸¾ï¼Œç„¡æ³•å¾©åŸï¼\n\nçœŸçš„ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ`);
                    
                    if (secondConfirm) {
                        try {
                            await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').doc(docId).delete();
                            alert(`å·²æˆåŠŸåˆªé™¤ã€Œ${assignmentName}ã€`);
                        } catch (error) {
                            alert("åˆªé™¤å¤±æ•—ï¼");
                        }
                    }
                }
            }
        });
		const manualReloadBtn = document.getElementById('manual-reload-btn');
        if(manualReloadBtn){
            manualReloadBtn.addEventListener('click', () => {
                if(confirm('ç¢ºå®šè¦å¾é›²ç«¯é‡æ–°ä¸‹è¼‰æˆç¸¾é …ç›®è³‡æ–™å—ï¼Ÿ')) {
                    localStorage.removeItem(GRADES_CACHE_KEY);
                    // ä¹Ÿè¦æ¸…é™¤ static cache ä»¥ç¢ºä¿åå†Šä¹Ÿæ˜¯æ–°çš„
                    localStorage.removeItem(STATIC_CACHE_KEY);
                    window.location.reload();
                }
            });
        }
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut().then(() => { window.location.href = 'login.html'; }); });
    </script>
</body>
</html>
