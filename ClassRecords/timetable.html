<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²è¡¨æš¨èª¿èª²ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<style>
/* CSS æ¨£å¼ä»£ç¢¼... (ä¿æŒä¸è®Š) */
:root {
    --primary-bg: #f8f9fa;
    --header-bg: #005a87;
    --text-color: #333;
    --border-color: #dee2e6;
    --accent-color: #007bff;
    --modal-bg: #fff;
    --modal-shadow: rgba(0,0,0,0.2);
    --table-header-bg: #e9ecef;
    --highlight-bg: #fff3cd;
    --suggestion-bg: #d1e7dd;
    --suggestion-border: #a3cfbb;
    --cleared-bg: #fdfdfd;
    --list-item-hover-bg: #e9ecef;
    --substitution-bg: #e9ecef; 
    --substitution-border: #adb5bd;
    --exchange-bg: #fff0f5;
    --exchange-border: #ffb6c1;
}
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif;
    background-color: var(--primary-bg);
    color: var(--text-color);
    margin: 0;
    line-height: 1.6;
}
button, input, select, textarea {
    font-family: inherit;
}
header {
    background-color: #4a90e2;
    color: white;
    padding: 0.6rem 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1000;
}
header h1 { font-size: 1.6em; margin: 0; }
header .header-actions button {
    background: none; border: 1px solid white; color: white;
    padding: 5px 10px; border-radius: 4px; cursor: pointer;
    margin-left: 10px; font-size: 1em;
}
.container {
    max-width: 1500px; margin: 20px auto; background: var(--modal-bg);
    padding: 20px 30px; border-radius: 8px; box-shadow: 0 4px 8px var(--modal-shadow);
}
.controls-header {
    display: grid;
    grid-template-columns: 1fr 1fr; 
    gap: 20px; 
    align-items: center; 
    margin-bottom: 2em;
}
.control-group { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
}
.control-group span { font-size: 1.1em; }
#class-selector, #search-teacher {
    font-size: 1em; padding: 5px 8px; border-radius: 4px;
    border: 1px solid #ccc; font-family: inherit;
}
#search-teacher { 
    width: 300px; 
    min-width: 150px;
    justify-self: start;
    margin-left: 0; 
}
#class-selector { 
    width: 300px; 
    min-width: 150px; 
    justify-self: end;
    margin-right: 0; 
}

.hidden { display: none !important; }
#teacher-list-by-subject-container { column-count: 6; column-gap: 6px; } 
.department-table { break-inside: avoid; margin-bottom: 15px; width: 100%; border-collapse: collapse; font-size: 15px; }
.department-table th { background-color: var(--header-bg); color: white; padding: 2px; text-align: center; font-weight: normal; }
.department-table td { border: 1px solid var(--border-color); padding: 2px 6px; white-space: normal; text-align: center; }
.department-table .name-cell { width: 40%; cursor: pointer; color: var(--accent-color); text-decoration: underline; }
.department-table .ext-cell { width: 50px; } 
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
.modal-content { margin: 1% auto; padding: 15px; border: 1px solid var(--border-color); width: 100%; border-radius: 8px; box-shadow: 0 5px 15px var(--modal-shadow); position: relative; background-color: var(--modal-bg); }
.main-modal .modal-content { max-width: 1000px; }
.sub-modal .modal-content { max-width: 480px; text-align: center; padding: 20px; }
.close-button { color: #aaa; position: absolute; top: 10px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; }
.close-button:hover, .close-button:focus { color: #333; }
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 40px 0 10px;
    margin-bottom: 5px;
}
#modal-title { text-align: center; margin: 0; color: var(--header-bg); }
#modal-title2 { text-align: left; margin: 0; font-size: 16px; color: blue; font-weight: normal; flex-grow: 1; }
.week-navigator {
    display: flex;
    align-items: center;
    gap: 10px;
}
.week-navigator button {
    font-size: 0.9em; padding: 3px 10px; border-radius: 4px;
    border: 1px solid var(--border-color); background-color: #fff;
    cursor: pointer; font-family: inherit;
}
.week-navigator button.current {
    color: blue;
    border-color: var(--accent-color);
}
#swap-confirm-modal .modal-content, #substitution-modal .modal-content { text-align: left; }
#swap-details, #substitution-details { background-color: #f1f1f1; border-radius: 4px; padding: 10px; margin-bottom: 20px; }
#swap-details p { margin: 5px 0; }
.date-picker-group { margin-bottom: 15px; }
.date-picker-group label { display: block; margin-bottom: 5px; }
.date-picker-group input[type="date"], .date-picker-group select, .date-picker-group textarea { width: 100%; box-sizing: border-box; padding: 8px; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; font-family: inherit;}
#confirm-swap-btn, #confirm-substitution-btn { width: 100%; padding: 10px; font-size: 1.1em; border: none; color: white; border-radius: 4px; cursor: pointer; }
#confirm-swap-btn { background-color: var(--accent-color); }
#single-event-modal h3 { margin-top: 0; color: var(--header-bg); }
#single-event-modal p { margin: 8px 0; }
#single-event-modal div { margin-bottom: 10px; }
#single-event-modal label { display: block; margin-bottom: 5px; text-align: left; }
#single-event-modal input[type="date"], #single-event-modal textarea { font-family: inherit; font-size: 1em; padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 95%; box-sizing: border-box; }
#single-event-modal button { padding: 8px 16px; font-size: 1em; font-family: inherit; border: 1px solid var(--header-bg); background-color: var(--header-bg); color: white; cursor: pointer; border-radius: 4px; }
#single-event-modal button:hover { background-color: #004a6e; }
.schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
.schedule-table th, .schedule-table td { border: 1px solid #999; padding: 2px; text-align: center; vertical-align: middle; word-wrap: break-word; box-sizing: border-box; position: relative; }
.schedule-table th { background-color: var(--table-header-bg); font-weight: bold; height: 35px; }
.schedule-table th:first-child, .schedule-table td:first-child { 
    width: 95px; 
}
.schedule-table td { padding: 0px; font-size: 16px; height: 70px; cursor: pointer; transition: background-color 0.2s;}
.schedule-table td.empty-cell { background-color: var(--cleared-bg); }
.schedule-table td:hover { background-color: #f0f0f0; }
.schedule-table td.empty-cell:hover, .schedule-table td.cleared-cell:hover { background-color: transparent; cursor: default; }
.schedule-table .period-header { 
    font-weight: bold; 
    background-color: var(--table-header-bg); 
    font-size: 1.0em; 
}
.schedule-table .subject { font-weight: normal; display: block; }
.schedule-table .details { font-size: 18px; color: #0000FF; font-weight: bold; display: block; line-height: 1.1; }
.schedule-table .details { font-size: 18px; color: #0000FF; font-weight: bold; display: block; line-height: 1.1; }
.schedule-table td.empty-cell { background-color: var(--cleared-bg); }
.schedule-table td:hover { background-color: #f0f0f0; }
.schedule-table td.empty-cell:hover, .schedule-table td.cleared-cell:hover { background-color: transparent; cursor: default; }
.schedule-table .period-header { 
    font-weight: bold; 
    background-color: var(--table-header-bg); 
    font-size: 1.0em; 
}
.schedule-table .subject { font-weight: normal; display: block; }
.schedule-table .details { font-size: 18px; color: #0000FF; font-weight: bold; display: block; line-height: 1.1; }
/* ã€ã€ã€æ–°å¢ã€‘ã€‘ã€‘: è®“æ‰€æœ‰è¡¨é ­æ—¥æœŸéƒ½è®Šç²—é«” */
.schedule-table thead th .date-span {
     font-weight: bold !important; /* ä½¿ç”¨ !important ç¢ºä¿è¦†è“‹å¯èƒ½æ®˜ç•™çš„ inline style */
}
/* è¦†è“‹ç­ç´šèª²è¡¨ (Class View) çš„æ•´å€‹è¡¨é ­é«˜åº¦ */
#schedule-modal.class-schedule-view .schedule-table th {
    height: 40px; /* ç¯„ä¾‹ï¼šèª¿æ•´ç­ç´šèª²è¡¨è¡¨é ­ç‚º 40px */
    padding: 2px;
}

/* è¦†è“‹ç­ç´šèª²è¡¨ (Class View) çš„å…§å®¹æ ¼å­é«˜åº¦ */
#schedule-modal.class-schedule-view .schedule-table td {
    height: 60px; /* ç¯„ä¾‹ï¼šèª¿æ•´ç­ç´šèª²è¡¨æ ¼å­ç‚º 60px */
    padding: 0;
}
.highlight { background-color: var(--highlight-bg) !important; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
.swap-suggestion { background-color: var(--suggestion-bg) !important; color: #0f5132; outline: 2px dashed var(--suggestion-border); outline-offset: -2px; }
.swap-suggestion .subject, .swap-suggestion .details {color: #0f5132;  line-height: 1.1;}
.swap-suggestion .teacher-detail, .swap-suggestion .ext-detail { display: inline; margin-left: 4px; }
.swap-suggestion .class-detail { display: block; }
.swap-suggestion .class-detail + .teacher-detail { margin-left: 0; }
.cleared-cell { background-color: var(--cleared-bg); }
#user-email {
  margin-right: 15px;
  font-size: 1.0em;
}
header .header-actions {
  display: flex;
  align-items: center;
}
@keyframes pulse-purple {
    from { background-color: var(--modal-bg); }
    to { background-color: #dcd3ef; }
}
@keyframes pulse-orange {
    from { background-color: var(--modal-bg); }
    to { background-color: #ffe8d1; }
}
.swapped-cell {
    border: 1px dashed #b19cd9;
    cursor: help;
	background-color: #e6e0f4 !important; /* æ–°å¢ï¼šæ·ºç´«è‰²èƒŒæ™¯ */
}
/* ... (åœ¨ .swapped-cell ä¹‹å¾Œæ–°å¢) ... */
/* ã€æ–°å¢ä»¥ä¸‹ä¸‰ç¨®ç­ç´šç•°å‹•çš„æ¨£å¼ã€‘ */
.swapped-class-cell {
    background-color: #e6f7ff !important; /* æ·ºè—è‰² */
    border: 1px dashed #7ec6ff;
    cursor: help;
}
.substituted-class-cell {
    background-color: #fff8e6 !important; /* æ·ºæ©˜é»ƒè‰² */
    border: 1px dashed #ffb74d;
    cursor: help;
}
.exchanged-class-cell {
    background-color: #e9f5e9 !important; /* æ·ºç¶ è‰² */
    border: 1px dashed #66bb6a;
    cursor: help;
}
/* ã€æ–°å¢çµæŸã€‘ */
.swapped-cell-pulse {
    animation-name: pulse-purple;
    animation-duration: 1.2s;
    animation-iteration-count: infinite;
    animation-direction: alternate;
}
.exchanged-cell {
    border: 1px dashed #ffc994;
    cursor: help;
	background-color: #fff3e0 !important; /* æ–°å¢ï¼šæ·ºæ©˜è‰²èƒŒæ™¯ */
}
.exchanged-cell-pulse {
    animation-name: pulse-orange;
    animation-duration: 1.2s;
    animation-iteration-count: infinite;
    animation-direction: alternate;
}
#exchange-modal .disabled-cell {
    background-color: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
}
#exchange-modal .disabled-cell:hover {
    background-color: #e9ecef;
}
#exchange-modal .exchange-target-cell {
    background-color: #d1e7dd;
    color: #0f5132;
    cursor: pointer;
}
#exchange-modal .exchange-target-cell:hover {
    background-color: #badbcc;
}
.swap-confirm-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 15px 10px;
    align-items: center;
    margin-bottom: 25px;
}
.swap-info-box {
    text-align: left;
    background-color: #f1f1f1;
    padding: 12px;
    border-radius: 4px;
    line-height: 1.4;
}
.swap-info-box b {
    display: block;
    margin-bottom: 4px;
}
.substituted-cell {
    background-color: var(--substitution-bg) !important;
    border: 1px dashed var(--substitution-border);
    cursor: help;
}
.substituted-cell .details {
    font-style: italic;
    color: #6c757d;
}

.week-navigator button.current {
    color: blue;
    border-color: var(--accent-color);
}
.schedule-table thead.current-week th {
    color:blue;
    font-weight: bold;
}
.modal-footer { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
.subtitle-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    margin: 0 10px 10px 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
    min-height: 38px;
}
#substitution-btn {
    display: none;
    padding: 6px 12px;
    font-size: 0.9em;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    flex-shrink: 0;
}
#substitution-btn.visible {
    display: inline-block;
}
.title-container {
	display: flex;
	align-items: center;
	gap: 5px;
}
.dropdown {
	position: relative;
	display: inline-block;
}
.icon-btn {
	background: none;
	border: none;
	color: white;
	cursor: pointer;
	font-size: 0.8em;
	padding: 5px;
	line-height: 1;
}
.dropdown-content {
	display: none;
	position: absolute;
	background-color: white;
	min-width: 180px;
	box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
	z-index: 1001;
	border-radius: 4px;
	overflow: hidden;
	left: 0;
}
.dropdown-content button {
	color: #333;
	padding: 10px 15px;
	text-decoration: none;
	display: block;
	width: 100%;
	text-align: left;
	background: none;
	border: none;
	cursor: pointer;
	font-size: 0.95em;
}
.dropdown-content button:hover {
	background-color: #f1f1f1;
}
.dropdown-content.show {
	display: block;
}
/* CSS æ¨£å¼ä»£ç¢¼... */

/* ... (åœ¨æ‰€æœ‰ .modal-content ä¹‹å¾Œæ–°å¢) ... */

/* ğŸ¯ CORE FIX ğŸ¯: ç¢ºä¿ç´”ç€è¦½æ¨¡æ…‹æ¡†çš„é«˜åº¦å’Œä½ˆå±€ */
#view-only-modal .modal-content { 
    max-width: 900px; 
    display: flex; 
    flex-direction: column; 
    /* ç§»é™¤é ‚éƒ¨ marginï¼Œè®“å…§å®¹æ›´å¾€ä¸Š */
    margin: 5vh auto; 
}
/* ğŸ¯ CORE FIX ğŸ¯: è¨­ç½®èª²è¡¨ä¸»é«”å¯æ²å‹• */
#view-only-modal-body {
    overflow-y: auto; 
    overflow-x: hidden;
    flex-grow: 1; /* è®“å…§å®¹ä½”æ»¿å‰©é¤˜ç©ºé–“ */
    /* å¢åŠ å…§è·ï¼Œèˆ‡æ¨™é¡Œå€å¡Šåˆ†é–‹ */
    padding-top: 15px; 
}
#view-only-modal .modal-header {
    /* ç¢ºä¿æ¨™é¡Œå€å¡Šä¸æœƒå› ç‚º flex-grow è€Œè¢«å£“ç¸® */
    flex-shrink: 0;
}
#view-only-modal-body .schedule-table {
    /* ç¢ºä¿è¡¨æ ¼åœ¨å®¹å™¨å…§è‡ªé©æ‡‰å¯¬åº¦ */
    width: 100%;
}

#view-only-modal .schedule-table {
    table-layout: fixed; /* ä¿æŒ fixed ä½ˆå±€ä»¥å‡åˆ†å¯¬åº¦ */
}
		
/* ğŸ¯ CORE FIX ğŸ¯: ç´”ç€è¦½æ¨¡å¼ä¸‹ï¼Œå–®ç¨è¨­å®šè¡¨æ ¼å–®å…ƒæ ¼çš„é«˜åº¦ */
#view-only-modal .schedule-table td {
    height: 50px; /* æ‚¨å¸Œæœ›è¨­å®šçš„å¯¦éš›é«˜åº¦ï¼Œä¾‹å¦‚ 60px */
    padding: 0;
}

/* ğŸ¯ CORE FIX ğŸ¯: å¦‚æœè¦èª¿æ•´è¡¨é ­é«˜åº¦ï¼Œå¯ä»¥åœ¨æ­¤è™•è¨­å®š */
#view-only-modal .schedule-table th {
    height: 30px; /* ä¾‹å¦‚ 30px */
}
@media screen and (max-width: 768px) {
    body { padding: 0; }
    header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 0.6rem 1rem;
    }
    header h1 {
        font-size: 1.6em;
        flex-shrink: 0;
    }
    header .header-actions button {
        padding: 4px 8px;
        font-size: 0.9em;
    }
    .container { padding: 10px; margin: 10px; }
    .close-button { top: 10px; right: 15px; }
	.controls-header {
		display: grid;
		grid-template-columnd: 1fr 1fr;
		gap: 10px 15px;
		justify-content: unset;
		margin-bottom: 1.5em;
		font-size: 0.9em;
	}
	.controls-header .control-group {
		margin: 0;
		display: block; 
	}
    #class-selector {
        width: 100%;
    }
    #view-by-subject-btn {
        width: 100%;
    }
    .view-toggle-btn {
		padding: 5px 10px;
		font-size: 1em; 
	}
    .modal-header { flex-direction: column; gap: 10px; }
    .modal-content { width: 90%; margin: 5% auto; }
    #modal-title2 { font-size: 12px; }
	#teacher-list-by-subject-container { 
		column-count: 2; 
		column-gap: 2px; 
	}
    .department-table { font-size: 14px; }
	.department-table .name-cell { width: 40%; }
    #search-teacher { width: 120px; }
    .schedule-table th { font-size: 12px; }
    .schedule-table td { font-size: 12px; height: 65px; }
    .schedule-table .details { font-size: 12px; }
	.schedule-table th:first-child, .schedule-table td:first-child { width: 65px; padding: 0px;}
    .schedule-table th:not(:first-child), .schedule-table td:not(:first-child) { width: 18%; }
    .swap-suggestion .details { display: block; margin-left: 0px; line-height: 1.2; }
}

</style>

</head>
<body>
	<header>
        <div class="title-container">
            <h1>èª²è¡¨ç³»çµ±</h1>
            <div class="dropdown">
                <button id="recent-schedules-btn" class="icon-btn">â–¼</button>
                <div id="recent-schedules-list" class="dropdown-content">
                    </div>
            </div>
        </div>
        <div class="header-actions">
            <span id="user-email"></span>
			<button onclick="history.back()">è¿”å›ä¸»é </button>
            <button id="logout-btn">ç™»å‡º</button>
        </div>
    </header>
 
    <div class="container">
        <div class="controls-header">
            <input type="search" id="search-teacher" placeholder="æœå°‹æ•™å¸«">
            <select id="class-selector"><option value="" disabled selected>ç­ç´šèª²è¡¨</option></select>
		</div>

        <div id="teacher-list-column">
            <div id="teacher-list-by-subject-container"><p>æ­£åœ¨è¼‰å…¥æ•™å¸«åˆ—è¡¨...</p></div>
        </div>
    </div>

    <div id="schedule-modal" class="modal main-modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <div class="week-navigator">
                    <button id="prev-week-btn">â€¹ ä¸Šä¸€é€±</button>
                    <button id="today-btn">å›åˆ°æœ¬é€±</button>
                    <button id="next-week-btn">ä¸‹ä¸€é€± â€º</button>
                </div>
            </div>
			<div class="subtitle-header">
                <h3 id="modal-title2"></h3>
                <button id="substitution-btn">æŒ‡å®šä»£èª² / æ›èª²</button>
            </div>
            <div id="reminder-container"></div>
            <div id="modal-body"></div>
        </div>
    </div>

    <div id="single-event-modal" class="modal sub-modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>å°‡èª²ç¨‹åŠ å…¥è¡Œäº‹æ›†</h3>
            <p id="single-event-info"></p>
            <div>
                <label for="single-event-date">é¸æ“‡æ—¥æœŸï¼š</label>
                <input type="date" id="single-event-date">
            </div>
            <div>
                <label for="event-notes">è¨»è¨˜ (ä¾‹å¦‚ï¼šå°è€ƒã€äº¤ä½œæ¥­)ï¼š</label>
                <textarea id="event-notes" rows="3" placeholder="æ­¤è™•çš„æ–‡å­—å°‡æœƒé¡¯ç¤ºåœ¨è¡Œäº‹æ›†äº‹ä»¶çš„èªªæ˜ä¸­..."></textarea>
            </div>
            <p><button id="download-single-ics-btn">ä¸‹è¼‰ .ics æª”æ¡ˆ</button></p>
        </div>
    </div>

	<div id="swap-confirm-modal" class="modal sub-modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>ç¢ºèªèª¿èª²</h3>
            
            <div class="swap-confirm-grid">
                <div id="original-class-info" class="swap-info-box"></div>
                <input type="date" id="original-class-date">
                <div id="target-class-info" class="swap-info-box"></div>
                <input type="date" id="target-class-date">
            </div>

            <p><button id="confirm-swap-btn">ç¢ºèªèª¿èª²</button></p>
        </div>
    </div>

	<div id="substitution-modal" class="modal sub-modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>æŒ‡å®šä»£èª² / æ›èª²</h3>
            
            <div id="substitution-details"></div>
            <div class="date-picker-group">
                <label for="substitution-date">è«‹å‡æ—¥æœŸï¼š</label>
                <input type="date" id="substitution-date">
            </div>
            <div class="date-picker-group">
                <label for="substitution-reason">äº‹ç”± (é¸å¡«)ï¼š</label>
                <textarea id="substitution-reason" rows="2" placeholder="äº‹ç”±å°‡é¡¯ç¤ºåœ¨èª²è¡¨æ ¼å­çš„æç¤ºä¸­..."></textarea>
            </div>
            <hr style="margin: 20px 0;">

            <div class="date-picker-group">
                <label for="substitute-teacher-select">é¸æ“‡ä»£èª²è€å¸«ï¼š</label>
                <select id="substitute-teacher-select"></select>
            </div>
            <div class="control-group" style="margin: 20px 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <input type="checkbox" id="exchange-checkbox" style="width: auto; height: 1.2em; transform: scale(1.2);">
                <label for="exchange-checkbox">é€™æ˜¯ä¸€æ¬¡äº’ç›¸æ›èª² (æˆ‘è¦é‚„èª²)</label>
            </div>
            
            <p><button id="confirm-substitution-btn">è«‹å…ˆé¸æ“‡è€å¸«</button></p>
        </div>
    </div>

    <div id="exchange-modal" class="modal main-modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="exchange-modal-title" style="text-align: center;"></h2>
            <h3 id="exchange-modal-subtitle" style="text-align: center; color: #555; font-weight: normal;"></h3>
            <div class="modal-header" style="padding: 0; margin-bottom: 15px;">
                <div class="week-navigator" style="margin: auto;">
                    <button id="exchange-prev-week-btn">â€¹ ä¸Šä¸€é€±</button>
                    <button id="exchange-today-btn">å›åˆ°æœ¬é€±</button>
                    <button id="exchange-next-week-btn">ä¸‹ä¸€é€± â€º</button>
                </div>
            </div>
            <div id="exchange-modal-body"></div>
        </div>
    </div>
	<div id="view-only-modal" class="modal main-modal">
        <div class="modal-content">
            <span class="close-button" id="view-only-close-btn">&times;</span>
            <div class="modal-header">
                <button id="back-to-class-btn" style="padding: 5px 10px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    è¿”å›ç­ç´šèª²è¡¨
                </button>
                <h2 id="view-only-modal-title" style="flex-grow: 1; text-align: center;"></h2>
            </div>
            <div id="view-only-modal-body"></div>
        </div>
    </div>
    <div id="welcome-modal-timetable" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: left; line-height: 1.8;">
            <span class="close-button">&times;</span>
            <h2>æ­¡è¿ä½¿ç”¨ èª²è¡¨ç³»çµ±</h2>
            <p>é€™æ˜¯ä¸€å¥—æ•´åˆæ€§çš„èª²è¡¨å·¥å…·ï¼Œæ‚¨å¯ä»¥ï¼š</p>
            <ul>
                <li><strong>æŸ¥è©¢èª²è¡¨</strong>: å¿«é€ŸæŸ¥è©¢å€‹äººã€ç­ç´šèª²è¡¨ã€‚</li>
                <li><strong>æ™ºæ…§èª¿èª²</strong>: é»æ“Šè‡ªå·±èª²è¡¨ä¸Šçš„èª²ç¨‹ï¼Œç³»çµ±æœƒè‡ªå‹•ä»¥<span style="background-color: #d1e7dd; padding: 2px 4px; border-radius: 3px;">ç¶ è‰²</span>æ¨™ç¤ºå‡ºå¯äº’ç›¸èª¿èª²çš„æ™‚æ®µã€‚</li>
                <li><strong>æŒ‡å®šä»£èª²/æ›èª²</strong>: é»æ“Šè‡ªå·±èª²è¡¨å¾Œï¼Œå¯æŒ‡å®šå¦ä¸€ä½è€å¸«é€²è¡Œå–®ç´”çš„ã€Œä»£èª²ã€ï¼Œæˆ–ç™¼èµ·äº’ç›¸æ”¯æ´çš„ã€Œæ›èª²ã€ã€‚</li>
                <li><strong>åŠ å…¥è¡Œäº‹æ›†</strong>: åœ¨ä»»ä½•èª²è¡¨ä¸Šé•·æŒ‰ (æˆ–æ»‘é¼ å³éµé»æ“Š) æŸä¸€ç¯€èª²ï¼Œå³å¯å°‡è©²èª²ç¨‹è³‡è¨Šä¸‹è¼‰æˆ .ics æª”æ¡ˆï¼Œæ–¹ä¾¿åŒ¯å…¥å€‹äººè¡Œäº‹æ›†ã€‚</li>
            </ul>
            <div class="modal-footer">
                <label><input type="checkbox" id="dont-show-again-timetable"> ä»¥å¾Œä¸è¦å†é¡¯ç¤ºæ­¤è¨Šæ¯</label>
                <button id="close-welcome-timetable-btn" style="width: auto; padding: 8px 20px; background-color: #4a90e2; color: white;">æˆ‘äº†è§£äº†</button>
            </div>
        </div>
    </div>
	<div id="multiple-ics-export-modal" class="modal">
		<div class="modal-content" style="max-width: 500px;">
			<span class="close-button">&times;</span>
			<h2 id="multiple-ics-modal-title">èª¿/æ›èª²ç•°å‹•è¡Œäº‹æ›†åŒ¯å‡º</h2>
			<p style="color: #007bff;">ä»¥ä¸‹ç‚ºæœ¬æ¬¡ç•°å‹•ç›¸é—œçš„å…©ç­†äº‹ä»¶ï¼Œå°‡åŒ¯å‡ºåœ¨åŒä¸€å€‹æª”æ¡ˆä¸­ï¼š</p>
			
			<div id="multiple-ics-event-details" style="max-height: 40vh; overflow-y: auto; margin-bottom: 15px;">
				</div>

			<button id="multiple-ics-download-btn" class="primary-btn" style="width: 100%;">
				ä¸‹è¼‰åˆä½µè¡Œäº‹æ›† (.ics) æª”æ¡ˆ
			</button>
		</div>
	</div>

<script>
// --- Firebase åˆå§‹åŒ–èˆ‡ç™»å…¥é©—è­‰ ---
  const firebaseConfig = {
    apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
    authDomain: "classrecords-13902.firebaseapp.com",
    projectId: "classrecords-13902",
    storageBucket: "classrecords-13902.firebasestorage.app",
    messagingSenderId: "431747377367",
    appId: "1:431747377367:web:b157a8f5c59ce38091e892",
    measurementId: "G-JWTQGM9XMP"
  };

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let currentUser = null;
let currentUserDisplayName = '';
const recentSchedulesBtn = document.getElementById('recent-schedules-btn');
const recentSchedulesList = document.getElementById('recent-schedules-list');
const MAX_RECENT_ITEMS = 10;

// å‹•æ…‹æ™‚é–“è¡¨æ•¸æ“š
let PERIOD_TIMES = []; 
let scheduleSnapshot = null;

// ç”¨æ–¼ç·©å­˜ teachers é›†åˆè³‡æ–™
let teachersDataCache = new Map(); 

// å®šç¾©é ˜åŸŸåˆ—è¡¨çš„å„ªå…ˆé †åº
const SUBJECT_ORDER = ['åœ‹æ–‡', 'è‹±èª', 'æ•¸å­¸', 'ç¤¾æœƒ', 'è‡ªç„¶', 'ç¶œåˆ', 'è—è¡“', 'å¥é«”', 'ç§‘æŠ€'];


auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        const displayElement = document.getElementById('user-email');

        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) { 
                const userData = userDoc.data();
                if (userData.displayName) {
                    displayElement.textContent = userData.displayName;
                    currentUserDisplayName = userData.displayName;
                } else {
                    displayElement.textContent = user.email;
                    currentUserDisplayName = user.email;
                }
            } else {
                displayElement.textContent = user.email;
            }
        } catch (e) {
            displayElement.textContent = user.email;
        }

        main();
    } else {
        window.location.href = 'login.html';
    }
});

document.getElementById('logout-btn').addEventListener('click', () => {
    auth.signOut();
});

// --- è¼”åŠ©å‡½æ•¸ï¼šæ™‚é–“å’Œæ—¥æœŸè™•ç† ---

/**
 * æ ¹æ“šç¯€æ¬¡è™Ÿç¢¼ (1-8) æŸ¥æ‰¾å…¶æ™‚é–“è³‡è¨Šã€‚
 */
function getPeriodTimeInfo(periodNum) {
    const info = PERIOD_TIMES.find(p => p.period === periodNum);
    if (!info) return null;

    const [startH, startM] = info.start.split(':').map(Number);
    const totalMinutes = startH * 60 + startM + info.duration;
    const endH = Math.floor(totalMinutes / 60) % 24;
    const endM = totalMinutes % 60;
    const pad = (n) => String(n).padStart(2, '0');

    return {
        start: info.start,
        duration: info.duration,
        end: `${pad(endH)}:${pad(endM)}`, 
        endMinutes: totalMinutes
    };
}

function getMonday(d) {
    d = new Date(d);
    d.setHours(0, 0, 0, 0);
    const day = d.getDay(),
        diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff));
}

function formatDate(date, format = 'MM/DD') {
    if (!date) return '';
    const month = date.getMonth() + 1;
    const day = date.getDate();
    if (format === 'YYYY-MM-DD') {
        return `${date.getFullYear()}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    }
    return `${month}/${day}`;
}

/**
 * è¼‰å…¥å­¸æ ¡è¨­å®šçš„æ¯ç¯€èª²é–‹å§‹æ™‚é–“å’ŒæŒçºŒæ™‚é–“ã€‚
 */
async function loadPeriodTimesFromFirestore(schoolId) {
    try {
        const periodsDoc = await db.collection('schools').doc(schoolId)
                                   .collection('periods').doc('current').get();

        if (periodsDoc.exists && periodsDoc.data().times && periodsDoc.data().times.length > 0) {
            PERIOD_TIMES = periodsDoc.data().times.map(item => ({
                period: item.period,
                start: item.start,
                duration: item.duration || 50 
            }));
            PERIOD_TIMES.sort((a, b) => a.period - b.period);
        } else {
            PERIOD_TIMES = [
                { period: 1, start: '08:10', duration: 50 },
                { period: 2, start: '09:10', duration: 50 },
                { period: 3, start: '10:10', duration: 50 },
                { period: 4, start: '11:10', duration: 50 },
                { period: 5, start: '13:10', duration: 50 },
                { period: 6, start: '14:10', duration: 50 },
                { period: 7, start: '15:10', duration: 50 },
                { period: 8, start: '16:10', duration: 50 }
            ];
        }
    } catch (error) {
    }
}


// --- main å‡½æ•¸ ---

async function main() {
    populateRecentList();
    const welcomeModal = document.getElementById('welcome-modal-timetable');
    if (localStorage.getItem('hideTimetableWelcome') !== 'true') {
        setTimeout(() => {
            welcomeModal.style.display = 'block';
        }, 500);
    }

    const closeWelcome = () => {
        if (document.getElementById('dont-show-again-timetable').checked) {
            localStorage.setItem('hideTimetableWelcome', 'true');
        }
        welcomeModal.style.display = 'none';
    };

    welcomeModal.querySelector('.close-button').onclick = closeWelcome;
    document.getElementById('close-welcome-timetable-btn').onclick = closeWelcome;
    
    const urlParams = new URLSearchParams(window.location.search);
    const teacherNameToShow = urlParams.get('teacher');
    
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    if (!userDoc.exists || !userDoc.data().schoolId) {
        alert('éŒ¯èª¤ï¼šæ‚¨çš„å¸³è™Ÿè³‡æ–™ä¸å®Œæ•´ï¼Œæ‰¾ä¸åˆ° schoolIdã€‚');
        document.querySelector('.container').innerHTML = '<h2>è®€å–è³‡æ–™å¤±æ•—ï¼šå¸³è™Ÿæœªç¶å®šå­¸æ ¡ IDã€‚</h2>';
        return;
    }
    const userData = userDoc.data();
    const schoolId = userData.schoolId;
    
    await loadPeriodTimesFromFirestore(schoolId);

	const schoolRef = db.collection('schools').doc(schoolId);
	
	scheduleSnapshot = await schoolRef.collection('timetables').get();
    
    const teachersSnapshot = await schoolRef.collection('teachers').get();
    teachersDataCache.clear();
    teachersSnapshot.forEach(doc => {
        teachersDataCache.set(doc.id, doc.data());
    });

    const teacherNameToId = new Map();
    const usersSnapshot = await db.collection('users').where('schoolId', '==', schoolId).get();
    usersSnapshot.forEach(doc => {
        const userData = doc.data();
        if (userData.displayName && userData.role === 'teacher') {
            teacherNameToId.set(userData.displayName, doc.id);
        }
    });

    const classSchedules = new Map();
    const teacherSchedules = new Map();
    
    let currentView = 'subject'; 
    let longPressTimer;
    const LONG_PRESS_DURATION = 500;
    
    let currentWeekStart = getMonday(new Date());
    let activeSchedule = { type: null, name: null };
    let teacherViewSelectedCell = null;
    let classViewSelectedCell = null;
    
    let activeChanges = [];

    let allTeachersList = [];
    let substitutionInfo = {};

    function log(message) {
        console.log(message);
    }

    function findNextAvailableDate(initialDate, period, day) {
        let nextAvailableDate = new Date(initialDate);
        let safetyCounter = 0;

        while (safetyCounter < 100) {
            const dateString = formatDate(nextAvailableDate, 'YYYY-MM-DD');
            const dayIndex = nextAvailableDate.getDay() - 1;
            
            const conflict = activeChanges.find(change => {
                if (change.type === 'substitution' || (change.type === 'exchange' && change.originalLessonInfo) ) {
                    const info = change.type === 'substitution' ? change.lessonInfo : change.originalLessonInfo;
                    const changeDate = change.type === 'substitution' ? change.date : info.date;
                    return changeDate === dateString && info.period === period && dayIndex === day;
                }
                if (change.type === 'swap') {
                    const infoA = change.originalClassInfo;
                    const infoB = change.targetClassInfo;
                    return (infoA.date === dateString && infoA.period === period && infoA.day === day) ||
                           (infoB.date === dateString && infoB.period === period && infoB.day === day);
                }
                return false;
            });

            if (conflict) {
                nextAvailableDate.setDate(nextAvailableDate.getDate() + 7);
                safetyCounter++;
            } else {
                return nextAvailableDate;
            }
        }
        
        console.warn("å°‹æ‰¾å¯ç”¨æ—¥æœŸè¶…é 100 é€±ï¼Œå¯èƒ½å­˜åœ¨é‚è¼¯å•é¡Œã€‚");
        return new Date(initialDate);
    }
    
	function isDateConflict(dateString, period, day) {
        const dayIndex = new Date(dateString).getDay() - 1;
        if (dayIndex !== day) {
        }

        const conflict = activeChanges.find(change => {
            if (change.status !== 'active') return false;

            if (change.type === 'substitution') {
                return change.date === dateString && change.lessonInfo.period === period;
            }
            if (change.type === 'exchange') {
                const infoA = change.originalLessonInfo;
                const infoB = change.exchangeLessonInfo;
                return (infoA.date === dateString && infoA.period === period) ||
                       (infoB.date === dateString && infoB.period === period);
            }
            if (change.type === 'swap') {
                const infoA = change.originalClassInfo;
                const infoB = change.targetClassInfo;
                return (infoA.date === dateString && infoA.period === period && infoA.day === day) ||
                       (infoB.date === dateString && infoB.period === period && infoB.day === day);
            }
            return false;
        });

        return conflict || null;
    }
	
    async function loadActiveChanges() {
        const involvedQuery = db.collection('classChanges')
                                .where('involvedTeacherIds', 'array-contains', currentUser.uid)
                                .where('status', '==', 'active');
                                
        const snapshot = await involvedQuery.get();
        activeChanges = [];
        snapshot.forEach(doc => {
            activeChanges.push({ id: doc.id, ...doc.data() });
        });
    }

    function parseSchedulesFromFirestore(allTeachers) {
        scheduleSnapshot.forEach(doc => {
            const teacherName = doc.id;
            const data = doc.data();
            
            if (!isValidTeacher(teacherName)) return;
            allTeachers.add(teacherName);
            
            if (!teacherSchedules.has(teacherName)) {
                 teacherSchedules.set(teacherName, Array.from({ length: 8 }, () => Array(5).fill(null)));
            }
            const teacherGrid = teacherSchedules.get(teacherName);
            
            const cachedData = teachersDataCache.get(teacherName) || {};
            const subject = cachedData.subject || data.subject || 'å…¶ä»–';
            const title = cachedData.title || data.title || 'å°ˆä»»æ•™å¸«'; 
            

            if (data.periods) {
                for (const periodKey in data.periods) {
                    const period = parseInt(periodKey, 10);
                    if (period < 0 || period >= 8) continue;
                    
                    const dailyLessons = data.periods[periodKey];
                    for(let day = 0; day < dailyLessons.length; day++) {
                        const cellContent = dailyLessons[day];
                        if (cellContent) {
                            const [className, ...subjectParts] = cellContent.split(/\s+/);
                            const extractedSubject = subjectParts.join(' ').trim(); 
                            const finalSubject = extractedSubject || subject; 
                            
                            if(className) {
                                teacherGrid[period][day] = { 
                                    subject: finalSubject, 
                                    class: className, 
                                    location: '', 
                                    period, 
                                    title 
                                };

                                if (!classSchedules.has(className)) {
                                    classSchedules.set(className, Array.from({ length: 8 }, () => Array(5).fill(null)));
                                }
                                classSchedules.get(className)[period][day] = { subject: finalSubject, teacher: teacherName, location: '' };
                                
                            }
                        }
                    }
                }
            }
        });
    }

	/**
	 * è¼‰å…¥åŸºç¤èª²è¡¨ä¸¦æ‡‰ç”¨æ‰€æœ‰ç•¶å‰é€±æ¬¡çš„ active èª²ç¨‹ç•°å‹•ï¼ˆèª¿èª²ã€ä»£èª²ã€æ›èª²ï¼‰ã€‚
	 */
	async function deriveSchedules() {
		await loadActiveChanges();
		
		teacherSchedules.clear();
		classSchedules.clear();

		const allTeachers = new Set();
		const baseTeacherSchedules = new Map();

		parseSchedulesFromFirestore(allTeachers);

		for (const [teacher, schedule] of teacherSchedules.entries()) {
			baseTeacherSchedules.set(teacher, JSON.parse(JSON.stringify(schedule)));
		}

		activeChanges.forEach(change => {
			
			if (change.type === 'swap' || change.type === 'substitution') {
				const changeDateStr = change.type === 'swap' ? change.originalClassInfo.date : change.date;
				const changeDate = new Date(changeDateStr);
				const changeWeekStart = getMonday(changeDate);
				
				if (changeWeekStart.getTime() !== currentWeekStart.getTime()) return;
				
				if (change.type === 'swap') {
					const teacherA_name = change.originalClassInfo.teacher;
					const teacherB_name = change.targetClassInfo.teacher;
					const scheduleA = teacherSchedules.get(teacherA_name);
					const scheduleB = teacherSchedules.get(teacherB_name);

					if (scheduleA && scheduleB) {
						const infoA = change.originalClassInfo;
						const infoB = change.targetClassInfo;
						scheduleA[infoA.period][infoA.day] = { ...infoB, class: infoA.class, isSwappedIn: true, changeId: change.id };
						scheduleA[infoB.period][infoB.day] = { ...infoA, isSwappedOut: true, changeId: change.id };
						scheduleB[infoB.period][infoB.day] = { ...infoA, class: infoB.class, isSwappedIn: true, changeId: change.id };
						scheduleB[infoA.period][infoA.day] = { ...infoB, isSwappedOut: true, changeId: change.id };
						/* ã€æ–°å¢ä»¥ä¸‹ç­ç´šèª²è¡¨æ›´æ–°é‚è¼¯ã€‘ */
						const classA_schedule = classSchedules.get(infoA.class);
						const classB_schedule = classSchedules.get(infoB.class); 
						
						if (classA_schedule) {
							// ç­ç´š A: åŸå§‹æ™‚æ®µè¢« B çš„èª²å–ä»£ï¼Œèª¿æ›æ™‚æ®µè¢« B çš„èª²å–ä»£
							classA_schedule[infoA.period][infoA.day] = { subject: infoB.subject, teacher: teacherB_name, location: infoB.location, isSwapped: true, changeId: change.id };
							classA_schedule[infoB.period][infoB.day] = { subject: infoA.subject, teacher: teacherA_name, location: infoA.location, isSwapped: true, changeId: change.id };
						}
						
						if (classB_schedule) {
							// ç­ç´š B: åŸå§‹æ™‚æ®µè¢« A çš„èª²å–ä»£ï¼Œèª¿æ›æ™‚æ®µè¢« A çš„èª²å–ä»£
							classB_schedule[infoB.period][infoB.day] = { subject: infoA.subject, teacher: teacherA_name, location: infoA.location, isSwapped: true, changeId: change.id };
							classB_schedule[infoA.period][infoA.day] = { subject: infoB.subject, teacher: teacherB_name, location: infoB.location, isSwapped: true, changeId: change.id };
						}
						/* ã€æ–°å¢çµæŸã€‘ */
					}
				} else { 
					const originalTeacher = change.originalTeacherName;
					const substituteTeacher = change.substituteTeacherName;
					const scheduleOriginal = teacherSchedules.get(originalTeacher);
					const scheduleSubstitute = teacherSchedules.get(substituteTeacher);
					const lessonInfo = change.lessonInfo;
					const dayIndex = new Date(change.date).getDay() - 1; 

					if (scheduleOriginal && dayIndex >= 0 && dayIndex < 5) {
						scheduleOriginal[lessonInfo.period][dayIndex] = { ...lessonInfo, isSubstitutedOut: true, substituteTeacherName: substituteTeacher, reason: change.reason, changeId: change.id };
					}
					if (scheduleSubstitute && dayIndex >= 0 && dayIndex < 5) {
						scheduleSubstitute[lessonInfo.period][dayIndex] = { ...lessonInfo, isSubstitutedIn: true, originalTeacherName: originalTeacher, reason: change.reason, changeId: change.id };
					}
					/* ã€æ–°å¢ä»¥ä¸‹ç­ç´šèª²è¡¨æ›´æ–°é‚è¼¯ã€‘ */
					const classSchedule = classSchedules.get(lessonInfo.class);
					if (classSchedule && dayIndex >= 0 && dayIndex < 5) {
						// ç­ç´šèª²è¡¨: è©²ç¯€æ¬¡é¡¯ç¤ºä»£èª²è€å¸«
						classSchedule[lessonInfo.period][dayIndex] = { 
							subject: lessonInfo.subject, 
							teacher: substituteTeacher, 
							location: lessonInfo.location, 
							isSubstituted: true, 
							changeId: change.id 
						};
					}
					/* ã€æ–°å¢çµæŸã€‘ */
				}

			} else if (change.type === 'exchange') {
				const teacherA = change.originalLessonInfo.teacher; 
				const teacherB = change.exchangeLessonInfo.teacher; 
				const scheduleA = teacherSchedules.get(teacherA);
				const scheduleB = teacherSchedules.get(teacherB);
				const infoA = change.originalLessonInfo; 
				const infoB = change.exchangeLessonInfo; 

				// A è€å¸«æ›¿ B ä»£èª²çš„æ™‚æ®µ (Info B)
				const weekB = getMonday(new Date(infoB.date));
				if (weekB.getTime() === currentWeekStart.getTime()) {
					const dayB = new Date(infoB.date).getDay() - 1;
					if (scheduleB && dayB >= 0 && dayB < 5) {
						// æ›´æ–° B è€å¸«èª²è¡¨: B è€å¸«çš„èª²è¢« A ä»£èµ°
						scheduleB[infoB.period][dayB] = { ...infoB, isExchangedOut: true, targetTeacher: teacherA, changeId: change.id, reason: change.reason };
					}
					if (scheduleA && dayB >= 0 && dayB < 5) {
						// æ›´æ–° A è€å¸«èª²è¡¨: A è€å¸«å¤šäº†ä»£ B è€å¸«èª²çš„æ™‚æ®µ
						scheduleA[infoB.period][dayB] = { ...infoB, isExchangedIn: true, originalTeacher: teacherB, changeId: change.id, reason: change.reason };
					}
					
					/* ã€æ–°å¢ä»¥ä¸‹ç­ç´šèª²è¡¨æ›´æ–°é‚è¼¯ (æ™‚æ®µ B)ã€‘ */
					const classB_schedule = classSchedules.get(infoB.class);
					if (classB_schedule && dayB >= 0 && dayB < 5) {
						// ç­ç´š B: è©²ç¯€æ¬¡é¡¯ç¤º A è€å¸«ä»£èª²
						classB_schedule[infoB.period][dayB] = { 
							subject: infoB.subject, 
							teacher: teacherA, 
							location: infoB.location, 
							isExchanged: true, 
							changeId: change.id 
						};
					}
					/* ã€æ–°å¢çµæŸã€‘ */
				}
				
				// B è€å¸«æ›¿ A ä»£èª²çš„æ™‚æ®µ (Info A)
				const weekA = getMonday(new Date(infoA.date));
				if (weekA.getTime() === currentWeekStart.getTime()) {
					const dayA = new Date(infoA.date).getDay() - 1;
					if (scheduleA && dayA >= 0 && dayA < 5) {
						// æ›´æ–° A è€å¸«èª²è¡¨: A è€å¸«çš„èª²è¢« B ä»£èµ°
						scheduleA[infoA.period][dayA] = { ...infoA, isExchangedOut: true, targetTeacher: teacherB, changeId: change.id, reason: change.reason };
					}
					if (scheduleB && dayA >= 0 && dayA < 5) {
						// æ›´æ–° B è€å¸«èª²è¡¨: B è€å¸«å¤šäº†ä»£ A è€å¸«èª²çš„æ™‚æ®µ
						scheduleB[infoA.period][dayA] = { ...infoA, isExchangedIn: true, originalTeacher: teacherA, changeId: change.id, reason: change.reason };
					}
					
					/* ã€æ–°å¢ä»¥ä¸‹ç­ç´šèª²è¡¨æ›´æ–°é‚è¼¯ (æ™‚æ®µ A)ã€‘ */
					const classA_schedule = classSchedules.get(infoA.class);
					if (classA_schedule && dayA >= 0 && dayA < 5) {
						// ç­ç´š A: è©²ç¯€æ¬¡é¡¯ç¤º B è€å¸«ä»£èª²
						classA_schedule[infoA.period][dayA] = { 
							subject: infoA.subject, 
							teacher: teacherB, 
							location: infoA.location, 
							isExchanged: true, 
							changeId: change.id 
						};
					}
					/* ã€æ–°å¢çµæŸã€‘ */
				}				
			}
		});
		
		return allTeachers;
	}

    function isValidTeacher(name) {
        if (!name) return false;
        return !/^(è‹±æ–‡å¸«|æ•¸å­¸å¸«|è‡ªç„¶å¸«|å…±é¸å¸«|ç¤¾åœ˜å¸«|å½ˆå­¸å¸«)\d*$/.test(name);
    }

    function isValidClassForListing(name) {
        if (!name) return false;
        return true; 
    }

	/**
	 * æ ¹æ“šé ˜åŸŸæ¸²æŸ“æ•™å¸«åˆ—è¡¨ã€‚
	 */
	function populateTeacherListBySubject(allTeachersWithSchedule) {
        const container = document.getElementById('teacher-list-by-subject-container');
        container.innerHTML = '';
        
        const subjectsMap = new Map();
        
        scheduleSnapshot.forEach(doc => {
            const teacherName = doc.id;
            
            if (allTeachersWithSchedule.has(teacherName)) { 
                
                const cachedData = teachersDataCache.get(teacherName) || {};
                
                const rawSubject = cachedData.subject || 'å…¶ä»–';
                
                const subjects = rawSubject.split(/,|ã€|\s+/).map(s => s.trim()).filter(Boolean);

                subjects.forEach(subjectName => {
                    if (!subjectsMap.has(subjectName)) {
                        subjectsMap.set(subjectName, []);
                    }
                    subjectsMap.get(subjectName).push({
                        name: teacherName,
                        role: cachedData.title || 'æ•™å¸«',
                        ext: '' 
                    });
                });
            }
        });

        const customOrder = SUBJECT_ORDER.reduce((acc, subject, index) => {
            acc[subject] = index;
            return acc;
        }, {});

        const sortedSubjects = [...subjectsMap.keys()].sort((a, b) => {
            const orderA = customOrder[a] !== undefined ? customOrder[a] : Infinity;
            const orderB = customOrder[b] !== undefined ? customOrder[b] : Infinity;

            if (orderA !== Infinity || orderB !== Infinity) {
                return orderA - orderB;
            }
            return a.localeCompare(b, 'zh-Hant');
        });


        if (sortedSubjects.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #6c757d;">æ‰¾ä¸åˆ°æ•™å¸«åˆ—è¡¨ã€‚è«‹ç¢ºèªå­¸æ ¡ç®¡ç†å“¡æ˜¯å¦å·²ä¸Šå‚³ã€Œå…¨æ ¡æ•™å¸«èª²è¡¨ã€åŠã€Œæ•™å¸«åŸºæœ¬è³‡æ–™ã€ã€‚</p>';
            return;
        }

        sortedSubjects.forEach(subjectName => {
            const members = subjectsMap.get(subjectName);
            const table = document.createElement('table');
            table.className = 'department-table';
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const th = document.createElement('th');
            th.colSpan = 3;
            th.textContent = subjectName;
            headerRow.appendChild(th);
            const tbody = table.createTBody();
            members.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(member => {
                const row = tbody.insertRow();
                row.insertCell().textContent = member.role;
                const nameCell = row.insertCell();
                nameCell.className = 'name-cell';
                nameCell.textContent = member.name;
				nameCell.onclick = () => showSchedule(member.name, 'teacher');

                row.insertCell().textContent = '';
            });
            container.appendChild(table);
        });
    }

    function populateClassList() {
        const selector = document.getElementById('class-selector');
        selector.innerHTML = '<option value="" disabled selected>ç­ç´šèª²è¡¨</option>';
        const classesForList = [...classSchedules.keys()].filter(isValidClassForListing).sort();
        classesForList.forEach(name => {
            selector.appendChild(new Option(name, name));
        });
        selector.onchange = function() {
            if (this.value) {
                showSchedule(this.value, 'class');
            }
        };
    }

	/**
	 * é¡¯ç¤ºæ•™å¸«æˆ–ç­ç´šèª²è¡¨ï¼Œä¸¦å•Ÿå‹•å®šæ™‚å™¨ä»¥ç¶­æŒé«˜äº®ã€‚
	 */
	async function showSchedule(name, type) {
		// ğŸ¯ CORE FIX ğŸ¯ï¼šåœ¨æ¯æ¬¡æ¸²æŸ“é–‹å§‹æ™‚ï¼Œå¼·åˆ¶éš±è—ã€ŒæŒ‡å®šä»£èª² / æ›èª²ã€æŒ‰éˆ•
		document.getElementById('substitution-btn').classList.remove('visible'); 

		addRecentSchedule(name, type);
		populateRecentList();

		activeSchedule = { type, name };
		const dataToStore = { 
			savedBy: currentUser.uid, 
			schedule: { view: currentView, ...activeSchedule } 
		};
		localStorage.setItem('lastSchedule', JSON.stringify(dataToStore));
		
		const modal = document.getElementById('schedule-modal');
		if (type === 'class') {
			modal.classList.add('class-schedule-view');
		} else {
			modal.classList.remove('class-schedule-view');
		}		
		const titleEl = document.getElementById('modal-title');
		const titleEl2 = document.getElementById('modal-title2');
		const bodyEl = document.getElementById('modal-body');
		
		const todayWeekStart = getMonday(new Date());
		const isCurrentWeek = currentWeekStart.getTime() === todayWeekStart.getTime();
		
		document.getElementById('today-btn').classList.toggle('current', isCurrentWeek);
		
		await deriveSchedules(); 
		
		let schedule, title;

		if (type === 'teacher' && teacherSchedules.has(name)) {
			schedule = teacherSchedules.get(name);
			title = `${name} èª²è¡¨`;
			const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
			const interactionHint = isTouchDevice ? 'é•·æŒ‰' : 'å³éµ';
			
			if (name === currentUserDisplayName) {
				titleEl2.textContent = `ï¼Šé»æ“Šæœ‰èª²æ ¼å­å¯é€²è¡Œèª¿/ä»£/æ›èª²ï¼ˆé»æ“Šè‡ªå·±èª²ç¨‹ï¼Œå†é»ç¶ è‰²å»ºè­°æ ¼å­ï¼‰ï¼Œ${interactionHint}å¯åŠ å…¥è¡Œäº‹æ›†è¨»è¨˜ï¼Š`;
			} else {
				titleEl2.textContent = `ï¼Š${interactionHint}å¯åŠ å…¥è¡Œäº‹æ›†è¨»è¨˜ï¼Š`;
			}
		} else if (type === 'class' && classSchedules.has(name)) {
			schedule = classSchedules.get(name);
			title = `${name} ç­èª²è¡¨`;
			titleEl2.textContent = 'ï¼Šé»æ“Šæœ‰èª²çš„æ ¼å­å¯çœ‹æ›èª²é¸æ“‡ï¼Š';
		} else {
			bodyEl.innerHTML = `<p style="text-align:center;">æ‰¾ä¸åˆ° ${name} çš„èª²è¡¨è³‡æ–™ã€‚</p>`;
			titleEl.textContent = "è³‡æ–™éŒ¯èª¤";
			if (!modal.style.display || modal.style.display === 'none') modal.style.display = 'block';
			return;
		}
		
		const renderScheduleTable = () => {
			 const modal = document.getElementById('schedule-modal');
			 if (!schedule) return; 
            
			 titleEl.textContent = title;
			 const daysOfWeek = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”'];
			 let tableHtml = '<table class="schedule-table"><thead><tr><th>ç¯€æ¬¡</th>';
			 
			 const weekDates = [];
			 for (let i = 0; i < 5; i++) {
				 const date = new Date(currentWeekStart);
				 date.setDate(currentWeekStart.getDate() + i);
				 weekDates.push(date);
				 tableHtml += `<th>${daysOfWeek[i]}<br><span class="date-span" style="color: #6c757d; font-size: 0.9em;">(${formatDate(date)})</span></th>`;
			 }
			 tableHtml += '</tr></thead><tbody>';

			 const now = new Date();
			 const currentDayIndex = now.getDay() - 1; 
			 const currentPeriodIndex = getPeriodIndexForTimetableHighlight(); 


			 for (let period = 0; period < 8; period++) {
				 const periodTimeInfo = getPeriodTimeInfo(period + 1);
				 const timeRangeStr = periodTimeInfo ? 
					 `<span style="font-size: 0.7em; font-weight: normal; line-height: 1.2; white-space: nowrap;">${periodTimeInfo.start}~${periodTimeInfo.end}</span>` 
					 : '';

				 tableHtml += `<tr><td class="period-header">${period + 1}<br>${timeRangeStr}</td>`;
				 for (let day = 0; day < 5; day++) {
					 const cellDate = formatDate(weekDates[day], 'YYYY-MM-DD');
					 const cellData = schedule[period]?.[day];
					 let content = '';
					 let cellClass = '';
					 let dataAttrs = `data-period="${period}" data-day="${day}" data-date="${cellDate}"`;
					 
					 const isCurrent = isCurrentWeek && day === currentDayIndex && period === currentPeriodIndex;
					 if (isCurrent) {
						  cellClass += ' current-timetable-cell'; 
					 }
				 
					 if (cellData) {
						 if (type === 'class') {
                             if (cellData.isSwapped) {
                                cellClass += ' swapped-class-cell';
                             } else if (cellData.isSubstituted) {
                                cellClass += ' substituted-class-cell';
                             } else if (cellData.isExchanged) {
                                cellClass += ' exchanged-class-cell';
                             }
							 
							 // å¦‚æœæ˜¯ç•°å‹•ï¼Œæ·»åŠ  data-change-id å’Œ title
							 if (cellData.isSwapped || cellData.isSubstituted || cellData.isExchanged) {
                                 dataAttrs += ` data-change-id="${cellData.changeId}" title="èª²ç¨‹ç•°å‹•"`;
                             
                                 // ç¢ºä¿å…§å®¹é¡¯ç¤ºæ–°çš„è€å¸«ï¼Œä¸¦åŠ ä¸Šæ¨™ç±¤
                                 const tag = cellData.isSwapped ? '(èª¿)' : (cellData.isSubstituted ? '(ä»£)' : '(æ›)');
                                 content = `<span class="subject">${cellData.subject || ''}</span><span class="details"><span style="color: blue;">${cellData.teacher || ''}${tag}</span></span>`;
							 } else {
                                 // ç­ç´šèª²è¡¨åŸºç¤é¡¯ç¤ºé‚è¼¯ (ç„¡ç•°å‹•)
                                 content = `<span class="subject">${cellData.subject || ''}</span><span class="details"><span style="color: blue;">${cellData.teacher || ''}</span></span>`;
							 }
                         } else if (cellData.isSwappedIn || cellData.isSwappedOut || cellData.isExchangedIn || cellData.isExchangedOut || cellData.isSubstitutedIn || cellData.isSubstitutedOut) {
							 cellClass += ' ' + (cellData.isSwappedIn || cellData.isSwappedOut ? 'swapped-cell swapped-cell-pulse' : (cellData.isExchangedIn || cellData.isExchangedOut ? 'exchanged-cell exchanged-cell-pulse' : 'substituted-cell'));
							 dataAttrs += ` data-change-id="${cellData.changeId}"`;

                             if (cellData.reason && cellData.reason.trim() !== '') {
                                 const escapedReason = cellData.reason.replace(/"/g, '&quot;');
                                 dataAttrs += ` title="${escapedReason}"`;
                             } else if (cellData.isSubstitutedIn || cellData.isSubstitutedOut) {
                                 dataAttrs += ` title="ä»£èª²ç•°å‹•"`;
                             } else if (cellData.isSwappedIn || cellData.isSwappedOut) {
                                 dataAttrs += ` title="èª¿èª²ç•°å‹•"`;
                             } else if (cellData.isExchangedIn || cellData.isExchangedOut) {
                                 dataAttrs += ` title="æ›èª²ç•°å‹•"`;
                             }
                             
                             if (cellData.isSwappedIn) {
                                 content = `<span class="subject">${cellData.subject}</span><span class="details">${cellData.class}</span>`;
                                 content += `<span style="font-size: 0.8em; color: #000000; display: block; font-weight: bold;">${cellData.teacher}(èª¿)</span>`;
                             } 
                             else if (cellData.isSwappedOut) {
                                 content = `<span class="subject">${cellData.subject}</span><span class="details">${cellData.class}</span>`;
                                 content += `<span style="font-size: 0.8em; color: #000000; display: block; font-weight: bold;">${cellData.teacher}(èª¿)</span>`;
                             }
                             else if (cellData.isSubstitutedOut) {
                                 content = `<span class="subject">${cellData.subject}</span><span class="details">${cellData.class || ''}</span>`;
                                 content += `<span style="font-size: 0.8em; color: #000000; display: block; font-weight: bold;">${cellData.substituteTeacherName || 'ä¸æ˜'}(ä»£)</span>`;
                             }
                             else if (cellData.isSubstitutedIn) {
								 content = `<span class="subject">${cellData.subject}</span><span class="details">${cellData.class || ''}</span>`;
                                 content += `<span style="font-size: 0.8em; color: #007bff; display: block;">(${cellData.originalTeacherName || 'ä¸æ˜'}(ä»£)</span>`;
                              }
                             else if (cellData.isExchangedOut || cellData.isExchangedIn) {
                                 const teacherName = cellData.isExchangedOut ? cellData.targetTeacher : cellData.originalTeacher;                                 
                                 content = `<span class="subject">${cellData.subject}</span><span class="details">${cellData.class || ''}</span>`;
                                 content += `<span style="font-size: 0.8em; color: #000000; font-weight: bold;">${teacherName || 'ä¸æ˜'}(æ›)</span>`;
                             }
							 /* ã€æ–°å¢ä»¥ä¸‹ç­ç´šèª²è¡¨ç•°å‹•åˆ¤æ–·é‚è¼¯ã€‘ */
							 if (type === 'class' && (cellData.isSwapped || cellData.isSubstituted || cellData.isExchanged)) {
								 if (cellData.isSwapped) {
									cellClass += ' swapped-class-cell';
								 } else if (cellData.isSubstituted) {
									cellClass += ' substituted-class-cell';
								 } else if (cellData.isExchanged) {
									cellClass += ' exchanged-class-cell';
								 }
								 dataAttrs += ` data-change-id="${cellData.changeId}" title="èª²ç¨‹ç•°å‹•"`;
								 
								 // ç¢ºä¿å…§å®¹é¡¯ç¤ºæ–°çš„è€å¸«ï¼Œä¸¦åŠ ä¸Šæ¨™ç±¤
								 const tag = cellData.isSwapped ? '(èª¿)' : (cellData.isSubstituted ? '(ä»£)' : '(æ›)');
								 content = `<span class="subject">${cellData.subject || ''}</span><span class="details"><span style="color: blue;">${cellData.teacher || ''}${tag}</span></span>`;
							 }


						 } else {
							 if (type === 'teacher') {
								 content = `<span class="subject">${cellData.subject || ''}</span><span class="details">${cellData.class || ''}</span>`;
								 dataAttrs += ` data-course-data='${JSON.stringify({ 
									 subjectName: cellData.subject, 
									 className: cellData.class, 
									 teacherName: name, 
									 periodNum: period + 1,
									 location: cellData.location
								 })}'`;
							 }
							 else if (type === 'class') content = `<span class="subject">${cellData.subject || ''}</span><span class="details"><span style="color: blue;">${cellData.teacher || ''}</span></span>`;
						 }
						 tableHtml += `<td class="${cellClass}" ${dataAttrs}>${content}</td>`;
					 } else {
						 tableHtml += `<td class="empty-cell ${cellClass}" ${dataAttrs}></td>`;
					 }
				 }
				 tableHtml += '</tr>';
			 }
			 tableHtml += '</tbody></table>';
			 bodyEl.innerHTML = tableHtml;

			 const scheduleTable = bodyEl.querySelector('.schedule-table');
			 
			 if (isCurrentWeek) {
				 scheduleTable.querySelector('thead').classList.add('current-week');
			 }
			
			// é‡æ–°ç¶å®šäº‹ä»¶
			if (type === 'teacher') {
				teacherViewSelectedCell = null;
				scheduleTable.removeEventListener('click', (e) => handleTeacherCellClick(e, name));
				scheduleTable.removeEventListener('contextmenu', (e) => handleTeacherCellInteraction(e, name));

				scheduleTable.addEventListener('click', (e) => handleTeacherCellClick(e, name));
				scheduleTable.addEventListener('contextmenu', (e) => handleTeacherCellInteraction(e, name));
				
				scheduleTable.removeEventListener('touchstart', handleTouchStart);
				scheduleTable.removeEventListener('touchend', handleTouchEnd);
				scheduleTable.removeEventListener('touchmove', handleTouchEnd);

				scheduleTable.addEventListener('touchstart', handleTouchStart);
				scheduleTable.addEventListener('touchend', handleTouchEnd);
				scheduleTable.addEventListener('touchmove', handleTouchEnd);


			} else if (type === 'class') {
				classViewSelectedCell = null;
				scheduleTable.addEventListener('click', (e) => handleClassCellClick(e, name));
			}

			 if (!modal.style.display || modal.style.display === 'none') {
				 modal.style.display = 'block';
			 }
		};        
		
		renderScheduleTable(); 


		document.getElementById('prev-week-btn').onclick = () => {
			currentWeekStart.setDate(currentWeekStart.getDate() - 7);
			showSchedule(activeSchedule.name, activeSchedule.type);
		};
		document.getElementById('next-week-btn').onclick = () => {
			currentWeekStart.setDate(currentWeekStart.getDate() + 7);
			showSchedule(activeSchedule.name, activeSchedule.type);
		};
		document.getElementById('today-btn').onclick = () => {
			currentWeekStart = getMonday(new Date());
			showSchedule(activeSchedule.name, activeSchedule.type);
		};

		modal.querySelector('.close-button').onclick = () => {
			modal.style.display = 'none';
		};
		
	}
    
    function getPeriodIndexForTimetableHighlight() {
        if (PERIOD_TIMES.length === 0) return -1;
        const now = new Date();
        const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();
        
        for (let i = 0; i < PERIOD_TIMES.length; i++) {
            const period = PERIOD_TIMES[i];
            const [startH, startM] = period.start.split(':').map(Number);
            
            let startTimeMinutes = startH * 60 + startM;
            let endTimeMinutes = startTimeMinutes + period.duration; 
            
            const bufferMinutes = 5; 
            startTimeMinutes = startTimeMinutes - bufferMinutes;
            endTimeMinutes = endTimeMinutes + bufferMinutes;

            if (currentTimeMinutes >= startTimeMinutes && currentTimeMinutes < endTimeMinutes) {
                return i; 
            }
        }
        return -1;
    }

	function handleTeacherCellClick(event, teacherName) {
		if (teacherName !== currentUserDisplayName) {
			const cell = event.target.closest('td');
			if(cell && cell.dataset.courseData) {
				alert(`æ‚¨é»æ“Šäº† ${teacherName} è€å¸«çš„èª²ã€‚\n\nå¦‚éœ€åŠ å…¥è¡Œäº‹æ›†ï¼Œè«‹ä½¿ç”¨æ»‘é¼ å³éµæˆ–é•·æŒ‰ã€‚`);
			}
			return;
		}
		
		const cell = event.target.closest('td');
		const substitutionBtn = document.getElementById('substitution-btn');
		substitutionBtn.classList.remove('visible');

		if (!cell || cell.classList.contains('period-header')) return;
		
		const changeId = cell.dataset.changeId;
		const isSuggestion = cell.classList.contains('swap-suggestion');
		const table = cell.closest('table');

		
		const originalCell = document.querySelector('.schedule-table .highlight');
		
		const clearAllSelections = () => {
			table.querySelectorAll('.highlight, .swap-suggestion').forEach(el => {
				el.classList.remove('highlight', 'swap-suggestion');
				if (el.dataset.originalText !== undefined) {
					el.innerHTML = el.dataset.originalText;
					delete el.dataset.originalText;
					delete el.dataset.originalLesson; 
					delete el.dataset.targetLesson;   
				}
			});
			teacherViewSelectedCell = null;
			substitutionBtn.classList.remove('visible');
		};

		if (changeId) {
			clearAllSelections();
			const changeToCancel = activeChanges.find(c => c.id === changeId);
			if (!changeToCancel) return;

			let message = '';
			if (changeToCancel.type === 'swap') {
				const infoA = changeToCancel.originalClassInfo;
				const infoB = changeToCancel.targetClassInfo;
				message = `é€™æ˜¯ä¸€ç­†èª¿èª²ç´€éŒ„ï¼š\n\n${infoA.date} ç¬¬${infoA.period + 1}ç¯€ [${infoA.subject}]\nèˆ‡\n${infoB.date} ç¬¬${infoB.period + 1}ç¯€ [${infoB.subject}]\n\næ‚¨ç¢ºå®šè¦å–æ¶ˆå—ï¼Ÿ`;
			} else if (changeToCancel.type === 'substitution') {
				const info = changeToCancel.lessonInfo;
				message = `é€™æ˜¯ä¸€ç­†ä»£èª²ç´€éŒ„ï¼š\n\n${changeToCancel.date} ç¬¬${info.period + 1}ç¯€ [${info.subject}]\nç”± ${changeToCancel.substituteTeacherName} è€å¸«ä»£èª²ã€‚\n\næ‚¨ç¢ºå®šè¦å–æ¶ˆå—ï¼Ÿ`;
			} else if (changeToCancel.type === 'exchange') {
				 const infoA = changeToCancel.originalLessonInfo;
				 const infoB = changeToCancel.exchangeLessonInfo;
				 message = `é€™æ˜¯ä¸€ç­†æ›èª²ç´€éŒ„ï¼š\n\n- ${infoA.date} ç¬¬${infoA.period+1}ç¯€ [${infoA.subject}] ç”± ${infoB.teacher} ä»£èª²\n- ${infoB.date} ç¬¬${infoB.period+1}ç¯€ [${infoB.subject}] ç”± ${infoA.teacher} ä»£èª²\n\næ‚¨ç¢ºå®šè¦å–æ¶ˆå—ï¼Ÿ`;
			}
			
			if (confirm(message)) {
				cancelChange(changeId);
			}
			return; 
		}

		if (isSuggestion) {
			let originalLessonData, targetLessonData;
			
			try {
				if (!cell.dataset.originalLesson || !cell.dataset.targetLesson) {
					 throw new Error("Missing dataset keys.");
				}
				originalLessonData = JSON.parse(cell.dataset.originalLesson);
				targetLessonData = JSON.parse(cell.dataset.targetLesson);
			} catch (e) {
				alert("éŒ¯èª¤ï¼šèª¿èª²å»ºè­°è³‡æ–™è§£æå¤±æ•—ã€‚è«‹æª¢æŸ¥èª²ç¨‹åç¨±æˆ–è¯ç¹«é–‹ç™¼äººå“¡ã€‚");
				console.error("JSON Parse Error for swap-suggestion:", e);
				clearAllSelections();
				return;
			}

			if (originalLessonData && targetLessonData) {
				showSwapConfirmationModal({
					original: originalLessonData,
					target: targetLessonData
				});
			}
			
			clearAllSelections(); 
			return;
		}

		if (cell === teacherViewSelectedCell) {
			clearAllSelections();
			return;
		}

		clearAllSelections();

		const period = parseInt(cell.dataset.period);
		const day = parseInt(cell.dataset.day);
		const clickedLesson = teacherSchedules.get(teacherName)?.[period]?.[day];
		
		if (!clickedLesson) return;
		
		const cellDate = cell.dataset.date;
		const periodInfo = getPeriodTimeInfo(period + 1);
		
		if (periodInfo) {
			const now = new Date();
			const lessonEnd = new Date(cellDate);
			const [endH, endM] = periodInfo.end.split(':').map(Number);
			lessonEnd.setHours(endH, endM, 0, 0);
			
			if (lessonEnd < now) {
				alert(`èª²ç¨‹å·²éæ™‚ï¼š${cellDate} ç¬¬ ${period + 1} ç¯€ [${clickedLesson.subject}] å·²çµæŸã€‚\n\nç„¡æ³•é€²è¡Œèª¿èª²æˆ–ä»£èª²æ“ä½œã€‚`);
				return; 
			}
		}

		if (period >= 7 || (day === 4 && period >= 5)) return; 

		cell.classList.add('highlight');
		teacherViewSelectedCell = cell;

		substitutionBtn.classList.add('visible');
		substitutionBtn.onclick = () => showSubstitutionModal(clickedLesson, teacherViewSelectedCell.dataset.date, teacherName);

		const classSchedule = classSchedules.get(clickedLesson.class);
		if (!classSchedule) return;

		const originalLesson = {
			teacher: teacherName,
			class: clickedLesson.class,
			subject: clickedLesson.subject,
			location: clickedLesson.location,
			day: day,
			period: period,
			date: cellDate 
		};

		for (let p = 0; p < 7; p++) {
			for (let d = 0; d < 5; d++) {
				if ((d === 4 && p >= 5) || (p === period && d === day)) continue; 

				const ownTargetCellData = teacherSchedules.get(teacherName)?.[p]?.[d];
				if (!ownTargetCellData) {
					const lessonAtTarget = classSchedule[p]?.[d];
					if (lessonAtTarget?.teacher && lessonAtTarget.teacher !== teacherName) {
						const otherTeacherSchedule = teacherSchedules.get(lessonAtTarget.teacher);
						if (otherTeacherSchedule && !otherTeacherSchedule[period]?.[day]) {
							const targetCell = table.querySelector(`td[data-period="${p}"][data-day="${d}"]`);
							if (targetCell) {
								
								const targetLesson = {
									teacher: lessonAtTarget.teacher,
									class: originalLesson.class, 
									subject: lessonAtTarget.subject,
									location: lessonAtTarget.location,
									day: d,
									period: p,
									date: targetCell.dataset.date
								};
								
								targetCell.classList.remove('cleared-cell', 'empty-cell');
								targetCell.classList.add('swap-suggestion');
								targetCell.dataset.originalText = targetCell.innerHTML;
								
								targetCell.dataset.originalLesson = JSON.stringify(originalLesson);
								targetCell.dataset.targetLesson = JSON.stringify(targetLesson);

								const extHtml = ''; 
								targetCell.innerHTML = `<span class="subject">${lessonAtTarget.subject}</span><span class="class-details">${clickedLesson.class}</span><span class="teacher-details">${lessonAtTarget.teacher}</span>${extHtml}`;
							}
						}
					}
				}
			}
		}
	}
	
	/**
	 * ğŸ¯ CORE FIX ğŸ¯: é¡¯ç¤ºç´”ç€è¦½æ¨¡å¼çš„æ•™å¸«èª²è¡¨ (ç”±ç­ç´šèª²è¡¨é»æ“Šé€²å…¥)
	 * @param {string} teacherName - è¦é¡¯ç¤ºèª²è¡¨çš„æ•™å¸«å§“åã€‚
	 * @param {string} className - åŸå§‹çš„ç­ç´šåç¨± (ç”¨æ–¼è¿”å›)ã€‚
	 * @param {string} subject - èª²ç¨‹ç§‘ç›®ã€‚
	 * @param {string} location - èª²ç¨‹åœ°é»ã€‚
	 * @param {string} cellDate - é»æ“Šçš„æ—¥æœŸã€‚
	 */
	function showPureTeacherSchedule(teacherName, className, subject, location, cellDate) {
		const teacherSchedule = teacherSchedules.get(teacherName);
		if (!teacherSchedule) {
			alert(`æ‰¾ä¸åˆ° ${teacherName} è€å¸«çš„èª²è¡¨è³‡æ–™ã€‚`);
			return;
		}

		const modal = document.getElementById('view-only-modal');
		const titleEl = document.getElementById('view-only-modal-title');
		const bodyEl = document.getElementById('view-only-modal-body');
        const backBtn = document.getElementById('back-to-class-btn');
        const closeBtn = document.getElementById('view-only-close-btn');


		titleEl.textContent = `${teacherName} è€å¸«èª²è¡¨ (ç´”ç€è¦½)`;
		
        // 1. æ¸²æŸ“èª²è¡¨
		const daysOfWeek = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”'];
		let tableHtml = '<table class="schedule-table"><thead><tr><th>ç¯€æ¬¡</th>';
		
		const currentWeekStartLocal = getMonday(new Date(cellDate));
		
		const weekDates = [];
		for (let i = 0; i < 5; i++) {
			const date = new Date(currentWeekStartLocal);
			date.setDate(currentWeekStartLocal.getDate() + i);
			weekDates.push(date);
			tableHtml += `<th>${daysOfWeek[i]}<br>(${formatDate(date)})</th>`;
		}
		tableHtml += '</tr></thead><tbody>';

		for (let period = 0; period < 8; period++) {
			const periodTimeInfo = getPeriodTimeInfo(period + 1);
			const timeRangeStr = periodTimeInfo ? 
				`<span style="font-size: 0.7em; font-weight: normal; line-height: 1.2; white-space: nowrap;">${periodTimeInfo.start}~${periodTimeInfo.end}</span>` 
				: '';

			tableHtml += `<tr><td class="period-header">${period + 1}<br>${timeRangeStr}</td>`;
			
			for (let day = 0; day < 5; day++) {
				const cellData = teacherSchedule[period]?.[day];
				let content = '';
				let cellClass = 'view-only-cell'; // æ–°å¢ class ç¢ºä¿ç„¡æ³•é»æ“Š
				
                // ğŸ¯ CORE FIX ğŸ¯ï¼šæ¨™è¨˜è¢«é»æ“Šçš„é‚£ä¸€ç¯€èª²
                const isClickedLesson = cellDate === formatDate(weekDates[day], 'YYYY-MM-DD') && period === teacherSchedule[period][day]?.period;

				if (cellData) {
                    // ğŸ¯ CORE FIX ğŸ¯ï¼šç§»é™¤æ‰€æœ‰ç•°å‹•/é»æ“Š/hover æ•ˆæœï¼Œåªé¡¯ç¤ºå…§å®¹
					content = `<span class="subject">${cellData.subject || ''}</span><span class="details">${cellData.class || ''}</span>`;
                    
                    if (isClickedLesson) {
                         // ğŸ¯ CORE FIX ğŸ¯ï¼šé«˜äº®é¡¯ç¤ºåŸå§‹è¢«é»æ“Šçš„èª²
                         cellClass += ' highlight';
                    }
				} else {
					cellClass += ' empty-cell';
				}
				tableHtml += `<td class="${cellClass}" style="cursor: default;" data-period="${period}" data-day="${day}">${content}</td>`;
			}
			tableHtml += '</tr>';
		}
		tableHtml += '</tbody></table>';
		bodyEl.innerHTML = tableHtml;

        // 2. è¨­ç½®è¿”å›é‚è¼¯
        const returnToClassSchedule = () => {
             modal.style.display = 'none';
             // ğŸ¯ CORE FIX ğŸ¯ï¼šå‘¼å« showSchedule è¿”å›ç­ç´šèª²è¡¨
             showSchedule(className, 'class');
        };

        // 3. ç¶å®šæŒ‰éˆ•å’Œé—œé–‰äº‹ä»¶
        backBtn.onclick = returnToClassSchedule;
        closeBtn.onclick = returnToClassSchedule; 

        // ğŸ¯ CORE FIX ğŸ¯ï¼šéš±è—åŸä¾†çš„èª²è¡¨æ¨¡æ…‹æ¡†
        document.getElementById('schedule-modal').style.display = 'none';
		modal.style.display = 'flex';
	}
	
    function handleClassCellClick(event, className) {
        const cell = event.target.closest('td');
        if (!cell || cell.classList.contains('period-header')) {
            if (classViewSelectedCell) showSchedule(className, 'class');
            return;
        }
		// ğŸ¯ CORE FIX ğŸ¯ï¼šæª¢æŸ¥æ˜¯å¦é»æ“Šäº†æœ‰èª²çš„æ ¼å­
        const cellData = classSchedules.get(className)?.[parseInt(cell.dataset.period)]?.[parseInt(cell.dataset.day)];
		if (cellData && cellData.teacher) {
            // ğŸ¯ CORE FIX ğŸ¯ï¼šå„²å­˜ç•¶å‰ç­ç´šèª²è¡¨ç‹€æ…‹ï¼Œä¸¦é–‹å•Ÿç´”ç€è¦½æ¨¡å¼
            showPureTeacherSchedule(cellData.teacher, className, cellData.subject, cellData.location, cell.dataset.date);
        } else {
            // é»æ“Šç©ºç™½è™•æˆ–æœªè¼‰å…¥çš„æ ¼å­ï¼Œæ¢å¾©åŸç‹€
            if (classViewSelectedCell) showSchedule(className, 'class');
        }
    }

	/**
	 * è™•ç†æ•™å¸«èª²è¡¨å–®å…ƒæ ¼çš„é•·æŒ‰ (è§¸æ‘¸) æˆ–å³éµé»æ“Š (æ»‘é¼ ) äº‹ä»¶ã€‚
	 */
	function handleTeacherCellInteraction(event, teacherName) {
		
		if (event.type === 'contextmenu') {
			event.preventDefault(); 
			event.stopPropagation();
		}
		
		const cell = event.target.closest('td');
		
		if (!cell || cell.classList.contains('period-header') || !cell.dataset.period) {
			clearTimeout(longPressTimer);
			return;
		}

		const period = parseInt(cell.dataset.period);
		const day = parseInt(cell.dataset.day);
		const cellDate = cell.dataset.date;
		
		if (cell.classList.contains('empty-cell') && !cell.dataset.courseData) {
			clearTimeout(longPressTimer);
			return;
		}
        
        let lesson;
        let isSpecialChange = cell.dataset.changeId;
        
        if (isSpecialChange) {
            const change = activeChanges.find(c => c.id === isSpecialChange);
            
            if (change.type === 'substitution') {
                lesson = { 
                    ...change.lessonInfo, 
                    reason: change.reason,
                    isSubstitutedOut: true,
                    substituteTeacherName: change.substituteTeacherName, 
                };
            } else if (change.type === 'exchange') {
                const isOut = change.originalLessonInfo.teacher === teacherName;
                
                lesson = isOut ? { ...change.originalLessonInfo } : { ...change.exchangeLessonInfo };
                
                lesson.isExchangedOut = isOut;
                lesson.isExchangedIn = !isOut;
                lesson.reason = change.reason;

                lesson.targetTeacher = isOut ? change.exchangeLessonInfo.teacher : undefined;
            } else if (change.type === 'swap') {
                 clearTimeout(longPressTimer);
                 return;
            }
        } else {
             lesson = teacherSchedules.get(teacherName)?.[period]?.[day];
        }

		if (!lesson) {
			clearTimeout(longPressTimer);
			return;
		}
		
		const periodInfo = getPeriodTimeInfo(period + 1);
		if (periodInfo) {
			const now = new Date();
			const lessonEnd = new Date(cellDate);
			const [endH, endM] = periodInfo.end.split(':').map(Number);
			lessonEnd.setHours(endH, endM, 0, 0);
			
			if (lessonEnd < now) {
				alert(`èª²ç¨‹å·²éæ™‚ï¼š${cellDate} ç¬¬ ${period + 1} ç¯€ [${lesson.subject || lesson.subjectName}] å·²çµæŸã€‚\n\nç„¡æ³•æ–°å¢è¡Œäº‹æ›†è¨»è¨˜ã€‚`);
				clearTimeout(longPressTimer);
				return;
			}
		}
		
		const showModal = () => {
             const cleanCourseData = JSON.parse(cell.dataset.courseData || '{}');
             
             const finalLesson = {
                subject: cleanCourseData.subjectName || lesson.subject,
                class: cleanCourseData.className || lesson.class,
                teacher: cleanCourseData.teacherName || teacherName,
                periodNum: period + 1,
                location: cleanCourseData.location || lesson.location,
                
                period: period,
                day: day,

                isSubstitutedOut: lesson.isSubstitutedOut,
                substituteTeacherName: lesson.substituteTeacherName, 
                isExchangedOut: lesson.isExchangedOut,
                targetTeacher: lesson.targetTeacher, 
                isSwappedOut: lesson.isSwappedOut,
                
                reason: lesson.reason
             };

             showSingleEventModal(finalLesson, currentWeekStart, day + 1); 
        }
		
		if (event.type === 'contextmenu') {
			showModal();
		} 
	}
   
	/**
	 * é¡¯ç¤ºèª¿èª²ç¢ºèªæ¨¡æ…‹æ¡†ã€‚
	 */
	function showSwapConfirmationModal(swapInfo) {
		const modal = document.getElementById('swap-confirm-modal');
		const originalInfoEl = document.getElementById('original-class-info');
		const targetInfoEl = document.getElementById('target-class-info');
		const originalDateInput = document.getElementById('original-class-date');
		const targetDateInput = document.getElementById('target-class-date');
		const confirmBtn = document.getElementById('confirm-swap-btn');

		const newConfirmBtn = confirmBtn.cloneNode(true);
		confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

		const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

		const originalPeriodInfo = getPeriodTimeInfo(swapInfo.original.period + 1);
		const targetPeriodInfo = getPeriodTimeInfo(swapInfo.target.period + 1);

		const originalTimeStr = originalPeriodInfo ? ` (${originalPeriodInfo.start} - ${originalPeriodInfo.end})` : '';
		const targetTimeStr = targetPeriodInfo ? ` (${targetPeriodInfo.start} - ${targetPeriodInfo.end})` : '';
		
		originalInfoEl.innerHTML = `
			<b>æ‚¨çš„èª²ç¨‹:</b> é€±${days[swapInfo.original.day + 1]} ç¬¬ ${swapInfo.original.period + 1} ç¯€${originalTimeStr} - ${swapInfo.original.subject} (${swapInfo.original.class})
		`;
		targetInfoEl.innerHTML = `
			<b>èª¿æ›å°è±¡:</b> é€±${days[swapInfo.target.day + 1]} ç¬¬ ${swapInfo.target.period + 1} ç¯€${targetTimeStr} - <span style="color: blue;">${swapInfo.target.teacher}</span>è€å¸«çš„ ${swapInfo.target.subject}
		`;
		
		const now = new Date();
		const today = new Date();
		today.setHours(0, 0, 0, 0);
		const todayString = formatDate(today, 'YYYY-MM-DD');

		let initialDateOriginal = new Date(swapInfo.original.date);
		if (originalPeriodInfo) {
			const lessonFullDateTime = new Date(initialDateOriginal);
			const [endH, endM] = originalPeriodInfo.end.split(':').map(Number);
			lessonFullDateTime.setHours(endH, endM, 0, 0);
			if (lessonFullDateTime < now) {
				initialDateOriginal.setDate(initialDateOriginal.getDate() + 7);
			}
		}
		const defaultDateOriginal = findNextAvailableDate(initialDateOriginal, swapInfo.original.period, swapInfo.original.day);
		originalDateInput.value = formatDate(defaultDateOriginal, 'YYYY-MM-DD');

		let initialDateTarget = new Date(swapInfo.target.date);
		if (targetPeriodInfo) {
			const lessonFullDateTime = new Date(initialDateTarget);
			const [endH, endM] = targetPeriodInfo.end.split(':').map(Number);
			lessonFullDateTime.setHours(endH, endM, 0, 0);
			if (lessonFullDateTime < now) {
				initialDateTarget.setDate(initialDateTarget.getDate() + 7);
			}
		}
		const defaultDateTarget = findNextAvailableDate(initialDateTarget, swapInfo.target.period, swapInfo.target.day);
		targetDateInput.value = formatDate(defaultDateTarget, 'YYYY-MM-DD');

		originalDateInput.min = todayString;
		targetDateInput.min = todayString;

		let lastValidDateOriginal = originalDateInput.value;
		const originalDateValidationHandler = () => {
			const newDate = new Date(originalDateInput.value);
			const newDayIndex = (newDate.getDay() + 6) % 7;
			if (newDayIndex !== swapInfo.original.day) {
				alert(`æ—¥æœŸé¸æ“‡éŒ¯èª¤ï¼\n\næ‚¨çš„èª²ç¨‹æ˜¯ã€Œæ˜ŸæœŸ${days[swapInfo.original.day + 1]}ã€ï¼Œæ‚¨ä¸èƒ½é¸æ“‡å…¶ä»–æ˜ŸæœŸã€‚\nç³»çµ±å°‡è‡ªå‹•é‚„åŸã€‚`);
				originalDateInput.value = lastValidDateOriginal;
			} else {
				lastValidDateOriginal = originalDateInput.value;
			}
		};

		let lastValidDateTarget = targetDateInput.value;
		const targetDateValidationHandler = () => {
			const newDate = new Date(targetDateInput.value);
			const newDayIndex = (newDate.getDay() + 6) % 7;
			if (newDayIndex !== swapInfo.target.day) {
				alert(`æ—¥æœŸé¸æ“‡éŒ¯èª¤ï¼\n\nèª¿æ›å°è±¡çš„èª²ç¨‹æ˜¯ã€Œæ˜ŸæœŸ${days[swapInfo.target.day + 1]}ã€ï¼Œæ‚¨ä¸èƒ½é¸æ“‡å…¶ä»–æ˜ŸæœŸã€‚\nç³»çµ±å°‡è‡ªå‹•é‚„åŸã€‚`);
				targetDateInput.value = lastValidDateTarget;
			} else {
				lastValidDateTarget = targetDateInput.value;
			}
		};

		originalDateInput.onchange = null;
		targetDateInput.onchange = null;
		originalDateInput.addEventListener('change', originalDateValidationHandler);
		targetDateInput.addEventListener('change', targetDateValidationHandler);

		newConfirmBtn.addEventListener('click', async () => {
			const originalDate = originalDateInput.value;
			const targetDate = targetDateInput.value;
			
			const conflict1 = isDateConflict(originalDate, swapInfo.original.period, swapInfo.original.day);
			if (conflict1) {
				alert(`éŒ¯èª¤ï¼šæ‚¨çš„åŸèª²ç¨‹ç¯€æ¬¡ (${originalDate} ç¬¬ ${swapInfo.original.period + 1} ç¯€) å·²æœ‰å…¶ä»–çš„èª²ç¨‹ç•°å‹•ï¼Œç„¡æ³•è¨­å®šã€‚`);
				return;
			}

			const conflict2 = isDateConflict(targetDate, swapInfo.target.period, swapInfo.target.day);
			if (conflict2) {
				alert(`éŒ¯èª¤ï¼šæ‚¨é¸æ“‡çš„èª¿æ›å°è±¡ç¯€æ¬¡ (${targetDate} ç¬¬ ${swapInfo.target.period + 1} ç¯€) å·²æœ‰å…¶ä»–çš„èª²ç¨‹ç•°å‹•ï¼Œç„¡æ³•è¨­å®šã€‚`);
				return;
			}

			newConfirmBtn.disabled = true;
			newConfirmBtn.textContent = 'å„²å­˜ä¸­...';
			
			let involvedIds = [currentUser.uid];
			
			const changeData = {
				type: 'swap',
				originalClassInfo: { ...swapInfo.original, teacher: swapInfo.original.teacher, date: originalDateInput.value },
				targetClassInfo: { ...swapInfo.target, teacher: swapInfo.target.teacher, class: swapInfo.original.class, date: targetDateInput.value },
				involvedTeacherIds: involvedIds, 
				status: 'active',
				createdAt: firebase.firestore.FieldValue.serverTimestamp()
			};
			
			try {
				await db.collection('classChanges').add(changeData);
				
				currentWeekStart = getMonday(new Date(originalDateInput.value));
				if (activeSchedule.type && activeSchedule.name) {
					showSchedule(activeSchedule.name, activeSchedule.type);
				}
				
				modal.style.display = 'none';
				const exportConfirmed = confirm("èª¿èª²æˆåŠŸï¼èª²è¡¨å·²è‡ªå‹•è·³è½‰è‡³èª¿èª²é€±æ¬¡ã€‚\n\næ˜¯å¦å°‡ç›¸é—œç•°å‹•äº‹ä»¶åŠ å…¥è¡Œäº‹æ›†ï¼Ÿ");
                
                if (exportConfirmed) {
                    promptForIcsExport('swap', changeData); 
                }
				
			} catch (error) {
				console.error("å„²å­˜èª¿èª²å¤±æ•—:", error);
				alert("å„²å­˜å¤±æ•—: " + error.message);
			} finally {
				newConfirmBtn.disabled = false;
				newConfirmBtn.textContent = 'ç¢ºèªèª¿èª²';
			}
		});

		modal.querySelector('.close-button').onclick = () => {
			originalDateInput.removeEventListener('change', originalDateValidationHandler);
			targetDateInput.removeEventListener('change', targetDateValidationHandler);
			modal.style.display = 'none';
		};

		modal.style.display = 'block';
	}

	async function cancelChange(changeId) {
        try {
            await db.collection('classChanges').doc(changeId).update({ status: 'cancelled' });
            console.log('èª²ç¨‹ç•°å‹•å·²æˆåŠŸå–æ¶ˆï¼');
            if (activeSchedule.type && activeSchedule.name) {
                showSchedule(activeSchedule.name, activeSchedule.type);
            }
        } catch (error) {
            console.error("å–æ¶ˆç•°å‹•å¤±æ•—:", error);
            console.error("å–æ¶ˆå¤±æ•—: " + error.message);
        }
    }
    
	/**
	 * é¡¯ç¤ºæŒ‡å®šä»£èª²/æ›èª²çš„æ¨¡æ…‹æ¡†ã€‚
	 */
	function showSubstitutionModal(lesson, date, ownTeacherName) {
		console.log('DEBUG: showSubstitutionModal called.');

		substitutionInfo = {
			originalLesson: lesson,
			originalDate: date,
			ownTeacherName: ownTeacherName
		};

		const modal = document.getElementById('substitution-modal');
		const detailsEl = document.getElementById('substitution-details');
		const teacherSelect = document.getElementById('substitute-teacher-select');
		const dateInput = document.getElementById('substitution-date');
		const reasonInput = document.getElementById('substitution-reason');
		const exchangeCheckbox = document.getElementById('exchange-checkbox');
		const confirmBtn = document.getElementById('confirm-substitution-btn'); 

		const days = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”'];
		const originalDayIndex = new Date(substitutionInfo.originalDate).getDay() - 1;
		const dayChar = days[originalDayIndex] || 'å‡æ—¥';

		const periodInfo = getPeriodTimeInfo(lesson.period + 1);
		const timeStr = periodInfo ? ` (${periodInfo.start} - ${periodInfo.end})` : '';

		detailsEl.innerHTML = `<p style="margin: 0;"><strong>æ‚¨è¦è«‹å‡çš„èª²ç¨‹ï¼š</strong><br>
							é€±${dayChar} ç¬¬ ${lesson.period + 1} ç¯€${timeStr}<br>
							${lesson.subject} (${lesson.class})</p>`;

		teacherSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
		allTeachersList.forEach(teacher => {
			const isBusy = teacherSchedules.get(teacher)?.[lesson.period]?.[originalDayIndex];
			if (teacher !== ownTeacherName && !isBusy) {
				const option = new Option(teacher, teacher);
				teacherSelect.appendChild(option);
			}
		});

		const now = new Date();
		let initialDate = new Date(date);
		
		if (periodInfo) {
			const lessonFullDateTime = new Date(initialDate);
			lessonFullDateTime.setHours(Math.floor(periodInfo.endMinutes / 60), periodInfo.endMinutes % 60, 0, 0); 
			
			if (lessonFullDateTime < now) {
				initialDate.setDate(initialDate.getDate() + 7);
			}
		}
		
		const defaultDate = findNextAvailableDate(initialDate, lesson.period, originalDayIndex);
		
		dateInput.value = formatDate(defaultDate, 'YYYY-MM-DD');
		const today = new Date();
		today.setHours(0, 0, 0, 0);
		dateInput.min = formatDate(today, 'YYYY-MM-DD');
		
		reasonInput.value = '';
		exchangeCheckbox.checked = false;

		let lastValidDate = dateInput.value;
		const dateValidationHandler = () => {
			const newDate = new Date(dateInput.value);
			const newDayIndex = (newDate.getDay() + 6) % 7;
			
			if (newDayIndex !== originalDayIndex) {
				alert(`æ—¥æœŸé¸æ“‡éŒ¯èª¤ï¼\n\nåŸå§‹èª²ç¨‹æ˜¯ã€Œæ˜ŸæœŸ${dayChar}ã€ï¼Œæ‚¨ä¸èƒ½é¸æ“‡å…¶ä»–æ˜ŸæœŸã€‚\nç³»çµ±å°‡è‡ªå‹•é‚„åŸã€‚`);
				dateInput.value = lastValidDate;
			} else {
				lastValidDate = dateInput.value;
			}
		};

		const updateButtonState = () => {
			const selectedTeacher = teacherSelect.value;
			if (!selectedTeacher) {
				confirmBtn.disabled = true;
				confirmBtn.textContent = 'è«‹å…ˆé¸æ“‡è€å¸«';
				confirmBtn.style.backgroundColor = '#ccc';
				return;
			}
			confirmBtn.disabled = false;
			confirmBtn.style.backgroundColor = exchangeCheckbox.checked ? '#ff8c00' : '#28a745';
			confirmBtn.textContent = exchangeCheckbox.checked ? 'ä¸‹ä¸€æ­¥ï¼šé¸æ“‡é‚„èª²æ™‚æ®µ' : 'ç¢ºèªæŒ‡å®šä»£èª²';
		};

		const confirmClickHandler = () => {
			console.log('DEBUG: confirmClickHandler activated.');
			const selectedTeacher = teacherSelect.value;
			if (!selectedTeacher) return;

			substitutionInfo.substituteTeacherName = selectedTeacher;
			substitutionInfo.newDate = dateInput.value;
			substitutionInfo.reason = reasonInput.value.trim();

			if (exchangeCheckbox.checked) {
				showExchangeModal();
			} else {
				confirmAndSaveChange('substitution', confirmBtn); 
			}
		};
		
		// --- äº‹ä»¶ç¶å®šèˆ‡æ¸…ç† ---
		confirmBtn.onclick = null;
		confirmBtn.removeEventListener('click', confirmClickHandler); 
		
		dateInput.removeEventListener('change', dateValidationHandler);
		dateInput.addEventListener('change', dateValidationHandler);

		exchangeCheckbox.removeEventListener('change', updateButtonState);
		exchangeCheckbox.addEventListener('change', updateButtonState);

		teacherSelect.removeEventListener('change', updateButtonState);
		teacherSelect.addEventListener('change', updateButtonState);
		
		confirmBtn.onclick = confirmClickHandler;


		modal.querySelector('.close-button').onclick = () => {
			dateInput.removeEventListener('change', dateValidationHandler);
			confirmBtn.onclick = null; 
			document.getElementById('exchange-modal').style.display = 'none'; 
			modal.style.display = 'none';
		};
		
		updateButtonState();
		modal.style.display = 'block';
	}
	
	/**
	 * é¡¯ç¤ºæ›èª²ï¼ˆé‚„èª²ï¼‰æ¨¡æ…‹æ¡†ã€‚
	 */
	function showExchangeModal() {
		const modal = document.getElementById('exchange-modal');
		const titleEl = document.getElementById('exchange-modal-title');
		const subtitleEl = document.getElementById('exchange-modal-subtitle');
		const bodyEl = document.getElementById('exchange-modal-body');
		
		const ownTeacherName = substitutionInfo.ownTeacherName;
		const targetTeacherName = substitutionInfo.substituteTeacherName;
		
		let exchangeWeekStart = getMonday(new Date(substitutionInfo.newDate));

		titleEl.textContent = `è«‹é¸æ“‡ä¸€ç¯€ ${targetTeacherName} è€å¸«çš„èª²ä¾†äº¤æ›`;
		subtitleEl.textContent = `ç°è‰²æ ¼å­ä»£è¡¨æ‚¨(${ownTeacherName})ç•¶æ™‚æœ‰èª²ï¼Œæˆ–ç‚ºæ‚¨è«‹å‡æ™‚æ®µï¼Œç„¡æ³•é¸æ“‡`;
		
		const renderExchangeSchedule = () => {
			const ownSchedule = teacherSchedules.get(ownTeacherName);
			const targetSchedule = teacherSchedules.get(targetTeacherName);
			
			const daysOfWeekForHeader = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”'];
			let tableHtml = '<table class="schedule-table"><thead><tr><th>ç¯€æ¬¡</th>';
			
			const weekDates = [];
			for (let i = 0; i < 5; i++) {
				const date = new Date(exchangeWeekStart);
				date.setDate(exchangeWeekStart.getDate() + i);
				weekDates.push(date);
				tableHtml += `<th>${daysOfWeekForHeader[i]}<br>(${formatDate(date)})</th>`;
			}
			tableHtml += '</tr></thead><tbody>';

			const originalDayIndex = new Date(substitutionInfo.originalDate).getDay() - 1;

			for (let period = 0; period < 8; period++) {
				const periodTimeInfo = getPeriodTimeInfo(period + 1);
				const timeRangeStr = periodTimeInfo ? 
					`<br><span style="font-size: 0.7em; font-weight: normal; line-height: 1.2; white-space: nowrap;">${periodTimeInfo.start}~${periodTimeInfo.end}</span>` 
					: '';

				tableHtml += `<tr><td class="period-header">${period + 1}${timeRangeStr}</td>`;
				
				for (let day = 0; day < 5; day++) {
					const targetLesson = targetSchedule?.[period]?.[day];
					const ownLesson = ownSchedule?.[period]?.[day];
					
					const isOriginalExchangeTime = (period === substitutionInfo.originalLesson.period && day === originalDayIndex && exchangeWeekStart.getTime() === getMonday(new Date(substitutionInfo.newDate)).getTime());
					
					if (targetLesson) {
						if (ownLesson || isOriginalExchangeTime) {
							tableHtml += `<td class="disabled-cell"><span class="subject">${targetLesson.subject}</span><span class="details">${targetLesson.class}</span></td>`;
						} else {
							const cellDate = formatDate(weekDates[day], 'YYYY-MM-DD');
							tableHtml += `<td class="exchange-target-cell" data-period="${period}" data-day="${day}" data-date="${cellDate}"><span class="subject">${targetLesson.subject}</span><span class="details">${targetLesson.class}</span></td>`;
						}
					} else {
						tableHtml += `<td class="empty-cell"></td>`;
					}
				}
				tableHtml += '</tr>';
			}
			tableHtml += '</tbody></table>';
			bodyEl.innerHTML = tableHtml;

			bodyEl.querySelector('.schedule-table').addEventListener('click', (e) => {
				const cell = e.target.closest('td');
				if (cell && cell.classList.contains('exchange-target-cell')) {
					
					const period = parseInt(cell.dataset.period);
					const day = parseInt(cell.dataset.day);
					const date = cell.dataset.date;
					const exchangeLesson = targetSchedule[period][day];
					
					if (!exchangeLesson || !date || day === undefined || period === undefined) {
						alert("éŒ¯èª¤ï¼šç„¡æ³•ç²å–å®Œæ•´çš„èª²ç¨‹è³‡è¨Šï¼Œè«‹é‡è©¦ã€‚");
						return;
					}
					
					substitutionInfo.exchangeLessonInfo = {
						...exchangeLesson,
						teacher: targetTeacherName,
						date,
						period,
						day
					};
					
					const tempBtnReference = document.getElementById('confirm-substitution-btn');
						
					confirmAndSaveChange('exchange', tempBtnReference);					
				}
			});
		};

		document.getElementById('exchange-prev-week-btn').onclick = () => {
			exchangeWeekStart.setDate(exchangeWeekStart.getDate() - 7);
			renderExchangeSchedule();
		};
		document.getElementById('exchange-next-week-btn').onclick = () => {
			exchangeWeekStart.setDate(exchangeWeekStart.getDate() + 7);
			renderExchangeSchedule();
		};
		document.getElementById('exchange-today-btn').onclick = () => {
			exchangeWeekStart = getMonday(new Date());
			renderExchangeSchedule();
		};

		renderExchangeSchedule();

		document.getElementById('substitution-modal').style.display = 'none';
		modal.style.display = 'block';
		modal.querySelector('.close-button').onclick = () => modal.style.display = 'none';
	}

    
	/**
	 * åŸ·è¡Œæœ€çµ‚çš„ä»£èª²æˆ–æ›èª²ç¢ºèªï¼Œé€²è¡Œç•°å‹•è¡çªæª¢æŸ¥ä¸¦å„²å­˜åˆ° Firestoreã€‚
	 */
	async function confirmAndSaveChange(type, callingBtn) {
		let message = '';
		let changeData = {};
		
		// --- 1. æº–å‚™ç¢ºèªè¨Šæ¯ ---
		if (type === 'substitution') {
			const { substituteTeacherName, newDate } = substitutionInfo;
			message = `æ‚¨ç¢ºå®šè¦è«‹ ${substituteTeacherName} è€å¸«æ–¼ ${newDate} ä»£æ‚¨é€™ç¯€èª²å—ï¼Ÿ`;
		} else if (type === 'exchange') {
			const infoA = substitutionInfo.originalLesson;
			const teacherB = substitutionInfo.substituteTeacherName;
			const dateA = substitutionInfo.newDate;

			const infoB = substitutionInfo.exchangeLessonInfo;
			const dateB = infoB.date;
			
			message = `æ‚¨ç¢ºå®šè¦é€²è¡Œä»¥ä¸‹æ›èª²å—ï¼Ÿ\n\n` +
					  `æ‚¨çš„èª²ç¨‹ï¼š\n${dateA} ç¬¬${infoA.period+1}ç¯€ [${infoA.subject}] å°‡ç”± ${teacherB} ä»£èª²ã€‚\n\n`+
					  `æ‚¨éœ€é‚„èª²ï¼š\n${dateB} ç¬¬${infoB.period+1}ç¯€ æ‚¨å°‡å‰å¾€ ${infoB.class} ä»£ ${teacherB} çš„ [${infoB.subject}] èª²ã€‚`;
		}

		if (confirm(message)) {
			
			// --- 2. ç•°å‹•è¡çªæª¢æŸ¥ ---
			if (type === 'substitution' || type === 'exchange') {
				const dateToCheck = substitutionInfo.newDate;
				const periodToCheck = substitutionInfo.originalLesson.period;
				const dayToCheck = new Date(dateToCheck).getDay() - 1;

				const conflict = isDateConflict(dateToCheck, periodToCheck, dayToCheck);
				if (conflict) {
					let conflictType = '';
					switch (conflict.type) {
						case 'swap': conflictType = 'èª¿èª²'; break;
						case 'exchange': conflictType = 'æ›èª²'; break;
						case 'substitution': conflictType = 'æŒ‡å®šä»£èª²'; break;
						default: conflictType = 'èª²ç¨‹ç•°å‹•';
					}
					alert(`éŒ¯èª¤ï¼šè©²ç¯€æ¬¡ (${dateToCheck} ç¬¬ ${periodToCheck + 1} ç¯€) å·²è¢«ã€${conflictType}ã€ï¼Œç„¡æ³•é‡è¤‡è¨­å®šã€‚`);
					return;
				}
			}
			
			// --- 3. è™•ç†æŒ‰éˆ•ç‹€æ…‹å’Œ UID æª¢æŸ¥ ---
			callingBtn.disabled = true;
			callingBtn.textContent = 'å„²å­˜ä¸­...';

			let involvedIds = [currentUser.uid];
			
			try {
				// --- 4. æº–å‚™å„²å­˜çš„æ•¸æ“šçµæ§‹ ---
				if (type === 'substitution') {
					 changeData = {
						type: 'substitution',
						date: substitutionInfo.newDate,
						reason: substitutionInfo.reason || '',
						originalTeacherName: substitutionInfo.ownTeacherName,
						substituteTeacherName: substitutionInfo.substituteTeacherName,
						involvedTeacherIds: involvedIds, 
						lessonInfo: {
							subject: substitutionInfo.originalLesson.subject,
							class: substitutionInfo.originalLesson.class,
							location: substitutionInfo.originalLesson.location,
							period: substitutionInfo.originalLesson.period
						},
						status: 'active',
						createdAt: firebase.firestore.FieldValue.serverTimestamp()
					};
				} else if (type === 'exchange') {
					const { originalLesson, ownTeacherName, newDate, exchangeLessonInfo } = substitutionInfo;
					changeData = {
						type: 'exchange',
						reason: substitutionInfo.reason || '',
						originalLessonInfo: {
							teacher: ownTeacherName,
							date: newDate,
							subject: originalLesson.subject,
							class: originalLesson.class,
							location: originalLesson.location,
							period: originalLesson.period
						},
						exchangeLessonInfo: {
							teacher: exchangeLessonInfo.teacher,
							date: exchangeLessonInfo.date,
							subject: exchangeLessonInfo.subject,
							class: exchangeLessonInfo.class,
							location: exchangeLessonInfo.location,
							period: exchangeLessonInfo.period
						},
						involvedTeacherIds: involvedIds, 
						status: 'active',
						createdAt: firebase.firestore.FieldValue.serverTimestamp()
					}
				}
				

				// --- 5. åŸ·è¡Œå„²å­˜ ---
				await db.collection('classChanges').add(changeData);
				
				// é—œé–‰æ¨¡æ…‹æ¡†
				document.getElementById('substitution-modal').style.display = 'none';
				document.getElementById('exchange-modal').style.display = 'none';

				let successTitle = '';
				let successMessage = ''; 

                if (type === 'substitution') {
                    successTitle = "ä»£èª²æŒ‡å®šæˆåŠŸï¼";
                    successMessage = "ä»£èª²æŒ‡å®šæˆåŠŸï¼æ˜¯å¦å°‡æ­¤ä»£èª²äº‹ä»¶åŠ å…¥è¡Œäº‹æ›†ï¼Ÿ";
                } else if (type === 'swap') {
                    successTitle = "èª¿èª²æˆåŠŸï¼";
                    successMessage = "èª¿èª²æˆåŠŸï¼æ˜¯å¦å°‡ç›¸é—œç•°å‹•äº‹ä»¶åŠ å…¥è¡Œäº‹æ›†ï¼Ÿ";
                } else if (type === 'exchange') {
                    successTitle = "æ›èª²æˆåŠŸï¼";
                    successMessage = "æ›èª²æˆåŠŸï¼æ˜¯å¦å°‡ç›¸é—œç•°å‹•äº‹ä»¶åŠ å…¥è¡Œäº‹æ›†ï¼Ÿ";
                } else {
                    successTitle = "ç•°å‹•å„²å­˜æˆåŠŸï¼";
                    successMessage = "ç•°å‹•å„²å­˜æˆåŠŸï¼æ˜¯å¦å°‡ç›¸é—œäº‹ä»¶åŠ å…¥è¡Œäº‹æ›†ï¼Ÿ";
                }
				
                const exportConfirmed = confirm(successMessage); 
                
                if (exportConfirmed) {
                    promptForIcsExport(type, changeData);
                }
				
				// è·³è½‰åˆ°ç•°å‹•é€±æ¬¡
				const jumpDate = substitutionInfo.newDate;
				currentWeekStart = getMonday(new Date(jumpDate));
				if (activeSchedule && activeSchedule.name) {
					showSchedule(activeSchedule.name, activeSchedule.type);
				} else {
				}

			} catch (error) {
				console.error("å„²å­˜ç•°å‹•ç´€éŒ„å¤±æ•—:", error);
				alert('å„²å­˜å¤±æ•—: ' + error.message);
			} finally {
				// --- 6. ç„¡è«–çµæœå¦‚ä½•ï¼Œæ¢å¾©æŒ‰éˆ•ç‹€æ…‹ ---
				const isExchangeChecked = document.getElementById('exchange-checkbox').checked;
				callingBtn.disabled = false;
				callingBtn.textContent = isExchangeChecked ? 'ä¸‹ä¸€æ­¥ï¼šé¸æ“‡é‚„èª²æ™‚æ®µ' : 'ç¢ºèªæŒ‡å®šä»£èª²';
				callingBtn.style.backgroundColor = isExchangeChecked ? '#ff8c00' : '#28a745';
			}
		}
	}
	

	/**
	 * æ ¹æ“šç•°å‹•é¡å‹ï¼Œæç¤ºç”¨æˆ¶åŒ¯å‡ºè¡Œäº‹æ›†äº‹ä»¶ã€‚
	 */
	function promptForIcsExport(type, changeData) {
		const eventsToExport = [];
		const changeReason = changeData.reason || ''; 
		const selfTeacherName = currentUser.displayName; 

		if (type === 'substitution') {
			const lessonInfo = changeData.lessonInfo;
			const substituteTeacherName = changeData.substituteTeacherName || 'ä¸æ˜ä»£èª²è€å¸«'; 
			const originalTeacherName = changeData.originalTeacherName || 'ä¸æ˜åŸè€å¸«';      
			
			const reasonContent = `[ä»£èª²] ${changeReason ? 'äº‹ç”±: ' + changeReason + 'ã€‚' : ''}ç”± ${substituteTeacherName} è€å¸«ä¸Šèª²ã€‚`;
			
			eventsToExport.push({
				subject: lessonInfo.subject,
				class: lessonInfo.class,
				teacher: substituteTeacherName, 
				substituteTeacherName: substituteTeacherName, 
				period: lessonInfo.period, 
				day: lessonInfo.day,       
				periodNum: lessonInfo.period + 1,
				date: changeData.date,
				location: lessonInfo.location,
				reason: reasonContent, 
				isSubstitutedOut: true 
			});

			eventsToExport.forEach(event => {
				const eventDate = new Date(event.date);
				const weekStart = getMonday(eventDate);
				const dayIndex = eventDate.getDay(); 
				showSingleEventModal(event, weekStart, dayIndex);
			});

		} 
		
		else if (type === 'swap' || type === 'exchange') {
			const infoA = type === 'swap' ? changeData.originalClassInfo : changeData.originalLessonInfo; 
			const infoB = type === 'swap' ? changeData.targetClassInfo : changeData.exchangeLessonInfo; 
			const statusPrefix = type === 'swap' ? '[èª¿èª²]' : '[æ›èª²]';

			const reasonAContent = `${statusPrefix}${changeReason ? 'äº‹ç”±: ' + changeReason + 'ã€‚' : ''}`+ (type === 'swap'?` ${infoB.teacher}`:`ç”± ${infoB.teacher} è€å¸«ä»£ã€‚`);

			eventsToExport.push({
				subject: (type === 'swap' ? infoB.subject : infoA.subject),
				class: (type === 'swap' ? infoB.class : infoA.class),
				teacher: selfTeacherName, 
				targetTeacher: infoB.teacher, 
				period: infoA.period, 
				day: infoA.day,       
				periodNum: infoA.period + 1,
				date: infoA.date,
				location: infoA.location,
				reason: reasonAContent, 
				isExchangedOut: type === 'exchange',
				isSwappedOut: type === 'swap'
			});

			const reasonBContent = `${statusPrefix}${changeReason ? 'äº‹ç”±: ' + changeReason + 'ã€‚' : ''}`+ (type === 'swap'?` ${infoA.teacher}`:`ç”± ${infoA.teacher} è€å¸«ä»£ã€‚`);

			eventsToExport.push({
				subject: (type === 'swap' ? infoA.subject : infoB.subject),
				class: (type === 'swap' ? infoA.class : infoB.class),
				teacher: selfTeacherName,
				period: infoB.period, 
				day: infoB.day,       
				periodNum: infoB.period + 1,
				date: infoB.date,
				location: infoB.location,
				reason: reasonBContent, 
				isExchangedIn: type === 'exchange',
				isSwappedIn: type === 'swap'
			});
			
			showMultipleEventsModal(eventsToExport);
		}
	}

	/**
	 * è™•ç†æ•™å¸«èª²è¡¨å–®å…ƒæ ¼çš„é•·æŒ‰ (è§¸æ‘¸) æˆ–å³éµé»æ“Š (æ»‘é¼ ) äº‹ä»¶ã€‚
	 */
	function handleTeacherCellInteraction(event, teacherName) {
		
		if (event.type === 'contextmenu') {
			event.preventDefault(); 
			event.stopPropagation();
		}
		
		const cell = event.target.closest('td');
		
		if (!cell || cell.classList.contains('period-header') || !cell.dataset.period) {
			clearTimeout(longPressTimer);
			return;
		}

		const period = parseInt(cell.dataset.period);
		const day = parseInt(cell.dataset.day);
		const cellDate = cell.dataset.date;
		
		if (cell.classList.contains('empty-cell') && !cell.dataset.courseData) {
			clearTimeout(longPressTimer);
			return;
		}
        
        let lesson;
        let isSpecialChange = cell.dataset.changeId;
        
        if (isSpecialChange) {
            const change = activeChanges.find(c => c.id === isSpecialChange);
            
            if (change.type === 'substitution') {
                lesson = { 
                    ...change.lessonInfo, 
                    reason: change.reason,
                    isSubstitutedOut: true,
                    substituteTeacherName: change.substituteTeacherName, 
                };
            } else if (change.type === 'exchange') {
                const isOut = change.originalLessonInfo.teacher === teacherName;
                
                lesson = isOut ? { ...change.originalLessonInfo } : { ...change.exchangeLessonInfo };
                
                lesson.isExchangedOut = isOut;
                lesson.isExchangedIn = !isOut;
                lesson.reason = change.reason;

                lesson.targetTeacher = isOut ? change.exchangeLessonInfo.teacher : undefined;
            } else if (change.type === 'swap') {
                 clearTimeout(longPressTimer);
                 return;
            }
        } else {
             lesson = teacherSchedules.get(teacherName)?.[period]?.[day];
        }

		if (!lesson) {
			clearTimeout(longPressTimer);
			return;
		}
		
		const periodInfo = getPeriodTimeInfo(period + 1);
		if (periodInfo) {
			const now = new Date();
			const lessonEnd = new Date(cellDate);
			const [endH, endM] = periodInfo.end.split(':').map(Number);
			lessonEnd.setHours(endH, endM, 0, 0);
			
			if (lessonEnd < now) {
				alert(`èª²ç¨‹å·²éæ™‚ï¼š${cellDate} ç¬¬ ${period + 1} ç¯€ [${lesson.subject || lesson.subjectName}] å·²çµæŸã€‚\n\nç„¡æ³•æ–°å¢è¡Œäº‹æ›†è¨»è¨˜ã€‚`);
				clearTimeout(longPressTimer);
				return;
			}
		}
		
		const showModal = () => {
             const cleanCourseData = JSON.parse(cell.dataset.courseData || '{}');
             
             const finalLesson = {
                subject: cleanCourseData.subjectName || lesson.subject,
                class: cleanCourseData.className || lesson.class,
                teacher: cleanCourseData.teacherName || teacherName,
                periodNum: period + 1,
                location: cleanCourseData.location || lesson.location,
                
                period: period,
                day: day,

                isSubstitutedOut: lesson.isSubstitutedOut,
                substituteTeacherName: lesson.substituteTeacherName, 
                isExchangedOut: lesson.isExchangedOut,
                targetTeacher: lesson.targetTeacher, 
                isSwappedOut: lesson.isSwappedOut,
                
                reason: lesson.reason
             };

             showSingleEventModal(finalLesson, currentWeekStart, day + 1); 
        }
		
		if (event.type === 'contextmenu') {
			showModal();
		} 
	}
    
	/**
	 * é¡¯ç¤ºã€Œå°‡èª²ç¨‹åŠ å…¥è¡Œäº‹æ›†ã€çš„æ¨¡æ…‹æ¡†ã€‚
	 */
	function showSingleEventModal(lesson, weekStart, dayIndex) {
		const modal = document.getElementById('single-event-modal');
		const infoEl = document.getElementById('single-event-info');
		const dateInput = document.getElementById('single-event-date');
		const notesInput = document.getElementById('event-notes');
		const downloadBtn = document.getElementById('download-single-ics-btn');

		const periodNum = lesson.periodNum || (lesson.period !== undefined ? lesson.period + 1 : null);
		const periodInfo = getPeriodTimeInfo(periodNum);
		
		if (!periodInfo) {
			alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°èª²ç¨‹æ™‚é–“è³‡è¨Šï¼Œç„¡æ³•åŒ¯å‡ºè¡Œäº‹æ›†ã€‚');
			return;
		}

		const targetDate = new Date(weekStart);
		targetDate.setDate(weekStart.getDate() + dayIndex - 1); 
		const dateStr = formatDate(targetDate, 'YYYY-MM-DD');
		
		const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
		const targetDayOfWeek = targetDate.getDay(); 

		let title = `${lesson.subjectName || lesson.subject} (${lesson.className || lesson.class})`;
		let details = `ç”± ${lesson.teacherName || lesson.teacher} è€å¸«æˆèª²`;

		if (lesson.isSubstitutedOut) {
			title = `[ä»£èª²] ${title}`;
			details = `ç”± ${lesson.substituteTeacherName} è€å¸«ä»£èª²`;
		} else if (lesson.isExchangedOut) {
			title = `[æ›èª²] ${title}`;
			details = `ç”± ${lesson.targetTeacher} è€å¸«ä»£èª² (æ‚¨éœ€é‚„èª²)`;
		}
		
		infoEl.innerHTML = `
			<h3>${title}</h3>
			<p><strong>æ—¥æœŸï¼š</strong>${dateStr} (é€±${dayNames[targetDayOfWeek]})</p>
			<p><strong>æ™‚é–“ï¼š</strong>ç¬¬ ${periodNum} ç¯€ (${periodInfo.start} - ${periodInfo.end})</p>
			<p><strong>ç´°ç¯€ï¼šï¼š</strong>${details}</p>
			<p><strong>åœ°é»ï¼š</strong>${lesson.location || 'ç„¡'}</p>
		`;

		notesInput.value = lesson.reason || '';
		dateInput.value = dateStr; 
		
		downloadBtn.onclick = () => {
			generateIcsForLesson({
				...lesson, 
				periodNum: periodNum
			}, {
				teacherName: lesson.teacherName || lesson.teacher,
				date: dateInput.value, 
				notes: notesInput.value
			});
			modal.style.display = 'none';
		};

		modal.style.display = 'block';
	}

	function toIcsDateTime(date) {
		return date.toISOString().replace(/[-:]/g, '').substring(0, 15) + 'Z';
	}

	function generateMultipleIcs(events) {
		let icsContent = "BEGIN:VCALENDAR\r\n";
		icsContent += "VERSION:2.0\r\n";
		icsContent += "PRODID:-//TeacherScheduleSystem//NONSGML v1.0//EN\r\n";
		
		events.forEach(event => {
			const periodInfo = getPeriodTimeInfo(event.period + 1);
			if (!periodInfo) return;

			const dateObj = new Date(event.date);
			const [startH, startM] = periodInfo.start.split(':').map(Number);
			const [endH, endM] = periodInfo.end.split(':').map(Number);

			dateObj.setHours(startH, startM, 0, 0);
			const dtstart = toIcsDateTime(dateObj);

			dateObj.setHours(endH, endM, 0, 0);
			const dtend = toIcsDateTime(dateObj);

			const summary = `[${event.class}] ${event.subject} (${event.teacher})`;
			
			let description = event.reason || '';
			description = description.replace(/,/g, '\\,').replace(/\n/g, '\\n'); 

			const uid = `${Date.now()}-${Math.random().toString(36).substring(2)}-${event.period}-${event.day}-${event.date.replace(/-/g, '')}`;

			icsContent += "BEGIN:VEVENT\r\n";
			icsContent += `UID:${uid}\r\n`;
			icsContent += `DTSTAMP:${toIcsDateTime(new Date())}\r\n`;
			icsContent += `DTSTART:${dtstart}\r\n`;
			icsContent += `DTEND:${dtend}\r\n`;
			icsContent += `SUMMARY:${summary}\r\n`;
			icsContent += `LOCATION:${event.location || 'æœªçŸ¥åœ°é»'}\r\n`;
			icsContent += `DESCRIPTION:${description}\r\n`;
			icsContent += "END:VEVENT\r\n";
		});

		icsContent += "END:VCALENDAR\r\n";
		return icsContent;
	}	

	function showMultipleEventsModal(events) {
		const modal = document.getElementById('multiple-ics-export-modal');
		const contentDiv = document.getElementById('multiple-ics-event-details');
		const downloadBtn = document.getElementById('multiple-ics-download-btn');
		const closeBtn = modal.querySelector('.close-button');

		if (!modal) return;
		
		contentDiv.innerHTML = ''; 

		events.forEach((event, index) => {
			const periodInfo = getPeriodTimeInfo(event.period + 1);
			if (!periodInfo) return;
			
			const dateStr = new Date(event.date).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric', weekday: 'short' });
			const timeStr = `${periodInfo.start} - ${periodInfo.end}`;
			
			let typeLabel = 'ç•°å‹•äº‹ä»¶';
			let color = '#333';
			if (event.isSwappedOut || event.isExchangedOut) {
				if (event.isSwappedOut)
					typeLabel = 'ã€(èª¿èª²)åŸèª²èª¿å‡ºï¼Œæ–°èª²èª¿å…¥ã€‘';
				else
					typeLabel = 'ã€(æ›èª²)åŸèª²è¢«ä»£ã€‘';
				color = 'red';
			} else if (event.isSwappedIn || event.isExchangedIn) {
				if (event.isSwappedIn)
					typeLabel = 'ã€(èª¿èª²)åŸèª²èª¿å…¥ã€‘';
				else
					typeLabel = 'ã€(æ›èª²)æ›ä»£æ–°èª²ã€‘';
				color = 'green';			
			}
			
			const eventHtml = `
				<div style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; background-color: #f9f9f9;">
					<h4 style="margin-top: 0; color: ${color};">${typeLabel}</h4>
					<p style="margin: 3px 0;"><strong>æ—¥æœŸèˆ‡æ™‚é–“ï¼š</strong> ${dateStr} ${timeStr} (ç¬¬ ${event.periodNum} ç¯€)</p>
					<p style="margin: 3px 0;"><strong>ç­ç´š/ç§‘ç›®ï¼š</strong> ${event.class} - ${event.subject}</p>
					<p style="margin: 3px 0;"><strong>è¨»è¨˜/äº‹ç”±ï¼š</strong> ${event.reason || 'ç„¡'}</p>
				</div>
			`;
			contentDiv.innerHTML += eventHtml;
		});
		
		downloadBtn.onclick = () => {
			const icsContent = generateMultipleIcs(events);
			const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
			const url = URL.createObjectURL(blob);
			const link = document.createElement('a');
			link.href = url;
			link.download = `èª²è¡¨ç•°å‹•_${new Date().toISOString().split('T')[0]}.ics`;
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
			
			modal.style.display = 'none';
		};

		closeBtn.onclick = () => {
			modal.style.display = 'none';
		};

		modal.style.display = 'flex';
	}

	function generateIcsForLesson(lesson, options) {
        const { teacherName, date, notes } = options;
        
        const periodData = PERIOD_TIMES.find(p => p.period === lesson.periodNum);
        if(!periodData) {
             console.error("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²ç¯€æ¬¡çš„ç¢ºåˆ‡æ™‚é–“è³‡è¨Šï¼Œç„¡æ³•åŒ¯å‡º ICS æª”æ¡ˆã€‚è«‹è¯ç¹«ç®¡ç†å“¡æ›´æ–°èª²ç¨‹æ™‚é–“è¡¨ã€‚");
             return;
        }

        const classStartTimeStr = periodData.start;
        const durationMinutes = periodData.duration;
        
        const [startH, startM] = classStartTimeStr.split(':');
        const startTime = new Date(`${date}T00:00:00`);
        startTime.setHours(startH, startM);
        
        const endTime = new Date(startTime.getTime() + durationMinutes * 60000); 

        const formatTime = (d) => {
            const pad = (n) => n.toString().padStart(2, '0');
            return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;
        };
        
        const formattedNotes = (notes || '').replace(/\n/g, '\\n');

        let summary = '';
        if (lesson.isSubstitutedIn) {
            summary = `[${lesson.subject}] ä»£ ${lesson.originalTeacherName} (${lesson.class})`;
        } else if (lesson.isSubstitutedOut) {
            summary = `[${lesson.subject}] ç”± ${lesson.substituteTeacherName} ä»£èª² (${lesson.class})`;
        } else if (lesson.isExchangedIn) {
            summary = `[${lesson.subject}] æ›èª²: ä»£ ${lesson.originalTeacher} (${lesson.class})`;
        } else if (lesson.isExchangedOut) {
            summary = `[${lesson.subject}] æ›èª²: ç”± ${lesson.targetTeacher} ä»£ (${lesson.class})`;
        } else {
            summary = `[${lesson.subject}] ${lesson.class} (${teacherName})`;
        }

        let eventDetails = [
            'BEGIN:VEVENT',
            `UID:${Date.now()}-${Math.random()}@myapp.com`,
            `DTSTAMP:${formatTime(new Date())}Z`,
            `DTSTART;TZID=Asia/Taipei:${formatTime(startTime)}`,
            `DTEND;TZID=Asia/Taipei:${formatTime(endTime)}`,
            `SUMMARY:${summary}`,
            `DESCRIPTION:${formattedNotes}`,
            `LOCATION:${lesson.location || ''}`,
            'END:VEVENT'
        ];
        const icsContent = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//My School//EN', ...eventDetails, 'END:VCALENDAR'].join('\r\n');
        
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${date}-${teacherName}-${lesson.subject}.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
	
    function bindNavEventListeners() {
        document.getElementById('prev-week-btn').addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            if (activeSchedule.type && activeSchedule.name) {
                showSchedule(activeSchedule.name, activeSchedule.type);
            }
        });
        document.getElementById('next-week-btn').addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            if (activeSchedule.type && activeSchedule.name) {
                showSchedule(activeSchedule.name, activeSchedule.type);
            }
        });
        document.getElementById('today-btn').addEventListener('click', () => {
            currentWeekStart = getMonday(new Date());
            if (activeSchedule.type && activeSchedule.name) {
                showSchedule(activeSchedule.name, activeSchedule.type);
            }
        });
    }

    try {
        const allTeachersWithSchedule = await deriveSchedules();
        allTeachersList = [...allTeachersWithSchedule].sort((a, b) => a.localeCompare(b, 'zh-Hant'));

        populateTeacherListBySubject(allTeachersWithSchedule); 
        populateClassList();

        if (teacherNameToShow) {
            setTimeout(() => {
                const decodedTeacherName = decodeURIComponent(teacherNameToShow);
                if (teacherSchedules.has(decodedTeacherName)) {
                    showSchedule(decodedTeacherName, 'teacher');
                } else {
                    console.error(`æ‰¾ä¸åˆ°æ•™å¸«ã€Œ${decodedTeacherName}ã€çš„èª²è¡¨è³‡æ–™ã€‚`);
                }
            }, 100);
        } else {
            const lastScheduleJSON = localStorage.getItem('lastSchedule');
            if (lastScheduleJSON) {
                const savedData = JSON.parse(lastScheduleJSON);
                if (savedData.savedBy && savedData.savedBy === currentUser.uid) {
                    const lastSchedule = savedData.schedule;
                    lastSchedule.view = 'subject'; 
                    if (lastSchedule?.type && lastSchedule?.name) {
                        activeSchedule = { type: lastSchedule.type, name: lastSchedule.name };
						setTimeout(() => showSchedule(lastSchedule.name, lastSchedule.type), 100);
                    }
                } else {
                    localStorage.removeItem('lastSchedule');
                }
            }
        }
    } catch (e) {
        console.error("ç¨‹å¼åŸ·è¡Œæ™‚ç™¼ç”Ÿåš´é‡éŒ¯èª¤:", e);
        if (e.code === 'permission-denied') {
             console.error("æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•è®€å–èª²ç¨‹ç•°å‹•è³‡æ–™ã€‚\n\nè«‹è¯ç¹«ç®¡ç†å“¡æª¢æŸ¥ Firestore çš„ 'classChanges' å®‰å…¨è¦å‰‡ã€‚");
        } else {
             console.error("ç¨‹å¼åŸ·è¡Œæ™‚ç™¼ç”Ÿåš´é‡éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°(F12)ç²å–æ›´å¤šè³‡è¨Šã€‚");
        }
    }
    
    document.querySelectorAll('.modal .close-button').forEach(btn => {
        btn.onclick = (e) => {
            const modal = e.target.closest('.modal');
            modal.style.display = 'none';
        };
    });
    window.onclick = (event) => {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    };
    document.getElementById('search-teacher').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        const container = document.getElementById('teacher-list-by-subject-container'); 
        container.querySelectorAll('.department-table').forEach(table => {
            let tableHasVisibleRow = false;
            table.querySelectorAll('tbody tr').forEach(row => {
                const nameCell = row.querySelector('.name-cell');
                const isVisible = nameCell && nameCell.textContent.toLowerCase().includes(searchTerm);
                row.style.display = isVisible ? '' : 'none';
                if (isVisible) tableHasVisibleRow = true;
            });
            table.style.display = (tableHasVisibleRow || !searchTerm) ? '' : 'none';
        });
    });
    
    function getRecentSchedules() {
        try {
            const stored = localStorage.getItem('recentSchedules');
            return stored ? JSON.parse(stored) : [];
        } catch (e) {
            return [];
        }
    }

    function addRecentSchedule(name, type) {
        let recents = getRecentSchedules();
        recents = recents.filter(item => !(item.name === name && item.type === type));
        recents.unshift({ name, type });
        if (recents.length > MAX_RECENT_ITEMS) {
            recents = recents.slice(0, MAX_RECENT_ITEMS);
        }
        localStorage.setItem('recentSchedules', JSON.stringify(recents));
    }

    function populateRecentList() {
        const recents = getRecentSchedules();
        recentSchedulesList.innerHTML = '';
        if (recents.length === 0) {
            const emptyItem = document.createElement('span');
            emptyItem.textContent = 'å°šç„¡ç€è¦½ç´€éŒ„';
            emptyItem.style.padding = '10px 15px';
            emptyItem.style.color = '#999';
            emptyItem.style.fontSize = '0.9em';
            recentSchedulesList.appendChild(emptyItem);
            return;
        }

        recents.forEach(item => {
            const btn = document.createElement('button');
            let typeText = '';
            if (item.type === 'teacher') typeText = ' (æ•™å¸«)';
            if (item.type === 'class') typeText = ' (ç­ç´š)';
            btn.textContent = item.name + typeText;
            btn.onclick = () => {
                showSchedule(item.name, item.type);
                recentSchedulesList.classList.remove('show');
            };
            recentSchedulesList.appendChild(btn);
        });
    }

    recentSchedulesBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        populateRecentList();
        recentSchedulesList.classList.toggle('show');
    });

    window.addEventListener('click', (event) => {
        if (!event.target.matches('#recent-schedules-btn')) {
            if (recentSchedulesList.classList.contains('show')) {
                recentSchedulesList.classList.remove('show');
            }
        }
    });


    // ã€ã€ã€æ–°å¢ã€‘ã€‘ã€‘: ç‚ºèª²è¡¨ Modal åŠ å…¥æ»‘å‹•æ›é€±åŠŸèƒ½
    const scheduleModalBody = document.getElementById('modal-body'); // ä¸»è¦èª²è¡¨å®¹å™¨
    const exchangeModalBody = document.getElementById('exchange-modal-body'); // æ›èª²é¸æ“‡èª²è¡¨å®¹å™¨
    let touchStartX = 0;
    let touchEndX = 0;
    const swipeThreshold = 50; // åˆ¤å®šç‚ºæ»‘å‹•çš„æœ€çŸ­åƒç´ è·é›¢

    function handleTouchStart(event) {
        if (event.touches.length === 1) {
            touchStartX = event.touches[0].clientX;
            touchEndX = 0;
        }
    }

    function handleTouchMove(event) {
        if (event.touches.length > 1) {
            touchStartX = 0;
        }
    }

    function handleTouchEnd(event, modalElement, prevBtnId, nextBtnId) {
        if (event.changedTouches.length === 1 && touchStartX !== 0) {
            touchEndX = event.changedTouches[0].clientX;
            const deltaX = touchEndX - touchStartX;

            // æª¢æŸ¥æ»‘å‹•è·é›¢å’Œ Modal æ˜¯å¦å¯è¦‹
            if (Math.abs(deltaX) > swipeThreshold && modalElement.style.display === 'block') {
                if (deltaX < 0) {
                    // å‘å·¦æ»‘ -> ä¸‹ä¸€é€±
                    document.getElementById(nextBtnId)?.click(); // ä½¿ç”¨ ?. é¿å…æŒ‰éˆ•ä¸å­˜åœ¨æ™‚å‡ºéŒ¯
                } else {
                    // å‘å³æ»‘ -> ä¸Šä¸€é€±
                    document.getElementById(prevBtnId)?.click(); // ä½¿ç”¨ ?. é¿å…æŒ‰éˆ•ä¸å­˜åœ¨æ™‚å‡ºéŒ¯
                }
            }
        }
        touchStartX = 0;
    }

    // --- ç¶å®šäº‹ä»¶åˆ°ä¸»è¦èª²è¡¨ Modal ---
    scheduleModalBody.addEventListener('touchstart', handleTouchStart, { passive: true });
    scheduleModalBody.addEventListener('touchmove', handleTouchMove, { passive: true });
    scheduleModalBody.addEventListener('touchend', (event) => {
        handleTouchEnd(event, document.getElementById('schedule-modal'), 'prev-week-btn', 'next-week-btn');
    });

    // --- ç¶å®šäº‹ä»¶åˆ°æ›èª² Modal ---
    exchangeModalBody.addEventListener('touchstart', handleTouchStart, { passive: true });
    exchangeModalBody.addEventListener('touchmove', handleTouchMove, { passive: true });
    exchangeModalBody.addEventListener('touchend', (event) => {
        handleTouchEnd(event, document.getElementById('exchange-modal'), 'exchange-prev-week-btn', 'exchange-next-week-btn');
    });
    // ã€ã€ã€æ–°å¢çµæŸã€‘ã€‘ã€‘

}
</script>
</body>
</html>
