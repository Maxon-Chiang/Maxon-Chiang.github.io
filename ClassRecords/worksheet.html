<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿä½œæ¥­ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
	<script>
	  window.MathJax = {
		tex: {
		  inlineMath: [['$', '$'], ['\\(', '\\)']]
		}
	  };
	</script>
	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; }
        .worksheet-content { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; }
        
        .worksheet-input {
            border: 2px solid #e2e8f0;
            padding: 8px;
            border-radius: 6px;
            margin-top: 5px;
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }
        .worksheet-input:focus {
            border-color: #3b82f6;
            outline: none;
        }

        textarea.worksheet-input,
        select.worksheet-input,
        input[type="text"].worksheet-input,
        input[type="number"].worksheet-input,
        input[type="date"].worksheet-input {
            width: 100%;
            display: block; 
        }

        input[type="radio"].worksheet-input,
        input[type="checkbox"].worksheet-input {
            width: auto;
            margin-right: 8px;
            display: inline-block;
            vertical-align: middle;
            cursor: pointer;
        }
        
        .grading-panel {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #94a3b8;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 0 4px 4px 0;
            margin-top: 5px;
            position: relative;
            z-index: 10;
        }
        .grading-panel.correct { border-left-color: #22c55e; background-color: #f0fdf4; }
        .grading-panel.incorrect { border-left-color: #ef4444; background-color: #fef2f2; }
        
        .grading-status-text { font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .text-correct { color: #166534; }
        .text-incorrect { color: #991b1b; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="login-view" class="flex flex-col items-center justify-center h-screen px-4">
        <div class="bg-white p-8 rounded-xl shadow-xl text-center w-full max-w-md">
            <h1 class="text-3xl font-extrabold text-blue-600 mb-2">å­¸ç”Ÿä½œæ¥­ç³»çµ±</h1>
            <p class="mb-8 text-gray-500">è«‹ä½¿ç”¨å­¸æ ¡ Google å¸³è™Ÿç™»å…¥</p>
            
            <button id="login-btn" class="bg-white border border-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-50 transition shadow-sm w-full">
                Google ç™»å…¥
            </button>
            <p id="login-msg" class="mt-4 text-sm text-red-500 font-bold"></p>
        </div>
    </div>

    <div id="app-view" class="container mx-auto p-4 max-w-5xl hidden">
        <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm mb-6 sticky top-0 z-10">
            <div class="flex items-center gap-3">
                <div class="bg-blue-100 p-2 rounded-full text-blue-600 font-bold text-xl">ğŸ“</div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800" id="student-name">è¼‰å…¥ä¸­...</h1>
                    <p class="text-sm text-gray-500 font-bold" id="class-info">...</p>
                </div>
            </div>
            <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-500 font-medium px-3 py-1 border rounded hover:bg-red-50 transition">ç™»å‡º</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <h2 class="text-xl font-bold text-gray-700 flex items-center gap-2">
                    ğŸ“ å¾…å®Œæˆä»»å‹™ 
                    <span id="todo-count" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">0</span>
                </h2>
                <div id="todo-list" class="space-y-3">
                    <p class="text-gray-400 text-center py-8">ç›®å‰æ²’æœ‰å¾…å®Œæˆçš„ä½œæ¥­ ğŸ‰</p>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-xl font-bold text-gray-700">âœ… å·²å®Œæˆ </h2>
                <div id="history-list" class="space-y-3 opacity-80">
                    <p class="text-gray-400 text-center py-8">å°šç„¡ç´€éŒ„</p>
                </div>
            </div>
        </div>
    </div>

    <div id="worksheet-modal" class="fixed inset-0 bg-gray-100 z-50 hidden overflow-y-auto">
        <div class="min-h-screen flex flex-col max-w-4xl mx-auto bg-white shadow-2xl">
            
            <div class="sticky top-0 z-20 bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm">
                <div>
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800">ä½œæ¥­æ¨™é¡Œ</h3>
                    <span id="modal-status" class="text-xs font-bold px-2 py-0.5 rounded bg-gray-200 text-gray-600">ç‹€æ…‹</span>
                </div>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 transition p-2 rounded-full hover:bg-gray-100">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-grow p-6 md:p-10 bg-white">
                
                <div id="teacher-feedback-area" class="hidden mb-8 p-6 bg-yellow-50 border-l-4 border-yellow-400 rounded-r text-base text-yellow-800 shadow-sm">
                    <strong class="block mb-2 text-lg">ğŸ‘©â€ğŸ« è€å¸«ç¸½è©•ï¼š</strong> 
                    <span id="feedback-text" class="leading-relaxed"></span>
                </div>

                <form id="worksheet-form" class="worksheet-content space-y-6" onsubmit="return false;">
                    </form>
            </div>

            <div class="p-6 border-t bg-gray-50 flex justify-between items-center sticky bottom-0 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                <span class="text-sm text-gray-500">ç³»çµ±è‡ªå‹•æš«å­˜</span>
                <div class="flex gap-4">
                    <button onclick="closeModal()" class="px-6 py-2.5 text-gray-600 font-bold hover:bg-gray-200 rounded-lg transition border border-gray-300 bg-white">
                        æš«æ™‚é›¢é–‹
                    </button>
                    <button id="submit-btn" class="px-8 py-2.5 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md transform hover:-translate-y-0.5 transition flex items-center gap-2">
                        <span>æäº¤ä½œæ¥­</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
		// ğŸ› ï¸ [ä¿®æ”¹] è¼”åŠ©å‡½å¼ï¼šå¼·åˆ¶åŸ·è¡Œ innerHTML ä¸­çš„è…³æœ¬ä¸¦æ¸²æŸ“æ•¸å­¸å…¬å¼
		function executeEmbeddedScripts(container) {
			// 1. è™•ç† Script (è®“åˆ†é èˆ‡äº’å‹•ç”Ÿæ•ˆ)
			const scripts = container.querySelectorAll('script');
			scripts.forEach(oldScript => {
				const newScript = document.createElement('script');
				Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
				newScript.appendChild(document.createTextNode(oldScript.innerHTML));
				oldScript.parentNode.replaceChild(newScript, oldScript);
			});

			// 2. [æ–°å¢] è™•ç†æ•¸å­¸å…¬å¼ (è®“ LaTeX é¡¯ç¤ºæ­£å¸¸)
			if (window.MathJax) {
				// å‘Šè¨´ MathJax é€™è£¡æœ‰æ–°å…§å®¹ï¼Œè«‹é‡æ–°æƒæä¸¦æ¸²æŸ“
				MathJax.typesetPromise([container]).catch((err) => console.log('MathJax error:', err));
			}
		}

        const firebaseConfig = {
            apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
            authDomain: "classrecords-13902.firebaseapp.com",
            projectId: "classrecords-13902",
            storageBucket: "classrecords-13902.firebasestorage.app",
            messagingSenderId: "431747377367",
            appId: "1:431747377367:web:b157a485c59ce38091e892",
            measurementId: "G-JWTQGM9XMP"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let studentProfile = null;
        let currentAssignmentId = null;

        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginMsg = document.getElementById('login-msg');

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                loginMsg.textContent = 'æ­£åœ¨ç¢ºèªå­¸ç”Ÿèº«åˆ†...';
                currentUser = user;
                
                try {
                    let userDoc = await db.collection('users').doc(user.uid).get();

                    if (userDoc.exists) {
                        studentProfile = userDoc.data();
                        if (!studentProfile.schoolName && studentProfile.schoolId) {
                            try {
                                const sDoc = await db.collection('schools').doc(studentProfile.schoolId).get();
                                if(sDoc.exists) studentProfile.schoolName = sDoc.data().name;
                            } catch(e) {}
                        }
                    } else {
                        const snapshot = await db.collectionGroup('students')
                                                 .where('email', '==', user.email)
                                                 .get();

                        if (!snapshot.empty) {
                            const studentDoc = snapshot.docs[0];
                            const studentData = studentDoc.data();
                            const schoolRef = studentDoc.ref.parent.parent;
                            const schoolId = schoolRef.id;
                            let schoolName = schoolId;
                            
                            try {
                                const schoolSnap = await schoolRef.get();
                                if(schoolSnap.exists && schoolSnap.data().name) {
                                    schoolName = schoolSnap.data().name;
                                }
                            } catch(e) {}

                            const newProfile = {
                                role: 'student',
                                email: user.email,
                                displayName: studentData.name,
                                schoolId: schoolId,
                                schoolName: schoolName,
                                classId: studentData.class_id,
                                seatNo: studentData.seat_no,
                                fullId: studentData.full_id
                            };
                            
                            await db.collection('users').doc(user.uid).set(newProfile);
                            studentProfile = newProfile;
                        } else {
                            throw new Error(`åœ¨æ‰€æœ‰å­¸æ ¡åå†Šä¸­æ‰¾ä¸åˆ° Emailï¼š${user.email}ã€‚è«‹è¯ç¹«è€å¸«å°‡æ‚¨åŠ å…¥åå–®ã€‚`);
                        }
                    }

                    if (studentProfile.role !== 'student') {
                        throw new Error('æ­¤å¸³è™Ÿç‚ºæ•™å¸«èº«åˆ†ï¼Œç„¡æ³•ç™»å…¥å­¸ç”Ÿç«¯ã€‚');
                    }

                    renderDashboard();
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');

                } catch (e) {
                    console.error("ç™»å…¥æµç¨‹éŒ¯èª¤:", e);
                    let errorHtml = `<div class="text-red-600 font-bold mb-3">â›” ${e.message}</div>`;
                    if(e.code === 'failed-precondition') {
                        errorHtml += '<div class="text-xs text-gray-500 mb-3">(ç³»çµ±æç¤º: è«‹ç®¡ç†å“¡è‡³ Firebase Console å»ºç«‹ students çš„ email ç´¢å¼•)</div>';
                    }
                    errorHtml += `
                        <button onclick="firebase.auth().signOut().then(() => window.location.reload())" 
                                class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow transition flex items-center justify-center gap-2 w-full">
                            ğŸ”„ å¼·åˆ¶ç™»å‡º / åˆ‡æ›å¸³è™Ÿ
                        </button>
                    `;
                    loginMsg.innerHTML = errorHtml;
                }
            } else {
                loginView.classList.remove('hidden');
                appView.classList.add('hidden');
            }
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({
                prompt: 'select_account'
            });
            auth.signInWithPopup(provider);
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => window.location.reload());
        });

        async function renderDashboard() {
            const schoolDisplay = studentProfile.schoolName || studentProfile.schoolId;
            document.getElementById('student-name').textContent = studentProfile.displayName;
            document.getElementById('class-info').textContent = `${schoolDisplay} | ${studentProfile.classId}ç­ ${studentProfile.seatNo}è™Ÿ`;

            const todoList = document.getElementById('todo-list');
            const historyList = document.getElementById('history-list');
            
            const assignsSnap = await db.collection('assignments')
                                        .where('target_class', '==', studentProfile.classId)
                                        .where('school_id', '==', studentProfile.schoolId)
                                        .orderBy('created_at', 'desc')
                                        .get();

            const responsesSnap = await db.collection('responses')
                                         .where('student_uid', '==', currentUser.uid)
                                         .get();

            const responseMap = {};
            responsesSnap.forEach(doc => { responseMap[doc.data().assignment_id] = doc.data(); });

            todoList.innerHTML = '';
            historyList.innerHTML = '';
            let todoCount = 0;

            if (assignsSnap.empty) {
                todoList.innerHTML = '<p class="text-center text-gray-500 py-4">ç›®å‰æ²’æœ‰ä½œæ¥­</p>';
                return;
            }

            assignsSnap.forEach(doc => {
                const task = doc.data();
                const taskId = doc.id;
                const userResponse = responseMap[taskId];
                
                let status = 'new'; 
                if (userResponse) status = userResponse.status;

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow border-l-4 transition hover:shadow-md cursor-pointer flex justify-between items-center";
                const dateStr = task.created_at ? new Date(task.created_at.seconds * 1000).toLocaleDateString() : '';

                if (status === 'submitted' || status === 'graded') {
                    card.classList.add('border-green-500');
                    let scoreHtml = status === 'graded' 
                        ? `<span class="text-green-600 font-bold text-lg">${userResponse.score} åˆ†</span>` 
                        : `<span class="text-gray-500 text-sm">å·²ç¹³äº¤</span>`;
                    
                    card.innerHTML = `<div><h4 class="font-bold text-gray-800">${task.worksheet_title}</h4><p class="text-xs text-gray-400">${dateStr}</p></div><div>${scoreHtml}</div>`;
                    card.onclick = () => openWorksheet(taskId, task, userResponse, true); 
                    historyList.appendChild(card);
                } else {
                    todoCount++;
                    let statusLabel = status === 'needs_correction' 
                        ? `<span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded font-bold">éœ€è¨‚æ­£</span>` 
                        : `<span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded font-bold">æ–°ä½œæ¥­</span>`;
                    
                    card.classList.add(status === 'needs_correction' ? 'border-yellow-400' : 'border-blue-500');
                    card.innerHTML = `<div><h4 class="font-bold text-gray-800 text-lg">${task.worksheet_title}</h4><div class="flex items-center gap-2 mt-1">${statusLabel}<span class="text-xs text-gray-400">æˆªæ­¢: ${task.deadline || 'ç„¡'}</span></div></div><button class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm shadow hover:bg-blue-700">å‰å¾€ä½œç­”</button>`;
                    card.onclick = () => openWorksheet(taskId, task, userResponse, false);
                    todoList.appendChild(card);
                }
            });
            document.getElementById('todo-count').textContent = todoCount;
        }

        async function openWorksheet(taskId, taskData, responseData, isReadOnly) {
            currentAssignmentId = taskId;
            const modal = document.getElementById('worksheet-modal');
            const form = document.getElementById('worksheet-form');
            const feedbackArea = document.getElementById('teacher-feedback-area');
            const submitBtn = document.getElementById('submit-btn');

            document.getElementById('modal-title').textContent = taskData.worksheet_title;
            document.getElementById('modal-status').textContent = isReadOnly ? 'å”¯è®€æ¨¡å¼' : 'ç·¨è¼¯æ¨¡å¼';

            const wsDoc = await db.collection('worksheets').doc(taskData.worksheet_id).get();
            
            if (!wsDoc.exists) {
                alert('âš ï¸ ç„¡æ³•é–‹å•Ÿï¼šè€å¸«å·²åˆªé™¤æˆ–æ’¤å›æ­¤ä»½å­¸ç¿’å–®ã€‚\n\nç³»çµ±å°‡è‡ªå‹•å¾æ‚¨çš„åˆ—è¡¨ä¸­ç§»é™¤æ­¤ä»»å‹™ã€‚');
                renderDashboard(); 
                return;
            }
            
            form.innerHTML = wsDoc.data().html_content;
			executeEmbeddedScripts(form);

            if (responseData && responseData.answers) {
                const answers = responseData.answers;
                const gradingDetails = responseData.grading_details || {};

                form.querySelectorAll('.worksheet-input').forEach(input => {
                    const name = input.name;
                    if (answers[name] !== undefined) {
                        if (input.type === 'radio' || input.type === 'checkbox') {
                            if (input.value === answers[name]) input.checked = true;
                        } else {
                            input.value = answers[name];
                        }
                    }
                    
                    const det = gradingDetails[name];
                    if (det && (det.is_correct !== undefined || det.feedback)) {
                        
                        if (input.type === 'radio') {
                            const allRadios = form.querySelectorAll(`input[type="radio"][name="${name}"]`);
                            const lastRadio = allRadios[allRadios.length - 1];
                            if (input !== lastRadio) return; 
                        }

                        const isCor = det.is_correct === true;
                        const isInc = det.is_correct === false;
                        const fb = det.feedback || '';

                        const panel = document.createElement('div');
                        panel.className = `grading-panel ${isCor?'correct':(isInc?'incorrect':'')}`;
                        
                        if (input.type === 'radio') {
                            panel.style.gridColumn = "1 / -1";
                            panel.style.width = "100%";
                            panel.style.marginTop = "15px";
                        }

                        let statusIcon = '';
                        if (isCor) statusIcon = '<span class="text-correct">â­• ç­”å°äº†</span>';
                        else if (isInc) statusIcon = '<span class="text-incorrect">âŒ ç­”éŒ¯äº†</span>';

                        let feedbackHtml = fb ? `<div class="mt-2 text-sm text-gray-600 bg-white p-2 rounded border border-gray-200"><strong>ğŸ‘©â€ğŸ« è€å¸«ï¼š</strong>${fb}</div>` : '';

                        panel.innerHTML = `<div class="grading-status-text text-lg">${statusIcon}</div>${feedbackHtml}`;

                        if (input.type === 'radio') {
                            const container = input.parentNode;
                            if(container.nextSibling) container.parentNode.insertBefore(panel, container.nextSibling);
                            else container.parentNode.appendChild(panel);
                        } else {
                            if(input.nextSibling) input.parentNode.insertBefore(panel, input.nextSibling);
                            else input.parentNode.appendChild(panel);
                        }
                    }
                });

                if (responseData.comment) {
                    feedbackArea.classList.remove('hidden');
                    document.getElementById('feedback-text').textContent = responseData.comment;
                } else {
                    feedbackArea.classList.add('hidden');
                }
            } else {
                feedbackArea.classList.add('hidden');
            }

            if (isReadOnly) {
                submitBtn.classList.add('hidden');
                form.querySelectorAll('input, textarea, select').forEach(el => el.disabled = true);
            } else {
                submitBtn.classList.remove('hidden');
            }

            modal.classList.remove('hidden');
        }

        function closeModal() { document.getElementById('worksheet-modal').classList.add('hidden'); }

        document.getElementById('submit-btn').addEventListener('click', async () => {
            const btn = document.getElementById('submit-btn');
            const form = document.getElementById('worksheet-form');
            const answers = {};
            
            form.querySelectorAll('.worksheet-input').forEach(input => {
                if (input.name) {
                    if (input.type === 'radio') { if (input.checked) answers[input.name] = input.value; } 
                    else answers[input.name] = input.value;
                }
            });

            btn.disabled = true; btn.textContent = 'æäº¤ä¸­...';
            try {
                const responseId = `${currentAssignmentId}_${currentUser.uid}`;
                await db.collection('responses').doc(responseId).set({
                    assignment_id: currentAssignmentId,
                    student_uid: currentUser.uid,
                    student_name: studentProfile.displayName,
                    student_no: studentProfile.seatNo,
                    class_id: studentProfile.classId,
                    answers: answers,
                    status: 'submitted',
                    submitted_at: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                alert('ä½œæ¥­å·²æäº¤ï¼');
                closeModal();
                renderDashboard();
            } catch (e) { console.error(e); alert(e.message); } 
            finally { btn.disabled = false; btn.textContent = 'æäº¤ä½œæ¥­'; }
        });
    </script>
</body>
</html>
