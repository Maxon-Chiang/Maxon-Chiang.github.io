<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å…¥ - å­¸ç”Ÿç¶œåˆç´€éŒ„æš¨èª²è¡¨ç³»çµ±</title>
    <style>
		body { 
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif; 
			background-color: #f5f5f5; 
			display: flex; 
			justify-content: center; 
			align-items: flex-start; 
			padding-top: 10vh; 
			margin: 0; 
			width: 100%;
			overflow-x: hidden;
		}
        button, input, select, textarea {
            font-family: inherit;
        }
		.container { 
			background-color: white; 
			padding: 30px 20px; 
			border-radius: 8px; 
			box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
			text-align: center; 
			width: 90%; 
			max-width: 450px; 
			overflow-y: auto;
			max-height: 95vh;
			margin: 10px auto; 
		}
        h1 { 
			color: #333; 
			margin-top: 0; 
			margin-bottom: 25px; 
			word-break: break-word; 
		}
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        button { width: 100%; padding: 12px; background-color: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:hover { background-color: #357abd; }
        #error-message { color: #d0021b; margin-top: 10px; min-height: 20px; font-size: 0.9em; }
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f5f5f5; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4a90e2; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
		.password-wrapper { position: relative; display: flex; align-items: center; }
		.password-wrapper input { padding-right: 50px; }
		.toggle-password { position: absolute; right: 15px; cursor: pointer; font-size: 1.2em; color: #888; }
        
        #google-signin-btn { 
            background-color: #ffffff; 
            color: #444; 
            border: 1px solid #ccc; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            font-size: 1.1em; 
            padding: 15px; 
            min-width: 100%; 
            white-space: nowrap;
        }
        #google-signin-btn:hover { background-color: #f8f8f8; }
        #google-signin-btn img { 
            width: auto; 
            height: 22px; 
            flex-shrink: 0; 
            object-fit: contain; 
        }

        .admin-toggle-link { display: block; margin-top: 25px; font-size: 0.9em; color: #6c757d; text-decoration: none; cursor: pointer; }
        .admin-toggle-link:hover { text-decoration: underline; }

        .options-container { display: flex; justify-content: center; align-items: center; margin: 15px 0; font-size: 0.9em; color: #555; }
        #remember-me { margin-right: 8px; width: 16px; height: 16px; }
        
        .onboarding-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; }
        .onboarding-modal .container { text-align: left; }
        .onboarding-modal h2 { text-align: center; margin-bottom: 20px; }
        .selection-list { list-style-type: none; padding: 0; margin: 20px 0; max-height: 40vh; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; }
        .selection-list li { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s; }
        .selection-list li:last-child { border-bottom: none; }
        .selection-list li:hover { background-color: #f5f5f5; }
        .selection-list strong { display: block; font-size: 1.1em; color: #333; }
        .selection-list span { font-size: 0.9em; color: #666; }
        
        @media (max-width: 600px) {
            h1 {
                font-size: 1.5em; 
            }
            body {
                height: auto; 
                min-height: 100vh;
            }
        }
    </style>
</head>
<body>
    <div id="splash-screen"><div class="spinner"></div><p style="margin-top: 20px; color: #555;">è¼‰å…¥ä¸­...</p></div>
    
    <div id="login-view">
        <div class="container">
            <h1>å­¸ç”Ÿç¶œåˆç´€éŒ„æš¨èª²è¡¨ç³»çµ±</h1>
            
            <div id="teacher-login-view">
                <button id="google-signin-btn">
                    <img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png" alt="Google Logo">
                    ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ (æ•™å¸«)
                </button>
                <a href="#" id="show-admin-login" class="admin-toggle-link">ç®¡ç†å“¡ç™»å…¥è«‹é»æ­¤</a>
            </div>

            <div id="admin-login-view" style="display: none;">
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="ç®¡ç†å“¡ Email" required autocomplete="email">
                    <div class="password-wrapper">
                        <input type="password" id="login-password" placeholder="å¯†ç¢¼" required autocomplete="current-password">
                        <span class="toggle-password" data-target="login-password">ğŸ‘ï¸</span>
                    </div>
                    <div class="options-container"><input type="checkbox" id="remember-me"><label for="remember-me">ä¿æŒç™»å…¥ç‹€æ…‹</label></div>
                    <button type="submit">ç®¡ç†å“¡ç™»å…¥</button>
                </form>
                <a href="#" id="back-to-teacher-login" class="admin-toggle-link">è¿”å›æ•™å¸«ç™»å…¥</a>
            </div>
            
            <p id="error-message"></p>
        </div>
    </div>

    <div id="school-selection-view" class="onboarding-modal">
        <div class="container">
            <h2>èº«åˆ†é©—è­‰</h2>
            <p>æˆ‘å€‘åœ¨æ‚¨çš„ Email ç¶²åŸŸä¸­æ‰¾åˆ°äº†ä»¥ä¸‹å­¸æ ¡ï¼Œè«‹é¸æ“‡æ‚¨ä»»è·çš„å­¸æ ¡ï¼š</p>
            <ul id="school-selection-list" class="selection-list">
                </ul>
        </div>
    </div>

    <div id="teacher-selection-view" class="onboarding-modal">
        <div class="container">
            <h2 id="teacher-selection-title">èº«åˆ†ç¢ºèª</h2>
            <p>è«‹åœ¨ä¸‹åˆ—åå–®ä¸­é¸æ“‡æ‚¨çš„èº«åˆ†ï¼Œä»¥å®Œæˆå¸³è™Ÿç¶å®šã€‚</p>
            <ul id="teacher-selection-list" class="selection-list">
                </ul>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
	  const firebaseConfig = {
		apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
		authDomain: "classrecords-13902.firebaseapp.com",
		projectId: "classrecords-13902",
		storageBucket: "classrecords-13902.firebasestorage.app",
		messagingSenderId: "431747377367",
		appId: "1:431747377367:web:b157a8f5c59ce38091e892",
		measurementId: "G-JWTQGM9XMP"
	  };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const splashScreen = document.getElementById('splash-screen');
        const loginView = document.getElementById('login-view');
        const errorMessage = document.getElementById('error-message');
        const schoolSelectionView = document.getElementById('school-selection-view');
        const teacherSelectionView = document.getElementById('teacher-selection-view');
        const teacherLoginView = document.getElementById('teacher-login-view');
        const adminLoginView = document.getElementById('admin-login-view');
        const showAdminLoginLink = document.getElementById('show-admin-login');
        const backToTeacherLoginLink = document.getElementById('back-to-teacher-login');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');

        // ğŸ¯ã€å¿«å–å„ªåŒ–ã€‘å®šç¾©å¿«å–éµ
        const USER_CACHE_KEY = 'teacher_static_cache_v6';

        const savedEmail = localStorage.getItem('lastLoginEmail');
        if (savedEmail) {
            loginEmailInput.value = savedEmail;
        }
        
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                if (user.email) {
                    localStorage.setItem('lastLoginEmail', user.email);
                }
                
                splashScreen.style.display = 'flex';

                // ğŸ¯ã€å¿«å–å„ªåŒ–ã€‘å˜—è©¦å¾å¿«å–è®€å–ç”¨æˆ¶è³‡æ–™
                const cachedData = localStorage.getItem(USER_CACHE_KEY);
                let userDocData = null;
                if (cachedData) {
                    try {
                        const parsedCache = JSON.parse(cachedData);
                        if (parsedCache.userData && parsedCache.userData.uid === user.uid) {
                            userDocData = parsedCache.userData;
                            console.log('å¿«å–å‘½ä¸­ï¼šè®€å–åˆ°ç”¨æˆ¶è³‡æ–™ã€‚');
                        }
                    } catch (e) {
                         console.error('è§£æå¿«å–å¤±æ•—:', e);
                         localStorage.removeItem(USER_CACHE_KEY);
                    }
                }
                
                // ğŸ¯ã€å¿«å–å„ªåŒ–ã€‘å¦‚æœå¿«å–ä¸å­˜åœ¨ï¼Œæ‰å¾ Firestore è®€å–
                if (!userDocData) {
                    console.log('è¼‰å…¥userè³‡æ–™...'); // ä¿ç•™åŸ console.log
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                         userDocData = userDoc.data();
                    }
                }

                if (userDocData) {
                    // ğŸ¯ã€å¿«å–å„ªåŒ–ã€‘ç¢ºä¿æœ€æ–°è®€å–çš„è³‡æ–™ä¹Ÿå¯«å…¥å¿«å– (å¦‚æœä¸æ˜¯å¾å¿«å–è®€å–çš„è©±)
                    if (!cachedData || !JSON.parse(cachedData).userData) {
                         // å‰µå»ºä¸€å€‹åªåŒ…å«ç”¨æˆ¶è³‡æ–™çš„å¿«å–ç‰©ä»¶ä¸¦å„²å­˜
                         localStorage.setItem(USER_CACHE_KEY, JSON.stringify({ userData: { uid: user.uid, ...userDocData } }));
                    }
                    
                    routeUser(userDocData.role);
                } else {
                    await startOnboarding(user);
                }
            } else {
                splashScreen.style.display = 'none';
                loginView.style.display = 'block';
                schoolSelectionView.style.display = 'none';
                teacherSelectionView.style.display = 'none';
            }
        });
        
        async function startOnboarding(user) {
            try {
                const emailDomain = user.email.split('@')[1];

                const schoolsSnapshot = await db.collection('schools').where('domain', '==', emailDomain).get();
                
                if (schoolsSnapshot.empty) {
                    showLoginError(`æ‚¨çš„ Email ç¶²åŸŸ (${emailDomain}) æœªåœ¨æœ¬ç³»çµ±è¨»å†Šä»»ä½•å­¸æ ¡ã€‚è«‹è¯ç¹«è¶…ç´šç®¡ç†å“¡ã€‚`);
                    return;
                }

                const potentialSchools = schoolsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (potentialSchools.length === 1) {
                    await handleSchoolSelection(user, potentialSchools[0].id);
                } else {
                    displaySchoolSelection(user, potentialSchools);
                }

            } catch (error) {
                showLoginError("é©—è­‰å­¸æ ¡èº«åˆ†æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
            }
        }

        function displaySchoolSelection(user, schools) {
            const schoolList = document.getElementById('school-selection-list');
            schoolList.innerHTML = '';
            schools.forEach(school => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${school.name}</strong>`;
                li.onclick = () => handleSchoolSelection(user, school.id);
                schoolList.appendChild(li);
            });
            
            splashScreen.style.display = 'none';
            loginView.style.display = 'none';
            schoolSelectionView.style.display = 'flex';
        }

        async function handleSchoolSelection(user, schoolId) {
            try {
                splashScreen.style.display = 'flex';
                
                const googleName = user.displayName;
                const teachersSnapshot = await db.collection('schools').doc(schoolId).collection('teachers').where('name', '==', googleName).get();

                if (teachersSnapshot.empty) {
                    const schoolDoc = await db.collection('schools').doc(schoolId).get();
                    const schoolName = schoolDoc.exists ? schoolDoc.data().name : 'è©²å­¸æ ¡';
                    showLoginError(`åœ¨ã€Œ${schoolName}ã€çš„æ•™å¸«åå†Šä¸­æ‰¾ä¸åˆ°æ‚¨çš„å§“åã€Œ${googleName}ã€ã€‚è«‹è¯ç¹«æ‚¨çš„å­¸æ ¡ç®¡ç†è€…ï¼Œç¢ºèªåå†Šä¸Šçš„å§“åæ˜¯å¦èˆ‡æ‚¨çš„ Google å¸³æˆ¶åç¨±å®Œå…¨ä¸€è‡´ã€‚`);
                    return;
                }

                const matchingTeachers = teachersSnapshot.docs.map(doc => doc.data());

                if (matchingTeachers.length === 1) {
                    await createUserProfile(user, schoolId, matchingTeachers[0]);
                } else {
                    const schoolDoc = await db.collection('schools').doc(schoolId).get();
                    const schoolName = schoolDoc.exists ? schoolDoc.data().name : '';
                    displayTeacherSelection(user, schoolId, schoolName, matchingTeachers);
                }

            } catch (error) {
                 showLoginError("æŸ¥æ‰¾æ•™å¸«è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
            }
        }

		async function createUserProfile(user, schoolId, teacherProfile) {
			try {
				splashScreen.style.display = 'flex';

				const schoolDoc = await db.collection('schools').doc(schoolId).get();
				if (!schoolDoc.exists) throw new Error("æ‰¾ä¸åˆ°å­¸æ ¡è³‡æ–™");
				const schoolData = schoolDoc.data();

				const newUserProfile = {
					role: 'teacher',
					email: user.email,
					displayName: teacherProfile.name, 
					schoolId: schoolId,
					schoolCode: schoolData.schoolCode,
					// ğŸ¯ã€å¿«å–å„ªåŒ–ã€‘æ–°å¢ uid å±¬æ€§åˆ° profile
					uid: user.uid, 
					...teacherProfile 
				};

				await db.collection('users').doc(user.uid).set(newUserProfile);
				
				// ğŸ¯ã€å¿«å–å„ªåŒ–ã€‘åœ¨å‰µå»ºç”¨æˆ¶è³‡æ–™å¾Œï¼Œå¯«å…¥æœ¬åœ°å¿«å–
				localStorage.setItem(USER_CACHE_KEY, JSON.stringify({ userData: newUserProfile }));

				routeUser('teacher');

			} catch (error) {
				showLoginError("å»ºç«‹ä½¿ç”¨è€…è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
			}
		}

        googleSignInBtn.addEventListener('click', async () => {
            errorMessage.textContent = '';
            splashScreen.style.display = 'flex';
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                splashScreen.style.display = 'none';
                errorMessage.textContent = 'Google ç™»å…¥å¤±æ•—: ' + error.message;
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = document.getElementById('login-password').value;
            errorMessage.textContent = '';
            splashScreen.style.display = 'flex';
            
            try {
                const persistence = document.getElementById('remember-me').checked ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
                await auth.setPersistence(persistence);
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // ğŸ¯ã€å¿«å–å„ªåŒ–ã€‘ç®¡ç†å“¡ç™»å…¥æ™‚ä¹Ÿå°‡ç”¨æˆ¶è³‡æ–™å¯«å…¥å¿«å–
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userDocData = userDoc.data();
                    localStorage.setItem(USER_CACHE_KEY, JSON.stringify({ userData: { uid: user.uid, ...userDocData } }));
                    routeUser(userDocData.role);
                } else {
                     showLoginError("æ‰¾ä¸åˆ°ç”¨æˆ¶è³‡æ–™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚");
                }

            } catch (error) {
                splashScreen.style.display = 'none';
                errorMessage.textContent = 'Email æˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œå†è©¦ã€‚';
            }
        });

        showAdminLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            teacherLoginView.style.display = 'none';
            adminLoginView.style.display = 'block';
            errorMessage.textContent = '';
        });

        backToTeacherLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            adminLoginView.style.display = 'none';
            teacherLoginView.style.display = 'block';
            errorMessage.textContent = '';
        });

        document.querySelectorAll('.toggle-password').forEach(toggle => {
			toggle.addEventListener('click', () => {
				const targetId = toggle.dataset.target;
				const passwordInput = document.getElementById(targetId);
				if (passwordInput.type === 'password') {
					passwordInput.type = 'text';
					toggle.textContent = 'ğŸ™ˆ';
				} else {
					passwordInput.type = 'password';
					toggle.textContent = 'ğŸ‘ï¸';
				}
			});
		});

        function routeUser(role) {
            if (role === 'admin') {
                window.location.href = 'admin.html';
            } else if (role === 'school_admin') {
                window.location.href = 'school_admin.html';
            } else if (role === 'teacher') {
				//localStorage.setItem('teacherTimetableNeedsRefresh', 'true');
                window.location.href = 'teacher.html';
            } else {
                showLoginError(`æœªçŸ¥çš„ç”¨æˆ¶è§’è‰² (${role})ï¼Œç„¡æ³•ç™»å…¥ã€‚`);
            }
        }

        function showLoginError(msg) {
            splashScreen.style.display = 'none';
            loginView.style.display = 'block';
            schoolSelectionView.style.display = 'none';
            teacherSelectionView.style.display = 'none';
            errorMessage.textContent = msg;
            auth.signOut();
        }
    });
    </script>
</body>
</html>
