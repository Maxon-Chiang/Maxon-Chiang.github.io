<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸æ ¡ç®¡ç†å¾Œå°</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif; padding: 20px; max-width: 1200px; margin: auto; background-color: #f8f9fa; }
        h1, h2, h3 { color: #333; }
        button, input, select, textarea { font-family: inherit; padding: 8px; margin: 5px 0; font-size: 1em; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background-color: #0d6efd; color: white; cursor: pointer; border: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .section { background-color: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #dee2e6; }
        textarea { width: 98%; min-height: 150px; font-size: 0.9em; line-height: 1.6; }
        .info-box { background-color: #fffbe6; padding: 15px; border: 1px solid #ffe58f; border-radius: 4px; font-size: 0.9em; line-height: 1.6; margin-bottom: 15px; }
        .danger-zone { border: 2px solid #dc3545; }
        .danger-zone h2 { color: #dc3545; }
        #reset-semester-btn { background-color: #dc3545; padding: 10px 20px; font-size: 1.1em; }
        #announcement-section { background-color: #e7f3ff; border-color: #b3d7ff; }
        #announcement-section h2 { color: #004085; }
        #announcement-content { white-space: pre-wrap; word-break: break-word; line-height: 1.7; }
        #announcement-meta { font-size: 0.9em; color: #555; text-align: right; }
        
        .data-block {
            border-bottom: 1px dashed #ccc;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .data-block:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        #periods-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }
        #periods-table th, #periods-table td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: center;
        }
        #periods-table th {
            background-color: #f2f2f2;
        }
        #periods-table input[type="time"] {
            width: 150px;
            text-align: center;
            font-size: 1em;
        }
        #periods-table input[type="number"] {
            width: 60px;
            text-align: center;
        }
        #periods-table .duration-unit {
             white-space: nowrap;
             padding-left: 5px;
        }
        #periods-table button {
            background-color: #6c757d;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        .upload-btn {
             background-color: #198754; 
             padding: 10px 20px; 
             font-size: 1.1em;
             margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>å­¸æ ¡ç®¡ç†å¾Œå°</h1>
        <div id="admin-panel" style="display: none;">
            <span>æ­¡è¿ï¼Œ<span id="admin-email"></span>ï¼</span>
            <button id="logout-btn" style="margin-left: 15px; background-color: #6c757d;">ç™»å‡º</button>
        </div>
    </div>
    <div id="announcement-section" class="section">
        <h2>æœ€æ–°ç³»çµ±å…¬å‘Š</h2>
        <div id="announcement-content">è¼‰å…¥ä¸­...</div>
        <div id="announcement-meta"></div>
    </div>
    <div class="section">
        <h2>å­¸æœŸè³‡æ–™è¨­å®šèˆ‡ä¸Šå‚³</h2>
        <p class="info-box">è«‹å°‡æ¯é …è³‡æ–™è²¼ä¸Š/è¨­å®šå®Œæˆå¾Œï¼Œé»æ“Šè©²å€å¡Šçš„ã€Œä¸Šå‚³ã€æŒ‰éˆ•ç¨ç«‹æ›´æ–°ã€‚å¿…è¦è³‡æ–™ï¼šèª²ç¨‹æ™‚é–“ â†’ å­¸ç”Ÿåå†Š â†’ æ•™å¸«èª²è¡¨ã€‚</p>
        <div class="data-block">
            <h3>1. èª²ç¨‹æ™‚é–“è¡¨ (æ¯ç¯€èª²èµ·è¨–æ™‚é–“)</h3>
            <p class="info-box">è«‹è¨­å®šæ¯ç¯€èª²çš„é–‹å§‹æ™‚é–“å’ŒæŒçºŒåˆ†é˜æ•¸ã€‚</p>
            <table id="periods-table">
                <thead>
                    <tr>
                        <th>ç¯€æ¬¡</th>
                        <th>é–‹å§‹æ™‚é–“</th>
                        <th>æŒçºŒæ™‚é–“ (åˆ†é˜)</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="periods-tbody">
                    </tbody>
            </table>
            <button id="add-period-btn" style="margin-top: 10px;">+ æ–°å¢ä¸€ç¯€èª²</button>
            <button id="upload-periods-btn" class="upload-btn" data-type="periods">ä¸Šå‚³èª²ç¨‹æ™‚é–“è¡¨</button>
        </div>
        <div class="data-block">
            <label for="roster-data"><h3>2. å­¸ç”Ÿåå†Š</h3></label>
            <textarea id="roster-data" placeholder="æ ¼å¼: ç­ç´šåº§è™Ÿ,å§“å (ä¸€è¡Œä¸€ç­†)&#10;70101,é™³å®¥ç‚˜&#10;70102,å»–ç¿ŠæšŸ"></textarea>
            <button id="upload-roster-btn" class="upload-btn" data-type="roster">ä¸Šå‚³å­¸ç”Ÿåå†Š</button>
        </div>
        <div class="data-block">
            <label for="timetable-data"><h3>3. å…¨æ ¡æ•™å¸«èª²è¡¨</h3></label>
            <textarea id="timetable-data" placeholder="è«‹è²¼ä¸Šå·²è½‰AIæ›éçš„ CSV æ ¼å¼èª²è¡¨..."></textarea>
            <button id="upload-timetable-btn" class="upload-btn" data-type="timetable">ä¸Šå‚³æ•™å¸«èª²è¡¨</button>
        </div>
    </div>
    <div class="section" style="border-left: 5px solid #6610f2;">
        <h2>å…¨æ ¡æ•™å¸«ç´€éŒ„ç®¡ç† (å‚™ä»½/åŒ¯å…¥)</h2>
        <p class="info-box">
            <strong>èªªæ˜ï¼š</strong> æ­¤åŠŸèƒ½ç”¨æ–¼å‚™ä»½å­¸æ ¡å…§æ‰€æœ‰è€å¸«çš„ã€Œå­¸ç”Ÿæˆç¸¾ (Gradebooks)ã€èˆ‡ã€Œæ—¥å¸¸è¡¨ç¾ç´€éŒ„ (Performance Records)ã€ã€‚<br>
            <span style="color: #6610f2;">é©ç”¨æƒ…å¢ƒï¼šæœŸæœ«å°å­˜ã€è³‡æ–™ç§»è½‰ã€‚</span><br>
            <span style="color: red;">æ³¨æ„ï¼šè³‡æ–™é‡è¼ƒå¤§æ™‚ï¼Œå‚™ä»½èˆ‡åŒ¯å…¥å¯èƒ½éœ€è¦æ•¸åˆ†é˜ï¼Œè«‹å‹¿é—œé–‰è¦–çª—ã€‚</span>
        </p>
        
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
                <h3>åŒ¯å‡ºæ•™å¸«ç´€éŒ„ (å‚™ä»½)</h3>
                <p>å°‡å…¨æ ¡è€å¸«çš„æˆç¸¾èˆ‡è¡¨ç¾ç´€éŒ„ä¸‹è¼‰ç‚º JSON æª”ã€‚</p>
                <button id="backup-teachers-btn" style="background-color: #6610f2;">â¬‡ï¸ ä¸‹è¼‰å…¨æ ¡ç´€éŒ„å‚™ä»½</button>
            </div>
            
            <div style="flex: 1; min-width: 300px; border-left: 1px solid #eee; padding-left: 20px;">
                <h3>åŒ¯å…¥æ•™å¸«ç´€éŒ„ (åˆä½µ)</h3>
                <p>ä¸Šå‚³ JSON æª”ã€‚æ­¤æ“ä½œç‚º<strong>ã€Œæ–°å¢æˆ–æ›´æ–°ã€</strong>ï¼Œ<br>ä¸æœƒåˆªé™¤ç¾æœ‰è³‡æ–™ (Merge Mode)ã€‚</p>
                <input type="file" id="import-teachers-input" accept=".json" style="display: block; margin-bottom: 10px;">
                <button id="import-teachers-btn" style="background-color: #6c757d;" disabled>â¬†ï¸ é–‹å§‹åŒ¯å…¥</button>
            </div>
        </div>
        <div id="progress-log" style="margin-top: 15px; font-family: monospace; font-size: 0.9em; color: #555; max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 10px; border: 1px solid #ddd; display: none;"></div>
    </div>	
    <div class="section danger-zone">
        <h2>å­¸æœŸé‡è¨­ (å±éšªæ“ä½œ)</h2>
        <p class="info-box">
            <strong>åŠŸèƒ½èªªæ˜ï¼š</strong> æ­¤æ“ä½œç”¨æ–¼å­¸æœŸçµæŸæ™‚çš„è³‡æ–™æ¸…ç†ã€‚<br>
            <span style="color: #dc3545;">
                <strong>[æœƒåˆªé™¤]</strong> å…¨æ ¡è€å¸«çš„ã€Œæˆç¸¾ç´€éŒ„ã€ã€ã€Œæ—¥å¸¸è¡¨ç¾ç´€éŒ„ã€èˆ‡ã€Œæˆç¸¾è¨ˆç®—è¦å‰‡ã€ã€‚<br>
            </span>
            <span style="color: #0d6efd;">
                <strong>[ä¿ç•™ä¸è®Š]</strong> ã€Œèª²ç¨‹æ™‚é–“è¡¨ã€ã€ã€Œå­¸ç”Ÿåå†Šã€èˆ‡ã€Œå…¨æ ¡æ•™å¸«èª²è¡¨ã€ä¸æœƒè¢«æ›´å‹•ã€‚<br>
                (è‹¥éœ€æ›´æ–°åå†Šæˆ–èª²è¡¨ï¼Œè«‹ä½¿ç”¨ä¸Šæ–¹çš„ã€Œä¸Šå‚³ã€åŠŸèƒ½ç›´æ¥è¦†è“‹å³å¯)
            </span>
        </p>
        <button id="reset-semester-btn">åŸ·è¡Œå­¸æœŸé‡è¨­</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
	  const firebaseConfig = {
		apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
		authDomain: "classrecords-13902.firebaseapp.com",
		projectId: "classrecords-13902",
		storageBucket: "classrecords-13902.firebasestorage.app",
		messagingSenderId: "431747377367",
		appId: "1:431747377367:web:b157a8f5c59ce38091e892",
		measurementId: "G-JWTQGM9XMP"
	  };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentUser = null;
        let schoolId = null; 
        
        let periodData = [
            { period: 1, start: '08:10', duration: 50 },
            { period: 2, start: '09:10', duration: 50 },
            { period: 3, start: '10:10', duration: 50 },
            { period: 4, start: '11:10', duration: 50 },
            { period: 5, start: '13:10', duration: 50 },
            { period: 6, start: '14:10', duration: 50 },
            { period: 7, start: '15:10', duration: 50 },
            { period: 8, start: '16:10', duration: 50 }
        ];
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().role === 'school_admin') {
                    const userData = userDoc.data();
                    schoolId = userData.schoolId; 
                    if (!schoolId) {
                        document.body.innerHTML = '<h1>éŒ¯èª¤ï¼šæ‚¨çš„ç®¡ç†è€…å¸³è™Ÿæœªç¶å®šå­¸æ ¡IDï¼Œè«‹è¯ç¹«è¶…ç´šç®¡ç†å“¡ã€‚</h1>';
                        return;
                    }
                    document.getElementById('admin-email').textContent = userData.displayName || user.email;
                    document.getElementById('admin-panel').style.display = 'block';
                    loadLatestAnnouncement();
                    await loadPeriodsData();
                    renderPeriodsTable();
                } else {
                    alert('æ¬Šé™ä¸è¶³ï¼');
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        function calculateEndTime(startTime, duration) {
            const [startH, startM] = startTime.split(':').map(Number);
            const totalMinutes = startH * 60 + startM + duration;
            const endH = Math.floor(totalMinutes / 60) % 24;
            const endM = totalMinutes % 60;
            const pad = (n) => String(n).padStart(2, '0');
            return `${pad(endH)}:${pad(endM)}`;
        }
        
        async function loadPeriodsData() {
            try {
                const periodsDoc = await db.collection('schools').doc(schoolId).collection('periods').doc('current').get();
                if (periodsDoc.exists && periodsDoc.data().times && periodsDoc.data().times.length > 0) {
                    periodData = periodsDoc.data().times.map(item => ({
                        period: item.period,
                        start: item.start,
                        duration: item.duration || 50
                    }));
                }
            } catch (error) {
                console.error("è¼‰å…¥èª²ç¨‹æ™‚é–“è¡¨å¤±æ•—:", error);
            }
        }

		function renderPeriodsTable() {
            const tbody = document.getElementById('periods-tbody');
            tbody.innerHTML = '';
            periodData.sort((a, b) => a.period - b.period);
            periodData.forEach((item, index) => {
                const endTime = calculateEndTime(item.start, item.duration);
                const row = tbody.insertRow();
                row.dataset.index = index;
                row.insertCell().textContent = item.period;
                const startCell = row.insertCell();
                startCell.innerHTML = `<input type="time" class="period-start" value="${item.start}">`;
                const durationCell = row.insertCell();
                durationCell.innerHTML = `
                    <div style="display:flex; align-items:center; justify-content:center;">
                        <input type="number" class="period-duration" value="${item.duration}" min="10" step="5">
                        <span class="duration-unit">(åˆ†é˜)</span>
                    </div>`;
                const actionCell = row.insertCell();
                actionCell.innerHTML = `<span class="period-end" style="margin-right: 10px; font-weight: bold;">~ ${endTime}</span> <button class="delete-period-btn" data-index="${index}">åˆªé™¤</button>`;
            });
            tbody.querySelectorAll('.period-start, .period-duration').forEach(input => {
                input.addEventListener('change', updatePeriodData);
            });
            tbody.querySelectorAll('.delete-period-btn').forEach(button => {
                button.addEventListener('click', deletePeriod);
            });
        }
        
        function updatePeriodData(e) {
            const row = e.target.closest('tr');
            const index = parseInt(row.dataset.index);
            const dataItem = periodData[index];
            
            if (e.target.classList.contains('period-start')) {
                dataItem.start = e.target.value;
            } else if (e.target.classList.contains('period-duration')) {
                let duration = parseInt(e.target.value);
                if (isNaN(duration) || duration < 10) {
                    e.target.value = 10;
                    duration = 10;
                }
                dataItem.duration = duration;
            }
            const endTime = calculateEndTime(dataItem.start, dataItem.duration);
            row.querySelector('.period-end').textContent = `~ ${endTime}`;
        }
        
        function deletePeriod(e) {
            const index = parseInt(e.target.dataset.index);
            periodData.splice(index, 1);
            periodData.forEach((item, i) => item.period = i + 1);
            renderPeriodsTable();
        }

        document.getElementById('add-period-btn').addEventListener('click', () => {
            const newPeriodNum = periodData.length > 0 ? periodData[periodData.length - 1].period + 1 : 1;
            const lastEndTime = periodData.length > 0 ? calculateEndTime(periodData[periodData.length - 1].start, periodData[periodData.length - 1].duration) : '08:00';
            const [lastH, lastM] = lastEndTime.split(':').map(Number);
            const nextStartMinutes = lastH * 60 + lastM + 10; 
            const nextStartH = Math.floor(nextStartMinutes / 60) % 24;
            const nextStartM = nextStartMinutes % 60;
            const pad = (n) => String(n).padStart(2, '0');
            const nextStartTime = `${pad(nextStartH)}:${pad(nextStartM)}`;
            periodData.push({ period: newPeriodNum, start: nextStartTime, duration: 50 });
            renderPeriodsTable();
        });
        async function loadLatestAnnouncement() {
            const contentEl = document.getElementById('announcement-content');
            const metaEl = document.getElementById('announcement-meta');
            try {
                const snapshot = await db.collection('announcements').orderBy('createdAt', 'desc').limit(1).get();
                if (snapshot.empty) {
                    contentEl.textContent = 'ç›®å‰æ²’æœ‰ç³»çµ±å…¬å‘Šã€‚';
                    return;
                }
                const doc = snapshot.docs[0];
                const announcement = doc.data();
                const date = announcement.createdAt.toDate().toLocaleString('zh-TW');
                contentEl.textContent = announcement.content;
                metaEl.textContent = `ç™¼å¸ƒæ–¼ ${date}`;
            } catch (error) {
                contentEl.innerHTML = `<strong style="color:red;">è®€å–å…¬å‘Šå¤±æ•—ï¼š</strong><br>${error.message}`;
            }
        }
        
        function parseRoster(text) {
            const students = [];
            const lines = text.trim().split('\n');
            lines.forEach((line, index) => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length < 2 || !parts[0] || !parts[1]) return;
                const [id, name] = parts;
                if (!/^\d{5}$/.test(id)) throw new Error(`å­¸ç”Ÿåå†Šç¬¬ ${index + 1} è¡Œçš„ç­ç´šåº§è™Ÿ (${id}) æ ¼å¼ä¸æ­£ç¢º`);
                students.push({ id, name });
            });
            if (students.length === 0) throw new Error('æœªè§£æåˆ°ä»»ä½•æœ‰æ•ˆçš„å­¸ç”Ÿè³‡æ–™ã€‚');
            return students;
        }

      
        async function uploadPeriods() {
            try {
                if (periodData.length === 0) return alert('è«‹è‡³å°‘è¨­å®šä¸€ç¯€èª²çš„æ™‚é–“ï¼');
                const periodsToUpload = periodData.map((item, index) => ({
                    period: index + 1,
                    start: item.start,
                    duration: item.duration,
                    end: calculateEndTime(item.start, item.duration)
                }));
                const confirmationMessage = `ç¢ºèªä¸Šå‚³ ${periodsToUpload.length} ç¯€èª²ç¨‹æ™‚é–“è¡¨ï¼Ÿ`;
                if (!confirm(confirmationMessage)) return alert('æ“ä½œå·²å–æ¶ˆã€‚');
                const schoolRef = db.collection('schools').doc(schoolId);
                const periodsRef = schoolRef.collection('periods').doc('current');
                await periodsRef.set({ times: periodsToUpload, uploadedAt: new Date() });
                alert('èª²ç¨‹æ™‚é–“è¡¨å·²æˆåŠŸä¸Šå‚³/æ›´æ–°ï¼');
                renderPeriodsTable();
            } catch (error) {
                alert('ä¸Šå‚³èª²ç¨‹æ™‚é–“è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š\n' + error.message);
                console.error(error);
            }
        }
        
        async function uploadRoster() {
            const text = document.getElementById('roster-data').value;
            if (!text) return alert('è«‹è²¼ä¸Šå­¸ç”Ÿåå†Šè³‡æ–™ï¼');
            try {
                const students = parseRoster(text);
                const confirmationMessage = `ç¢ºèªä¸Šå‚³ ${students.length} ç­†å­¸ç”Ÿåå†Šè³‡æ–™ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ã€‚`;
                if (!confirm(confirmationMessage)) return alert('æ“ä½œå·²å–æ¶ˆã€‚');
                const schoolRef = db.collection('schools').doc(schoolId);
                const rosterRef = schoolRef.collection('rosters').doc('current');
                await rosterRef.set({ students: students, uploadedAt: new Date() });
                alert('å­¸ç”Ÿåå†Šå·²æˆåŠŸä¸Šå‚³/æ›´æ–°ï¼');
            } catch (error) {
                alert('ä¸Šå‚³å­¸ç”Ÿåå†Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š\n' + error.message);
                console.error(error);
            }
        }
       
        function parseTimetable(text) {
            const OFFICIAL_SUBJECTS = ['åœ‹æ–‡', 'è‹±æ–‡', 'è‹±èª', 'æ•¸å­¸', 'ç¤¾æœƒ', 'è‡ªç„¶', 'ç¶œåˆ', 'è—è¡“', 'å¥é«”', 'ç§‘æŠ€', 'å…¬æ°‘', 'æ­·å²', 'åœ°ç†', 'ç†åŒ–', 'ç”Ÿç‰©', 'åœ°ç§‘', 'è¡¨æ¼”', 'è¦–è¦º', 'éŸ³æ¨‚', 'é«”è‚²', 'å®¶æ”¿', 'ç«¥è»', 'è¼”å°', 'æœ¬åœŸèª', 'è³‡è¨Šç§‘æŠ€', 'ç”Ÿæ´»ç§‘æŠ€'];
            const PERIOD_NAMES = ['ç¬¬ä¸€ç¯€', 'ç¬¬äºŒç¯€', 'ç¬¬ä¸‰ç¯€', 'ç¬¬å››ç¯€', 'ç¬¬äº”ç¯€', 'ç¬¬å…­ç¯€', 'ç¬¬ä¸ƒç¯€', 'ç¬¬å…«ç¯€'];
            const lines = text.trim().split(/\r?\n/);
            
            // åµæ¸¬æ¨™é ­ä¸¦ç§»é™¤ (ä¿æŒä¸è®Š)
            if (lines.length > 0 && (lines[0].includes('è€å¸«åç¨±') || lines[0].includes('æ•™å¸«å§“å'))) {
                lines.shift();
            }

            const schedules = {};
            const teacherTitles = {};
            const teacherSubjects = {};

            for (let i = 0; i < lines.length; i++) {
                const parts = lines[i].split(',').map(p => p.trim());
                
                // --- ğŸŸ¢ é—œéµä¿®æ”¹è™• ---
                // æª¢æŸ¥æ¬„ä½æ•¸é‡ï¼Œä¸¦å‹•æ…‹æ±ºå®šè¦è®€å–å“ªå¹¾å€‹æ¬„ä½
                let name, title, periodStr, mon, tue, wed, thu, fri;

                if (parts.length >= 9) {
                    // 9 æ¬„æ ¼å¼: [å§“å, é ­éŠœ, é ˜åŸŸ, ç¯€æ¬¡, é€±ä¸€, ..., é€±äº”]
                    [name, title, , periodStr, mon, tue, wed, thu, fri] = parts; // ç¬¬3æ¬„(é ˜åŸŸ)ç”¨ç©ºç™½ä½”ä½ç¬¦å¿½ç•¥
                } else if (parts.length === 8) {
                    // 8 æ¬„æ ¼å¼: [å§“å, é ­éŠœ, ç¯€æ¬¡, é€±ä¸€, ..., é€±äº”]
                    [name, title, periodStr, mon, tue, wed, thu, fri] = parts;
                } else {
                    // æ¬„ä½æ•¸ä¸è¶³ï¼Œè·³éæ­¤è¡Œ
                    console.warn(`[è§£æè­¦å‘Š] ç¬¬ ${i + 2} è¡Œçš„æ¬„ä½æ•¸é‡ä¸è¶³ (${parts.length}æ¬„)ï¼Œå·²å¿½ç•¥ã€‚`);
                    continue;
                }
                // --- ğŸŸ¢ ä¿®æ”¹çµæŸ ---

                if (!name) continue;

                if (!schedules[name]) {
                    schedules[name] = Array.from({ length: 8 }, () => Array(5).fill('')); 
                    teacherSubjects[name] = new Set();
                    teacherTitles[name] = title;
                }

                const periodIndex = PERIOD_NAMES.indexOf(periodStr);
                if (periodIndex === -1 && periodStr) {
                    console.warn(`[è§£æè­¦å‘Š] æ‰¾ä¸åˆ°å°æ‡‰çš„ç¯€æ¬¡åç¨±: "${periodStr}" æ–¼ç¬¬ ${i + 2} è¡Œã€‚è©²è¡Œèª²è¡¨å°‡è¢«å¿½ç•¥ã€‚`);
                }
                
                if (periodIndex !== -1 && periodIndex < 8) {
                    const dailyLessons = [mon, tue, wed, thu, fri];
                    schedules[name][periodIndex] = dailyLessons;
                    dailyLessons.forEach(lesson => {
                        if (lesson) {
                            for (const officialSub of OFFICIAL_SUBJECTS) {
                                if (lesson.includes(officialSub)) {
                                    teacherSubjects[name].add(officialSub);
                                    break;
                                }
                            }
                        }
                    });
                }
            }

            for (const teacher in teacherSubjects) {
                teacherSubjects[teacher] = Array.from(teacherSubjects[teacher]).join(', ') || 'å…¶ä»–';
            }
            
            return { schedules, teacherTitles, teacherSubjects };
        }
        
        async function uploadTimetable() {
            const text = document.getElementById('timetable-data').value;
            if (!text) return alert('è«‹è²¼ä¸Šå…¨æ ¡èª²è¡¨è³‡æ–™ï¼');
            
            const btn = document.getElementById('upload-timetable-btn');

            try {
                // 1. è§£æè³‡æ–™
                const { schedules, teacherTitles, teacherSubjects } = parseTimetable(text);
                const teacherCount = Object.keys(schedules).length;

                if (teacherCount === 0) {
                    alert("âš ï¸ éŒ¯èª¤ï¼šè§£æåˆ°çš„æ•™å¸«æ•¸é‡ç‚º 0ï¼\n\nè«‹æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·ï¼ŒæŸ¥çœ‹ Console (æ§åˆ¶å°) ä¸­çš„è©³ç´°è­¦å‘Šè¨Šæ¯ï¼Œç¢ºèª CSV æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚\n(è³‡æ–™åº«æœªé€²è¡Œä»»ä½•è®Šæ›´)");
                    return;
                }

                if (!confirm(`âœ… è§£ææˆåŠŸï¼å…±æ‰¾åˆ° ${teacherCount} ä½è€å¸«çš„èª²è¡¨ã€‚\n\nç¢ºå®šè¦è¦†è“‹ç¾æœ‰çš„å…¨æ ¡èª²è¡¨å—ï¼Ÿ`)) {
                    return alert('æ“ä½œå·²å–æ¶ˆã€‚');
                }
                
                btn.disabled = true;
                btn.textContent = "æ­£åœ¨å¯«å…¥è³‡æ–™åº«...";

                const schoolRef = db.collection('schools').doc(schoolId);
                const batch = db.batch();

                // 3. æ¸…é™¤èˆŠèª²è¡¨
                const oldTimetables = await schoolRef.collection('timetables').get();
                oldTimetables.forEach(doc => batch.delete(doc.ref));

                // 4. å¯«å…¥æ–°è³‡æ–™
                for (const name in schedules) {
                    const scheduleObject = {};
                    schedules[name].forEach((dayData, periodIndex) => {
                        scheduleObject[periodIndex] = dayData;
                    });
                    const scheduleData = { 
                         periods: scheduleObject,
                         title: teacherTitles[name] || 'å°ˆä»»æ•™å¸«', 
                         subject: teacherSubjects[name] || 'å…¶ä»–'
                     };
                    // --- å†æ¬¡åµéŒ¯ ---
                    // æª¢æŸ¥æº–å‚™å¯«å…¥çš„å–®ä¸€è€å¸«è³‡æ–™æ˜¯å¦ç‚ºç©º
                    if(Object.values(scheduleData.periods).every(p => p.every(c => c === ''))) {
                        console.error(`[å¯«å…¥è­¦å‘Š] æ•™å¸« "${name}" çš„èª²è¡¨è³‡æ–™æ˜¯ç©ºçš„ï¼é€™ä»£è¡¨è§£æå¯èƒ½æœ‰å•é¡Œã€‚é›–ç„¶æ–‡ä»¶æœƒè¢«å»ºç«‹ï¼Œä½†å…§å®¹æœƒæ˜¯ç©ºçš„ã€‚`);
                    }
                    // --- åµéŒ¯çµæŸ ---
                    const docRef = schoolRef.collection('timetables').doc(name);
                    batch.set(docRef, scheduleData);
                }

                await batch.commit();
                alert(`ğŸ‰ æˆåŠŸï¼å·²æ›´æ–° ${teacherCount} ä½è€å¸«çš„èª²è¡¨ã€‚`);

            } catch (error) {
                console.error(error);
                alert('âŒ ä¸Šå‚³å¤±æ•—ï¼š\n' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "ä¸Šå‚³æ•™å¸«èª²è¡¨";
            }
        }


        document.getElementById('upload-periods-btn').addEventListener('click', uploadPeriods);
        document.getElementById('upload-roster-btn').addEventListener('click', uploadRoster);
        document.getElementById('upload-timetable-btn').addEventListener('click', uploadTimetable);
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
        
        document.getElementById('reset-semester-btn').addEventListener('click', async () => { 
             const btn = document.getElementById('reset-semester-btn');
             
             const firstConfirm = confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æœƒåˆªé™¤ã€Œæœ¬æ ¡ã€æ‰€æœ‰è€å¸«çš„ï¼š\n1. æˆç¸¾ç´€éŒ„\n2. æ—¥å¸¸è¡¨ç¾ç´€éŒ„\n3. æˆç¸¾è¨ˆç®—è¦å‰‡\n4. æ‰€æœ‰èª¿ä»£èª²ç´€éŒ„\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ');
             if (!firstConfirm) return;
             
             const secondConfirm = prompt('ã€æœ€å¾Œç¢ºèªã€‘\n\næ‚¨å³å°‡æ°¸ä¹…æ¸…ç©ºæœ¬å­¸æœŸçš„æ‰€æœ‰å‹•æ…‹è³‡æ–™ã€‚\n\nè«‹è¼¸å…¥ "RESET" (å…¨å¤§å¯«) ä»¥ç¢ºèªåŸ·è¡Œï¼š');
             if (secondConfirm !== "RESET") {
                 alert("è¼¸å…¥éŒ¯èª¤ï¼Œæ“ä½œå·²å–æ¶ˆã€‚");
                 return;
             }

             btn.disabled = true;
             btn.textContent = "æ­£åœ¨åˆªé™¤...";
             logDiv.innerHTML = ''; 
             logDiv.style.display = 'block';

             try {
                logMsg("æ­¥é©Ÿ 1/5: å–å¾—æœ¬æ ¡æ•™å¸«åå–®...");
                
                const usersSnapshot = await db.collection('users')
                    .where('schoolId', '==', schoolId)
                    .where('role', '==', 'teacher')
                    .get();

                if (usersSnapshot.empty) {
                    logMsg("è­¦å‘Šï¼šæ‰¾ä¸åˆ°æœ¬æ ¡æ•™å¸«è³‡æ–™ï¼Œå°‡åƒ…æ¸…é™¤å…¨åŸŸè³‡æ–™ã€‚");
                }

                const teachers = usersSnapshot.docs.map(doc => doc.id);
                if (teachers.length > 0) {
                    logMsg(`æ‰¾åˆ° ${teachers.length} ä½æ•™å¸«ï¼Œæº–å‚™åˆªé™¤å€‹äººè³‡æ–™...`);
                }

                let batch = db.batch();
                let operationCount = 0;
                let totalDeleted = 0;

                const commitBatch = async () => {
                    if (operationCount > 0) {
                        await batch.commit();
                        totalDeleted += operationCount;
                        logMsg(`å·²åˆªé™¤ ${totalDeleted} ç­†è³‡æ–™...`);
                        batch = db.batch();
                        operationCount = 0;
                    }
                };

                logMsg("æ­¥é©Ÿ 2/5: åˆªé™¤æˆç¸¾ç´€éŒ„...");
                for (const uid of teachers) {
                    const snapshot = await db.collection('gradebooks').doc(uid).collection('assignments').get();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                        operationCount++;
                        if (operationCount >= 400) commitBatch();
                    });
                }
                await commitBatch();

                logMsg("æ­¥é©Ÿ 3/5: åˆªé™¤è¡¨ç¾ç´€éŒ„...");
                for (const uid of teachers) {
                    const snapshot = await db.collection('performanceRecords').doc(uid).collection('records').get();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                        operationCount++;
                        if (operationCount >= 400) commitBatch();
                    });
                }
                await commitBatch();

                logMsg("æ­¥é©Ÿ 4/5: åˆªé™¤è¨ˆç®—è¦å‰‡...");
                for (const uid of teachers) {
                    const snapshot = await db.collection('calculationRules').where('teacherId', '==', uid).get();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                        operationCount++;
                        if (operationCount >= 400) commitBatch();
                    });
                }
                await commitBatch();
                
                // --- ğŸŸ¢ æ–°å¢æ­¥é©Ÿï¼šåˆªé™¤ classChanges ---
                logMsg("æ­¥é©Ÿ 5/5: åˆªé™¤èª¿ä»£èª²ç´€éŒ„...");
                // classChanges é›†åˆæ²’æœ‰ schoolId, ä½†å¯ä»¥é€é involvedTeacherIds ä¾†ç¯©é¸
                // ç‚ºäº†ç°¡å–®é«˜æ•ˆï¼Œé€™è£¡å‡è¨­å­¸æœŸé‡è¨­æ™‚ï¼Œæ¸…ç©ºæ‰€æœ‰ classChanges æ˜¯å¯æ¥å—çš„
                const changesSnapshot = await db.collection('classChanges').get();
                if (changesSnapshot.empty) {
                    logMsg("æ²’æœ‰æ‰¾åˆ°èª¿ä»£èª²ç´€éŒ„ï¼Œè·³éæ­¤æ­¥é©Ÿã€‚");
                } else {
                    changesSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                        operationCount++;
                        if (operationCount >= 400) commitBatch();
                    });
                    await commitBatch();
                }
                // --- ğŸŸ¢ æ–°å¢çµæŸ ---

                logMsg("âœ… å­¸æœŸé‡è¨­å®Œæˆï¼");
                alert(`å­¸æœŸé‡è¨­æˆåŠŸï¼å…±åˆªé™¤ ${totalDeleted} ç­†ç›¸é—œè³‡æ–™ã€‚`);

             } catch(error) {
                console.error("åŸ·è¡Œå­¸æœŸé‡è¨­å¤±æ•—:", error);
                logMsg(`âŒ å¤±æ•—ï¼š${error.message}`);
                alert("é‡è¨­å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–ç¶²è·¯ã€‚");
             } finally {
                btn.disabled = false;
                btn.textContent = "åŸ·è¡Œå­¸æœŸé‡è¨­";
             }
        });

		
        const logDiv = document.getElementById('progress-log');
        function logMsg(msg) {
            logDiv.style.display = 'block';
            logDiv.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // ------------------------------------------------
        // 1. å‚™ä»½åŠŸèƒ½ (Backup)
        // ------------------------------------------------
        document.getElementById('backup-teachers-btn').addEventListener('click', async () => {
            const btn = document.getElementById('backup-teachers-btn');
            btn.disabled = true;
            logDiv.innerHTML = ''; // æ¸…ç©º Log
            
            try {
                logMsg("é–‹å§‹æƒææœ¬æ ¡æ•™å¸«åå–®...");
                
                // 1. æ‰¾å‡ºè©²å­¸æ ¡çš„æ‰€æœ‰è€å¸« ID
                const usersSnapshot = await db.collection('users')
                    .where('schoolId', '==', schoolId)
                    .where('role', '==', 'teacher')
                    .get();

                if (usersSnapshot.empty) {
                    throw new Error("æ‰¾ä¸åˆ°æœ¬æ ¡çš„ä»»ä½•æ•™å¸«å¸³è™Ÿã€‚");
                }

                const teachers = [];
                usersSnapshot.forEach(doc => teachers.push({ uid: doc.id, ...doc.data() }));
                logMsg(`å…±æ‰¾åˆ° ${teachers.length} ä½æ•™å¸«ã€‚é–‹å§‹ä¸‹è¼‰è³‡æ–™...`);

                const backupData = {
                    metadata: {
                        type: "teacher_records_backup",
                        schoolId: schoolId,
                        timestamp: new Date().toISOString(),
                        teacherCount: teachers.length
                    },
                    records: {} // çµæ§‹: { teacherUid: { gradebooks: [], performance: [] } }
                };

                // 2. é€ä¸€æŠ“å–æ¯ä½è€å¸«çš„è³‡æ–™
                for (const teacher of teachers) {
                    const uid = teacher.uid;
                    const teacherName = teacher.displayName || teacher.email;
                    logMsg(`æ­£åœ¨è®€å–ï¼š${teacherName}...`);

                    backupData.records[uid] = {
                        gradebooks: [],
                        performance: []
                    };

                    // A. æŠ“å–æˆç¸¾ (Gradebooks)
                    const gradesSnap = await db.collection('gradebooks').doc(uid).collection('assignments').get();
                    gradesSnap.forEach(doc => {
                        backupData.records[uid].gradebooks.push({ id: doc.id, data: doc.data() });
                    });

                    // B. æŠ“å–è¡¨ç¾ç´€éŒ„ (Performance Records)
                    const perfSnap = await db.collection('performanceRecords').doc(uid).collection('records').get();
                    perfSnap.forEach(doc => {
                        backupData.records[uid].performance.push({ id: doc.id, data: doc.data() });
                    });
                }

                logMsg("è³‡æ–™è®€å–å®Œæˆï¼Œæ­£åœ¨ç”¢ç”Ÿæª”æ¡ˆ...");

                // 3. è§¸ç™¼ä¸‹è¼‰
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const downloadLink = document.createElement('a');
                
                const dateStr = new Date().toISOString().slice(0,10).replace(/-/g, "");
                downloadLink.href = url;
                downloadLink.download = `Full_Records_Backup_${schoolId}_${dateStr}.json`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                logMsg("âœ… ä¸‹è¼‰å®Œæˆï¼");
                alert('å…¨æ ¡ç´€éŒ„å‚™ä»½ä¸‹è¼‰å®Œæˆï¼');

            } catch (error) {
                console.error(error);
                logMsg(`âŒ éŒ¯èª¤ï¼š${error.message}`);
                alert("å‚™ä»½å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ä¸‹æ–¹æ—¥èªŒã€‚");
            } finally {
                btn.disabled = false;
            }
        });

        // ------------------------------------------------
        // 2. åŒ¯å…¥åŠŸèƒ½ (Import / Merge)
        // ------------------------------------------------
        const importInput = document.getElementById('import-teachers-input');
        const importBtn = document.getElementById('import-teachers-btn');

        importInput.addEventListener('change', () => {
            importBtn.disabled = !importInput.files.length;
            if (importInput.files.length) {
                importBtn.style.backgroundColor = '#28a745';
            } else {
                importBtn.style.backgroundColor = '#6c757d';
            }
        });

        importBtn.addEventListener('click', async () => {
            const file = importInput.files[0];
            if (!file) return;

            if (!confirm("ç¢ºå®šè¦åŒ¯å…¥é€™ä»½è³‡æ–™å—ï¼Ÿ\n\nç³»çµ±å°‡æœƒã€Œåˆä½µã€è³‡æ–™ (å·²å­˜åœ¨çš„ ID æœƒæ›´æ–°ï¼Œä¸å­˜åœ¨çš„æœƒæ–°å¢)ï¼Œç¾æœ‰è³‡æ–™ä¸æœƒè¢«æ¸…ç©ºã€‚")) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                importBtn.disabled = true;
                logDiv.innerHTML = '';
                logMsg("æ­£åœ¨è§£æå‚™ä»½æª”æ¡ˆ...");

                try {
                    const jsonContent = JSON.parse(e.target.result);

                    if (jsonContent.metadata?.schoolId !== schoolId) {
                        if (!confirm(`âš ï¸ è­¦å‘Šï¼šé€™ä»½å‚™ä»½æª”æ¡ˆçš„å­¸æ ¡ ID (${jsonContent.metadata?.schoolId}) èˆ‡ç›®å‰å­¸æ ¡ (${schoolId}) ä¸ç¬¦ã€‚\n\nç¢ºå®šè¦ç¹¼çºŒåŒ¯å…¥å—ï¼Ÿ`)) {
                            throw new Error("ä½¿ç”¨è€…å–æ¶ˆåŒ¯å…¥ã€‚");
                        }
                    }

                    const recordsMap = jsonContent.records;
                    if (!recordsMap) throw new Error("æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° records å€å¡Šã€‚");

                    logMsg("é–‹å§‹å¯«å…¥è³‡æ–™åº« (é€™å¯èƒ½éœ€è¦ä¸€é»æ™‚é–“)...");

                    // æº–å‚™ Batch (Firestore é™åˆ¶æ¯æ‰¹æ¬¡æœ€å¤š 500 ç­†æ“ä½œ)
                    let batch = db.batch();
                    let operationCount = 0;
                    let totalImported = 0;

                    const commitBatch = async () => {
                        if (operationCount > 0) {
                            await batch.commit();
                            totalImported += operationCount;
                            logMsg(`å·²å¯«å…¥ ${totalImported} ç­†è³‡æ–™...`);
                            batch = db.batch(); // é‡ç½® batch
                            operationCount = 0;
                        }
                    };

                    for (const [teacherUid, data] of Object.entries(recordsMap)) {
                        
                        // 1. åŒ¯å…¥æˆç¸¾ (Gradebooks)
                        if (data.gradebooks && data.gradebooks.length > 0) {
                            for (const item of data.gradebooks) {
                                const ref = db.collection('gradebooks').doc(teacherUid).collection('assignments').doc(item.id);
                                batch.set(ref, item.data, { merge: true }); // ä½¿ç”¨ merge: true é¿å…è¦†è“‹æœªå‚™ä»½çš„æ¬„ä½
                                operationCount++;
                                if (operationCount >= 450) await commitBatch(); // ç•™ä¸€é»ç·©è¡ï¼Œåˆ° 450 å°±æäº¤
                            }
                        }

                        // 2. åŒ¯å…¥è¡¨ç¾ç´€éŒ„ (Performance Records)
                        if (data.performance && data.performance.length > 0) {
                            for (const item of data.performance) {
                                // ä¿®æ­£ Timestamp (JSON è½‰å›ä¾†æœƒè®Šæˆå­—ä¸²æˆ–ç‰©ä»¶ï¼Œéœ€è½‰å› Firestore Timestamp)
                                if (item.data.timestamp && item.data.timestamp.seconds) {
                                    item.data.timestamp = new firebase.firestore.Timestamp(item.data.timestamp.seconds, item.data.timestamp.nanoseconds);
                                } else if (typeof item.data.timestamp === 'string') {
                                    item.data.timestamp = firebase.firestore.Timestamp.fromDate(new Date(item.data.timestamp));
                                }

                                const ref = db.collection('performanceRecords').doc(teacherUid).collection('records').doc(item.id);
                                batch.set(ref, item.data, { merge: true });
                                operationCount++;
                                if (operationCount >= 450) await commitBatch();
                            }
                        }
                    }

                    // æäº¤å‰©ä¸‹çš„
                    await commitBatch();

                    logMsg("âœ… åŒ¯å…¥æˆåŠŸï¼æ‰€æœ‰è³‡æ–™å·²åˆä½µã€‚");
                    alert("åŒ¯å…¥å®Œæˆï¼");
                    
                    importInput.value = '';
                    importBtn.disabled = true;
                    importBtn.style.backgroundColor = '#6c757d';

                } catch (error) {
                    console.error(error);
                    logMsg(`âŒ åŒ¯å…¥å¤±æ•—ï¼š${error.message}`);
                    alert("åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ—¥èªŒã€‚");
                    importBtn.disabled = false;
                }
            };
            reader.readAsText(file);
        });		
    </script>
</body>
</html>