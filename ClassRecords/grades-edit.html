<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç¸¾ç™»éŒ„æˆ–ç·¨è¼¯ - ç­ç´šç¶œåˆæˆç¸¾ç´€éŒ„ç³»çµ±</title>
    <style>
        :root { --primary-color: #4a90e2; --secondary-color: #f5f5ff; --font-color: #333; --border-color: #ddd; --success-color: #28a745; --cancel-color: #777; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif; margin: 0; background-color: var(--secondary-color); color: var(--font-color); }
        button, input, select, textarea {
            font-family: inherit;
        }
		header { 
            background-color: var(--primary-color); color: white; padding: 0.6rem 1rem; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; 
            justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; 
        }
        header h1 { font-size: 1.6em; margin: 0; }
        header button { background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px;}
        header button:hover { background-color: rgba(255, 255, 255, 0.2); }

        main { padding: 1rem; max-width: 1000px; margin: auto; }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: bold; }
        .form-group input[type="text"], .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        #grades-table-container {
            overflow-x: auto;
            margin-top: 1.5rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #grades-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }
        #grades-table th, #grades-table td {
            padding: 0.6rem 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        #grades-table th {
            background-color: #e9ecef;
            color: var(--font-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #grades-table tr:hover {
            background-color: #f8f9fa;
        }
        .score-input {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 3px;
        }

        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }
        .actions button {
            padding: 0.7rem 1.5rem;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #save-grades-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        #save-grades-btn:hover:not(:disabled) {
            background-color: #3a82d0;
        }
        #back-btn {
            background-color: var(--cancel-color);
            color: white;
            border: none;
        }
        #back-btn:hover:not(:disabled) {
            background-color: #666;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="assignment-edit-header">æˆç¸¾ç™»éŒ„æˆ–ç·¨è¼¯</h1>
        <div>
            <button id="back-btn">è¿”å›åˆ—è¡¨</button>
            <button id="logout-btn">ç™»å‡º</button>
        </div>
    </header>

    <div id="loading-screen" style="display: none;">
        è¼‰å…¥ä¸­...
    </div>

    <main id="app-container" style="display: none;">
        <form id="grades-form">
            <div class="form-group">
                <label for="assignment-name">æˆç¸¾é …ç›®åç¨±</label>
                <input type="text" id="assignment-name" required placeholder="ä¾‹å¦‚ï¼šæœŸä¸­æ¸¬é©—">
            </div>
            
            <div class="form-group">
                <label for="general-comment">é …ç›®å‚™è¨» (é¸å¡«)</label>
                <textarea id="general-comment" rows="2" placeholder="ä¾‹å¦‚ï¼šæœ¬æ¬¡æ¸¬é©—ç¯„åœåŒ…å«..."></textarea>
            </div>
            
            <div id="grades-table-container">
                <table id="grades-table">
                    <thead>
                        <tr>
                            <th>åº§è™Ÿ/ç­ç´š</th>
                            <th>å­¸è™Ÿå¾Œä¸‰ç¢¼</th>
                            <th>å­¸ç”Ÿå§“å</th>
                            <th>åˆ†æ•¸</th>
                        </tr>
                    </thead>
                    <tbody id="grades-table-body">
                        </tbody>
                </table>
            </div>
            
            <div class="actions">
                <button type="submit" id="save-grades-btn">æ›´æ–°å„²å­˜</button>
            </div>
        </form>
    </main>

	<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
	  const firebaseConfig = {
		apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
		authDomain: "classrecords-13902.firebaseapp.com",
		projectId: "classrecords-13902",
		storageBucket: "classrecords-13902.firebasestorage.app",
		messagingSenderId: "431747377367",
		appId: "1:431747377367:web:b157a8f5c59ce38091e892",
		measurementId: "G-JWTQGM9XMP"
	  };

        // åˆå§‹åŒ– Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // å…¨åŸŸè®Šæ•¸
        let currentUser = null, classId = null, assignmentId = null;

        // ğŸŒŸ ä¿®æ­£é» 1: å…¨åŸŸè®Šæ•¸å®šç¾©åŠå¿«å–éµ ğŸŒŸ
        const COMMON_ROSTER_DATA = 'COMMON_ROSTER_DATA';
        const GRADEBOOK_ASSIGNMENTS = 'GRADEBOOK_ASSIGNMENTS';
        // ğŸŒŸ çµæŸä¿®æ­£ ğŸŒŸ

        const appContainer = document.getElementById('app-container');
        const loadingScreen = document.getElementById('loading-screen');
        const gradesTableBody = document.getElementById('grades-table-body');
        const gradesForm = document.getElementById('grades-form');
        const saveGradesBtn = document.getElementById('save-grades-btn');
        const assignmentEditHeader = document.getElementById('assignment-edit-header');
        
        // ----------------------------------------------------
        // è¼”åŠ©å‡½æ•¸
        // ----------------------------------------------------

        function navigateBackToList() {
            window.location.href = `grades.html?class=${classId}`;
        }
        
        function renderGradesTable(students, existingScores) {
            gradesTableBody.innerHTML = '';
            // ä¿®æ­£ï¼šä½¿ç”¨å­¸ç”Ÿ ID çš„å¾Œä¸‰ç¢¼é€²è¡Œæ’åº
            students.sort((a, b) => parseInt(a.id.substring(3)) - parseInt(b.id.substring(3))); 

            students.forEach(student => {
                const tr = document.createElement('tr');
                const studentSeatNum = student.id ? student.id.substring(3) : 'N/A';
                const studentIdLastThree = student.id ? student.id.substring(student.id.length - 3) : 'N/A';
                const score = existingScores[student.id] ? (existingScores[student.id].score || '') : '';
                
                tr.innerHTML = `
                    <td>${studentSeatNum}</td>
                    <td>${studentIdLastThree}</td>
                    <td>${student.name}</td>
                    <td>
                        <input type="number" step="0.1" min="0" max="100" class="score-input" data-student-id="${student.id}" value="${score}" placeholder="åˆ†æ•¸">
                    </td>
                `;
                gradesTableBody.appendChild(tr);
            });
        }
        
		async function initializeGradesEditPage(userData) {
			const urlParams = new URLSearchParams(window.location.search);
			classId = urlParams.get('class');
			assignmentId = urlParams.get('id');
			const assignmentNameFromURL = urlParams.get('name');
			const generalCommentFromURL = urlParams.get('comment');

			if (!classId) {
				alert('éŒ¯èª¤ï¼šæœªæŒ‡å®šç­ç´šã€‚');
				return;
			}
			
			const assignmentEditHeader = document.getElementById('assignment-edit-header');
			if (assignmentId) {
				assignmentEditHeader.textContent = `${classId} ç­ æˆç¸¾ç·¨è¼¯ï¼š${assignmentNameFromURL || 'è®€å–ä¸­...'}`;
			} else {
				assignmentEditHeader.textContent = `${classId} ç­ å»ºç«‹æ–°æˆç¸¾é …ç›®`;
			}

			if (!userData.schoolId) {
				alert('éŒ¯èª¤ï¼šæ‚¨çš„å¸³è™Ÿæœªç¶å®šå­¸æ ¡IDï¼Œç„¡æ³•è®€å–åå†Šã€‚');
				return;
			}

            let allStudents = [];
            let studentsInClass = [];
            let useRosterCache = false;

            // ğŸŒŸ é–‹å§‹ä¿®æ­£ï¼šæ›´è©³ç´°åœ°è¨˜éŒ„åå†Šå¿«å–ç‹€æ…‹ ğŸŒŸ
            try {
                const cachedRoster = sessionStorage.getItem(COMMON_ROSTER_DATA);
                if (cachedRoster) {
                    allStudents = JSON.parse(cachedRoster).students || [];
                    
                    if (allStudents) { 
                        useRosterCache = true;
                        if (allStudents.length > 0) {
                            console.log('ã€å¿«å–å‘½ä¸­ã€‘åå†Šï¼šè®€å– Session å¿«å–çš„åå†Šï¼Œå…±æ‰¾åˆ° ' + allStudents.length + ' ç­†å­¸ç”Ÿè³‡æ–™ã€‚');
                        } else {
                            console.warn('ã€å¿«å–å‘½ä¸­ã€‘åå†Šï¼šSession å¿«å–è¢«è®€å–ï¼Œä½†å­¸ç”Ÿè³‡æ–™ç‚ºç©ºã€‚å°‡å¾ Firestore å†æ¬¡å˜—è©¦ã€‚');
                            useRosterCache = false; 
                        }
                    }
                }
            } catch (e) {
                console.error('ã€å¿«å–éŒ¯èª¤ã€‘Session å¿«å–è§£æå¤±æ•—ï¼Œå°‡å¾ Firestore é‡æ–°è®€å–åå†Šã€‚', e);
                sessionStorage.removeItem(COMMON_ROSTER_DATA);
                useRosterCache = false;
            }
            // ğŸŒŸ çµæŸä¿®æ­£ ğŸŒŸ
            
            // å¦‚æœå¿«å–ç„¡æ•ˆï¼Œå‰‡å¾ Firestore è®€å–
            if (!useRosterCache) {
                console.log('åå†Šï¼šå¾ Firestore é€²è¡Œç¡¬è®€å–ã€‚'); // Log ç´€éŒ„ç¡¬è®€å–
                const rosterDoc = await db.collection('schools').doc(userData.schoolId).collection('rosters').doc('current').get();
                if (!rosterDoc.exists) {
                    alert('æ‰¾ä¸åˆ°å­¸æ ¡çš„å­¸ç”Ÿåå†Šï¼Œè«‹è¯ç¹«å­¸æ ¡ç®¡ç†è€…ä¸Šå‚³è³‡æ–™ã€‚');
                    return;
                }
                allStudents = rosterDoc.data().students || [];
                
                // å¯«å…¥ Session å¿«å–
                sessionStorage.setItem(COMMON_ROSTER_DATA, JSON.stringify({ students: allStudents }));
                console.log('åå†Šï¼šå·²å°‡ ' + allStudents.length + ' ç­†è³‡æ–™å¯«å…¥ Session å¿«å–ã€‚'); // Log ç´€éŒ„å¯«å…¥
            }
			
            // é€™è£¡å‡è¨­åå†Šä¸­çš„ student.id æ ¼å¼ç‚º {ç­ç´šä»£ç¢¼}{åº§è™Ÿ}ï¼Œä¾‹å¦‚ "70101"
			studentsInClass = allStudents.filter(s => s.id.startsWith(classId));
			if (studentsInClass.length === 0) {
				alert(`æ‰¾ä¸åˆ° ${classId} ç­çš„å­¸ç”Ÿåå†Šï¼Œè«‹ç¢ºèªç­ç´šä»£ç¢¼æˆ–è¯ç¹«ç®¡ç†å“¡ã€‚`);
				return;
			}
			
			// Fetch existing assignment data if editing
			let existingScores = {};
			if (assignmentId) {
				const assignmentDoc = await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').doc(assignmentId).get();
				if (assignmentDoc.exists) {
					const data = assignmentDoc.data();
					existingScores = data.scores || {};
					
					// Populate form fields
					document.getElementById('assignment-name').value = data.assignmentName || '';
					document.getElementById('general-comment').value = data.generalComment || '';
					
					// Set header content if not set by URL param
					if (!assignmentNameFromURL) {
						 assignmentEditHeader.textContent = `${classId} ç­ æˆç¸¾ç·¨è¼¯ï¼š${data.assignmentName || 'æœªå‘½åé …ç›®'}`;
					}
					
				} else {
					alert('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„æˆç¸¾é …ç›®ã€‚');
					return;
				}
			} else {
				// Populate assignment name and comment from URL if creating new assignment
				document.getElementById('assignment-name').value = assignmentNameFromURL || '';
				document.getElementById('general-comment').value = generalCommentFromURL || '';
			}

			renderGradesTable(studentsInClass, existingScores);
			appContainer.style.display = 'block';
		}

        // ğŸŒŸ ä¿®æ­£é» 3: å„²å­˜å‡½æ•¸ saveGrades (åŒæ­¥æ›´æ–°å¿«å–) ğŸŒŸ
        async function saveGrades(e) {
            e.preventDefault();
            
            saveGradesBtn.disabled = true;
            saveGradesBtn.textContent = 'å„²å­˜ä¸­...';

            const assignmentName = document.getElementById('assignment-name').value.trim();
            const generalComment = document.getElementById('general-comment').value.trim();

            if (!assignmentName) {
                alert('è«‹è¼¸å…¥æˆç¸¾é …ç›®åç¨±ã€‚');
                saveGradesBtn.disabled = false;
                saveGradesBtn.textContent = 'æ›´æ–°å„²å­˜';
                return;
            }

            const scoreInputs = gradesTableBody.querySelectorAll('.score-input');
            const scoresToSave = {};

            let hasValidScore = false;
            scoreInputs.forEach(input => {
                const studentId = input.dataset.studentId;
                const scoreValue = input.value.trim();
                
                if (scoreValue !== '') {
                    const score = parseFloat(scoreValue);
                    if (!isNaN(score) && score >= 0 && score <= 100) {
                        scoresToSave[studentId] = { score: score };
                        hasValidScore = true;
                    } else {
                        scoresToSave[studentId] = { score: null }; // å„²å­˜ç„¡æ•ˆ/ä¸åˆç†çš„åˆ†æ•¸ç‚º null
                    }
                } else {
                    scoresToSave[studentId] = { score: null }; // å„²å­˜ç©ºæ¬„ä½ç‚º null
                }
            });
            
            if (!hasValidScore) {
                const confirmEmpty = confirm('æ‚¨å°šæœªè¼¸å…¥ä»»ä½•æœ‰æ•ˆæˆç¸¾ã€‚ç¢ºå®šè¦å„²å­˜é€™å€‹ç©ºçš„æˆç¸¾é …ç›®å—ï¼Ÿ');
                if (!confirmEmpty) {
                    saveGradesBtn.disabled = false;
                    saveGradesBtn.textContent = 'æ›´æ–°å„²å­˜';
                    return;
                }
            }

            const dataToSave = {
                className: classId,
                assignmentName: assignmentName,
                generalComment: generalComment,
                scores: scoresToSave,
                // ä½¿ç”¨ Firestore ä¼ºæœå™¨æ™‚é–“æˆ³ï¼Œç¢ºä¿æ™‚é–“ä¸€è‡´æ€§
                date: firebase.firestore.FieldValue.serverTimestamp() 
            };

            try {
                let isUpdate = !!assignmentId;
                let finalDocId = assignmentId;
                
                if (assignmentId) {
                    // UPDATE
                    await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').doc(assignmentId).update(dataToSave);
                    alert('æˆç¸¾å·²æˆåŠŸæ›´æ–°ï¼');
                } else {
                    // CREATE
                    const newDocRef = await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').add(dataToSave);
                    finalDocId = newDocRef.id; // å–å¾—æ–°çš„æ–‡ä»¶ ID
                    assignmentId = finalDocId; // æ›´æ–°å…¨åŸŸè®Šæ•¸ä»¥ä¾¿å¾ŒçºŒç·¨è¼¯
                    assignmentEditHeader.textContent = `${classId} ç­ æˆç¸¾ç·¨è¼¯ï¼š${assignmentName}`;
                    alert('æ–°æˆç¸¾é …ç›®å·²æˆåŠŸå»ºç«‹ï¼');
                }
                
                // ğŸŒŸ é–‹å§‹ä¿®æ”¹ï¼šæ›´æ–° Session å¿«å– (GRADEBOOK_ASSIGNMENTS) ğŸŒŸ
                let allAssignments = [];
                try {
                    // 1. è®€å–ç¾æœ‰å¿«å–
                    allAssignments = JSON.parse(sessionStorage.getItem(GRADEBOOK_ASSIGNMENTS) || '[]');
                } catch (e) {
                    console.error("è§£ææˆç¸¾é …ç›®å¿«å–å¤±æ•—ï¼Œå°‡è·³éå¿«å–æ›´æ–°ã€‚", e);
                }

                // 2. å»ºç«‹ç”¨æ–¼å¿«å–çš„æ–°æ•¸æ“šç‰©ä»¶ã€‚æ³¨æ„ï¼šä½¿ç”¨æœ¬åœ°æ™‚é–“å­—ä¸²ä»£æ›¿ serverTimestamp()
                const newAssignmentData = {
                    id: finalDocId, 
                    ...dataToSave,
                    // å°‡ Date ç‰©ä»¶åºåˆ—åŒ–ç‚º ISO stringï¼Œgrades.html ä¸­çš„ loadHistory å·²è™•ç†æ­¤æ ¼å¼
                    date: new Date().toISOString() 
                };

                if (isUpdate) {
                    // 3a. æ›´æ–°ï¼šæ›¿æ›èˆŠé …ç›®
                    const index = allAssignments.findIndex(a => a.id === finalDocId);
                    if (index !== -1) {
                        allAssignments[index] = newAssignmentData;
                    } else {
                        allAssignments.unshift(newAssignmentData); // å¾Œå‚™
                    }
                } else {
                    // 3b. æ–°å¢ï¼šé …ç›®åˆ°åˆ—è¡¨é ‚éƒ¨ (å› ç‚º grades.html æ˜¯é™åºæ’åº)
                    allAssignments.unshift(newAssignmentData);
                }
                
                // 4. å¯«å› Session å¿«å–
                sessionStorage.setItem(GRADEBOOK_ASSIGNMENTS, JSON.stringify(allAssignments));
                
                console.log(`æˆç¸¾é …ç›®å¿«å–å·²æ›´æ–°ã€‚é …ç›® ID: ${finalDocId}`);
                // ğŸŒŸ çµæŸä¿®æ”¹ï¼šæ›´æ–° Session å¿«å– ğŸŒŸ

                navigateBackToList();

            } catch (error) {
                console.error("å„²å­˜æˆç¸¾å¤±æ•—:", error);
                alert("å„²å­˜æˆç¸¾å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«æŠ€è¡“æ”¯æ´ã€‚");
            } finally {
                saveGradesBtn.disabled = false;
                saveGradesBtn.textContent = 'æ›´æ–°å„²å­˜';
            }
        }
        // ğŸŒŸ çµæŸä¿®æ­£ ğŸŒŸ


        // ----------------------------------------------------
        // äº‹ä»¶ç›£è½èˆ‡åˆå§‹åŒ–
        // ----------------------------------------------------

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadingScreen.style.display = 'flex';
                db.collection('users').doc(user.uid).get().then(doc => {
                    const userData = doc.data() || {};
                    if (userData.role === 'teacher') {
                        // é€™è£¡å¯ä»¥åŠ å…¥ä¸€å€‹ console.log ä¾†ç¢ºèªåˆå§‹åŒ–é–‹å§‹åŸ·è¡Œ
                        console.log('grades-edit.html: èªè­‰æˆåŠŸï¼Œé–‹å§‹åˆå§‹åŒ–é é¢ã€‚');
                        initializeGradesEditPage(userData);
                    } else {
                        alert('æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢ã€‚');
                        window.location.href = 'login.html';
                    }
                }).catch(e => {
                    console.error("Error fetching user data:", e);
                    alert("è¼‰å…¥ç”¨æˆ¶æ•¸æ“šå¤±æ•—ã€‚");
                    window.location.href = 'login.html';
                }).finally(() => {
                    loadingScreen.style.display = 'none';
                });
            } else {
                window.location.href = 'login.html';
            }
        });

        gradesForm.addEventListener('submit', saveGrades);
        
        document.getElementById('back-btn').addEventListener('click', () => { navigateBackToList(); });
        
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut().then(() => { window.location.href = 'login.html'; }); });
    </script>
</body>
</html>
