<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成績登錄或編輯 - 班級綜合成績紀錄系統</title>
    <style>
        :root { --primary-color: #4a90e2; --secondary-color: #f5f5ff; --font-color: #333; --border-color: #ddd; --success-color: #28a745; --cancel-color: #777; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif; margin: 0; background-color: var(--secondary-color); color: var(--font-color); }
        button, input, select, textarea {
            font-family: inherit;
        }
		header { background-color: var(--primary-color); color: white; padding: 0.6rem 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        header h1 { font-size: 1.6em; margin: 0; }
        header button { background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 1em; }
        main { padding: 20px; max-width: 1000px; margin: auto; padding-bottom: 80px; }
        .section { background-color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h2, h3 { color: #333; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-top: 0;}
        input, textarea { padding: 10px; margin: 5px 0; font-size: 1em; border-radius: 4px; border: 1px solid var(--border-color); box-sizing: border-box; width: 100%; }
        button { background-color: var(--primary-color); color: white; cursor: pointer; border: none; }
        
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px;
        }
        .form-grid label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        /* 學生分數輸入區塊樣式 */
        #student-scores-container {
            display: block; 
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .score-entry-header {
            display: grid;
            grid-template-columns: 80px 1fr 100px 1.5fr; 
            font-weight: bold;
            background-color: #f7f7f7;
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid var(--border-color);
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }
        .score-entry-header > div { 
            text-align: center;
            padding: 0; 
        }

        .score-entry-grid {
            display: grid;
            grid-template-columns: 80px 1fr 100px 1.5fr; 
            align-items: center;
            gap: 10px;
            padding: 5px 10px;
            border-bottom: 1px solid #eee;
        }
        .score-entry-grid:last-child { 
            border-bottom: none; 
        }
        
        .score-entry-grid input {
            margin: 0;
            padding: 8px;
            width: 100%;
            text-align: center;
        }

        .student-id-cell { text-align: center; font-size: 0.9em; color: #555; }
        .student-name-cell { 
            text-align: center; /* 修正：將姓名置中 */
            font-weight: 500; 
        }
        
        /* 浮動按鈕樣式 */
        .float-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0; /* 修正：確保按鈕容器不會被擠壓到 */
            width: 100%;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px 20px;
            box-sizing: border-box; /* 修正：確保 padding 不會導致總寬度超過 100% */
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            z-index: 1000;
        }
        .float-actions button {
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 6px;
            min-width: 100px; 
            white-space: nowrap; 
        }
        #save-grades-btn { background-color: var(--success-color); }
        #cancel-edit-btn { background-color: var(--cancel-color); }

        /* RWD 調整 */
        @media (max-width: 768px) {
            main { padding: 10px; padding-bottom: 70px; }
            .section { padding: 10px; margin-bottom: 15px; }
            .form-grid { grid-template-columns: 1fr; gap: 15px; } 

            .score-entry-header {
                display: none;
            }
            
            #student-scores-container {
                border: none;
                padding: 0;
            }

            .score-entry-grid {
                display: flex;
                flex-wrap: wrap;
                align-items: flex-start;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                margin-bottom: 8px;
            }
            
            .student-id-cell, .student-name-cell {
                flex: 0 0 100%; 
                text-align: left;
                padding: 0;
                margin-bottom: 5px;
                /* 修正：小螢幕下姓名靠左 */
                text-align: left !important;
            }
            .student-id-cell {
                font-size: 0.85em;
            }

            .score-input-cell, .comment-input-cell {
                flex: 0 0 49%; 
                display: flex;
                flex-direction: column;
                gap: 2px;
                padding: 0;
            }
            
            .score-input-cell input, .comment-input-cell input {
                order: 2; 
                padding: 6px;
            }

            .score-input-cell::before, .comment-input-cell::before {
                content: attr(data-label);
                order: 1; 
                font-size: 0.75em;
                color: #555;
                font-weight: bold;
                margin-top: 5px;
            }
            
            .float-actions {
                padding: 8px 15px; 
            }
            .float-actions button {
                padding: 10px 20px;
                font-size: 1.0em;
                min-width: 80px; 
            }
        }
    </style>
</head>
<body>
	<header>
        <h1 id="header-title">成績登錄/編輯</h1>
        <div class="header-actions">
            <span id="user-email"></span>
            <button id="back-to-list-btn">返回清單</button>
            <button id="logout-btn">登出</button>
        </div>
    </header>
    <main id="app-container" style="display: none;">
        
        <div class="section">
            <h2 id="assignment-edit-header"></h2>
            
            <div class="form-grid">
				<div>
					<label for="edit-assignment-name">成績項目名稱：</label>
					<input type="text" id="edit-assignment-name" required>
				</div>
				<div>
					<label for="edit-general-comment">成績說明 (選填)：</label>
					<input type="text" id="edit-general-comment" placeholder="例如: 遲交">
				</div>
			</div>
        </div>
        
		<div id="grade-entry-section" class="section">
            <h3>學生分數登錄</h3>
            <div id="student-scores-container">
                <div class="score-entry-header">
                    <div>座號</div>
                    <div>姓名</div>
                    <div>分數</div>
                    <div>備註</div>
                </div>
                
</div>
		</div>
    </main>

    <div class="float-actions" id="float-actions-bar">
        <button id="cancel-edit-btn">取消</button>
        <button id="save-grades-btn">更新儲存</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
	  const firebaseConfig = {
		apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
		authDomain: "classrecords-13902.firebaseapp.com",
		projectId: "classrecords-13902",
		storageBucket: "classrecords-13902.firebasestorage.app",
		messagingSenderId: "431747377367",
		appId: "1:431747377367:web:b157a8f5c59ce38091e892",
		measurementId: "G-JWTQGM9XMP"
	  };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();
        let currentUser = null; 
        let classId = null;
        let assignmentId = null; 
        let studentsInClass = []; 
        let currentGradesData = {}; 

        const appContainer = document.getElementById('app-container');
        const assignmentEditHeader = document.getElementById('assignment-edit-header');
        const editAssignmentNameInput = document.getElementById('edit-assignment-name');
        const editGeneralCommentInput = document.getElementById('edit-general-comment');
        const studentScoresContainer = document.getElementById('student-scores-container');
        const saveGradesBtn = document.getElementById('save-grades-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const backToListBtn = document.getElementById('back-to-list-btn'); // 取得新的返回按鈕

        // 修正：設置返回清單按鈕的導航邏輯
        function navigateBackToList() {
            if (classId) {
                window.location.href = `grades.html?class=${classId}`;
            } else {
                window.location.href = `grades.html`;
            }
        }

        backToListBtn.addEventListener('click', navigateBackToList);
        cancelEditBtn.addEventListener('click', () => {
            if (confirm('確定要取消編輯並返回清單嗎？所有未儲存的變更將會遺失。')) {
                navigateBackToList();
            }
        });
        
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().role === 'teacher') {
                    const displayElement = document.getElementById('user-email');
                    const userData = userDoc.data();
                    if (userData.displayName) {
                        displayElement.textContent = userData.displayName;
                    } else {
                        displayElement.textContent = user.email;
                    }
                    await initializeEditPage(userData);
                } else {
                    alert('權限不足或帳號設定錯誤。');
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

		async function initializeEditPage(userData) {
			const urlParams = new URLSearchParams(window.location.search);
			classId = urlParams.get('class');
            assignmentId = urlParams.get('assignmentId');
            const assignmentName = decodeURIComponent(urlParams.get('assignmentName') || '');
            const assignmentComment = decodeURIComponent(urlParams.get('assignmentComment') || '');

			if (!classId) {
				// 如果未指定班級，導航回主頁或顯示錯誤
                appContainer.innerHTML = '<h2>錯誤：未指定班級，請從主頁重新進入。</h2>';
				appContainer.style.display = 'block';
				backToListBtn.textContent = '返回主頁';
                backToListBtn.onclick = () => window.location.href = 'teacher.html';
				return;
			}
            
            assignmentEditHeader.textContent = assignmentId ? `${classId} 班 成績編輯：${assignmentName}` : `${classId} 班 建立新成績項目`;
            editAssignmentNameInput.value = assignmentName;
            editGeneralCommentInput.value = assignmentComment;
            document.title = assignmentId ? `編輯 ${assignmentName}` : `建立新項目`;


			if (!userData.schoolId) {
				alert('錯誤：您的帳號未綁定學校ID，無法讀取名冊。');
				return;
			}
			
			const rosterDoc = await db.collection('schools').doc(userData.schoolId).collection('rosters').doc('current').get();
			if (!rosterDoc.exists) {
				alert('找不到學校的學生名冊，請聯繫學校管理者上傳資料。');
				return;
			}
            
            studentsInClass = (rosterDoc.data().students || [])
                                .filter(s => s.id.startsWith(classId))
                                .sort((a, b) => parseInt(a.id.substring(3)) - parseInt(b.id.substring(3)));

            if (assignmentId) {
                const assignmentDoc = await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').doc(assignmentId).get();
                if (assignmentDoc.exists) {
                    currentGradesData = assignmentDoc.data().scores || {};
                } else {
                    alert('找不到此成績項目，將以新增模式載入。');
                    assignmentId = null;
                }
            }
            
            renderStudentScores();
			appContainer.style.display = 'block';
		}
        
        function renderStudentScores() {
            const existingHeader = studentScoresContainer.querySelector('.score-entry-header');
            studentScoresContainer.innerHTML = '';
            if (existingHeader) {
                studentScoresContainer.appendChild(existingHeader);
            } else {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'score-entry-header';
                headerDiv.innerHTML = `<div>座號</div><div>姓名</div><div>分數</div><div>備註</div>`;
                studentScoresContainer.appendChild(headerDiv);
            }

            studentsInClass.forEach(student => {
                const studentId = student.id;
                const studentSeat = studentId.substring(3);
                const existingScore = currentGradesData[studentId] ? currentGradesData[studentId].score : '';
                const existingComment = currentGradesData[studentId] ? currentGradesData[studentId].comment : '';

                const studentDiv = document.createElement('div');
                studentDiv.className = 'score-entry-grid';
                studentDiv.dataset.id = studentId;

                studentDiv.innerHTML = `
                    <div class="student-id-cell">${studentSeat}</div>
                    <div class="student-name-cell">${student.name}</div>
                    <div class="score-input-cell" data-label="分數">
                        <input type="number" step="0.5" min="0" max="100" class="student-score-input" data-id="${studentId}" value="${existingScore}" placeholder="分數">
                    </div>
                    <div class="comment-input-cell" data-label="備註">
                        <input type="text" class="student-comment-input" data-id="${studentId}" value="${existingComment}" placeholder="備註 (選填)">
                    </div>
                `;
                studentScoresContainer.appendChild(studentDiv);
            });
            
            setupKeyboardNavigation();
        }
        
        function setupKeyboardNavigation() {
            const inputs = Array.from(document.querySelectorAll('.student-score-input, .student-comment-input'));
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    const isScoreInput = input.classList.contains('student-score-input');
                    let nextIndex = -1;
                    
                    if (e.key === 'Enter' || e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (isScoreInput) { 
                            nextIndex = index + 2; 
                        } else { 
                            nextIndex = index + 1; 
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (isScoreInput) { 
                            nextIndex = index - 2; 
                        } else { 
                            nextIndex = index - 1; 
                        }
                    } else if (e.key === 'ArrowRight' && isScoreInput) {
                        e.preventDefault();
                        nextIndex = index + 1;
                    } else if (e.key === 'ArrowLeft' && !isScoreInput) {
                        e.preventDefault();
                        nextIndex = index - 1;
                    }
                    
                    if (nextIndex >= 0 && nextIndex < inputs.length) {
                        inputs[nextIndex].focus();
                    } else if (e.key === 'Enter' && nextIndex >= inputs.length) {
                        saveGradesBtn.focus();
                    }
                });
            });
        }
        
        saveGradesBtn.addEventListener('click', saveGrades);

        async function saveGrades() {
            const assignmentName = editAssignmentNameInput.value.trim();
            const generalComment = editGeneralCommentInput.value.trim();

            if (!assignmentName) {
                alert('成績項目名稱不能為空！');
                editAssignmentNameInput.focus();
                return;
            }

            saveGradesBtn.disabled = true;
            saveGradesBtn.textContent = '儲存中...';

            const scoresToSave = {};
            let isAnyScoreEntered = false;
            let invalidScoreError = false;

            studentsInClass.forEach(student => {
                const scoreInput = document.querySelector(`.student-score-input[data-id="${student.id}"]`);
                const commentInput = document.querySelector(`.student-comment-input[data-id="${student.id}"]`);
                
                const scoreValue = scoreInput.value.trim();
                const commentValue = commentInput.value.trim();
                
                let score = null;
                if (scoreValue !== '') {
                    score = parseFloat(scoreValue);
                    if (isNaN(score) || score < 0 || score > 100) {
                        alert(`學生 ${student.name} 的分數 [${scoreValue}] 無效 (必須介於 0 到 100 之間)。`);
                        scoreInput.focus();
                        invalidScoreError = true;
                        return;
                    }
                    isAnyScoreEntered = true;
                }
                
                if (score !== null || commentValue !== '') {
                    scoresToSave[student.id] = {
                        score: score,
                        comment: commentValue
                    };
                }
            });
            
            if (invalidScoreError) {
                saveGradesBtn.disabled = false;
                saveGradesBtn.textContent = '更新儲存';
                return;
            }

            if (!isAnyScoreEntered && studentsInClass.length > 0) {
                alert('請至少為一位學生輸入分數。');
                saveGradesBtn.disabled = false;
                saveGradesBtn.textContent = '更新儲存';
                return;
            }

            const dataToSave = {
                className: classId,
                assignmentName: assignmentName,
                generalComment: generalComment,
                scores: scoresToSave,
                date: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (assignmentId) {
                    await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').doc(assignmentId).update(dataToSave);
                    alert('成績已成功更新！');
                } else {
                    const newDocRef = await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').add(dataToSave);
                    assignmentId = newDocRef.id;
                    assignmentEditHeader.textContent = `${classId} 班 成績編輯：${assignmentName}`;
                    alert('新成績項目已成功建立！');
                }
                
                navigateBackToList();

            } catch (error) {
                console.error("儲存成績失敗:", error);
                alert("儲存成績失敗！請檢查網路連線或聯繫技術支援。");
            } finally {
                saveGradesBtn.disabled = false;
                saveGradesBtn.textContent = '更新儲存';
            }
        }
        
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut().then(() => { window.location.href = 'login.html'; }); });
    </script>
</body>
</html>