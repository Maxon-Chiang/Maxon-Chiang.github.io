<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç¸¾ç™»éŒ„æˆ–ç·¨è¼¯ - ç­ç´šç¶œåˆæˆç¸¾ç´€éŒ„ç³»çµ±</title>
    <style>
        :root { --primary-color: #4a90e2; --secondary-color: #f5f5ff; --font-color: #333; --success-color: #28a745; --cancel-color: #777; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif; margin: 0; background-color: var(--secondary-color); color: var(--font-color); }
        button, input, select, textarea {
            font-family: inherit;
        }
		header { 
            background-color: var(--primary-color); color: white; padding: 0.6rem 1rem; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; 
            justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; 
        }
        header h1 { font-size: 1.6em; margin: 0; }
        header button { background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 1em; }
        main { padding: 20px; max-width: 1000px; margin: auto; padding-bottom: 80px; }
        .section { background-color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h2, h3 { color: #333; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-top: 0;}
        input, textarea { padding: 10px; margin: 5px 0; font-size: 1em; border-radius: 4px; border: 1px solid var(--border-color); box-sizing: border-box; width: 100%; }
        button { background-color: var(--primary-color); color: white; cursor: pointer; border: none; }
        
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px;
        }
        .form-grid label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        #student-scores-container {
            display: block; 
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .score-columns {
			display: grid;
            grid-template-columns: 8% 25% 15% 35% 17%; 
            gap: 0px;
            padding: 0;
        }
        
        .score-entry-header {
            font-weight: bold;
            background-color: #f7f7f7;
            padding: 10px 0;
            text-align: center;
            border-bottom: 2px solid var(--border-color);
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }
        .score-entry-header > div { 
			text-align: center !important; 
			padding: 0 !important; 
        }
        .score-entry-grid {
            padding: 5px 0; 
            border-bottom: 1px solid #eee;
			height: 30px;
        }
        .score-entry-grid:last-child { 
            border-bottom: none; 
        }
        
        .score-entry-grid input {
            margin: 0;
            padding: 8px;
            width: 100%;
            text-align: center;
			height: 30px;
        }
        
        .student-id-cell { text-align: center; font-size: 0.9em; color: #555; }
        .student-name-cell { 
			text-align: center !important; 
			font-weight: 500;		
		}
        
        .float-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0; 
            width: 100%;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px 20px;
            box-sizing: border-box; 
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            z-index: 1000;
        }
        .float-actions button {
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 6px;
            min-width: 100px; 
            white-space: nowrap; 
        }
        #save-grades-btn { background-color: var(--success-color); }
        #cancel-edit-btn { background-color: var(--cancel-color); }

        @media (max-width: 768px) {
            
            header {
                padding: 0.6rem 10px;
            }
            .header-actions {
                justify-content: flex-end;
            }
            
            #user-email, #logout-btn {
                display: none !important;
            }
            
            main { padding: 10px; padding-bottom: 70px; }
            .section { padding: 10px; margin-bottom: 15px; }
            
			.form-grid { 
				grid-template-columns: 1fr 1fr; 
				gap: 5px; 
				margin-bottom: 15px; 
			} 
			.form-grid label {
				font-size: 0.8em; 
				margin-bottom: 2px;
			}
			.form-grid input {
				padding: 8px; 
			}
            #grade-entry-section h3 {
                font-size: 1.2em;
                padding-bottom: 5px;
            }
            .score-entry-header {
                 padding: 8px 10px;
            }
            .score-columns {
                padding: 0; 
            }
            .score-entry-grid {
                padding: 5px 0;
                height: 25px;
            }
            .score-entry-grid input {
                padding: 6px;
                height: 25px;
                font-size: 0.9em;
            }
            
            .student-id-cell { font-size: 0.9em; }
            .student-name-cell { font-size: 0.9em; }
            
            .float-actions {
                padding: 8px 15px; 
            }
            .float-actions button {
                padding: 10px 15px;
                font-size: 1.0em;
                min-width: 80px; 
            }
        }
    </style>
</head>
<body>
	<header>
        <h1 id="header-title">æˆç¸¾ç™»éŒ„/ç·¨è¼¯</h1>
        <div class="header-actions">
            <span id="user-email"></span>
            <button id="back-to-list-btn">è¿”å›æ¸…å–®</button>
            <button id="logout-btn">ç™»å‡º</button>
        </div>
    </header>
    <main id="app-container" style="display: none;">
        
        <div class="section">
            <h2 id="assignment-edit-header"></h2>
            
            <div class="form-grid">
				<div>
					<label for="edit-assignment-name">æˆç¸¾é …ç›®åç¨±ï¼š</label>
					<input type="text" id="edit-assignment-name" required>
				</div>
				<div>
					<label for="edit-general-comment">æˆç¸¾èªªæ˜ (é¸å¡«)ï¼š</label>
					<input type="text" id="edit-general-comment" placeholder="ä¾‹å¦‚: é²äº¤">
				</div>
			</div>
        </div>

		<div id="grade-entry-section" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3>å­¸ç”Ÿåˆ†æ•¸ç™»éŒ„</h3>
                <span id="assignment-date-display" style="font-size: 0.9em; color: #666;"></span>
            </div>
            <div id="student-scores-container">
                <div class="score-entry-header score-columns">
                    <div>åº§è™Ÿ</div>
                    <div>å§“å</div>
                    <div>åˆ†æ•¸</div>
                    <div>å‚™è¨»</div>
					<div>ç™»éŒ„æ™‚é–“</div>
                </div>
                
			</div>
		</div>
    </main>
    <div class="float-actions" id="float-actions-bar">
        <button id="cancel-edit-btn">å–æ¶ˆ</button>
        <button id="save-grades-btn">æ›´æ–°å„²å­˜</button>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
	  const firebaseConfig = {
		apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
		authDomain: "classrecords-13902.firebaseapp.com",
		projectId: "classrecords-13902",
		storageBucket: "classrecords-13902.firebasestorage.app",
		messagingSenderId: "431747377367",
		appId: "1:431747377367:web:b157a8f5c59ce38091e892",
		measurementId: "G-JWTQGM9XMP"
	  };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();
        let currentUser = null; 
        let classId = null;
        let assignmentId = null; 
        let studentsInClass = []; 
        let currentGradesData = {}; 
        const appContainer = document.getElementById('app-container');
        const assignmentEditHeader = document.getElementById('assignment-edit-header');
        const editAssignmentNameInput = document.getElementById('edit-assignment-name');
        const editGeneralCommentInput = document.getElementById('edit-general-comment');
        const studentScoresContainer = document.getElementById('student-scores-container');
        const saveGradesBtn = document.getElementById('save-grades-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const backToListBtn = document.getElementById('back-to-list-btn');
		const STATIC_CACHE_KEY = 'teacher_static_cache_v6';
        const USER_AUTH_KEY = 'user_auth_profile_v1';
        let CACHE_DATA = {};
        const ASSIGNMENT_COMMENT_KEY = 'assignmentComment';
        let currentAssignmentData = null; // ğŸ“Œ Gemini æ–°å¢ï¼šå„²å­˜ç•¶å‰ä½œæ¥­ç°¿è³‡æ–™
        
        function formatDate(date) {
            if (!date) return 'N/A';
            if (date instanceof firebase.firestore.Timestamp) {
                date = date.toDate();
            }
            const pad = (n) => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
        }
		
		function formatMinguoDate(dateString) {
			if (!dateString || typeof dateString !== 'string' || dateString.length < 10) {
				return 'æœªç™»éŒ„';
			}
			// å‡è¨­æ ¼å¼ç‚º YYYY-MM-DD
			const parts = dateString.split('-');
			const year = parseInt(parts[0], 10);
			const month = parts[1];
			const day = parts[2];
			
			if (isNaN(year) || year < 1912) { // 1912 æ˜¯æ°‘åœ‹å…ƒå¹´
				return dateString;
			}
			
			const minguoYear = year - 1911;
			// è¼¸å‡ºæ ¼å¼ï¼šæ°‘åœ‹å¹´/æœˆ/æ—¥
			return `${minguoYear}/${month}/${day}`;
		}

        function navigateBackToList() {
            if (classId) {
                window.location.href = `grades.html?class=${classId}`;
            } else {
                window.location.href = `grades.html`;
            }
        }
        backToListBtn.addEventListener('click', navigateBackToList);
        cancelEditBtn.addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦å–æ¶ˆç·¨è¼¯ä¸¦è¿”å›æ¸…å–®å—ï¼Ÿæ‰€æœ‰æœªå„²å­˜çš„è®Šæ›´å°‡æœƒéºå¤±ã€‚')) {
                navigateBackToList();
            }
        });
		
        auth.onAuthStateChanged(async (user) => {
			if (user) {
                currentUser = user;
                const displayElement = document.getElementById('user-email');
                let userData = null;
                try {
                    const cachedAuthData = localStorage.getItem(USER_AUTH_KEY);
                    if (cachedAuthData) {
                         userData = JSON.parse(cachedAuthData).userData;
                         if (userData.displayName) {
                             displayElement.textContent = userData.displayName;
                         } else {
                             displayElement.textContent = user.email;
                         }
                    }
                } catch (e) {
                     console.error('âŒ è§£æ AUTH å¿«å–å¤±æ•—:', e);
                }
                if (!userData) {
                     const userDoc = await db.collection('users').doc(user.uid).get();
                     console.log('è¼‰å…¥userè³‡æ–™...');
                     if (userDoc.exists) {
                          userData = userDoc.data();
                          if (userData.displayName) {
                              displayElement.textContent = userData.displayName;
                          } else {
                              displayElement.textContent = user.email;
                          }
                     }
                }
                if (userData && userData.role === 'teacher') {
                    await initializeEditPage(userData);
                } else {
                    alert('æ¬Šé™ä¸è¶³æˆ–å¸³è™Ÿè¨­å®šéŒ¯èª¤ã€‚');
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

		async function initializeEditPage(userData) {
			const urlParams = new URLSearchParams(window.location.search);
			classId = urlParams.get('class');
            assignmentId = urlParams.get('assignmentId');
            const assignmentName = decodeURIComponent(urlParams.get('assignmentName') || '');
            const assignmentComment = decodeURIComponent(urlParams.get('assignmentComment') || '');
            
            let useStaticCache = false;
            let rosterDataLoaded = false;
            const assignmentDateDisplay = document.getElementById('assignment-date-display');
		
            try {
                const cached = localStorage.getItem(STATIC_CACHE_KEY);
                if (cached) {
                    CACHE_DATA = JSON.parse(cached);
                    if (CACHE_DATA.uid === currentUser.uid) {
                        useStaticCache = true;
                    } else {
                        localStorage.removeItem(STATIC_CACHE_KEY);
                    }
                }
            } catch (e) {
                console.error('âŒ è§£æ STATIC å¿«å–å¤±æ•—:', e);
                localStorage.removeItem(STATIC_CACHE_KEY);
            }

            if (useStaticCache && CACHE_DATA.rosterData) {
                var allStudents = CACHE_DATA.rosterData;
                rosterDataLoaded = true;
                console.log('âœ… å­¸ç”Ÿåå†Šï¼šSTATIC å¿«å–å‘½ä¸­ï¼');
            }
			if (!classId) {
                appContainer.innerHTML = '<h2>éŒ¯èª¤ï¼šæœªæŒ‡å®šç­ç´šï¼Œè«‹å¾ä¸»é é‡æ–°é€²å…¥ã€‚</h2>';
				appContainer.style.display = 'block';
				backToListBtn.textContent = 'è¿”å›ä¸»é ';
                backToListBtn.onclick = () => window.location.href = 'teacher.html';
				return;
			}
            
            assignmentEditHeader.textContent = assignmentId ? `${classId} ç­ æˆç¸¾ç·¨è¼¯ï¼š${assignmentName}` : `${classId} ç­ å»ºç«‹æ–°æˆç¸¾é …ç›®`;
            editAssignmentNameInput.value = assignmentName;
            editGeneralCommentInput.value = assignmentComment;
            document.title = assignmentId ? `ç·¨è¼¯ ${assignmentName}` : `å»ºç«‹æ–°é …ç›®`;

			if (!rosterDataLoaded) {
                if (!userData.schoolId) {
                    alert('éŒ¯èª¤ï¼šæ‚¨çš„å¸³è™Ÿæœªç¶å®šå­¸æ ¡IDï¼Œç„¡æ³•è®€å–åå†Šã€‚');
                    return;
                }
				const rosterDoc = await db.collection('schools').doc(userData.schoolId).collection('rosters').doc('current').get();
				console.log('è¼‰å…¥å­¸ç”Ÿåå†Šè³‡æ–™...');
				if (!rosterDoc.exists) {
					alert('æ‰¾ä¸åˆ°å­¸æ ¡çš„å­¸ç”Ÿåå†Šï¼Œè«‹è¯ç¹«å­¸æ ¡ç®¡ç†è€…ä¸Šå‚³è³‡æ–™ã€‚');
					return;
				}
                allStudents = rosterDoc.data().students || [];
                CACHE_DATA.rosterData = allStudents;
                CACHE_DATA.uid = currentUser.uid; 
			}
            
            studentsInClass = (allStudents || [])
                                .filter(s => s.id.startsWith(classId))
                                .sort((a, b) => parseInt(a.id.substring(3)) - parseInt(b.id.substring(3)));
            if (assignmentId) {
                const assignmentDoc = await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').doc(assignmentId).get();
				console.log('è¼‰å…¥ä½œæ¥­æˆç¸¾è³‡æ–™...');
                if (assignmentDoc.exists) {
                    currentGradesData = assignmentDoc.data().scores || {};
					const docData = assignmentDoc.data();
                    const docDate = docData.date ? formatDate(docData.date) : 'æ—¥æœŸæœªçŸ¥';
                    assignmentDateDisplay.textContent = `å»ºç«‹/æ›´æ–°æ—¥æœŸ: ${docDate}`;
                } else {
                    alert('æ‰¾ä¸åˆ°æ­¤æˆç¸¾é …ç›®ï¼Œå°‡ä»¥æ–°å¢æ¨¡å¼è¼‰å…¥ã€‚');
                    assignmentId = null;
                }
            }
			if (!assignmentId) {
                assignmentDateDisplay.textContent = `ç™»éŒ„æ—¥æœŸ: ${formatDate(new Date())}`;
            }
            renderStudentScores();
			appContainer.style.display = 'block';
			document.getElementById('user-email').style.display = 'none';
			document.getElementById('logout-btn').style.display = 'none';
		}
        
        function renderStudentScores() {
            const existingHeader = studentScoresContainer.querySelector('.score-entry-header');
            studentScoresContainer.innerHTML = '';
            if (existingHeader) {
                studentScoresContainer.appendChild(existingHeader);
            } else {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'score-entry-header score-columns';
				headerDiv.innerHTML = `<div>åº§è™Ÿ</div><div>å§“å</div><div>åˆ†æ•¸</div><div>å‚™è¨»</div><div>ç™»éŒ„æ™‚é–“</div>`;
                studentScoresContainer.appendChild(headerDiv);
            }
            studentsInClass.forEach(student => {
                const studentId = student.id;
                const studentSeat = studentId.substring(3);
				const existingScoreEntry = currentGradesData[studentId] || {}; 
                const existingScore = existingScoreEntry.score !== undefined && existingScoreEntry.score !== null ? existingScoreEntry.score : '';
                const existingComment = existingScoreEntry.comment || '';
				const rawDate = existingScoreEntry.scoreEntryDate;
                const existingDate = (typeof rawDate === 'string' && rawDate.trim()) 
                                     ? formatMinguoDate(rawDate) // è½‰æ›ç‚ºæ°‘åœ‹å¹´
                                     : '';
                const studentDiv = document.createElement('div');
                studentDiv.className = 'score-entry-grid score-columns'; 
                studentDiv.dataset.id = studentId;
				studentDiv.innerHTML = `
                    <div class="student-id-cell">${studentSeat}</div>
                    <div class="student-name-cell">${student.name}</div>
                    <div class="score-input-cell">
                        <input type="number" step="0.5" min="0" max="100" class="student-score-input" data-id="${studentId}" value="${existingScore}" placeholder="åˆ†æ•¸">
                    </div>
                    <div class="comment-input-cell">
                        <input type="text" class="student-comment-input" data-id="${studentId}" value="${existingComment}" placeholder="å‚™è¨» (é¸å¡«)">
                    </div>
                    <div class="score-date-display" style="text-align: center; font-size: 0.7em; color: #555; white-space: nowrap;">${existingDate}</div>
                `;
              studentScoresContainer.appendChild(studentDiv);
            });
            setupKeyboardNavigation();
        }
        
		function setupKeyboardNavigation() {
            const scoreInputs = Array.from(document.querySelectorAll('.student-score-input'));
            const commentInputs = Array.from(document.querySelectorAll('.student-comment-input'));
            const inputMap = {};
            studentsInClass.forEach(student => {
                inputMap[student.id] = {
                    score: document.querySelector(`.student-score-input[data-id="${student.id}"]`),
                    comment: document.querySelector(`.student-comment-input[data-id="${student.id}"]`)
                };
            });
            const allInputs = [...scoreInputs, ...commentInputs];
            allInputs.forEach((input) => {
                input.addEventListener('keydown', (e) => {
                    const studentId = input.dataset.id;
                    const isScoreInput = input.classList.contains('student-score-input');
                    const currentIndexInStudents = studentsInClass.findIndex(s => s.id === studentId);
                    let nextIndexInStudents = -1; 
                    const targetInputType = isScoreInput ? 'score' : 'comment'; 
                    if (e.key === 'Enter' || e.key === 'ArrowDown') {
                        e.preventDefault();
                        nextIndexInStudents = currentIndexInStudents + 1;
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        nextIndexInStudents = currentIndexInStudents - 1;
                    } else if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                        return; 
                    }
                    if (nextIndexInStudents >= 0 && nextIndexInStudents < studentsInClass.length) {
                        const nextStudentId = studentsInClass[nextIndexInStudents].id;
                        if (inputMap[nextStudentId] && inputMap[nextStudentId][targetInputType]) {
                            inputMap[nextStudentId][targetInputType].focus();
                        }
                    } else if ((e.key === 'Enter' || e.key === 'ArrowDown') && nextIndexInStudents >= studentsInClass.length) {
                        e.preventDefault(); 
                        saveGradesBtn.focus();
                    }
                });
            });
        }
		
        saveGradesBtn.addEventListener('click', saveGrades);

		async function saveGrades() {
            const assignmentName = editAssignmentNameInput.value.trim();
            const generalComment = editGeneralCommentInput.value.trim();
            if (!assignmentName) {
                alert('æˆç¸¾é …ç›®åç¨±ä¸èƒ½ç‚ºç©ºï¼');
                editAssignmentNameInput.focus();
                return;
            }
            saveGradesBtn.disabled = true;
            saveGradesBtn.textContent = 'å„²å­˜ä¸­...';
            const scoresToSave = {};
            let isAnyScoreEntered = false;
            let invalidScoreError = false;
            
            // ğŸ“Œ Gemini ä¿®æ”¹é–‹å§‹ï¼šå–å¾—ä»Šå¤©çš„æ—¥æœŸå­—ä¸²å’Œç¾æœ‰æˆç¸¾è³‡æ–™ (ä½¿ç”¨ scoreEntryDate)
            const today = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const dateString = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;
            const existingScores = currentGradesData || {}; // ç²å–ç¾æœ‰çš„ scores è³‡æ–™
            // ğŸ“Œ Gemini ä¿®æ”¹çµæŸ

            studentsInClass.forEach(student => {
                const scoreInput = document.querySelector(`.student-score-input[data-id="${student.id}"]`);
                const commentInput = document.querySelector(`.student-comment-input[data-id="${student.id}"]`);
                const scoreValue = scoreInput.value.trim();
                const commentValue = commentInput.value.trim();
                
                // ğŸ“Œ Gemini ä¿®æ”¹é–‹å§‹ï¼šç²å–ç¾æœ‰çš„å–®ç­†æˆç¸¾ç´€éŒ„
                const existingScoreEntry = existingScores[student.id] || {};
                // ğŸ“Œ Gemini ä¿®æ”¹çµæŸ
                
                let score = null;
                if (scoreValue !== '') {
                    score = parseFloat(scoreValue);
                    if (isNaN(score)) {
                        alert(`å­¸ç”Ÿ ${student.name} çš„åˆ†æ•¸ [${scoreValue}] ç„¡æ•ˆ`);
                        scoreInput.focus();
                        invalidScoreError = true;
                        return;
                    }
                    isAnyScoreEntered = true;
                }
                
                if (score !== null || commentValue !== '') {
                    
                    // ğŸ“Œ Gemini ä¿®æ”¹é–‹å§‹ï¼šæˆç¸¾ç™»éŒ„æ™‚é–“æˆ³è¨˜é‚è¼¯ (ä¸å¯è¦†è“‹åŸå‰‡)
                    let entryDate = existingScoreEntry.scoreEntryDate || null; // ç²å–ç¾æœ‰çš„æ™‚é–“æˆ³è¨˜

                    // å¦‚æœæ²’æœ‰æ™‚é–“æˆ³è¨˜ï¼Œä¸”æœ‰è¼¸å…¥åˆ†æ•¸ï¼Œå‰‡å¯«å…¥ä»Šå¤©çš„æ—¥æœŸ
                    if (!entryDate && score !== null) {
                        entryDate = dateString;
                    }
                    
                    const scoreObject = {
                        score: score,
                        comment: commentValue
                    };
                    
                    // åªæœ‰ç•¶ entryDate å­˜åœ¨æ™‚ï¼Œæ‰å°‡å…¶å¯«å…¥ç‰©ä»¶
                    if (entryDate) {
                        scoreObject.scoreEntryDate = entryDate; 
                    }
                    
                    scoresToSave[student.id] = scoreObject;
                    // ğŸ“Œ Gemini ä¿®æ”¹çµæŸ
                }
            });
            if (invalidScoreError) {
                saveGradesBtn.disabled = false;
                saveGradesBtn.textContent = 'æ›´æ–°å„²å­˜';
                return;
            }
            if (Object.keys(scoresToSave).length === 0 && studentsInClass.length > 0) {
                 alert('è«‹è‡³å°‘ç‚ºä¸€ä½å­¸ç”Ÿè¼¸å…¥åˆ†æ•¸æˆ–å‚™è¨»ã€‚');
                 saveGradesBtn.disabled = false;
                 saveGradesBtn.textContent = 'æ›´æ–°å„²å­˜';
                 return;
            }
            const dataToSave = {
                className: classId,
                assignmentName: assignmentName,
                generalComment: generalComment,
                scores: scoresToSave,
                date: firebase.firestore.FieldValue.serverTimestamp()
            };
            try {
                if (assignmentId) {
                    await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').doc(assignmentId).update(dataToSave);
                    alert('æˆç¸¾å·²æˆåŠŸæ›´æ–°ï¼');
                } else {
                    const newDocRef = await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').add(dataToSave);
                    assignmentId = newDocRef.id;
                    assignmentEditHeader.textContent = `${classId} ç­ æˆç¸¾ç·¨è¼¯ï¼š${assignmentName}`;
                    alert('æ–°æˆç¸¾é …ç›®å·²æˆåŠŸå»ºç«‹ï¼');
                }
                navigateBackToList();
            } catch (error) {
                console.error("å„²å­˜æˆç¸¾å¤±æ•—:", error);
                alert("å„²å­˜æˆç¸¾å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«æŠ€è¡“æ”¯æ´ã€‚");
            } finally {
                saveGradesBtn.disabled = false;
                saveGradesBtn.textContent = 'æ›´æ–°å„²å­˜';
            }
        }
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut().then(() => { window.location.href = 'login.html'; }); });
    </script>
</body>
</html>
