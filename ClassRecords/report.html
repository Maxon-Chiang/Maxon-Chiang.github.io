<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸æ“šå ±å‘Š - ç­ç´šç¶œåˆæˆç¸¾ç´€éŒ„ç³»çµ±</title>
    <style>
        :root { --primary-color: #4a90e2; --secondary-color: #f5f5ff; --font-color: #333; --border-color: #ddd; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif; margin: 0; background-color: var(--secondary-color); color: var(--font-color); }
        button, input, select, textarea {
            font-family: inherit;
        }
        header { background-color: var(--primary-color); color: white; padding: 0.6rem 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        header h1 { font-size: 1.6em; margin: 0; }
        header a button, header button { background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 1em;}
        main { padding: 20px; max-width: 1200px; margin: auto; }
        .section { background-color: white; padding: 5px 20px; border-radius: 8px; margin-bottom: 20px; margin-top: 0px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h2 { color: #333; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .tab-nav { border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-nav button { background: none; border: none; padding: 10px 20px; font-size: 1.1em; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-nav button.active { border-bottom-color: var(--primary-color); font-weight: bold; color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .sub-nav { font-size: 0.9em; font-weight: normal; }
        .sub-nav label { margin-left: 20px; cursor: pointer; }
		.filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 300px)); gap: 20px; align-items: end; margin-top: 0px;}
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .filter-group input, .filter-group select { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; }
        #class-filter-container, #assignment-filter-container, #perf-grade-checkbox-container,  #perf-grade-radiobtn-container { 
            display: flex; flex-wrap: wrap; gap: 10px; overflow-y: auto; background: #f9f9f9; padding: 5px; border-radius: 4px; border: 1px solid #eee;
        }
        .class-checkbox { display: flex; align-items: center; gap: 5px; height: 30px; }
        .action-buttons { margin-top: 20px; }
        .action-buttons button { font-size: 1.1em; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; }
        .run-query-btn { background-color: var(--primary-color); color: white; }
        .export-csv-btn { background-color: #28a745; color: white; margin-left: 10px; }
        .export-csv-btn:disabled { background-color: #aaa; cursor: not-allowed; }
        .results-container { min-height: 100px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; white-space: nowrap; }
        th { background-color: #f2f2f2; position: sticky; top: 0; z-index: 1;}
        tr:nth-child(even) { background-color: #f9f9f9; }
        .sortable-header, .drill-down-row { cursor: pointer; user-select: none; }
        .sortable-header:hover, .drill-down-row:hover { background-color: #eef3f8; }
        .sortable-header .sort-arrow { margin-left: 5px; color: #999; display: inline-block; width: 1em; }
        .back-btn { background-color: #6c757d; color: white; font-size: 0.9em; padding: 5px 10px; border: none; border-radius: 4px; }
		#user-email {
            margin-right: 15px;
            font-size: 1.0em;
        }
        header .header-actions {
            display: flex;
            align-items: center;
        }
		.filter-grid { 
			display: grid; 
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
			gap: 20px; 
			align-items: end; 
			margin-top: 0px;
		}
		#perf-stats-filter-grid {
			display: flex !important; 
			flex-wrap: wrap; 
			gap: 10px; 
			margin-top: 20px; 
		}
		#perf-stats-filter-grid .filter-group:nth-child(1) { 
			flex: 0 1 20%; 
		}
		#perf-stats-filter-grid .filter-group:nth-child(2) { 
			flex: 0 1 72%; 
		}
		#grades-stats-filter-grid {
			display: flex !important; 
			gap: 30px;
			margin-top: 20px; 
		}
		#grades-stats-filter-grid .filter-group:nth-child(1) { 
			flex: 1 1 20%; 
		}
		#grades-stats-filter-grid .filter-group:nth-child(2) { 
			flex: 1 1 70%; 
		}
        @media (max-width: 768px) {
            main { padding: 10px; }
            .section { padding: 5px 15px 10px; margin-bottom: 10px;}
            header h1 { font-size: 1.6em; }
			header a button, header button { padding: 2px 5px; margin-left: 5px; font-size: 0.8em;}
            h2 {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
			.reload-text {
                display: block;
            }
            .sub-nav {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                flex-direction: row;
				font-size: 0.8em;
            }
            .sub-nav label {
                margin-left: 0;
            }
			.filter-grid {
				 grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));				 
			}
			.filter-group input, .filter-group select { 
				padding: 2px; 
				font-size: 0.9em; 
				max-width:110px; 
			}
            .action-buttons {
                display: flex;
                flex-direction: row;
                gap: 10px;
            }
            .export-csv-btn {
                margin-left: 0;
            }
			#perf-stats-filter-grid .filter-group:nth-child(1) { 
				min-width: 80px;
			}
			#perf-stats-filter-grid .filter-group:nth-child(2) { 
				max-width: 300px;
			}
			#grades-stats-filter-grid {
				gap: 10px;
				margin-top: 10px; 
			}
			#grades-stats-filter-grid .filter-group:nth-child(1) { 
				font-size: 1.0em;
			}
			#grades-stats-filter-grid .filter-group:nth-child(2) { 
				font-size: 1.0em;
			}			
			.action-buttons { margin-top: 10px; }
			.action-buttons button { padding: 5px 10px; border-radius: 3px; }			
        }
    </style>
</head>
<body>
	<header>
        <h1>æ•¸æ“šå ±å‘Š</h1>
        <div class="header-actions">
            <span id="user-email"></span>
			<button id="manual-reload-btn">ğŸ”„ æ‰‹å‹•æ›´æ–°</button>
            <button onclick="history.back()">è¿”å›ä¸»é </button>
            <button id="logout-btn">ç™»å‡º</button>
        </div>
    </header>
    <main>
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="performance">è¡¨ç¾ç´€éŒ„å ±å‘Š</button>
            <button class="tab-btn" data-tab="grades">æˆç¸¾å ±å‘Š</button>
        </div>
        <div id="performance-tab" class="tab-content active">
            <div class="section">
                <h2>
                    <span>æŸ¥è©¢æ¢ä»¶</span>
                    <div class="sub-nav">
                        <label><input type="radio" name="perf-report-type" value="log" checked> äº‹ä»¶æ˜ç´°</label>
                        <label><input type="radio" name="perf-report-type" value="stats"> çµ±è¨ˆæ‘˜è¦</label>
                    </div>
                </h2>
                <div class="filter-grid">
                    <div class="filter-group"><label for="start-date">é–‹å§‹æ—¥æœŸ:</label><input type="date" id="start-date"></div>
                    <div class="filter-group"><label for="end-date">çµæŸæ—¥æœŸ:</label><input type="date" id="end-date"></div>
					<div class="filter-grid" style="grid-template-columns: 1fr;" id="event-select">
                        <div class="filter-group">
                            <label>äº‹ä»¶é¡å‹:</label>
                            <select id="event-type-filter">
                                <option value="all">å…¨éƒ¨äº‹ä»¶</option>
                                <option value="with_points">åƒ…æœ‰åˆ†æ•¸</option>
                                <option value="text_only">åƒ…ç´”æ–‡å­—</option>
                            </select>
                        </div>
                    </div>
                </div>
                
				<div id="perf-stats-options" style="margin-top: 20px; display: none;">
					<div id="perf-stats-filter-grid" style="display: flex;" >
						<div class="filter-group">
							<label style="font-weight: bold;">åŠ ç¸½å°è±¡:</label>
							<div id="perf-grade-radiobtn-container">
								<label><input type="radio" name="sum-target" value="class" checked>ç­ç´š</label>
								<label><input type="radio" name="sum-target" value="student">å­¸ç”Ÿ</label>
							</div>
						</div>
						
						<div id="perf-grade-filter-container" class="filter-group">
							<label>é¸æ“‡å¹´æ®µ (å¯è¤‡é¸):</label>
							<div id="perf-grade-checkbox-container">
								<div class="class-checkbox">
									<input type="checkbox" id="select-all-grades" class="grade-selector" data-grade="all" checked>
									<label for="select-all-grades">å…¨é¸</label>
								</div>
								</div>
						</div>
					</div>
				</div>
 
                <div id="perf-log-filters">                    
                    <div class="filter-group" style="margin-top: 20px;"><label>ç­ç´š (å¯è¤‡é¸):</label><div id="class-filter-container"><div class="class-checkbox"><input type="checkbox" id="select-all-classes" checked><label for="select-all-classes">å…¨é¸</label></div></div></div>
                </div>
                <div class="action-buttons"><button id="run-perf-query-btn" class="run-query-btn">åŸ·è¡ŒæŸ¥è©¢</button><button id="export-perf-csv-btn" class="export-csv-btn" disabled>åŒ¯å‡º CSV</button></div>
            </div>
            <div class="section"><h2 id="perf-results-title"><span>æŸ¥è©¢çµæœ</span></h2><div id="perf-results-container" class="results-container"><p>è«‹è¨­å®šæ¢ä»¶å¾ŒåŸ·è¡ŒæŸ¥è©¢ã€‚</p></div></div>
        </div>
        <div id="grades-tab" class="tab-content">
            <div class="section">
                <h2><span>æŸ¥è©¢æ¢ä»¶</span><div class="sub-nav"><label><input type="radio" name="grades-report-type" value="student" checked> å­¸ç”Ÿå€‹äººæˆç¸¾æ˜ç´°</label><label><input type="radio" name="grades-report-type" value="assignment"> ç­ç´šå…§ä½œæ¥­åˆ†æ</label><label><input type="radio" name="grades-report-type" value="cross-class"> è·¨ç­ç´šä½œæ¥­æ¯”è¼ƒ</label></div></h2>
				<div id="grades-student-filters">				
					<div id="grades-stats-filter-grid" style="display: flex;" >						
						<div class="filter-group">
							<label for="grades-class-select">1.å…ˆé¸ç­ç´š</label>
							<select id="grades-class-select"><option value="">......</option></select>
						</div>
						<div class="filter-group">
							<label>2.é¸æˆç¸¾é …ç›®(å¯è¤‡é¸):</label>
							<div id="assignment-filter-container">
								<div class="class-checkbox">
									<input type="checkbox" id="select-all-assignments" checked>
									<label for="select-all-assignments">å…¨é¸</label>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div id="grades-assignment-filters" style="display:none; font-size: 1em;">
					<div><label for="grades-class-select-single">é¸æ“‡ç­ç´šï¼š</label><select id="grades-class-select-single"><option value="">......</option></select></div>
				</div>
				<div id="grades-cross-class-filters" style="display:none; font-size: 1em;">
					<div><label for="grades-assignment-select">é¸æ“‡æˆç¸¾é …ç›®ï¼š</label><select id="grades-assignment-select"><option value="">è«‹å…ˆè¼‰å…¥æ‰€æœ‰æˆç¸¾é …ç›®</option></select></div>
				</div>
                <div class="action-buttons"><button id="run-grades-query-btn" class="run-query-btn">åŸ·è¡ŒæŸ¥è©¢</button><button id="export-grades-csv-btn" class="export-csv-btn" disabled>åŒ¯å‡º CSV</button></div>
            </div>
            <div class="section"><h2 id="grades-results-title"><span>æŸ¥è©¢çµæœ</span></h2><div id="grades-results-container" class="results-container"><p>è«‹è¨­å®šæ¢ä»¶å¾ŒåŸ·è¡ŒæŸ¥è©¢ã€‚</p></div></div>
        </div>
    </main>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
	  const firebaseConfig = {
		apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
		authDomain: "classrecords-13902.firebaseapp.com",
		projectId: "classrecords-13902",
		storageBucket: "classrecords-13902.firebasestorage.app",
		messagingSenderId: "431747377367",
		appId: "1:431747377367:web:b157a8f5c59ce38091e892",
		measurementId: "G-JWTQGM9XMP"
	  };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); const auth = firebase.auth();
        let currentUser = null, studentsData = [], studentMap = new Map(), classList = [], currentPerfResults = [], currentPerfStats = {}, allAssignments = [];
        let perfSortState = { key: 'class', direction: 'asc' };
        let perfStatsSortState = { key: 'total', direction: 'desc', target: 'class' }; 
        let gradeAssignmentSortState = { key: 'date', direction: 'desc' };
        let gradeCrossClassSortState = { key: 'className', direction: 'asc' };
		const USER_AUTH_PROFILE_KEY = 'user_auth_profile_v1'; 
		const REPORT_STATIC_CACHE_KEY = 'report_cache_v1';
		const STATIC_CACHE_KEY = 'teacher_static_cache_v6'; 
        const CACHE_LIFETIME = 45 * 60 * 1000; 
        let CACHE_DATA = {};
		
        const GRADE_MAP = { '1': 'ä¸€', '2': 'äºŒ', '3': 'ä¸‰', '4': 'å››', '5': 'äº”', '6': 'å…­', '7': 'ä¸ƒ', '8': 'å…«', '9': 'ä¹' };

        function getGradeLevelFromClassId(classId) {
            if (!classId || classId.length < 3) return null;
            const firstDigit = classId.charAt(0);
            return GRADE_MAP[firstDigit] ? firstDigit : null; 
        }
        
		auth.onAuthStateChanged(async (user) => { 
            if (user) { 
                currentUser = user;
                const displayElement = document.getElementById('user-email');
                
                let cacheUser = null;
                
                try {
                    const cachedAuthData = localStorage.getItem(USER_AUTH_PROFILE_KEY);
                    if (cachedAuthData) {
                        const parsedData = JSON.parse(cachedAuthData);
                        if (parsedData.uid === currentUser.uid) {
                            cacheUser = parsedData;
                            console.log('âœ¨ ç¹¼æ‰¿ç”¨æˆ¶è³‡æ–™ï¼šå¿«å–å‘½ä¸­ï¼');
                        } else {
							 console.log('âœ¨ å¿«å–ä¸åŒ¹é…æˆ–æå£ï¼Œæ¸…ç†å¿«å–ï¼');
                             localStorage.removeItem(USER_AUTH_PROFILE_KEY);
                        }
                    }
                } catch (e) {
                    console.error('âŒ è§£æç”¨æˆ¶å¿«å–å¤±æ•—ï¼Œå°‡å¾ Firestore è¼‰å…¥ã€‚', e);
                }
                if (!cacheUser) {
                    const cacheUser = await db.collection('users').doc(currentUser.uid).get(); 
				    console.log('è¼‰å…¥userè³‡æ–™...');
                    if (cacheUser.exists) {
                        cacheUser = cacheUser.data();
                        cacheUser.uid = user.uid;
                    }
                }
                
                if (cacheUser && (cacheUser.userData.role === 'teacher' || cacheUser.userData.role === 'admin')) {
                    if (cacheUser.userData.displayName) {
                        displayElement.textContent = cacheUser.userData.displayName;
                    } else {
                        displayElement.textContent = cacheUser.userData.email;
                    }
                    await initializeReportPage(cacheUser); 
                } else { 
                    window.location.href = 'login.html'; 
                } 
            } else { 
                window.location.href = 'login.html'; 
            } 
        });
			
        async function initializeReportPage(cacheUser) {
            const today = new Date().toLocaleDateString('en-CA');
            document.getElementById('start-date').value = today;
            document.getElementById('end-date').value = today;
            
            let useCache = false;
            let rosterDataLoaded = false;
            let assignmentsDataLoaded = false;
            
            try {
				const teacherCache = localStorage.getItem(STATIC_CACHE_KEY);
				if (teacherCache) {
					const staticData = JSON.parse(teacherCache)
					if (staticData.rosterData && staticData.allClassList) {
						studentsData = staticData.rosterData;
						classList = staticData.allClassList;
						console.log('âœ¨ åå†Š/ç­ç´šåˆ—è¡¨ï¼šå¿«å–å‘½ä¸­ï¼');
						rosterDataLoaded = true;
					}
				}
                const storedCache = localStorage.getItem(REPORT_STATIC_CACHE_KEY);
                if (storedCache) {
                    const parsedCache = JSON.parse(storedCache);
                    const now = new Date().getTime();
                    CACHE_DATA = parsedCache;
                    if (parsedCache.lastUpdated) { 
                        useCache = true;                                                
                        if (CACHE_DATA.allAssignments) {
                            allAssignments = CACHE_DATA.allAssignments;
                            console.log('âœ¨ æˆç¸¾é …ç›®ï¼šå¿«å–å‘½ä¸­ï¼(æ‰‹å‹•æ¨¡å¼)');
                            assignmentsDataLoaded = true;
                        }
                    } else if(parsedCache.lastUpdated) {
                        console.log('âŒ æˆç¸¾è³‡æ–™å¿«å–å·²éæœŸ ('+(CACHE_LIFETIME/60000)+'åˆ†é˜)ï¼Œé‡æ–°è¼‰å…¥ Firestoreã€‚');
                    }
                }
            } catch (e) {
                console.error('âŒ è§£ææœ¬åœ°å¿«å–å¤±æ•—ï¼Œå°‡å¾ Firestore è¼‰å…¥ã€‚', e);
            }
            if (!cacheUser.userData.schoolId) {
                console.warn("å¸³è™Ÿæœªç¶å®šå­¸æ ¡IDï¼Œç„¡æ³•è®€å–åå†Šã€‚");
                alert('éŒ¯èª¤ï¼šæ‚¨çš„å¸³è™Ÿæœªç¶å®šå­¸æ ¡IDï¼Œç„¡æ³•ç¹¼çºŒæ“ä½œã€‚');
                return;
            }
            
            if (!rosterDataLoaded) {
                const rosterDoc = await db.collection('schools').doc(cacheUser.userData.schoolId).collection('rosters').doc('current').get();
                console.log('è¼‰å…¥å­¸ç”Ÿåå†Šè³‡æ–™...');
                if (!rosterDoc.exists) {
                    alert('æ‰¾ä¸åˆ°å­¸æ ¡çš„å­¸ç”Ÿåå†Šï¼Œè«‹è¯ç¹«å­¸æ ¡ç®¡ç†è€…ä¸Šå‚³è³‡æ–™ã€‚');
                    return;
                }
                studentsData = rosterDoc.data().students;
                classList = [...new Set(studentsData.map(s => s.id.substring(0, 3)))].sort();
            }
            studentMap.clear();
            studentsData.forEach(s => studentMap.set(s.id, s));
            
            const perfClassFilter = document.getElementById('class-filter-container');
            const gradesClassSelect = document.getElementById('grades-class-select');
            const gradesClassSelectSingle = document.getElementById('grades-class-select-single');
            
            const perfGradeContainer = document.getElementById('perf-grade-checkbox-container'); 
            const selectAllGrades = document.getElementById('select-all-grades');
            const gradeGroups = {}; 
            classList.forEach(className => {
                const grade = getGradeLevelFromClassId(className);
                if (grade) {
                    if (!gradeGroups[grade]) gradeGroups[grade] = [];
                    gradeGroups[grade].push(className);
                }
                const div = document.createElement('div');
                div.className = 'class-checkbox';
                div.innerHTML = `<input type="checkbox" id="class-${className}" value="${className}" class="class-selector" checked><label for="class-${className}">${className}</label>`;
                perfClassFilter.appendChild(div);
                gradesClassSelect.add(new Option(`${className} ç­`, className));
                gradesClassSelectSingle.add(new Option(`${className} ç­`, className));
            });
            
            const availableGrades = Object.keys(gradeGroups).sort();
            availableGrades.forEach(grade => {
                const gradeName = GRADE_MAP[grade] || grade;
                const div = document.createElement('div');
                div.className = 'class-checkbox';
                div.innerHTML = `<input type="checkbox" id="grade-${grade}" value="${grade}" class="grade-selector grade-checkbox" checked><label for="grade-${grade}">${gradeName}å¹´ç´š</label>`;
                perfGradeContainer.appendChild(div);
            });
            
            selectAllGrades.addEventListener('change', (e) => {
                document.querySelectorAll('.grade-checkbox').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });
            document.querySelectorAll('.grade-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const allChecked = [...document.querySelectorAll('.grade-checkbox')].every(cb => cb.checked);
                    selectAllGrades.checked = allChecked;
                });
            });
            if (!assignmentsDataLoaded) {
                const assignmentsSnapshot = await db.collection('gradebooks').doc(currentUser.uid).collection('assignments').orderBy('date', 'desc').get();
                console.log('è¼‰å…¥æˆç¸¾è³‡æ–™...');
                allAssignments = [];
                assignmentsSnapshot.forEach(doc => {
                    allAssignments.push({ id: doc.id, ...doc.data() });
                });
            }
            
            const uniqueAssignments = {};
            allAssignments.forEach(a => {
                const name = a.assignmentName;
                if (!uniqueAssignments[name]) uniqueAssignments[name] = name;
            });
            const gradesAssignmentSelect = document.getElementById('grades-assignment-select');
            gradesAssignmentSelect.innerHTML = '<option value="">......</option>';
            Object.keys(uniqueAssignments).sort().forEach(name => {
                gradesAssignmentSelect.add(new Option(name, name));
            });
            
            if (!useCache || !assignmentsDataLoaded) {
                CACHE_DATA = {
                    allAssignments: allAssignments,
                    lastUpdated: new Date().getTime() 
                };
                localStorage.setItem(REPORT_STATIC_CACHE_KEY, JSON.stringify(CACHE_DATA));
                console.log('âœ¨ éœæ…‹è³‡æ–™å·²å¯«å…¥æœ¬åœ°å¿«å–ã€‚');
            }
        }
        
		document.getElementById('manual-reload-btn').addEventListener('click', () => {
            if(confirm('ç¢ºå®šè¦å¾é›²ç«¯é‡æ–°ä¸‹è¼‰è³‡æ–™å—ï¼Ÿ')) {
                localStorage.removeItem(REPORT_STATIC_CACHE_KEY);
                window.location.reload();
            }
        });
		
        document.querySelectorAll('.tab-btn').forEach(button => { button.addEventListener('click', () => { document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active')); button.classList.add('active'); document.getElementById(button.dataset.tab + '-tab').classList.add('active'); }); });
        
        document.querySelectorAll('input[name="perf-report-type"]').forEach(radio => { 
            radio.addEventListener('change', () => { 
                const isLog = radio.value === 'log'; 
                document.getElementById('perf-log-filters').style.display = isLog ? 'block' : 'none'; 
                document.getElementById('event-select').style.display = isLog ? 'block' : 'none'; 
                document.getElementById('perf-stats-options').style.display = isLog ? 'none' : 'block';
                document.getElementById('perf-grade-filter-container').style.display = isLog ? 'none' : 'flex';
                document.getElementById('perf-results-container').innerHTML = '<p>è«‹è¨­å®šæ¢ä»¶å¾ŒåŸ·è¡ŒæŸ¥è©¢ã€‚</p>'; 
                document.getElementById('export-perf-csv-btn').disabled = true; 
                document.getElementById('perf-results-title').innerHTML = '<span>æŸ¥è©¢çµæœ</span>'; 
            }); 
        });
        
        document.querySelectorAll('input[name="sum-target"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                perfStatsSortState = { key: 'total', direction: 'desc', target: e.target.value };
                document.getElementById('perf-results-container').innerHTML = '<p>è«‹è¨­å®šæ¢ä»¶å¾ŒåŸ·è¡ŒæŸ¥è©¢ã€‚</p>'; 
                document.getElementById('export-perf-csv-btn').disabled = true; 
            });
        });
        document.querySelectorAll('input[name="grades-report-type"]').forEach(radio => { radio.addEventListener('change', (e) => { document.getElementById('grades-student-filters').style.display = 'none'; document.getElementById('grades-assignment-filters').style.display = 'none'; document.getElementById('grades-cross-class-filters').style.display = 'none'; document.getElementById(`grades-${e.target.value}-filters`).style.display = 'block'; document.getElementById('grades-results-container').innerHTML = '<p>è«‹è¨­å®šæ¢ä»¶å¾ŒåŸ·è¡ŒæŸ¥è©¢ã€‚</p>'; document.getElementById('export-grades-csv-btn').disabled = true; document.getElementById('grades-results-title').innerHTML = '<span>æŸ¥è©¢çµæœ</span>'; }); });
        
        document.getElementById('select-all-classes').addEventListener('change', (e) => { document.querySelectorAll('#performance-tab .class-selector').forEach(checkbox => { checkbox.checked = e.target.checked; }); });
        
        document.getElementById('run-perf-query-btn').addEventListener('click', async () => {
            const container = document.getElementById('perf-results-container');
            container.innerHTML = 'æŸ¥è©¢ä¸­...'; document.getElementById('export-perf-csv-btn').disabled = true;
            const reportType = document.querySelector('input[name="perf-report-type"]:checked').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (!startDate || !endDate) { container.innerHTML = '<p style="color:red;">è«‹é¸æ“‡æ—¥æœŸï¼</p>'; return; }
            const startTS = new Date(startDate); const endTS = new Date(endDate); endTS.setHours(23, 59, 59, 999);
            try {
                const query = db.collection('performanceRecords').doc(currentUser.uid).collection('records').where('timestamp', '>=', startTS).where('timestamp', '<=', endTS);
                const snapshot = await query.get();
				console.log('è¼‰å…¥å­¸ç”Ÿç´€éŒ„...');
                let allRecordsInRange = [];
                snapshot.forEach(doc => allRecordsInRange.push(doc.data()));
                
                if (reportType === 'log') {
                    const selectedClasses = [...document.querySelectorAll('#performance-tab .class-selector:checked')].map(cb => cb.value);
                    const eventType = document.getElementById('event-type-filter').value;
                    currentPerfResults = allRecordsInRange.filter(r => { const cId = (r.entityType === 'class') ? r.entityId : (r.entityId || r.studentId).substring(0, 3); const hasP = (r.points || 0) !== 0; const hasT = (r.text || '').trim() !== ''; const cMatch = selectedClasses.length === 0 || selectedClasses.includes(cId); let eMatch = true; if (eventType === 'with_points') eMatch = hasP; if (eventType === 'text_only') eMatch = !hasP && hasT; return cMatch && eMatch; });
                    perfSortState = { key: 'class', direction: 'asc' };
                    sortAndRenderPerfLog();
                } 
                else {
                    const sumTarget = document.querySelector('input[name="sum-target"]:checked').value;
                    perfStatsSortState.target = sumTarget;
                    const selectedGrades = [...document.querySelectorAll('.grade-checkbox:checked')].map(cb => cb.value); 
                    if (selectedGrades.length === 0) {
                        container.innerHTML = '<p style="color:red;">è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å¹´æ®µé€²è¡Œçµ±è¨ˆï¼</p>'; 
                        return;
                    }
                    const classesToProcess = classList.filter(c => {
                        const grade = getGradeLevelFromClassId(c);
                        return grade && selectedGrades.includes(grade); 
                    });
                    
                    if (sumTarget === 'class') {
                        const stats = {};
                        classesToProcess.forEach(c => { 
                            stats[c] = { className: c, total: 0, positive: 0, negative: 0, count: 0 }; 
                        });
                        allRecordsInRange.forEach(record => {
                            const className = (record.entityType === 'class') ? record.entityId : (record.entityId || record.studentId).substring(0, 3);
                            if (classesToProcess.includes(className)) {
                                if (stats[className]) {
                                    const points = record.points || 0;
                                    stats[className].count++;
                                    stats[className].total += points;
                                    if (points > 0) stats[className].positive += points;
                                    if (points < 0) stats[className].negative += points;
                                }
                            }
                        });
                        currentPerfStats = { target: 'class', allRecords: allRecordsInRange, stats: Object.values(stats).filter(s => s.count > 0) };
                        perfStatsSortState.key = 'total'; 
                        perfStatsSortState.direction = 'desc';
                        sortAndRenderPerfStats();
                    } else if (sumTarget === 'student') {
                        const stats = {};
                        const studentsToProcess = studentsData.filter(s => {
                            const grade = getGradeLevelFromClassId(s.id.substring(0, 3));
                            return grade && selectedGrades.includes(grade);
                        }).map(s => s.id);
                        studentsToProcess.forEach(sId => {
                            const student = studentMap.get(sId);
                            stats[sId] = { studentId: sId, className: student.id.substring(0, 3), name: student.name, total: 0, positive: 0, negative: 0, count: 0 };
                        });
                        allRecordsInRange.forEach(record => {
                            const studentId = record.entityId || record.studentId;
                            if (record.entityType !== 'class' && studentsToProcess.includes(studentId)) {
                                if (stats[studentId]) {
                                    const points = record.points || 0;
                                    stats[studentId].count++;
                                    stats[studentId].total += points;
                                    if (points > 0) stats[studentId].positive += points;
                                    if (points < 0) stats[studentId].negative += points;
                                }
                            }
                        });
                        currentPerfStats = { target: 'student', allRecords: allRecordsInRange, stats: Object.values(stats).filter(s => s.count > 0) };
                        perfStatsSortState.key = 'total'; 
                        perfStatsSortState.direction = 'desc';
                        sortAndRenderPerfStudentStats();
                    }
                }
            } catch (error) { console.error("æŸ¥è©¢å¤±æ•—:", error); container.innerHTML = `<p style="color:red;">æŸ¥è©¢å¤±æ•—ï¼è«‹æª¢æŸ¥ Consoleã€‚</p>`; }
        });

        function sortAndRenderPerfStudentStats() {
            const sortedStats = [...currentPerfStats.stats]; 
            sortedStats.sort((a, b) => { 
                const key = perfStatsSortState.key;
                const direction = perfStatsSortState.direction === 'asc' ? 1 : -1;
                let valA, valB;
                if (key === 'avg') { 
                    valA = a.count > 0 ? (a.total / a.count) : -Infinity; 
                    valB = b.count > 0 ? (b.total / b.count) : -Infinity; 
                } else if (key === 'className') {
                     valA = a.className;
                     valB = b.className;
                } else if (key === 'studentId') {
                     valA = a.studentId;
                     valB = b.studentId;
                } else { 
                    valA = a[key]; 
                    valB = b[key]; 
                } 
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return valA.localeCompare(valB, 'zh-TW') * direction;
                } else {
                    if (valA < valB) return -1 * direction; 
                    if (valA > valB) return 1 * direction; 
                }
                return a.studentId.localeCompare(b.studentId); 
            }); 
            renderPerfStudentStats(sortedStats); 
        }

        function renderPerfStudentStats(stats) {
            const container = document.getElementById('perf-results-container'); 
            document.getElementById('perf-results-title').innerHTML = '<span>æŸ¥è©¢çµæœ</span>';
            if (stats.length === 0) { container.innerHTML = '<p>æ‰¾ä¸åˆ°å¯çµ±è¨ˆçš„ç´€éŒ„ã€‚</p>'; return; } 
            const getArrow = (key) => { 
                if (perfStatsSortState.key !== key) return '&#x25B4;&#x25BE;'; 
                return perfStatsSortState.direction === 'asc' ? '&#x25B2;' : '&#x25BC;'; 
            }; 
            let table = `<table><thead><tr>
                <th class="sortable-header" data-sort-stats="className">ç­ç´š <span class="sort-arrow">${getArrow('className')}</span></th>
                <th class="sortable-header" data-sort-stats="studentId">åº§è™Ÿ <span class="sort-arrow">${getArrow('studentId')}</span></th>
                <th>å§“å</th>
                <th class="sortable-header" data-sort-stats="total">ç¸½åˆ† <span class="sort-arrow">${getArrow('total')}</span></th>
                <th class="sortable-header" data-sort-stats="positive">ç¸½åŠ åˆ† <span class="sort-arrow">${getArrow('positive')}</span></th>
                <th class="sortable-header" data-sort-stats="negative">ç¸½æ‰£åˆ† <span class="sort-arrow">${getArrow('negative')}</span></th>
                <th class="sortable-header" data-sort-stats="count">äº‹ä»¶ç¸½æ•¸ <span class="sort-arrow">${getArrow('count')}</span></th>
                <th class="sortable-header" data-sort-stats="avg">å–®æ¬¡å‡åˆ† <span class="sort-arrow">${getArrow('avg')}</span></th>
                </tr></thead><tbody>`; 
            stats.forEach(s => { 
                const avg = s.count > 0 ? (s.total / s.count).toFixed(2) : 'N/A'; 
                const seatNum = s.studentId.substring(3);
                table += `<tr class="drill-down-row" data-type="perf-student" data-value="${s.studentId}">
                    <td>${s.className}</td>
                    <td>${seatNum}</td>
                    <td>${s.name}</td>
                    <td>${s.total.toFixed(1)}</td>
                    <td>${s.positive.toFixed(1)}</td>
                    <td>${s.negative.toFixed(1)}</td>
                    <td>${s.count}</td>
                    <td>${avg}</td>
                    </tr>`; 
            }); 
            table += '</tbody></table>'; 
            container.innerHTML = table; 
            document.getElementById('export-perf-csv-btn').disabled = false; 
            container.querySelectorAll('.sortable-header[data-sort-stats]').forEach(header => { 
                header.addEventListener('click', () => { 
                    const sortKey = header.dataset.sortStats; 
                    if (perfStatsSortState.key === sortKey) { 
                        perfStatsSortState.direction = perfStatsSortState.direction === 'asc' ? 'desc' : 'asc'; 
                    } else { 
                        perfStatsSortState.key = sortKey; 
                        perfStatsSortState.direction = sortKey === 'className' || sortKey === 'studentId' ? 'asc' : 'desc'; 
                    } 
                    sortAndRenderPerfStudentStats(); 
                }); 
            }); 
            container.querySelectorAll('.drill-down-row[data-type="perf-student"]').forEach(row => { 
                row.addEventListener('click', () => { 
                    const studentId = row.dataset.value; 
                    const student = studentMap.get(studentId);
                    document.querySelector('input[name="perf-report-type"][value="log"]').checked = true; 
                    document.querySelector('input[name="perf-report-type"][value="log"]').dispatchEvent(new Event('change')); 
                    document.getElementById('perf-log-filters').style.display = 'none';
                    currentPerfResults = currentPerfStats.allRecords.filter(r => (r.entityId === studentId || r.studentId === studentId)); 
                    perfSortState = { key: 'timestamp', direction: 'desc' }; 
                    renderPerfLog(currentPerfResults, true, `å­¸ç”Ÿ: ${student ? student.name : studentId}`); 
                }); 
            });
        }
        
        function sortAndRenderPerfLog(fromDrillDown = false, drillDownTitle = '') { 
                const sortedResults = [...currentPerfResults];
                sortedResults.sort( (a, b) => {
                    const key = perfSortState.key;
                    const direction = perfSortState.direction === 'asc' ? 1 : -1;
                    let valA, valB;
                    if (key === 'timestamp') {
                        valA = a.timestamp.seconds;
                        valB = b.timestamp.seconds;
                    } else if (key === 'score') {
                        valA = a.points || 0;
                        valB = b.points || 0;
                    } else if (key === 'class') {
                        valA = parseInt(a.entityId || a.studentId || '0', 10);
                        valB = parseInt(b.entityId || b.studentId || '0', 10);
                    }
                    if (valA < valB)
                        return -1 * direction;
                    if (valA > valB)
                        return 1 * direction;
                    return 0;
                }
                );
                renderPerfLog(sortedResults, fromDrillDown, drillDownTitle);
        }

        function renderPerfLog(results, fromDrillDown = false, drillDownTitle = '') { 
            const container = document.getElementById('perf-results-container');
            const title = document.getElementById('perf-results-title');
            const existingBtn = title.querySelector('.back-btn');
            if(existingBtn) existingBtn.remove();
            let titleText = fromDrillDown ? `<span>æŸ¥è©¢çµæœ: ${drillDownTitle}</span>` : '<span>æŸ¥è©¢çµæœ</span>';
            if (fromDrillDown) {
                titleText += '<button class="back-btn" id="back-to-perf-stats">è¿”å›çµ±è¨ˆæ‘˜è¦</button>';
            }
            title.innerHTML = titleText;
            if (fromDrillDown) {
                document.getElementById('back-to-perf-stats').addEventListener('click', () => {
                    const statsRadio = document.querySelector('input[name="perf-report-type"][value="stats"]');
                    statsRadio.checked = true;
                    statsRadio.dispatchEvent(new Event('change'));
                    if (currentPerfStats.target === 'student') {
                        sortAndRenderPerfStudentStats();
                    } else {
                        sortAndRenderPerfStats();
                    }
                });
            }
            if (results.length === 0) { container.innerHTML = '<p>æ‰¾ä¸åˆ°ç´€éŒ„ã€‚</p>'; return; } 
            const getArrow = (key) => { if (perfSortState.key !== key) return '&#x25B4;&#x25BE;'; return perfSortState.direction === 'asc' ? '&#x25B2;' : '&#x25BC;'; }; 
            let tableHTML = `<table><thead><tr><th class="sortable-header" data-sort="timestamp">æ—¥æœŸæ™‚é–“ <span class="sort-arrow">${getArrow('timestamp')}</span></th><th class="sortable-header" data-sort="class">ç­ç´š <span class="sort-arrow">${getArrow('class')}</span></th><th>åº§è™Ÿ</th><th>å§“å</th><th class="sortable-header" data-sort="score">åˆ†æ•¸ <span class="sort-arrow">${getArrow('score')}</span></th><th>äº‹ç”±</th></tr></thead><tbody>`; 
            results.forEach(record => { 
                const entityId = record.entityId || record.studentId; 
                const type = record.entityType || 'student'; 
                const seatNum = (type === 'student') ? entityId.substring(3) : '-'; 
                let targetName = ''; 
                if (type === 'class') { 
                    targetName = `ç­ç´š (${entityId})`; 
                } else { 
                    const student = studentMap.get(entityId); 
                    targetName = student ? student.name : `å­¸ç”Ÿ (${entityId})`; 
                } 
                const className = type === 'class' ? entityId : entityId.substring(0, 3); 
                tableHTML += `<tr><td>${record.timestamp.toDate().toLocaleString('zh-TW', { hour12: false })}</td><td>${className}</td><td>${seatNum}</td><td>${targetName}</td><td>${record.points || 0}</td><td>${record.text || ''}</td></tr>`; 
            }); 
            tableHTML += '</tbody></table>'; 
            container.innerHTML = tableHTML; 
            document.getElementById('export-perf-csv-btn').disabled = false; 
            container.querySelectorAll('.sortable-header[data-sort]').forEach(header => { 
                header.addEventListener('click', () => { 
                    const sortKey = header.dataset.sort; 
                    if (perfSortState.key === sortKey) { 
                        perfSortState.direction = perfSortState.direction === 'asc' ? 'desc' : 'asc'; 
                    } else { 
                        perfSortState.key = sortKey; 
                        perfSortState.direction = 'desc'; 
                    } 
                    sortAndRenderPerfLog(fromDrillDown, drillDownTitle); 
                }); 
            }); 
        }
        
        function sortAndRenderPerfStats() { 
            const sortedStats = [...currentPerfStats.stats]; 
            sortedStats.sort((a, b) => { 
                const key = perfStatsSortState.key; 
                const direction = perfStatsSortState.direction === 'asc' ? 1 : -1; 
                let valA, valB; 
                if (key === 'avg') { 
                    valA = a.count > 0 ? (a.total / a.count) : -Infinity; 
                    valB = b.count > 0 ? (b.total / b.count) : -Infinity; 
                } else if (key === 'className') {
                     valA = a.className;
                     valB = b.className;
                } else { 
                    valA = a[key]; valB = b[key]; 
                } 
                if (valA < valB) return -1 * direction; 
                if (valA > valB) return 1 * direction; 
                return a.className.localeCompare(b.className); 
            }); 
            renderPerfStats(sortedStats); 
        }
        
        function renderPerfStats(stats) { 
            const container = document.getElementById('perf-results-container'); 
            document.getElementById('perf-results-title').innerHTML = '<span>æŸ¥è©¢çµæœ</span>';
            if (stats.length === 0) { container.innerHTML = '<p>æ‰¾ä¸åˆ°å¯çµ±è¨ˆçš„ç´€éŒ„ã€‚</p>'; return; } 
            const getArrow = (key) => { if (perfStatsSortState.key !== key) return '&#x25B4;&#x25BE;'; return perfStatsSortState.direction === 'asc' ? '&#x25B2;' : '&#x25BC;'; }; 
            let table = `<table><thead><tr><th class="sortable-header" data-sort-stats="className">ç­ç´š <span class="sort-arrow">${getArrow('className')}</span></th><th class="sortable-header" data-sort-stats="total">ç¸½åˆ† <span class="sort-arrow">${getArrow('total')}</span></th><th class="sortable-header" data-sort-stats="positive">ç¸½åŠ åˆ† <span class="sort-arrow">${getArrow('positive')}</span></th><th class="sortable-header" data-sort-stats="negative">ç¸½æ‰£åˆ† <span class="sort-arrow">${getArrow('negative')}</span></th><th class="sortable-header" data-sort-stats="count">äº‹ä»¶ç¸½æ•¸ <span class="sort-arrow">${getArrow('count')}</span></th><th class="sortable-header" data-sort-stats="avg">å–®æ¬¡å‡åˆ† <span class="sort-arrow">${getArrow('avg')}</span></th></tr></thead><tbody>`; 
            stats.forEach(s => { 
                const avg = s.count > 0 ? (s.total / s.count).toFixed(2) : 'N/A'; 
                table += `<tr class="drill-down-row" data-type="perf" data-value="${s.className}"><td>${s.className}</td><td>${s.total}</td><td>${s.positive}</td><td>${s.negative}</td><td>${s.count}</td><td>${avg}</td></tr>`; 
            }); 
            table += '</tbody></table>'; 
            container.innerHTML = table; 
            document.getElementById('export-perf-csv-btn').disabled = false; 
            container.querySelectorAll('.sortable-header[data-sort-stats]').forEach(header => { 
                header.addEventListener('click', () => { 
                    const sortKey = header.dataset.sortStats; 
                    if (perfStatsSortState.key === sortKey) { 
                        perfStatsSortState.direction = perfStatsSortState.direction === 'asc' ? 'desc' : 'asc'; 
                    } else { 
                        perfStatsSortState.key = sortKey; 
                        perfStatsSortState.direction = sortKey === 'className' ? 'asc' : 'desc'; 
                    } 
                    sortAndRenderPerfStats(); 
                }); 
            }); 
            container.querySelectorAll('.drill-down-row[data-type="perf"]').forEach(row => { 
                row.addEventListener('click', () => { 
                    const className = row.dataset.value; 
                    document.querySelector('input[name="perf-report-type"][value="log"]').checked = true; 
                    document.querySelector('input[name="perf-report-type"][value="log"]').dispatchEvent(new Event('change')); 
                    document.querySelectorAll('#performance-tab .class-selector').forEach(cb => { cb.checked = cb.value === className; }); 
                    document.getElementById('select-all-classes').checked = false; 
                    currentPerfResults = currentPerfStats.allRecords.filter(r => ((r.entityType === 'class' ? r.entityId : (r.entityId || r.studentId).substring(0, 3)) === className)); 
                    perfSortState = { key: 'timestamp', direction: 'desc' }; 
                    renderPerfLog(currentPerfResults, true, `ç­ç´š: ${className}`); 
                }); 
            });
        }

        document.getElementById('export-perf-csv-btn').addEventListener('click', () => {
             const reportType = document.querySelector('input[name="perf-report-type"]:checked').value;
             if (reportType === 'log') {
                 exportPerfLogCSV();
             } else {
                 if (currentPerfStats.target === 'class') {
                     exportPerfStatsCSV();
                 } else if (currentPerfStats.target === 'student') {
                     exportPerfStudentStatsCSV();
                 }
             }
        });

        function exportPerfLogCSV() { 
            if (currentPerfResults.length === 0) return; 
            let csv = "\uFEFF"; 
            csv += "æ—¥æœŸæ™‚é–“,ç­ç´š,åº§è™Ÿ,å°è±¡,åˆ†æ•¸,äº‹ç”±\r\n"; 
            const sortedForExport = [...currentPerfResults]; 
            sortedForExport.sort((a, b) => { let valA, valB; const key = perfSortState.key; const direction = perfSortState.direction === 'asc' ? 1 : -1; if (key === 'timestamp') { valA = a.timestamp.seconds; valB = b.timestamp.seconds; } else if (key === 'score') { valA = a.points || 0; valB = b.points || 0; } else if (key === 'class') { const classA = (a.entityType === 'class') ? a.entityId : (a.entityId || a.studentId).substring(0, 3); const classB = (b.entityType === 'class') ? b.entityId : (b.entityId || a.studentId).substring(0, 3); const classComparison = classA.localeCompare(classB); if (classComparison !== 0) return classComparison * direction; const idA = parseInt((a.entityType === 'student') ? (a.entityId || a.studentId) : '0', 10); const idB = parseInt((b.entityType === 'student') ? (b.entityId || b.studentId) : '0', 10); return (idA - idB); } if (valA < valB) return -1 * direction; if (valA > valB) return 1 * direction; return 0; }); 
            sortedForExport.forEach(r => { 
                const eid = r.entityId || r.studentId; 
                const type = r.entityType || 'student'; 
                const ts = r.timestamp.toDate().toLocaleString('zh-TW', { hour12: false }); 
                const cName = type === 'class' ? eid : eid.substring(0, 3); 
                const seatNum = (type === 'student') ? eid.substring(3) : ''; 
                let target = `ç­ç´š-${cName}`; 
                if (type === 'student') { const s = studentMap.get(eid); target = s ? s.name : `å­¸ç”Ÿ-${eid}`; } 
                const p = r.points || 0; 
                const t = r.text ? `"${r.text.replace(/"/g, '""')}"` : ''; 
                csv += [ts, cName, seatNum, target, p, t].join(',') + "\r\n"; 
            }); 
            downloadCSV(csv, 'performance_log_report'); 
        }
        
        function exportPerfStatsCSV() { 
            if (!currentPerfStats.stats || currentPerfStats.stats.length === 0) return; 
            let csv = "\uFEFF"; 
            csv += "ç­ç´š,ç¸½åˆ†,ç¸½åŠ åˆ†,ç¸½æ‰£åˆ†,äº‹ä»¶ç¸½æ•¸,å–®æ¬¡å‡åˆ†\r\n"; 
            const sortedForExport = [...currentPerfStats.stats]; 
            sortedForExport.sort((a, b) => { const key = perfStatsSortState.key; const direction = perfStatsSortState.direction === 'asc' ? 1 : -1; let valA, valB; if (key === 'avg') { valA = a.count > 0 ? (a.total / a.count) : -Infinity; valB = b.count > 0 ? (b.total / b.count) : -Infinity; } else { valA = a[key]; valB = b[key]; } if (valA < valB) return -1 * direction; if (valA > valB) return 1 * direction; return a.className.localeCompare(b.className); }); 
            sortedForExport.forEach(s => { 
                const avg = s.count > 0 ? (s.total / s.count).toFixed(2) : 'N/A'; 
                csv += [s.className, s.total, s.positive, s.negative, s.count, avg].join(',') + "\r\n"; 
            }); 
            downloadCSV(csv, 'performance_stats_class_report'); 
        }

        function exportPerfStudentStatsCSV() {
            if (!currentPerfStats.stats || currentPerfStats.stats.length === 0) return; 
            let csv = "\uFEFF"; 
            csv += "ç­ç´š,åº§è™Ÿ,å§“å,ç¸½åˆ†,ç¸½åŠ åˆ†,ç¸½æ‰£åˆ†,äº‹ä»¶ç¸½æ•¸,å–®æ¬¡å‡åˆ†\r\n"; 
            const sortedForExport = [...currentPerfStats.stats]; 
            sortedForExport.sort((a, b) => { 
                const key = perfStatsSortState.key;
                const direction = perfStatsSortState.direction === 'asc' ? 1 : -1;
                let valA, valB;
                if (key === 'avg') { 
                    valA = a.count > 0 ? (a.total / a.count) : -Infinity; 
                    valB = b.count > 0 ? (b.total / b.count) : -Infinity; 
                } else if (key === 'className') {
                     valA = a.className;
                     valB = b.className;
                } else if (key === 'studentId') {
                     valA = a.studentId;
                     valB = b.studentId;
                } else { 
                    valA = a[key]; 
                    valB = b[key]; 
                } 
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return valA.localeCompare(valB, 'zh-TW') * direction;
                } else {
                    if (valA < valB) return -1 * direction; 
                    if (valA > valB) return 1 * direction; 
                }
                return a.studentId.localeCompare(b.studentId);
            }); 
            
            sortedForExport.forEach(s => { 
                const avg = s.count > 0 ? (s.total / s.count).toFixed(2) : 'N/A'; 
                const seatNum = s.studentId.substring(3);
                const row = [s.className, seatNum, s.name, s.total.toFixed(1), s.positive.toFixed(1), s.negative.toFixed(1), s.count, avg]; 
                csv += row.join(',') + "\r\n"; 
            }); 
            downloadCSV(csv, 'performance_stats_student_report'); 
        }
        
        const gradesClassSelect = document.getElementById('grades-class-select'), assignmentFilterContainer = document.getElementById('assignment-filter-container'), runGradesQueryBtn = document.getElementById('run-grades-query-btn'), exportGradesCsvBtn = document.getElementById('export-grades-csv-btn'), gradesResultsContainer = document.getElementById('grades-results-container'), gradesClassSelectSingle = document.getElementById('grades-class-select-single'), gradesAssignmentSelect = document.getElementById('grades-assignment-select');
        
        gradesClassSelect.addEventListener('change', async (e) => { 
            const selectedClass = e.target.value; 
            assignmentFilterContainer.innerHTML = '<div class="class-checkbox"><input type="checkbox" id="select-all-assignments" checked><label for="select-all-assignments">å…¨é¸</label></div>'; 
            gradesResultsContainer.innerHTML = '<p>è«‹é¸æ“‡æˆç¸¾é …ç›®å¾ŒåŸ·è¡ŒæŸ¥è©¢ã€‚</p>'; 
            exportGradesCsvBtn.disabled = true; 
            if (!selectedClass) return; 
            try { 
                const assignmentsInClass = allAssignments.filter(a => a.className === selectedClass);              
                if (assignmentsInClass.length === 0) { assignmentFilterContainer.innerHTML += '<p>æ­¤ç­ç´šå°šç„¡æˆç¸¾é …ç›®ã€‚</p>'; }
                assignmentsInClass.forEach(a => { 
                    const div = document.createElement('div'); 
                    div.className = 'class-checkbox'; 
                    div.innerHTML = `<input type="checkbox" id="assign-${a.id}" value="${a.id}" data-name="${a.assignmentName}" class="assignment-selector" checked><label for="assign-${a.id}">${a.assignmentName}</label>`; 
                    assignmentFilterContainer.appendChild(div); 
                }); 
                document.getElementById('select-all-assignments').addEventListener('change', (e) => { 
                    document.querySelectorAll('.assignment-selector').forEach(checkbox => { 
                        checkbox.checked = e.target.checked; 
                    }); 
                }); 
            } catch(error) { 
                console.error("è¼‰å…¥æˆç¸¾é …ç›®å¤±æ•—:", error); 
                assignmentFilterContainer.innerHTML += `<p style="color:red;">è¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ Consoleã€‚</p>`; 
            } 
        });
        
        runGradesQueryBtn.addEventListener('click', async () => { const reportType = document.querySelector('input[name="grades-report-type"]:checked').value; if (reportType === 'student') await runGradesStudentQuery(); else if (reportType === 'assignment') await runGradesAssignmentQuery(); else if (reportType === 'cross-class') await runGradesCrossClassQuery(); });
        
        async function runGradesStudentQuery() { 
			const container = document.getElementById('grades-results-container'); 
			container.innerHTML = 'æŸ¥è©¢ä¸­...'; 
			document.getElementById('export-grades-csv-btn').disabled = true; 
			const selectedClass = gradesClassSelect.value; 
			const selectedAssignments = [...document.querySelectorAll('.assignment-selector:checked')]; 
			if (!selectedClass || selectedAssignments.length === 0) { 
				container.innerHTML = '<p style="color:red;">è«‹å…ˆé¸æ“‡ç­ç´šå’Œæˆç¸¾é …ç›®ï¼</p>'; 
				return; 
			} 
			const studentsInClass = studentsData.filter(s => s.id.startsWith(selectedClass)).sort((a,b) => parseInt(a.id) - parseInt(b.id)); 
			const assignmentIds = selectedAssignments.map(cb => cb.value); 
			try { 
				const assignmentsData = {}; 
				const promises = assignmentIds.map(id => db.collection('gradebooks').doc(currentUser.uid).collection('assignments').doc(id).get()); 
				console.log('è¼‰å…¥æˆç¸¾è³‡æ–™...');
				const assignmentSnapshots = await Promise.all(promises); 
				assignmentSnapshots.forEach(doc => { 
					if (doc.exists) { assignmentsData[doc.id] = { id: doc.id, ...doc.data() }; } 
				}); 
				currentGradesResults = { type: 'student', students: studentsInClass, assignments: Object.values(assignmentsData), data: assignmentsData }; 
				renderGradesStudentResults(currentGradesResults); 
			} catch (error) { 
				console.error("æŸ¥è©¢æˆç¸¾å¤±æ•—:", error); 
				container.innerHTML = `<p style="color:red;">æŸ¥è©¢å¤±æ•—ï¼</p>`; 
			} 
		}
        
        function renderGradesStudentResults(results) { const container = document.getElementById('grades-results-container'); document.getElementById('grades-results-title').innerHTML = `<span>æŸ¥è©¢çµæœ</span>`; const { students, assignments, data } = results; if (students.length === 0) { container.innerHTML = '<p>æ‰¾ä¸åˆ°å­¸ç”Ÿè³‡æ–™ã€‚</p>'; return; } let tableHTML = '<table><thead><tr><th>åº§è™Ÿ</th><th>å§“å</th>'; assignments.forEach(assign => { tableHTML += `<th>${assign.assignmentName}</th>`; }); tableHTML += '<th>å€‹äººå¹³å‡</th></tr></thead><tbody>'; students.forEach(student => { tableHTML += `<tr><td>${student.id.substring(3)}</td><td>${student.name}</td>`; let total = 0; const count = assignments.length; assignments.forEach(assign => { const assignmentData = data[assign.id]; const scoreInfo = assignmentData && assignmentData.scores[student.id]; let cellContent = ''; let score = 0; if (scoreInfo && scoreInfo.score !== undefined && scoreInfo.score !== null) { cellContent = scoreInfo.score; score = scoreInfo.score; if (scoreInfo.comment) { cellContent += ` (${scoreInfo.comment})`; } } else { cellContent = '<span style="color:#aaa;">-</span>'; } total += score; tableHTML += `<td>${cellContent}</td>`; }); const avg = count > 0 ? (total/count).toFixed(1) : ''; tableHTML += `<td><strong>${avg}</strong></td></tr>`; }); tableHTML += '</tbody></table>'; container.innerHTML = tableHTML; document.getElementById('export-grades-csv-btn').disabled = false; }
        
        async function runGradesAssignmentQuery(fromDrillDown = false, drillDownClass = null) { const container = document.getElementById('grades-results-container'); container.innerHTML = 'æŸ¥è©¢ä¸­...'; document.getElementById('export-grades-csv-btn').disabled = true; const selectedClass = drillDownClass || document.getElementById('grades-class-select-single').value; if (!selectedClass) { container.innerHTML = '<p style="color:red;">è«‹å…ˆé¸æ“‡ç­ç´šï¼</p>'; return; } const studentsInClass = studentsData.filter(s => s.id.startsWith(selectedClass)); try { const assignmentsInClass = allAssignments.filter(a => a.className === selectedClass); let stats = []; assignmentsInClass.forEach(a => { let studentCount = 0, totalScore = 0, maxScore = -Infinity, minScore = Infinity, passCount = 0; if (a.scores) { for(const sid in a.scores) { if (a.scores[sid].score !== undefined && a.scores[sid].score !== null) { const score = a.scores[sid].score; studentCount++; totalScore += score; if (score > maxScore) maxScore = score; if (score < minScore) minScore = score; if (score >= 60) passCount++; } } } stats.push({ assignmentName: a.assignmentName, date: a.date, studentCount, totalStudents: studentsInClass.length, avg: studentCount > 0 ? (totalScore / studentCount) : 0, max: studentCount > 0 ? maxScore : 'N/A', min: studentCount > 0 ? minScore : 'N/A', passRate: studentCount > 0 ? (passCount / studentCount) * 100 : 0 }); }); currentGradesResults = { type: 'assignment', stats: stats, fromDrillDown: fromDrillDown }; sortAndRenderGradesAssignmentStats(); } catch (error) { console.error("æŸ¥è©¢å¤±æ•—:", error); container.innerHTML = `<p style="color:red;">æŸ¥è©¢å¤±æ•—ï¼</p>`; } }
        function sortAndRenderGradesAssignmentStats() { const sortedStats = [...currentGradesResults.stats]; sortedStats.sort((a,b) => { const key = gradeAssignmentSortState.key; const direction = gradeAssignmentSortState.direction === 'asc' ? 1 : -1; let valA = a[key], valB = b[key]; if (key === 'date') { valA = a.date.seconds; valB = b.date.seconds; } if (valA < valB) return -1 * direction; if (valA > valB) return 1 * direction; return 0; }); renderGradesAssignmentStats(sortedStats, currentGradesResults.fromDrillDown); }
        function renderGradesAssignmentStats(stats, fromDrillDown = false) { 
            const container = document.getElementById('grades-results-container');
            const title = document.getElementById('grades-results-title');
            const existingBtn = title.querySelector('.back-btn');
            if(existingBtn) existingBtn.remove();
            let titleText = '<span>æŸ¥è©¢çµæœ</span>';
            if (fromDrillDown) {
                titleText += '<button class="back-btn" id="back-to-cross-class">è¿”å›è·¨ç­ç´šæ¯”è¼ƒ</button>';
            }
            title.innerHTML = titleText;
            if (fromDrillDown) {
                 document.getElementById('back-to-cross-class').addEventListener('click', () => {
                    const crossClassRadio = document.querySelector('input[name="grades-report-type"][value="cross-class"]');
                    crossClassRadio.checked = true;
                    crossClassRadio.dispatchEvent(new Event('change'));
                    runGradesCrossClassQuery();
                 });
            }
            if (stats.length === 0) { container.innerHTML = '<p>æ‰¾ä¸åˆ°æˆç¸¾é …ç›®ã€‚</p>'; return; } 
            const getArrow = (key) => { if (gradeAssignmentSortState.key !== key) return '&#x25B4;&#x25BE;'; return gradeAssignmentSortState.direction === 'asc' ? '&#x25B2;' : '&#x25BC;'; }; 
            let table = `<table><thead><tr><th class="sortable-header" data-sort-grades="assignmentName">æˆç¸¾é …ç›® <span class="sort-arrow">${getArrow('assignmentName')}</span></th><th class="sortable-header" data-sort-grades="date">æ—¥æœŸ <span class="sort-arrow">${getArrow('date')}</span></th><th>ç¹³äº¤äººæ•¸</th><th class="sortable-header" data-sort-grades="avg">ç­ç´šå¹³å‡ <span class="sort-arrow">${getArrow('avg')}</span></th><th class="sortable-header" data-sort-grades="max">æœ€é«˜åˆ† <span class="sort-arrow">${getArrow('max')}</span></th><th class="sortable-header" data-sort-grades="min">æœ€ä½åˆ† <span class="sort-arrow">${getArrow('min')}</span></th><th class="sortable-header" data-sort-grades="passRate">åŠæ ¼ç‡(%) <span class="sort-arrow">${getArrow('passRate')}</span></th></tr></thead><tbody>`; 
            stats.forEach(s => { table += `<tr><td>${s.assignmentName}</td><td>${s.date.toDate().toLocaleDateString()}</td><td>${s.studentCount}/${s.totalStudents}</td><td>${s.avg.toFixed(1)}</td><td>${s.max}</td><td>${s.min}</td><td>${s.passRate.toFixed(1)}%</td></tr>`; }); 
            table += '</tbody></table>'; 
            container.innerHTML = table; 
            document.getElementById('export-grades-csv-btn').disabled = false; 
            container.querySelectorAll('.sortable-header[data-sort-grades]').forEach(header => { header.addEventListener('click', () => { const sortKey = header.dataset.sortGrades; if (gradeAssignmentSortState.key === sortKey) { gradeAssignmentSortState.direction = gradeAssignmentSortState.direction === 'asc' ? 'desc' : 'asc'; } else { gradeAssignmentSortState.key = sortKey; gradeAssignmentSortState.direction = 'desc'; } sortAndRenderGradesAssignmentStats(); }); }); 
        }
        
        async function runGradesCrossClassQuery() { const container = document.getElementById('grades-results-container'); container.innerHTML = 'æŸ¥è©¢ä¸­...'; document.getElementById('export-grades-csv-btn').disabled = true; const selectedAssignmentName = document.getElementById('grades-assignment-select').value; if (!selectedAssignmentName) { container.innerHTML = '<p style="color:red;">è«‹å…ˆé¸æ“‡æˆç¸¾é …ç›®ï¼</p>'; return; } try { const assignmentsWithName = allAssignments.filter(a => a.assignmentName === selectedAssignmentName); let stats = []; classList.forEach(className => { const assignment = assignmentsWithName.find(a => a.className === className); if (assignment) { const studentsInClass = studentsData.filter(s => s.id.startsWith(className)); let studentCount = 0, totalScore = 0, maxScore = -Infinity, minScore = Infinity, passCount = 0; if (assignment.scores) { for(const sid in assignment.scores) { if (assignment.scores[sid].score !== undefined && assignment.scores[sid].score !== null) { const score = assignment.scores[sid].score; studentCount++; totalScore += score; if (score > maxScore) maxScore = score; if (score < minScore) minScore = score; if (score >= 60) passCount++; } } } stats.push({ className, date: assignment.date, studentCount, totalStudents: studentsInClass.length, avg: studentCount > 0 ? (totalScore / studentCount) : 0, max: studentCount > 0 ? maxScore : 'N/A', min: studentCount > 0 ? minScore : 'N/A', passRate: studentCount > 0 ? (passCount / studentCount) * 100 : 0 }); } }); currentGradesResults = { type: 'cross-class', stats: stats }; sortAndRenderGradesCrossClassStats(); } catch (error) { console.error("æŸ¥è©¢å¤±æ•—:", error); container.innerHTML = `<p style="color:red;">æŸ¥è©¢å¤±æ•—ï¼</p>`; } }
        function sortAndRenderGradesCrossClassStats() { const sortedStats = [...currentGradesResults.stats]; sortedStats.sort((a,b) => { const key = gradeCrossClassSortState.key; const direction = gradeCrossClassSortState.direction === 'asc' ? 1 : -1; let valA = a[key], valB = b[key]; if (key === 'avg') { valA = a.studentCount > 0 ? a.avg : -Infinity; valB = b.studentCount > 0 ? b.avg : -Infinity; } if (valA < valB) return -1 * direction; if (valA > valB) return 1 * direction; return 0; }); renderGradesCrossClassStats(sortedStats); }
        function renderGradesCrossClassStats(stats) { 
            const container = document.getElementById('grades-results-container'); 
            document.getElementById('grades-results-title').innerHTML = `<span>æŸ¥è©¢çµæœï¼š${document.getElementById('grades-assignment-select').value}</span>`; 
            if (stats.length === 0) { container.innerHTML = '<p>æ‰¾ä¸åˆ°æ­¤æˆç¸¾é …ç›®çš„è·¨ç­ç´šè³‡æ–™ã€‚</p>'; return; } 
            const getArrow = (key) => { if (gradeCrossClassSortState.key !== key) return '&#x25B4;&#x25BE;'; return gradeCrossClassSortState.direction === 'asc' ? '&#x25B2;' : '&#x25BC;'; }; 
            let table = `<table><thead><tr><th class="sortable-header" data-sort-cross="className">ç­ç´š <span class="sort-arrow">${getArrow('className')}</span></th><th>ç¹³äº¤äººæ•¸</th><th class="sortable-header" data-sort-cross="avg">ç­ç´šå¹³å‡ <span class="sort-arrow">${getArrow('avg')}</span></th><th class="sortable-header" data-sort-cross="max">æœ€é«˜åˆ† <span class="sort-arrow">${getArrow('max')}</span></th><th class="sortable-header" data-sort-cross="min">æœ€ä½åˆ† <span class="sort-arrow">${getArrow('min')}</span></th><th class="sortable-header" data-sort-cross="passRate">åŠæ ¼ç‡(%) <span class="sort-arrow">${getArrow('passRate')}</span></th></tr></thead><tbody>`; 
            stats.forEach(s => { 
                table += `<tr class="drill-down-row" data-type="grades" data-value="${s.className}"><td>${s.className}</td><td>${s.studentCount}/${s.totalStudents}</td><td>${s.avg.toFixed(1)}</td><td>${s.max}</td><td>${s.min}</td><td>${s.passRate.toFixed(1)}%</td></tr>`; 
            }); 
            table += '</tbody></table>'; container.innerHTML = table; document.getElementById('export-grades-csv-btn').disabled = false; container.querySelectorAll('.sortable-header[data-sort-cross]').forEach(header => { header.addEventListener('click', () => { const sortKey = header.dataset.sortCross; if (gradeCrossClassSortState.key === sortKey) { gradeCrossClassSortState.direction = gradeCrossClassSortState.direction === 'asc' ? 'desc' : 'asc'; } else { gradeCrossClassSortState.key = sortKey; gradeCrossClassSortState.direction = 'desc'; } sortAndRenderGradesCrossClassStats(); }); }); container.querySelectorAll('.drill-down-row[data-type="grades"]').forEach(row => { row.addEventListener('click', () => { const className = row.dataset.value; document.querySelector('input[name="grades-report-type"][value="assignment"]').checked = true; document.querySelector('input[name="grades-report-type"][value="assignment"]').dispatchEvent(new Event('change')); document.getElementById('grades-class-select-single').value = className; runGradesAssignmentQuery(true, className); }); }); }
        
        document.getElementById('export-grades-csv-btn').addEventListener('click', () => { const reportType = document.querySelector('input[name="grades-report-type"]:checked').value; if (reportType === 'student') exportGradesStudentCSV(); else if (reportType === 'assignment') exportGradesAssignmentStatsCSV(); else if (reportType === 'cross-class') exportGradesCrossClassStatsCSV(); });
        function exportGradesStudentCSV() { 
            const { students, assignments, data } = currentGradesResults; 
            if (students.length === 0) return; 
            let csvContent = "\uFEFF"; 
            let header = ["åº§è™Ÿ", "å§“å"]; 
            assignments.forEach(assign => header.push(assign.assignmentName)); 
            csvContent += header.join(',') + "," + "å€‹äººå¹³å‡\r\n"; 
            students.forEach(student => { 
                let row = [student.id.substring(3), student.name]; 
                let total = 0; 
                const count = assignments.length; 
                assignments.forEach(assign => { 
                    const assignmentData = data[assign.id]; 
                    const scoreInfo = assignmentData && assignmentData.scores[student.id]; 
                    let cellContent = ''; 
                    let score = 0; 
                    if (scoreInfo && scoreInfo.score !== undefined && scoreInfo.score !== null) { 
                        cellContent = scoreInfo.score; score = scoreInfo.score; 
                        if (scoreInfo.comment) { cellContent = `"${cellContent} (${scoreInfo.comment})"`; } 
                    } 
                    total += score; 
                    row.push(cellContent); 
                }); 
                const avg = count > 0 ? (total/count).toFixed(1) : ''; 
                row.push(avg); 
                csvContent += row.join(',') + "\r\n"; 
            }); 
            downloadCSV(csvContent, `grades_student_report_${document.getElementById('grades-class-select').value}`); 
        }
        function exportGradesAssignmentStatsCSV() { 
            const { stats } = currentGradesResults; if (!stats || stats.length === 0) return; 
            let csv = "\uFEFF"; 
            csv += "æˆç¸¾é …ç›®,æ—¥æœŸ,ç¹³äº¤äººæ•¸,ç­ç´šå¹³å‡,æœ€é«˜åˆ†,æœ€ä½åˆ†,åŠæ ¼ç‡(%)\r\n"; 
            stats.forEach(s => { 
                const row = [s.assignmentName, s.date.toDate().toLocaleDateString(), `${s.studentCount}/${s.totalStudents}`, s.avg.toFixed(1), s.max, s.min, s.passRate.toFixed(1)]; 
                csv += row.join(',') + "\r\n"; 
            }); 
            downloadCSV(csv, `grades_assignment_stats_${document.getElementById('grades-class-select-single').value}`); 
        }
        function exportGradesCrossClassStatsCSV() { 
            const { stats } = currentGradesResults; 
            if (!stats || stats.length === 0) return; 
            let csv = "\uFEFF"; 
            csv += "ç­ç´š,ç¹³äº¤äººæ•¸,ç­ç´šå¹³å‡,æœ€é«˜åˆ†,æœ€ä½åˆ†,åŠæ ¼ç‡(%)\r\n"; 
            stats.forEach(s => { 
                const row = [s.className, `${s.studentCount}/${s.totalStudents}`, s.avg.toFixed(1), s.max, s.min, s.passRate.toFixed(1)]; 
                csv += row.join(',') + "\r\n"; 
            }); 
            downloadCSV(csv, `grades_cross_class_stats_${document.getElementById('grades-assignment-select').value}`); 
        }
        
        function downloadCSV(csvContent, baseFileName) { const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", `${baseFileName}_${new Date().toISOString().split('T')[0]}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut().then(() => { window.location.href = 'login.html'; }); });
    </script>
</body>
</html>


