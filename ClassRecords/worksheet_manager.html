<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’å–®ç®¡ç†ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
	  window.MathJax = {
		tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
	  };
	</script>
	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
	<script type="importmap">
	  {
		"imports": {
		  "@google/generative-ai": "https://esm.run/@google/generative-ai"
		}
	  }
	</script>
	<script type="module">
	  import { GoogleGenerativeAI } from "@google/generative-ai";
	  // å°‡ SDK æ›è¼‰åˆ°å…¨åŸŸè®Šæ•¸ï¼Œè®“ä¸‹æ–¹çš„èˆŠç‰ˆ script å¯ä»¥å‘¼å«
	  window.GenAI = GoogleGenerativeAI;
	</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>
        // è¨­å®š PDF.js Worker (ä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„å®˜æ–¹ä¾†æº)
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
    </script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; }
        
        /* å­¸ç¿’å–®é è¦½å€å¡Š */
        .worksheet-preview { 
            border: 2px dashed #ccc; padding: 20px; background: #fff; 
            border-radius: 8px; min-height: 100px; 
        }
        .worksheet-input {
            border: 1px solid #ccc; padding: 4px 8px; border-radius: 4px; 
            margin: 0 5px; background-color: #fff;
        }

        /* æ‰¹æ”¹é¢æ¿æ¨£å¼ */
        .grading-panel {
            background-color: #f8fafc; border: 1px solid #e2e8f0; border-left: 4px solid #94a3b8;
            padding: 10px; margin-bottom: 20px; border-radius: 0 4px 4px 0;
            margin-top: 5px; position: relative; z-index: 10;
        }
        .grading-panel.correct { border-left-color: #22c55e; background-color: #f0fdf4; }
        .grading-panel.incorrect { border-left-color: #ef4444; background-color: #fef2f2; }
        
        .grading-radio-label {
            cursor: pointer; padding: 4px 8px; border-radius: 4px; margin-right: 10px;
            font-size: 0.9em; font-weight: bold; display: inline-flex; align-items: center;
            border: 1px solid transparent; transition: all 0.2s;
        }
        .grading-radio-label:hover { background-color: #e2e8f0; }
        
        input[type="radio"]:checked + span.btn-text-correct { color: #166534; }
        input[type="radio"]:checked + span.btn-text-incorrect { color: #991b1b; }

        /* å­¸æ ¡é¸æ“‡æ¸…å–® */
        .school-select-item { cursor: pointer; transition: all 0.2s; }
        .school-select-item:hover { background-color: #eff6ff; border-color: #3b82f6; }
		/* --- åœ¨ <style> æ¨™ç±¤å…§æœ€å¾Œé¢åŠ å…¥ä»¥ä¸‹ CSS --- */

		/* æ–°å¢ï¼šæŸ¥çœ‹é¡Œç›®æŒ‰éˆ•æ¨£å¼ */
		.view-btn {
			display: inline-flex;
			align-items: center;
			background-color: #eff6ff; /* blue-50 */
			color: #1d4ed8; /* blue-700 */
			border: 1px solid #bfdbfe; /* blue-200 */
			padding: 2px 8px;
			border-radius: 4px;
			font-size: 0.75rem; /* text-xs */
			cursor: pointer;
			margin-left: 8px;
			transition: all 0.2s;
			font-weight: bold;
			line-height: 1.5;
		}
		.view-btn:hover {
			background-color: #2563eb; /* blue-600 */
			color: white;
			border-color: #2563eb;
			z-index: 10; /* ç¢ºä¿æµ®åœ¨ä¸Šæ–¹ */
		}
		.q-id-badge {
			background-color: #f3f4f6; /* æ·ºç°åº• */
			color: #6b7280;            /* æ·±ç°å­— */
			font-size: 0.75em;
			padding: 1px 6px;
			border-radius: 4px;
			margin-right: 6px;
			border: 1px solid #e5e7eb;
			font-family: monospace;    /* ç­‰å¯¬å­—é«”ï¼Œçœ‹èµ·ä¾†åƒä»£ç¢¼ */
			flex-shrink: 0;            /* é˜²æ­¢è¢«å£“ç¸® */
		}
		/* --- æ–°å¢ï¼šæˆç¸¾å–®æ¨¡å¼æ¨£å¼ --- */
		.result-tabs-container {
			display: flex;
			border-bottom: 2px solid #e5e7eb;
			margin-bottom: 15px;
			overflow-x: auto;
		}
		.result-tab {
			padding: 10px 20px;
			cursor: pointer;
			border-bottom: 3px solid transparent;
			color: #6b7280;
			font-weight: 600;
			transition: all 0.2s;
			white-space: nowrap;
		}
		.result-tab:hover {
			color: #2563eb;
			background-color: #f3f4f6;
		}
		.result-tab.active {
			border-bottom-color: #2563eb;
			color: #2563eb;
		}
		.result-table th {
			background-color: #f9fafb;
			color: #374151;
			font-weight: bold;
			text-transform: uppercase;
			font-size: 0.75rem;
			letter-spacing: 0.05em;
		}
		.result-table td {
			border-bottom: 1px solid #e5e7eb;
		}
		.res-status-icon {
			font-size: 1.1em;
			display: inline-block;
		}
		.res-ans-truncate {
			max-width: 250px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			color: #4b5563;
			font-family: monospace;
		}
		/* --- å°ˆé¡Œæ¨¡å¼å”¯è®€æ¨£å¼ --- */
		.worksheet-readonly-input {
			background-color: #f3f4f6 !important; /* æ·ºç°åº• */
			color: #1f2937 !important;           /* æ·±ç°å­— */
			border: 1px solid #d1d5db !important;
			pointer-events: none;                /* ç¦æ­¢æ»‘é¼ é»æ“Š */
			font-weight: bold;
		}
		.worksheet-readonly-file-link {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.5rem;
			background-color: #eff6ff;
			border: 1px dashed #3b82f6;
			border-radius: 0.375rem;
			color: #2563eb;
			text-decoration: none;
			font-size: 0.875rem;
			margin-top: 0.25rem;
		}
		.worksheet-readonly-file-link:hover {
			background-color: #dbeafe;
		}
		/* --- è¦–è¦ºåŒ–ç·¨è¼¯å™¨å°ˆç”¨æ¨£å¼ (æ–°å¢) --- */
		#visual-editor-modal { z-index: 10050; } /* å±¤ç´šè¦é«˜éå…¶ä»–è¦–çª— */
		.ve-sidebar { background: #2c3e50; color: white; display: flex; flex-direction: column; }
		.ve-main { background: #ecf0f1; position: relative; display: flex; flex-direction: column; overflow: hidden; }
		.ve-canvas-wrapper { position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.2); background: white; align-self: center; margin-top: 20px; margin-bottom: 20px; }
		.ve-marker { position: absolute; border: 2px solid #e74c3c; background: rgba(231, 76, 60, 0.2); display: flex; align-items: center; justify-content: center; cursor: grab; resize: both; overflow: hidden; z-index: 10; }
		.ve-marker:hover { background: rgba(231, 76, 60, 0.4); border-color: red; }
		.ve-marker span { background: rgba(255,255,255,0.9); padding: 1px 4px; font-size: 11px; border-radius: 2px; color: #c0392b; font-weight: bold; pointer-events: none; }
		.ve-marker .del { position: absolute; top:0; right:0; background:red; color:white; width:20px; height:20px; font-size:12px; text-align:center; line-height:20px; cursor:pointer; display:none; }
		.ve-marker:hover .del { display: block; }
		#ve-popup { position: absolute; display: none; background: white; border: 1px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.3); padding: 10px; z-index: 100; border-radius: 5px; width: 280px; }
		.ve-btn-upload { position: relative; overflow: hidden; cursor: pointer; }
		.ve-btn-upload input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }		
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-view" class="container mx-auto p-4">
		<header class="flex justify-between items-center bg-white p-4 rounded shadow mb-6">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">ğŸ“š ä½œæ¥­ç®¡ç†ä¸­å¿ƒ</h1>
                    <p class="text-sm text-gray-500">
                        <span id="header-school-name" class="font-bold text-blue-600">è¼‰å…¥ä¸­...</span> | 
                        <span id="user-info">è¼‰å…¥ä¸­...</span>
                    </p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button id="force-refresh-btn" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition" title="æ‰‹å‹•å¾é›²ç«¯è¼‰å…¥æœ€æ–°è³‡æ–™">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </button>
                
                <button onclick="location.href='teacher.html'" class="text-sm text-gray-600 hover:text-blue-600 font-bold border border-gray-300 px-3 py-1 rounded bg-white">
                    è¿”å›ä¸»é 
                </button>

                <button id="logout-btn" class="text-sm text-gray-600 hover:text-red-500 font-bold border border-gray-300 px-3 py-1 rounded bg-white">
                    ç™»å‡º
                </button>
            </div>
        </header>


        <div class="flex mb-4 border-b border-gray-300 overflow-x-auto">
            <button id="btn-tab-grading" class="tab-btn px-6 py-3 text-blue-600 border-b-2 border-blue-600 font-bold hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('grading')">ğŸ“ æ‰¹æ”¹ä½œæ¥­</button>
            <button id="btn-tab-library" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('library')">ğŸ“‚ å­¸ç¿’å–®ç®¡ç†</button>
            <button id="btn-tab-assign" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('assign')">ğŸš€ ç™¼å¸ƒä»»å‹™</button>
            <button id="btn-tab-withdraw" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('withdraw')">ğŸ“Š ä»»å‹™ç®¡ç†</button>
			<button id="btn-tab-storage" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('storage')">â˜ï¸ æª”æ¡ˆç®¡ç†</button>
		</div>

        <div id="tab-grading" class="app-section-panel">
            <div class="bg-white p-6 rounded shadow max-w-5xl mx-auto">
                <h2 class="text-lg font-bold mb-6 pb-2 border-b flex items-center gap-2">
                    ğŸ“ å¾…æ‰¹æ”¹ä½œæ¥­åˆ—è¡¨
                    <span class="text-xs font-normal text-gray-500 ml-2">(é»é¸ç­ç´šé€²å…¥æ‰¹æ”¹)</span>
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-blue-50 border-b border-blue-200">
                                <th class="p-4 font-bold text-blue-800 w-1/3">å­¸ç¿’å–®åç¨±</th>
                                <th class="p-4 font-bold text-blue-800 w-2/3">ç™¼å¸ƒç­ç´š</th>
                            </tr>
                        </thead>
                        <tbody id="grading-list-body" class="text-sm">
                            <tr><td colspan="2" class="p-8 text-center text-gray-500">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

		<div id="tab-library" class="app-section-panel hidden">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

				<div class="lg:col-span-5 bg-white p-6 rounded shadow h-fit space-y-4">
					<h2 class="text-xl font-bold mb-4 border-b pb-2 flex items-center gap-2">
						â• æ–°å¢ / ç·¨è¼¯å­¸ç¿’å–®
					</h2>

					<div>
						<label class="block text-sm font-bold mb-2 text-gray-700">å­¸ç¿’å–®æ¨™é¡Œ</label>
						<input type="text" id="ws-title" class="w-full border p-2 rounded mb-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šCH2 é›»è…¦ç¡¬é«”å–®å…ƒæ¸¬é©—">
						
						<div class="flex gap-2">
							<button id="preview-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm font-bold shadow transition">
								ğŸ‘‡ é è¦½ç•«é¢
							</button>
							<button id="save-ws-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow transition">
								ğŸ’¾ å„²å­˜åˆ°é¡Œåº«
							</button>
						</div>
					</div>

					<div class="text-right">
						<button onclick="toggleSourceCodeArea()" class="text-xs text-blue-500 underline hover:text-blue-700">
							ğŸ‘ï¸ é¡¯ç¤º / éš±è— åŸå§‹ç¢¼ (HTML & JSON)
						</button>
					</div>

					<div id="source-code-area" class="hidden p-3 bg-gray-50 border rounded-lg border-gray-200 transition-all">
						<p class="text-xs text-red-500 mb-2 font-bold">â€» æ­¤å€ç”± AI è‡ªå‹•å¡«å…¥ï¼Œé€šå¸¸ä¸éœ€æ‰‹å‹•ä¿®æ”¹ã€‚</p>
						
						<label class="block text-xs font-bold mb-1 text-gray-700">HTML ç¶²é åŸå§‹ç¢¼</label>
						<textarea id="ws-html" class="w-full border p-2 rounded h-32 font-mono text-[10px] mb-2 focus:ring-2 focus:ring-blue-500 outline-none text-gray-600"></textarea>
						
						<label class="block text-xs font-bold mb-1 text-blue-600">JSON ç­”æ¡ˆå·è³‡æ–™</label>
						<textarea id="ws-json" class="w-full border p-2 rounded h-24 font-mono text-[10px] mb-2 focus:ring-2 focus:ring-blue-500 outline-none text-gray-600"></textarea>
					</div>

					<hr class="border-gray-200 my-4">

					<div class="border-2 border-indigo-100 rounded-xl p-4 bg-indigo-50/50 hover:bg-indigo-50 transition relative overflow-hidden group">
						<div class="absolute top-0 right-0 bg-indigo-500 text-white text-[10px] px-2 py-1 rounded-bl font-bold">æ¨¡å¼ 1</div>
						<h3 class="font-bold text-indigo-700 text-lg mb-1">âœ¨ AI å‰µæ„ç”Ÿæˆ</h3>
						<p class="text-xs text-gray-500 mb-3">é©åˆç„¡è¬›ç¾©ï¼Œç”± Gemini/ChatGPT ç›´æ¥ç”Ÿæˆå®Œæ•´é¡Œç›®èˆ‡ç¶²é æ’ç‰ˆã€‚</p>
						<button onclick="openMode1PromptModal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow text-sm flex items-center justify-center gap-2 transition">
							ğŸ§™â€â™‚ï¸ é–‹å•Ÿå­¸ç¿’å–®ç”Ÿæˆå™¨
						</button>
					</div>

					<div class="border-2 border-orange-100 rounded-xl p-4 bg-orange-50/50 hover:bg-orange-50 transition relative overflow-hidden group">
						<div class="absolute top-0 right-0 bg-orange-500 text-white text-[10px] px-2 py-1 rounded-bl font-bold">æ¨¡å¼ 2</div>
						<h3 class="font-bold text-orange-700 text-lg mb-1">ğŸ“‚ æª”æ¡ˆé¡Œç›®ä¸Šé›²ç«¯</h3>
						<p class="text-xs text-gray-500 mb-3">ä¸Šå‚³ PDF ç¿’ä½œï¼ŒAI è‡ªå‹•åˆ†æé¡Œç›®ã€è£åˆ‡é é¢ä¸¦ç”Ÿæˆäº’å‹•ç¶²é ã€‚</p>
						<div class="flex gap-2">
							<button onclick="openAIImportModal()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold py-2 px-2 rounded shadow text-xs flex items-center justify-center gap-2 transition transform hover:scale-[1.02]">
								ğŸª„ é–‹å•Ÿ AI è‡ªå‹•åŒ¯å…¥ç²¾éˆ
							</button>
						</div>
					</div>
				</div>                

                <div class="lg:col-span-7 space-y-6">
                    <div id="preview-area" class="hidden">
                        <div class="flex justify-between items-end mb-1">
                            <h3 class="text-sm font-bold text-gray-500">é è¦½çµæœï¼š</h3>
                            <button onclick="document.getElementById('preview-area').classList.add('hidden')" class="text-xs text-red-400 hover:text-red-600">é—œé–‰é è¦½</button>
                        </div>
                        <div id="preview-content" class="worksheet-preview shadow-inner"></div>
                    </div>
                    
                    <div class="bg-white p-6 rounded shadow min-h-[500px]">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h2 class="text-lg font-bold text-gray-800">ğŸ“œ å·²å»ºç«‹çš„å­¸ç¿’å–®</h2>
                            <button onclick="loadWorksheets(true)" class="text-xs text-blue-500 hover:underline">ğŸ”„ é‡æ–°æ•´ç†åˆ—è¡¨</button>
                        </div>
                        <div id="ws-list" class="space-y-3"><p class="text-center text-gray-500 py-4">è¼‰å…¥ä¸­...</p></div>
                    </div>
                </div>
            </div>
        </div>
		
        <div id="tab-assign" class="app-section-panel hidden">
            <div class="bg-white p-6 rounded shadow max-w-4xl mx-auto border-t-4 border-blue-500">
                <h2 class="text-lg font-bold mb-6 pb-2 border-b">ğŸš€ æ´¾ç™¼ä½œæ¥­</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">1. é¸æ“‡å­¸ç¿’å–®</label>
                        <select id="assign-ws-select" class="w-full border p-2 rounded bg-white outline-none"><option value="">è¼‰å…¥ä¸­...</option></select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">2. æˆªæ­¢æ—¥æœŸ (é¸å¡«)</label>
                        <input type="date" id="assign-deadline" class="w-full border p-2 rounded outline-none">
                    </div>
                </div>
                <div class="mt-6">
                    <label class="block text-gray-700 font-bold mb-2">3. é¸æ“‡ç­ç´š</label>
                    <div id="class-checkboxes" class="grid grid-cols-3 md:grid-cols-5 gap-3 p-4 bg-gray-50 rounded border max-h-40 overflow-y-auto"></div>
                </div>
                <div class="mt-8 text-center">
                    <button id="submit-assign-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-lg shadow-lg">ç¢ºèªç™¼å¸ƒ</button>
                </div>
            </div>
        </div>

        <div id="tab-withdraw" class="app-section-panel hidden">
            <div class="bg-white p-6 rounded shadow max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">ğŸ“Š ä»»å‹™ç®¡ç†</h2>
                    <div class="flex gap-2">
                        <button id="batch-deadline-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded shadow text-sm disabled:opacity-50">ğŸ“… ä¿®æ”¹æˆªæ­¢æ—¥</button>
                        <button id="batch-withdraw-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded shadow text-sm disabled:opacity-50">ğŸ—‘ï¸ æ’¤å›ç™¼å¸ƒ</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b border-gray-300">
                                <th class="p-3 font-bold text-gray-700 w-1/3">å­¸ç¿’å–®åç¨±</th>
                                <th class="p-3 font-bold text-gray-700 w-2/3">å·²ç™¼å¸ƒç­ç´š (å‹¾é¸ä»¥ç®¡ç†)</th>
                            </tr>
                        </thead>
                        <tbody id="assignment-table-body" class="text-sm"><tr><td colspan="2" class="p-4 text-center">è¼‰å…¥ä¸­...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
		<div id="tab-storage" class="app-section-panel hidden">
			<div class="bg-white p-6 rounded shadow max-w-5xl mx-auto border-t-4 border-purple-500">
				<div class="flex justify-between items-center mb-6">
					<div>
						<h2 class="text-lg font-bold text-gray-800">â˜ï¸ é›²ç«¯æª”æ¡ˆç¸½ç®¡</h2>
						<p class="text-sm text-gray-500">ç®¡ç†å­¸ç”Ÿä½œæ¥­æª”æ¡ˆèˆ‡æ‚¨ä¸Šå‚³çš„æ•™å­¸ç´ æåœ–ç‰‡ã€‚</p>
					</div>
					<button onclick="loadStorageAnalysis()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded shadow flex items-center gap-2 hover:shadow-lg transition">
						ğŸ”„ å…¨é¢æƒæ
					</button>
				</div>

				<h3 class="font-bold text-gray-700 mb-2 flex items-center gap-2 text-lg">
					ğŸ“‚ å­¸ç”Ÿä½œæ¥­ç¹³äº¤å€ <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">è³‡æ–™å¤¾æ¨¡å¼</span>
				</h3>
				<div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 text-sm text-yellow-800">
					<strong>èªªæ˜ï¼š</strong> æƒæ <code>uploads/</code>ã€‚è‹¥ä»»å‹™å·²åˆªé™¤ï¼Œå°æ‡‰çš„ä½œæ¥­è³‡æ–™å¤¾å³ç‚º<strong>æœªé—œè¯æª”æ¡ˆ (Orphaned)</strong>ã€‚
				</div>
				<div class="overflow-x-auto rounded border border-gray-200 mb-10">
					<table class="min-w-full text-left border-collapse">
						<thead>
							<tr class="bg-gray-100 border-b border-gray-300 text-gray-700">
								<th class="p-3 font-bold w-1/3">ä»»å‹™ ID (è³‡æ–™å¤¾)</th>
								<th class="p-3 font-bold w-1/3">ç‹€æ…‹</th>
								<th class="p-3 font-bold w-1/3 text-center">æ“ä½œ</th>
							</tr>
						</thead>
						<tbody id="storage-uploads-body" class="text-sm bg-white divide-y divide-gray-100">
							<tr><td colspan="3" class="p-6 text-center text-gray-400">è«‹é»æ“ŠæƒææŒ‰éˆ•...</td></tr>
						</tbody>
					</table>
				</div>
				<div class="flex justify-between items-end mb-2 mt-8 border-b pb-2">
					<div class="flex items-center gap-2">
						<h3 class="font-bold text-gray-700 text-lg">
							ğŸ–¼ï¸ æ•™å¸«ç´ æåœ–åº« <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">è¦–è¦ºåŒ–ç·¨è¼¯å™¨ä¸Šå‚³</span>
						</h3>
					</div>
					<button id="res-batch-del-btn" onclick="deleteSelectedResources()" class="hidden bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1.5 px-4 rounded shadow transition flex items-center gap-1">
						ğŸ—‘ï¸ åˆªé™¤é¸å–é …ç›® (<span id="res-sel-count">0</span>)
					</button>
				</div>

				<div class="bg-blue-50 border-l-4 border-blue-400 p-2 mb-2 text-xs text-blue-800">
					<strong>èªªæ˜ï¼š</strong> ç³»çµ±æœƒè‡ªå‹•æ¯”å°å­¸ç¿’å–® HTMLã€‚è‹¥åœ–ç‰‡æœªè¢«å¼•ç”¨ï¼Œå°‡æ¨™ç¤ºç‚ºã€Œ<strong>æœªä½¿ç”¨ç´ æ</strong>ã€ä¸¦å…è¨±å‹¾é¸åˆªé™¤ã€‚
				</div>

				<div class="overflow-x-auto rounded border border-gray-200 max-h-[500px] overflow-y-auto">
					<table class="min-w-full text-left border-collapse relative">
						<thead class="sticky top-0 bg-gray-100 z-10 shadow-sm">
							<tr class="text-gray-700 text-xs uppercase">
								<th class="p-2 w-10 text-center border-b border-gray-300">
									<input type="checkbox" id="res-master-chk" onchange="toggleAllResources(this)" class="cursor-pointer align-middle">
								</th>
								<th class="p-2 w-2/5 border-b border-gray-300">åœ–ç‰‡é è¦½ / æª”å</th>
								<th class="p-2 w-2/5 border-b border-gray-300">å¼•ç”¨æª¢æŸ¥</th>
								<th class="p-2 w-20 text-center border-b border-gray-300">æ“ä½œ</th>
							</tr>
						</thead>
						<tbody id="storage-resources-body" class="text-xs bg-white divide-y divide-gray-100">
							<tr><td colspan="4" class="p-6 text-center text-gray-400">è«‹é»æ“Šä¸Šæ–¹ã€Œå…¨é¢æƒæã€æŒ‰éˆ•...</td></tr>
						</tbody>
					</table>
				</div>				

			</div>
		</div>

    </div>

	<div id="view-modal" style="z-index: 100000;" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="view-modal-title" class="text-xl font-bold">é è¦½</h3>
                <button onclick="closeViewModal()" class="text-3xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow"><div id="view-modal-content" class="worksheet-preview"></div></div>
            <div class="p-4 border-t text-right"><button onclick="closeViewModal()" class="bg-gray-500 text-white px-6 py-2 rounded">é—œé–‰</button></div>
        </div>
    </div>
	
    <div id="source-code-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
		<div class="bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 max-h-[90vh] flex flex-col">
			<div class="flex justify-between items-center p-4 border-b">
				<h3 class="text-xl font-bold text-gray-800">ğŸ“ åŸå§‹ç¢¼æª¢è¦–</h3>
				<button onclick="document.getElementById('source-code-modal').classList.add('hidden')" class="text-3xl text-gray-500 hover:text-gray-800">&times;</button>
			</div>
			<div class="p-6 overflow-y-auto flex-grow space-y-6">
				<div>
					<div class="flex justify-between items-center mb-2">
						<label class="block text-sm font-bold text-gray-700">HTML åŸå§‹ç¢¼</label>
						<button onclick="copyToClipboard('view-src-html', this)" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded transition flex items-center gap-1 border border-gray-300">
							ğŸ“‹ è¤‡è£½ HTML ä»£ç¢¼
						</button>
					</div>
					<textarea id="view-src-html" class="w-full border p-3 rounded h-48 font-mono text-xs bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500" readonly></textarea>
				</div>
				<div>
					<div class="flex justify-between items-center mb-2">
						<label class="block text-sm font-bold text-blue-600">ç­”æ¡ˆå·è³‡æ–™ (JSON)</label>
						<button onclick="copyToClipboard('view-src-json', this)" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded transition flex items-center gap-1 border border-blue-200">
							ğŸ“‹ è¤‡è£½ JSON è³‡æ–™
						</button>
					</div>
					<textarea id="view-src-json" class="w-full border p-3 rounded h-48 font-mono text-xs bg-blue-50 outline-none focus:ring-2 focus:ring-blue-500" readonly></textarea>
				</div>
			</div>
			<div class="p-4 border-t text-right bg-gray-50">
				<button onclick="document.getElementById('source-code-modal').classList.add('hidden')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded shadow transition">é—œé–‰è¦–çª—</button>
			</div>
		</div>
	</div>

    <div id="deadline-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-80 p-6">
            <h3 class="text-lg font-bold mb-4">ä¿®æ”¹æˆªæ­¢æ—¥æœŸ</h3>
            <p class="text-sm text-gray-500 mb-2">è«‹é¸æ“‡æ–°çš„æˆªæ­¢æ—¥ (ç•™ç©ºç‚ºç„¡æœŸé™)ï¼š</p>
            <input type="date" id="new-deadline-input" class="w-full border p-2 rounded mb-4 outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('deadline-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded text-sm hover:bg-gray-400">å–æ¶ˆ</button>
                <button id="save-deadline-btn" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">å„²å­˜</button>
            </div>
        </div>
    </div>

	<div id="submission-list-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-40">
		<div class="bg-white rounded-lg shadow-xl w-11/12 md:w-[600px] max-h-[95vh] flex flex-col transition-all">
			
			<div class="flex justify-between items-center p-3 border-b bg-blue-50 rounded-t-lg shrink-0">
				<div>
					<h3 class="text-lg font-bold text-gray-800" id="submission-modal-title">ä½œæ¥­ç¹³äº¤æ¦‚æ³</h3>
					<p class="text-xs text-gray-500 mt-0.5" id="submission-modal-subtitle">...</p>
				</div>
				<div class="flex gap-2">
					<button id="open-analysis-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded shadow font-bold text-xs flex items-center gap-1">
						ğŸ“Š ç­ç´šç­”é¡Œåˆ†æ
					</button>
					<button onclick="document.getElementById('submission-list-modal').classList.add('hidden')" class="text-gray-500 text-2xl hover:text-gray-800 ml-3">&times;</button>
				</div>
			</div>
			
			<div class="bg-orange-50 p-2 border-b flex items-center justify-between shrink-0">
				<div class="flex items-center gap-2">
					<span class="text-xs font-bold text-orange-800">æ‰¹é‡æ“ä½œï¼š</span>
					<button id="batch-return-continue-btn" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded shadow text-xs font-bold flex items-center gap-1 transition disabled:opacity-50 disabled:cursor-not-allowed">
						â†©ï¸ ç™¼å›çºŒå¯« (è§£é–)
					</button>
				</div>
				<span class="text-[10px] text-orange-600 font-bold">â€» æ³¨æ„ï¼šç‹€æ…‹å°‡æ”¹å›è‰ç¨¿ã€‚</span>
			</div>

			<div class="flex-grow overflow-y-auto bg-white">
				<table class="min-w-full text-left border-collapse">
					<thead class="sticky top-0 z-10">
						<tr class="bg-gray-100 border-b text-sm">
							<th class="p-2 w-10 text-center">
								<input type="checkbox" id="submission-master-checkbox" class="form-checkbox h-4 w-4 text-blue-600 cursor-pointer">
							</th>
							<th class="p-2 font-bold text-gray-600 w-14">åº§è™Ÿ</th>
							<th class="p-2 font-bold text-gray-600">å§“å</th>
							<th class="p-2 font-bold text-gray-600 w-24">ç‹€æ…‹</th>
							<th class="p-2 font-bold text-gray-600 w-16 text-center">åˆ†æ•¸</th>
							<th class="p-2 font-bold text-gray-600 w-48 text-center pr-4">æ“ä½œ</th> </tr>
					</thead>
					<tbody id="submission-list-body" class="text-sm"></tbody>
				</table>
			</div>
			
			<div class="p-2 border-t bg-gray-50 text-right shrink-0">
				 <button onclick="document.getElementById('submission-list-modal').classList.add('hidden')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-1 rounded text-sm">é—œé–‰</button>
			</div>
		</div>
	</div>

	<div id="analysis-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col overflow-hidden relative">
            
            <div class="flex justify-between items-center p-4 border-b bg-purple-50">
                <div>
					<h3 id="analysis-main-title" class="text-xl font-bold text-purple-900">ğŸ“Š ç­ç´šç­”é¡Œåˆ†æ</h3>
                    <p id="analysis-subtitle" class="text-sm text-purple-600">è¼‰å…¥ä¸­...</p>
                </div>
                <button onclick="document.getElementById('analysis-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <div class="flex-grow p-4 md:p-6 overflow-hidden grid grid-cols-1 lg:grid-cols-5 gap-6 bg-gray-50">
                
                <div class="lg:col-span-2 bg-white p-5 rounded-lg shadow overflow-y-auto">
                    <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2">
                        ğŸ”¥ éŒ¯èª¤ç‡ Top 5 <span class="text-xs font-normal text-gray-500">(é­”ç‹é¡Œ)</span>
                    </h4>
                    <div id="analysis-leaderboard" class="space-y-4">
                        <p class="text-center text-gray-400 py-10">è³‡æ–™è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <div class="lg:col-span-3 bg-white p-5 rounded-lg shadow flex flex-col overflow-hidden relative">
                    
                    <div id="analysis-table-view" class="flex flex-col h-full">
                        <h4 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">ğŸ“‹ å®Œæ•´ç­”é¡Œçµ±è¨ˆè¡¨ <span class="text-xs font-normal text-gray-500">(é»æ“Šé¡Œç›®æŸ¥çœ‹åˆ†ä½ˆ)</span></h4>
                        <div class="flex-grow overflow-y-auto">
                            <table class="min-w-full text-left text-sm table-fixed">
								<thead class="bg-gray-100 text-gray-600 sticky top-0 z-10">
                                    <tr>
                                        <th class="p-3 font-bold w-5/12">é¡Œç›®</th>
                                        <th class="p-3 font-bold text-center w-1/12">äººæ•¸</th>
                                        <th class="p-3 font-bold text-center w-1/12 text-green-600">å°</th>
                                        <th class="p-3 font-bold text-center w-1/12 text-red-600">éŒ¯</th>
                                        <th class="p-3 font-bold text-center w-2/12">éŒ¯èª¤ç‡</th>
                                    </tr>
                                </thead>								
                                <tbody id="analysis-table-body" class="divide-y divide-gray-100">
                                    </tbody>
                            </table>
                        </div>
                    </div>

					<div id="analysis-chart-view" class="hidden flex flex-col h-full absolute inset-0 bg-white p-5 z-20">
						<div class="flex items-center justify-between mb-4 border-b pb-2">
							<div class="flex items-center gap-2">
								<button onclick="toggleAnalysisView('table')" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded flex items-center gap-1 transition">
									â¬…ï¸ è¿”å›åˆ—è¡¨
								</button>
								<button id="analysis-view-question-btn" class="text-sm bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-3 py-1 rounded flex items-center gap-1 transition font-bold">
									ğŸ‘ï¸ æŸ¥çœ‹é¡Œç›®å…§å®¹
								</button>
							</div>
							<h4 id="chart-question-title" class="text-md font-bold text-purple-800 truncate max-w-lg">é¡Œç›®æ¨™é¡Œ</h4>
						</div>
						<div class="flex-grow flex items-center justify-center bg-gray-50 rounded border border-gray-100 p-4 cursor-pointer" title="é»æ“ŠæŸ¥çœ‹é¡Œç›®å…§å®¹">
							<canvas id="analysis-chart"></canvas>
						</div>
					</div>
                </div>
            </div>
        </div>
    </div>

    <div id="grading-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex overflow-hidden relative">
            <div id="grading-left-panel" class="w-2/3 bg-gray-50 border-r relative transition-all duration-300 flex flex-col">
                <div class="absolute top-0 left-0 w-full flex justify-between items-start z-20 pointer-events-none">
                    <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-br-lg text-sm font-bold shadow-md pointer-events-auto border-b border-r border-blue-200">å­¸ç”Ÿä½œç­”å·</div>
                    <button onclick="document.getElementById('grading-modal').classList.add('hidden')" 
                            class="bg-gray-800 text-white px-4 py-2 rounded-bl-lg hover:bg-gray-700 pointer-events-auto shadow-md hidden flex items-center gap-2 transition" 
                            id="view-mode-close-btn">
                        <span>âœ•</span> é—œé–‰æª¢è¦–
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 pt-14"><div id="grading-worksheet-content" class="worksheet-preview bg-white shadow-sm min-h-full"></div></div>
            </div>
            <div id="grading-right-panel" class="w-1/3 flex flex-col bg-white transition-all duration-300 border-l">
                <div class="p-4 border-b bg-gray-50 shadow-sm z-10"><h3 class="text-lg font-bold text-gray-800" id="grading-student-name">å­¸ç”Ÿå§“å</h3><p class="text-xs text-gray-500">è«‹é‡å°å·¦å´é¡Œç›®é€²è¡Œ O/X æ¨™ç¤º</p></div>
                <div class="p-6 flex-grow overflow-y-auto space-y-6">
                    <div><label class="block text-gray-700 font-bold mb-2 text-lg">ç¸½åˆ† (0-100)</label><input type="number" id="grade-score" class="w-full border-2 border-blue-200 p-3 rounded-lg text-2xl font-bold text-center focus:border-blue-500 outline-none" placeholder="0"></div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">ç¸½è©•èª / å»ºè­°</label>
                        <textarea id="grade-comment" class="w-full border p-3 rounded-lg h-32 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="å¯«é»é¼“å‹µæˆ–å»ºè­°..."></textarea>
                        <div class="flex gap-2 mt-2"><button onclick="insertComment('åšå¾—å¾ˆå¥½ï¼')" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">åšå¾—å¾ˆå¥½</button><button onclick="insertComment('è«‹æª¢æŸ¥éŒ¯å­—')" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">æª¢æŸ¥éŒ¯å­—</button></div>
                    </div>
                </div>
				<div class="p-4 border-t bg-gray-50 space-y-2 z-10">
					<button id="submit-grade-btn" onclick="doGrade('graded')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow transition">
						âœ… é€å‡ºæˆç¸¾
					</button>
					
					<div class="grid grid-cols-2 gap-2">
						<button id="return-correction-btn" onclick="doGrade('needs_correction')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition">
							â†©ï¸ é€€å›è¨‚æ­£
						</button>
						
						<button onclick="confirmGradingExit()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition">
							å–æ¶ˆ
						</button>
					</div>
				</div>
        </div>
    </div>
	<div id="result-summary-modal" style="z-index: 9999;" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center">
		<div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden">
			
			<div class="bg-blue-50 p-3 border-b flex justify-between items-center shrink-0">
				<div>
					<h3 id="res-modal-title" class="text-lg font-bold text-gray-800">å­¸ç¿’å–®æ¨™é¡Œ</h3>
					<p class="text-xs text-gray-500 mt-0.5">å­¸ç”Ÿï¼š<span id="res-student-name" class="font-bold text-blue-600">--</span></p>
				</div>
				<div class="text-right">
					<div class="text-[10px] text-gray-500 uppercase font-bold">ç¸½åˆ† Score</div>
					<div id="res-total-score" class="text-3xl font-bold text-blue-600 leading-none">--</div>
				</div>
			</div>
			
			<div class="flex-grow flex flex-col p-0 overflow-hidden bg-white relative">
				
				<div id="res-tabs-area" class="result-tabs-container hidden px-4 pt-2 shrink-0 bg-white z-10"></div>
				
				<div id="res-html-view" class="worksheet-preview p-6 hidden overflow-y-auto h-full bg-white"></div>

				<div id="res-table-container" class="flex-grow overflow-y-auto px-4 pb-4 hidden h-full">
					<table class="min-w-full text-left result-table">
						<thead class="sticky top-0 bg-white z-10 shadow-sm">
							<tr class="text-sm bg-gray-50">
								<th class="p-2 w-12 text-center border-b">é¡Œè™Ÿ</th>
								<th class="p-2 border-b">é¡Œç›®åç¨±</th>
								<th class="p-2 w-16 text-center border-b">å°éŒ¯</th>
								<th class="p-2 w-1/4 border-b text-green-700">æ­£ç¢ºç­”æ¡ˆ</th>
								<th class="p-2 w-1/3 border-b">å­¸ç”Ÿä½œç­”å…§å®¹</th>
							</tr>
						</thead>
						<tbody id="res-table-body" class="text-sm">
							</tbody>
					</table>
				</div>
			</div>

			<div class="p-2 border-t bg-gray-50 text-right shrink-0">
				<button onclick="closeResultSummaryModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-4 rounded shadow transition text-sm">é—œé–‰</button>
			</div>
		</div>
	</div>
	<div id="grading-exit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-[60]">
		<div class="bg-white rounded-lg shadow-xl w-96 p-6">
			<h3 class="text-xl font-bold text-gray-800 mb-4">âš ï¸ å°šæœªé€å‡ºæˆç¸¾</h3>
			<p class="text-gray-600 mb-6">æ‚¨æ­£åœ¨æ‰¹æ”¹é€™ä»½ä½œæ¥­ï¼Œå°šæœªé€å‡ºåˆ°é›²ç«¯ã€‚è«‹å•è¦å¦‚ä½•è™•ç†ï¼Ÿ</p>        
			<div class="flex flex-col gap-3">
				<button onclick="saveDraftAndExit()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
					ğŸ’¾ æš«å­˜ä¸¦é€€å‡º <span class="text-xs font-normal opacity-80">(ä¸‹æ¬¡è¼‰å…¥)</span>
				</button>
				<button onclick="discardAndExit()" class="w-full bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 px-4 rounded transition">
					ğŸšª ç›´æ¥é€€å‡º <span class="text-xs font-normal opacity-70">(ä¸å„²å­˜)</span>
				</button>
				<button onclick="document.getElementById('grading-exit-modal').classList.add('hidden')" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded transition">
					â†©ï¸ å›åˆ°æ‰¹æ”¹
				</button>
			</div>
		</div>
	</div>	
	<div id="visual-editor-modal" class="fixed inset-0 bg-gray-900 hidden flex flex-row overflow-hidden">
		<div class="ve-sidebar w-80 p-4 shadow-lg overflow-y-auto z-20 bg-gray-900 text-white flex flex-col">
			<h2 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2 flex items-center gap-2">
				ğŸ–¼ï¸ è¦–è¦ºåŒ–ç·¨è¼¯å™¨
			</h2>
			
			<div class="mb-6 text-gray-300 text-sm space-y-3">
				<div class="bg-blue-900/50 p-3 rounded border border-blue-800">
					<p class="font-bold text-blue-300 mb-1">â„¹ï¸ æ“ä½œèªªæ˜</p>
					<p>æ­¤å…§å®¹ç”± AI è‡ªå‹•ç”Ÿæˆã€‚</p>
					<ul class="list-disc pl-4 mt-2 space-y-1 text-xs text-gray-400">
						<li>è«‹æª¢æŸ¥ä¸¦æ‹–æ›³ <span class="text-red-400 font-bold">ç´…æ¡†</span> è‡³æ­£ç¢ºä½ç½®ã€‚</li>
						<li>æ‹–æ›³å³ä¸‹è§’å¯èª¿æ•´å¤§å°ã€‚</li>
						<li>é»æ“Šç´…æ¡†å³ä¸Šè§’ X å¯åˆªé™¤ã€‚</li>
						<li>é»æ“Šåœ–ç‰‡ç©ºç™½è™•å¯æ–°å¢æ¡†ã€‚</li>
					</ul>
				</div>
			</div>

			<div class="hidden">
				<textarea id="ve-url-input"></textarea>
				<textarea id="ve-json-input"></textarea>
				<input type="file" id="ve-file-upload">
				</div>

			<div class="mt-auto pt-4 border-t border-gray-600 space-y-3">
				<button onclick="veExport()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold text-lg shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
					âœ… å®Œæˆä¸¦åŒ¯å…¥
				</button>
				<button onclick="closeVisualEditor()" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-bold transition flex items-center justify-center gap-2">
					âŒ å–æ¶ˆé—œé–‰
				</button>
			</div>
		</div>

		<div class="ve-main flex-1 flex flex-col h-full relative bg-gray-200">
			
			<div class="h-14 bg-white border-b flex items-center justify-center gap-4 px-4 shadow-md z-30 flex-shrink-0">
				<button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1.5 rounded font-bold shadow transition" onclick="vePrevPage()">â—€ ä¸Šä¸€é </button>
				<span id="ve-page-indicator" class="font-bold text-gray-700 w-32 text-center text-lg">Page 0 / 0</span>
				<button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1.5 rounded font-bold shadow transition" onclick="veNextPage()">ä¸‹ä¸€é  â–¶</button>
			</div>
			
			<div id="ve-scroll-container" class="flex-1 overflow-auto flex justify-center p-10 relative">
				
				<div id="ve-canvas-wrapper" class="ve-canvas-wrapper relative shadow-2xl bg-white self-start">
					<img id="ve-current-img" class="block max-w-none select-none pointer-events-none" style="min-width: 600px;">
				</div>

			</div>
		</div>

		<div id="ve-popup">
			<label class="block text-sm font-bold mb-1">é¸æ“‡é¡Œç›®:</label>
			<select id="ve-q-select" class="w-full border p-1 mb-2"></select>
			<div class="flex gap-2">
				<button onclick="veAddMarker()" class="bg-green-500 text-white px-3 py-1 rounded text-sm flex-1">ç¢ºå®š</button>
				<button onclick="document.getElementById('ve-popup').style.display='none'" class="bg-gray-400 text-white px-3 py-1 rounded text-sm flex-1">å–æ¶ˆ</button>
			</div>
		</div>
	</div>
	<div id="ve-library-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center z-[20000]">
		<div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 h-[80vh] flex flex-col">
			<div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
				<h3 class="text-lg font-bold text-gray-800">ğŸ“‚ é¸æ“‡åœ–ç‰‡å¼•ç”¨</h3>
				<div class="flex gap-2">
                    <button onclick="veConfirmLibrarySelection()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded font-bold shadow">ç¢ºèªé¸å– (<span id="lib-sel-count">0</span>)</button>
					<button onclick="document.getElementById('ve-library-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
				</div>
			</div>
			<div class="p-4 overflow-y-auto flex-grow bg-gray-100">
                <div id="ve-library-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <p class="col-span-full text-center text-gray-500 py-10">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
            <div class="p-2 bg-yellow-50 text-xs text-yellow-800 text-center border-t">
                åœ–ç‰‡å·²ä¾ç…§ã€Œä¸Šå‚³æ™‚é–“ã€æ’åºï¼Œå»ºè­°ä¾ç…§é ç¢¼é †åºå‹¾é¸ã€‚
            </div>
		</div>
	</div>
	<div id="ai-import-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-[70]">
		<div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
			<div class="p-4 border-b flex justify-between items-center bg-indigo-600 rounded-t-xl text-white">
				<h3 class="text-lg font-bold flex items-center gap-2">
					ğŸ¤– Gemini æ™ºæ…§åˆ†æç²¾éˆ
					<span class="text-xs bg-indigo-500 px-2 py-0.5 rounded border border-indigo-400">Powered by Gemini 2.5</span>
				</h3>
				<button onclick="closeAIImportModal()" class="text-indigo-200 hover:text-white text-2xl">&times;</button>
			</div>
			
			<div class="p-6 overflow-y-auto flex-grow space-y-6">
				
				<div class="bg-indigo-50 border-2 border-indigo-100 rounded-xl p-5 relative overflow-hidden">
					<div class="absolute top-0 right-0 bg-indigo-500 text-white text-[10px] px-2 py-1 rounded-bl font-bold">New!</div>
					<div class="flex items-center gap-2 mb-3">
						<span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">1</span>
						<label class="font-bold text-indigo-900 text-lg">ä¸Šå‚³ç¿’ä½œæª”æ¡ˆ (PDF / åœ–ç‰‡)</label>
					</div>
					
					<div class="flex gap-4 items-start">
						<div class="flex-grow">
							<label class="flex flex-col items-center justify-center w-full h-32 border-2 border-indigo-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-indigo-50 transition group">
								<div class="flex flex-col items-center justify-center pt-5 pb-6">
									<p class="mb-2 text-2xl group-hover:scale-110 transition">ğŸ“„</p>
									<p class="text-sm text-gray-500 font-bold">é»æ“Šé¸æ“‡æª”æ¡ˆ (PDF, JPG, PNG)</p>
									<p class="text-xs text-gray-400 mt-1">æ”¯æ´æ‰‹å¯«è­˜åˆ¥èˆ‡é¡Œç›®å®šä½</p>
								</div>
								<input type="file" id="gemini-upload-file" class="hidden" accept="image/*,.pdf" onchange="previewUploadFile()">
							</label>
							<div id="file-info-display" class="text-xs text-center mt-2 font-bold text-indigo-600 h-4"></div>
						</div>

						<button id="btn-run-gemini" onclick="runGeminiAnalysis()" disabled class="h-32 w-32 bg-gray-300 text-white rounded-lg font-bold flex flex-col items-center justify-center gap-2 shadow-inner transition disabled:cursor-not-allowed">
							<span class="text-2xl">âœ¨</span>
							<span>é–‹å§‹åˆ†æ</span>
						</button>
					</div>
					<p id="gemini-status" class="text-xs text-center mt-2 text-gray-500 min-h-[1.5em]"></p>
				</div>

				<div class="opacity-75 hover:opacity-100 transition">
					<div class="flex items-center gap-2 mb-2">
						<span class="bg-gray-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">2</span>
						<label class="font-bold text-gray-700">åˆ†æçµæœ (JSON è³‡æ–™)</label>
					</div>
					<textarea id="ai-json-input" class="w-full border-2 border-gray-200 p-3 rounded h-32 font-mono text-xs focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="ç­‰å¾… AI åˆ†æä¸­... (æ‚¨ä¹Ÿå¯ä»¥æ‰‹å‹•è²¼ä¸Š)"></textarea>
					<div class="text-right mt-1">
						<button onclick="parseAIJsonInput()" class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded font-bold text-gray-700">ğŸ‘‡ è®€å– JSON ä¸¦è¨­å®šåº•åœ– (ä¸‹ä¸€æ­¥)</button>
					</div>
				</div>

				<div id="ai-image-mapping-area" class="hidden border-t pt-4">
					<div class="flex items-center gap-2 mb-2">
						<span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">3</span>
						<label class="font-bold text-gray-700">è¨­å®šåº•åœ–ä¾†æº</label>
					</div>
					<p class="text-xs text-gray-500 mb-3">AI åµæ¸¬åˆ°ä»¥ä¸‹é é¢ï¼Œè«‹ç‚ºæ¯ä¸€é æä¾›åœ–ç‰‡ç¶²å€ã€‚</p>
					<div id="ai-pages-list" class="space-y-3"></div>
				</div>
			</div>

			<div class="p-4 border-t bg-gray-50 text-right rounded-b-xl">
				<button onclick="generateFromAI()" id="btn-generate-ai" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded shadow transition disabled:opacity-50 disabled:cursor-not-allowed">
					ğŸš€ åˆæˆä¸¦å¡«å…¥ç·¨è¼¯å™¨
				</button>
			</div>
		</div>
	</div>
	
	<div id="mode1-prompt-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-[80]">
		<div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]">
			
			<div class="bg-indigo-600 p-4 rounded-t-xl text-white flex justify-between items-center shrink-0">
				<h3 class="font-bold text-lg flex items-center gap-2">
					âœ¨ Mode 1: AI å‰µæ„ç”Ÿæˆ
					<span class="text-xs bg-indigo-500 border border-indigo-400 px-2 py-0.5 rounded">è®€å–æ•™æ -> è‡ªå‹•å‡ºé¡Œ</span>
				</h3>
				<button onclick="closeMode1Modal()" class="text-2xl hover:text-indigo-200">&times;</button>
			</div>

			<div class="p-6 overflow-y-auto space-y-5">
				
				<div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
					<label class="block text-indigo-900 font-bold mb-3 text-sm">1. è«‹æä¾›æ•™æå…§å®¹ (AI å°‡æ ¹æ“šæ­¤å…§å®¹å‡ºé¡Œ)</label>
					
					<div class="flex border-b border-indigo-200 mb-3">
						<button onclick="switchMode1Tab('pdf')" id="btn-m1-tab-pdf" class="px-4 py-2 text-sm font-bold text-indigo-700 border-b-2 border-indigo-600 transition">ğŸ“„ ä¸Šå‚³æ•™æ</button>
						<button onclick="switchMode1Tab('text')" id="btn-m1-tab-text" class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition">ğŸ“ ç´”æ–‡å­—è£œå……</button>
					</div>

					<div id="m1-content-pdf">
						<label class="flex flex-col items-center justify-center w-full h-24 border-2 border-indigo-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-indigo-50 transition group">
							<div class="flex flex-col items-center justify-center pt-2 pb-3">
								<p class="mb-1 text-2xl group-hover:scale-110 transition">ğŸ“‚</p>
								<p class="text-xs text-gray-500 font-bold"><span id="m1-file-name">é»æ“Šé¸æ“‡ PDF / Word / PPT æ•™æ</span></p>
								<p class="text-[10px] text-gray-400 mt-1">æ”¯æ´ .pdf, .docx, .pptx</p>
							</div>
							<input type="file" id="m1-upload-pdf" class="hidden" 
								   accept=".pdf,.docx,.pptx" 
								   onchange="document.getElementById('m1-file-name').textContent = this.files[0].name">
						</label>
					</div>

					<div id="m1-content-text" class="hidden">
						<textarea id="m1-text-input" class="w-full h-24 border p-2 rounded text-xs focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="è«‹è²¼ä¸Šèª²æ–‡ã€è¬›ç¾©å…§å®¹æˆ–ä»»ä½•æ•™å­¸æ–‡å­—..."></textarea>
					</div>
				</div>

				<div>
					<div class="flex flex-wrap items-center justify-between mb-2">
						<div class="flex items-center gap-2">
							<label class="text-gray-700 font-bold text-sm">2. è¨­å®šé¡Œå‹èˆ‡é¡Œæ•¸</label>
							<span id="m1-total-display" class="text-blue-600 font-bold text-sm bg-blue-50 px-2 py-0.5 rounded border border-blue-100">(ç›®å‰ç¸½åˆ†: 0)</span>
						</div>
						<div class="flex gap-3 text-xs bg-gray-100 p-1 rounded">
							<label class="flex items-center gap-1 cursor-pointer px-2 py-0.5 hover:bg-white rounded transition">
								<input type="radio" name="m1-calc-mode" value="total" checked onchange="toggleM1CalcMode()">
								<span class="font-bold text-gray-700">é¡Œæ•¸èˆ‡ç¸½åˆ†</span>
							</label>
							<label class="flex items-center gap-1 cursor-pointer px-2 py-0.5 hover:bg-white rounded transition">
								<input type="radio" name="m1-calc-mode" value="per_q" onchange="toggleM1CalcMode()">
								<span class="font-bold text-gray-700">é¡Œæ•¸èˆ‡æ¯é¡Œåˆ†æ•¸</span>
							</label>
						</div>
					</div>

					<div class="grid grid-cols-3 gap-4 bg-gray-50 p-3 rounded border">
						
						<div class="bg-white p-2 rounded border border-gray-200 shadow-sm">
							<div class="flex justify-between items-center mb-2 border-b border-gray-100 pb-1">
								<span class="text-xs text-gray-800 font-bold">é¸æ“‡é¡Œ</span>
								<div class="flex items-center gap-1">
									<span class="text-[10px] text-gray-400">(ç¸½åˆ†)</span>
									<input type="number" id="m1-choice-total-input" step="5" min="0" class="w-12 border p-0.5 rounded text-center text-xs font-bold text-blue-600 focus:ring-1 focus:ring-indigo-500" oninput="onM1InputChanged()">
									<span id="m1-choice-total-text" class="hidden w-12 text-center text-xs font-bold text-blue-600 bg-gray-100 rounded px-1">0</span>
								</div>
							</div>
							
							<div class="flex gap-2 items-center">
								<div class="flex-1">
									<label class="block text-[10px] text-gray-400 text-center mb-0.5">é¡Œæ•¸</label>
									<input type="number" id="m1-choice-count" class="w-full border p-1 rounded text-center text-sm focus:ring-1 focus:ring-indigo-500" oninput="onM1InputChanged()">
								</div>
								<div class="flex-1" id="m1-choice-per-wrapper">
									<label class="block text-[10px] text-gray-400 text-center mb-0.5">æ¯é¡Œåˆ†</label>
									<input type="number" id="m1-choice-per-input" class="w-full border p-1 rounded text-center text-sm font-bold text-gray-700 focus:ring-1 focus:ring-indigo-500" oninput="onM1InputChanged()">
								</div>
							</div>
						</div>

						<div class="bg-white p-2 rounded border border-gray-200 shadow-sm">
							<div class="flex justify-between items-center mb-2 border-b border-gray-100 pb-1">
								<span class="text-xs text-gray-800 font-bold">ç°¡ç­”/å¡«å……</span>
								<div class="flex items-center gap-1">
									<span class="text-[10px] text-gray-400">(ç¸½åˆ†)</span>
									<input type="number" id="m1-text-total-input" class="w-12 border p-0.5 rounded text-center text-xs font-bold text-blue-600 focus:ring-1 focus:ring-indigo-500" oninput="onM1InputChanged()">
									<span id="m1-text-total-text" class="hidden w-12 text-center text-xs font-bold text-blue-600 bg-gray-100 rounded px-1">0</span>
								</div>
							</div>
							
							<div class="flex gap-2 items-center">
								<div class="flex-1">
									<label class="block text-[10px] text-gray-400 text-center mb-0.5">é¡Œæ•¸</label>
									<input type="number" id="m1-text-count" class="w-full border p-1 rounded text-center text-sm focus:ring-1 focus:ring-indigo-500" oninput="onM1InputChanged()">
								</div>
								<div class="flex-1" id="m1-text-per-wrapper">
									<label class="block text-[10px] text-gray-400 text-center mb-0.5">æ¯é¡Œåˆ†</label>
									<input type="number" id="m1-text-per-input" class="w-full border p-1 rounded text-center text-sm font-bold text-gray-700 focus:ring-1 focus:ring-indigo-500" oninput="onM1InputChanged()">
								</div>
							</div>
						</div>

						<div class="bg-blue-50 p-2 rounded border border-blue-200 shadow-sm">
							<div class="flex justify-between items-center mb-2 border-b border-blue-200 pb-1">
								<span class="text-xs text-blue-800 font-bold">å¯¦ä½œä¸Šå‚³</span>
								<div class="flex items-center gap-1">
									<span class="text-[10px] text-blue-400">(ç¸½åˆ†)</span>
									<input type="number" id="m1-file-total-input" class="w-12 border p-0.5 rounded text-center text-xs font-bold text-blue-700 focus:ring-1 focus:ring-blue-500 bg-white" oninput="onM1InputChanged()">
									<span id="m1-file-total-text" class="hidden w-12 text-center text-xs font-bold text-blue-700 bg-white/50 rounded px-1">0</span>
								</div>
							</div>
							
							<div class="flex gap-2 items-center">
								<div class="flex-1">
									<label class="block text-[10px] text-blue-400 text-center mb-0.5">é¡Œæ•¸</label>
									<input type="number" id="m1-file-count" class="w-full border p-1 rounded text-center text-sm focus:ring-1 focus:ring-blue-500" oninput="onM1InputChanged()">
								</div>
								<div class="flex-1" id="m1-file-per-wrapper">
									<label class="block text-[10px] text-blue-400 text-center mb-0.5">æ¯é¡Œåˆ†</label>
									<input type="number" id="m1-file-per-input" class="w-full border p-1 rounded text-center text-sm font-bold text-blue-800 bg-white focus:ring-1 focus:ring-blue-500" oninput="onM1InputChanged()">
								</div>
							</div>
						</div>

					</div>
					<div class="bg-green-50 p-3 rounded-b border border-green-200 flex items-center gap-3">
						<div class="bg-green-100 p-2 rounded-full text-lg">ğŸŒŸ</div>
						<div class="flex-grow">
							<h4 class="text-sm font-bold text-green-800">ç´ é¤Šå°å‘é¡Œå‹è¨­å®š</h4>
							<p class="text-[10px] text-green-600">ç³»çµ±å°‡å¾ä¸Šè¿°çš„ã€Œé¸æ“‡é¡Œã€æˆ–ã€Œå¡«å……é¡Œã€ä¸­ï¼Œå°‡æŒ‡å®šæ•¸é‡çš„é¡Œç›®è½‰åŒ–ç‚ºé•·é¡Œå¹¹çš„æƒ…å¢ƒç´ é¤Šé¡Œã€‚</p>
						</div>
						<div class="flex items-center gap-2 bg-white px-3 py-1 rounded border border-green-200">
							<label class="text-xs font-bold text-gray-700 whitespace-nowrap">å…§å«é¡Œæ•¸:</label>
							<input type="number" id="m1-lite-count" value="1" min="0" class="w-12 border-b-2 border-green-500 text-center font-bold outline-none text-green-700 text-sm">
							<span class="text-xs text-gray-400">é¡Œ</span>
						</div>
					</div>

					<div class="mt-2 flex gap-4 items-center flex-wrap">
						 <label class="flex items-center gap-2 cursor-pointer">
							<input type="radio" name="m1-type" value="quiz" checked class="form-radio text-indigo-600" onchange="toggleM1ScoreMode('quiz')">
							<span class="text-xs font-bold text-gray-700">æ¸¬é©—æ¨¡å¼ (è‡ªå‹•é…åˆ†)</span>
						</label>
						<label class="flex items-center gap-2 cursor-pointer">
							<input type="radio" name="m1-type" value="record" class="form-radio text-indigo-600" onchange="toggleM1ScoreMode('record')">
							<span class="text-xs font-bold text-gray-700">å­¸ç¿’å–®æ¨¡å¼ (ä¸è¨ˆåˆ†)</span>
						</label>
						
						<div class="w-px h-4 bg-gray-300 mx-2"></div>
						<label class="flex items-center gap-2 cursor-pointer">
							<input type="checkbox" id="m1-enable-hint" class="form-checkbox text-orange-500">
							<span class="text-xs font-bold text-orange-700">ğŸ’¡ ç”Ÿæˆè§£é¡Œæç¤º (Hint)</span>
						</label>
						
						<div class="w-px h-4 bg-gray-300 mx-2"></div>
						<label class="flex items-center gap-2 cursor-pointer" title="å‹¾é¸å¾Œï¼Œç³»çµ±å°‡åˆ†æé¡Œç›®ä¸¦è‡ªå‹•ç”Ÿæˆé…åœ– (æœƒå¢åŠ è™•ç†æ™‚é–“)">
							<input type="checkbox" id="m1-auto-image" class="form-checkbox text-pink-500">
							<span class="text-xs font-bold text-pink-700">ğŸ¨ è‡ªå‹•ç”Ÿæˆé…åœ– (Beta)</span>
						</label>
					</div>
				</div>

				<div id="m1-status-msg" class="text-center text-xs font-bold text-gray-400 min-h-[20px]"></div>

			</div>

			<div class="p-4 bg-gray-50 rounded-b-xl text-right flex justify-end gap-2 border-t">
				<button onclick="closeMode1Modal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded font-bold text-sm transition">å–æ¶ˆ</button>
				<button id="btn-run-mode1" onclick="runMode1AI()" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-6 py-2 rounded font-bold text-sm shadow flex items-center gap-2 transition transform hover:scale-105">
					<span>ğŸš€</span> AI ç«‹å³ç”Ÿæˆå­¸ç¿’å–®
				</button>
			</div>
		</div>
	</div>

    <div id="mode2-guide-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-[80]">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]">
            <div class="bg-orange-500 p-4 rounded-t-xl text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg">ğŸ“‚ æ¨¡å¼äºŒï¼šæª”æ¡ˆæ•¸ä½åŒ–æµç¨‹</h3>
                <button onclick="document.getElementById('mode2-guide-modal').classList.add('hidden')" class="text-2xl hover:text-orange-200">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                
                <div class="bg-orange-50 p-4 rounded border-l-4 border-orange-400 text-sm space-y-2">
                    <p class="font-bold text-orange-800">Step 1: AI è§£æ (PDF/åœ–ç‰‡)</p>
                    <ul class="list-disc pl-5 text-orange-700 space-y-1">
                        <li>è¤‡è£½ä¸‹æ–¹çš„ã€Œå°ˆç”¨æç¤ºèªã€ã€‚</li>
                        <li>å‰å¾€ <strong>Gemini / ChatGPT</strong>ã€‚</li>
                        <li>ä¸Šå‚³æ‚¨çš„ <strong>PDF ç¿’ä½œæª”æˆ–åœ–ç‰‡</strong>ï¼Œè²¼ä¸Šæç¤ºèªä¸¦ç™¼é€ã€‚</li>
                    </ul>
                </div>

                <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-400 text-sm space-y-2">
                    <p class="font-bold text-blue-800">Step 2: æ ¼å¼è½‰æ› (é‡è¦ï¼)</p>
                    <ul class="list-disc pl-5 text-blue-700 space-y-1">
                        <li>AI è™•ç†å®Œå¾Œï¼Œè«‹å°‡æ‚¨çš„ PDF æª” <strong>è½‰å­˜ç‚ºåœ–ç‰‡ (JPG/PNG)</strong>ã€‚</li>
                        <li>(å› ç‚ºç¶²é ç³»çµ±èƒŒæ™¯éœ€è¦åœ–ç‰‡æ ¼å¼ï¼Œç„¡æ³•ç›´æ¥é¡¯ç¤º PDF)</li>
                        <li>å°æ’‡æ­¥ï¼šå¯ç”¨æˆªåœ–å·¥å…·æˆ–ç·šä¸Šè½‰æª”æœå‹™ã€‚</li>
                    </ul>
                </div>

                <div class="bg-green-50 p-4 rounded border-l-4 border-green-400 text-sm space-y-2">
                    <p class="font-bold text-green-800">Step 3: åŒ¯å…¥ç³»çµ±</p>
                    <ul class="list-disc pl-5 text-green-700 space-y-1">
                        <li>å›åˆ°æœ¬ç³»çµ±ï¼Œé»æ“Š <strong>ã€ŒğŸª„ é–‹å•Ÿ AI åŒ¯å…¥ç²¾éˆã€</strong>ã€‚</li>
                        <li>è²¼ä¸Š AI çµ¦æ‚¨çš„ JSONã€‚</li>
                        <li>ä¸Šå‚³ Step 2 æº–å‚™å¥½çš„åœ–ç‰‡ã€‚</li>
                        <li>ç³»çµ±å°‡è‡ªå‹•åˆæˆå­¸ç¿’å–®ã€‚</li>
                    </ul>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-1">
                        <label class="font-bold text-gray-700">ğŸ‘‡ è§£æå°ˆç”¨æç¤ºèª (å«æ‰‹å¯«/åº§æ¨™è­˜åˆ¥)</label>
                        <button onclick="copyToClipboard('m2-prompt-text', this)" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-700 transition">ğŸ“‹ è¤‡è£½</button>
                    </div>
                    <textarea id="m2-prompt-text" class="w-full h-32 border border-gray-300 rounded p-3 text-xs font-mono bg-gray-50 focus:ring-2 focus:ring-orange-500 outline-none" readonly>
# è§’è‰²
ä½ æ˜¯ä¸€ä½è³‡æ·±çš„è³‡è¨Šç§‘å­¸æ•™å¸«èˆ‡å‰ç«¯å·¥ç¨‹å¸«ï¼Œæ“…é•·å¾ PDF ç¿’ä½œä¸­æå–è©•é‡å…§å®¹ï¼Œä¸¦å°‡å…¶è½‰æ›ç‚ºã€Œè³‡æ–™ï¼ˆJSONï¼‰ã€èˆ‡ã€Œè¦–è¦ºå±¤ï¼ˆHTMLï¼‰ã€æ•´åˆçš„æ ¼å¼ã€‚

# ä»»å‹™
è«‹åˆ†æä¸Šå‚³çš„ PDF ç¿’ä½œé é¢ï¼Œè­˜åˆ¥ã€Œé¸æ“‡é¡Œã€ã€ã€Œå¡«å……é¡Œã€ã€ã€Œæ˜¯é/å‹¾é¸é¡Œã€ä»¥åŠã€Œæ‰‹å¯«/ç¹ªåœ–/è¨ˆç®—é¡Œã€ã€‚
ä½ éœ€è¦åšå…©ä»¶äº‹ï¼š
1. **è³‡æ–™æå–**ï¼šè§£æé¡Œç›®å…§å®¹èˆ‡ç­”æ¡ˆï¼Œè½‰ç‚º JSONã€‚
2. **è¦–è¦ºä½ˆå±€**ï¼šä¼°æ¸¬è©²é¡Œç›®åœ¨é é¢ä¸Šçš„ã€Œä½œç­”å€åŸŸä½ç½®ã€ï¼Œä¸¦ç”Ÿæˆå°æ‡‰çš„ HTML æ¨™ç±¤ã€‚

# æ“·å–è¦å‰‡
1. **é¡Œç›®æ‹†è§£**ï¼š
   - å«å°é¡Œçš„é¡Œç›®ï¼ˆå¦‚ 1. (1)ï¼‰éœ€æ‹†åˆ†ç‚ºç¨ç«‹ Entryã€‚
   - æ˜¯é/å‹¾é¸é¡Œè‹¥æœ‰å¤šå€‹é¸é …ï¼Œæ¯å€‹é¸é …è¦–ç‚ºç¨ç«‹çš„ True/False é¡Œç›®ã€‚

2. **é¡Œå‹åˆ¤æ–· (é—œéµ)**ï¼š
   - è‹¥é¡Œç›®å‡ºç¾ã€Œç•«å‡ºã€ã€ã€Œç¹ªè£½ã€ã€ã€Œå¯«å‡ºè¨ˆç®—éç¨‹ã€ã€ã€Œè©³è§£ã€ã€ã€Œè­‰æ˜ã€ã€ã€Œä¸Šå‚³æˆªåœ–ã€ç­‰é—œéµå­—ï¼Œè«‹æ­¸é¡ç‚º **æ‰‹å¯«/ç¹ªåœ–é¡Œ (handwriting)**ã€‚

3. **ID å‘½å (Strict)**ï¼š
   - æ ¼å¼ï¼š`p{é ç¢¼}_q{å¤§é¡Œè™Ÿ}_{å­é¡Œè™Ÿ}`
   - ä¾‹å¦‚ï¼š`p1_q2_1`ã€‚æ­¤ ID å¿…é ˆåŒæ™‚ç”¨æ–¼ JSON Key èˆ‡ HTML çš„ id å±¬æ€§ã€‚

4. **ä½ç½®ä¼°ç®— (Critical)**ï¼š
   - è«‹è§€å¯Ÿ PDF åœ–åƒï¼Œä¼°ç®—è©²é¡Œã€Œä½œç­”æ ¼/æ‹¬è™Ÿ/ç©ºç™½è™•ã€åœ¨è©²é é¢çš„**ç›¸å°ä½ç½®**ï¼ˆTop% èˆ‡ Left%ï¼‰ã€‚
   - è‹¥æ˜¯å¡«å……é¡Œï¼Œä½ç½®æ‡‰ç‚ºåº•ç·šæˆ–æ‹¬è™Ÿçš„èµ·å§‹é»ã€‚
   - è‹¥æ˜¯æ‰‹å¯«/ç¹ªåœ–é¡Œï¼Œä½ç½®æ‡‰ç‚ºè©²é¡Œé ç•™ç©ºç™½ä½œç­”å€çš„å·¦ä¸Šè§’ã€‚

# è¼¸å‡ºæ ¼å¼ (JSON çµæ§‹)
è«‹è¼¸å‡ºä¸€å€‹åŒ…å«å…©å€‹ä¸»è¦æ¬„ä½çš„ JSON ç‰©ä»¶ï¼š
1. `"questions"`: é¡Œåº«è³‡æ–™ç‰©ä»¶ã€‚
2. `"pages_html"`: æ¯ä¸€é å°æ‡‰çš„ HTML ç–ŠåŠ å±¤å­—ä¸²ã€‚

## 1. questions æ¬„ä½è¦ç¯„
Key ç‚º IDï¼ŒValue åŒ…å«ï¼š
- **unitId**: "page1", "page2"...
- **label**: é¡Œè™Ÿ+é¡Œç›®ç°¡è¿°ã€‚
- **answer**: æ¨™æº–ç­”æ¡ˆ (è‹¥ç‚ºé–‹æ”¾å¼ç¹ªåœ–é¡Œï¼Œå¯å¡« "ç•¥" æˆ– "è«‹åƒé–±è©³è§£")ã€‚
- **points**: é…åˆ† (é è¨­ é¸æ“‡4, å¡«å……5, æ˜¯é2, æ‰‹å¯«/ç¹ªåœ– 10)ã€‚
- **type**: "choice", "text", "true_false", "checkbox", "handwriting"ã€‚
- **choiceNo**: é¸æ“‡é¡Œé¸é …å­—ä¸² (éé¸æ“‡é¡Œç•™ç©º)ã€‚

## 2. pages_html æ¬„ä½è¦ç¯„
Key ç‚º "page1", "page2"...ï¼ŒValue ç‚ºè©²é é¢çš„ HTML å­—ä¸²ã€‚
HTML ç”Ÿæˆè¦å‰‡ï¼š
- å¿…é ˆæ˜¯ **ç´” HTML æ¨™ç±¤** (ä¸å« html/head/body)ã€‚
- é‡å°æ¯å€‹é¡Œç›®ç”Ÿæˆè¼¸å…¥å…ƒä»¶ï¼Œå¤–å±¤ç”¨ `&lt;div class='input-wrapper'>` åŒ…è¦†ã€‚
- **Style å±¬æ€§**ï¼šå¿…é ˆåŒ…å« `position: absolute; top: {Y}%; left: {X}%;` (æ ¹æ“šä½ çš„è¦–è¦ºä¼°ç®—)ã€‚
- **å…ƒä»¶é¡å‹å°æ‡‰**ï¼š
  - **choice (é¸æ“‡é¡Œ)**: ç”Ÿæˆ `&lt;select id="...">` åŒ…å«é¸é … A,B,C,D...
  - **text (å¡«å……é¡Œ)**: ç”Ÿæˆ `&lt;input type="text" id="...">`ã€‚
  - **true_false/checkbox**: ç”Ÿæˆ `&lt;input type="checkbox" id="...">`ã€‚
  - **handwriting (æ‰‹å¯«/ç¹ªåœ–)**: 
    å¿…é ˆç”Ÿæˆ **å…©å€‹** å…ƒç´ åœ¨åŒä¸€å€‹ div å…§ï¼š
    1. `&lt;textarea id="{ID}" class="ans-input" placeholder="å¯è¼¸å…¥æ–‡å­—èªªæ˜...">&lt;/textarea>`
    2. `&lt;label class="file-upload-btn">ğŸ“· ä¸Šå‚³ç…§ç‰‡&lt;input type="file" id="{ID}_file" name="{ID}_file" accept="image/*" style="display:none;">&lt;/label>`
       *(è¨»ï¼šè«‹ç¢ºä¿ file input çš„ name ç‚º åŸID + "_file"ï¼Œä»¥ä¾¿ç³»çµ±è­˜åˆ¥ç‚ºè£œå……æª”æ¡ˆ)*
                    </textarea>
                </div>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-xl text-right">
                <button onclick="document.getElementById('mode2-guide-modal').classList.add('hidden')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded font-bold text-sm">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>
	
	<script>
		// ==========================================
		// 1. MathJax & Helper Functions
		// ==========================================
		// è¼”åŠ©ï¼šåŸ·è¡ŒåµŒå…¥çš„ Script (å¼·åŒ–ç‰ˆï¼Œç¢ºä¿å‡½å¼è®Šæ•¸æå‡åˆ° window)
		function executeEmbeddedScripts(container) {
			const scripts = container.querySelectorAll('script');
			const promises = [];

			scripts.forEach(oldScript => {
				const newScript = document.createElement('script');
				// è¤‡è£½å±¬æ€§
				Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
				
				// è™•ç†å…§å®¹ï¼šå°‡å‡½å¼å¼·åˆ¶æ›è¼‰åˆ° window ä»¥ä¾¿ onclick å‘¼å«
				let scriptContent = oldScript.innerHTML;
				// é€™æ˜¯ç‚ºäº†é˜²æ­¢æŸäº›ç€è¦½å™¨ä½œç”¨åŸŸéš”é›¢ï¼Œé›–ç„¶æœ‰é»æš´åŠ›ä½†æœ‰æ•ˆ
				newScript.appendChild(document.createTextNode(scriptContent));
				
				oldScript.parentNode.replaceChild(newScript, oldScript);
			});
			
			// å¦‚æœæœ‰ MathJaxï¼Œé‡æ–°æ¸²æŸ“
			if (window.MathJax && window.MathJax.typesetPromise) {
				return MathJax.typesetPromise([container]).catch((err) => console.log('MathJax error:', err));
			}
			return Promise.resolve();
		}

		// è¼”åŠ©ï¼šè’é›†ç›®å‰æ‰¹æ”¹é¢æ¿çš„è³‡æ–™
		function collectCurrentGradingData() {
			const s = document.getElementById('grade-score').value;
			const c = document.getElementById('grade-comment').value;
			const gd = {};
			
			document.querySelectorAll('.grading-feedback-input').forEach(inp => {
				const n = inp.dataset.field; 
				const p = inp.closest('.grading-panel');
				const isC = p.querySelector('input[value="c"]').checked; 
				const isI = p.querySelector('input[value="i"]').checked;
				
				let finalC = null; 
				if(isC) finalC = true; 
				else if(isI) finalC = false;
				
				if(finalC !== null || inp.value.trim() !== '') {
					gd[n] = { is_correct: finalC, feedback: inp.value };
				}
			});
			
			return {
				score: s,
				comment: c,
				grading_details: gd,
				timestamp: new Date().getTime()
			};
		}

		// ==========================================
		// 2. Firebase Config & Global Vars
		// ==========================================
		const firebaseConfig = {
			apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
			authDomain: "classrecords-13902.firebaseapp.com",
			projectId: "classrecords-13902",
			storageBucket: "classrecords-13902.firebasestorage.app",
			messagingSenderId: "431747377367",
			appId: "1:431747377367:web:b157a485c59ce38091e892",
			measurementId: "G-JWTQGM9XMP"
		};
		if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
		const db = firebase.firestore();
		const auth = firebase.auth();
		const storage = firebase.storage();

		let currentUser = null;
		let currentSchoolId = null;
		let availableClasses = [];
		let worksheetsCache = {}; 
		
		let currentGradingResponseId = null;
		let currentGradingWorksheetId = null;
		let editingWorksheetId = null;
		
		// åˆ†æåœ–è¡¨ç›¸é—œ
		let analysisChartInstance = null;
		let currentAnalysisHtmlContent = ''; 
		
		const CACHE_PREFIX = 'ws_sys_cache_';

		// ==========================================
		// 3. Authentication (Shared with Login System)
		// ==========================================
		// å®šç¾©èˆ‡ login.html ç›¸åŒçš„ Key
		const USER_AUTH_KEY = 'user_auth_profile_v1';

		async function initApp() {
            // 1. æª¢æŸ¥ LocalStorage æ˜¯å¦æœ‰ç™»å…¥è³‡æ–™
            const cachedAuth = localStorage.getItem(USER_AUTH_KEY);
            
            if (!cachedAuth) {
                // ç„¡è³‡æ–™ï¼Œå°å›ç™»å…¥é 
                window.location.href = 'login.html';
                return;
            }

            try {
                const userProfile = JSON.parse(cachedAuth);
                // é©—è­‰è³‡æ–™çµæ§‹
                if (!userProfile.uid || !userProfile.userData || !userProfile.userData.schoolId) {
                    throw new Error('ä½¿ç”¨è€…è³‡æ–™ä¸å®Œæ•´');
                }

                // 2. è¨­å®šå…¨åŸŸè®Šæ•¸ (æ¨¡æ“¬ Firebase User ç‰©ä»¶çµæ§‹ä»¥ç›¸å®¹èˆŠç¨‹å¼)
                currentUser = {
                    uid: userProfile.uid,
                    email: userProfile.userData.email,
                    displayName: userProfile.userData.displayName
                };
                
                currentSchoolId = userProfile.userData.schoolId;

                // 3. æ›´æ–°ä»‹é¢é¡¯ç¤º
                // å˜—è©¦å¾ school_cache æˆ–ç›´æ¥é¡¯ç¤º IDï¼Œç¨å¾Œ analyzeClasses æœƒæ›´æ–°æ ¡å
                document.getElementById('header-school-name').textContent = 'è®€å–ä¸­...'; 
                document.getElementById('user-info').textContent = currentUser.displayName;

                // 4. å–å¾—æ­£ç¢ºçš„å­¸æ ¡åç¨± (éå¿…è¦ï¼Œä½†ç‚ºäº†ç¾è§€)
                db.collection('schools').doc(currentSchoolId).get().then(doc => {
                    if (doc.exists) {
                         document.getElementById('header-school-name').textContent = doc.data().name;
                    }
                });

                // 5. å•Ÿå‹•è³‡æ–™è¼‰å…¥ (åŸæœ¬åœ¨ onAuthStateChanged å…§çš„é‚è¼¯)
                console.log("âœ… èº«åˆ†é©—è­‰æˆåŠŸ (LocalStorage)ï¼Œé–‹å§‹è¼‰å…¥è³‡æ–™...");
                loadGradingList(); 
                loadWorksheets();
                analyzeClasses();

            } catch (e) {
                console.error("Auth Error:", e);
                localStorage.removeItem(USER_AUTH_KEY); // æ¸…é™¤å£æ‰çš„è³‡æ–™
                window.location.href = 'login.html';
            }
		}

		// åŸ·è¡Œåˆå§‹åŒ–
        initApp();

		// ğŸ› ï¸ ã€ä¿®æ”¹é–‹å§‹ã€‘ä¿®å¾©æ­»æ©Ÿå•é¡Œï¼šç§»é™¤æ‰€æœ‰ä¸å­˜åœ¨çš„æŒ‰éˆ•ç›£è½å™¨ (login-btn ç­‰)ï¼Œåªä¿ç•™ç®¡ç†ä»‹é¢éœ€è¦çš„
		// --------------------------------------------------------------------------

		// 1. ç™»å‡ºæŒ‰éˆ• (åŠ ä¸Š ? é˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æ™‚å ±éŒ¯)
		document.getElementById('logout-btn')?.addEventListener('click', () => {
            if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                localStorage.removeItem(USER_AUTH_KEY);
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                });
            }
        });

		// 2. å¼·åˆ¶é‡æ–°æ•´ç†æŒ‰éˆ•
		document.getElementById('force-refresh-btn')?.addEventListener('click', async () => {
			if(!confirm('ç¢ºå®šè¦å¾é›²ç«¯é‡æ–°ä¸‹è¼‰æœ€æ–°è³‡æ–™å—ï¼Ÿ')) return;
			const btn = document.getElementById('force-refresh-btn');
			btn.classList.add('animate-spin', 'text-blue-600'); 
			
			try {
				await Promise.all([
					loadWorksheets(true),
					loadAssignmentsData(true), 
					analyzeClasses(true)
				]);
				loadGradingList(); 
				loadAssignments();
				alert('âœ… è³‡æ–™åŒæ­¥å®Œæˆï¼');
			} catch(e) {
				alert('âŒ åŒæ­¥å¤±æ•—: ' + e.message);
			} finally {
				btn.classList.remove('animate-spin', 'text-blue-600');
			}
		});

		// 3. åˆ†é åˆ‡æ›åŠŸèƒ½ (ä¿®å¾© ReferenceErrorï¼Œç¢ºä¿ HTML æŒ‰éˆ•æ‰¾å¾—åˆ°æ­¤å‡½å¼)
		window.switchAppMenu = (tabName) => {
			// éš±è—æ‰€æœ‰å€å¡Š
			document.querySelectorAll('.app-section-panel').forEach(el => el.classList.add('hidden'));
			// é¡¯ç¤ºç›®æ¨™å€å¡Š
			document.getElementById(`tab-${tabName}`)?.classList.remove('hidden');

			// æ›´æ–°æŒ‰éˆ•æ¨£å¼
			document.querySelectorAll('.tab-btn').forEach(btn => {
				btn.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
				btn.classList.add('text-gray-500');
			});

			const targetBtn = document.getElementById(`btn-tab-${tabName}`);
			if (targetBtn) {
				targetBtn.classList.remove('text-gray-500');
				targetBtn.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
			}
			
			// åˆ‡æ›å¾Œè‡ªå‹•è¼‰å…¥è©²å€å¡Šè³‡æ–™
			if (tabName === 'grading') loadGradingList();
			if (tabName === 'withdraw') loadAssignments();
		};

		// ==========================================
		// 4. Data Fetching & Caching
		// ==========================================
		async function fetchDataWithCache(keySuffix, forceRefresh, fetcher) {
			const cacheKey = CACHE_PREFIX + keySuffix;
			let data = null;
			const cacheHead = keySuffix.split("_")[0];
			let cacheName = null;
			if (cacheHead=='ws') cacheName = 'å­¸ç¿’å–®';
			else if (cacheHead=='assign') cacheName = 'ä»»å‹™æŒ‡æ´¾';
			else cacheName = 'ç­ç´šå­¸ç”Ÿ';
			
			if (!forceRefresh) {
				const cachedJson = localStorage.getItem(cacheKey);
				if (cachedJson) {
					try {
						data = JSON.parse(cachedJson);
						console.log(`ğŸ“¦ [æœ¬åœ°å¿«å–] ${cacheName}... `);
					} catch(e) {
						console.warn('å¿«å–è§£æéŒ¯èª¤ï¼Œç§»é™¤å¿«å–:', e);
						localStorage.removeItem(cacheKey);
					}
				}
			}

			if (!data) {
				console.log(`â˜ï¸ [é›²ç«¯è¼‰å…¥] ${cacheName}...`);
				data = await fetcher();
				localStorage.setItem(cacheKey, JSON.stringify(data));
			}
			return data;
		}

		/* ğŸ› ï¸ æ–°å¢ï¼šæ™ºæ…§å‹å­¸ç¿’å–®è³‡æ–™ç²å– (Memory -> LocalStorage -> Firestore) */
		async function getSmartWorksheetData(wid) {
			// 1. æª¢æŸ¥è¨˜æ†¶é«”è®Šæ•¸ (æœ€å¿«)
			if (worksheetsCache && worksheetsCache[wid]) {
				console.log(`ğŸš€ [è¨˜æ†¶é«”å¿«å–] ç§’é–‹å­¸ç¿’å–®: ${wid}`);
				return worksheetsCache[wid];
			}

			// 2. æª¢æŸ¥ localStorage (æ¬¡å¿« - é‡å°é‡æ–°æ•´ç†å¾Œçš„æƒ…æ³)
			// å˜—è©¦å¾å®Œæ•´çš„ worksheets åˆ—è¡¨ä¸­å°‹æ‰¾
			const cacheKey = CACHE_PREFIX + 'ws_' + (currentUser ? currentUser.uid : '');
			const localStr = localStorage.getItem(cacheKey);
			if (localStr) {
				try {
					const list = JSON.parse(localStr);
					const found = list.find(item => item.id === wid);
					if (found) {
						console.log(`ğŸ“¦ [æœ¬åœ°å¿«å–] è®€å–å­¸ç¿’å–®: ${wid}`);
						worksheetsCache[wid] = found; // å›å¯«åˆ°è¨˜æ†¶é«”
						return found;
					}
				} catch (e) { console.warn('å¿«å–è§£æå¤±æ•—', e); }
			}

			// 3. æœ€å¾Œæ‰‹æ®µï¼šè®€å– Firebase (æœ€æ…¢ï¼Œä½†ä¿è­‰è³‡æ–™å­˜åœ¨)
			console.log(`â˜ï¸ [é›²ç«¯ä¸‹è¼‰] è®€å–å­¸ç¿’å–®: ${wid}`);
			const doc = await db.collection('worksheets').doc(wid).get();
			if (!doc.exists) return null;
			
			const data = doc.data();
			const formattedData = {
				id: doc.id,
				title: data.title,
				html_content: data.html_content,
				answer_key: data.answer_key
			};
			
			// æ›´æ–°è¨˜æ†¶é«”å¿«å– (ä¸å¼·åˆ¶æ›´æ–° localStorage åˆ—è¡¨ï¼Œé¿å…è³‡æ–™ä¸ä¸€è‡´ï¼Œåƒ…æš«å­˜æ–¼è¨˜æ†¶é«”)
			worksheetsCache[wid] = formattedData;
			return formattedData;
		}
		/* ğŸ› ï¸ æ–°å¢çµæŸ */

		// ==========================================
		// 6. Worksheet Management (Library)
		// ==========================================
		document.getElementById('preview-btn').addEventListener('click', () => {
			document.getElementById('view-modal-content').innerHTML = '';
			document.getElementById('view-modal').classList.add('hidden'); 
			const previewDiv = document.getElementById('preview-content');
			const htmlContent = document.getElementById('ws-html').value;
			previewDiv.innerHTML = htmlContent;
			document.getElementById('preview-area').classList.remove('hidden');
			executeEmbeddedScripts(previewDiv);
		});

		document.getElementById('save-ws-btn').addEventListener('click', async () => {
			const title = document.getElementById('ws-title').value.trim();
			const html = document.getElementById('ws-html').value.trim();
			const jsonStr = document.getElementById('ws-json').value.trim();
			
			if(!title) return alert('è«‹è¼¸å…¥æ¨™é¡Œ');
			if(!html) return alert('è«‹è¼¸å…¥å…§å®¹(HTMLåŸå§‹ç¢¼)');
			
			let answerKey = null;
			if(jsonStr) {
				try { answerKey = JSON.parse(jsonStr); } catch(e) { return alert('ç­”æ¡ˆå· JSON æ ¼å¼éŒ¯èª¤: ' + e.message); }
			}

			const btn = document.getElementById('save-ws-btn');
			btn.disabled = true;

			try {
				if (editingWorksheetId) {
					// 1. æ›´æ–°æ¨¡å¼ (Update)
					await db.collection('worksheets').doc(editingWorksheetId).update({
						title: title,
						html_content: html,
						answer_key: answerKey,
						project_state: currentEditingProjectState || null, // â˜… æ–°å¢é€™ä¸€è¡Œ
						updated_at: firebase.firestore.FieldValue.serverTimestamp()
					});
					alert('æ›´æ–°æˆåŠŸï¼');
					resetEditMode(); 
				} else {
					const dupSnap = await db.collection('worksheets')
						.where('creator_id', '==', currentUser.uid)
						.where('title', '==', title)
						.get();

					if (!dupSnap.empty) {
						if (!confirm(`å­¸ç¿’å–® "${title}" å·²å­˜åœ¨ã€‚\nç¢ºå®šè¦è¦†è“‹å®ƒå—ï¼Ÿ(é€™å°‡è®Šæˆæ›´æ–°æ¨¡å¼)`)) {
							btn.disabled = false; return;
						}
						const oldId = dupSnap.docs[0].id;
						// 2. è¦†è“‹æ¨¡å¼ (Overwrite)
						await db.collection('worksheets').doc(oldId).update({
							html_content: html, 
							answer_key: answerKey,
							project_state: currentEditingProjectState || null, // â˜… æ–°å¢é€™ä¸€è¡Œ
							created_at: firebase.firestore.FieldValue.serverTimestamp()
						});
					} else {
						// 3. æ–°å¢æ¨¡å¼ (Create)
						await db.collection('worksheets').add({
							title, 
							html_content: html, 
							answer_key: answerKey,
							creator_id: currentUser.uid, 
							project_state: currentEditingProjectState || null, // â˜… æ–°å¢é€™ä¸€è¡Œ
							created_at: firebase.firestore.FieldValue.serverTimestamp()
						});
					}
					alert('å·²å„²å­˜ï¼');
					resetEditMode(); 
				}

				document.getElementById('preview-area').classList.add('hidden');
				localStorage.removeItem(CACHE_PREFIX + 'ws_' + currentUser.uid);
				loadWorksheets(true);

			} catch(e) { 
				console.error(e);
				alert('æ“ä½œå¤±æ•—: ' + e.message); 
			} finally {
				btn.disabled = false;
			}
		});

		async function loadWorksheets(force = false) {
			const listEl = document.getElementById('ws-list');
			const selectEl = document.getElementById('assign-ws-select');
			
			const items = await fetchDataWithCache('ws_' + currentUser.uid, force, async () => {
				const snap = await db.collection('worksheets').where('creator_id', '==', currentUser.uid).orderBy('created_at', 'desc').get();
				const res = [];
				snap.forEach(doc => {
					const d = doc.data();
					res.push({
						id: doc.id,
						title: d.title,
						html_content: d.html_content,
						answer_key: d.answer_key,
						project_state: d.project_state,
						created_at_iso: d.created_at ? d.created_at.toDate().toISOString() : new Date().toISOString()
					});
				});
				return res;
			});

			listEl.innerHTML = ''; selectEl.innerHTML = '<option value="">è«‹é¸æ“‡å­¸ç¿’å–®...</option>'; worksheetsCache = {};
			
			if (items.length === 0) { listEl.innerHTML = '<p class="text-center text-gray-500 py-4">ç„¡è³‡æ–™</p>'; return; }
			
			items.forEach(data => {
				worksheetsCache[data.id] = data; 
				
				const dateObj = new Date(data.created_at_iso);
				const dateStr = dateObj.toLocaleString('zh-TW', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
				const item = document.createElement('div');
				item.className = 'flex justify-between items-center p-4 border rounded bg-white shadow-sm';
				item.innerHTML = `
					<div>
						<div class="font-bold text-gray-700">ğŸ“„ ${data.title}</div>
						<div class="text-xs text-gray-400 mt-1">å»ºç«‹æ–¼ï¼š${dateStr}</div>
					</div>
					<div class="space-x-2">
						<button class="bg-orange-100 text-orange-600 px-3 py-1 rounded text-sm font-bold hover:bg-orange-200" onclick="editWorksheet('${data.id}')">âœï¸ ç·¨è¼¯</button>
						<button class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-sm font-bold hover:bg-yellow-200" onclick="renameWorksheet('${data.id}', '${data.title}')">âœï¸ æ”¹å</button>
						<button class="bg-purple-100 text-purple-600 px-3 py-1 rounded text-sm font-bold hover:bg-purple-200" onclick="viewSourceCode('${data.id}')">ğŸ“ åŸå§‹ç¢¼</button>
						<button class="bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm font-bold hover:bg-blue-200" onclick="viewWorksheet('${data.id}')">ğŸ‘ï¸ é è¦½</button>
						<button class="bg-red-100 text-red-500 px-3 py-1 rounded text-sm font-bold hover:bg-red-200" onclick="deleteWorksheet('${data.id}')">åˆªé™¤</button>
					</div>`;

				listEl.appendChild(item);
				const opt = document.createElement('option'); opt.value = data.id; opt.textContent = data.title; selectEl.appendChild(opt);
			});
		}
		
		// ğŸ› ï¸ [ä¿®æ”¹é–‹å§‹] editWorksheet: ç·¨è¼¯æ™‚å±•é–‹åŸå§‹ç¢¼
		window.editWorksheet = (id) => {
			const data = worksheetsCache[id];
			if (!data) return alert('æ‰¾ä¸åˆ°å¿«å–è³‡æ–™ï¼Œè«‹å˜—è©¦é‡æ–°æ•´ç†é é¢');

			currentEditingProjectState = data.project_state || null;
			
			document.getElementById('ws-title').value = data.title;
			document.getElementById('ws-html').value = data.html_content;
			
			const jsonStr = data.answer_key ? JSON.stringify(data.answer_key, null, 4) : '';
			document.getElementById('ws-json').value = jsonStr;

			editingWorksheetId = id;

			// âœ¨ æ–°å¢ï¼šç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œè‡ªå‹•å±•é–‹åŸå§‹ç¢¼å€å¡Šä»¥ä¾¿æŸ¥çœ‹
			document.getElementById('source-code-area').classList.remove('hidden');

			const saveBtn = document.getElementById('save-ws-btn');
			saveBtn.textContent = 'ğŸ’¾ æ›´æ–°å­¸ç¿’å–® (ç·¨è¼¯ä¸­)';
			saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
			saveBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
			
			document.getElementById('tab-library').scrollIntoView({ behavior: 'smooth' });
			alert('å·²è¼‰å…¥å…§å®¹ï¼\n\nè«‹åœ¨ä¸Šæ–¹ç·¨è¼¯å€ä¿®æ”¹ HTML æˆ– JSONï¼Œ\nå®Œæˆå¾ŒæŒ‰æ©˜è‰²çš„ã€Œæ›´æ–°å­¸ç¿’å–®ã€æŒ‰éˆ•ã€‚');
		};
		// ğŸ› ï¸ [ä¿®æ”¹çµæŸ]

		function resetEditMode() {
			editingWorksheetId = null;
			document.getElementById('ws-title').value = '';
			document.getElementById('ws-html').value = '';
			document.getElementById('ws-json').value = '';
			
			const saveBtn = document.getElementById('save-ws-btn');
			saveBtn.textContent = 'å„²å­˜åˆ°é¡Œåº«';
			saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
			saveBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
		}

		window.renameWorksheet = async (id, oldTitle) => {
			const newTitle = prompt('è«‹è¼¸å…¥æ–°çš„æ¨™é¡Œï¼š', oldTitle);
			if (newTitle && newTitle.trim() !== '' && newTitle !== oldTitle) {
				try {
					await db.collection('worksheets').doc(id).update({ title: newTitle.trim() });
					localStorage.removeItem(CACHE_PREFIX + 'ws_' + currentUser.uid);
					loadWorksheets(true);
				} catch (e) { alert('æ›´æ–°å¤±æ•—: ' + e.message); }
			}
		};

		window.viewWorksheet = (id) => {
			document.getElementById('preview-content').innerHTML = '';
			document.getElementById('preview-area').classList.add('hidden');
			const data = worksheetsCache[id]; if(!data) return;
			document.getElementById('view-modal-title').textContent = data.title;
			const contentDiv = document.getElementById('view-modal-content');
			contentDiv.innerHTML = data.html_content;
			executeEmbeddedScripts(contentDiv);
			document.getElementById('view-modal').classList.remove('hidden');
		};
		window.closeViewModal = () => document.getElementById('view-modal').classList.add('hidden');
		
		window.deleteWorksheet = async (id) => {
			if(!confirm('âš ï¸ è­¦å‘Šï¼šåˆªé™¤é€™ä»½å­¸ç¿’å–®ï¼Œå°‡æœƒä¸€ä½µã€Œæ’¤å›ã€æ‰€æœ‰å·²æ´¾ç™¼çµ¦å­¸ç”Ÿçš„ä»»å‹™ï¼\n\nç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) return;
			const btn = event.target; const originalText = btn.textContent;
			btn.textContent = 'åˆªé™¤ä¸­...'; btn.disabled = true;
			try {
				const batch = db.batch();
				batch.delete(db.collection('worksheets').doc(id));
				const assignSnap = await db.collection('assignments').where('worksheet_id', '==', id).get();
				assignSnap.forEach(doc => { batch.delete(doc.ref); });
				await batch.commit();
				alert(`åˆªé™¤æˆåŠŸï¼`);
				
				localStorage.removeItem(CACHE_PREFIX + 'ws_' + currentUser.uid);
				localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
				
				loadWorksheets(true); 
				loadAssignmentsData(true).then(() => {
					loadAssignments(); 
					loadGradingList();
				});

			} catch(e) {
				console.error(e); alert('åˆªé™¤å¤±æ•—: ' + e.message);
				btn.textContent = originalText; btn.disabled = false;
			}
		};

		// ==========================================
		// 7. Assignment (Class) Management
		// ==========================================
		async function analyzeClasses(force = false) {
			const container = document.getElementById('class-checkboxes');
			
			const classes = await fetchDataWithCache('classes_' + currentSchoolId, force, async () => {
				const s = await db.collection('schools').doc(currentSchoolId).collection('students').get();
				const set = new Set();
				s.forEach(d => { if(d.data().class_id) set.add(d.data().class_id); });
				return Array.from(set).sort();
			});
			
			availableClasses = classes;
			if(classes.length === 0) { container.innerHTML = '<p class="text-red-500 col-span-full text-center">ç„¡å­¸ç”Ÿè³‡æ–™</p>'; return; }

			const groups = {};
			classes.forEach(cls => {
				const grade = cls.charAt(0);
				if (!groups[grade]) groups[grade] = [];
				groups[grade].push(cls);
			});

			container.innerHTML = '';
			container.className = "p-4 bg-gray-50 rounded border max-h-60 overflow-y-auto space-y-4"; 

			Object.keys(groups).sort().forEach(grade => {
				const clsList = groups[grade];
				const section = document.createElement('div');
				section.className = "border-b border-gray-200 pb-2 last:border-0";
				const header = document.createElement('div');
				header.className = "flex items-center mb-2";
				header.innerHTML = `<label class="flex items-center space-x-2 cursor-pointer select-none"><input type="checkbox" class="grade-master-checkbox form-checkbox h-4 w-4 text-blue-600 rounded border-gray-400" data-grade="${grade}" onchange="toggleGradeGroup(this)"><span class="font-bold text-gray-800 text-sm">${grade} å¹´ç´š (${clsList.length} ç­)</span></label>`;
				section.appendChild(header);
				const grid = document.createElement('div');
				grid.className = "grid grid-cols-4 md:grid-cols-5 gap-2"; 
				clsList.forEach(cls => {
					grid.innerHTML += `<label class="flex items-center space-x-1 cursor-pointer p-1 hover:bg-blue-100 rounded transition select-none"><input type="checkbox" name="target_class" value="${cls}" class="grade-${grade}-item form-checkbox h-4 w-4 text-blue-500 rounded border-gray-300"><span class="text-gray-700 text-sm font-medium">${cls}</span></label>`;
				});
				section.appendChild(grid);
				container.appendChild(section);
			});
		}
		window.toggleGradeGroup = (btn) => {
			document.querySelectorAll(`.grade-${btn.dataset.grade}-item`).forEach(cb => cb.checked = btn.checked);
		};

		document.getElementById('submit-assign-btn').addEventListener('click', async () => {
			const selectEl = document.getElementById('assign-ws-select');
			const deadlineEl = document.getElementById('assign-deadline');
			
			const wid = selectEl.value;
			const dead = deadlineEl.value;
			const cls = Array.from(document.querySelectorAll('input[name="target_class"]:checked')).map(c => c.value);
			
			if(!wid || cls.length === 0) return alert('è«‹é¸æ“‡å­¸ç¿’å–®èˆ‡ç­ç´š');
			
			const btn = document.getElementById('submit-assign-btn');
			const originalText = btn.textContent;
			btn.disabled = true; 
			btn.textContent = 'è™•ç†ä¸­...';

			const wtitle = document.querySelector(`#assign-ws-select option[value="${wid}"]`).textContent;

			try {
				const checkPromises = cls.map(async (className) => {
					const snapshot = await db.collection('assignments')
						.where('worksheet_id', '==', wid)
						.where('target_class', '==', className)
						.where('school_id', '==', currentSchoolId)
						.limit(1)
						.get();
					return { className, snapshot };
				});

				const results = await Promise.all(checkPromises);
				const batch = db.batch();
				let updatedCount = 0;
				let createdCount = 0;

				results.forEach(({ className, snapshot }) => {
					if (!snapshot.empty) {
						const docRef = snapshot.docs[0].ref;
						batch.update(docRef, {
							deadline: dead,
							worksheet_title: wtitle,
							updated_at: firebase.firestore.FieldValue.serverTimestamp()
						});
						updatedCount++;
					} else {
						const newRef = db.collection('assignments').doc();
						batch.set(newRef, {
							worksheet_id: wid, 
							worksheet_title: wtitle, 
							target_class: className,
							teacher_id: currentUser.uid, 
							school_id: currentSchoolId, 
							deadline: dead,
							status: 'published', 
							created_at: firebase.firestore.FieldValue.serverTimestamp()
						});
						createdCount++;
					}
				});

				await batch.commit(); 
				
				let msg = 'æ“ä½œæˆåŠŸï¼\n';
				if (createdCount > 0) msg += `âœ… æ–°ç™¼å¸ƒçµ¦ ${createdCount} å€‹ç­ç´š\n`;
				if (updatedCount > 0) msg += `ğŸ”„ æ›´æ–°äº† ${updatedCount} å€‹ç­ç´šçš„ä»»å‹™è¨­å®š`;
				alert(msg);

				localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
				await loadAssignmentsData(true);
				loadAssignments(); 
				loadGradingList();

				selectEl.value = ''; 
				deadlineEl.value = ''; 
				document.querySelectorAll('input[name="target_class"]').forEach(cb => cb.checked = false);
				document.querySelectorAll('.grade-master-checkbox').forEach(cb => cb.checked = false);

				switchAppMenu('withdraw'); 

			} catch(e) { 
				console.error(e);
				alert('ç™¼å¸ƒå¤±æ•—: ' + e.message); 
			} finally {
				btn.disabled = false;
				btn.textContent = originalText;
			}
		});
		
		async function loadAssignments() {
			const tb = document.getElementById('assignment-table-body');
			const items = await loadAssignmentsData(); 
			
			tb.innerHTML = '';
			if(items.length === 0) { tb.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-500">ç„¡ç´€éŒ„</td></tr>'; return; }
			
			const g = {};
			items.forEach(i => {
				if(!g[i.title]) g[i.title] = [];
				g[i.title].push(i);
			});

			Object.keys(g).forEach(t => {
				const list = g[t];
				let lastPubStr = 'æœªçŸ¥';
				if (list.length > 0) {
					const dates = list.map(i => i.created_at_iso).filter(d => d).sort();
					if (dates.length > 0) {
						const lastIso = dates[dates.length - 1];
						const dateObj = new Date(lastIso);
						lastPubStr = dateObj.toLocaleString('zh-TW', { 
							hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' 
						});
					}
				}

				list.sort((a,b) => a.target_class.localeCompare(b.target_class));
				
				const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-gray-50';
				const tdTitle = document.createElement('td'); tdTitle.className = "p-3 align-top";
				
				tdTitle.innerHTML = `
					<div class="flex flex-col gap-1">
						<span class="font-bold text-gray-800 text-lg">${t}</span>
						<span class="text-xs text-gray-500 font-mono tracking-wide">ğŸ•’ æœ€å¾Œç™¼å¸ƒï¼š${lastPubStr}</span>
						<label class="inline-flex items-center text-xs text-gray-400 cursor-pointer select-none hover:text-blue-600 transition w-fit mt-1">
							<input type="checkbox" class="form-checkbox h-3 w-3 text-blue-500 mr-1 rounded border-gray-300" onchange="toggleGroup(this)">
							å…¨é¸ / å…¨å–æ¶ˆ
						</label>
					</div>`;
				
				const tdClasses = document.createElement('td'); tdClasses.className = "p-3 align-top";
				let clsHtml = '';
				list.forEach(i => {
					const deadInfo = i.deadline ? `<span class="text-red-500 ml-1 font-bold">æœŸé™:${i.deadline.slice(5)}</span>` : '<span class="text-green-500 ml-1">ç„¡æœŸé™</span>';
					clsHtml += `<label class="inline-flex items-center mr-3 mb-2 bg-white px-3 py-1.5 rounded border border-gray-200 shadow-sm hover:bg-blue-50 hover:border-blue-200 cursor-pointer select-none transition"><input type="checkbox" class="withdraw-checkbox form-checkbox h-4 w-4 text-red-500 mr-2 rounded border-gray-300 focus:ring-red-500" value="${i.id}"><span class="font-bold text-gray-700">${i.target_class} ç­</span><span class="text-xs text-gray-500 ml-1">(${deadInfo})</span></label>`;
				});
				tdClasses.innerHTML = clsHtml;
				tr.appendChild(tdTitle); tr.appendChild(tdClasses); tb.appendChild(tr);
			});
		}

		async function loadAssignmentsData(force = false) {
			return await fetchDataWithCache('assign_' + currentUser.uid, force, async () => {
				const s = await db.collection('assignments')
					.where('teacher_id', '==', currentUser.uid)
					.orderBy('created_at', 'desc')
					.get();
				
				const res = [];
				s.forEach(d => {
					const data = d.data();
					res.push({
						id: d.id,
						worksheet_id: data.worksheet_id,
						title: data.worksheet_title || 'æœªå‘½å',
						target_class: data.target_class,
						deadline: data.deadline,
						created_at_iso: data.created_at ? data.created_at.toDate().toISOString() : null
					});
				});
				return res;
			});
		}

		// ==========================================
		// 8. Grading & Submission Lists
		// ==========================================
		async function loadGradingList() {
			const tb = document.getElementById('grading-list-body');
			
			const items = await loadAssignmentsData(); 
			
			tb.innerHTML = '';
			if(items.length === 0) { tb.innerHTML = '<tr><td colspan="2" class="p-8 text-center text-gray-500">ç›®å‰ç„¡ç™¼å¸ƒä½œæ¥­</td></tr>'; return; }
			
			const g = {};
			items.forEach(i => {
				if(!g[i.title]) g[i.title] = [];
				g[i.title].push(i);
			});

			const titles = Object.keys(g);
			for (const t of titles) {
				const list = g[t].sort((a,b) => a.target_class.localeCompare(b.target_class));
				const tr = document.createElement('tr'); 
				tr.className = 'border-b hover:bg-blue-50';
				
				const firstTask = list[0]; 
				const worksheetId = firstTask.worksheet_id;
				const allAssignmentIds = list.map(item => item.id);

				const titleHtml = `
					<div class="flex flex-col gap-2">
						<span class="font-bold text-gray-800 text-lg align-middle">${t}</span>
						<button onclick="openOverallAnalysis('${worksheetId}', '${encodeURIComponent(JSON.stringify(allAssignmentIds))}', '${t} (å…¨é«”)')" 
								class="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-1.5 rounded border border-indigo-200 w-fit flex items-center gap-1 transition">
							ğŸ“Š æ•´é«”åˆ†æ (${list.length} å€‹ç­ç´š)
						</button>
					</div>
				`;

				const classPromises = list.map(async (i) => {
					const q = await db.collection('responses').where('assignment_id', '==', i.id).get();
					let sub = 0; let corr = 0;
					q.forEach(d => {
						const st = d.data().status;
						if(st === 'submitted') sub++;
						if(st === 'needs_correction') corr++;
					});
					
					const hasPending = (sub > 0 || corr > 0);
					const badgeClass = hasPending ? 'bg-red-100 text-red-700 border-red-200 font-bold' : 'bg-gray-100 text-gray-400 border-gray-200';
					const btnBorder = hasPending ? 'border-blue-400 ring-2 ring-blue-100' : 'border-gray-200';

					return `
						<button onclick="openSubmissionList('${i.id}', '${i.target_class}', '${i.worksheet_id}', '${i.title}')" 
								class="m-1 bg-white hover:bg-white hover:shadow-lg border ${btnBorder} px-3 py-2 rounded shadow-sm transition flex flex-col items-center justify-center min-w-[110px] group">
							<span class="font-bold text-blue-700 text-base mb-1 group-hover:text-blue-900">ğŸ« ${i.target_class} ç­</span>
							<span class="text-xs px-2 py-0.5 rounded border ${badgeClass} w-full text-center">
								å·²äº¤: ${sub} | è¨‚æ­£: ${corr}
							</span>
						</button>`;
				});

				const buttonsHtml = await Promise.all(classPromises);
				const clsBtns = buttonsHtml.join('');

				tr.innerHTML = `<td class="p-4 align-top">${titleHtml}</td><td class="p-4 align-middle flex flex-wrap">${clsBtns}</td>`;
				tb.appendChild(tr);
			}
		}

		async function openOverallAnalysis(worksheetId, assignmentIdsStr, title) {
			const assignmentIds = JSON.parse(decodeURIComponent(assignmentIdsStr));
			await openAnalysisModal(assignmentIds, worksheetId, title);
		}

		window.toggleGroup = (master) => {
			master.closest('tr').querySelectorAll('.withdraw-checkbox').forEach(cb => cb.checked = master.checked);
		};
		
		document.getElementById('batch-withdraw-btn').addEventListener('click', async () => {
			const chk = document.querySelectorAll('.withdraw-checkbox:checked');
			if(chk.length === 0 || !confirm('ç¢ºå®šæ’¤å›ï¼Ÿ')) return;
			const b = db.batch(); chk.forEach(c => b.delete(db.collection('assignments').doc(c.value)));
			try { 
				await b.commit(); 
				alert('å·²æ’¤å›'); 
				localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
				await loadAssignmentsData(true);
				loadAssignments(); 
				loadGradingList();
			} catch(e) { alert(e.message); }
		});
		
		document.getElementById('batch-deadline-btn').addEventListener('click', () => {
			if(document.querySelectorAll('.withdraw-checkbox:checked').length === 0) return alert('è«‹å…ˆå‹¾é¸');
			document.getElementById('new-deadline-input').value = '';
			document.getElementById('deadline-modal').classList.remove('hidden');
		});
		document.getElementById('save-deadline-btn').addEventListener('click', async () => {
			const newDate = document.getElementById('new-deadline-input').value;
			const chk = document.querySelectorAll('.withdraw-checkbox:checked');
			const b = db.batch(); chk.forEach(c => b.update(db.collection('assignments').doc(c.value), { deadline: newDate || null }));
			try { 
				await b.commit(); alert('æ›´æ–°æˆåŠŸ'); document.getElementById('deadline-modal').classList.add('hidden'); 
				localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
				await loadAssignmentsData(true);
				loadAssignments(); 
			} catch(e) { alert(e.message); }
		});

		/* ==========================================
		   âœï¸ ä¿®æ”¹ï¼šopenSubmissionList (å®Œæ•´ç‰ˆ)
		   åŠŸèƒ½ï¼šé–‹å•Ÿç¹³äº¤åˆ—è¡¨ (å«å¿«å–åŠ é€Ÿ & ç·Šæ¹Šç‰ˆé¢)
		   ========================================== */
		window.openSubmissionList = async (aid, cls, wid, title) => {
			const modal = document.getElementById('submission-list-modal');
			const tb = document.getElementById('submission-list-body');
			const masterChk = document.getElementById('submission-master-checkbox');
			const analysisBtn = document.getElementById('open-analysis-btn');
			
			// è¨­å®šåˆ†ææŒ‰éˆ•
			analysisBtn.onclick = () => openAnalysisModal(aid, wid, `${title} (${cls}ç­)`);

			// é‡ç½®å…¨é¸æ¡†
			if(masterChk) {
				masterChk.checked = false;
				masterChk.onclick = (e) => {
					document.querySelectorAll('.sub-checkbox:not(:disabled)').forEach(cb => cb.checked = e.target.checked);
				};
			}

			// è¨­å®šæ¨™é¡Œ
			document.getElementById('submission-modal-title').textContent = title;
			document.getElementById('submission-modal-subtitle').textContent = `ç­ç´šï¼š${cls} ç­`;
			
			// é¡¯ç¤ºè¼‰å…¥ä¸­å‹•ç•«
			tb.innerHTML = '<tr><td colspan="6" class="p-4 text-center"><div class="animate-spin inline-block w-4 h-4 border-2 border-blue-500 rounded-full border-t-transparent"></div> è¼‰å…¥ä¸­...</td></tr>';
			modal.classList.remove('hidden');
			
			try {
				// ğŸš€ ä¸¦è¡Œè®€å–ï¼šå­¸ç”Ÿä½œæ¥­(å³æ™‚) + å­¸ç¿’å–®å…§å®¹(å¿«å–)
				const [snap, wsData] = await Promise.all([
					db.collection('responses').where('assignment_id', '==', aid).orderBy('student_no').get(),
					getSmartWorksheetData(wid) // ä½¿ç”¨å¿«å–å‡½å¼
				]);
				
				// å–å¾—ç­”æ¡ˆå· (ç”¨æ–¼è¨ˆç®—è‡ªå‹•åˆ†æ•¸)
				const answerKey = (wsData && wsData.answer_key) ? wsData.answer_key : {}; 

				tb.innerHTML = '';
				
				if(snap.empty) { tb.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">å°šç„¡ç¹³äº¤</td></tr>'; return; }
				
				snap.forEach(doc => {
					const d = doc.data();
					
					// 1. ç‹€æ…‹æ¨™ç±¤ (ç·Šæ¹Šç‰ˆ)
					let st = '';
					if(d.status==='submitted') st='<span class="bg-blue-100 text-blue-800 text-[10px] px-1.5 py-0.5 rounded font-bold">å·²ç¹³äº¤</span>';
					else if(d.status==='graded') st='<span class="bg-green-100 text-green-800 text-[10px] px-1.5 py-0.5 rounded font-bold">å·²æ‰¹æ”¹</span>';
					else if(d.status==='needs_correction') st='<span class="bg-yellow-100 text-yellow-800 text-[10px] px-1.5 py-0.5 rounded font-bold">è¨‚æ­£ä¸­</span>';
					else st='<span class="bg-gray-100 text-gray-600 text-[10px] px-1.5 py-0.5 rounded">è‰ç¨¿/æœªäº¤</span>';
					
					// 2. åˆ†æ•¸é¡¯ç¤º (å«è‡ªå‹•ç®—åˆ†é‚è¼¯)
					let scoreDisplay = '-';
					if (d.status === 'graded' && d.score !== undefined) {
						scoreDisplay = `<span class="text-blue-600 font-bold text-base">${d.score}</span>`;
					} else if ((d.status === 'submitted' || d.status === 'needs_correction') && d.answers) {
						let autoScore = 0;
						Object.keys(answerKey).forEach(qKey => {
							const keyData = answerKey[qKey];
							const studAns = d.answers[qKey];
							// ç°¡å–®æ¯”å°
							if (keyData.answer && studAns && String(keyData.answer).trim() === String(studAns).trim()) {
								autoScore += (parseInt(keyData.points) || 0);
							}
						});
						scoreDisplay = `<span class="text-gray-400 font-mono text-xs" title="ç³»çµ±è‡ªå‹•é‹ç®—">(${autoScore})</span>`;
					}

					const canReturn = (d.status === 'submitted' || d.status === 'graded' || d.status === 'needs_correction');
					const checkboxHtml = `<input type="checkbox" class="sub-checkbox form-checkbox h-4 w-4 text-orange-500 cursor-pointer" value="${doc.id}" ${canReturn ? '' : 'disabled'}>`;

					const tr = document.createElement('tr'); 
					tr.className = 'border-b hover:bg-gray-50 transition';
					
					// 3. æ¸²æŸ“è³‡æ–™åˆ— (ç·Šæ¹Š padding: px-2 py-1.5)
					tr.innerHTML = `
						<td class="px-2 py-1.5 text-center">${checkboxHtml}</td>
						<td class="px-2 py-1.5 text-gray-600">${d.student_no||'?'}</td>
						<td class="px-2 py-1.5 font-bold text-gray-700">${d.student_name}</td>
						<td class="px-2 py-1.5 whitespace-nowrap">${st}</td>
						<td class="px-2 py-1.5 text-center">${scoreDisplay}</td>
						<td class="px-2 py-1.5 flex gap-2 justify-end">
							<button onclick="openResultSummaryModal('${doc.id}', '${wid}', '${d.student_name.replace(/'/g, "\\'")}', '${title.replace(/'/g, "\\'")}')" class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs hover:bg-blue-100 border border-blue-200 font-bold flex items-center gap-1">ğŸ“Š æª¢è¦–ä½œç­”</button>
							<button onclick="openGradingModal('${doc.id}', '${wid}', '${d.student_name}', 'edit')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 font-bold shadow-sm">æ‰¹æ”¹</button>
						</td>`;
					tb.appendChild(tr);
				});
				
				// è¨­å®šæ‰¹é‡æ“ä½œæŒ‰éˆ•
				setupBatchReturnBtn(aid, cls, wid, title);

			} catch (e) {
				console.error(e);
				tb.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">è¼‰å…¥å¤±æ•—: ${e.message}</td></tr>`;
			}
		};

		// è¼”åŠ©å‡½å¼ï¼šç¨ç«‹å‡ºä¾†çš„æ‰¹é‡æŒ‰éˆ•é‚è¼¯ (é¿å…ç¨‹å¼ç¢¼å¤ªäº‚)
		function setupBatchReturnBtn(aid, cls, wid, title) {
			const batchBtn = document.getElementById('batch-return-continue-btn');
			const newBtn = batchBtn.cloneNode(true);
			batchBtn.parentNode.replaceChild(newBtn, batchBtn);
			
			newBtn.addEventListener('click', async () => {
				const checkedBoxes = document.querySelectorAll('.sub-checkbox:checked');
				if(checkedBoxes.length === 0) return alert('è«‹å…ˆå‹¾é¸å­¸ç”Ÿï¼');
				if(!confirm(`ç¢ºå®šè¦å°‡é¸å–çš„ ${checkedBoxes.length} ä½å­¸ç”Ÿç™¼å›çºŒå¯«å—ï¼Ÿ`)) return;

				newBtn.disabled = true; newBtn.textContent = 'è™•ç†ä¸­...';
				try {
					const batch = db.batch();
					checkedBoxes.forEach(cb => {
						const ref = db.collection('responses').doc(cb.value);
						batch.update(ref, {
							status: 'draft',
							updated_at: firebase.firestore.FieldValue.serverTimestamp()
						});
					});
					await batch.commit();
					alert('âœ… å·²æˆåŠŸç™¼å›çºŒå¯«ï¼');
					openSubmissionList(aid, cls, wid, title);
					// loadGradingList(); // Optional: é‡æ–°æ•´ç†å¤–éƒ¨åˆ—è¡¨
				} catch(e) { alert('ç™¼ç”ŸéŒ¯èª¤: ' + e.message); } 
				finally { newBtn.disabled = false; newBtn.textContent = 'â†©ï¸ ç™¼å›çºŒå¯« (è§£é–)'; }
			});
		}

		// ==========================================
		// 9. Analysis & Charts
		// ==========================================
		window.toggleAnalysisView = (viewName) => {
			const tableView = document.getElementById('analysis-table-view');
			const chartView = document.getElementById('analysis-chart-view');
			
			if (viewName === 'chart') {
				tableView.classList.add('hidden');
				chartView.classList.remove('hidden');
			} else {
				chartView.classList.add('hidden');
				tableView.classList.remove('hidden');
			}
		};

		async function openAnalysisModal(assignmentIdOrArray, worksheetId, title) {
			const modal = document.getElementById('analysis-modal');
			const mainTitleEl = document.getElementById('analysis-main-title'); 
			const leaderboardEl = document.getElementById('analysis-leaderboard');
			const tableBody = document.getElementById('analysis-table-body');
			
			if (analysisChartInstance) { analysisChartInstance.destroy(); analysisChartInstance = null; }
			toggleAnalysisView('table');
			
			if (Array.isArray(assignmentIdOrArray)) {
				mainTitleEl.textContent = 'ğŸ“Š å…¨é«”ç­”é¡Œåˆ†æ';
			} else {
				mainTitleEl.textContent = 'ğŸ“Š ç­ç´šç­”é¡Œåˆ†æ';
			}

			document.getElementById('analysis-subtitle').textContent = title;
			leaderboardEl.innerHTML = '<p class="text-center text-gray-400 py-10">è³‡æ–™é‹ç®—ä¸­...</p>';
			tableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">è¼‰å…¥ä¸­...</td></tr>';
			modal.classList.remove('hidden');

			try {
				let resPromise;
				
				if (Array.isArray(assignmentIdOrArray)) {
					const chunks = [];
					const ids = assignmentIdOrArray;
					for (let i = 0; i < ids.length; i += 10) {
						chunks.push(ids.slice(i, i + 10));
					}
					
					const promises = chunks.map(chunk => 
						db.collection('responses').where('assignment_id', 'in', chunk).get()
					);
					
					resPromise = Promise.all(promises).then(snapshots => {
						const allDocs = [];
						snapshots.forEach(snap => snap.forEach(doc => allDocs.push(doc)));
						return { 
							size: allDocs.length, 
							forEach: (cb) => allDocs.forEach(cb) 
						};
					});

				} else {
					resPromise = db.collection('responses').where('assignment_id', '==', assignmentIdOrArray).get();
				}

				const [wsDoc, resSnap] = await Promise.all([
					db.collection('worksheets').doc(worksheetId).get(),
					resPromise
				]);

				if (!wsDoc.exists) throw new Error('æ‰¾ä¸åˆ°å­¸ç¿’å–®');
				
				const wsData = wsDoc.data();
				currentAnalysisHtmlContent = wsData.html_content; 

				const answerKey = wsData.answer_key || {}; 
				const totalStudents = resSnap.size;

				if (totalStudents === 0) {
					const noDataHtml = '<p class="text-center text-gray-400 py-10">å°šç„¡å­¸ç”Ÿç¹³äº¤ï¼Œç„¡æ³•åˆ†æã€‚</p>';
					leaderboardEl.innerHTML = noDataHtml;
					tableBody.innerHTML = `<tr><td colspan="5">${noDataHtml}</td></tr>`;
					return;
				}

				const questionMeta = {};
				Object.keys(answerKey).forEach(key => {
					const qData = answerKey[key];
					
					let unitLabel = '';
					const parts = key.split('_');
					if (parts.length > 0 && parts[0].startsWith('u')) {
						const unitNum = parts[0].substring(1);
						if (!isNaN(unitNum)) unitLabel = `ã€å–®å…ƒ ${unitNum}ã€‘`;
					}
					
					let rawLabel = qData.label; 
					if (!rawLabel) rawLabel = qData.note ? qData.note.substring(0, 15) + '...' : key;
					
					const points = parseInt(qData.points) || 0;

					questionMeta[key] = { 
						key: key,
						unit: unitLabel, 
						rawLabel: rawLabel,
						fullLabel: unitLabel ? `${unitLabel} ${rawLabel}` : rawLabel,
						points: points, 
						stats: { answeredCount: 0, correct: 0, incorrect: 0, options: {} } 
					};
				});

				resSnap.forEach(doc => {
					const d = doc.data();
					const answers = d.answers || {};
					const details = d.grading_details || {};

					Object.keys(questionMeta).forEach(qKey => {
						const qStat = questionMeta[qKey].stats;
						const userAns = answers[qKey];
						
						const hasAnswered = (userAns !== undefined && userAns !== null && String(userAns).trim() !== '');

						if (hasAnswered) {
							qStat.answeredCount++; 
							const val = String(userAns).trim();
							qStat.options[val] = (qStat.options[val] || 0) + 1;

							let isCorrect = null;
							if (details[qKey] && details[qKey].is_correct !== undefined) {
								isCorrect = details[qKey].is_correct;
							} else {
								const stdData = answerKey[qKey];
								if (stdData && stdData.answer) {
									const studentStr = String(userAns).trim().toLowerCase();
									const stdStr = String(stdData.answer).trim().toLowerCase();
									isCorrect = (studentStr === stdStr);
								}
							}

							if (isCorrect !== null) {
								if (isCorrect) qStat.correct++;
								else qStat.incorrect++;
							}
						}
					});
				});

				const allQuestions = Object.values(questionMeta).map(q => {
					const total = q.stats.answeredCount;
					const errorRate = total > 0 ? (q.stats.incorrect / total) * 100 : 0;
					return { ...q, total, errorRate };
				}).sort((a, b) => {
					return a.key.localeCompare(b.key, undefined, { numeric: true, sensitivity: 'base' });
				});

				const top5 = [...allQuestions]
					.filter(q => q.total > 0 && q.stats.incorrect > 0 && q.points > 0) 
					.sort((a, b) => b.errorRate - a.errorRate)
					.slice(0, 5);

				leaderboardEl.innerHTML = '';
				if (top5.length === 0) {
					 leaderboardEl.innerHTML = `<div class="text-center py-8"><div class="text-4xl mb-2">ğŸ‰</div><p class="text-gray-500 font-bold">ç›®å‰æ²’æœ‰éŒ¯èª¤ç´€éŒ„</p></div>`;
				} else {
					top5.forEach((q, idx) => {
						const barWidth = `${q.errorRate}%`;
						const colorClass = idx === 0 ? 'bg-red-500' : (idx === 1 ? 'bg-orange-500' : 'bg-yellow-500');
						
						let qNum = q.key; 
						try {
							const parts = q.key.split('_');
							const numPart = parts[parts.length - 1].replace(/\D/g, ''); 
							if(numPart) qNum = parseInt(numPart, 10); 
						} catch(e) {}

						const displayLabel = `${q.unit ? q.unit + ' ' : ''}${qNum}. ${q.rawLabel}`;

						leaderboardEl.innerHTML += `
							<div class="mb-3 cursor-pointer hover:bg-gray-50 p-2 rounded transition border border-transparent hover:border-gray-200" onclick="showChartFromLeaderboard('${q.key}')">
								<div class="flex justify-between items-center text-sm mb-2">
									<div class="flex items-center flex-grow overflow-hidden mr-2">
										<span class="font-bold text-gray-500 mr-2 flex-shrink-0" style="min-width:15px">${idx+1}.</span>
										<span class="font-bold text-gray-800 truncate mr-2" style="max-width: 65%;" title="${displayLabel}">${displayLabel}</span>
										<button onclick="event.stopPropagation(); showQuestionContext('${q.key}')" class="view-btn flex-shrink-0">ğŸ‘ï¸ çœ‹é¡Œ</button>
									</div>
									<span class="text-red-600 font-bold flex-shrink-0">${Math.round(q.errorRate)}%</span>
								</div>
								<div class="w-full bg-gray-200 rounded-full h-2.5">
									<div class="${colorClass} h-2.5 rounded-full" style="width: ${barWidth}"></div>
								</div>
							</div>`;
					});
				}
				
				tableBody.innerHTML = '';
				let lastUnit = null;

				allQuestions.forEach(q => {
					if (q.unit !== lastUnit && q.unit) {
						const row = document.createElement('tr');
						row.innerHTML = `<td colspan="5" class="bg-gray-200 font-bold text-gray-700 py-1 px-3 text-xs">${q.unit}</td>`;
						tableBody.appendChild(row);
						lastUnit = q.unit;
					}

					const tr = document.createElement('tr');
					tr.className = "hover:bg-purple-50 cursor-pointer transition border-b border-gray-100 last:border-0 group"; 
					
					tr.onclick = () => {
						document.getElementById('chart-question-title').textContent = q.fullLabel;
						renderChart(q);
						toggleAnalysisView('chart');
					};

					const rateColor = q.errorRate > 50 ? 'text-red-600 font-bold' : (q.errorRate > 0 ? 'text-orange-500' : 'text-gray-400');
					
					tr.innerHTML = `
						<td class="px-2 py-1.5 text-gray-700 font-medium relative">
							<div class="flex items-center justify-between">
								<span class="truncate pr-2">${q.rawLabel}</span>
								<button onclick="event.stopPropagation(); showQuestionContext('${q.key}')" class="view-btn opacity-0 group-hover:opacity-100 transition-opacity text-xs whitespace-nowrap">ğŸ‘ï¸ çœ‹é¡Œ</button>
							</div>
						</td>
						<td class="px-2 py-1.5 text-center text-gray-500 text-sm">${q.total}</td>
						<td class="px-2 py-1.5 text-center text-green-600 bg-green-50/50 text-sm">${q.stats.correct}</td>
						<td class="px-2 py-1.5 text-center text-red-600 bg-red-50/50 text-sm">${q.stats.incorrect}</td>
						<td class="px-2 py-1.5 text-center ${rateColor} text-sm">${Math.round(q.errorRate)}%</td>
					`;
					tableBody.appendChild(tr);
				});

				window.showChartFromLeaderboard = (key) => {
					const q = questionMeta[key];
					if(q) {
						document.getElementById('chart-question-title').textContent = q.fullLabel;
						renderChart(q);
						toggleAnalysisView('chart');
					}
				};

			} catch (e) {
				console.error(e);
				leaderboardEl.innerHTML = `<p class="text-red-500">åˆ†æå¤±æ•—: ${e.message}</p>`;
			}
		}
		
		function renderChart(qData) {
			const ctx = document.getElementById('analysis-chart').getContext('2d');
			if (analysisChartInstance) analysisChartInstance.destroy();

			const viewBtn = document.getElementById('analysis-view-question-btn');
			if (viewBtn) {
				viewBtn.onclick = null;
				viewBtn.onclick = function() {
					showQuestionContext(qData.key);
				};
			}

			const labels = Object.keys(qData.stats.options);
			const data = Object.values(qData.stats.options);
			const totalCount = data.reduce((a, b) => a + b, 0);

			const bgColors = labels.map(() => 'rgba(54, 162, 235, 0.6)');
			const borderColors = labels.map(() => 'rgba(54, 162, 235, 1)');

			const topLabelPlugin = {
				id: 'topLabels',
				afterDatasetsDraw(chart, args, pluginOptions) {
					const { ctx } = chart;
					chart.data.datasets.forEach((dataset, i) => {
						const meta = chart.getDatasetMeta(i);
						meta.data.forEach((bar, index) => {
							const value = dataset.data[index];
							if (value > 0) {
								let percentage = totalCount > 0 ? Math.round((value / totalCount) * 100) : 0;
								const countText = `${value}`;
								const pctText = ` (${percentage}%)`;
								
								const countFont = 'bold 16px "Microsoft JhengHei", sans-serif'; 
								const pctFont = 'normal 12px "Microsoft JhengHei", sans-serif';  
								
								ctx.font = countFont;
								const countWidth = ctx.measureText(countText).width;
								ctx.font = pctFont;
								const pctWidth = ctx.measureText(pctText).width;
								const totalWidth = countWidth + pctWidth;
								const startX = bar.x - (totalWidth / 2);
								const yPos = bar.y - 8; 

								ctx.font = countFont;
								ctx.fillStyle = '#1e40af'; 
								ctx.textAlign = 'left';
								ctx.textBaseline = 'bottom';
								ctx.fillText(countText, startX, yPos);

								ctx.font = pctFont;
								ctx.fillStyle = '#6b7280';
								ctx.fillText(pctText, startX + countWidth, yPos);
							}
						});
					});
				}
			};

			const bottomTickPlugin = {
				id: 'bottomTickConnector',
				afterDraw(chart) {
					const { ctx, scales: { x } } = chart;
					const yTop = x.top; 

					ctx.save();
					ctx.beginPath();
					ctx.lineWidth = 1; 
					ctx.strokeStyle = '#9ca3af'; 

					x.ticks.forEach((tick, index) => {
						const xPos = x.getPixelForTick(index);
						ctx.moveTo(xPos, yTop);
						ctx.lineTo(xPos, yTop + 6); 
					});
					
					ctx.stroke();
					ctx.restore();
				}
			};

			analysisChartInstance = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: 'é¸æ“‡äººæ•¸',
						data: data,
						backgroundColor: bgColors,
						borderColor: borderColors,
						borderWidth: 1
					}]
				},
				plugins: [topLabelPlugin, bottomTickPlugin],
				options: {
					responsive: true,
					maintainAspectRatio: false,
					onClick: (e) => {
						showQuestionContext(qData.key);
					},
					layout: {
						padding: { top: 10 } 
					},
					scales: {
						y: { 
							beginAtZero: true, 
							grace: '15%', 
							ticks: { 
								stepSize: 1,
								color: '#000000',
								font: { weight: 'normal' }
							},
							title: {
								display: true,
								text: 'äººæ•¸',
								align: 'end',
								color: '#374151',
								font: { weight: 'bold', size: 13 },
								padding: { bottom: 5 }
							}
						},
						x: {
							ticks: {
								color: '#000000',
								font: { weight: 'normal', size: 11 },
								padding: 4 
							},
							grid: {
								drawOnChartArea: true, 
								drawTicks: false 
							}
						}
					},
					plugins: {
						legend: { display: false },
						title: { 
							display: true, 
							text: `ä½œç­”åˆ†ä½ˆï¼š${qData.fullLabel || qData.rawLabel}`, 
							color: '#6b21a8',
							font: { size: 16, weight: 'bold' },
							padding: { bottom: 10 } 
						},
						tooltip: {
							callbacks: {
								label: function(context) {
									const val = context.parsed.y;
									const pct = totalCount > 0 ? Math.round((val / totalCount) * 100) : 0;
									return ` ${val} äºº (${pct}%)`;
								}
							}
						}
					}
				}
			});
		}
		

		// ğŸ› ï¸ [ä¿®æ­£ç‰ˆ] openGradingModal
		window.openGradingModal = async (rid, wid, sname, mode = 'edit') => {
			currentGradingResponseId = rid; 
			currentGradingWorksheetId = wid;
			const modal = document.getElementById('grading-modal');
			const view = document.getElementById('grading-worksheet-content');
			const scoreIn = document.getElementById('grade-score');
			const commIn = document.getElementById('grade-comment');
			
			const leftPanel = document.getElementById('grading-left-panel');
			const rightPanel = document.getElementById('grading-right-panel');
			const viewCloseBtn = document.getElementById('view-mode-close-btn');

			document.getElementById('preview-content').innerHTML = ''; 
			document.getElementById('view-modal-content').innerHTML = ''; 

			document.getElementById('grading-student-name').textContent = sname;
			
			const nameArea = document.getElementById('grading-student-name');
			const draftBadgeId = 'draft-badge-indicator';
			const oldBadge = document.getElementById(draftBadgeId);
			if(oldBadge) oldBadge.remove();

			view.innerHTML = '<p class="p-4 text-center">è¼‰å…¥ä¸­...</p>';
			scoreIn.value = ''; commIn.value = '';

			// ğŸŸ¢ 1. å±¤ç´šä¿®å¾©ï¼šå¼·åˆ¶ç§»åˆ° Body ä¸¦è¨­å®šæœ€é«˜å±¤ç´šï¼Œè§£æ±ºæŒ‰éˆ•é»ä¸åˆ°çš„å•é¡Œ
			if (modal.parentElement !== document.body) {
				document.body.appendChild(modal);
			}
			modal.classList.remove('hidden');
			modal.style.setProperty('z-index', '2147483647', 'important'); // ç¢ºä¿åœ¨æœ€ä¸Šå±¤

			if (mode === 'view') {
				leftPanel.classList.remove('w-2/3'); leftPanel.classList.add('w-full');
				rightPanel.classList.add('hidden'); viewCloseBtn.classList.remove('hidden');
			} else {
				leftPanel.classList.remove('w-full'); leftPanel.classList.add('w-2/3');
				rightPanel.classList.remove('hidden'); viewCloseBtn.classList.add('hidden');
			}

			try {
				const [r, w] = await Promise.all([
					db.collection('responses').doc(rid).get(), 
					db.collection('worksheets').doc(wid).get()
				]);
				
				let rd = r.data(); 
				const wd = w.data();
				
				if (mode === 'edit') {
					const draftKey = `grading_draft_${rid}`;
					const localJson = localStorage.getItem(draftKey);
					
					if (localJson) {
						const draft = JSON.parse(localJson);
						const useDraft = confirm(`âš ï¸ ç³»çµ±ç™¼ç¾æ­¤ä½œæ¥­æœ‰ã€Œæœªé€å‡ºçš„æ‰¹æ”¹æš«å­˜ã€ã€‚\n\næ˜¯å¦è¼‰å…¥æš«å­˜æª”ï¼Ÿ\n(æŒ‰ã€Œå–æ¶ˆã€å‰‡è¼‰å…¥é›²ç«¯åŸå§‹è³‡æ–™)`);
						
						if (useDraft) {
							console.log("è¼‰å…¥æš«å­˜:", draft);
							if (draft.score !== undefined) rd.score = draft.score;
							if (draft.comment !== undefined) rd.comment = draft.comment;
							rd.grading_details = { ...(rd.grading_details || {}), ...draft.grading_details };
							nameArea.innerHTML += ` <span id="${draftBadgeId}" class="text-xs bg-gray-600 text-white px-2 py-0.5 rounded ml-2">ğŸ’¾ å·²è¼‰å…¥æš«å­˜</span>`;
						}
					}
				}

				view.innerHTML = wd.html_content;
				executeEmbeddedScripts(view);
				
				const ans = rd.answers || {}; 
				const details = rd.grading_details || {};
				
				let currentAutoScore = 0;
				const calculatedQuestions = new Set(); 

				if(rd.comment) commIn.value = rd.comment;

				view.querySelectorAll('.worksheet-input').forEach(inp => {
					const n = inp.name; if(!n) return;
					
					// 1. å¡«å…¥å­¸ç”Ÿç­”æ¡ˆ
					if(ans[n] !== undefined) {
						if (inp.type === 'file') {
							const fileUrl = ans[n];
							if (fileUrl && fileUrl.toString().startsWith('http')) {
								const link = document.createElement('a');
								link.href = fileUrl;
								link.target = '_blank';
								link.className = 'inline-flex items-center gap-1 text-blue-600 underline font-bold text-sm ml-2 hover:text-blue-800';
								link.innerHTML = 'ğŸ“‚ ä¸‹è¼‰/æŸ¥çœ‹ä¸Šå‚³æª”æ¡ˆ';
								if(inp.nextSibling) inp.parentNode.insertBefore(link, inp.nextSibling);
								else inp.parentNode.appendChild(link);
							}
						}
						else if(inp.type === 'radio' || inp.type === 'checkbox') { 
							if(inp.value === ans[n]) inp.checked = true; 
						}
						else {
							inp.value = ans[n];
						}
					}
					
					// 2. é–å®šè¼¸å…¥æ¡†
					inp.disabled = true;

					// 3. ç”¢ç”Ÿæ‰¹æ”¹ä»‹é¢ (O/X æŒ‰éˆ•)
					if (mode === 'edit' && Object.keys(wd.answer_key || {}).length > 0) {
						let isCor = null, isInc = null, fb = '';
						let points = 0; 
						let autoResult = null; 
						let correctAnswerText = null; // ğŸŸ¢ æº–å‚™è®Šæ•¸

						if (wd.answer_key && wd.answer_key[n]) {
							const key = wd.answer_key[n];
							points = parseInt(key.points) || 0; 
							if(key.note) fb = key.note;
							
							// ğŸŸ¢ å–å¾—æ­£ç¢ºç­”æ¡ˆ
							if (key.answer !== undefined && key.answer !== null && String(key.answer).trim() !== '') {
								correctAnswerText = key.answer;
							}

							const stdAns = ans[n];
							if (key.answer !== null && key.answer !== undefined && stdAns !== undefined) {
								const valStudent = String(stdAns).trim();
								const valAnswer = String(key.answer).trim();
								
								if (valStudent === valAnswer) {
									autoResult = true; 
									if (!details[n] && !calculatedQuestions.has(n)) {
										currentAutoScore += points;
										calculatedQuestions.add(n);
									}
								} else {
									autoResult = false; 
								}
							}
						}

						if (details[n]) {
							isCor = details[n].is_correct === true;
							isInc = details[n].is_correct === false;
							if (details[n].feedback !== undefined) fb = details[n].feedback;
						} else if (autoResult !== null) {
							isCor = (autoResult === true);
							isInc = (autoResult === false);
						}

						if (inp.type === 'radio') {
							const all = view.querySelectorAll(`input[type="radio"][name="${n}"]`);
							if (inp !== all[all.length - 1]) return;
						}
						
						const panel = document.createElement('div');
						panel.className = `grading-panel ${isCor?'correct':(isInc?'incorrect':'')}`;
						if (inp.type === 'radio') panel.style.marginTop = "15px";

						const currentStatus = isCor ? 'c' : (isInc ? 'i' : '');
						panel.setAttribute('data-status', currentStatus);

						const pointsBadge = points > 0 ? `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded ml-2">é…åˆ†: ${points}</span>` : '';
						
						// ğŸŸ¢ ç”¢ç”Ÿæ­£ç¢ºç­”æ¡ˆ HTML å€å¡Š
						let correctHtml = '';
						if (correctAnswerText) {
							correctHtml = `
								<div class="mb-2 text-xs text-green-800 bg-green-100 border border-green-200 p-1.5 rounded flex items-start gap-1">
									<span class="font-bold shrink-0">ğŸ¯ æ­£è§£ï¼š</span>
									<span class="font-mono font-bold break-all">${correctAnswerText}</span>
								</div>
							`;
						}

						panel.innerHTML = `
							${correctHtml} <div class="flex items-center justify-between mb-2">
								<div class="flex gap-2 items-center">
									<label class="grading-radio-label">
										<input type="radio" name="gs_${n}" value="c" data-points="${points}" ${isCor?'checked':''} onchange="updPanel(this)">
										<span class="ml-1 btn-text-correct">â­• æ­£ç¢º</span>
									</label>
									<label class="grading-radio-label">
										<input type="radio" name="gs_${n}" value="i" data-points="${points}" ${isInc?'checked':''} onchange="updPanel(this)">
										<span class="ml-1 btn-text-incorrect">âŒ éŒ¯èª¤</span>
									</label>
									${pointsBadge}
								</div>
								<button class="text-xs text-gray-400 hover:text-red-500 transition" onclick="clsGrade('${n}', this)">æ¸…é™¤è©•èª</button>
							</div>
							<input type="text" class="grading-feedback-input w-full border border-gray-300 rounded p-1 text-sm outline-none" placeholder="å€‹åˆ¥è©•èª..." value="${fb}" data-field="${n}">
						`;
						
						if (inp.type === 'radio') {
							panel.style.gridColumn = "1 / -1"; panel.style.width = "100%";
							const c = inp.parentNode;
							if(c.nextSibling) c.parentNode.insertBefore(panel, c.nextSibling); else c.parentNode.appendChild(panel);
						} else {
							if(inp.nextSibling) inp.parentNode.insertBefore(panel, inp.nextSibling); else inp.parentNode.appendChild(panel);
						}
					}
				});

				if (mode === 'edit') {
					if (rd.score !== undefined && rd.score !== null && rd.score !== "") {
						scoreIn.value = rd.score;
					} else {
						scoreIn.value = currentAutoScore;
					}
				} else {
					scoreIn.value = rd.score !== undefined ? rd.score : '';
				}

			} catch(e) { console.error(e); alert(e.message); modal.classList.add('hidden'); }
		};
				
		window.updPanel = (r) => { 
			const p = r.closest('.grading-panel'); 
			const oldStatus = p.getAttribute('data-status') || ''; 
			const newStatus = r.value; 
			const points = parseInt(r.getAttribute('data-points')) || 0; 
			
			p.classList.remove('correct', 'incorrect'); 
			if(newStatus==='c') p.classList.add('correct'); 
			if(newStatus==='i') p.classList.add('incorrect'); 
			
			if (oldStatus === newStatus) return; 

			const scoreInput = document.getElementById('grade-score');
			let currentTotal = parseInt(scoreInput.value) || 0;
			
			if (newStatus === 'c' && oldStatus !== 'c') {
				currentTotal += points;
			} else if (oldStatus === 'c' && newStatus !== 'c') {
				currentTotal -= points;
			}

			scoreInput.value = currentTotal;
			p.setAttribute('data-status', newStatus); 
		};

		window.clsGrade = (n, btn) => { 
			const p = btn.closest('.grading-panel'); 
			const input = p.querySelector('.grading-feedback-input');
			
			if (!input) return;

			const isUndoMode = btn.getAttribute('data-is-undo') === 'true';

			if (isUndoMode) {
				const prevText = input.getAttribute('data-prev-text') || '';
				input.value = prevText;
				btn.textContent = 'æ¸…é™¤è©•èª';
				btn.classList.remove('text-blue-600', 'font-bold');
				btn.classList.add('text-gray-400', 'hover:text-red-500');
				btn.setAttribute('data-is-undo', 'false');
				input.removeAttribute('data-prev-text'); 

			} else {
				const currentText = input.value;
				if (!currentText) return; 

				input.setAttribute('data-prev-text', currentText);
				input.value = '';

				btn.textContent = 'â†©ï¸ å¾©åŸ';
				btn.classList.remove('text-gray-400', 'hover:text-red-500');
				btn.classList.add('text-blue-600', 'font-bold'); 
				btn.setAttribute('data-is-undo', 'true');
			}
			
			input.focus(); 
		};
		
		window.insertComment = (t) => { const el = document.getElementById('grade-comment'); el.value = el.value ? el.value+'ï¼Œ'+t : t; };

		const doGrade = async (status) => {
			const s = parseFloat(document.getElementById('grade-score').value);
			const c = document.getElementById('grade-comment').value;
			
			if(status==='graded' && isNaN(s)) return alert('è«‹æ‰“åˆ†');
			
			const btn = document.getElementById(status==='graded'?'submit-grade-btn':'return-correction-btn');
			btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­...';

			const data = collectCurrentGradingData();
			
			try {
				await db.collection('responses').doc(currentGradingResponseId).update({
					score: isNaN(s) ? 0 : s, 
					comment: c, 
					grading_details: data.grading_details, 
					status: status,
					graded_at: firebase.firestore.FieldValue.serverTimestamp(), 
					graded_by: currentUser.uid
				});
				
				const draftKey = `grading_draft_${currentGradingResponseId}`;
				localStorage.removeItem(draftKey);

				alert('å®Œæˆï¼');
				document.getElementById('grading-modal').classList.add('hidden');
				document.getElementById('submission-list-modal').classList.add('hidden'); 
				loadGradingList(); 
			} catch(e) { 
				alert(e.message); 
			} finally { 
				btn.disabled=false; 
				btn.textContent=status==='graded'?'âœ… é€å‡ºæˆç¸¾':'â†©ï¸ é€€å›è¨‚æ­£'; 
			}
		};
		
		window.viewSourceCode = (id) => {
			const data = worksheetsCache[id];
			if (!data) return;
			document.getElementById('view-src-html').value = data.html_content || '';
			const jsonStr = data.answer_key ? JSON.stringify(data.answer_key, null, 4) : '{}';
			document.getElementById('view-src-json').value = jsonStr;
			document.getElementById('source-code-modal').classList.remove('hidden');
		};

		window.copyToClipboard = (elementId, btn) => {
			const el = document.getElementById(elementId);
			if (!el) return;
			el.select();
			el.setSelectionRange(0, 99999); 
			navigator.clipboard.writeText(el.value).then(() => {
				const originalContent = btn.innerHTML;
				btn.textContent = 'âœ… å·²è¤‡è£½ï¼';
				setTimeout(() => {
					btn.innerHTML = originalContent;
				}, 1500);
			}).catch(err => {
				console.error('è¤‡è£½å¤±æ•—', err);
				alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚');
			});
		};
		
		/* ============================================================
		   ğŸ› ï¸ [Mode 1 é‡æ§‹] å…¨æ–° AI å‡ºé¡Œé‚è¼¯æ•´åˆåŒ… (é–‹å§‹)
		   åŒ…å«ï¼šåŸå§‹ç¢¼åˆ‡æ›ã€åˆ†é æ§åˆ¶ã€è¦–çª—ç®¡ç†ã€Gemini API ä¸²æ¥
		   ============================================================ */

		// 1. æ–°å¢ï¼šåˆ‡æ›åŸå§‹ç¢¼é¡¯ç¤º (ç”¨æ–¼æ–°å¢/ç·¨è¼¯å­¸ç¿’å–®é é¢ï¼Œéš±è—/é¡¯ç¤º HTML & JSON)
		window.toggleSourceCodeArea = function() {
			const area = document.getElementById('source-code-area');
			if (area.classList.contains('hidden')) {
				area.classList.remove('hidden');
			} else {
				area.classList.add('hidden');
			}
		};

		// 2. æ–°å¢ï¼šMode 1 åˆ†é åˆ‡æ› (åˆ‡æ›ã€Œä¸Šå‚³ PDFã€èˆ‡ã€Œç´”æ–‡å­—è²¼ä¸Šã€)
		window.switchMode1Tab = function(tab) {
			const btnPdf = document.getElementById('btn-m1-tab-pdf');
			const btnText = document.getElementById('btn-m1-tab-text');
			const divPdf = document.getElementById('m1-content-pdf');
			const divText = document.getElementById('m1-content-text');

			if (tab === 'pdf') {
				btnPdf.classList.add('text-indigo-700', 'border-indigo-600');
				btnPdf.classList.remove('text-gray-500', 'border-transparent');
				btnText.classList.add('text-gray-500', 'border-transparent');
				btnText.classList.remove('text-indigo-700', 'border-indigo-600');
				divPdf.classList.remove('hidden');
				divText.classList.add('hidden');
			} else {
				btnText.classList.add('text-indigo-700', 'border-indigo-600');
				btnText.classList.remove('text-gray-500', 'border-transparent');
				btnPdf.classList.add('text-gray-500', 'border-transparent');
				btnPdf.classList.remove('text-indigo-700', 'border-indigo-600');
				divText.classList.remove('hidden');
				divPdf.classList.add('hidden');
			}
		};

		// 3. è¼”åŠ©ï¼šMode 1 åˆ‡æ›è¨ˆåˆ†æ¨¡å¼ (æ¸¬é©—å· vs å­¸ç¿’ç´€éŒ„)
		window.toggleM1ScoreMode = function(mode) {
			const isQuiz = (mode === 'quiz');
			// é–å®šæˆ–è§£é–æ‰€æœ‰é…åˆ†ç›¸é—œæ¬„ä½
			const fields = [
				'm1-choice-total-input', 'm1-choice-per-input',
				'm1-text-total-input', 'm1-text-per-input',
				'm1-file-total-input', 'm1-file-per-input'
			];
			
			fields.forEach(function(id) {
				var el = document.getElementById(id);
				if (el) {
					el.disabled = !isQuiz;
					if (!isQuiz) {
						el.style.backgroundColor = '#f3f4f6'; // ç°è‰²
						el.style.color = '#9ca3af'; 
						el.value = 0; // å­¸ç¿’å–®æ¨¡å¼åˆ†æ•¸æ­¸é›¶
					} else {
						el.style.backgroundColor = ''; 
						el.style.color = ''; 
					}
				}
			});
			// è§¸ç™¼ä¸€æ¬¡è¨ˆç®—ä»¥æ›´æ–°ç¸½åˆ†é¡¯ç¤º
			if(!isQuiz) onM1InputChanged();
		};

		// ==========================================
		// ğŸ› ï¸ Mode 1: æ–°å¢é…åˆ†é‚è¼¯èˆ‡å¿«å–åŠŸèƒ½
		// ==========================================

		const M1_CACHE_KEY = 'm1_settings_cache_v3'; // ç‰ˆæœ¬å‡ç´š

		// 1. é—œé–‰è¦–çª— (å«å„²å­˜è¨­å®š)
		window.closeMode1Modal = function() {
			saveM1Cache();
			const modal = document.getElementById('mode1-prompt-modal');
			modal.classList.add('hidden');
			modal.style.removeProperty('display');
			modal.style.removeProperty('z-index');
		};

		// 2. é–‹å•Ÿè¦–çª— (å«è¼‰å…¥è¨­å®š)
		window.openMode1PromptModal = function() {
			var modal = document.getElementById('mode1-prompt-modal');
			if (!modal) return;

			const fileIn = document.getElementById('m1-upload-pdf');
			if(fileIn) fileIn.value = '';
			const fileName = document.getElementById('m1-file-name');
			if(fileName) fileName.textContent = 'é»æ“Šé¸æ“‡æ•™ææª”æ¡ˆ';
			const statusEl = document.getElementById('m1-status-msg');
			if(statusEl) statusEl.textContent = '';
			const runBtn = document.getElementById('btn-run-mode1');
			if(runBtn) { runBtn.disabled = false; runBtn.innerHTML = '<span>ğŸš€</span> AI ç«‹å³ç”Ÿæˆå­¸ç¿’å–®'; }
			
			// è¼‰å…¥è¨­å®š
			loadM1Cache();

			if (modal.parentElement !== document.body) { document.body.appendChild(modal); }
			modal.classList.remove('hidden');
			modal.style.setProperty('display', 'flex', 'important');
			modal.style.setProperty('z-index', '2147483647', 'important');
		};

		// 3. åˆ‡æ›è¨ˆç®—æ¨¡å¼ (é¡Œæ•¸èˆ‡ç¸½åˆ† vs é¡Œæ•¸èˆ‡æ¯é¡Œåˆ†æ•¸)
		window.toggleM1CalcMode = function() {
			const mode = document.querySelector('input[name="m1-calc-mode"]:checked').value;
			const categories = ['choice', 'text', 'file'];
			
			categories.forEach(type => {
				const totalInput = document.getElementById(`m1-${type}-total-input`);
				const totalText = document.getElementById(`m1-${type}-total-text`);
				const perWrapper = document.getElementById(`m1-${type}-per-wrapper`);
				
				if (mode === 'total') {
					// æ¨¡å¼ A: é¡Œæ•¸èˆ‡ç¸½åˆ†
					// é¡¯ç¤ºæ¨™é¡Œæ—çš„ç¸½åˆ†è¼¸å…¥æ¡†ï¼Œéš±è—ä¸‹æ–¹æ¯é¡Œåˆ†
					if(totalInput) totalInput.classList.remove('hidden');
					if(totalText) totalText.classList.add('hidden');
					if(perWrapper) perWrapper.classList.add('hidden'); // ä¸‹æ–¹åªå‰©é¡Œæ•¸
				} else {
					// æ¨¡å¼ B: é¡Œæ•¸èˆ‡æ¯é¡Œåˆ†æ•¸
					// éš±è—æ¨™é¡Œæ—çš„è¼¸å…¥æ¡†ï¼Œæ”¹é¡¯ç¤ºå”¯è®€æ–‡å­—ï¼Œé¡¯ç¤ºä¸‹æ–¹æ¯é¡Œåˆ†
					if(totalInput) totalInput.classList.add('hidden');
					if(totalText) totalText.classList.remove('hidden');
					if(perWrapper) perWrapper.classList.remove('hidden');
				}
			});
			
			// é‡æ–°è¨ˆç®— (å› ç‚ºåˆ‡æ›æ¨¡å¼å¯èƒ½éœ€è¦é‡ç®—ç¸½åˆ†æˆ–é‡ç½®æ¬„ä½)
			onM1InputChanged();
		};

		// 4. è¼¸å…¥è®Šæ›´äº‹ä»¶ (é€£å‹•è¨ˆç®—)
		window.onM1InputChanged = function() {
			const mode = document.querySelector('input[name="m1-calc-mode"]:checked').value;
			const isQuiz = document.querySelector('input[name="m1-type"][value="quiz"]').checked;
			const categories = ['choice', 'text', 'file'];
			let grandTotal = 0;

			categories.forEach(type => {
				const countEl = document.getElementById(`m1-${type}-count`);
				const totalInputEl = document.getElementById(`m1-${type}-total-input`);
				const totalTextEl = document.getElementById(`m1-${type}-total-text`);
				const perInputEl = document.getElementById(`m1-${type}-per-input`);
				
				let count = parseInt(countEl.value) || 0;
				if (count < 0) { count = 0; countEl.value = 0; }

				let subTotal = 0;

				if (mode === 'total') {
					// æ¨¡å¼ A: è®€å–ç¸½åˆ†è¼¸å…¥æ¡†
					// éœ€æ±‚ï¼šå¦‚æœç”¨ç¸½åˆ†å‡ºé¡Œï¼Œç•¶å¤§é¡Œé¡Œæ•¸è®Šç‚º0æ™‚ï¼Œå¤§é¡Œç¸½åˆ†è¦è‡ªå‹•è®Šæˆ0
					subTotal = parseInt(totalInputEl.value) || 0;
					if (subTotal < 0) { subTotal = 0; totalInputEl.value = 0; }
					
					if (count === 0 && subTotal > 0) {
						subTotal = 0;
						totalInputEl.value = 0;
					}
				} else {
					// æ¨¡å¼ B: è®€å–æ¯é¡Œåˆ†ï¼Œè¨ˆç®—ç¸½åˆ†
					let per = parseInt(perInputEl.value) || 0;
					if (per < 0) { per = 0; perInputEl.value = 0; }
					
					subTotal = count * per;
					// æ›´æ–°é¡¯ç¤ºæ–‡å­—
					if(totalTextEl) totalTextEl.textContent = subTotal;
				}

				if (isQuiz) {
					grandTotal += subTotal;
				}
			});

			document.getElementById('m1-total-display').textContent = `(ç›®å‰ç¸½åˆ†: ${grandTotal})`;
			saveM1Cache();
		};

		// 5. å„²å­˜è¨­å®š (åŠ å…¥ liteCnt)
		function saveM1Cache() {
			const settings = {
				mode: document.querySelector('input[name="m1-calc-mode"]:checked').value,
				
				choiceCnt: document.getElementById('m1-choice-count').value,
				choiceTotal: document.getElementById('m1-choice-total-input').value,
				choicePer: document.getElementById('m1-choice-per-input').value,
				
				textCnt: document.getElementById('m1-text-count').value,
				textTotal: document.getElementById('m1-text-total-input').value,
				textPer: document.getElementById('m1-text-per-input').value,
				
				// âœ¨ ç´ é¤Šé¡Œæ•¸ (å…§å«)
				liteCnt: document.getElementById('m1-lite-count').value,
				
				fileCnt: document.getElementById('m1-file-count').value,
				fileTotal: document.getElementById('m1-file-total-input').value,
				filePer: document.getElementById('m1-file-per-input').value,
				
				enableHint: document.getElementById('m1-enable-hint').checked,
				scoreType: document.querySelector('input[name="m1-type"]:checked').value
			};
			localStorage.setItem(M1_CACHE_KEY, JSON.stringify(settings));
		}

		// 6. è¼‰å…¥è¨­å®š (åŠ å…¥ liteCnt é è¨­å€¼)
		function loadM1Cache() {
			const cache = localStorage.getItem(M1_CACHE_KEY);
			
			// é è¨­å€¼
			let s = {
				mode: 'per_q',
				choiceCnt: 10, choiceTotal: 50, choicePer: 5,
				textCnt: 8, textTotal: 40, textPer: 5,
				liteCnt: 1, // âœ¨ é è¨­ 1 é¡Œç´ é¤Šé¡Œ
				fileCnt: 0, fileTotal: 0, filePer: 10,
				enableHint: false, scoreType: 'quiz'
			};

			if (cache) {
				try { s = { ...s, ...JSON.parse(cache) }; } catch(e) {}
			}

			// å›å¡« UI
			const modeRadio = document.querySelector(`input[name="m1-calc-mode"][value="${s.mode}"]`);
			if (modeRadio) modeRadio.checked = true;
			
			document.getElementById('m1-choice-count').value = s.choiceCnt;
			document.getElementById('m1-choice-total-input').value = s.choiceTotal;
			document.getElementById('m1-choice-per-input').value = s.choicePer;

			document.getElementById('m1-text-count').value = s.textCnt;
			document.getElementById('m1-text-total-input').value = s.textTotal;
			document.getElementById('m1-text-per-input').value = s.textPer;

			// âœ¨ å›å¡«ç´ é¤Šé¡Œæ•¸
			if(document.getElementById('m1-lite-count')) {
				document.getElementById('m1-lite-count').value = s.liteCnt;
			}

			document.getElementById('m1-file-count').value = s.fileCnt;
			document.getElementById('m1-file-total-input').value = s.fileTotal;
			document.getElementById('m1-file-per-input').value = s.filePer;

			document.getElementById('m1-enable-hint').checked = s.enableHint;
			
			const typeRadio = document.querySelector(`input[name="m1-type"][value="${s.scoreType}"]`);
			if (typeRadio) typeRadio.checked = true;

			// é€™è£¡æˆ‘å€‘ä¸éœ€è¦æ”¹ toggleM1CalcModeï¼Œå› ç‚ºæˆ‘å€‘æ²’æœ‰æ–°å¢æ¬„ä½ï¼Œåªæ˜¯æ–°å¢ä¸€å€‹å±¬æ€§è¼¸å…¥æ¡†
			toggleM1CalcMode();
			toggleM1ScoreMode(s.scoreType);
			onM1InputChanged();
		}

		// ğŸ› ï¸ [ä¿®æ­£ç‰ˆ] runMode1AI: ä¿®æ­£åœ–ç‰‡å°ºå¯¸ (1/4) èˆ‡ ç´ æé¢¨æ ¼ (é»‘ç™½ç·šæ¢)
		window.runMode1AI = async function() {
			if (!window.GenAI) return alert("éŒ¯èª¤ï¼šGemini SDK æœªè¼‰å…¥");
			
			saveM1Cache(); 

			// A. å–å¾—è¨­å®šåƒæ•¸
			const scoreMode = document.querySelector('input[name="m1-type"]:checked').value;
			const calcMode = document.querySelector('input[name="m1-calc-mode"]:checked').value;
			const enableHint = document.getElementById('m1-enable-hint').checked;
			const enableAutoImage = document.getElementById('m1-auto-image').checked;
			
			// ... (å–å¾—é¡Œæ•¸èˆ‡é…åˆ†è®Šæ•¸ï¼Œç¶­æŒåŸæ¨£) ...
			const choiceCnt = parseInt(document.getElementById('m1-choice-count').value) || 0;
			const textCnt = parseInt(document.getElementById('m1-text-count').value) || 0;
			const fileCnt = parseInt(document.getElementById('m1-file-count').value) || 0;
			
			// âœ¨ å–å¾—ç´ é¤Šé¡Œæ•¸
			const liteCnt = parseInt(document.getElementById('m1-lite-count').value) || 0;
			
			const choiceTotalVal = parseInt(document.getElementById('m1-choice-total-input').value) || 0;
			const choicePerVal   = parseInt(document.getElementById('m1-choice-per-input').value) || 0;
			const textTotalVal   = parseInt(document.getElementById('m1-text-total-input').value) || 0;
			const textPerVal     = parseInt(document.getElementById('m1-text-per-input').value) || 0;
			const fileTotalVal   = parseInt(document.getElementById('m1-file-total-input').value) || 0;
			const filePerVal     = parseInt(document.getElementById('m1-file-per-input').value) || 0;

			// B. çµ„è£é…åˆ†æè¿°
			let descChoice = "", descText = "", descFile = "";
			if (scoreMode === 'record') {
				descChoice = "ä¸è¨ˆåˆ†"; descText = "ä¸è¨ˆåˆ†"; descFile = "ä¸è¨ˆåˆ†";
			} else {
				if (calcMode === 'total') {
					descChoice = `ç¸½é…åˆ† ${choiceTotalVal} åˆ†`; descText = `ç¸½é…åˆ† ${textTotalVal} åˆ†`; descFile = `ç¸½é…åˆ† ${fileTotalVal} åˆ†`;
				} else {
					descChoice = `æ¯é¡Œ ${choicePerVal} åˆ†`; descText = `æ¯é¡Œ ${textPerVal} åˆ†`; descFile = `æ¯é¡Œ ${filePerVal} åˆ†`;
				}
			}

			let aiParts = [];
			const statusEl = document.getElementById('m1-status-msg');
			const runBtn = document.getElementById('btn-run-mode1');
			const originalBtnHtml = runBtn.innerHTML;

			runBtn.disabled = true;
			runBtn.innerHTML = '<span class="animate-spin text-lg">â†»</span> AI æ­£åœ¨è¨­è¨ˆé¡Œç›®...';

			try {
				// C. æº–å‚™æ•™æå…§å®¹ (ç¶­æŒåŸæ¨£)
				const isFileMode = !document.getElementById('m1-content-pdf').classList.contains('hidden');
				if (isFileMode) {
					const fileInput = document.getElementById('m1-upload-pdf');
					if (fileInput.files.length === 0) throw new Error("è«‹å…ˆä¸Šå‚³æ•™ææª”æ¡ˆ");
					const file = fileInput.files[0];
					const lowerName = file.name.toLowerCase();
					const arrayBuffer = await file.arrayBuffer();
					statusEl.textContent = `ğŸ“– æ­£åœ¨è®€å–æª”æ¡ˆ: ${file.name}...`;

					if (lowerName.endsWith('.pdf')) {
						const base64Data = await fileToBase64(file);
						aiParts.push({ inlineData: { data: base64Data, mimeType: "application/pdf" } });
					} else if (lowerName.endsWith('.docx')) {
						const text = await extractTextFromDocx(arrayBuffer);
						aiParts.push({ text: "æ•™æ(Word)ï¼š\n" + text });
					} else if (lowerName.endsWith('.pptx')) {
						const text = await extractTextFromPptx(arrayBuffer);
						aiParts.push({ text: "æ•™æ(PPT)ï¼š\n" + text });
					}
				} else {
					const textVal = document.getElementById('m1-text-input').value.trim();
					aiParts.push({ text: "æ•™æå…§å®¹ï¼š\n" + textVal });
				}

				statusEl.textContent = "ğŸ§  AI æ­£åœ¨æ§‹æ€é¡Œç›®èˆ‡è¦–è¦ºç•«é¢...";
				
				const hintInstruction = enableHint 
					? `- [é‡è¦] æ¯å€‹é¡Œç›®å¿…é ˆåŒ…å« "hint" æ¬„ä½ã€‚HTML ä¸­ç”Ÿæˆæç¤ºæŒ‰éˆ•ã€‚`
					: `- ä¸è¦åœ¨ HTML ä¸­ç”Ÿæˆæç¤ºæŒ‰éˆ•ã€‚`;

				const forceImageInstruction = enableAutoImage 
					? `\nâš ï¸âš ï¸ã€å¼·åˆ¶é…åœ–æŒ‡ä»¤ã€‘ä½¿ç”¨è€…å·²é–‹å•Ÿã€Œè‡ªå‹•é…åœ–æ¨¡å¼ã€ã€‚è«‹å‹™å¿…å°‡30%ä»¥ä¸Šé¡Œç›®è¨­è¨ˆç‚ºã€Œçœ‹åœ–å›ç­”ã€ã€‚è«‹åœ¨ JSON ç”Ÿæˆ "image_prompt" ä¸¦åœ¨ HTML æ’å…¥ img æ¨™ç±¤ã€‚âš ï¸âš ï¸\n`
					: "";

				// ğŸŸ¢ğŸŸ¢ğŸŸ¢ ä¿®æ”¹ System Promptï¼šç¸®å°å°ºå¯¸ + ç´ æé¢¨æ ¼ ğŸŸ¢ğŸŸ¢ğŸŸ¢
				let systemPrompt = `
					ä½ æ˜¯ä¸€ä½å°ˆæ¥­æ•™å¸«ã€‚è«‹æ ¹æ“šæ•™æè¨­è¨ˆ HTML5 äº’å‹•å­¸ç¿’å–®ã€‚

					ã€å‡ºé¡Œèˆ‡é…åˆ†ã€‘
					1. é¸æ“‡é¡Œï¼š${choiceCnt} é¡Œï¼Œ${descChoice}ã€‚
					2. ç°¡ç­”/å¡«å……ï¼š${textCnt} é¡Œï¼Œ${descText}ã€‚
					3. å¯¦ä½œä¸Šå‚³ï¼š${fileCnt} é¡Œï¼Œ${descFile}ã€‚
					${scoreMode==='quiz' ? '' : '(ç·´ç¿’æ¨¡å¼ï¼Œåˆ†æ•¸è¨­ç‚º 0)ã€‚'}
					${forceImageInstruction}

					ã€ğŸŒŸ ç´ é¤Šé¡ŒæŒ‡ä»¤ (é‡è¦)ã€‘
					**åœ¨ä¸Šè¿° ${choiceCnt + textCnt} é¡Œé¸æ“‡èˆ‡å¡«å……é¡Œä¸­ï¼Œè«‹å‹™å¿…å°‡å…¶ä¸­ ${liteCnt} é¡Œè¨­è¨ˆç‚ºã€Œç´ é¤Šå°å‘è©¦é¡Œã€ã€‚**
					- **åˆ†ä½ˆ**ï¼šè«‹éš¨æ©ŸæŒ‘é¸é¡Œè™Ÿï¼ˆå¯ç‚ºé¸æ“‡é¡Œæˆ–ç°¡ç­”é¡Œï¼‰ï¼Œå°‡å…¶æ”¹å¯«ç‚ºç´ é¤Šé¡Œã€‚
					- **å…§å®¹**ï¼šå¿…é ˆåŒ…å«çœŸå¯¦æƒ…å¢ƒã€æ•¸æ“šåˆ¤è®€ã€è·¨é ˜åŸŸæ‡‰ç”¨æˆ–è§£æ±ºå•é¡Œçš„éç¨‹ã€‚é¿å…å–®ç´”çš„åè©è§£é‡‹ã€‚
					- **æ¨™ç¤º**ï¼šè«‹åœ¨è©²é¡Œç›®çš„ \`label\` é–‹é ­åŠ ä¸Š \`[ç´ é¤Š]\` æ¨™ç±¤ (ä¾‹å¦‚ï¼š"[ç´ é¤Š] å°æ˜åœ¨å¯¦é©—ä¸­ç™¼ç¾...")ã€‚
		
					ã€âœ¨ æ’ç‰ˆè¦ç¯„ (ä¿ç•™)ã€‘
					1. é¸æ“‡é¡Œé¸é …ç·¨è™Ÿç”¨æ‹¬å¼§æ‹¬èµ·ä¾†ï¼Œå…§å®¹ä¾åºç‚º radio button+ç·¨è™Ÿç²—é«”+ç•™ç™½+é¸é …æ–‡å­—
					2. å¤§é¡Œæ–‡å­—æ”¾å¤§ç²—é«”ã€ç·¨è™Ÿ(ä¸€ã€äºŒ)ã€ä¸åˆ†é ã€‚
					3. é¡Œç›®èˆ‡é¸é …é–“è·é…ç½®ï¼Œä¸ä½¿ç”¨è‡ªå‹•ç·¨è™Ÿã€‚
					4. é¡Œç›®å¾Œç·Šæ¥æ‹¬å¼§é¡¯ç¤ºåˆ†æ•¸ã€‚
					5. ** å¡«å……é¡Œç©ºæ ¼ä½ç½®ç›´æ¥ä½¿ç”¨HTMLè¼¸å…¥å…ƒç´ ä¸¦åŠ æ¡†ç·šï¼Œä¸è¦é¡¯ç¤ºåº•ç·šç•™ç©ºã€‚ **
					6. é¸é …èˆ‡é¡Œç›®é–“ä¸ç©ºè¡Œï¼Œé¸é …å¾ŒåŠ ä¸‰å€‹ä¸­æ–‡ç©ºç™½, å„é¸é …ç›¸é€£ï¼Œä¸è¦è·³è¡Œ
					7. å„é¡Œé–“è¦ç©ºä¸€è¡Œ
					8. è­˜åˆ¥æ•™æä¸­çš„åœ–ç‰‡/åœ–è¡¨ä¸¦è¨­è¨ˆå…¥é¡Œã€‚
					9. ä¸ç”¨ç”Ÿæˆé¡¯ç¤ºå­¸ç¿’å–®æ¨™é¡Œï¼Œå¾å¤§é¡Œé–‹å§‹é¡¯ç¤ºå³å¯
					10. **ç´ é¤Šé¡Œ**è‹¥é¡Œå¹¹è¼ƒé•·ï¼Œè«‹é©ç•¶ä½¿ç”¨ \`<br>\` æ›è¡Œï¼Œä½¿å…¶æ˜“æ–¼é–±è®€ã€‚
					11. çµ•å°ä¸èƒ½ä½¿ç”¨ç°¡é«”å­—
					12. åœ–å½¢é¡Œçš„åœ–å½¢è¦ç½®æ–¼é¡Œç›®ä¸‹æ–¹ï¼Œè€Œä¸”åœ¨åœ–çš„å³é‚Šè¦é¡¯ç¤ºåœ–çš„ç·¨è™Ÿï¼Œä¾‹å¦‚åœ–(ä¸€)ï¼Œè€Œä¸”åœ¨é¡Œç›®å…§åƒè€ƒåœ–çš„æ™‚å€™è¦å°‡åœ–çš„ç·¨è™Ÿä¹Ÿå¯«å‡ºä¾†ï¼Œä¾‹å¦‚ï¼šè¦‹ä¸‹åœ–(ä¸€)

					ã€âœ¨ åœ–ç‰‡èˆ‡ç¹ªåœ–è¦ç¯„ (CRITICAL UPDATE)ã€‘
					1. **SVG (é¦–é¸)**ï¼šç°¡å–®å¹¾ä½•/åœ–è¡¨è«‹ç›´æ¥å¯« <svg>ã€‚
					2. **AI ç”Ÿæˆåœ– (Image Generation)**ï¼š
					   - è‹¥éœ€è¦æƒ…å¢ƒåœ–ï¼Œè«‹åœ¨ HTML æ’å…¥ï¼š
						 \`<img id="img_{ID}" src="https://placehold.co/300x300?text=Generating..." class="ai-generated-img block mx-auto my-2 rounded shadow" style="max-width: 250px; width: auto;">\`
					   - **(é‡é» 1: å°ºå¯¸)** style å¿…é ˆåŒ…å« \`max-width: 250px;\` (ç´„ç‰ˆé¢ 1/4)ï¼Œé¿å…åœ–ç‰‡éå¤§ã€‚
					   - **(é‡é» 2: é¢¨æ ¼)** åœ¨ JSON çš„ \`"image_prompt"\` æ¬„ä½ä¸­ï¼Œæè¿°å¿…é ˆåŒ…å«ï¼š
						 "black and white line art sketch, simple clean lines, pure white background"
						 (é»‘è‰²ç·šæ¢ã€æ¨™ç¤ºæ¸…æ¥šã€ç´”ç™½èƒŒæ™¯ã€ç„¡è¤‡é›œé™°å½±ã€æ•™ç§‘æ›¸æ’åœ–é¢¨æ ¼)ã€‚

					ã€è¼¸å‡ºæ ¼å¼è¦ç¯„ã€‘
					åˆ†é–‹è¼¸å‡º HTML èˆ‡ JSONã€‚

					\`\`\`html
					<div class="p-4 space-y-4">
					   <div>
						  <img id="img_u1_q1" src="..." style="max-width: 250px; display:block; margin: 10px auto;">
						  1. è«‹è§€å¯Ÿä¸Šåœ–... (4åˆ†)
					   </div>
					</div>
					\`\`\`

					\`\`\`json
					{
					   "u1_q1": {
						   "label": "1. ...",
						   "answer": "A",
						   "points": 4,
						   "type": "choice",
						   "image_prompt": "A simple black and white line art sketch of a microscope, pure white background." 
					   }
					}
					\`\`\`
					${hintInstruction}
				`;

				aiParts.push({ text: systemPrompt });

				// E. å‘¼å« Gemini
				const genAI = new window.GenAI(GEMINI_API_KEY);
				const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });
				const result = await model.generateContent(aiParts);
				const text = await result.response.text();

				// F. è§£æ
				let htmlContent = "", jsonContent = "{}";
				const htmlMatch = text.match(/```html\s*([\s\S]*?)\s*```/i);
				if (htmlMatch) htmlContent = htmlMatch[1].trim();
				else if (text.includes("<div")) htmlContent = text.substring(text.indexOf("<div"), text.lastIndexOf("</div>")+6);

				const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/i);
				if (jsonMatch) jsonContent = jsonMatch[1].trim();
				else { const s = text.indexOf('{'), e = text.lastIndexOf('}'); if(s!==-1 && e!==-1) jsonContent = text.substring(s, e+1); }

				let answerKey = {};
				try { answerKey = JSON.parse(jsonContent); } catch (e) { console.error(e); }
				if (!htmlContent) throw new Error("AI æœªå›å‚³ HTML");

				// G. åœ–ç‰‡ç”Ÿæˆè¿´åœˆ
				const questionsWithImg = Object.entries(answerKey).filter(([_, data]) => data.image_prompt);
				const totalImages = questionsWithImg.length;
				
				if (totalImages > 0) {
					statusEl.textContent = `ğŸ¨ æº–å‚™ç¹ªè£½ ${totalImages} å¼µæ’åœ–...`;
					const tempDiv = document.createElement('div');
					tempDiv.innerHTML = htmlContent;
					let completedCount = 0;

					const imgPromises = questionsWithImg.map(async ([qId, data]) => {
						try {
							// å‘¼å« API (æœƒå¼·åˆ¶ç–ŠåŠ ç´ æ Prompt)
							const imageUrl = await realGenerateImageAPI(data.image_prompt);
							
							completedCount++;
							statusEl.textContent = `ğŸ¨ æ­£åœ¨ç¹ªè£½ç¬¬ ${completedCount} / ${totalImages} å¼µ...`;
							
							const imgTag = tempDiv.querySelector(`img[id="img_${qId}"]`);
							if (imgTag) {
								imgTag.src = imageUrl;
								// å¼·åˆ¶ç¢ºä¿å°ºå¯¸æ¨£å¼ (ä»¥é˜² AI å¿˜è¨˜å¯« style)
								imgTag.style.maxWidth = '250px';
								imgTag.style.display = 'block';
								imgTag.style.margin = '10px auto';
								data.generated_image = imageUrl;
							}
						} catch (err) {
							console.error(`åœ–ç‰‡ç”Ÿæˆå¤±æ•— (${qId}):`, err);
							completedCount++;
						}
					});

					await Promise.all(imgPromises);
					htmlContent = tempDiv.innerHTML;
				}

				// H. å¡«å…¥çµæœ
				document.getElementById('ws-html').value = htmlContent;
				document.getElementById('ws-json').value = JSON.stringify(answerKey, null, 4);
				
				let fileName = "AI ç”Ÿæˆå­¸ç¿’å–®";
				if(isFileMode && document.getElementById('m1-upload-pdf').files[0]) 
					 fileName = document.getElementById('m1-upload-pdf').files[0].name.split('.')[0];
				document.getElementById('ws-title').value = fileName;
				document.getElementById('source-code-area').classList.remove('hidden');
				closeMode1Modal();
				document.getElementById('preview-btn').click();
				
				if (window.MathJax) window.MathJax.typesetPromise([document.getElementById('preview-content')]);
				
				let msg = `ğŸ‰ å®Œæˆï¼å…± ${Object.keys(answerKey).length} é¡Œã€‚`;
				if (totalImages > 0) msg += `\n(å·²ç”Ÿæˆ ${totalImages} å¼µç´ æé…åœ–)`;
				alert(msg);

			} catch (e) {
				console.error(e);
				statusEl.textContent = "âŒ éŒ¯èª¤: " + e.message;
				alert("ç”Ÿæˆå¤±æ•—: " + e.message);
			} finally {
				runBtn.disabled = false;
				runBtn.innerHTML = originalBtnHtml;
			}
		};

		// ğŸ› ï¸ [å¾®èª¿ç‰ˆ] realGenerateImageAPI: å¼·åˆ¶ç–ŠåŠ ç´ æé¢¨æ ¼ Prompt
		async function realGenerateImageAPI(prompt) {
			const API_KEY = "AIzaSyApaFU-uDxigWjDzGEJ5cY5qsJ5oFtXxaE";
			const MODEL_NAME = "imagen-4.0-generate-preview-06-06";
			const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:predict?key=${API_KEY}`;

			// ğŸŸ¢ å¼·åˆ¶æ·»åŠ é¢¨æ ¼é—œéµå­—ï¼Œç¢ºä¿ä¸€å®šæ˜¯é»‘ç™½ç´ æ
			const styleSuffix = ", black and white pencil sketch, line art, pure white background, minimal style, high contrast, no colors";
			const finalPrompt = prompt + styleSuffix;

			const payload = {
				instances: [{ prompt: finalPrompt }],
				parameters: { sampleCount: 1, aspectRatio: "1:1", outputFormat: "image/png" }
			};

			try {
				console.log(`ğŸš€ ç¹ªåœ– Prompt: ${finalPrompt}`);
				const response = await fetch(url, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});

				if (!response.ok) throw new Error(`API éŒ¯èª¤ (${response.status})`);
				const result = await response.json();

				if (result.predictions && result.predictions.length > 0) {
					const b64Image = result.predictions[0].bytesBase64Encoded;
					return `data:image/png;base64,${b64Image}`;
				} else {
					throw new Error("No image data");
				}
			} catch (error) {
				console.error("åœ–ç‰‡ç”Ÿæˆå¤±æ•—:", error);
				return `https://placehold.co/250x250?text=Error`;
			}
		}
			
		// 1. è¼”åŠ©ï¼šè§£æ DOCX æ–‡å­— (Mammoth) - å› ç‚º API ä¸åƒ DOCXï¼Œæ‰€ä»¥å¿…é ˆè½‰
		async function extractTextFromDocx(arrayBuffer) {
			if (!window.mammoth) throw new Error("Mammoth library not loaded");
			const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
			return result.value; 
		}

		// 2. è¼”åŠ©ï¼šè§£æ PPTX æ–‡å­— (JSZip) - å› ç‚º API ä¸åƒ PPTXï¼Œæ‰€ä»¥å¿…é ˆè½‰
		async function extractTextFromPptx(arrayBuffer) {
			if (!window.JSZip) throw new Error("JSZip library not loaded");
			const zip = await JSZip.loadAsync(arrayBuffer);
			const slideFiles = Object.keys(zip.files).filter(name => name.match(/^ppt\/slides\/slide\d+\.xml$/));
			
			// æ’åºæŠ•å½±ç‰‡
			slideFiles.sort((a, b) => {
				const numA = parseInt(a.match(/slide(\d+)\.xml/)[1]);
				const numB = parseInt(b.match(/slide(\d+)\.xml/)[1]);
				return numA - numB;
			});

			let fullText = "";
			for (const filename of slideFiles) {
				const str = await zip.file(filename).async("string");
				const parser = new DOMParser();
				const xmlDoc = parser.parseFromString(str, "text/xml");
				const texts = xmlDoc.getElementsByTagName("a:t");
				let slideText = "";
				for (let i = 0; i < texts.length; i++) {
					slideText += texts[i].textContent + " ";
				}
				if (slideText.trim()) fullText += slideText + "\n";
			}
			return fullText;
		}

		// 3. è¼”åŠ©ï¼šæª”æ¡ˆè½‰ Base64 (çµ¦ PDF ç”¨)
		function fileToBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.onload = () => resolve(reader.result.split(',')[1]);
				reader.onerror = error => reject(error);
				reader.readAsDataURL(file);
			});
		}

		window.openMode2GuideModal = function() {
			var modal = document.getElementById('mode2-guide-modal');
			if (!modal) return;

			// 1. å¼·åˆ¶ç§»åˆ° Body æœ€å°¾ç«¯
			if (modal.parentElement !== document.body) {
				document.body.appendChild(modal);
			}

			// 2. å¼·åˆ¶é¡¯ç¤ºä¸¦è¨­å®šæœ€é«˜å±¤ç´š
			modal.classList.remove('hidden');
			modal.style.setProperty('display', 'flex', 'important');
			modal.style.setProperty('z-index', '2147483647', 'important');

			// å®šç¾©å…±ç”¨çš„é—œé–‰å‹•ä½œ (ç§»é™¤å¼·åˆ¶æ¨£å¼)
			var closeModal = function() {
				modal.classList.add('hidden');
				modal.style.removeProperty('display');
				modal.style.removeProperty('z-index');
			};

			// 3. é‡æ–°ç¶å®šã€Œå³ä¸Šè§’ Xã€æŒ‰éˆ•
			var closeBtn = modal.querySelector('button.text-2xl');
			if (closeBtn) {
				closeBtn.onclick = closeModal;
			}

			// 4. [æ–°å¢] é‡æ–°ç¶å®šåº•éƒ¨ã€Œæˆ‘çŸ¥é“äº†ã€æŒ‰éˆ•
			// é€éå…¶çˆ¶å®¹å™¨çš„ class (.rounded-b-xl) ä¾†ç²¾æº–æ‰¾åˆ°å®ƒ
			var okBtn = modal.querySelector('.rounded-b-xl button');
			if (okBtn) {
				okBtn.onclick = closeModal;
			}
		};
		
		window.confirmGradingExit = () => {
			const rightPanel = document.getElementById('grading-right-panel');
			if (rightPanel.classList.contains('hidden')) {
				document.getElementById('grading-modal').classList.add('hidden');
				return;
			}
			document.getElementById('grading-exit-modal').classList.remove('hidden');
		};

		window.saveDraftAndExit = () => {
			try {
				const data = collectCurrentGradingData();
				const key = `grading_draft_${currentGradingResponseId}`;
				localStorage.setItem(key, JSON.stringify(data));
				document.getElementById('grading-exit-modal').classList.add('hidden');
				document.getElementById('grading-modal').classList.add('hidden');
			} catch (e) {
				alert('æš«å­˜å¤±æ•— (å¯èƒ½æ˜¯å„²å­˜ç©ºé–“å·²æ»¿)');
			}
		};

		window.discardAndExit = () => {
			document.getElementById('grading-exit-modal').classList.add('hidden');
			document.getElementById('grading-modal').classList.add('hidden');
		};

		window.showQuestionContext = (key) => {
			if (!currentAnalysisHtmlContent) {
				alert("âš ï¸ ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è®€å–é¡Œç›®å…§å®¹ (HTML æœªè¼‰å…¥)");
				return;
			}

			const contentDiv = document.getElementById('view-modal-content');
			contentDiv.innerHTML = currentAnalysisHtmlContent;
			document.getElementById('view-modal-title').textContent = 'é¡Œç›®å…§å®¹æª¢è¦–';

			const modal = document.getElementById('view-modal');
			modal.classList.remove('hidden');

			executeEmbeddedScripts(contentDiv).then(() => {
				setTimeout(async () => {
					let targetInput = contentDiv.querySelector(`[name="${CSS.escape(key)}"]`);
					if (!targetInput) {
						targetInput = contentDiv.querySelector(`[name="${key}"]`);
					}

					if (targetInput) {
						if (targetInput.offsetParent === null) {
							let curr = targetInput.parentElement;
							let foundTab = false;

							while (curr && curr !== contentDiv) {
								const style = window.getComputedStyle(curr);
								if (style.display === 'none' || curr.classList.contains('hidden')) {
									if (curr.id) {
										const tabTrigger = contentDiv.querySelector(`a[href="#${curr.id}"], button[data-target="#${curr.id}"], label[for="${curr.id}"], [onclick*="${curr.id}"]`);
										
										if (tabTrigger) {
											tabTrigger.click(); 
											foundTab = true;
											await new Promise(r => setTimeout(r, 100));
											break;
										}
									}
									if (!foundTab) {
										curr.classList.remove('hidden');
										curr.style.display = 'block';
										foundTab = true;
									}
								}
								curr = curr.parentElement;
							}
						}

						const scrollContainer = contentDiv.parentElement;
						const elementRect = targetInput.getBoundingClientRect();
						const containerRect = scrollContainer.getBoundingClientRect();

						if (elementRect.height > 0) {
							const offsetTop = elementRect.top - containerRect.top + scrollContainer.scrollTop;
							const centerPosition = offsetTop - (scrollContainer.clientHeight / 2) + (elementRect.height / 2);

							scrollContainer.scrollTo({
								top: centerPosition,
								behavior: 'smooth'
							});

							let highlightTarget = targetInput;
							if ((targetInput.type === 'radio' || targetInput.type === 'checkbox') && targetInput.parentElement) {
								highlightTarget = targetInput.parentElement;
							}

							const originalShadow = highlightTarget.style.boxShadow;
							const originalTransition = highlightTarget.style.transition;
							const originalBg = highlightTarget.style.backgroundColor;

							highlightTarget.style.transition = "all 0.5s ease";
							highlightTarget.style.boxShadow = "0 0 0 6px rgba(251, 191, 36, 0.8)";
							highlightTarget.style.backgroundColor = "rgba(254, 243, 199, 0.5)";

							setTimeout(() => {
								highlightTarget.style.boxShadow = originalShadow || "";
								highlightTarget.style.backgroundColor = originalBg || "";
								highlightTarget.style.transition = originalTransition || "";
							}, 2000);
						} 

					} else {
						const fuzzyInput = contentDiv.querySelector(`[name*="${key}"]`);
						if (fuzzyInput) {
							fuzzyInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
						} else {
							alert(`æ‰¾ä¸åˆ°é¡Œç›® (name="${key}")ï¼Œè«‹ç¢ºèª HTML çµæ§‹ã€‚`);
						}
					}
				}, 300);
			});
		};
		
		window.closeResultSummaryModal = function() {
			const modal = document.getElementById('result-summary-modal');
			if (modal) {
				modal.classList.add('hidden');
				modal.style.display = 'none'; // å¼·åˆ¶éš±è—
				// æ¸…ç©ºå…§å®¹ä»¥é˜²ä¸‹æ¬¡é–‹å•Ÿæ®˜ç•™
				const tbody = document.getElementById('res-table-body');
				if(tbody) tbody.innerHTML = ''; 
			}
		};

		/* ğŸ› ï¸ [ä¿®æ­£ç‰ˆ] openResultSummaryModal */
		window.openResultSummaryModal = async function(rid, wid, sname, wsTitle) {
			console.log("ğŸš€ é–‹å•Ÿä½œæ¥­æª¢è¦–:", wsTitle);

			const modal = document.getElementById('result-summary-modal');
			if (modal && modal.parentNode !== document.body) document.body.appendChild(modal);

			try {
				const titleEl = document.getElementById('res-modal-title');
				const nameEl = document.getElementById('res-student-name');
				const scoreEl = document.getElementById('res-total-score');
				
				const htmlView = document.getElementById('res-html-view');
				const tableViewContainer = document.getElementById('res-table-container');
				const systemTabs = document.getElementById('res-tabs-area');

				// âŒ ç§»é™¤é€™è£¡çš„ scrollTop = 0ï¼Œå› ç‚ºæ­¤æ™‚å…ƒç´ å¯èƒ½æ˜¯éš±è—çš„ï¼Œè¨­å®šç„¡æ•ˆ

				// å¼·åˆ¶éš±è— Tab (é›™é‡ä¿éšª)
				if (systemTabs) systemTabs.classList.add('hidden');

				if (titleEl) titleEl.textContent = wsTitle;
				if (nameEl) nameEl.textContent = sname;
				if (scoreEl) scoreEl.textContent = '...';

				modal.classList.remove('hidden');
				modal.style.display = 'flex';
				
				htmlView.innerHTML = '<div class="text-center p-10"><div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 rounded-full border-t-transparent"></div><p class="mt-2 text-gray-500">è¼‰å…¥ä½œç­”å…§å®¹...</p></div>';
				
				// åˆå§‹ç‹€æ…‹
				htmlView.classList.remove('hidden');
				tableViewContainer.classList.add('hidden');

				const [rDoc, wd] = await Promise.all([
					db.collection('responses').doc(rid).get(), 
					getSmartWorksheetData(wid)
				]);

				if (!rDoc.exists || !wd) throw new Error("è³‡æ–™åº«æ‰¾ä¸åˆ°æ­¤ä½œæ¥­æˆ–å­¸ç¿’å–®");

				const rd = rDoc.data();
				currentAnalysisHtmlContent = wd.html_content; 
				const studentAns = rd.answers || {};
				const ansKey = wd.answer_key || {};

				if (scoreEl) scoreEl.textContent = (rd.score !== undefined && rd.score !== "") ? rd.score : '--';

				let totalMaxPoints = 0;
				Object.values(ansKey).forEach(q => { totalMaxPoints += (parseInt(q.points) || 0); });

				if (totalMaxPoints > 0) {
					// ğŸ‘‰ A: æ¸¬é©—æ¨¡å¼ (è¡¨æ ¼)
					htmlView.classList.add('hidden');
					
					// ğŸŸ¢ 1. å…ˆè®“å®¹å™¨é¡¯ç¤ºå‡ºä¾†
					tableViewContainer.classList.remove('hidden');
					
					// ğŸŸ¢ 2. é¡¯ç¤ºå¾Œç«‹å³æ­¸é›¶æ²è»¸ï¼Œé€™æ¨£æ‰æœ‰æ•ˆ
					tableViewContainer.scrollTop = 0; 
					
					await processTableModeLogic(wd, rd, studentAns, ansKey);

				} else {
					// ğŸ‘‰ B: å­¸ç¿’å–®æ¨¡å¼ (HTML)
					// ğŸŸ¢ 1. å…ˆè®“å®¹å™¨é¡¯ç¤ºå‡ºä¾†
					htmlView.classList.remove('hidden');
					tableViewContainer.classList.add('hidden');
					
					// ğŸŸ¢ 2. é¡¯ç¤ºå¾Œç«‹å³æ­¸é›¶æ²è»¸
					htmlView.scrollTop = 0; 

					htmlView.innerHTML = wd.html_content;
					await executeEmbeddedScripts(htmlView);

					// ... (åŸæœ¬çš„è³‡æ–™å›å¡«é‚è¼¯ä¿æŒä¸è®Š) ...
					htmlView.querySelectorAll('input, select, textarea').forEach(input => {
						const fieldName = input.getAttribute('name');
						if (!fieldName) return;
						const studentValue = studentAns[fieldName];

						if (input.type === 'file') {
							input.style.display = 'none';
							if (studentValue) {
								const linkContainer = document.createElement('div');
								linkContainer.className = "mt-1";
								if (studentValue.match(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i)) {
									 linkContainer.innerHTML = `<a href="${studentValue}" target="_blank" class="block border rounded p-1 bg-gray-50 w-fit hover:border-blue-500 transition"><img src="${studentValue}" class="h-32 w-auto object-contain rounded"><span class="block text-xs text-center text-blue-600 mt-1">ğŸ–¼ï¸ æŸ¥çœ‹å¤§åœ–</span></a>`;
								} else {
									 linkContainer.innerHTML = `<a href="${studentValue}" target="_blank" class="worksheet-readonly-file-link">ğŸ“‚ ä¸‹è¼‰å­¸ç”Ÿä¸Šå‚³æª”æ¡ˆ</a>`;
								}
								input.parentNode.insertBefore(linkContainer, input.nextSibling);
							} else {
								const span = document.createElement('span');
								span.className = 'text-gray-400 text-xs italic ml-2';
								span.textContent = '(æœªä¸Šå‚³)';
								input.parentNode.insertBefore(span, input.nextSibling);
							}
						} else if (input.type === 'radio' || input.type === 'checkbox') {
							if (studentValue === input.value) input.checked = true;
							input.disabled = true;
						} else {
							if (studentValue !== undefined) input.value = studentValue;
							input.classList.add('worksheet-readonly-input');
							input.setAttribute('readonly', true);
							if (input.tagName === 'TEXTAREA') {
								 input.style.height = 'auto';
								 input.style.height = (input.scrollHeight + 5) + 'px';
								 input.style.resize = 'none';
							}
						}
					});
				}

			} catch(e) {
				console.error("é–‹å•Ÿæˆç¸¾å–®ç™¼ç”ŸéŒ¯èª¤:", e);
				alert("è®€å–å¤±æ•—ï¼š" + e.message);
			}
		};

		// ğŸŸ¡ è¼”åŠ©å‡½å¼ï¼šå°‡åŸæœ¬ç”¢ç”Ÿè¡¨æ ¼çš„é‚è¼¯æŠ½é›¢å‡ºä¾† (æ’åºé‚è¼¯ä¿®æ­£ç‰ˆ)
		async function processTableModeLogic(wd, rd, studentAns, ansKey) {
			const details = rd.grading_details || {};
			const unitMap = {}; 
			
			// è§£æ HTML å–å¾—å–®å…ƒæ¨™é¡Œ
			if (wd.html_content) {
				const parser = new DOMParser();
				const doc = parser.parseFromString(wd.html_content, 'text/html');
				const divs = doc.querySelectorAll('div[id][title]');
				divs.forEach(div => unitMap[div.id] = div.getAttribute('title'));
			}

			const units = {}; 
			const noUnitKey = 'default_section';
			let qCounter = 1; // é¡Œè™Ÿè¨ˆæ•¸å™¨

			// ğŸŸ¢ ä¿®æ­£ï¼šæ™ºæ…§æ’åºé‚è¼¯ (å…ˆæ¯” Unitï¼Œå†æ¯” Question)
			const sortedQIDs = Object.keys(ansKey).sort((a, b) => {
				// 1. å˜—è©¦å–å‡º u å¾Œé¢çš„æ•¸å­— (å–®å…ƒè™Ÿ)
				const unitMatchA = a.match(/u(\d+)/);
				const unitMatchB = b.match(/u(\d+)/);
				const unitA = unitMatchA ? parseInt(unitMatchA[1]) : 0;
				const unitB = unitMatchB ? parseInt(unitMatchB[1]) : 0;

				// å¦‚æœå–®å…ƒä¸åŒï¼Œå–®å…ƒå°çš„æ’å‰é¢
				if (unitA !== unitB) return unitA - unitB;

				// 2. å˜—è©¦å–å‡º q å¾Œé¢çš„æ•¸å­— (é¡Œè™Ÿ)
				// æ”¯æ´ u1_q10 æ ¼å¼ï¼Œä¹Ÿæ”¯æ´ç´” q10 æ ¼å¼
				const qMatchA = a.match(/q(\d+)/) || a.match(/(\d+)$/);
				const qMatchB = b.match(/q(\d+)/) || b.match(/(\d+)$/);
				const qA = qMatchA ? parseInt(qMatchA[1]) : 0;
				const qB = qMatchB ? parseInt(qMatchB[1]) : 0;

				// å¦‚æœå–®å…ƒç›¸åŒï¼Œé¡Œè™Ÿå°çš„æ’å‰é¢
				if (qA !== qB) return qA - qB;

				// å¦‚æœéƒ½æŠ“ä¸åˆ°æ•¸å­—ï¼Œå°±ç”¨å­—ä¸²è‡ªç„¶æ’åº
				return a.localeCompare(b);
			});

			sortedQIDs.forEach(qid => {
				const qData = ansKey[qid];
				let unitId = qData.unitId || noUnitKey;
				
				// å˜—è©¦è‡ªå‹•æ­¸é¡å–®å…ƒ
				if (unitId === noUnitKey) {
					const parts = qid.split('_');
					if (parts.length > 1 && unitMap[parts[0]]) unitId = parts[0];
				}
				
				let unitName = unitMap[unitId] || (unitId===noUnitKey ? 'ä½œç­”å…§å®¹' : unitId);
				if (!units[unitId]) units[unitId] = { name: unitName, questions: [] };

				// åˆ¤å®šç‹€æ…‹
				let statusIcon = '<span class="text-gray-300 font-bold text-sm">?</span>'; 

				// 1. æº–å‚™æ¯”å°è³‡æ–™ (è½‰æˆå­—ä¸²ä¸¦å»é™¤ç©ºç™½ï¼Œé¿å…æ ¼å¼å•é¡Œ)
				const valStd = (qData.answer !== undefined && qData.answer !== null) ? String(qData.answer).trim() : '';
				const valStu = (studentAns[qid] !== undefined && studentAns[qid] !== null) ? String(studentAns[qid]).trim() : '';
				const hasStdAns = valStd !== ''; // æ˜¯å¦æœ‰æ¨™æº–ç­”æ¡ˆ
				const hasStuAns = valStu !== ''; // å­¸ç”Ÿæ˜¯å¦æœ‰ä½œç­”

				// 2. å„ªå…ˆè®€å–ã€Œäººå·¥æ‰¹æ”¹ç´€éŒ„ã€
				// details[qid]?.is_correct è‹¥ç‚º undefined ä»£è¡¨æ²’æ”¹é
				const manualStatus = details[qid]?.is_correct; 

				if (manualStatus === true) {
					// A. è€å¸«æ‰‹å‹•æ”¹ï¼šå°
					statusIcon = '<span class="text-green-600 font-bold text-lg">â­•</span>';
				} else if (manualStatus === false) {
					// B. è€å¸«æ‰‹å‹•æ”¹ï¼šéŒ¯
					statusIcon = '<span class="text-red-500 font-bold text-lg">âŒ</span>';
				} else {
					// C. æ²’æ‰‹å‹•æ”¹ï¼Œé€²å…¥ã€Œè‡ªå‹•åˆ¤å®šã€é‚è¼¯
					if (hasStdAns && hasStuAns) {
						if (valStd === valStu) {
							// è‡ªå‹•åˆ¤å®šï¼šå°
							statusIcon = '<span class="text-green-600 font-bold text-lg">â­•</span>';
						} else {
							// âœ¨ã€ä¿®æ­£é—œéµã€‘ï¼šè‡ªå‹•åˆ¤å®šï¼šéŒ¯ (åŸæœ¬æ¼æ‰é€™æ®µ)
							// æœ‰æ¨™æº–ç­”æ¡ˆï¼Œå­¸ç”Ÿä¹Ÿæœ‰å¯«ï¼Œä½†ä¸ä¸€æ¨£ -> çµ¦ X
							statusIcon = '<span class="text-red-500 font-bold text-lg">âŒ</span>';
						}
					}
				}

				units[unitId].questions.push({
					id: qid,            
					label: qData.label || qid,
					statusHtml: statusIcon,
					answerRaw: studentAns[qid],
					correctAnswer: qData.answer,
					displayNum: qCounter++, // é€™è£¡çš„æ•¸å­—æœƒä¾ç…§ä¸Šé¢çš„ sortedQIDs é †åºç”¢ç”Ÿ
					sortNum: 999 
				});
			});
			
			// å­˜å…¥å…¨åŸŸè®Šæ•¸ä¸¦æ¸²æŸ“
			//window.currentResultData = { units, keys: Object.keys(units).sort() };
			//renderResultTabs(Object.keys(units)[0]); 
			
			window.currentResultData = { units, keys: Object.keys(units).sort() };
			renderResultTable(); // ç›´æ¥æ¸²æŸ“åˆ—è¡¨ï¼Œä¸è¦ç¶“é Tab å‡½å¼
		}		

		function renderResultTabs(activeKey) {
			const tabsArea = document.getElementById('res-tabs-area');
			const data = window.currentResultData; // Access global safely
			if (!data) return;

			const unitKeys = data.keys;
			
			tabsArea.innerHTML = '';
			tabsArea.classList.remove('hidden');

			unitKeys.forEach(key => {
				const u = data.units[key];
				const btn = document.createElement('button');
				btn.className = `result-tab ${key === activeKey ? 'active' : ''}`;
				btn.textContent = u.name;
				btn.onclick = () => {
					document.querySelectorAll('.result-tab').forEach(b => b.classList.remove('active'));
					btn.classList.add('active');
					renderResultTable(key);
				};
				tabsArea.appendChild(btn);
			});
			
			renderResultTable(activeKey);
		}

		/* ğŸ› ï¸ ä¿®æ”¹ï¼šrenderResultTable (ä¿®æ­£æ¬„ä½é‡è¤‡å•é¡Œ) */
		function renderResultTable() {
			const tbody = document.getElementById('res-table-body');
			if (!tbody) return;

			const allData = window.currentResultData; 
			if (!allData || !allData.keys) return;

			let html = '';

			allData.keys.forEach(unitKey => {
				const unitData = allData.units[unitKey];
				const questions = unitData.questions || [];

				if (questions.length > 0) {
					// 1. å–®å…ƒæ¨™é¡Œ
					if (unitKey !== 'default_section' || allData.keys.length > 1) {
						html += `
							<tr class="bg-blue-50 border-b border-blue-200">
								<td colspan="4" class="py-2 px-3 text-left font-bold text-blue-800 text-sm pl-4">
									ğŸ“‚ ${unitData.name}
								</td>
							</tr>
						`;
					}

					// 2. é¡Œç›®åˆ—è¡¨
					questions.forEach(q => {
						html += '<tr class="border-b border-gray-100 hover:bg-gray-50 transition group">';
						
						// é¡Œè™Ÿ
						html += `<td class="p-2 text-center text-gray-700 font-bold text-base">${q.displayNum || q.sortNum}</td>`;
						
						// é¡Œç›®åç¨± (ä¿®æ­£ï¼šåŸæœ¬é€™è£¡é‡è¤‡äº†å…©æ¬¡ tdï¼Œç¾åœ¨åªä¿ç•™å¸¶æœ‰æŒ‰éˆ•çš„é€™ä¸€å€‹)
						html += `
							<td class="p-2 text-gray-800 text-sm leading-tight relative">
								<div class="flex items-center justify-between">
									<span>${q.label}</span>
									<button onclick="showQuestionContext('${q.id}')" class="opacity-0 group-hover:opacity-100 transition-opacity ml-2 text-xs bg-blue-100 hover:bg-blue-600 hover:text-white text-blue-600 px-2 py-0.5 rounded cursor-pointer" title="æŸ¥çœ‹åŸå§‹é¡Œç›®">
										ğŸ‘ï¸
									</button>
								</div>
							</td>`;
						
						// å°éŒ¯ Icon
						html += `<td class="p-2 text-center">${q.statusHtml}</td>`;

						let correctDisp = q.correctAnswer;
						if (correctDisp === undefined || correctDisp === null || String(correctDisp).trim() === '') {
							correctDisp = '<span class="text-gray-300 text-xs">-</span>'; // è‹¥ç„¡æ¨™æº–ç­”æ¡ˆé¡¯ç¤ºæ©«ç·š
						} else {
							// ç°¡å–®è™•ç†ï¼šè‹¥æ˜¯é•·æ–‡å­—æˆ–ç‰¹æ®Šæ ¼å¼ï¼Œå¯è¦–éœ€æ±‚èª¿æ•´æ¨£å¼
							correctDisp = `<span class="text-green-700 font-bold font-mono bg-green-50 px-1 rounded">${correctDisp}</span>`;
						}
						html += `<td class="p-2 text-sm border-l border-dashed border-gray-200">${correctDisp}</td>`;
						
						let displayAns = q.answerRaw;
						if (displayAns === undefined || displayAns === null || displayAns === '') {
							displayAns = '<span class="text-gray-300 italic text-xs">(æœªä½œç­”)</span>';
						} else if (typeof displayAns === 'string' && displayAns.startsWith('http')) {
							// å‡è¨­æ˜¯ç¶²å€ï¼Œé¡¯ç¤ºç‚ºé€£çµ
							displayAns = `<a href="${displayAns}" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1">ğŸ“ é–‹å•Ÿæª”æ¡ˆ</a>`;
						}

						// å­¸ç”Ÿä½œç­”
						html += `<td class="p-2 text-gray-600 font-mono text-sm whitespace-pre-wrap break-all">${displayAns}</td>`;
						
						html += '</tr>';
					});
				}
			});

			if (html === '') {
				html = '<tr><td colspan="4" class="p-8 text-center text-gray-500">æ­¤ä»½ä½œæ¥­æ²’æœ‰é¡Œç›®è³‡æ–™</td></tr>';
			}

			tbody.innerHTML = html;
		}
		

		// ğŸ› ï¸ ä¿®æ”¹ JSï¼šå¼·åŒ–ç‰ˆæª”æ¡ˆç®¡ç†åˆ†æ (æ–°å¢ï¼šå¹½éˆæª”æ¡ˆæ’åœ¨æœ€ä¸Šæ–¹)
		async function loadStorageAnalysis() {
			// 1. åˆå§‹åŒ–ä»‹é¢
			const tbodyUploads = document.getElementById('storage-uploads-body');
			const tbodyResources = document.getElementById('storage-resources-body');
			
			const loadingHtml = '<tr><td colspan="4" class="p-8 text-center"><div class="animate-spin inline-block w-6 h-6 border-4 border-purple-500 rounded-full border-t-transparent"></div><span class="ml-2 text-gray-500 font-bold">æƒæä¸¦æ’åºä¸­...</span></td></tr>';
			tbodyUploads.innerHTML = loadingHtml;
			tbodyResources.innerHTML = loadingHtml;

			try {
				// ===========================================
				// ä»»å‹™ A: å­¸ç”Ÿä½œæ¥­è³‡æ–™å¤¾åˆ†æ (uploads/)
				// ===========================================
				const uploadsPromise = (async () => {
					const listRes = await storage.ref().child('uploads').listAll();
					const folders = listRes.prefixes;
					
					// å–å¾—æ‰€æœ‰æœ‰æ•ˆ Assignment ID
					const assignSnap = await db.collection('assignments').get();
					const activeIds = new Set();
					assignSnap.forEach(doc => activeIds.add(doc.id));

					if (folders.length === 0) {
						return '<tr><td colspan="3" class="p-4 text-center text-gray-400">ç„¡å­¸ç”Ÿä½œæ¥­æª”æ¡ˆ</td></tr>';
					}

					// 1. å»ºç«‹è³‡æ–™é™£åˆ—
					const folderData = folders.map(folderRef => {
						const fid = folderRef.name;
						const isActive = activeIds.has(fid);
						return { folderRef, fid, isActive };
					});

					// 2. æ’åºï¼šå¹½éˆæª”æ¡ˆ (isActive=false) æ’å‰é¢ï¼ŒåŒé¡åˆ¥å‰‡ä¾ ID æ’åº
					folderData.sort((a, b) => {
						if (a.isActive !== b.isActive) {
							return a.isActive ? 1 : -1; // isActive=true (1) æ’åœ¨å¾Œï¼Œfalse (-1) æ’åœ¨å‰
						}
						return a.fid.localeCompare(b.fid);
					});

					// 3. ç”¢ç”Ÿ HTML
					let html = '';
					folderData.forEach(item => {
						const { folderRef, fid, isActive } = item;
						
						const statusBadge = isActive 
							? '<span class="px-2 py-0.5 rounded text-xs bg-green-100 text-green-700 border border-green-200">âœ… æ­£å¸¸ä½¿ç”¨</span>'
							: '<span class="px-2 py-0.5 rounded text-xs bg-orange-100 text-orange-700 border border-orange-200 font-bold">âš ï¸ æœªé—œé€£è³‡æ–™å¤¾</span>';						// å¹½éˆè³‡æ–™å¤¾é¡¯ç¤ºæ·¡ç´…è‰²èƒŒæ™¯ï¼Œæ›´æ˜é¡¯
						//const rowClass = isActive ? 'hover:bg-gray-50' : 'bg-red-50 hover:bg-red-100';
						const rowClass = isActive ? 'hover:bg-gray-50' : 'bg-orange-50 hover:bg-orange-100';

						const actionBtn = isActive
							? '<span class="text-gray-300 text-xs">--</span>'
							: `<button onclick="deleteStorageFolder('${folderRef.fullPath}', this)" class="text-red-600 hover:bg-red-50 border border-red-200 px-3 py-1 rounded text-xs transition bg-white shadow-sm font-bold">ğŸ—‘ï¸ åˆªé™¤</button>`;

						html += `<tr class="${rowClass} transition border-b border-gray-100">
							<td class="p-3 font-mono text-gray-600">${fid}</td>
							<td class="p-3">${statusBadge}</td>
							<td class="p-3 text-center">${actionBtn}</td>
						</tr>`;
					});
					
					return html;
				})();

				// ===========================================
				// ä»»å‹™ B: æ•™å¸«ç´ æåœ–ç‰‡åˆ†æ (resource_images/)
				// ===========================================
				const resourcesPromise = (async () => {
					// é‡ç½®æ‰¹é‡æŒ‰éˆ•ç‹€æ…‹
					if(window.updateBatchBtnUI) updateBatchBtnUI(0);
					if(document.getElementById('res-master-chk')) document.getElementById('res-master-chk').checked = false;

					// B-1. å–å¾—æ‰€æœ‰ HTML
					const wsSnap = await db.collection('worksheets').where('creator_id', '==', currentUser.uid).get();
					let allHtmlContent = "";
					wsSnap.forEach(doc => { allHtmlContent += (doc.data().html_content || ""); });

					// B-2. åˆ—å‡º storage
					const resRef = storage.ref().child(`resource_images/${currentUser.uid}`);
					let resList;
					try { resList = await resRef.listAll(); } catch(e) { return '<tr><td colspan="4" class="p-4 text-center text-gray-400">å°šç„¡ä¸Šå‚³çš„ç´ æåœ–ç‰‡</td></tr>'; }

					if (resList.items.length === 0) return '<tr><td colspan="4" class="p-4 text-center text-gray-400">ç›®å‰æ²’æœ‰ç´ æåœ–ç‰‡</td></tr>';

					// B-3. å»ºç«‹è³‡æ–™é™£åˆ—ä¸¦è¨ˆç®—ç‹€æ…‹
					const resourceData = resList.items.map(itemRef => {
						const filename = itemRef.name;
						// æª¢æŸ¥æ˜¯å¦è¢«å¼•ç”¨
						const isUsed = allHtmlContent.includes(encodeURIComponent(filename)) || allHtmlContent.includes(filename);
						return { itemRef, filename, isUsed };
					});

					// B-4. æ’åºï¼šå¹½éˆæª”æ¡ˆ (isUsed=false) æ’å‰é¢ï¼ŒåŒé¡åˆ¥å‰‡ä¾æ™‚é–“(æª”å)å€’åº
					resourceData.sort((a, b) => {
						if (a.isUsed !== b.isUsed) {
							return a.isUsed ? 1 : -1; // isUsed=true (1) æ’åœ¨å¾Œï¼Œfalse (-1) æ’åœ¨å‰
						}
						// å¦‚æœç‹€æ…‹ç›¸åŒï¼Œä¾æª”å(æ™‚é–“)å€’åºï¼Œæ–°çš„åœ¨ä¸Šé¢
						return b.filename.localeCompare(a.filename);
					});

					// B-5. ç”¢ç”Ÿåˆ—è¡¨
					let html = '';
					
					resourceData.forEach(item => {
						const { itemRef, filename, isUsed } = item;
						
						// ç‹€æ…‹æ¨™ç±¤
						const statusBadge = isUsed
							? '<span class="px-1.5 py-0.5 rounded text-[10px] bg-green-50 text-green-700 border border-green-200 whitespace-nowrap">âœ… å¼•ç”¨ä¸­</span>'
							: '<span class="px-1.5 py-0.5 rounded text-[10px] bg-gray-100 text-gray-500 border border-gray-300 font-bold whitespace-nowrap">â›” æœªä½¿ç”¨</span>';
						// Checkbox: åªæœ‰ã€Œå¹½éˆåœ–ç‰‡ã€æ‰é¡¯ç¤º Checkbox
						const checkboxHtml = !isUsed 
							? `<input type="checkbox" class="res-chk cursor-pointer" value="${itemRef.fullPath}" onchange="updateBatchBtnUI()">`
							: `<input type="checkbox" disabled class="opacity-20 cursor-not-allowed">`;

						// æ“ä½œæŒ‰éˆ•
						const actionBtn = isUsed
							? `<button onclick="previewResourceImage('${itemRef.fullPath}')" class="text-blue-600 hover:text-blue-800">ğŸ”</button>`
							: `<div class="flex items-center justify-center gap-3">
								<button onclick="previewResourceImage('${itemRef.fullPath}')" class="text-blue-500 hover:text-blue-700" title="é è¦½">ğŸ”</button>
								<button onclick="deleteResourceFile('${itemRef.fullPath}', this)" class="text-red-500 hover:text-red-700 font-bold" title="åˆªé™¤">âœ•</button>
							   </div>`;
						
						// å¹½éˆæª”æ¡ˆçµ¦äºˆæ·¡ç´…è‰²èƒŒæ™¯ï¼Œæ–¹ä¾¿è¾¨è­˜
						// const rowClass = isUsed ? 'hover:bg-gray-50' : 'bg-red-50 hover:bg-red-100';
						const rowClass = isUsed ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';

						html += `<tr class="${rowClass} transition group border-b border-gray-50">
							<td class="py-2 px-2 text-center">${checkboxHtml}</td>
							<td class="py-2 px-2">
								<div class="flex items-center gap-2 overflow-hidden">
									<span class="text-gray-600 font-medium truncate w-64" title="${filename}">${filename}</span>
								</div>
							</td>
							<td class="py-2 px-2 text-gray-500">${statusBadge}</td>
							<td class="py-2 px-2 text-center">${actionBtn}</td>
						</tr>`;
					});
					
					return html;
				})();

				// ç­‰å¾…å…©é‚Šéƒ½å®Œæˆ
				const [uploadsHtml, resourcesHtml] = await Promise.all([uploadsPromise, resourcesPromise]);

				tbodyUploads.innerHTML = uploadsHtml;
				tbodyResources.innerHTML = resourcesHtml;

			} catch (e) {
				console.error(e);
				const errHtml = `<tr><td colspan="4" class="p-4 text-center text-red-500">æƒæå¤±æ•—: ${e.message}</td></tr>`;
				tbodyUploads.innerHTML = errHtml;
				tbodyResources.innerHTML = errHtml;
			}
		}

		// åˆªé™¤å–®ä¸€æª”æ¡ˆ (ç”¨æ–¼ç´ æåœ–ç‰‡)
		async function deleteResourceFile(fullPath, btn) {
			if(!confirm('âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™å¼µåœ–ç‰‡å—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
			
			const originalText = btn.textContent;
			btn.textContent = '...';
			btn.disabled = true;

			try {
				await storage.ref(fullPath).delete();
				// åˆªé™¤è©²è¡Œ
				const row = btn.closest('tr');
				row.style.opacity = '0';
				setTimeout(() => row.remove(), 300);
			} catch (e) {
				alert('åˆªé™¤å¤±æ•—: ' + e.message);
				btn.textContent = originalText;
				btn.disabled = false;
			}
		}

		// é è¦½åœ–ç‰‡ (åœ¨æ–°åˆ†é é–‹å•Ÿ)
		async function previewResourceImage(fullPath) {
			try {
				const url = await storage.ref(fullPath).getDownloadURL();
				window.open(url, '_blank');
			} catch(e) {
				alert('ç„¡æ³•å–å¾—é è¦½é€£çµ');
			}
		}

		// éè¿´åˆªé™¤è³‡æ–™å¤¾ (å› ç‚º Firebase Web SDK ä¸æ”¯æ´ç›´æ¥åˆªé™¤è³‡æ–™å¤¾)
		async function deleteStorageFolder(fullPath, btn) {
			if(!confirm('âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤è³‡æ–™å¤¾åŠå…¶æ‰€æœ‰å…§å®¹å—ï¼Ÿ\n\né€™å°‡æœƒåˆªé™¤è©²ä»»å‹™ä¸‹æ‰€æœ‰å­¸ç”Ÿä¸Šå‚³çš„æª”æ¡ˆï¼Œæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) return;
			
			const originalHtml = btn.innerHTML;
			btn.innerHTML = 'â³ åˆªé™¤ä¸­...';
			btn.disabled = true;
			btn.classList.add('opacity-50', 'cursor-not-allowed');

			try {
				const rootRef = storage.ref(fullPath);
				await deleteFolderRecursively(rootRef);
				
				// åˆªé™¤æˆåŠŸå¾Œï¼Œç§»é™¤è©²è¡Œ
				const row = btn.closest('tr');
				row.style.transition = 'all 0.5s';
				row.style.opacity = '0';
				setTimeout(() => row.remove(), 500);
				
				// å¦‚æœä½ æƒ³é€šçŸ¥ç”¨æˆ¶
				// alert('âœ… æ¸…ç†å®Œæˆï¼');
			} catch (e) {
				console.error(e);
				alert('åˆªé™¤å¤±æ•—: ' + e.message);
				btn.innerHTML = originalHtml;
				btn.disabled = false;
				btn.classList.remove('opacity-50', 'cursor-not-allowed');
			}
		}

		// è¼”åŠ©ï¼šéè¿´åˆªé™¤é‚è¼¯
		async function deleteFolderRecursively(ref) {
			const list = await ref.listAll();
			
			// 1. åˆªé™¤ç•¶å‰å±¤ç´šçš„æ‰€æœ‰æª”æ¡ˆ
			const filePromises = list.items.map(item => item.delete());
			await Promise.all(filePromises);

			// 2. éè¿´é€²å…¥å­è³‡æ–™å¤¾åˆªé™¤ (å­¸ç”ŸIDå±¤)
			const folderPromises = list.prefixes.map(prefix => deleteFolderRecursively(prefix));
			await Promise.all(folderPromises);
		}
		/* âœ¨ã€ä¿®æ”¹çµæŸã€‘ */

		// ==========================================
		// â˜…â˜…â˜… è¦–è¦ºåŒ–ç·¨è¼¯å™¨ (Visual Editor) é‚è¼¯ â˜…â˜…â˜…
		// ==========================================
		let vePages = []; let veJsonData = {}; let veMarkersData = {}; 
		let veCurrentPage = 0; let veClickPos = {x:0, y:0};
		let currentEditingProjectState = null; // å„²å­˜å°ˆæ¡ˆç‹€æ…‹

		// ä¿®æ­£ç‰ˆï¼šé–‹å•Ÿè¦–è¦ºåŒ–ç·¨è¼¯å™¨ (å¼·åŒ–è³‡æ–™è¼‰å…¥)
		function openVisualEditor() {
			const modal = document.getElementById('visual-editor-modal');
			if (!modal) { alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¦–çª—å…ƒç´ "); return; }

			// 1. é¡¯ç¤ºè¦–çª— (æ¨£å¼è¨­å®š)
			if (modal.parentElement !== document.body) { document.body.appendChild(modal); }
			modal.removeAttribute('style');
			modal.classList.remove('hidden');
			
			// å¼·åˆ¶è¨­å®šæ¨£å¼ç¢ºä¿å¯è¦‹
			modal.style.setProperty('display', 'flex', 'important');
			modal.style.setProperty('flex-direction', 'row', 'important');
			modal.style.setProperty('position', 'fixed', 'important');
			modal.style.setProperty('top', '0', 'important');
			modal.style.setProperty('left', '0', 'important');
			modal.style.setProperty('width', '100vw', 'important');
			modal.style.setProperty('height', '100vh', 'important');
			modal.style.setProperty('z-index', '10000000', 'important');
			modal.style.setProperty('background-color', '#111827', 'important');
			
			// 2. æ ¸å¿ƒä¿®æ­£ï¼šæª¢æŸ¥ä¸¦å¼·åˆ¶æ³¨å…¥è³‡æ–™
			// å¦‚æœå…¨åŸŸè®Šæ•¸ currentEditingProjectState æœ‰è³‡æ–™ (ä¾†è‡ª AI æˆ–ç·¨è¼¯æ¨¡å¼)
			if (typeof currentEditingProjectState !== 'undefined' && currentEditingProjectState) {
				console.log("ğŸ”„ [VisualEditor] åµæ¸¬åˆ°å°ˆæ¡ˆè³‡æ–™ï¼Œæ­£åœ¨è¼‰å…¥...", currentEditingProjectState);

				try {
					// A. åŒæ­¥å…¨åŸŸè®Šæ•¸
					vePages = currentEditingProjectState.urls || [];
					veJsonData = currentEditingProjectState.jsonData || {};
					// æ·±æ‹·è² markers
					veMarkersData = JSON.parse(JSON.stringify(currentEditingProjectState.markers || {}));

					// B. â˜…é—œéµï¼šå¼·åˆ¶æŠŠè³‡æ–™å¡«å›å·¦å´çš„ Input æ¬„ä½ (é€™æ¨£ä½ å°±çœ‹å¾—åˆ°ç¶²å€è·ŸJSONäº†)
					const urlInput = document.getElementById('ve-url-input');
					const jsonInput = document.getElementById('ve-json-input');
					
					if (urlInput) urlInput.value = vePages.join('\n');
					if (jsonInput) jsonInput.value = JSON.stringify(veJsonData, null, 4);

					// C. æ¸²æŸ“ç¬¬ä¸€é 
					veCurrentPage = 0;
					// å»¶é²ä¸€é»é»åŸ·è¡Œæ¸²æŸ“ï¼Œç¢ºä¿ DOM å·²ç¶“é¡¯ç¤º
					setTimeout(() => {
						veRenderPage();
						console.log("âœ… [VisualEditor] ç•«é¢æ¸²æŸ“å®Œæˆ");
					}, 50);

				} catch(e) { 
					console.error("è¼‰å…¥å¤±æ•—", e); 
					alert("è¼‰å…¥å°ˆæ¡ˆç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
				}
				
			} else if (typeof vePages !== 'undefined' && vePages.length > 0) {
				// æ¢å¾©èˆŠé€²åº¦
				veRenderPage();
			}
		}

		function closeVisualEditor() {
			const modal = document.getElementById('visual-editor-modal');
			if (modal) {
				// 1. åŠ å›éš±è—é¡åˆ¥ (Tailwind)
				modal.classList.add('hidden');
				
				// 2. ã€é—œéµä¿®å¾©ã€‘ç§»é™¤æ‰€æœ‰å¼·åˆ¶åŠ ä¸Šå»çš„æ¨£å¼
				// å› ç‚ºé–‹å•Ÿæ™‚æˆ‘å€‘ç”¨äº† !importantï¼Œå¦‚æœä¸ç§»é™¤ï¼Œè¦–çª—æœƒä¸€ç›´å¡åœ¨é¡¯ç¤ºç‹€æ…‹
				modal.removeAttribute('style'); 
				
				console.log("âœ… è¦–è¦ºåŒ–ç·¨è¼¯å™¨å·²é—œé–‰");
			}
		}

		async function veUploadImages(files) {
			if (!files.length) return;
			const statusDiv = document.getElementById('ve-upload-status');
			const urlArea = document.getElementById('ve-url-input');
			statusDiv.innerText = `æº–å‚™ä¸Šå‚³ ${files.length} å€‹æª”æ¡ˆ...`;

			for (let i = 0; i < files.length; i++) {
				const file = files[i];
				statusDiv.innerText = `ä¸Šå‚³ä¸­ (${i+1}/${files.length}): ${file.name}`;
				try {
					// éœ€ç¢ºä¿ storage å·²åˆå§‹åŒ–
					const ref = firebase.storage().ref().child(`resource_images/${currentUser.uid}/${Date.now()}_${file.name}`);
					await ref.put(file);
					const url = await ref.getDownloadURL();
					urlArea.value += (urlArea.value ? '\n' : '') + url;
				} catch (e) { console.error(e); statusDiv.innerText = "ä¸Šå‚³å¤±æ•—: " + e.message; }
			}
			statusDiv.innerText = "âœ… ä¸Šå‚³å®Œæˆ";
			statusDiv.className = "text-xs mt-1 text-green-400";
		}

		function veLoadProject(preserveMarkers = false) {
			const urlText = document.getElementById('ve-url-input').value.trim();
			const jsonText = document.getElementById('ve-json-input').value.trim();
			if(!urlText) return alert("è«‹è¼¸å…¥åœ–ç‰‡ç¶²å€");

			vePages = urlText.split('\n').filter(l => l.trim()!=='');
			try { veJsonData = jsonText ? JSON.parse(jsonText) : {}; } catch(e) { return alert("JSON æ ¼å¼éŒ¯èª¤"); }

			if (!preserveMarkers) {
				veMarkersData = {};
				vePages.forEach((_, i) => veMarkersData[i] = []);
			} else {
				vePages.forEach((_, i) => { if(!veMarkersData[i]) veMarkersData[i] = []; });
			}
			veCurrentPage = 0;
			veRenderPage();
		}

		function veRenderPage() {
			if(vePages.length === 0) return;
			document.getElementById('ve-current-img').src = vePages[veCurrentPage];
			document.getElementById('ve-page-indicator').innerText = `Page ${veCurrentPage+1} / ${vePages.length}`;
			document.querySelectorAll('.ve-marker').forEach(el => el.remove());
			const saved = veMarkersData[veCurrentPage] || [];
			saved.forEach(m => veCreateMarkerDOM(m.id, m.left, m.top, m.w, m.h));
		}

		function veSaveCurrentPage() {
			const domMarkers = document.querySelectorAll('.ve-marker');
			const newData = [];
			domMarkers.forEach(el => {
				newData.push({
					id: el.dataset.id, left: el.style.left, top: el.style.top,
					w: el.style.width, h: el.style.height
				});
			});
			veMarkersData[veCurrentPage] = newData;
		}

		function vePrevPage() { if(veCurrentPage > 0) { veSaveCurrentPage(); veCurrentPage--; veRenderPage(); } }
		function veNextPage() { if(veCurrentPage < vePages.length-1) { veSaveCurrentPage(); veCurrentPage++; veRenderPage(); } }

		// ==========================================
		// ä¿®æ”¹éƒ¨åˆ† Aï¼šéæ¿¾å·²é¸é¡Œç›® & é»æ“Šç•«å¸ƒé‚è¼¯
		// ==========================================

		// è¼”åŠ©å‡½å¼ï¼šå–å¾—ç›®å‰æ‰€æœ‰é é¢å·²ç¶“è¢«æ”¾ç½®çš„é¡Œç›® ID
		function veGetUsedIds() {
			const used = new Set();
			
			// 1. æª¢æŸ¥ã€Œéç•¶å‰é é¢ã€çš„å„²å­˜è³‡æ–™
			Object.keys(veMarkersData).forEach(p => {
				if (parseInt(p) !== veCurrentPage) {
					(veMarkersData[p] || []).forEach(m => used.add(m.id));
				}
			});

			// 2. æª¢æŸ¥ã€Œç•¶å‰é é¢ã€çš„ DOM å…ƒç´  (å› ç‚ºç•¶å‰é é¢å¯èƒ½é‚„æ²’å­˜å…¥ veMarkersData)
			document.querySelectorAll('.ve-marker').forEach(el => {
				if (el.dataset.id) used.add(el.dataset.id);
			});

			return used;
		}

		const veWrapper = document.getElementById('ve-canvas-wrapper');
		if (veWrapper) {
			veWrapper.addEventListener('click', (e) => {
				// å¦‚æœé»åˆ°çš„æ˜¯æ¨™è¨˜æœ¬èº«(åŒ…å«æ‹–æ›³ä¸­)ï¼Œä¸è¦è§¸ç™¼æ–°å¢è¦–çª—
				if(e.target.closest('.ve-marker')) return;
				
				if(vePages.length === 0) return;

				const rect = veWrapper.getBoundingClientRect();
				veClickPos.x = ((e.clientX - rect.left) / rect.width * 100).toFixed(2);
				veClickPos.y = ((e.clientY - rect.top) / rect.height * 100).toFixed(2);
				
				const select = document.getElementById('ve-q-select');
				select.innerHTML = '';

				// â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå–å¾—å·²ä½¿ç”¨çš„ ID â˜…â˜…â˜…
				const usedIds = veGetUsedIds();
				let availableCount = 0;

				Object.keys(veJsonData).forEach(k => {
					// å¦‚æœå·²ç¶“ç”¨éï¼Œå°±è·³éä¸é¡¯ç¤º
					if (usedIds.has(k)) return;

					const opt = document.createElement('option');
					opt.value = k;
					opt.text = `${k} (${veJsonData[k].label || ''})`;
					select.appendChild(opt);
					availableCount++;
				});

				if(availableCount === 0) { 
					const opt = document.createElement('option'); 
					opt.text = "ç„¡å‰©é¤˜é¡Œç›® (æˆ–æœªè¨­å®š JSON)"; 
					select.appendChild(opt); 
				}

				const p = document.getElementById('ve-popup');
				p.style.display = 'block'; 
				p.style.left = e.pageX + 'px'; 
				p.style.top = e.pageY + 'px';
			});
		} else {
			console.warn("æ‰¾ä¸åˆ° ve-canvas-wrapper å…ƒç´ ");
		}
		
		function veAddMarker() {
			const qId = document.getElementById('ve-q-select').value;
			if(!qId || qId === "è«‹å…ˆè¨­å®š JSON") return;
			veCreateMarkerDOM(qId, veClickPos.x + '%', veClickPos.y + '%', '10%', '5%');
			document.getElementById('ve-popup').style.display = 'none';
		}

		// ==========================================
		// ä¿®æ”¹éƒ¨åˆ† Bï¼šå»ºç«‹å¯æ‹–æ›³ (Draggable) çš„æ¨™è¨˜
		// ==========================================
		function veCreateMarkerDOM(id, l, t, w, h) {
			const div = document.createElement('div');
			div.className = 've-marker';
			// åŠ å…¥ cursor: move è®“ä½¿ç”¨è€…çŸ¥é“å¯ä»¥æ‹–
			div.style.left = l; div.style.top = t; div.style.width = w; div.style.height = h;
			div.style.cursor = 'move'; 
			div.dataset.id = id;
			
			// å…§å®¹ HTML (åŠ å…¥é˜²æ­¢é¸å–æ–‡å­—çš„æ¨£å¼)
			div.innerHTML = `<span style="pointer-events:none; user-select:none;">${id}</span><div class="del" onclick="this.parentElement.remove()">X</div>`;
			
			// â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå¯¦ä½œæ‹–æ›³é‚è¼¯ â˜…â˜…â˜…
			div.onmousedown = function(e) {
				// å¦‚æœé»åˆ°çš„æ˜¯åˆªé™¤éˆ•ï¼Œæˆ–æ˜¯èª¿æ•´å¤§å°çš„æŠŠæ‰‹(å³ä¸‹è§’)ï¼Œå°±ä¸è§¸ç™¼æ‹–æ›³
				if (e.target.classList.contains('del')) return;
				
				// æª¢æŸ¥æ˜¯å¦é»æ“Šåˆ°å³ä¸‹è§’å€åŸŸ (Resize æŠŠæ‰‹å€åŸŸé€šå¸¸åœ¨å³ä¸‹ 10x10)
				const rect = div.getBoundingClientRect();
				if (e.clientX > rect.right - 15 && e.clientY > rect.bottom - 15) {
					return; // è®“åŸç”Ÿçš„ resize ç”Ÿæ•ˆï¼Œä¸åŸ·è¡Œ drag
				}

				e.preventDefault(); // é˜²æ­¢é¸å–æ–‡å­—
				e.stopPropagation(); // é˜²æ­¢è§¸ç™¼èƒŒæ™¯çš„æ–°å¢è¦–çª—

				const startX = e.clientX;
				const startY = e.clientY;
				const initialLeft = div.offsetLeft;
				const initialTop = div.offsetTop;
				const containerRect = veWrapper.getBoundingClientRect();

				function onMove(moveEvent) {
					const dx = moveEvent.clientX - startX;
					const dy = moveEvent.clientY - startY;

					// å…ˆæš«æ™‚ç”¨ px ç§»å‹•ï¼Œæ¯”è¼ƒé †æš¢
					let newLeft = initialLeft + dx;
					let newTop = initialTop + dy;

					// é‚Šç•Œæª¢æŸ¥ (å¯é¸ï¼Œé˜²æ­¢æ‹–å‡ºæ¡†å¤–)
					if (newLeft < 0) newLeft = 0;
					if (newTop < 0) newTop = 0;
					if (newLeft + div.offsetWidth > containerRect.width) newLeft = containerRect.width - div.offsetWidth;
					if (newTop + div.offsetHeight > containerRect.height) newTop = containerRect.height - div.offsetHeight;

					div.style.left = newLeft + 'px';
					div.style.top = newTop + 'px';
				}

				function onUp() {
					document.removeEventListener('mousemove', onMove);
					document.removeEventListener('mouseup', onUp);

					// â˜… æ‹–æ›³çµæŸï¼šå°‡ px è½‰å› % (å› ç‚ºç³»çµ±ä¾è³´ % åš RWD)
					const finalLeftPct = (div.offsetLeft / containerRect.width * 100).toFixed(2) + '%';
					const finalTopPct = (div.offsetTop / containerRect.height * 100).toFixed(2) + '%';
					
					div.style.left = finalLeftPct;
					div.style.top = finalTopPct;
				}

				document.addEventListener('mousemove', onMove);
				document.addEventListener('mouseup', onUp);
			};

			veWrapper.appendChild(div);
		}


		// ğŸ› ï¸ [ä¿®æ”¹é–‹å§‹] veExport: åŒ¯å‡ºå¾Œå±•é–‹åŸå§‹ç¢¼ä¸¦è‡ªå‹•é è¦½
		function veExport() {
			veSaveCurrentPage(); 

			let fullHtml = "";

			// éæ­·æ¯ä¸€é 
			vePages.forEach((url, i) => {
				const markers = veMarkersData[i] || [];
				let inputs = "";

				// éæ­·è©²é çš„æ‰€æœ‰æ¨™è¨˜
				markers.forEach(m => {
					const qData = veJsonData[m.id] || {};
					const qType = qData.type || 'text'; 
					
					const commonStyle = `position:absolute; left:${m.left}; top:${m.top}; width:${m.w}; height:${m.h}; background:rgba(255,255,255,0.9); border:1px solid #bfdbfe; font-size:14px; color:#1d4ed8; outline:none; z-index:10; margin:0; padding:4px; box-sizing:border-box;`;
					
					if (qType === 'choice') {
						let optionsHtml = `<option value="">è«‹é¸æ“‡</option>`;
						
						if (qData.choiceNo) {
							const regex = /\(([^)]+)\)([^(\r\n]*)/g;
							let match;
							while ((match = regex.exec(qData.choiceNo)) !== null) {
								const val = match[1].trim(); 
								let label = match[2].trim(); 
								if(!label) label = val; 
								else label = `${val}. ${label}`; 
								
								optionsHtml += `<option value="${val}">${label}</option>`;
							}
						} else {
							['A', 'B', 'C', 'D'].forEach(opt => {
								optionsHtml += `<option value="${opt}">${opt}</option>`;
							});
						}

						inputs += `    <select name="${m.id}" class="worksheet-input" style="${commonStyle}">
							${optionsHtml}
						</select>\n`;

					} else if (qType === 'checkbox') {
						 inputs += `    <div style="${commonStyle}; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.5); border:none;">
							<input type="checkbox" name="${m.id}" value="true" style="width:20px; height:20px; cursor:pointer;">
						 </div>\n`;

					} else {
						inputs += `    <input type="text" name="${m.id}" class="worksheet-input" 
							style="${commonStyle} text-align: center;" 
							placeholder="(${m.id})">\n`;
					}
				});

				fullHtml += `<div class="sheet-page relative w-full max-w-[800px] mx-auto mb-5 shadow bg-white">
					<img src="${url}" style="width:100%; display:block;">
					${inputs}
				</div>\n`;
			});

			document.getElementById('ws-html').value = fullHtml;
			document.getElementById('ws-json').value = JSON.stringify(veJsonData, null, 4);
			
			// 1. åŒ¯å‡ºå®Œç•¢å¾Œï¼Œè‡ªå‹•å±•é–‹åŸå§‹ç¢¼å€å¡Š
			document.getElementById('source-code-area').classList.remove('hidden');

			// âœ¨ 2. [æ–°å¢] è‡ªå‹•é»æ“Šé è¦½æŒ‰éˆ•ï¼Œå¼·åˆ¶åˆ·æ–°é è¦½ç•«é¢
			document.getElementById('preview-btn').click();

			currentEditingProjectState = { urls: vePages, jsonData: veJsonData, markers: veMarkersData };
			closeVisualEditor();
			
			alert("âœ… å·²ä¾æ“š JSON é¡Œå‹ç”Ÿæˆå°æ‡‰çš„ HTML å…ƒç´ ï¼\n\n(é¸æ“‡é¡Œå·²è½‰ç‚ºä¸‹æ‹‰é¸å–®ã€æ–‡å­—é¡Œç¶­æŒè¼¸å…¥æ¡†)\nè«‹è¨˜å¾—æŒ‰ã€Œå„²å­˜åˆ°é¡Œåº«ã€ã€‚");
		}
		// ğŸ› ï¸ [ä¿®æ”¹çµæŸ]

		console.log("ã€æª¢æŸ¥é» Cã€‘JavaScript è…³æœ¬å·²å®Œæ•´è¼‰å…¥è‡³çµå°¾");

		const veWrapperCheck = document.getElementById('ve-canvas-wrapper');
		console.log("ã€æª¢æŸ¥é» Dã€‘è¦–è¦ºåŒ–ç•«å¸ƒå€å¡Š (ve-canvas-wrapper) æ˜¯å¦å­˜åœ¨ï¼Ÿ", veWrapperCheck);

		// å¦‚æœé€™è£¡æ˜¯ nullï¼Œä»£è¡¨ HTML çµæ§‹æœ‰ç¼ºï¼Œæˆ–è€…è…³æœ¬è·‘å¤ªå¿«
		if (!veWrapperCheck) {
			console.error("âŒ åš´é‡éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° ve-canvas-wrapperï¼Œé€™æœƒå°è‡´ä¸‹æ–¹äº‹ä»¶ç¶å®šå¤±æ•—");
		}

		// 1. å…¨é¸/å…¨å–æ¶ˆ
		window.toggleAllResources = (master) => {
			document.querySelectorAll('.res-chk').forEach(cb => cb.checked = master.checked);
			updateBatchBtnUI();
		};

		// 2. æ›´æ–°æ‰¹é‡æŒ‰éˆ•ç‹€æ…‹ (é¡¯ç¤º/éš±è—)
		window.updateBatchBtnUI = () => {
			// å–å¾—æ‰€æœ‰è¢«å‹¾é¸çš„ checkbox
			const count = document.querySelectorAll('.res-chk:checked').length;
			const btn = document.getElementById('res-batch-del-btn');
			const countSpan = document.getElementById('res-sel-count');
			
			// é˜²å‘†ï¼šå¦‚æœæŒ‰éˆ•æœ¬èº«ä¸å­˜åœ¨ï¼Œå°±çµæŸ
			if (!btn) return;

			if (count > 0) {
				btn.classList.remove('hidden');
				// é˜²å‘†ï¼šç¢ºèª span å­˜åœ¨æ‰æ›´æ–°æ•¸å­—ï¼Œé¿å…å ±éŒ¯
				if (countSpan) {
					countSpan.textContent = count;
				}
			} else {
				btn.classList.add('hidden');
			}
		};

		// ğŸ› ï¸ [ä¿®æ”¹é–‹å§‹] deleteSelectedResources: åˆªé™¤å¾Œç«‹å³é‡ç½®æŒ‰éˆ•ç‹€æ…‹
		window.deleteSelectedResources = async () => {
			const checked = document.querySelectorAll('.res-chk:checked');
			const count = checked.length;
			if (count === 0) return;

			if (!confirm(`âš ï¸ ç¢ºå®šè¦ä¸€æ¬¡åˆªé™¤é€™ ${count} å€‹æœªä½¿ç”¨ç´ æå—ï¼Ÿ\n\næ³¨æ„ï¼šæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) return;

			const btn = document.getElementById('res-batch-del-btn');
			
			btn.textContent = 'åˆªé™¤ä¸­...';
			btn.disabled = true;

			let successCount = 0;
			
			// ä½¿ç”¨ Promise.all å¹³è¡Œè™•ç†åˆªé™¤
			const promises = Array.from(checked).map(async (cb) => {
				try {
					await storage.ref(cb.value).delete();
					
					// â˜…é—œéµä¿®æ­£ï¼šç«‹å³å–æ¶ˆå‹¾é¸ï¼Œé€™æ¨£ updateBatchBtnUI è¨ˆç®—æ™‚å°±ä¸æœƒç®—åˆ°å®ƒ
					cb.checked = false; 

					const row = cb.closest('tr');
					if (row) {
						row.style.transition = 'opacity 0.3s'; // ç¢ºä¿æœ‰éæ¸¡æ•ˆæœ
						row.style.opacity = '0';
						// ç­‰å¾…å‹•ç•«çµæŸå¾Œç§»é™¤ DOM
						setTimeout(() => row.remove(), 300);
					}
					successCount++;
				} catch (e) {
					console.error("åˆªé™¤å¤±æ•—", e);
				}
			});

			await Promise.all(promises);

			// --- ç‹€æ…‹é‡ç½®å€ ---
			
			// 1. å–æ¶ˆã€Œå…¨é¸ã€æ ¸å–æ–¹å¡Š
			const masterChk = document.getElementById('res-master-chk');
			if (masterChk) masterChk.checked = false;

			// 2. æ¢å¾©æŒ‰éˆ•é è¨­æ–‡å­— (é›–ç„¶é¦¬ä¸Šæœƒéš±è—ï¼Œä½†é‡ç½®æ˜¯å¥½ç¿’æ…£)
			btn.innerHTML = 'ğŸ—‘ï¸ åˆªé™¤é¸å–é …ç›® (<span id="res-sel-count">0</span>)';
			btn.disabled = false;

			// 3. å¼·åˆ¶æ›´æ–° UI
			// å› ç‚ºä¸Šé¢å·²ç¶“æŠŠ cb.checked è¨­ç‚º false äº†ï¼Œé€™è£¡ç®—å‡ºä¾†çš„ count æœƒæ˜¯ 0
			// æŒ‰éˆ•å°±æœƒè‡ªå‹•éš±è—
			if (typeof updateBatchBtnUI === 'function') {
				updateBatchBtnUI(); 
			}
			
			// 4. æª¢æŸ¥æ˜¯å¦æ¸…ç©ºï¼Œé¡¯ç¤ºã€Œç„¡ç´ æã€æç¤º
			setTimeout(() => {
				const tbody = document.getElementById('storage-resources-body');
				// æª¢æŸ¥ tbody å…§æ˜¯å¦é‚„æœ‰å¯è¦‹çš„ row (æ’é™¤æ­£åœ¨ç§»é™¤çš„)
				if (tbody && tbody.children.length === 0) {
					tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">ç›®å‰æ²’æœ‰ç´ æåœ–ç‰‡</td></tr>';
				}
			}, 500); // æ¯”ç§»é™¤å‹•ç•«ç¨æ…¢ä¸€é»åŸ·è¡Œ

			alert(`âœ… å·²æˆåŠŸæ¸…ç† ${successCount} å€‹æª”æ¡ˆï¼`);
		};
		// ğŸ› ï¸ [ä¿®æ”¹çµæŸ]
				
		// ==========================================
        // æ–°å¢åŠŸèƒ½ï¼šè¦–è¦ºåŒ–ç·¨è¼¯å™¨ - åœ–åº«å¼•ç”¨
        // ==========================================
        
		/* ğŸ› ï¸ [ä¿®æ”¹é–‹å§‹] åœ–åº«é–‹å•Ÿå‡½å¼ï¼šåŠ å…¥åœ–ç‰‡é è¦½æŒ‰éˆ• */
        window.veOpenLibraryModal = async function() {
            console.log("æ­£åœ¨é–‹å•Ÿåœ–åº«è¦–çª— (å«é è¦½åŠŸèƒ½)..."); 
            
            const modal = document.getElementById('ve-library-modal');
            const grid = document.getElementById('ve-library-grid');
            const countSpan = document.getElementById('lib-sel-count');

            if (!modal) return;
            
            // 1. å¼·åˆ¶ç§»åˆ° Body æœ€å°¾ç«¯
            if (modal.parentElement !== document.body) {
                document.body.appendChild(modal);
            }

            // 2. é¡¯ç¤ºè¦–çª—
            modal.classList.remove('hidden');
            modal.style.setProperty('display', 'flex', 'important'); 
            modal.style.setProperty('z-index', '2147483647', 'important'); 

            // é‡æ–°ç¶å®šå³ä¸Šè§’çš„ X æŒ‰éˆ• (ç¶­æŒä¸Šä¸€ç‰ˆçš„ä¿®å¾©)
            const closeBtn = modal.querySelector('button.text-2xl');
            if (closeBtn) {
                closeBtn.onclick = function() {
                    modal.classList.add('hidden');
                    modal.style.removeProperty('display');
                    modal.style.removeProperty('z-index');
                };
            }

            grid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10 flex items-center justify-center gap-2"><span class="animate-spin text-2xl">â†»</span> æ­£åœ¨è®€å–é›²ç«¯åœ–åº«...</p>';
            countSpan.textContent = '0';

            try {
                const res = await storage.ref(`resource_images/${currentUser.uid}`).listAll();
                
                if (res.items.length === 0) {
                    grid.innerHTML = '<p class="col-span-full text-center text-gray-400 py-10">åœ–åº«æ˜¯ç©ºçš„ï¼Œè«‹å…ˆä¸Šå‚³åœ–ç‰‡ã€‚</p>';
                    return;
                }

                res.items.sort((a, b) => a.name.localeCompare(b.name));

                grid.innerHTML = ''; 

                const promises = res.items.map(async (itemRef) => {
                    const url = await itemRef.getDownloadURL();
                    return { ref: itemRef, url: url };
                });

                const files = await Promise.all(promises);

                files.forEach(f => {
                    const div = document.createElement('div');
                    // å¢åŠ  group å±¬æ€§ä»¥ä¾¿åš hover æ•ˆæœ
                    div.className = "relative group bg-white p-2 rounded shadow hover:shadow-lg transition cursor-pointer border border-transparent hover:border-blue-400";
                    
                    // é»æ“Šå¡ç‰‡æœ¬é«”ï¼šåˆ‡æ›é¸å–ç‹€æ…‹
                    div.onclick = (e) => {
                        // å¦‚æœé»æ“Šçš„ä¸æ˜¯ checkbox ä¹Ÿä¸æ˜¯æ”¾å¤§é¡æŒ‰éˆ•(é˜²æ­¢å†’æ³¡)ï¼Œæ‰è§¸ç™¼é¸å–
                        if(e.target.type !== 'checkbox' && !e.target.closest('.preview-btn')) {
                            const chk = div.querySelector('input[type="checkbox"]');
                            chk.checked = !chk.checked;
                            updateLibCount();
                        }
                    };

                    div.innerHTML = `
                        <div class="aspect-w-1 aspect-h-1 w-full overflow-hidden rounded bg-gray-200 mb-2 relative" style="height: 120px;">
                            <img src="${f.url}" class="w-full h-full object-contain pointer-events-none">
                            
                            <div class="absolute top-1 left-1 z-10">
                                <input type="checkbox" class="lib-chk form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 shadow bg-white" value="${f.url}" onchange="updateLibCount()">
                            </div>

                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all flex items-center justify-center">
                                <button onclick="event.stopPropagation(); vePreviewLargeImage('${f.url}')" class="preview-btn opacity-0 group-hover:opacity-100 transform scale-75 group-hover:scale-100 transition-all bg-white text-blue-600 rounded-full p-2 shadow-lg hover:bg-blue-50" title="é»æ“Šæ”¾å¤§é è¦½">
                                    ğŸ”
                                </button>
                            </div>
                        </div>
                        <div class="text-[10px] text-gray-500 truncate font-mono" title="${f.ref.name}">
                            ${f.ref.name.split('_').slice(1).join('_')}
                        </div>
                    `;
                    grid.appendChild(div);
                });

            } catch(e) {
                console.error(e);
                grid.innerHTML = `<p class="col-span-full text-center text-red-500 py-10">è¼‰å…¥å¤±æ•—: ${e.message}</p>`;
            }
        };
        /* ğŸ› ï¸ [ä¿®æ”¹çµæŸ] */
		
		/* ğŸ› ï¸ [æ–°å¢] åœ–ç‰‡æ”¾å¤§é è¦½åŠŸèƒ½ */
        window.vePreviewLargeImage = function(url) {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰é è¦½è¦–çª—ï¼Œæ²’æœ‰å°±å»ºç«‹ä¸€å€‹
            let previewModal = document.getElementById('ve-img-preview-modal');
            if (!previewModal) {
                previewModal = document.createElement('div');
                previewModal.id = 've-img-preview-modal';
                // è¨­å®šæ¥µé«˜çš„å±¤ç´šï¼Œä¸¦ä½¿ç”¨ flex ç½®ä¸­
                previewModal.className = "fixed inset-0 bg-black bg-opacity-90 hidden flex items-center justify-center";
                previewModal.style.setProperty('z-index', '2147483650', 'important'); // ç¢ºä¿æ¯”åœ–åº«æ›´é«˜
                previewModal.onclick = function() {
                    this.classList.add('hidden'); // é»æ“ŠèƒŒæ™¯é—œé–‰
                };
                
                // åœ–ç‰‡å®¹å™¨
                previewModal.innerHTML = `<img id="ve-preview-img-target" class="max-w-[95vw] max-h-[95vh] object-contain shadow-2xl rounded cursor-zoom-out">`;
                document.body.appendChild(previewModal);
            }

            // è¨­å®šåœ–ç‰‡ä¸¦é¡¯ç¤º
            const img = document.getElementById('ve-preview-img-target');
            img.src = url;
            
            // ç¢ºä¿è¦–çª—åœ¨æœ€ä¸Šå±¤ (DOM é †åº)
            document.body.appendChild(previewModal); 
            
            previewModal.classList.remove('hidden');
        };
		
        function updateLibCount() {
            const cnt = document.querySelectorAll('.lib-chk:checked').length;
            document.getElementById('lib-sel-count').textContent = cnt;
        }


		/* ğŸŸ¢ [ä¿®æ”¹é–‹å§‹] AI åŒ¯å…¥ç²¾éˆç›¸é—œå‡½å¼ (ç©©å¥ç‰ˆï¼šä»¿ç…§åœ–åº«åŠŸèƒ½) */

		// ä½¿ç”¨ var é¿å…é‡è¤‡å®£å‘ŠéŒ¯èª¤
		var parsedAiData = null;
		var currentAIInputId = null;

		window.closeAIImportModal = function() {
			var modal = document.getElementById('ai-import-modal');
			if (modal) {
				modal.classList.add('hidden');
				// é—œéµï¼šç§»é™¤å¼·åˆ¶å¯«å…¥çš„ styleï¼Œé¿å…ä¸‹æ¬¡æ‰“ä¸é–‹æˆ–é—œä¸æ‰
				modal.style.removeProperty('display');
				modal.style.removeProperty('z-index');
			}
			currentAIInputId = null; // é‡ç½®åœ–åº«ç›®æ¨™
		};

		window.openAIImportModal = function() {
			console.log("æ­£åœ¨é–‹å•Ÿ AI åŒ¯å…¥ç²¾éˆ..."); 

			var modal = document.getElementById('ai-import-modal');
			if (!modal) {
				alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¦–çª—å…ƒç´  (id="ai-import-modal")');
				return;
			}

			var inputEl = document.getElementById('ai-json-input');
			var mappingArea = document.getElementById('ai-image-mapping-area');
			var listDiv = document.getElementById('ai-pages-list');
			var genBtn = document.getElementById('btn-generate-ai'); // å–å¾—åˆæˆæŒ‰éˆ•

			if (inputEl) inputEl.value = '';
			if (mappingArea) mappingArea.classList.add('hidden');
			if (listDiv) listDiv.innerHTML = '';
			
			// é‡ç½®ï¼šéš±è—åˆæˆæŒ‰éˆ•
			if (genBtn) genBtn.classList.add('hidden');

			parsedAiData = null;

			// ... (ä»¥ä¸‹ç¶­æŒåŸæœ¬çš„ç½®é ‚èˆ‡é¡¯ç¤ºé‚è¼¯) ...
			if (modal.parentElement !== document.body) {
				document.body.appendChild(modal);
			}
			modal.classList.remove('hidden');
			modal.style.setProperty('display', 'flex', 'important');
			modal.style.setProperty('z-index', '2147483647', 'important');
		};
		
		// 2. è§£æ JSON
		window.parseAIJsonInput = function() {
			var inputEl = document.getElementById('ai-json-input');
			var input = inputEl ? inputEl.value.trim() : '';
			
			if (!input) return alert('è«‹å…ˆè²¼ä¸Š JSON è³‡æ–™');

			try {
				var data = JSON.parse(input);
				if (!data.questions) throw new Error('JSON æ ¼å¼ä¸ç¬¦ï¼šç¼ºå°‘ questions æ¬„ä½');
				if (!data.pages_html) data.pages_html = {}; 
				
				// å„²å­˜è§£æå¾Œçš„è³‡æ–™ä¾›å¾ŒçºŒä½¿ç”¨
				window.parsedAiData = data;
				
				// â˜…â˜…â˜… ä¿®æ­£ 3ï¼šæ™ºæ…§æ’åº (è®“ page2 æ’åœ¨ page10 å‰é¢) â˜…â˜…â˜…
				var pageKeys = Object.keys(data.pages_html).sort(function(a, b) {
					return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
				});
				
				var listDiv = document.getElementById('ai-pages-list');
				if(listDiv) {
					listDiv.innerHTML = '';
					var pdfSection = document.createElement('div');
					pdfSection.className = 'mb-4 p-4 bg-orange-50 border border-orange-200 rounded-lg flex flex-col md:flex-row items-center justify-between gap-3';
					pdfSection.innerHTML = `
						<div class="flex items-center gap-3">
							<div class="bg-orange-100 p-2 rounded-full text-2xl">ğŸ“„</div>
							<div>
								<h4 class="font-bold text-orange-900 text-sm">æ‡¶äººåŒ…ï¼šç›´æ¥ä¸Šå‚³ PDF</h4>
								<p class="text-xs text-orange-700">ç³»çµ±å°‡è‡ªå‹•æŠŠ PDF æ¯ä¸€é è½‰æˆåœ–ç‰‡ï¼Œä¸Šå‚³ä¸¦å¡«å…¥ä¸‹æ–¹æ¬„ä½ã€‚</p>
							</div>
						</div>
						<label class="cursor-pointer bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded shadow text-xs flex items-center gap-2 transition">
							âš¡ é¸æ“‡ PDF è‡ªå‹•è½‰æª”
							<input type="file" class="hidden" accept="application/pdf" onchange="aiBatchPdfUpload(this)">
						</label>
					`;
					listDiv.appendChild(pdfSection);
					pageKeys.forEach(function(pageKey, index) {
						var uniqueId = 'ai-img-' + pageKey; // ç”¢ç”Ÿå”¯ä¸€ ID
						var row = document.createElement('div');
						row.className = 'flex flex-col md:flex-row md:items-center gap-2 bg-white p-3 border rounded shadow-sm';
						
						// â˜…â˜…â˜… ä¿®æ­£ 1ï¼šæ•´åˆä¸Šå‚³èˆ‡åœ–åº«æŒ‰éˆ• â˜…â˜…â˜…
						row.innerHTML = `
							<div class="flex items-center gap-2 min-w-[100px]">
								<span class="font-mono text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded w-full text-center">${pageKey}</span>
							</div>
							
							<div class="flex-grow flex items-center gap-2">
								<input type="text" id="${uniqueId}" 
									   class="ai-bg-url-input flex-grow border p-2 rounded text-sm outline-none focus:border-indigo-500 bg-gray-50" 
									   placeholder="åœ–ç‰‡ç¶²å€..." data-page="${pageKey}">
							</div>

							<div class="flex items-center gap-2 flex-shrink-0">
								<label class="cursor-pointer bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition">
									â˜ï¸ ä¸Šå‚³
									<input type="file" class="hidden" accept="image/*" onchange="aiUploadSingleImage(this, '${uniqueId}')">
								</label>

								<button onclick="aiOpenLibrary('${uniqueId}')" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition">
									ğŸ“‚ åœ–åº«
								</button>
							</div>
						`;
						listDiv.appendChild(row);
					});
					document.getElementById('ai-image-mapping-area').classList.remove('hidden');
					var genBtn = document.getElementById('btn-generate-ai');
					if (genBtn) genBtn.classList.remove('hidden');
				}

			} catch (e) {
				alert('è§£æå¤±æ•—ï¼š' + e.message);
				console.error(e);
			}
		};

		// 3. ç”Ÿæˆä¸¦å°å…¥è¦–è¦ºåŒ–ç·¨è¼¯å™¨ (ä¿®æ­£ç‰ˆï¼šé‡å° input-wrapper çµæ§‹å„ªåŒ–)
		window.generateFromAI = function() {
			if (!parsedAiData) return;
			
			console.log("ğŸš€ é–‹å§‹åŸ·è¡Œ AI è³‡æ–™è½‰æ› (Wrapper æ¨¡å¼)...");

			// 1. æ”¶é›†åœ–ç‰‡ç¶²å€ (å»ºç«‹ Pages)
			var inputs = document.querySelectorAll('.ai-bg-url-input');
			var bgMap = {};
			var allFilled = true;
			
			// æŒ‰ç…§é é¢é †åºæ’åº
			var sortedInputs = Array.from(inputs).sort(function(a, b) {
				return a.dataset.page.localeCompare(b.dataset.page, undefined, { numeric: true, sensitivity: 'base' });
			});

			var newVePages = [];
			
			sortedInputs.forEach(function(inp) {
				var url = inp.value.trim();
				if (!url) allFilled = false;
				bgMap[inp.dataset.page] = url;
				newVePages.push(url);
			});

			if (!allFilled) {
				if (!confirm('éƒ¨åˆ†é é¢æœªå¡«å¯«åœ–ç‰‡ç¶²å€ï¼Œé€™äº›é é¢å°‡é¡¯ç¤ºç©ºç™½èƒŒæ™¯ã€‚ç¢ºå®šç¹¼çºŒï¼Ÿ')) return;
			}

			// 2. æº–å‚™è³‡æ–™å®¹å™¨
			// æ·±æ‹·è²é¡Œç›®è¨­å®š (ä¿ç•™é¡Œå‹ã€é…åˆ†ç­‰è³‡è¨Š)
			var newVeJsonData = JSON.parse(JSON.stringify(parsedAiData.questions));
			var newVeMarkersData = {};
			
			// 3. è§£æ AI çš„ HTML å­—ä¸²ï¼Œæå–åº§æ¨™
			var pageKeys = Object.keys(parsedAiData.pages_html).sort(function(a, b) {
				return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
			});

			var parser = new DOMParser();
			var markerCount = 0;

			pageKeys.forEach(function(pageKey, index) {
				newVeMarkersData[index] = []; // åˆå§‹åŒ–è©²é é™£åˆ—
				
				var htmlContent = parsedAiData.pages_html[pageKey];
				if (!htmlContent) return;

				// è½‰ç‚º DOM
				var doc = parser.parseFromString(htmlContent, 'text/html');
				
				// â˜… é—œéµä¿®æ­£ï¼šé‡å°æ‚¨çš„ JSON çµæ§‹ (.input-wrapper åŒ…è£¹è¼¸å…¥æ¡†)
				// å…ˆæŠ“å¤–å±¤ Wrapperï¼Œå› ç‚ºåº§æ¨™ (Top/Left) åœ¨é€™è£¡
				var wrappers = doc.querySelectorAll('.input-wrapper');
				
				wrappers.forEach(function(div) {
					// æ‰¾å‡ºå…§éƒ¨çš„è¼¸å…¥å…ƒä»¶ (input, select, textarea) ä»¥å–å¾— ID
					var inputEl = div.querySelector('input, select, textarea');
					if (!inputEl) return;

					// å„ªå…ˆå– IDï¼Œå¦‚æœæ²’ ID æ‰å– Name
					var qId = inputEl.id || inputEl.getAttribute('name');
					if (!qId) return;

					// 1. åº§æ¨™ï¼šå¾å¤–å±¤ div å–å¾— (å› ç‚º style="position:absolute; top:..; left:.." åœ¨é€™)
					var left = div.style.left || '0%';
					var top = div.style.top || '0%';

					// 2. å¤§å°ï¼šå„ªå…ˆçœ‹ input æœ¬èº«æœ‰æ²’æœ‰è¨­å¯¬é«˜ï¼Œæ²’æœ‰çš„è©±çœ‹ divï¼Œå†æ²’æœ‰å°±çµ¦é è¨­å€¼
					// JSON ä¸­çš„ select é€šå¸¸æ²’æœ‰å¯¬åº¦ï¼Œçµ¦å€‹é è¨­å€¼
					// JSON ä¸­çš„ text/textarea é€šå¸¸æœ‰ style="width:..."
					var width = inputEl.style.width || div.style.width || '15%'; 
					var height = inputEl.style.height || div.style.height || '30px';
					
					// ç‰¹åˆ¥è™•ç† textarea é«˜åº¦ï¼Œå› ç‚º JSON è£¡æœ‰è¨­ height: 150px
					if (inputEl.tagName.toLowerCase() === 'textarea') {
						 if (!inputEl.style.height) height = '100px';
						 if (!inputEl.style.width) width = '80%';
					}
					
					// ç‰¹åˆ¥è™•ç† select (é¸æ“‡é¡Œ)ï¼Œå¯¬åº¦çµ¦å°ä¸€é»æ¯”è¼ƒå¥½çœ‹ï¼Œæˆ–è€…å›ºå®š
					if (inputEl.tagName.toLowerCase() === 'select') {
						if (!inputEl.style.width) width = '12%'; // çµ¦é¸æ“‡é¡Œä¸€å€‹é è¨­å¯¬åº¦
					}

					// å»ºç«‹æ¨™è¨˜ç‰©ä»¶
					newVeMarkersData[index].push({
						id: qId,
						left: left,
						top: top,
						w: width,
						h: height
					});
					markerCount++;
				});
				
				// â˜… å‚™æ¡ˆï¼šå¦‚æœæ²’æœ‰ç”¨ wrapperï¼Œå˜—è©¦ç›´æ¥æŠ“ input (ç›¸å®¹èˆŠæ ¼å¼)
				if (wrappers.length === 0) {
					var elements = doc.querySelectorAll('input[style*="position"], select[style*="position"], textarea[style*="position"]');
					elements.forEach(function(el) {
						var qId = el.id || el.getAttribute('name');
						if(qId) {
							 newVeMarkersData[index].push({
								id: qId,
								left: el.style.left || '0', top: el.style.top || '0',
								w: el.style.width || '10%', h: el.style.height || '30px'
							});
							markerCount++;
						}
					});
				}
			});

			console.log(`âœ… è§£æå®Œæˆï¼šå…± ${newVePages.length} é ï¼Œ${markerCount} å€‹é¡Œç›®æ¨™è¨˜`);

			// 4. æ›´æ–°å…¨åŸŸè®Šæ•¸
			vePages = newVePages;
			veJsonData = newVeJsonData;
			veMarkersData = newVeMarkersData;
			
			// è¨­å®šå°ˆæ¡ˆç‹€æ…‹
			currentEditingProjectState = {
				urls: vePages,
				jsonData: veJsonData,
				markers: veMarkersData
			};
			
			// å¡«å…¥å´é‚Šæ¬„
			var urlInput = document.getElementById('ve-url-input');
			var jsonInput = document.getElementById('ve-json-input');
			if(urlInput) urlInput.value = vePages.join('\n');
			if(jsonInput) jsonInput.value = JSON.stringify(veJsonData, null, 4);

			// 5. åŸ·è¡Œåˆ‡æ›
			closeAIImportModal();

			setTimeout(function() {
				if (typeof openVisualEditor === 'function') {
					openVisualEditor();
					
					// å¼·åˆ¶é‡ç½®åˆ°ç¬¬ä¸€é ä¸¦æ¸²æŸ“
					veCurrentPage = 0;
					if (typeof veRenderPage === 'function') {
						veRenderPage(); 
					}
					
					alert(`ğŸ‰ åŒ¯å…¥æˆåŠŸï¼\n\nå·²è¾¨è­˜å‡º ${markerCount} å€‹ä½œç­”æ¡†ã€‚\næ‚¨ç¾åœ¨å¯ä»¥æ‹–æ›³èª¿æ•´å®ƒå€‘çš„ä½ç½®äº†ã€‚`);
				} else {
					alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° Visual Editor å•Ÿå‹•å‡½å¼ã€‚');
				}
			}, 200);
		};

		// 3. AI æ¨¡å¼å°ˆç”¨çš„å–®å¼µåœ–ç‰‡ä¸Šå‚³
		window.aiUploadSingleImage = async function(input, targetId) {
			if (!input.files || input.files.length === 0) return;
			
			var file = input.files[0];
			var targetInput = document.getElementById(targetId);
			var originalPlaceholder = targetInput.placeholder;
			
			targetInput.value = '';
			targetInput.placeholder = 'â³ ä¸Šå‚³ä¸­...';
			targetInput.disabled = true;

			try {
				// ä½¿ç”¨èˆ‡åŸæœ¬ç›¸åŒçš„è·¯å¾‘çµæ§‹
				var ref = firebase.storage().ref().child(`resource_images/${currentUser.uid}/${Date.now()}_${file.name}`);
				await ref.put(file);
				var url = await ref.getDownloadURL();
				
				targetInput.value = url;
				targetInput.classList.add('bg-green-50', 'text-green-700'); // æˆåŠŸè¦–è¦ºå›é¥‹
			} catch (e) {
				alert('ä¸Šå‚³å¤±æ•—: ' + e.message);
			} finally {
				targetInput.placeholder = originalPlaceholder;
				targetInput.disabled = false;
				input.value = ''; // æ¸…ç©º file input ä»¥ä¾¿é‡è¤‡ä¸Šå‚³
			}
		};

		// 4. AI æ¨¡å¼é–‹å•Ÿåœ–åº«
		window.aiOpenLibrary = function(targetId) {
			currentAIInputId = targetId; // è¨˜éŒ„æ˜¯ç”±å“ªä¸€æ ¼å‘¼å«çš„
			if (window.veOpenLibraryModal) {
				window.veOpenLibraryModal(); // å‘¼å«åŸæœ¬çš„åœ–åº«é–‹å•Ÿå‡½å¼
			} else {
				alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åœ–åº«å‡½å¼');
			}
		};

		// ==========================================
		// ä¿®æ”¹åŸæœ‰çš„ veConfirmLibrarySelection
		// è®“å®ƒèƒ½æ”¯æ´ AI åŒ¯å…¥æ¨¡å¼
		// ==========================================
		// è«‹æ‰¾åˆ°åŸæœ¬çš„ veConfirmLibrarySelection ä¸¦æ›¿æ›æˆé€™å€‹ç‰ˆæœ¬
		window.veConfirmLibrarySelection = function() {
			const modal = document.getElementById('ve-library-modal');
			const checked = document.querySelectorAll('.lib-chk:checked');
			
			if (checked.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€å¼µåœ–ç‰‡");

			// â˜…â˜…â˜… åˆ¤æ–·æ¨¡å¼ â˜…â˜…â˜…
			if (currentAIInputId) {
				// [æ¨¡å¼ A] AI åŒ¯å…¥ç²¾éˆæ¨¡å¼ (åªå–ç¬¬ä¸€å¼µ)
				const selectedUrl = checked[0].value;
				const targetInput = document.getElementById(currentAIInputId);
				if (targetInput) {
					targetInput.value = selectedUrl;
					targetInput.classList.add('bg-blue-50', 'text-blue-700');
				}
				
				if (checked.length > 1) {
					alert(`å·²é¸å–ç¬¬ä¸€å¼µåœ–ç‰‡å¡«å…¥ "${currentAIInputId}" æ¬„ä½ã€‚`);
				}
				currentAIInputId = null; // é‡ç½®

			} else {
				// [æ¨¡å¼ B] åŸæœ¬çš„è¦–è¦ºåŒ–ç·¨è¼¯å™¨æ¨¡å¼
				const urlInput = document.getElementById('ve-url-input');
				const selectedUrls = Array.from(checked).map(cb => cb.value);
				const currentVal = urlInput.value.trim();
				urlInput.value = (currentVal ? currentVal + '\n' : '') + selectedUrls.join('\n');
				
				// è‡ªå‹•è¼‰å…¥
				if(window.veLoadProject) window.veLoadProject();
				alert(`âœ… å·²å¼•ç”¨ ${checked.length} å¼µåœ–ç‰‡ï¼`);
			}

			// é—œé–‰åœ–åº«è¦–çª—
			modal.classList.add('hidden');
			modal.style.removeProperty('display'); 
			modal.style.removeProperty('z-index');
			
			// æ¸…ç©ºå‹¾é¸
			checked.forEach(cb => cb.checked = false);
			if(document.getElementById('lib-sel-count')) document.getElementById('lib-sel-count').textContent = '0';
		};
		
		window.aiBatchPdfUpload = async function(input) {
            if (!input.files || input.files.length === 0) return;
            const file = input.files[0];
            
            // å–å¾—ç›®å‰ç•«é¢ä¸Šæ‰€æœ‰çš„è¼¸å…¥æ¡†ï¼Œä¸¦ä¾ç…§ pageKey æ’åº
            const inputs = Array.from(document.querySelectorAll('.ai-bg-url-input')).sort((a, b) => {
                return a.dataset.page.localeCompare(b.dataset.page, undefined, { numeric: true, sensitivity: 'base' });
            });

            if (inputs.length === 0) return alert("è«‹å…ˆè§£æ JSON ä»¥ç”¢ç”Ÿé é¢æ¬„ä½");

            const btnLabel = input.parentElement;
            const originalText = btnLabel.textContent; // "âš¡ é¸æ“‡ PDF è‡ªå‹•è½‰æª”"
            
            // é–å®šæŒ‰éˆ•é¿å…é‡è¤‡æŒ‰
            input.disabled = true;
            btnLabel.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                btnLabel.innerText = "â³ è®€å– PDF ä¸­...";
                
                // 1. è®€å– PDF
				const arrayBuffer = await file.arrayBuffer();
                
                // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šç›´æ¥åœ¨é€™è£¡æŒ‡å®š CMaps è·¯å¾‘ï¼Œæ¯”å…¨åŸŸè¨­å®šæ›´æœ‰æ•ˆ â˜…â˜…â˜…
                const loadingTask = pdfjsLib.getDocument({
                    data: arrayBuffer,
                    // ä½¿ç”¨å®˜æ–¹æ¨™æº–çµæ§‹çš„ CMaps è·¯å¾‘
                    cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
                    cMapPacked: true,
                    // å˜—è©¦è¼‰å…¥æ¨™æº–å­—å‹è³‡æ–™ (æœ‰åŠ©æ–¼æŸäº›ç‰¹æ®Šè‹±æ•¸å­—å‹)
                    standardFontDataUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/standard_fonts/'
                });

                const pdf = await loadingTask.promise;
                
                const totalPages = pdf.numPages;
                const processCount = Math.min(totalPages, inputs.length); // å– PDF é æ•¸èˆ‡ JSON é æ•¸çš„æœ€å°å€¼

                if (totalPages !== inputs.length) {
                    if(!confirm(`âš ï¸ æ³¨æ„ï¼š\nPDF å…±æœ‰ ${totalPages} é ï¼Œä½† JSON éœ€è¦ ${inputs.length} é ã€‚\n\nç³»çµ±å°‡æœƒä¾åºè™•ç†å‰ ${processCount} é ï¼Œç¢ºå®šç¹¼çºŒå—ï¼Ÿ`)) {
                        throw new Error("ä½¿ç”¨è€…å–æ¶ˆ");
                    }
                }

                // 2. é€é è™•ç†
                for (let i = 0; i < processCount; i++) {
                    const pageNum = i + 1;
                    const targetInput = inputs[i];

                    // UI æ›´æ–°ç‹€æ…‹
                    btnLabel.innerText = `â³ è™•ç†ç¬¬ ${pageNum}/${processCount} é ...`;
                    targetInput.placeholder = "ğŸ”„ è½‰æª”ä¸Šå‚³ä¸­...";
                    targetInput.classList.add('bg-yellow-50');

                    // å–å¾—é é¢
                    const page = await pdf.getPage(pageNum);
                    
                    // è¨­å®šç¸®æ”¾æ¯”ä¾‹ (2.0 = æ¸…æ™°åº¦è¼ƒé«˜)
                    const viewport = page.getViewport({ scale: 2.0 });
                    
                    // å»ºç«‹ Canvas
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    // æ¸²æŸ“ PDF åˆ° Canvas
                    await page.render({ canvasContext: context, viewport: viewport }).promise;

                    // Canvas è½‰ Blob (JPEG, 0.8 å“è³ª)
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                    
                    // ä¸Šå‚³ Firebase
                    const filename = `pdf_import_${Date.now()}_p${pageNum}.jpg`;
                    const ref = firebase.storage().ref().child(`resource_images/${currentUser.uid}/${filename}`);
                    
                    btnLabel.innerText = `â˜ï¸ ä¸Šå‚³ç¬¬ ${pageNum}/${processCount} é ...`;
                    await ref.put(blob);
                    const url = await ref.getDownloadURL();

                    // å¡«å…¥ç¶²å€
                    targetInput.value = url;
                    targetInput.classList.remove('bg-yellow-50');
                    targetInput.classList.add('bg-green-50', 'text-green-700'); // æˆåŠŸæ¨™ç¤º
                }

                alert("ğŸ‰ PDF è½‰æª”ä¸¦ä¸Šå‚³å®Œæˆï¼");

            } catch (e) {
                if (e.message !== "ä½¿ç”¨è€…å–æ¶ˆ") {
                    console.error(e);
                    alert("è™•ç†å¤±æ•—: " + e.message);
                }
            } finally {
                // å¾©åŸæŒ‰éˆ•ç‹€æ…‹
                input.value = ''; // æ¸…ç©ºä»¥å…è¨±å†æ¬¡é¸æ“‡
                input.disabled = false;
                btnLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                btnLabel.innerHTML = `âš¡ é¸æ“‡ PDF è‡ªå‹•è½‰æª” <input type="file" class="hidden" accept="application/pdf" onchange="aiBatchPdfUpload(this)">`;
            }
        };
				
		/* ==========================================
		   ğŸ¤– Gemini API æ•´åˆé‚è¼¯ (Client-Side)
		   ========================================== */
		const GEMINI_API_KEY = "AIzaSyApaFU-uDxigWjDzGEJ5cY5qsJ5oFtXxaE"; // æ‚¨çš„ API Key
		const GEMINI_MODEL_NAME = "gemini-2.5-flash"; // ä½¿ç”¨æœ€æ–°æ¨¡å‹

		// 1. æª”æ¡ˆé è¦½èˆ‡æŒ‰éˆ•ç‹€æ…‹æ›´æ–°
		function previewUploadFile() {
			const fileInput = document.getElementById('gemini-upload-file');
			const infoDisplay = document.getElementById('file-info-display');
			const runBtn = document.getElementById('btn-run-gemini');

			if (fileInput.files.length > 0) {
				const file = fileInput.files[0];
				infoDisplay.textContent = `å·²é¸æ“‡: ${file.name} (${(file.size/1024).toFixed(1)} KB)`;
				
				// å•Ÿç”¨æŒ‰éˆ•ï¼Œè®Šè‰²
				runBtn.disabled = false;
				runBtn.classList.remove('bg-gray-300', 'text-white');
				runBtn.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700', 'shadow-lg');
			} else {
				infoDisplay.textContent = "";
				runBtn.disabled = true;
				runBtn.classList.add('bg-gray-300');
				runBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'shadow-lg');
			}
		}

		/* ==========================================
		   ğŸš€ å…¨è‡ªå‹• AI è™•ç†æ ¸å¿ƒé‚è¼¯ (Gemini + PDF.js + Firebase)
		   ========================================== */

		// 1. åŸ·è¡Œåˆ†æ (é€²å…¥é») - ä¿®æ­£ç‰ˆï¼šä½¿ç”¨æ­£ç¢ºçš„å®Œæ•´æç¤ºèª
		async function runGeminiAnalysis() {
			if (!window.GenAI) {
				alert("éŒ¯èª¤ï¼šGemini SDK å°šæœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
				return;
			}

			const fileInput = document.getElementById('gemini-upload-file');
			const statusEl = document.getElementById('gemini-status');
			const runBtn = document.getElementById('btn-run-gemini');

			if (fileInput.files.length === 0) return;
			const file = fileInput.files[0];

			// é–å®šä»‹é¢
			const originalBtnContent = runBtn.innerHTML;
			runBtn.disabled = true;
			runBtn.innerHTML = `<span class="animate-spin text-2xl">â†»</span><span>AI æ€è€ƒä¸­...</span>`;
			
			// ç‹€æ…‹ 1: å‘¼å« Gemini
			statusEl.className = "text-xs text-center mt-2 text-indigo-600 font-bold animate-pulse";
			statusEl.textContent = "ğŸš€ æ­£åœ¨å‚³é€çµ¦ Gemini åˆ†æé¡Œç›®çµæ§‹ (Step 1/3)...";

			try {
				// A. æº–å‚™ Prompt (é€™è£¡å¿…é ˆç”¨çœŸæ­£çš„ < > ç¬¦è™Ÿï¼Œä¸”è¦å‰‡è¦å®Œæ•´)
				const promptText = `
		# è§’è‰²
		ä½ æ˜¯ä¸€ä½è³‡æ·±çš„è³‡è¨Šç§‘å­¸æ•™å¸«èˆ‡å‰ç«¯å·¥ç¨‹å¸«ï¼Œæ“…é•·å¾ PDF ç¿’ä½œä¸­æå–è©•é‡å…§å®¹ï¼Œä¸¦å°‡å…¶è½‰æ›ç‚ºã€Œè³‡æ–™ï¼ˆJSONï¼‰ã€èˆ‡ã€Œè¦–è¦ºå±¤ï¼ˆHTMLï¼‰ã€æ•´åˆçš„æ ¼å¼ã€‚

		# ä»»å‹™
		è«‹åˆ†æä¸Šå‚³çš„ PDF ç¿’ä½œé é¢ï¼Œè­˜åˆ¥ã€Œé¸æ“‡é¡Œã€ã€ã€Œå¡«å……é¡Œã€ã€ã€Œæ˜¯é/å‹¾é¸é¡Œã€ä»¥åŠã€Œæ‰‹å¯«/ç¹ªåœ–/è¨ˆç®—é¡Œã€ã€‚
		ä½ éœ€è¦åšå…©ä»¶äº‹ï¼š
		1. **è³‡æ–™æå–**ï¼šè§£æé¡Œç›®å…§å®¹èˆ‡ç­”æ¡ˆï¼Œè½‰ç‚º JSONã€‚
		2. **è¦–è¦ºä½ˆå±€**ï¼šä¼°æ¸¬è©²é¡Œç›®åœ¨é é¢ä¸Šçš„ã€Œä½œç­”å€åŸŸä½ç½®ã€ï¼Œä¸¦ç”Ÿæˆå°æ‡‰çš„ HTML æ¨™ç±¤ã€‚

		# æ“·å–è¦å‰‡
		1. **é¡Œç›®æ‹†è§£**ï¼š
		   - å«å°é¡Œçš„é¡Œç›®ï¼ˆå¦‚ 1. (1)ï¼‰éœ€æ‹†åˆ†ç‚ºç¨ç«‹ Entryã€‚
		   - æ˜¯é/å‹¾é¸é¡Œè‹¥æœ‰å¤šå€‹é¸é …ï¼Œæ¯å€‹é¸é …è¦–ç‚ºç¨ç«‹çš„ True/False é¡Œç›®ã€‚

		2. **é¡Œå‹åˆ¤æ–· (é—œéµ)**ï¼š
		   - è‹¥é¡Œç›®å‡ºç¾ã€Œç•«å‡ºã€ã€ã€Œç¹ªè£½ã€ã€ã€Œå¯«å‡ºè¨ˆç®—éç¨‹ã€ã€ã€Œè©³è§£ã€ã€ã€Œè­‰æ˜ã€ã€ã€Œä¸Šå‚³æˆªåœ–ã€ç­‰é—œéµå­—ï¼Œè«‹æ­¸é¡ç‚º **æ‰‹å¯«/ç¹ªåœ–é¡Œ (handwriting)**ã€‚

		3. **ID å‘½å (Strict)**ï¼š
		   - æ ¼å¼ï¼šp{é ç¢¼}_q{å¤§é¡Œè™Ÿ}_{å­é¡Œè™Ÿ}
		   - ä¾‹å¦‚ï¼šp1_q2_1ã€‚æ­¤ ID å¿…é ˆåŒæ™‚ç”¨æ–¼ JSON Key èˆ‡ HTML çš„ id å±¬æ€§ã€‚

		4. **ä½ç½®ä¼°ç®— (Critical)**ï¼š
		   - è«‹è§€å¯Ÿ PDF åœ–åƒï¼Œä¼°ç®—è©²é¡Œã€Œä½œç­”æ ¼/æ‹¬è™Ÿ/ç©ºç™½è™•ã€åœ¨è©²é é¢çš„**ç›¸å°ä½ç½®**ï¼ˆTop% èˆ‡ Left%ï¼‰ã€‚
		   - è‹¥æ˜¯å¡«å……é¡Œï¼Œä½ç½®æ‡‰ç‚ºåº•ç·šæˆ–æ‹¬è™Ÿçš„èµ·å§‹é»ã€‚
		   - è‹¥æ˜¯æ‰‹å¯«/ç¹ªåœ–é¡Œï¼Œä½ç½®æ‡‰ç‚ºè©²é¡Œé ç•™ç©ºç™½ä½œç­”å€çš„å·¦ä¸Šè§’ã€‚

		# è¼¸å‡ºæ ¼å¼ (JSON çµæ§‹)
		è«‹è¼¸å‡ºä¸€å€‹åŒ…å«ä¸‰å€‹ä¸»è¦æ¬„ä½çš„ JSON ç‰©ä»¶ï¼š
		1. "worksheet_title": "å­¸ç¿’å–®æ¨™é¡Œ (è«‹å¾å…§å®¹è­˜åˆ¥)"
		2. "questions": é¡Œåº«è³‡æ–™ç‰©ä»¶ã€‚
		3. "pages_html": æ¯ä¸€é å°æ‡‰çš„ HTML ç–ŠåŠ å±¤å­—ä¸²ã€‚

		## 1. questions æ¬„ä½è¦ç¯„
		Key ç‚º IDï¼ŒValue åŒ…å«ï¼š
		- unitId: "page1", "page2"...
		- label: é¡Œè™Ÿ+é¡Œç›®ç°¡è¿°ã€‚
		- answer: æ¨™æº–ç­”æ¡ˆ (è‹¥ç‚ºé–‹æ”¾å¼ç¹ªåœ–é¡Œï¼Œå¯å¡« "ç•¥" æˆ– "è«‹åƒé–±è©³è§£")ã€‚
		- points: é…åˆ† (é è¨­ é¸æ“‡4, å¡«å……5, æ˜¯é2, æ‰‹å¯«/ç¹ªåœ– 10)ã€‚
		- type: "choice", "text", "true_false", "checkbox", "handwriting"ã€‚
		- choiceNo: é¸æ“‡é¡Œé¸é …å­—ä¸² (éé¸æ“‡é¡Œç•™ç©º)ã€‚

		## 2. pages_html æ¬„ä½è¦ç¯„
		Key ç‚º "page1", "page2"...ï¼ŒValue ç‚ºè©²é é¢çš„ HTML å­—ä¸²ã€‚
		HTML ç”Ÿæˆè¦å‰‡ï¼š
		- å¿…é ˆæ˜¯ **ç´” HTML æ¨™ç±¤** (ä¸å« html/head/body)ã€‚
		- é‡å°æ¯å€‹é¡Œç›®ç”Ÿæˆè¼¸å…¥å…ƒä»¶ï¼Œå¤–å±¤ç”¨ <div class='input-wrapper'> åŒ…è¦†ã€‚
		- **Style å±¬æ€§**ï¼šå¿…é ˆåŒ…å« position: absolute; top: {Y}%; left: {X}%; (æ ¹æ“šä½ çš„è¦–è¦ºä¼°ç®—)ã€‚
		- **å…ƒä»¶é¡å‹å°æ‡‰**ï¼š
		  - **choice (é¸æ“‡é¡Œ)**: ç”Ÿæˆ <select id="..."> åŒ…å«é¸é … A,B,C,D...
		  - **text (å¡«å……é¡Œ)**: ç”Ÿæˆ <input type="text" id="...">ã€‚
		  - **true_false/checkbox**: ç”Ÿæˆ <input type="checkbox" id="...">ã€‚
		  - **handwriting (æ‰‹å¯«/ç¹ªåœ–)**: 
			å¿…é ˆç”Ÿæˆ **å…©å€‹** å…ƒç´ åœ¨åŒä¸€å€‹ div å…§ï¼š
			1. <textarea id="{ID}" class="ans-input" placeholder="å¯è¼¸å…¥æ–‡å­—èªªæ˜..."></textarea>
			2. <label class="file-upload-btn">ğŸ“· ä¸Šå‚³ç…§ç‰‡<input type="file" id="{ID}_file" name="{ID}_file" accept="image/*" style="display:none;"></label>
			   (è¨»ï¼šè«‹ç¢ºä¿ file input çš„ name ç‚º ID + "_file"ï¼Œä»¥ä¾¿ç³»çµ±è­˜åˆ¥ç‚ºè£œå……æª”æ¡ˆ)
		`;

				// B. æª”æ¡ˆè½‰ Base64 ä¸¦å‘¼å« API
				const base64Data = await fileToGenerativePart(file);
				const genAI = new window.GenAI(GEMINI_API_KEY);
				const model = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME });

				const result = await model.generateContent([ promptText, base64Data ]);
				const response = await result.response;
				const text = response.text();

				// C. è§£æ JSON
				let cleanJson = text.replace(/```json/g, '').replace(/```/g, '').trim();
				
				// â˜…â˜…â˜… ä¿®æ­£ï¼šå¼·åˆ¶æŠ“å– JSON ç‰©ä»¶ç¯„åœ (å¿½ç•¥ AI çš„é–‹å ´ç™½èˆ‡çµå°¾) â˜…â˜…â˜…
				const firstBrace = cleanJson.indexOf('{');
				const lastBrace = cleanJson.lastIndexOf('}');
				
				if (firstBrace !== -1 && lastBrace !== -1) {
					// åªä¿ç•™ { ... } ä¸­é–“çš„éƒ¨åˆ†
					cleanJson = cleanJson.substring(firstBrace, lastBrace + 1);
				} else {
					throw new Error("AI å›å‚³çš„å…§å®¹æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ JSON ç‰©ä»¶ ({ ... })");
				}

				let jsonData;
				try {
					jsonData = JSON.parse(cleanJson);
				} catch (e) {
					console.error("JSON Parse Error:", e);
					console.log("Raw Text:", text); // æ–¹ä¾¿é™¤éŒ¯
					throw new Error("JSON æ ¼å¼ææ¯€ï¼Œè«‹é‡è©¦ (SyntaxError)");
				}

				// D. é€²å…¥è‡ªå‹•åŒ–ç¬¬äºŒéšæ®µï¼šPDF è™•ç†
				statusEl.textContent = "ğŸ”„ Gemini åˆ†æå®Œæˆï¼æ­£åœ¨è™•ç† PDF é é¢è½‰æª”èˆ‡ä¸Šå‚³ (Step 2/3)...";
				statusEl.className = "text-xs text-center mt-2 text-orange-600 font-bold animate-pulse";
				
				// å‘¼å«è‡ªå‹•è™•ç†å‡½å¼ (é€™éƒ¨åˆ†ç¶­æŒåŸæœ¬é‚è¼¯)
				await autoProcessPDFAndSynthesize(file, jsonData, statusEl);

				// E. å®Œæˆ
				statusEl.className = "text-xs text-center mt-2 text-green-600 font-bold";
				statusEl.textContent = "âœ… å…¨æ•¸å®Œæˆï¼å·²å¡«å…¥ç·¨è¼¯å™¨ã€‚";
				closeAIImportModal(); // è‡ªå‹•é—œé–‰è¦–çª—
				
				// å¦‚æœæœ‰æŠ“åˆ°æ¨™é¡Œï¼Œè‡ªå‹•å¡«å…¥
				if(jsonData.worksheet_title) {
					document.getElementById('ws-title').value = jsonData.worksheet_title;
				}

			} catch (error) {
				console.error("Auto Process Error:", error);
				statusEl.className = "text-xs text-center mt-2 text-red-500 font-bold";
				statusEl.textContent = `âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}`;
				alert("è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Console (F12)ã€‚å¯èƒ½åŸå› ï¼šJSON æ ¼å¼éŒ¯èª¤æˆ–ç¶²è·¯é€¾æ™‚ã€‚");
			} finally {
				runBtn.disabled = false;
				runBtn.innerHTML = originalBtnContent;
			}
		}

		// 2. è‡ªå‹• PDF è½‰æª”ã€ä¸Šå‚³ã€åˆæˆ (æœ€çµ‚ä¿®æ­£ç‰ˆï¼šæš´åŠ›æ³¨å…¥ DOM ç¢ºä¿è³‡æ–™é¡¯ç¤º)
		async function autoProcessPDFAndSynthesize(file, jsonData, statusEl) {
			// æª¢æŸ¥æª”æ¡ˆé¡å‹
			if (file.type !== 'application/pdf') {
				throw new Error("è‡ªå‹•æ¨¡å¼ç›®å‰åƒ…æ”¯æ´ PDF æª”æ¡ˆå®Œæ•´æµç¨‹ã€‚");
			}

			// ==========================================
			// A. è®€å– PDF
			// ==========================================
			const arrayBuffer = await file.arrayBuffer();
			const loadingTask = pdfjsLib.getDocument({
				data: arrayBuffer,
				cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
				cMapPacked: true
			});
			const pdf = await loadingTask.promise;
			const totalPages = pdf.numPages;

			// ==========================================
			// B. æº–å‚™ JSON Key æ’åº
			// ==========================================
			if (!jsonData.pages_html) jsonData.pages_html = {};
			const sortedPageKeys = Object.keys(jsonData.pages_html).sort((a, b) => {
				return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
			});

			const processedPages = [];
			
			// ==========================================
			// C. é€é è½‰æª”èˆ‡ä¸Šå‚³ (Firebase)
			// ==========================================
			for (let i = 0; i < totalPages; i++) {
				const pageNum = i + 1;
				statusEl.textContent = `ğŸ”„ æ­£åœ¨è™•ç†ç¬¬ ${pageNum}/${totalPages} é  (è½‰æª”ä¸¦ä¸Šå‚³é›²ç«¯)...`;
				
				// Render Page
				const page = await pdf.getPage(pageNum);
				const viewport = page.getViewport({ scale: 2.0 });
				const canvas = document.createElement('canvas');
				const context = canvas.getContext('2d');
				canvas.height = viewport.height;
				canvas.width = viewport.width;
				await page.render({ canvasContext: context, viewport: viewport }).promise;

				// Upload
				const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.85));
				const filename = `auto_ai_${Date.now()}_p${pageNum}.jpg`;
				const ref = firebase.storage().ref().child(`resource_images/${currentUser.uid}/${filename}`);
				await ref.put(blob);
				const url = await ref.getDownloadURL();

				processedPages.push(url);
			}

			// ==========================================
			// D. åˆæˆ HTML (Mapping) èˆ‡ åº§æ¨™è¨ˆç®—
			// ==========================================
			statusEl.textContent = "âœ¨ æ­£åœ¨åˆæˆæœ€çµ‚å­¸ç¿’å–® (Step 3/3)...";
			
			let fullHtml = "";
			let parser = new DOMParser();
			let newVeMarkersData = {}; // é€™æ˜¯ AI ç®—å‡ºä¾†çš„åº§æ¨™
			let newVeJsonData = jsonData.questions || {};

			for (let i = 0; i < processedPages.length; i++) {
				const bgUrl = processedPages[i];
				let inputsHtml = "";
				
				// åˆå§‹åŒ–è©²é é™£åˆ—
				newVeMarkersData[i] = []; 

				if (i < sortedPageKeys.length) {
					const key = sortedPageKeys[i];
					const rawHtml = jsonData.pages_html[key];
					const doc = parser.parseFromString(rawHtml, 'text/html');
					
					// è§£æç­–ç•¥ï¼šæ‰¾ .input-wrapper æˆ– å¸¶æœ‰ position çš„ input
					let wrappers = doc.querySelectorAll('.input-wrapper');
					
					if (wrappers.length === 0) {
						// Fallback: ç›´æ¥æ‰¾ input
						const rawElements = doc.querySelectorAll('input[style*="position"], select[style*="position"], textarea[style*="position"]');
						rawElements.forEach(el => {
							const qId = el.id || el.getAttribute('name');
							if (qId) {
								const left = el.style.left || '0%';
								const top = el.style.top || '0%';
								const width = el.style.width || '15%';
								const height = el.style.height || '30px';
								// å­˜å…¥åº§æ¨™æ•¸æ“š
								newVeMarkersData[i].push({ id: qId, left, top, w: width, h: height });
								inputsHtml += el.outerHTML + "\n";
							}
						});
					} else {
						// Standard: .input-wrapper
						wrappers.forEach(div => {
							const inputEl = div.querySelector('input, select, textarea');
							if (!inputEl) return;
							const qId = inputEl.id || inputEl.getAttribute('name');
							if (!qId) return;

							const left = div.style.left || '0%';
							const top = div.style.top || '0%';
							let width = inputEl.style.width || div.style.width || '15%';
							let height = inputEl.style.height || div.style.height || '30px';
							
							// æ ¹æ“šé¡Œå‹å¾®èª¿é¡¯ç¤º HTML
							const qType = (newVeJsonData[qId] && newVeJsonData[qId].type) ? newVeJsonData[qId].type : 'text';
							const commonStyle = `position:absolute; left:${left}; top:${top}; width:${width}; height:${height}; z-index:10;`;
							
							if (qType === 'choice') {
								let options = '<option value="">è«‹é¸æ“‡</option>';
								['A','B','C','D'].forEach(o => options += `<option value="${o}">${o}</option>`);
								inputsHtml += `<select name="${qId}" class="worksheet-input" style="${commonStyle} background:rgba(255,255,255,0.9); border:1px solid #bfdbfe; color:#1d4ed8;">${options}</select>\n`;
							} else if (qType === 'checkbox') {
								inputsHtml += `<div style="${commonStyle} display:flex; align-items:center; justify-content:center;"><input type="checkbox" name="${qId}" value="true" style="width:20px; height:20px;"></div>\n`;
							} else {
								inputsHtml += `<input type="text" name="${qId}" class="worksheet-input" style="${commonStyle} background:rgba(255,255,255,0.9); border:1px solid #bfdbfe; text-align:center;" placeholder="(${qId})">\n`;
							}
							
							// å­˜å…¥åº§æ¨™æ•¸æ“š
							newVeMarkersData[i].push({ id: qId, left, top, w: width, h: height });
						});
					}
				}

				fullHtml += `<div class="sheet-page relative w-full max-w-[800px] mx-auto mb-5 shadow bg-white">
					<img src="${bgUrl}" style="width:100%; display:block;">
					${inputsHtml}
				</div>\n`;
			}

			// ==========================================
			// E. å¯«å…¥è³‡æ–™åº«æ ¼å¼ (Hidden Inputs)
			// ==========================================
			document.getElementById('ws-html').value = fullHtml;
			document.getElementById('ws-json').value = JSON.stringify(newVeJsonData, null, 4);

			// ==========================================
			// F. ã€é—œéµä¿®æ­£ã€‘å¼·åˆ¶å•Ÿå‹•è¦–è¦ºåŒ–ç·¨è¼¯å™¨æµç¨‹
			// ==========================================
			
			// 1. é—œé–‰åŒ¯å…¥è¦–çª—
			closeAIImportModal(); 

			// 2. é–‹å•Ÿè¦–è¦ºåŒ–ç·¨è¼¯å™¨
			if (typeof openVisualEditor === 'function') {
				openVisualEditor();

				// 3. ã€æš´åŠ›æ³¨å…¥ã€‘ç›´æ¥æ“ä½œç·¨è¼¯å™¨çš„ DOMï¼Œä¸ä¾è³´å…¨åŸŸè®Šæ•¸å‚³é
				// é€™æ˜¯ç¢ºä¿å·¦å´æ¬„ä½ä¸€å®šæœ‰è³‡æ–™çš„å”¯ä¸€æ–¹æ³•
				setTimeout(() => {
					const veUrlInput = document.getElementById('ve-url-input');
					const veJsonInput = document.getElementById('ve-json-input');
					
					// å°‡æˆ‘å€‘è™•ç†å¥½çš„è³‡æ–™ç›´æ¥å¡é€²å»
					if (veUrlInput) veUrlInput.value = processedPages.join('\n');
					if (veJsonInput) veJsonInput.value = JSON.stringify(newVeJsonData, null, 4);

					// 4. å¼·åˆ¶æ›´æ–°å…¨åŸŸç‹€æ…‹è®Šæ•¸ (ç¢ºä¿ç·¨è¼¯å™¨å…§éƒ¨é‚è¼¯åŒæ­¥)
					if (typeof vePages !== 'undefined') vePages = processedPages;
					if (typeof veJsonData !== 'undefined') veJsonData = newVeJsonData;
					
					// 5. ã€é—œéµæ­¥é©Ÿã€‘è¦†è“‹ Marker è³‡æ–™
					// å› ç‚º veLoadProject æˆ–æ˜¯ openVisualEditor å¯èƒ½æœƒé‡ç½® marker
					// æˆ‘å€‘é€™è£¡å¼·åˆ¶æŠŠ AI ç®—å¥½çš„ marker è“‹å›å»
					if (typeof veMarkersData !== 'undefined') {
						veMarkersData = newVeMarkersData;
					}

					// 6. å¼·åˆ¶æ¸²æŸ“ç¬¬ä¸€é 
					if (typeof veCurrentPage !== 'undefined') veCurrentPage = 0;
					if (typeof veRenderPage === 'function') {
						veRenderPage();
						console.log("âœ… å¼·åˆ¶æ¸²æŸ“å®Œæˆ (Page 0)");
					}

					alert("ğŸ‰ AI åˆ†æå®Œæˆï¼\n\nç³»çµ±å·²è‡ªå‹•å¡«å…¥åœ–ç‰‡èˆ‡åº§æ¨™ã€‚\nè«‹æª¢æŸ¥ç´…æ¡†ä½ç½®æ˜¯å¦æ­£ç¢ºã€‚");
					
				}, 300); // å»¶é² 300ms ç¢ºä¿è¦–çª—å·²å®Œå…¨æ‰“é–‹

			} else {
				alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° Visual Editor å•Ÿå‹•å‡½å¼ã€‚');
			}
		}
		
		// è¼”åŠ©ï¼šæª”æ¡ˆè½‰ Base64 ä¾› SDK ä½¿ç”¨
		async function fileToGenerativePart(file) {
			const base64EncodedDataPromise = new Promise((resolve) => {
				const reader = new FileReader();
				reader.onloadend = () => resolve(reader.result.split(',')[1]);
				reader.readAsDataURL(file);
			});
			return {
				inlineData: {
					data: await base64EncodedDataPromise,
					mimeType: file.type,
				},
			};
		}
	</script>
	
</body>
</html>
