<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’å–®ç®¡ç†ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
	<script>
	  window.MathJax = {
		tex: {
		  inlineMath: [['$', '$'], ['\\(', '\\)']]
		}
	  };
	</script>
	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; }
        
        /* å­¸ç¿’å–®é è¦½å€å¡Š */
        .worksheet-preview { 
            border: 2px dashed #ccc; 
            padding: 20px; 
            background: #fff; 
            border-radius: 8px; 
            min-height: 100px; 
        }
        .worksheet-input {
            border: 1px solid #ccc;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 0 5px;
            background-color: #fff;
        }

        /* æ‰¹æ”¹é¢æ¿æ¨£å¼ */
        .grading-panel {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #94a3b8;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 0 4px 4px 0;
            margin-top: 5px; 
            position: relative;
            z-index: 10;
        }
        .grading-panel.correct { border-left-color: #22c55e; background-color: #f0fdf4; }
        .grading-panel.incorrect { border-left-color: #ef4444; background-color: #fef2f2; }
        
        .grading-radio-label {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 0.9em;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .grading-radio-label:hover { background-color: #e2e8f0; }
        
        input[type="radio"]:checked + span.btn-text-correct { color: #166534; }
        input[type="radio"]:checked + span.btn-text-incorrect { color: #991b1b; }

        /* å­¸æ ¡é¸æ“‡æ¸…å–® */
        .school-select-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .school-select-item:hover {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-view" class="flex flex-col items-center justify-center h-screen">
        <div class="bg-white p-8 rounded shadow-lg text-center w-96">
            <h1 class="text-2xl font-bold mb-4">å­¸ç¿’å–®ç®¡ç†ç³»çµ±</h1>
            <p class="mb-6 text-gray-600">è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
            <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded w-full flex justify-center items-center gap-2">
                Google ç™»å…¥
            </button>
            <p id="login-msg" class="mt-4 text-sm text-red-500 font-bold"></p>
        </div>
    </div>

    <div id="onboarding-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ğŸ« è«‹ç¢ºèªæ‚¨çš„ä»»è·å­¸æ ¡</h2>
            <p class="text-sm text-gray-600 mb-4">ç³»çµ±åµæ¸¬åˆ°æ‚¨çš„å§“å <strong><span id="onboarding-name" class="text-blue-600"></span></strong> å­˜åœ¨æ–¼ä»¥ä¸‹å­¸æ ¡åå†Šä¸­ã€‚<br>è«‹é¸æ“‡æ­£ç¢ºçš„å­¸æ ¡é€²è¡Œå¸³è™Ÿç¶å®šï¼š</p>
            <div id="school-list" class="space-y-2 max-h-60 overflow-y-auto mb-4"></div>
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                <p class="text-xs text-yellow-700"><strong>âš ï¸ é‡è¦è­¦å‘Šï¼š</strong><br>æ­¤è¨­å®šç‚º<strong>æ°¸ä¹…ç¶å®š</strong>ï¼Œä¸€æ—¦ç¢ºèªå¾Œç„¡æ³•è‡ªè¡Œä¿®æ”¹ã€‚</p>
            </div>
            <button id="cancel-bind-btn" class="w-full text-gray-500 text-sm hover:underline">é€™ä¸æ˜¯æˆ‘ï¼Œç™»å‡ºä¸¦è¿”å›</button>
        </div>
    </div>

    <div id="app-view" class="container mx-auto p-4 hidden">
        <header class="flex justify-between items-center bg-white p-4 rounded shadow mb-6">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">ğŸ“š ä½œæ¥­ç®¡ç†ä¸­å¿ƒ</h1>
                    <p class="text-sm text-gray-500">
                        <span id="header-school-name" class="font-bold text-blue-600">è¼‰å…¥ä¸­...</span> | 
                        <span id="user-info">è¼‰å…¥ä¸­...</span>
                    </p>
                </div>
                <button id="force-refresh-btn" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition" title="æ‰‹å‹•å¾é›²ç«¯è¼‰å…¥æœ€æ–°è³‡æ–™">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </button>
            </div>
            <button id="logout-btn" class="text-sm text-gray-600 hover:text-red-500 font-bold border border-gray-300 px-3 py-1 rounded">ç™»å‡º</button>
        </header>

		<div class="flex mb-4 border-b border-gray-300 overflow-x-auto">
            <button id="btn-tab-grading" class="tab-btn px-6 py-3 text-blue-600 border-b-2 border-blue-600 font-bold hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('grading')">ğŸ“ æ‰¹æ”¹ä½œæ¥­</button>
            <button id="btn-tab-library" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('library')">ğŸ“‚ å­¸ç¿’å–®ç®¡ç†</button>
            <button id="btn-tab-assign" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('assign')">ğŸš€ ç™¼å¸ƒä»»å‹™</button>
            <button id="btn-tab-withdraw" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('withdraw')">ğŸ“Š ä»»å‹™ç®¡ç†</button>
        </div>

        <div id="tab-grading" class="app-section-panel">
            <div class="bg-white p-6 rounded shadow max-w-5xl mx-auto">
                <h2 class="text-lg font-bold mb-6 pb-2 border-b flex items-center gap-2">
                    ğŸ“ å¾…æ‰¹æ”¹ä½œæ¥­åˆ—è¡¨
                    <span class="text-xs font-normal text-gray-500 ml-2">(è«‹é¸æ“‡è¦é€²å…¥çš„ç­ç´šä½œæ¥­)</span>
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-blue-50 border-b border-blue-200">
                                <th class="p-4 font-bold text-blue-800 w-1/3">å­¸ç¿’å–®åç¨±</th>
                                <th class="p-4 font-bold text-blue-800 w-2/3">ç­ç´šèˆ‡æ‰¹æ”¹å…¥å£</th>
                            </tr>
                        </thead>
                        <tbody id="grading-list-body" class="text-sm">
                            <tr><td colspan="2" class="p-8 text-center text-gray-500">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-library" class="app-section-panel hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded shadow h-fit">
                    <h2 class="text-lg font-bold mb-4 border-b pb-2">â• æ–°å¢å­¸ç¿’å–®</h2>
                    
                    <label class="block text-sm font-bold mb-2">æ¨™é¡Œ</label>
                    <input type="text" id="ws-title" class="w-full border p-2 rounded mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
                    
                    <label class="block text-sm font-bold mb-2">HTML åŸå§‹ç¢¼</label>
                    <textarea id="ws-html" class="w-full border p-2 rounded h-40 font-mono text-xs mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="<div>...</div>"></textarea>
                    
                    <label class="block text-sm font-bold mb-2 text-blue-600">ç­”æ¡ˆå·è³‡æ–™ (JSON) <span class="text-xs font-normal text-gray-500">(è‡ªå‹•æ‰¹æ”¹ç”¨)</span></label>
                    <textarea id="ws-json" class="w-full border p-2 rounded h-32 font-mono text-xs mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder='{"q1": {"answer": "A", "note": "..."}}'></textarea>

                    <button id="preview-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm mb-4 w-full">ğŸ‘‡ é è¦½ HTML</button>
                    <button id="save-ws-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow transition">å„²å­˜åˆ°é¡Œåº«</button>
                </div>
                <div class="md:col-span-2 space-y-6">
                    <div id="preview-area" class="hidden">
                        <h3 class="text-sm font-bold text-gray-500 mb-1">é è¦½çµæœï¼š</h3>
                        <div id="preview-content" class="worksheet-preview"></div>
                    </div>
                    <div class="bg-white p-6 rounded shadow">
                        <h2 class="text-lg font-bold mb-4">ğŸ“œ å·²å»ºç«‹çš„å­¸ç¿’å–®</h2>
                        <div id="ws-list" class="space-y-3"><p class="text-center text-gray-500 py-4">è¼‰å…¥ä¸­...</p></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-assign" class="app-section-panel hidden">
            <div class="bg-white p-6 rounded shadow max-w-4xl mx-auto border-t-4 border-blue-500">
                <h2 class="text-lg font-bold mb-6 pb-2 border-b">ğŸš€ æ´¾ç™¼ä½œæ¥­</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">1. é¸æ“‡å­¸ç¿’å–®</label>
                        <select id="assign-ws-select" class="w-full border p-2 rounded bg-white outline-none"><option value="">è¼‰å…¥ä¸­...</option></select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">2. æˆªæ­¢æ—¥æœŸ (é¸å¡«)</label>
                        <input type="date" id="assign-deadline" class="w-full border p-2 rounded outline-none">
                    </div>
                </div>
                <div class="mt-6">
                    <label class="block text-gray-700 font-bold mb-2">3. é¸æ“‡ç­ç´š</label>
                    <div id="class-checkboxes" class="grid grid-cols-3 md:grid-cols-5 gap-3 p-4 bg-gray-50 rounded border max-h-40 overflow-y-auto"></div>
                </div>
                <div class="mt-8 text-center">
                    <button id="submit-assign-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-lg shadow-lg">ç¢ºèªç™¼å¸ƒ</button>
                </div>
            </div>
        </div>

        <div id="tab-withdraw" class="app-section-panel hidden">
            <div class="bg-white p-6 rounded shadow max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">ğŸ“Š ä»»å‹™ç®¡ç†</h2>
                    <div class="flex gap-2">
                        <button id="batch-deadline-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded shadow text-sm disabled:opacity-50">ğŸ“… ä¿®æ”¹æˆªæ­¢æ—¥</button>
                        <button id="batch-withdraw-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded shadow text-sm disabled:opacity-50">ğŸ—‘ï¸ æ’¤å›ç™¼å¸ƒ</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b border-gray-300">
                                <th class="p-3 font-bold text-gray-700 w-1/3">å­¸ç¿’å–®åç¨±</th>
                                <th class="p-3 font-bold text-gray-700 w-2/3">å·²ç™¼å¸ƒç­ç´š (å‹¾é¸ä»¥ç®¡ç†)</th>
                            </tr>
                        </thead>
                        <tbody id="assignment-table-body" class="text-sm"><tr><td colspan="2" class="p-4 text-center">è¼‰å…¥ä¸­...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div id="view-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="view-modal-title" class="text-xl font-bold">é è¦½</h3>
                <button onclick="closeViewModal()" class="text-3xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow"><div id="view-modal-content" class="worksheet-preview"></div></div>
            <div class="p-4 border-t text-right"><button onclick="closeViewModal()" class="bg-gray-500 text-white px-6 py-2 rounded">é—œé–‰</button></div>
        </div>
    </div>
	
	<div id="source-code-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
		<div class="bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 max-h-[90vh] flex flex-col">
			<div class="flex justify-between items-center p-4 border-b">
				<h3 class="text-xl font-bold text-gray-800">ğŸ“ åŸå§‹ç¢¼æª¢è¦–</h3>
				<button onclick="document.getElementById('source-code-modal').classList.add('hidden')" class="text-3xl text-gray-500 hover:text-gray-800">&times;</button>
			</div>
			<div class="p-6 overflow-y-auto flex-grow space-y-6">
				<div>
					<div class="flex justify-between items-center mb-2">
						<label class="block text-sm font-bold text-gray-700">HTML åŸå§‹ç¢¼</label>
						<button onclick="copyToClipboard('view-src-html', this)" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded transition flex items-center gap-1 border border-gray-300">
							ğŸ“‹ è¤‡è£½ HTML ä»£ç¢¼
						</button>
					</div>
					<textarea id="view-src-html" class="w-full border p-3 rounded h-48 font-mono text-xs bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500" readonly></textarea>
				</div>
				
				<div>
					<div class="flex justify-between items-center mb-2">
						<label class="block text-sm font-bold text-blue-600">ç­”æ¡ˆå·è³‡æ–™ (JSON)</label>
						<button onclick="copyToClipboard('view-src-json', this)" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded transition flex items-center gap-1 border border-blue-200">
							ğŸ“‹ è¤‡è£½ JSON è³‡æ–™
						</button>
					</div>
					<textarea id="view-src-json" class="w-full border p-3 rounded h-48 font-mono text-xs bg-blue-50 outline-none focus:ring-2 focus:ring-blue-500" readonly></textarea>
				</div>
			</div>
			<div class="p-4 border-t text-right bg-gray-50">
				<button onclick="document.getElementById('source-code-modal').classList.add('hidden')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded shadow transition">é—œé–‰è¦–çª—</button>
			</div>
		</div>
	</div>

    <div id="deadline-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-80 p-6">
            <h3 class="text-lg font-bold mb-4">ä¿®æ”¹æˆªæ­¢æ—¥æœŸ</h3>
            <p class="text-sm text-gray-500 mb-2">è«‹é¸æ“‡æ–°çš„æˆªæ­¢æ—¥ (ç•™ç©ºç‚ºç„¡æœŸé™)ï¼š</p>
            <input type="date" id="new-deadline-input" class="w-full border p-2 rounded mb-4 outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('deadline-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded text-sm hover:bg-gray-400">å–æ¶ˆ</button>
                <button id="save-deadline-btn" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="submission-list-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b bg-blue-50 rounded-t-lg">
                <div><h3 class="text-xl font-bold text-gray-800" id="submission-modal-title">ä½œæ¥­ç¹³äº¤æ¦‚æ³</h3><p class="text-sm text-gray-500" id="submission-modal-subtitle">...</p></div>
                <button onclick="document.getElementById('submission-list-modal').classList.add('hidden')" class="text-gray-500 text-3xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <table class="min-w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100 border-b">
                            <th class="p-3 font-bold text-gray-600">åº§è™Ÿ</th>
                            <th class="p-3 font-bold text-gray-600">å§“å</th>
                            <th class="p-3 font-bold text-gray-600">ç‹€æ…‹</th>
                            <th class="p-3 font-bold text-gray-600">åˆ†æ•¸</th>
                            <th class="p-3 font-bold text-gray-600">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="submission-list-body" class="text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="grading-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex overflow-hidden relative">
            <div id="grading-left-panel" class="w-2/3 bg-gray-50 border-r relative transition-all duration-300 flex flex-col">
                <div class="absolute top-0 left-0 w-full flex justify-between items-start z-20 pointer-events-none">
                    <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-br-lg text-sm font-bold shadow-md pointer-events-auto border-b border-r border-blue-200">å­¸ç”Ÿä½œç­”å·</div>
                    <button onclick="document.getElementById('grading-modal').classList.add('hidden')" 
                            class="bg-gray-800 text-white px-4 py-2 rounded-bl-lg hover:bg-gray-700 pointer-events-auto shadow-md hidden flex items-center gap-2 transition" 
                            id="view-mode-close-btn">
                        <span>âœ•</span> é—œé–‰æª¢è¦–
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 pt-14"><div id="grading-worksheet-content" class="worksheet-preview bg-white shadow-sm min-h-full"></div></div>
            </div>
            <div id="grading-right-panel" class="w-1/3 flex flex-col bg-white transition-all duration-300 border-l">
                <div class="p-4 border-b bg-gray-50 shadow-sm z-10"><h3 class="text-lg font-bold text-gray-800" id="grading-student-name">å­¸ç”Ÿå§“å</h3><p class="text-xs text-gray-500">è«‹é‡å°å·¦å´é¡Œç›®é€²è¡Œ O/X æ¨™ç¤º</p></div>
                <div class="p-6 flex-grow overflow-y-auto space-y-6">
                    <div><label class="block text-gray-700 font-bold mb-2 text-lg">ç¸½åˆ† (0-100)</label><input type="number" id="grade-score" class="w-full border-2 border-blue-200 p-3 rounded-lg text-2xl font-bold text-center focus:border-blue-500 outline-none" placeholder="0"></div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">ç¸½è©•èª / å»ºè­°</label>
                        <textarea id="grade-comment" class="w-full border p-3 rounded-lg h-32 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="å¯«é»é¼“å‹µæˆ–å»ºè­°..."></textarea>
                        <div class="flex gap-2 mt-2"><button onclick="insertComment('åšå¾—å¾ˆå¥½ï¼')" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">åšå¾—å¾ˆå¥½</button><button onclick="insertComment('è«‹æª¢æŸ¥éŒ¯å­—')" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">æª¢æŸ¥éŒ¯å­—</button></div>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50 space-y-2 z-10">
                    <button id="submit-grade-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow transition">âœ… é€å‡ºæˆç¸¾</button>
                    <div class="grid grid-cols-2 gap-2"><button id="return-correction-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition">â†©ï¸ é€€å›è¨‚æ­£</button><button onclick="document.getElementById('grading-modal').classList.add('hidden')" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition">å–æ¶ˆ</button></div>
                </div>
            </div>
        </div>
    </div>

    <script>
		// ğŸ› ï¸ [ä¿®æ”¹] è¼”åŠ©å‡½å¼ï¼šå¼·åˆ¶åŸ·è¡Œè…³æœ¬ä¸¦é‡æ–°æ¸²æŸ“æ•¸å­¸å…¬å¼
		function executeEmbeddedScripts(container) {
			const scripts = container.querySelectorAll('script');
			scripts.forEach(oldScript => {
				const newScript = document.createElement('script');
				Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
				newScript.appendChild(document.createTextNode(oldScript.innerHTML));
				oldScript.parentNode.replaceChild(newScript, oldScript);
			});
			if (window.MathJax) {
				MathJax.typesetPromise([container]).catch((err) => console.log('MathJax error:', err));
			}
		}

         // 1. Config
        const firebaseConfig = {
            apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
            authDomain: "classrecords-13902.firebaseapp.com",
            projectId: "classrecords-13902",
            storageBucket: "classrecords-13902.firebasestorage.app",
            messagingSenderId: "431747377367",
            appId: "1:431747377367:web:b157a485c59ce38091e892",
            measurementId: "G-JWTQGM9XMP"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let currentSchoolId = null;
        let availableClasses = [];
        let worksheetsCache = {}; // è¨˜æ†¶é«”å…§çš„å¿«å– (ç”¨æ–¼é è¦½ç­‰)
        
        let currentGradingResponseId = null;
        let currentGradingWorksheetId = null;

        // ğŸ”¥ [æ–°å¢] å¿«å– Key å‰ç¶´
        const CACHE_PREFIX = 'ws_sys_cache_';

        // 2. Auth Logic
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginMsg = document.getElementById('login-msg');
        const onboardingModal = document.getElementById('onboarding-modal');

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                loginMsg.textContent = 'é©—è­‰èº«åˆ†ä¸­...';
                currentUser = user;
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.schoolId) {
                            currentSchoolId = userData.schoolId;
                            const schoolDoc = await db.collection('schools').doc(currentSchoolId).get();
                            const schoolName = schoolDoc.exists ? (schoolDoc.data().name || currentSchoolId) : currentSchoolId;
                            
                            document.getElementById('header-school-name').textContent = schoolName;
                            document.getElementById('user-info').textContent = userData.displayName || user.displayName;
                            
                            loginView.classList.add('hidden');
                            appView.classList.remove('hidden');
                            
                            // åˆå§‹è¼‰å…¥ (å˜—è©¦ä½¿ç”¨ Local Cache)
                            loadGradingList(); 
                            loadWorksheets();
                            analyzeClasses();
                        } else {
                            startOnboarding(user);
                        }
                    } else {
                        startOnboarding(user);
                    }
                } catch (e) {
                    console.error(e);
                    loginMsg.textContent = "ç™»å…¥éŒ¯èª¤: " + e.message;
                }
            } else {
                loginView.classList.remove('hidden');
                appView.classList.add('hidden');
                onboardingModal.classList.add('hidden');
            }
        });

        async function startOnboarding(user) {
            loginMsg.textContent = 'æ­£åœ¨æœå°‹æ‚¨çš„å­¸æ ¡...';
            const googleName = user.displayName;
            document.getElementById('onboarding-name').textContent = googleName;
            try {
                const snapshot = await db.collectionGroup('teachers').where('name', '==', googleName).get();
                if (snapshot.empty) throw new Error(`åœ¨æ‰€æœ‰å­¸æ ¡åå†Šä¸­æ‰¾ä¸åˆ°å§“åã€Œ${googleName}ã€ã€‚`);
                const schoolList = document.getElementById('school-list');
                schoolList.innerHTML = '';
                const promises = snapshot.docs.map(async (doc) => {
                    const schoolDocRef = doc.ref.parent.parent;
                    const schoolId = schoolDocRef.id;
                    const schoolDoc = await schoolDocRef.get();
                    const schoolName = schoolDoc.exists ? schoolDoc.data().name : schoolId;
                    return { schoolId, schoolName, teacherData: doc.data() };
                });
                const results = await Promise.all(promises);
                results.forEach(match => {
                    const div = document.createElement('div');
                    div.className = "school-select-item border rounded p-3 flex justify-between items-center";
                    div.innerHTML = `<div><div class="font-bold text-gray-800">${match.schoolName}</div><div class="text-xs text-gray-500">ID: ${match.schoolId}</div></div><button class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700">é¸æ“‡æ­¤æ ¡</button>`;
                    div.querySelector('button').onclick = () => confirmBind(match);
                    schoolList.appendChild(div);
                });
                loginView.classList.add('hidden');
                onboardingModal.classList.remove('hidden');
            } catch (e) {
                console.error(e);
                loginMsg.textContent = e.message;
                if(e.code === 'failed-precondition') loginMsg.innerHTML += '<br><span class="text-xs text-gray-400">(ç³»çµ±æç¤º: éœ€è¦å»ºç«‹ teachers çš„ name ç´¢å¼•)</span>';
                setTimeout(() => auth.signOut(), 5000);
            }
        }

        async function confirmBind(match) {
            if (!confirm(`æ‚¨ç¢ºå®šè¦ç¶å®šèº«åˆ†å—ï¼Ÿ\n\nå§“åï¼š${currentUser.displayName}\nå­¸æ ¡ï¼š${match.schoolName}\n\nâš ï¸ ç¶å®šå¾Œç„¡æ³•è‡ªè¡Œä¿®æ”¹ï¼`)) return;
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    role: 'teacher', displayName: match.teacherData.name, email: currentUser.email,
                    schoolId: match.schoolId, uid: currentUser.uid, boundAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('ç¶å®šæˆåŠŸï¼'); window.location.reload();
            } catch (e) { alert('ç¶å®šå¤±æ•—: ' + e.message); }
        }

        document.getElementById('cancel-bind-btn').addEventListener('click', () => {
            auth.signOut();
            onboardingModal.classList.add('hidden');
            loginView.classList.remove('hidden');
        });

        // 3. Login/Logout & Force Refresh
        document.getElementById('login-btn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            auth.signInWithPopup(provider);
        });
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut().then(() => window.location.reload()));

        // ğŸ”¥ [æ–°å¢] æ‰‹å‹•å¼·åˆ¶åŒæ­¥æŒ‰éˆ•
        document.getElementById('force-refresh-btn').addEventListener('click', async () => {
            if(!confirm('ç¢ºå®šè¦å¾é›²ç«¯é‡æ–°ä¸‹è¼‰æœ€æ–°è³‡æ–™å—ï¼Ÿ')) return;
            const btn = document.getElementById('force-refresh-btn');
            btn.classList.add('animate-spin', 'text-blue-600'); // æ—‹è½‰å‹•ç•«
            
            try {
                await Promise.all([
                    loadWorksheets(true),
                    loadAssignmentsData(true), // å…ˆæŠ“è³‡æ–™
                    analyzeClasses(true)
                ]);
                // æ ¹æ“šç›®å‰åˆ†é é‡ç¹ª
                loadGradingList(); 
                loadAssignments();
                alert('âœ… è³‡æ–™åŒæ­¥å®Œæˆï¼');
            } catch(e) {
                alert('âŒ åŒæ­¥å¤±æ•—: ' + e.message);
            } finally {
                btn.classList.remove('animate-spin', 'text-blue-600');
            }
        });

        // ğŸ”¥ [æ–°å¢] é€šç”¨å¿«å–è®€å–å‡½å¼
        async function fetchDataWithCache(keySuffix, forceRefresh, fetcher) {
            const cacheKey = CACHE_PREFIX + keySuffix;
            let data = null;
			const cacheHead = keySuffix.split("_")[0];
			let cacheName = null;
			if (cacheHead=='ws')
				cacheName = 'å­¸ç¿’å–®';
			else if (cacheHead=='assign')
				cacheName = 'ä»»å‹™æŒ‡æ´¾';
			else
				cacheName = 'ç­ç´šå­¸ç”Ÿ';
            // 1. å˜—è©¦è®€å¿«å–
            if (!forceRefresh) {
                const cachedJson = localStorage.getItem(cacheKey);
                if (cachedJson) {
                    try {
                        data = JSON.parse(cachedJson);
                        console.log(`ğŸ“¦ [æœ¬åœ°å¿«å–] ${cacheName}... `);
                    } catch(e) {
                        console.warn('å¿«å–è§£æéŒ¯èª¤ï¼Œç§»é™¤å¿«å–:', e);
                        localStorage.removeItem(cacheKey);
                    }
                }
            }

            // 2. è‹¥ç„¡å¿«å–æˆ–å¼·åˆ¶æ›´æ–°ï¼Œå‰‡å¾é›²ç«¯è®€å–
            if (!data) {
                console.log(`â˜ï¸ [é›²ç«¯è¼‰å…¥] ${cacheName}...`);
                data = await fetcher();
                // å­˜å…¥å¿«å–
                localStorage.setItem(cacheKey, JSON.stringify(data));
            }
            return data;
        }

        // 4. Tab Logic
		// 4. Tab Logic (ä¿®å¾©ç‰ˆ)
        window.switchAppMenu = (tabName) => {
            // 1. éš±è—æ‰€æœ‰é¢æ¿
            document.querySelectorAll('.app-section-panel').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            // 2. é‡ç½®æ‰€æœ‰æŒ‰éˆ•æ¨£å¼ (è®Šå›ç°è‰²)
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
                btn.classList.add('text-gray-500');
            });

            // 3. é»äº®ç›®æ¨™æŒ‰éˆ• (è®Šè—è‰²)
            const targetBtn = document.getElementById(`btn-tab-${tabName}`);
            if (targetBtn) {
                targetBtn.classList.remove('text-gray-500');
                targetBtn.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
            }
            
            // 4. è¼‰å…¥å°æ‡‰è³‡æ–™
            if (tabName === 'grading') loadGradingList();
            if (tabName === 'withdraw') loadAssignments();
        };
		
        // 5. Library Logic
		document.getElementById('preview-btn').addEventListener('click', () => {
			document.getElementById('view-modal-content').innerHTML = '';
			document.getElementById('view-modal').classList.add('hidden'); 
			const previewDiv = document.getElementById('preview-content');
			const htmlContent = document.getElementById('ws-html').value;
			previewDiv.innerHTML = htmlContent;
			document.getElementById('preview-area').classList.remove('hidden');
			executeEmbeddedScripts(previewDiv);
		});

        document.getElementById('save-ws-btn').addEventListener('click', async () => {
            const title = document.getElementById('ws-title').value.trim();
            const html = document.getElementById('ws-html').value.trim();
            const jsonStr = document.getElementById('ws-json').value.trim();
            
            if(!title) return alert('è«‹è¼¸å…¥æ¨™é¡Œ');
            if(!html) return alert('è«‹è¼¸å…¥å…§å®¹(HTMLåŸå§‹ç¢¼)');
            
            let answerKey = null;
            if(jsonStr) {
                try { answerKey = JSON.parse(jsonStr); } catch(e) { return alert('ç­”æ¡ˆå· JSON æ ¼å¼éŒ¯èª¤: ' + e.message); }
            }

            try {
                const dupSnap = await db.collection('worksheets')
                    .where('creator_id', '==', currentUser.uid)
                    .where('title', '==', title)
                    .get();

                if (!dupSnap.empty) {
                    if (confirm(`å­¸ç¿’å–® "${title}" å·²å­˜åœ¨ï¼Œç¢ºå®šè¦†è“‹ï¼Ÿ`)) {
                        await db.collection('worksheets').doc(dupSnap.docs[0].id).update({
                            html_content: html, answer_key: answerKey,
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else return;
                } else {
                    await db.collection('worksheets').add({
                        title, html_content: html, answer_key: answerKey,
                        creator_id: currentUser.uid, created_at: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                alert('å·²å„²å­˜ï¼');
                document.getElementById('ws-title').value = ''; document.getElementById('ws-html').value = ''; document.getElementById('ws-json').value = ''; document.getElementById('preview-area').classList.add('hidden');
                
                // ğŸ”¥ [Cache] æ¸…é™¤å¿«å–ä¸¦å¼·åˆ¶é‡è¼‰
                localStorage.removeItem(CACHE_PREFIX + 'ws_' + currentUser.uid);
                loadWorksheets(true);

            } catch(e) { console.error(e); alert('æ“ä½œå¤±æ•—: ' + e.message); }
        });

        // ğŸ”¥ [ä¿®æ”¹] æ”¯æ´å¿«å–çš„å­¸ç¿’å–®è¼‰å…¥
		async function loadWorksheets(force = false) {
			const listEl = document.getElementById('ws-list');
			const selectEl = document.getElementById('assign-ws-select');
            
            // è®€å–è³‡æ–™
            const items = await fetchDataWithCache('ws_' + currentUser.uid, force, async () => {
                const snap = await db.collection('worksheets').where('creator_id', '==', currentUser.uid).orderBy('created_at', 'desc').get();
                const res = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    // è½‰æ›æ™‚é–“æˆ³è¨˜ä»¥ä¾¿ JSON å„²å­˜
                    res.push({
                        id: doc.id,
                        title: d.title,
                        html_content: d.html_content, // å¿«å–ä¹Ÿå­˜ HTML
                        answer_key: d.answer_key,
                        created_at_iso: d.created_at ? d.created_at.toDate().toISOString() : new Date().toISOString()
                    });
                });
                return res;
            });

			listEl.innerHTML = ''; selectEl.innerHTML = '<option value="">è«‹é¸æ“‡å­¸ç¿’å–®...</option>'; worksheetsCache = {};
			
            if (items.length === 0) { listEl.innerHTML = '<p class="text-center text-gray-500 py-4">ç„¡è³‡æ–™</p>'; return; }
			
            items.forEach(data => {
				worksheetsCache[data.id] = data; // å­˜å…¥è¨˜æ†¶é«”ä¾›é è¦½ç”¨
				
				const dateObj = new Date(data.created_at_iso);
				const dateStr = dateObj.toLocaleString('zh-TW', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

				const item = document.createElement('div');
				item.className = 'flex justify-between items-center p-4 border rounded bg-white shadow-sm';
				item.innerHTML = `
					<div>
						<div class="font-bold text-gray-700">ğŸ“„ ${data.title}</div>
						<div class="text-xs text-gray-400 mt-1">å»ºç«‹æ–¼ï¼š${dateStr}</div>
					</div>
					<div class="space-x-2">
						<button class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-sm font-bold hover:bg-yellow-200" onclick="renameWorksheet('${data.id}', '${data.title}')">âœï¸ æ”¹å</button>
						<button class="bg-purple-100 text-purple-600 px-3 py-1 rounded text-sm font-bold hover:bg-purple-200" onclick="viewSourceCode('${data.id}')">ğŸ“ åŸå§‹ç¢¼</button>
						<button class="bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm font-bold hover:bg-blue-200" onclick="viewWorksheet('${data.id}')">ğŸ‘ï¸ é è¦½</button>
						<button class="bg-red-100 text-red-500 px-3 py-1 rounded text-sm font-bold hover:bg-red-200" onclick="deleteWorksheet('${data.id}')">åˆªé™¤</button>
					</div>`;
				listEl.appendChild(item);
				const opt = document.createElement('option'); opt.value = data.id; opt.textContent = data.title; selectEl.appendChild(opt);
			});
		}

        window.renameWorksheet = async (id, oldTitle) => {
            const newTitle = prompt('è«‹è¼¸å…¥æ–°çš„æ¨™é¡Œï¼š', oldTitle);
            if (newTitle && newTitle.trim() !== '' && newTitle !== oldTitle) {
                try {
                    await db.collection('worksheets').doc(id).update({ title: newTitle.trim() });
                    // ğŸ”¥ [Cache] æ¸…é™¤å¿«å–ä¸¦é‡è¼‰
                    localStorage.removeItem(CACHE_PREFIX + 'ws_' + currentUser.uid);
                    loadWorksheets(true);
                } catch (e) { alert('æ›´æ–°å¤±æ•—: ' + e.message); }
            }
        };

		window.viewWorksheet = (id) => {
			document.getElementById('preview-content').innerHTML = '';
			document.getElementById('preview-area').classList.add('hidden');
			const data = worksheetsCache[id]; if(!data) return;
			document.getElementById('view-modal-title').textContent = data.title;
			const contentDiv = document.getElementById('view-modal-content');
			contentDiv.innerHTML = data.html_content;
			executeEmbeddedScripts(contentDiv);
			document.getElementById('view-modal').classList.remove('hidden');
		};
        window.closeViewModal = () => document.getElementById('view-modal').classList.add('hidden');
        
        window.deleteWorksheet = async (id) => {
            if(!confirm('âš ï¸ è­¦å‘Šï¼šåˆªé™¤é€™ä»½å­¸ç¿’å–®ï¼Œå°‡æœƒä¸€ä½µã€Œæ’¤å›ã€æ‰€æœ‰å·²æ´¾ç™¼çµ¦å­¸ç”Ÿçš„ä»»å‹™ï¼\n\nç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) return;
            const btn = event.target; const originalText = btn.textContent;
            btn.textContent = 'åˆªé™¤ä¸­...'; btn.disabled = true;
            try {
                const batch = db.batch();
                batch.delete(db.collection('worksheets').doc(id));
                const assignSnap = await db.collection('assignments').where('worksheet_id', '==', id).get();
                assignSnap.forEach(doc => { batch.delete(doc.ref); });
                await batch.commit();
                alert(`åˆªé™¤æˆåŠŸï¼`);
                
                // ğŸ”¥ [Cache] æ¸…é™¤å¤šå€‹å¿«å–
                localStorage.removeItem(CACHE_PREFIX + 'ws_' + currentUser.uid);
                localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
                
                loadWorksheets(true); 
                loadAssignmentsData(true).then(() => {
                    loadAssignments(); 
                    loadGradingList();
                });

            } catch(e) {
                console.error(e); alert('åˆªé™¤å¤±æ•—: ' + e.message);
                btn.textContent = originalText; btn.disabled = false;
            }
        };

        // 6. Assign Logic (Classes)
        // ğŸ”¥ [ä¿®æ”¹] æ”¯æ´å¿«å–çš„ç­ç´šè³‡æ–™è¼‰å…¥
        async function analyzeClasses(force = false) {
            const container = document.getElementById('class-checkboxes');
            
            const classes = await fetchDataWithCache('classes_' + currentSchoolId, force, async () => {
                const s = await db.collection('schools').doc(currentSchoolId).collection('students').get();
                const set = new Set();
                s.forEach(d => { if(d.data().class_id) set.add(d.data().class_id); });
                return Array.from(set).sort();
            });
            
            availableClasses = classes;
            if(classes.length === 0) { container.innerHTML = '<p class="text-red-500 col-span-full text-center">ç„¡å­¸ç”Ÿè³‡æ–™</p>'; return; }

            const groups = {};
            classes.forEach(cls => {
                const grade = cls.charAt(0);
                if (!groups[grade]) groups[grade] = [];
                groups[grade].push(cls);
            });

            container.innerHTML = '';
            container.className = "p-4 bg-gray-50 rounded border max-h-60 overflow-y-auto space-y-4"; 

            Object.keys(groups).sort().forEach(grade => {
                const clsList = groups[grade];
                const section = document.createElement('div');
                section.className = "border-b border-gray-200 pb-2 last:border-0";
                const header = document.createElement('div');
                header.className = "flex items-center mb-2";
                header.innerHTML = `<label class="flex items-center space-x-2 cursor-pointer select-none"><input type="checkbox" class="grade-master-checkbox form-checkbox h-4 w-4 text-blue-600 rounded border-gray-400" data-grade="${grade}" onchange="toggleGradeGroup(this)"><span class="font-bold text-gray-800 text-sm">${grade} å¹´ç´š (${clsList.length} ç­)</span></label>`;
                section.appendChild(header);
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-4 md:grid-cols-5 gap-2"; 
                clsList.forEach(cls => {
                    grid.innerHTML += `<label class="flex items-center space-x-1 cursor-pointer p-1 hover:bg-blue-100 rounded transition select-none"><input type="checkbox" name="target_class" value="${cls}" class="grade-${grade}-item form-checkbox h-4 w-4 text-blue-500 rounded border-gray-300"><span class="text-gray-700 text-sm font-medium">${cls}</span></label>`;
                });
                section.appendChild(grid);
                container.appendChild(section);
            });
        }
        window.toggleGradeGroup = (btn) => {
            document.querySelectorAll(`.grade-${btn.dataset.grade}-item`).forEach(cb => cb.checked = btn.checked);
        };

		// ğŸ”¥ [ä¿®æ”¹] ç™¼å¸ƒä»»å‹™é‚è¼¯ï¼šé˜²é‡è¤‡ + æˆåŠŸå¾Œæ¸…ç©ºè¡¨å–®ä¸¦è·³è½‰è‡³ä»»å‹™ç®¡ç†
        document.getElementById('submit-assign-btn').addEventListener('click', async () => {
            const selectEl = document.getElementById('assign-ws-select');
            const deadlineEl = document.getElementById('assign-deadline');
            
            const wid = selectEl.value;
            const dead = deadlineEl.value;
            // å–å¾—æ‰€æœ‰è¢«å‹¾é¸çš„ç­ç´š
            const cls = Array.from(document.querySelectorAll('input[name="target_class"]:checked')).map(c => c.value);
            
            if(!wid || cls.length === 0) return alert('è«‹é¸æ“‡å­¸ç¿’å–®èˆ‡ç­ç´š');
            
            const btn = document.getElementById('submit-assign-btn');
            const originalText = btn.textContent;
            btn.disabled = true; 
            btn.textContent = 'è™•ç†ä¸­...';

            const wtitle = document.querySelector(`#assign-ws-select option[value="${wid}"]`).textContent;

            try {
                // 1. æº–å‚™æŸ¥è©¢ï¼šæª¢æŸ¥æ¯å€‹ç­ç´šæ˜¯å¦å·²ç¶“æœ‰é€™ä»½ä½œæ¥­
                const checkPromises = cls.map(async (className) => {
                    const snapshot = await db.collection('assignments')
                        .where('worksheet_id', '==', wid)
                        .where('target_class', '==', className)
                        .where('school_id', '==', currentSchoolId)
                        .limit(1)
                        .get();
                    return { className, snapshot };
                });

                // 2. ç­‰å¾…æ‰€æœ‰æŸ¥è©¢å®Œæˆ
                const results = await Promise.all(checkPromises);

                const batch = db.batch();
                let updatedCount = 0;
                let createdCount = 0;

                // 3. æ ¹æ“šæŸ¥è©¢çµæœæ±ºå®šæ˜¯ã€Œæ–°å¢ã€é‚„æ˜¯ã€Œæ›´æ–°ã€
                results.forEach(({ className, snapshot }) => {
                    if (!snapshot.empty) {
                        // æ›´æ–°ç¾æœ‰ä»»å‹™ (ä¿ç•™å­¸ç”Ÿä½œç­”ç´€éŒ„)
                        const docRef = snapshot.docs[0].ref;
                        batch.update(docRef, {
                            deadline: dead,
                            worksheet_title: wtitle,
                            updated_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        updatedCount++;
                    } else {
                        // å»ºç«‹æ–°ä»»å‹™
                        const newRef = db.collection('assignments').doc();
                        batch.set(newRef, {
                            worksheet_id: wid, 
                            worksheet_title: wtitle, 
                            target_class: className,
                            teacher_id: currentUser.uid, 
                            school_id: currentSchoolId, 
                            deadline: dead,
                            status: 'published', 
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        createdCount++;
                    }
                });

                // 4. é€å‡ºæ‰¹æ¬¡è®Šæ›´
                await batch.commit(); 
                
                let msg = 'æ“ä½œæˆåŠŸï¼\n';
                if (createdCount > 0) msg += `âœ… æ–°ç™¼å¸ƒçµ¦ ${createdCount} å€‹ç­ç´š\n`;
                if (updatedCount > 0) msg += `ğŸ”„ æ›´æ–°äº† ${updatedCount} å€‹ç­ç´šçš„ä»»å‹™è¨­å®š`;
                alert(msg);

                // 5. è³‡æ–™æ›´æ–°èˆ‡å¿«å–æ¸…é™¤
                localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
                await loadAssignmentsData(true); // å¼·åˆ¶é‡è¼‰è³‡æ–™
                loadAssignments(); // æ¸²æŸ“ä»»å‹™åˆ—è¡¨
                loadGradingList();

                // ğŸ›‘ [æ–°å¢ UX å„ªåŒ–]ï¼šæ¸…ç©ºè¡¨å–®
                selectEl.value = ''; // æ¸…ç©ºå­¸ç¿’å–®é¸æ“‡
                deadlineEl.value = ''; // æ¸…ç©ºæ—¥æœŸ
                
                // æ¸…ç©ºæ‰€æœ‰ç­ç´šå‹¾é¸
                document.querySelectorAll('input[name="target_class"]').forEach(cb => cb.checked = false);
                // æ¸…ç©ºå¹´ç´šå…¨é¸æŒ‰éˆ•
                document.querySelectorAll('.grade-master-checkbox').forEach(cb => cb.checked = false);

                // ğŸ›‘ [æ–°å¢ UX å„ªåŒ–]ï¼šè·³è½‰è‡³ã€Œä»»å‹™ç®¡ç†ã€é é¢æª¢è¦–çµæœ
                switchAppMenu('withdraw'); 

            } catch(e) { 
                console.error(e);
                alert('ç™¼å¸ƒå¤±æ•—: ' + e.message); 
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
		
        // 7. Withdraw & Grading Data (Shared Fetcher)
        // ğŸ”¥ [æ–°å¢] å…±äº«çš„ Assignment è³‡æ–™æŠ“å–å‡½å¼ (å¿«å–ç‰ˆ)
        async function loadAssignments() {
            const tb = document.getElementById('assignment-table-body');
            const items = await loadAssignmentsData(); // è®€å–è³‡æ–™ (æ”¯æ´å¿«å–)
            
            tb.innerHTML = '';
            if(items.length === 0) { tb.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-500">ç„¡ç´€éŒ„</td></tr>'; return; }
            
            // 1. åˆ†çµ„ï¼šä¾æ“šå­¸ç¿’å–®æ¨™é¡Œåˆ†çµ„
            const g = {};
            items.forEach(i => {
                if(!g[i.title]) g[i.title] = [];
                g[i.title].push(i);
            });

            Object.keys(g).forEach(t => {
                const list = g[t];
                
                // 2. è¨ˆç®—è©²çµ„ä¸­ã€Œæœ€æ–°çš„ã€ç™¼å¸ƒæ™‚é–“
                let lastPubStr = 'æœªçŸ¥';
                if (list.length > 0) {
                    // å–å‡ºæ‰€æœ‰æ™‚é–“å­—ä¸²ï¼Œæ’åºå¾ŒæŠ“æœ€å¾Œä¸€å€‹ (æœ€å¤§çš„æ—¥æœŸ)
                    const dates = list.map(i => i.created_at_iso).filter(d => d).sort();
                    if (dates.length > 0) {
                        const lastIso = dates[dates.length - 1];
                        const dateObj = new Date(lastIso);
                        // æ ¼å¼åŒ–ç‚ºï¼š2023/12/03 14:05
                        lastPubStr = dateObj.toLocaleString('zh-TW', { 
                            hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' 
                        });
                    }
                }

                // 3. æ’åºç­ç´šé¡¯ç¤ºé †åº
                list.sort((a,b) => a.target_class.localeCompare(b.target_class));
                
                const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-gray-50';
                const tdTitle = document.createElement('td'); tdTitle.className = "p-3 align-top";
                
                // ğŸ”¥ [ä¿®æ”¹é»] åœ¨æ¨™é¡Œä¸‹æ–¹åŠ å…¥æ—¥æœŸé¡¯ç¤º
                tdTitle.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <span class="font-bold text-gray-800 text-lg">${t}</span>
                        <span class="text-xs text-gray-500 font-mono tracking-wide">ğŸ•’ æœ€å¾Œç™¼å¸ƒï¼š${lastPubStr}</span>
                        <label class="inline-flex items-center text-xs text-gray-400 cursor-pointer select-none hover:text-blue-600 transition w-fit mt-1">
                            <input type="checkbox" class="form-checkbox h-3 w-3 text-blue-500 mr-1 rounded border-gray-300" onchange="toggleGroup(this)">
                            å…¨é¸ / å…¨å–æ¶ˆ
                        </label>
                    </div>`;
                
                const tdClasses = document.createElement('td'); tdClasses.className = "p-3 align-top";
                let clsHtml = '';
                list.forEach(i => {
                    const deadInfo = i.deadline ? `<span class="text-red-500 ml-1 font-bold">æœŸé™:${i.deadline.slice(5)}</span>` : '<span class="text-green-500 ml-1">ç„¡æœŸé™</span>';
                    clsHtml += `<label class="inline-flex items-center mr-3 mb-2 bg-white px-3 py-1.5 rounded border border-gray-200 shadow-sm hover:bg-blue-50 hover:border-blue-200 cursor-pointer select-none transition"><input type="checkbox" class="withdraw-checkbox form-checkbox h-4 w-4 text-red-500 mr-2 rounded border-gray-300 focus:ring-red-500" value="${i.id}"><span class="font-bold text-gray-700">${i.target_class} ç­</span><span class="text-xs text-gray-500 ml-1">(${deadInfo})</span></label>`;
                });
                tdClasses.innerHTML = clsHtml;
                tr.appendChild(tdTitle); tr.appendChild(tdClasses); tb.appendChild(tr);
            });
        }

		// -------------------------------------------------------------------------
        // 7. å…±ç”¨è³‡æ–™å±¤ï¼šè®€å–ä»»å‹™è³‡æ–™ (å«å¿«å–æ©Ÿåˆ¶)
        // -------------------------------------------------------------------------
        
        // ğŸ”¥ [è£œå›éºå¤±çš„å‡½å¼] é€™æ˜¯æ ¸å¿ƒè³‡æ–™è®€å–å‡½å¼ï¼Œå¿…é ˆå­˜åœ¨ï¼
        async function loadAssignmentsData(force = false) {
            // ä½¿ç”¨å‰é¢å®šç¾©çš„ fetchDataWithCache
            return await fetchDataWithCache('assign_' + currentUser.uid, force, async () => {
                const s = await db.collection('assignments')
                    .where('teacher_id', '==', currentUser.uid)
                    .orderBy('created_at', 'desc')
                    .get();
                
                const res = [];
                s.forEach(d => {
                    const data = d.data();
                    res.push({
                        id: d.id,
                        worksheet_id: data.worksheet_id,
                        title: data.worksheet_title || 'æœªå‘½å',
                        target_class: data.target_class,
                        deadline: data.deadline,
                        created_at_iso: data.created_at ? data.created_at.toDate().toISOString() : null
                    });
                });
                return res;
            });
        }

        // -------------------------------------------------------------------------
        // ä»»å‹™ç®¡ç†åˆ—è¡¨ (å«æœ€å¾Œç™¼å¸ƒæ™‚é–“é¡¯ç¤º)
        // -------------------------------------------------------------------------
        async function loadAssignments() {
            const tb = document.getElementById('assignment-table-body');
            
            // å‘¼å«ä¸Šé¢çš„å…±ç”¨å‡½å¼
            const items = await loadAssignmentsData(); 
            
            tb.innerHTML = '';
            if(items.length === 0) { tb.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-500">ç„¡ç´€éŒ„</td></tr>'; return; }
            
            // 1. åˆ†çµ„ï¼šä¾æ“šå­¸ç¿’å–®æ¨™é¡Œåˆ†çµ„
            const g = {};
            items.forEach(i => {
                if(!g[i.title]) g[i.title] = [];
                g[i.title].push(i);
            });

            Object.keys(g).forEach(t => {
                const list = g[t];
                
                // 2. è¨ˆç®—è©²çµ„ä¸­ã€Œæœ€æ–°çš„ã€ç™¼å¸ƒæ™‚é–“
                let lastPubStr = 'æœªçŸ¥';
                if (list.length > 0) {
                    // å–å‡ºæ‰€æœ‰æ™‚é–“å­—ä¸²ï¼Œæ’åºå¾ŒæŠ“æœ€å¾Œä¸€å€‹ (æœ€å¤§çš„æ—¥æœŸ)
                    const dates = list.map(i => i.created_at_iso).filter(d => d).sort();
                    if (dates.length > 0) {
                        const lastIso = dates[dates.length - 1];
                        const dateObj = new Date(lastIso);
                        // æ ¼å¼åŒ–ç‚ºï¼š2023/12/03 14:05
                        lastPubStr = dateObj.toLocaleString('zh-TW', { 
                            hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' 
                        });
                    }
                }

                // 3. æ’åºç­ç´šé¡¯ç¤ºé †åº
                list.sort((a,b) => a.target_class.localeCompare(b.target_class));
                
                const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-gray-50';
                const tdTitle = document.createElement('td'); tdTitle.className = "p-3 align-top";
                
                // é¡¯ç¤ºæ¨™é¡Œèˆ‡æ™‚é–“
                tdTitle.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <span class="font-bold text-gray-800 text-lg">${t}</span>
                        <span class="text-xs text-gray-500 font-mono tracking-wide">ğŸ•’ æœ€å¾Œç™¼å¸ƒï¼š${lastPubStr}</span>
                        <label class="inline-flex items-center text-xs text-gray-400 cursor-pointer select-none hover:text-blue-600 transition w-fit mt-1">
                            <input type="checkbox" class="form-checkbox h-3 w-3 text-blue-500 mr-1 rounded border-gray-300" onchange="toggleGroup(this)">
                            å…¨é¸ / å…¨å–æ¶ˆ
                        </label>
                    </div>`;
                
                const tdClasses = document.createElement('td'); tdClasses.className = "p-3 align-top";
                let clsHtml = '';
                list.forEach(i => {
                    const deadInfo = i.deadline ? `<span class="text-red-500 ml-1 font-bold">æœŸé™:${i.deadline.slice(5)}</span>` : '<span class="text-green-500 ml-1">ç„¡æœŸé™</span>';
                    clsHtml += `<label class="inline-flex items-center mr-3 mb-2 bg-white px-3 py-1.5 rounded border border-gray-200 shadow-sm hover:bg-blue-50 hover:border-blue-200 cursor-pointer select-none transition"><input type="checkbox" class="withdraw-checkbox form-checkbox h-4 w-4 text-red-500 mr-2 rounded border-gray-300 focus:ring-red-500" value="${i.id}"><span class="font-bold text-gray-700">${i.target_class} ç­</span><span class="text-xs text-gray-500 ml-1">(${deadInfo})</span></label>`;
                });
                tdClasses.innerHTML = clsHtml;
                tr.appendChild(tdTitle); tr.appendChild(tdClasses); tb.appendChild(tr);
            });
        }
        
        // -------------------------------------------------------------------------
        // 8. æ‰¹æ”¹åˆ—è¡¨ (ä¹Ÿä½¿ç”¨å…±ç”¨å‡½å¼)
        // -------------------------------------------------------------------------
        async function loadGradingList() {
            const tb = document.getElementById('grading-list-body');
            
            // å‘¼å«å…±ç”¨å‡½å¼ï¼Œç¢ºä¿ä¸æœƒå ±éŒ¯
            const items = await loadAssignmentsData(); 
            
            tb.innerHTML = '';
            if(items.length === 0) { tb.innerHTML = '<tr><td colspan="2" class="p-8 text-center text-gray-500">ç›®å‰ç„¡ç™¼å¸ƒä½œæ¥­</td></tr>'; return; }
            
            const g = {};
            items.forEach(i => {
                if(!g[i.title]) g[i.title] = [];
                g[i.title].push(i);
            });

            Object.keys(g).forEach(t => {
                const list = g[t].sort((a,b) => a.target_class.localeCompare(b.target_class));
                const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-blue-50';
                let clsBtns = '';
                list.forEach(i => {
                    clsBtns += `<button onclick="openSubmissionList('${i.id}', '${i.target_class}', '${i.worksheet_id}', '${i.title}')" class="m-1 bg-white hover:bg-blue-600 hover:text-white text-blue-700 border border-blue-200 px-4 py-2 rounded shadow-sm font-bold transition flex items-center gap-2"><span>ğŸ« ${i.target_class} ç­</span><span class="text-xs opacity-70">â” æ‰¹æ”¹</span></button>`;
                });
                tr.innerHTML = `<td class="p-4 font-bold text-gray-800 text-lg align-middle">${t}</td><td class="p-4 align-middle flex flex-wrap">${clsBtns}</td>`;
                tb.appendChild(tr);
            });
        }

        window.toggleGroup = (master) => {
            master.closest('tr').querySelectorAll('.withdraw-checkbox').forEach(cb => cb.checked = master.checked);
        };
        
        document.getElementById('batch-withdraw-btn').addEventListener('click', async () => {
            const chk = document.querySelectorAll('.withdraw-checkbox:checked');
            if(chk.length === 0 || !confirm('ç¢ºå®šæ’¤å›ï¼Ÿ')) return;
            const b = db.batch(); chk.forEach(c => b.delete(db.collection('assignments').doc(c.value)));
            try { 
                await b.commit(); 
                alert('å·²æ’¤å›'); 
                
                // ğŸ”¥ [Cache] æ¸…é™¤å¿«å–
                localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
                await loadAssignmentsData(true);
                loadAssignments(); 
                loadGradingList();
            } catch(e) { alert(e.message); }
        });
        
        document.getElementById('batch-deadline-btn').addEventListener('click', () => {
            if(document.querySelectorAll('.withdraw-checkbox:checked').length === 0) return alert('è«‹å…ˆå‹¾é¸');
            document.getElementById('new-deadline-input').value = '';
            document.getElementById('deadline-modal').classList.remove('hidden');
        });
        document.getElementById('save-deadline-btn').addEventListener('click', async () => {
            const newDate = document.getElementById('new-deadline-input').value;
            const chk = document.querySelectorAll('.withdraw-checkbox:checked');
            const b = db.batch(); chk.forEach(c => b.update(db.collection('assignments').doc(c.value), { deadline: newDate || null }));
            try { 
                await b.commit(); alert('æ›´æ–°æˆåŠŸ'); document.getElementById('deadline-modal').classList.add('hidden'); 
                
                // ğŸ”¥ [Cache] æ¸…é™¤å¿«å–
                localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
                await loadAssignmentsData(true);
                loadAssignments(); 
            } catch(e) { alert(e.message); }
        });

        // 8. Grading List (Uses Shared Fetcher)
        async function loadGradingList() {
            const tb = document.getElementById('grading-list-body');
            const items = await loadAssignmentsData(); // è®€å¿«å–
            
            tb.innerHTML = '';
            if(items.length === 0) { tb.innerHTML = '<tr><td colspan="2" class="p-8 text-center text-gray-500">ç›®å‰ç„¡ç™¼å¸ƒä½œæ¥­</td></tr>'; return; }
            
            const g = {};
            items.forEach(i => {
                if(!g[i.title]) g[i.title] = [];
                g[i.title].push(i);
            });

            Object.keys(g).forEach(t => {
                const list = g[t].sort((a,b) => a.target_class.localeCompare(b.target_class));
                const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-blue-50';
                let clsBtns = '';
                list.forEach(i => {
                    clsBtns += `<button onclick="openSubmissionList('${i.id}', '${i.target_class}', '${i.worksheet_id}', '${i.title}')" class="m-1 bg-white hover:bg-blue-600 hover:text-white text-blue-700 border border-blue-200 px-4 py-2 rounded shadow-sm font-bold transition flex items-center gap-2"><span>ğŸ« ${i.target_class} ç­</span><span class="text-xs opacity-70">â” æ‰¹æ”¹</span></button>`;
                });
                tr.innerHTML = `<td class="p-4 font-bold text-gray-800 text-lg align-middle">${t}</td><td class="p-4 align-middle flex flex-wrap">${clsBtns}</td>`;
                tb.appendChild(tr);
            });
        }

        window.openSubmissionList = async (aid, cls, wid, title) => {
            const modal = document.getElementById('submission-list-modal');
            const tb = document.getElementById('submission-list-body');
            document.getElementById('submission-modal-title').textContent = title;
            document.getElementById('submission-modal-subtitle').textContent = `ç­ç´šï¼š${cls} ç­`;
            tb.innerHTML = '<tr><td colspan="5" class="p-4 text-center">è¼‰å…¥ä¸­...</td></tr>';
            modal.classList.remove('hidden');
            const snap = await db.collection('responses').where('assignment_id', '==', aid).orderBy('student_no').get();
            tb.innerHTML = '';
            if(snap.empty) { tb.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">å°šç„¡ç¹³äº¤</td></tr>'; return; }
            snap.forEach(doc => {
                const d = doc.data();
                let st = '';
                if(d.status==='submitted') st='<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">å·²ç¹³äº¤</span>';
                else if(d.status==='graded') st='<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded font-bold">å·²æ‰¹æ”¹</span>';
                else st='<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded font-bold">è¨‚æ­£ä¸­</span>';
                const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `<td class="p-3">${d.student_no||'?'}</td><td class="p-3 font-bold">${d.student_name}</td><td class="p-3">${st}</td><td class="p-3 font-mono font-bold text-blue-600">${d.score!==undefined?d.score:'-'}</td><td class="p-3 flex gap-2"><button onclick="openGradingModal('${doc.id}', '${wid}', '${d.student_name}', 'view')" class="bg-gray-100 text-gray-600 px-3 py-1 rounded text-sm hover:bg-gray-200 border border-gray-300 font-bold">ğŸ‘ï¸ æª¢è¦–</button><button onclick="openGradingModal('${doc.id}', '${wid}', '${d.student_name}', 'edit')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 font-bold shadow-sm">æ‰¹æ”¹</button></td>`;
                tb.appendChild(tr);
            });
        };

		window.openGradingModal = async (rid, wid, sname, mode = 'edit') => {
            currentGradingResponseId = rid; currentGradingWorksheetId = wid;
            const modal = document.getElementById('grading-modal');
            const view = document.getElementById('grading-worksheet-content');
            const scoreIn = document.getElementById('grade-score');
            const commIn = document.getElementById('grade-comment');
            
            const leftPanel = document.getElementById('grading-left-panel');
            const rightPanel = document.getElementById('grading-right-panel');
            const viewCloseBtn = document.getElementById('view-mode-close-btn');

            document.getElementById('preview-content').innerHTML = ''; 
            document.getElementById('view-modal-content').innerHTML = ''; 

            document.getElementById('grading-student-name').textContent = sname;
            view.innerHTML = '<p class="p-4 text-center">è¼‰å…¥ä¸­...</p>';
            scoreIn.value = ''; commIn.value = '';
            modal.classList.remove('hidden');

            if (mode === 'view') {
                leftPanel.classList.remove('w-2/3'); leftPanel.classList.add('w-full');
                rightPanel.classList.add('hidden'); viewCloseBtn.classList.remove('hidden');
            } else {
                leftPanel.classList.remove('w-full'); leftPanel.classList.add('w-2/3');
                rightPanel.classList.remove('hidden'); viewCloseBtn.classList.add('hidden');
            }

            try {
                const [r, w] = await Promise.all([db.collection('responses').doc(rid).get(), db.collection('worksheets').doc(wid).get()]);
                const rd = r.data(); const wd = w.data();
                
                view.innerHTML = wd.html_content;
                executeEmbeddedScripts(view);
                
                const ans = rd.answers || {}; 
                const details = rd.grading_details || {};
                
                let currentAutoScore = 0;
                let hasManualScore = (rd.score !== undefined && rd.score !== null);
                
                const calculatedQuestions = new Set(); 

                if(rd.comment) commIn.value = rd.comment;

                view.querySelectorAll('.worksheet-input').forEach(inp => {
                    const n = inp.name; if(!n) return;
                    
                    if(ans[n] !== undefined) {
                        if(inp.type === 'radio' || inp.type === 'checkbox') { if(inp.value === ans[n]) inp.checked = true; }
                        else inp.value = ans[n];
                    }
                    inp.disabled = true;

                    if (mode === 'edit') {
                        let isCor = null, isInc = null, fb = '';
                        let points = 0; 

                        if (wd.answer_key && wd.answer_key[n]) {
                            const key = wd.answer_key[n];
                            points = parseInt(key.points) || 0; 
                            if(key.note) fb = key.note;
                            
                            const stdAns = ans[n];
                            if (key.answer !== null && key.answer !== undefined && stdAns !== undefined) {
                                if (String(stdAns).trim() === String(key.answer).trim()) {
                                    isCor = true;
                                    if (!calculatedQuestions.has(n)) {
                                        currentAutoScore += points;
                                        calculatedQuestions.add(n);
                                    }
                                } else {
                                    isInc = true;
                                }
                            }
                        }

                        if (details[n]) {
                            isCor = details[n].is_correct === true;
                            isInc = details[n].is_correct === false;
                            fb = details[n].feedback || fb;
                        }

                        if (inp.type === 'radio') {
                            const all = view.querySelectorAll(`input[type="radio"][name="${n}"]`);
                            if (inp !== all[all.length - 1]) return;
                        }
                        
                        const panel = document.createElement('div');
                        panel.className = `grading-panel ${isCor?'correct':(isInc?'incorrect':'')}`;
                        if (inp.type === 'radio') panel.style.marginTop = "15px";

                        const currentStatus = isCor ? 'c' : (isInc ? 'i' : '');
                        panel.setAttribute('data-status', currentStatus);

                        const pointsBadge = points > 0 ? `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded ml-2">é…åˆ†: ${points}</span>` : '';

                        panel.innerHTML = `
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex gap-2 items-center">
                                    <label class="grading-radio-label">
                                        <input type="radio" name="gs_${n}" value="c" data-points="${points}" ${isCor?'checked':''} onchange="updPanel(this)">
                                        <span class="ml-1 btn-text-correct">â­• æ­£ç¢º</span>
                                    </label>
                                    <label class="grading-radio-label">
                                        <input type="radio" name="gs_${n}" value="i" data-points="${points}" ${isInc?'checked':''} onchange="updPanel(this)">
                                        <span class="ml-1 btn-text-incorrect">âŒ éŒ¯èª¤</span>
                                    </label>
                                    ${pointsBadge}
                                </div>
                                <button class="text-xs text-gray-400" onclick="clsGrade('${n}', this)">æ¸…é™¤</button>
                            </div>
                            <input type="text" class="grading-feedback-input w-full border border-gray-300 rounded p-1 text-sm outline-none" placeholder="å€‹åˆ¥è©•èª..." value="${fb}" data-field="${n}">
                        `;
                        
                        if (inp.type === 'radio') {
                            panel.style.gridColumn = "1 / -1"; panel.style.width = "100%";
                            const c = inp.parentNode;
                            if(c.nextSibling) c.parentNode.insertBefore(panel, c.nextSibling); else c.parentNode.appendChild(panel);
                        } else {
                            if(inp.nextSibling) inp.parentNode.insertBefore(panel, inp.nextSibling); else inp.parentNode.appendChild(panel);
                        }
                    }
                });
 
                if (mode === 'edit') {
                    if (hasManualScore) {
                        scoreIn.value = rd.score;
                    } else {
                        scoreIn.value = currentAutoScore;
                    }
                } else {
                    scoreIn.value = rd.score !== undefined ? rd.score : '';
                }

            } catch(e) { console.error(e); alert(e.message); modal.classList.add('hidden'); }
        };

        window.updPanel = (r) => { 
            const p = r.closest('.grading-panel'); 
            const oldStatus = p.getAttribute('data-status') || ''; 
            const newStatus = r.value; 
            const points = parseInt(r.getAttribute('data-points')) || 0; 
            
            p.classList.remove('correct', 'incorrect'); 
            if(newStatus==='c') p.classList.add('correct'); 
            if(newStatus==='i') p.classList.add('incorrect'); 
            
            if (oldStatus === newStatus) return; 

            const scoreInput = document.getElementById('grade-score');
            let currentTotal = parseInt(scoreInput.value) || 0;
            
            if (newStatus === 'c' && oldStatus !== 'c') {
                currentTotal += points;
            } else if (oldStatus === 'c' && newStatus !== 'c') {
                currentTotal -= points;
            }

            scoreInput.value = currentTotal;
            p.setAttribute('data-status', newStatus); 
        };
		
        window.clsGrade = (n, btn) => { 
            const p = btn.closest('.grading-panel'); 
            const oldStatus = p.getAttribute('data-status') || '';
            
            const cRadio = p.querySelector('input[value="c"]');
            const points = cRadio ? (parseInt(cRadio.getAttribute('data-points')) || 0) : 0;

            if (oldStatus === 'c') {
                const scoreInput = document.getElementById('grade-score');
                let currentTotal = parseInt(scoreInput.value) || 0;
                currentTotal -= points;
                scoreInput.value = currentTotal;
            }

            p.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false); 
            p.classList.remove('correct', 'incorrect'); 
            p.setAttribute('data-status', ''); 
        };
		
        window.insertComment = (t) => { const el = document.getElementById('grade-comment'); el.value = el.value ? el.value+'ï¼Œ'+t : t; };

        const doGrade = async (status) => {
            const s = parseFloat(document.getElementById('grade-score').value);
            const c = document.getElementById('grade-comment').value;
            if(status==='graded' && isNaN(s)) return alert('è«‹æ‰“åˆ†');
            const btn = document.getElementById(status==='graded'?'submit-grade-btn':'return-correction-btn');
            btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­...';
            const gd = {};
            document.querySelectorAll('.grading-feedback-input').forEach(inp => {
                const n = inp.dataset.field; const p = inp.closest('.grading-panel');
                const isC = p.querySelector('input[value="c"]').checked; const isI = p.querySelector('input[value="i"]').checked;
                let finalC = null; if(isC) finalC = true; else if(isI) finalC = false;
                if(finalC !== null || inp.value.trim()!=='') gd[n] = { is_correct: finalC, feedback: inp.value.trim() };
            });
            try {
                await db.collection('responses').doc(currentGradingResponseId).update({
                    score: isNaN(s)?0:s, comment: c, grading_details: gd, status: status,
                    graded_at: firebase.firestore.FieldValue.serverTimestamp(), graded_by: currentUser.uid
                });
                alert('å®Œæˆï¼');
                document.getElementById('grading-modal').classList.add('hidden');
                document.getElementById('submission-list-modal').classList.add('hidden'); 
                loadGradingList(); 
            } catch(e) { alert(e.message); } 
            finally { btn.disabled=false; btn.textContent=status==='graded'?'âœ… é€å‡ºæˆç¸¾':'â†©ï¸ é€€å›è¨‚æ­£'; }
        };
        document.getElementById('submit-grade-btn').onclick = () => doGrade('graded');
        document.getElementById('return-correction-btn').onclick = () => doGrade('needs_correction');
		
		window.viewSourceCode = (id) => {
			const data = worksheetsCache[id];
			if (!data) return;
			document.getElementById('view-src-html').value = data.html_content || '';
			const jsonStr = data.answer_key ? JSON.stringify(data.answer_key, null, 4) : '{}';
			document.getElementById('view-src-json').value = jsonStr;
			document.getElementById('source-code-modal').classList.remove('hidden');
		};

		window.copyToClipboard = (elementId, btn) => {
			const el = document.getElementById(elementId);
			if (!el) return;
			el.select();
			el.setSelectionRange(0, 99999); 
			navigator.clipboard.writeText(el.value).then(() => {
				const originalContent = btn.innerHTML;
				btn.textContent = 'âœ… å·²è¤‡è£½ï¼';
				setTimeout(() => {
					btn.innerHTML = originalContent;
				}, 1500);
			}).catch(err => {
				console.error('è¤‡è£½å¤±æ•—', err);
				alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚');
			});
		};
    </script>
</body>
</html>
