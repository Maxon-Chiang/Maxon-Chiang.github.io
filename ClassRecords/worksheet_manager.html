<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’å–®ç®¡ç†ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
	  window.MathJax = {
		tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
	  };
	</script>
	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; }
        
        /* å­¸ç¿’å–®é è¦½å€å¡Š */
        .worksheet-preview { 
            border: 2px dashed #ccc; padding: 20px; background: #fff; 
            border-radius: 8px; min-height: 100px; 
        }
        .worksheet-input {
            border: 1px solid #ccc; padding: 4px 8px; border-radius: 4px; 
            margin: 0 5px; background-color: #fff;
        }

        /* æ‰¹æ”¹é¢æ¿æ¨£å¼ */
        .grading-panel {
            background-color: #f8fafc; border: 1px solid #e2e8f0; border-left: 4px solid #94a3b8;
            padding: 10px; margin-bottom: 20px; border-radius: 0 4px 4px 0;
            margin-top: 5px; position: relative; z-index: 10;
        }
        .grading-panel.correct { border-left-color: #22c55e; background-color: #f0fdf4; }
        .grading-panel.incorrect { border-left-color: #ef4444; background-color: #fef2f2; }
        
        .grading-radio-label {
            cursor: pointer; padding: 4px 8px; border-radius: 4px; margin-right: 10px;
            font-size: 0.9em; font-weight: bold; display: inline-flex; align-items: center;
            border: 1px solid transparent; transition: all 0.2s;
        }
        .grading-radio-label:hover { background-color: #e2e8f0; }
        
        input[type="radio"]:checked + span.btn-text-correct { color: #166534; }
        input[type="radio"]:checked + span.btn-text-incorrect { color: #991b1b; }

        /* å­¸æ ¡é¸æ“‡æ¸…å–® */
        .school-select-item { cursor: pointer; transition: all 0.2s; }
        .school-select-item:hover { background-color: #eff6ff; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-view" class="flex flex-col items-center justify-center h-screen">
        <div class="bg-white p-8 rounded shadow-lg text-center w-96">
            <h1 class="text-2xl font-bold mb-4">å­¸ç¿’å–®ç®¡ç†ç³»çµ±</h1>
            <p class="mb-6 text-gray-600">è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
            <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded w-full flex justify-center items-center gap-2">
                Google ç™»å…¥
            </button>
            <p id="login-msg" class="mt-4 text-sm text-red-500 font-bold"></p>
        </div>
    </div>

    <div id="onboarding-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ğŸ« è«‹ç¢ºèªæ‚¨çš„ä»»è·å­¸æ ¡</h2>
            <p class="text-sm text-gray-600 mb-4">ç³»çµ±åµæ¸¬åˆ°æ‚¨çš„å§“å <strong><span id="onboarding-name" class="text-blue-600"></span></strong> å­˜åœ¨æ–¼ä»¥ä¸‹å­¸æ ¡åå†Šä¸­ã€‚<br>è«‹é¸æ“‡æ­£ç¢ºçš„å­¸æ ¡é€²è¡Œå¸³è™Ÿç¶å®šï¼š</p>
            <div id="school-list" class="space-y-2 max-h-60 overflow-y-auto mb-4"></div>
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                <p class="text-xs text-yellow-700"><strong>âš ï¸ é‡è¦è­¦å‘Šï¼š</strong><br>æ­¤è¨­å®šç‚º<strong>æ°¸ä¹…ç¶å®š</strong>ï¼Œä¸€æ—¦ç¢ºèªå¾Œç„¡æ³•è‡ªè¡Œä¿®æ”¹ã€‚</p>
            </div>
            <button id="cancel-bind-btn" class="w-full text-gray-500 text-sm hover:underline">é€™ä¸æ˜¯æˆ‘ï¼Œç™»å‡ºä¸¦è¿”å›</button>
        </div>
    </div>

    <div id="app-view" class="container mx-auto p-4 hidden">
        <header class="flex justify-between items-center bg-white p-4 rounded shadow mb-6">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">ğŸ“š ä½œæ¥­ç®¡ç†ä¸­å¿ƒ</h1>
                    <p class="text-sm text-gray-500">
                        <span id="header-school-name" class="font-bold text-blue-600">è¼‰å…¥ä¸­...</span> | 
                        <span id="user-info">è¼‰å…¥ä¸­...</span>
                    </p>
                </div>
                <button id="force-refresh-btn" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition" title="æ‰‹å‹•å¾é›²ç«¯è¼‰å…¥æœ€æ–°è³‡æ–™">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </button>
            </div>
            <button id="logout-btn" class="text-sm text-gray-600 hover:text-red-500 font-bold border border-gray-300 px-3 py-1 rounded">ç™»å‡º</button>
        </header>

        <div class="flex mb-4 border-b border-gray-300 overflow-x-auto">
            <button id="btn-tab-grading" class="tab-btn px-6 py-3 text-blue-600 border-b-2 border-blue-600 font-bold hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('grading')">ğŸ“ æ‰¹æ”¹ä½œæ¥­</button>
            <button id="btn-tab-library" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('library')">ğŸ“‚ å­¸ç¿’å–®ç®¡ç†</button>
            <button id="btn-tab-assign" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('assign')">ğŸš€ ç™¼å¸ƒä»»å‹™</button>
            <button id="btn-tab-withdraw" class="tab-btn px-6 py-3 text-gray-500 hover:text-blue-600 hover:bg-gray-50 transition whitespace-nowrap" onclick="switchAppMenu('withdraw')">ğŸ“Š ä»»å‹™ç®¡ç†</button>
        </div>

        <div id="tab-grading" class="app-section-panel">
            <div class="bg-white p-6 rounded shadow max-w-5xl mx-auto">
                <h2 class="text-lg font-bold mb-6 pb-2 border-b flex items-center gap-2">
                    ğŸ“ å¾…æ‰¹æ”¹ä½œæ¥­åˆ—è¡¨
                    <span class="text-xs font-normal text-gray-500 ml-2">(é»é¸ç­ç´šé€²å…¥æ‰¹æ”¹)</span>
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-blue-50 border-b border-blue-200">
                                <th class="p-4 font-bold text-blue-800 w-1/3">å­¸ç¿’å–®åç¨±</th>
                                <th class="p-4 font-bold text-blue-800 w-2/3">ç™¼å¸ƒç­ç´š</th>
                            </tr>
                        </thead>
                        <tbody id="grading-list-body" class="text-sm">
                            <tr><td colspan="2" class="p-8 text-center text-gray-500">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-library" class="app-section-panel hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded shadow h-fit">
                    <h2 class="text-lg font-bold mb-4 border-b pb-2">â• æ–°å¢å­¸ç¿’å–®</h2>
                    <label class="block text-sm font-bold mb-2">æ¨™é¡Œ</label>
                    <input type="text" id="ws-title" class="w-full border p-2 rounded mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
                    <label class="block text-sm font-bold mb-2">HTML åŸå§‹ç¢¼</label>
                    <textarea id="ws-html" class="w-full border p-2 rounded h-40 font-mono text-xs mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="<div>...</div>"></textarea>
                    <label class="block text-sm font-bold mb-2 text-blue-600">ç­”æ¡ˆå·è³‡æ–™ (JSON) <span class="text-xs font-normal text-gray-500">(è‡ªå‹•æ‰¹æ”¹ç”¨)</span></label>
                    <textarea id="ws-json" class="w-full border p-2 rounded h-32 font-mono text-xs mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder='{"q1": {"answer": "A", "note": "..."}}'></textarea>
                    <button id="preview-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm mb-4 w-full">ğŸ‘‡ é è¦½ HTML</button>
                    <button id="save-ws-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow transition">å„²å­˜åˆ°é¡Œåº«</button>
                </div>
                <div class="md:col-span-2 space-y-6">
                    <div id="preview-area" class="hidden">
                        <h3 class="text-sm font-bold text-gray-500 mb-1">é è¦½çµæœï¼š</h3>
                        <div id="preview-content" class="worksheet-preview"></div>
                    </div>
                    <div class="bg-white p-6 rounded shadow">
                        <h2 class="text-lg font-bold mb-4">ğŸ“œ å·²å»ºç«‹çš„å­¸ç¿’å–®</h2>
                        <div id="ws-list" class="space-y-3"><p class="text-center text-gray-500 py-4">è¼‰å…¥ä¸­...</p></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-assign" class="app-section-panel hidden">
            <div class="bg-white p-6 rounded shadow max-w-4xl mx-auto border-t-4 border-blue-500">
                <h2 class="text-lg font-bold mb-6 pb-2 border-b">ğŸš€ æ´¾ç™¼ä½œæ¥­</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">1. é¸æ“‡å­¸ç¿’å–®</label>
                        <select id="assign-ws-select" class="w-full border p-2 rounded bg-white outline-none"><option value="">è¼‰å…¥ä¸­...</option></select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">2. æˆªæ­¢æ—¥æœŸ (é¸å¡«)</label>
                        <input type="date" id="assign-deadline" class="w-full border p-2 rounded outline-none">
                    </div>
                </div>
                <div class="mt-6">
                    <label class="block text-gray-700 font-bold mb-2">3. é¸æ“‡ç­ç´š</label>
                    <div id="class-checkboxes" class="grid grid-cols-3 md:grid-cols-5 gap-3 p-4 bg-gray-50 rounded border max-h-40 overflow-y-auto"></div>
                </div>
                <div class="mt-8 text-center">
                    <button id="submit-assign-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-lg shadow-lg">ç¢ºèªç™¼å¸ƒ</button>
                </div>
            </div>
        </div>

        <div id="tab-withdraw" class="app-section-panel hidden">
            <div class="bg-white p-6 rounded shadow max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">ğŸ“Š ä»»å‹™ç®¡ç†</h2>
                    <div class="flex gap-2">
                        <button id="batch-deadline-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded shadow text-sm disabled:opacity-50">ğŸ“… ä¿®æ”¹æˆªæ­¢æ—¥</button>
                        <button id="batch-withdraw-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded shadow text-sm disabled:opacity-50">ğŸ—‘ï¸ æ’¤å›ç™¼å¸ƒ</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b border-gray-300">
                                <th class="p-3 font-bold text-gray-700 w-1/3">å­¸ç¿’å–®åç¨±</th>
                                <th class="p-3 font-bold text-gray-700 w-2/3">å·²ç™¼å¸ƒç­ç´š (å‹¾é¸ä»¥ç®¡ç†)</th>
                            </tr>
                        </thead>
                        <tbody id="assignment-table-body" class="text-sm"><tr><td colspan="2" class="p-4 text-center">è¼‰å…¥ä¸­...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div id="view-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="view-modal-title" class="text-xl font-bold">é è¦½</h3>
                <button onclick="closeViewModal()" class="text-3xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow"><div id="view-modal-content" class="worksheet-preview"></div></div>
            <div class="p-4 border-t text-right"><button onclick="closeViewModal()" class="bg-gray-500 text-white px-6 py-2 rounded">é—œé–‰</button></div>
        </div>
    </div>
	
    <div id="source-code-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
		<div class="bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 max-h-[90vh] flex flex-col">
			<div class="flex justify-between items-center p-4 border-b">
				<h3 class="text-xl font-bold text-gray-800">ğŸ“ åŸå§‹ç¢¼æª¢è¦–</h3>
				<button onclick="document.getElementById('source-code-modal').classList.add('hidden')" class="text-3xl text-gray-500 hover:text-gray-800">&times;</button>
			</div>
			<div class="p-6 overflow-y-auto flex-grow space-y-6">
				<div>
					<div class="flex justify-between items-center mb-2">
						<label class="block text-sm font-bold text-gray-700">HTML åŸå§‹ç¢¼</label>
						<button onclick="copyToClipboard('view-src-html', this)" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded transition flex items-center gap-1 border border-gray-300">
							ğŸ“‹ è¤‡è£½ HTML ä»£ç¢¼
						</button>
					</div>
					<textarea id="view-src-html" class="w-full border p-3 rounded h-48 font-mono text-xs bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500" readonly></textarea>
				</div>
				<div>
					<div class="flex justify-between items-center mb-2">
						<label class="block text-sm font-bold text-blue-600">ç­”æ¡ˆå·è³‡æ–™ (JSON)</label>
						<button onclick="copyToClipboard('view-src-json', this)" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded transition flex items-center gap-1 border border-blue-200">
							ğŸ“‹ è¤‡è£½ JSON è³‡æ–™
						</button>
					</div>
					<textarea id="view-src-json" class="w-full border p-3 rounded h-48 font-mono text-xs bg-blue-50 outline-none focus:ring-2 focus:ring-blue-500" readonly></textarea>
				</div>
			</div>
			<div class="p-4 border-t text-right bg-gray-50">
				<button onclick="document.getElementById('source-code-modal').classList.add('hidden')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded shadow transition">é—œé–‰è¦–çª—</button>
			</div>
		</div>
	</div>

    <div id="deadline-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-80 p-6">
            <h3 class="text-lg font-bold mb-4">ä¿®æ”¹æˆªæ­¢æ—¥æœŸ</h3>
            <p class="text-sm text-gray-500 mb-2">è«‹é¸æ“‡æ–°çš„æˆªæ­¢æ—¥ (ç•™ç©ºç‚ºç„¡æœŸé™)ï¼š</p>
            <input type="date" id="new-deadline-input" class="w-full border p-2 rounded mb-4 outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('deadline-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded text-sm hover:bg-gray-400">å–æ¶ˆ</button>
                <button id="save-deadline-btn" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="submission-list-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b bg-blue-50 rounded-t-lg">
                <div>
                    <h3 class="text-xl font-bold text-gray-800" id="submission-modal-title">ä½œæ¥­ç¹³äº¤æ¦‚æ³</h3>
                    <p class="text-sm text-gray-500" id="submission-modal-subtitle">...</p>
                </div>
                <div class="flex gap-2">
                    <button id="open-analysis-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded shadow font-bold text-sm flex items-center gap-2">
                        ğŸ“Š ç­ç´šç­”é¡Œåˆ†æ
                    </button>
                    <button onclick="document.getElementById('submission-list-modal').classList.add('hidden')" class="text-gray-500 text-3xl hover:text-gray-800 ml-4">&times;</button>
                </div>
            </div>
            
            <div class="bg-orange-50 p-3 border-b flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-bold text-orange-800">æ‰¹é‡æ“ä½œï¼š</span>
                    <button id="batch-return-continue-btn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-1.5 rounded shadow text-sm font-bold flex items-center gap-2 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        â†©ï¸ ç™¼å›çºŒå¯« (è§£é–)
                    </button>
                </div>
                <span class="text-xs text-orange-600 font-bold">â€» æ³¨æ„ï¼šã€Œç™¼å›çºŒå¯«ã€æœƒå°‡ä½œæ¥­ç‹€æ…‹æ”¹å›è‰ç¨¿ï¼Œå­¸ç”Ÿå¯å†æ¬¡ç·¨è¼¯å…§å®¹ã€‚</span>
            </div>

            <div class="p-6 overflow-y-auto flex-grow">
                <table class="min-w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100 border-b">
                            <th class="p-3 w-10 text-center">
                                <input type="checkbox" id="submission-master-checkbox" class="form-checkbox h-4 w-4 text-blue-600 cursor-pointer">
                            </th>
                            <th class="p-3 font-bold text-gray-600">åº§è™Ÿ</th>
                            <th class="p-3 font-bold text-gray-600">å§“å</th>
                            <th class="p-3 font-bold text-gray-600">ç‹€æ…‹</th>
                            <th class="p-3 font-bold text-gray-600">åˆ†æ•¸</th>
                            <th class="p-3 font-bold text-gray-600">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="submission-list-body" class="text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

	<div id="analysis-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col overflow-hidden relative">
            
            <div class="flex justify-between items-center p-4 border-b bg-purple-50">
                <div>
					<h3 id="analysis-main-title" class="text-xl font-bold text-purple-900">ğŸ“Š ç­ç´šç­”é¡Œåˆ†æ</h3>
                    <p id="analysis-subtitle" class="text-sm text-purple-600">è¼‰å…¥ä¸­...</p>
                </div>
                <button onclick="document.getElementById('analysis-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <div class="flex-grow p-4 md:p-6 overflow-hidden grid grid-cols-1 lg:grid-cols-5 gap-6 bg-gray-50">
                
                <div class="lg:col-span-2 bg-white p-5 rounded-lg shadow overflow-y-auto">
                    <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2">
                        ğŸ”¥ éŒ¯èª¤ç‡ Top 5 <span class="text-xs font-normal text-gray-500">(é­”ç‹é¡Œ)</span>
                    </h4>
                    <div id="analysis-leaderboard" class="space-y-4">
                        <p class="text-center text-gray-400 py-10">è³‡æ–™è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <div class="lg:col-span-3 bg-white p-5 rounded-lg shadow flex flex-col overflow-hidden relative">
                    
                    <div id="analysis-table-view" class="flex flex-col h-full">
                        <h4 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">ğŸ“‹ å®Œæ•´ç­”é¡Œçµ±è¨ˆè¡¨ <span class="text-xs font-normal text-gray-500">(é»æ“Šé¡Œç›®æŸ¥çœ‹åˆ†ä½ˆ)</span></h4>
                        <div class="flex-grow overflow-y-auto">
                            <table class="min-w-full text-left text-sm table-fixed"> <thead class="bg-gray-100 text-gray-600 sticky top-0 z-10">
                                    <tr>
                                        <th class="p-3 font-bold w-5/12">é¡Œç›®</th>
                                        <th class="p-3 font-bold text-center w-1/12">äººæ•¸</th>
                                        <th class="p-3 font-bold text-center w-1/12 text-green-600">å°</th>
                                        <th class="p-3 font-bold text-center w-1/12 text-red-600">éŒ¯</th>
                                        <th class="p-3 font-bold text-center w-2/12">éŒ¯èª¤ç‡</th>
                                    </tr>
                                </thead>
                                <tbody id="analysis-table-body" class="divide-y divide-gray-100">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="analysis-chart-view" class="hidden flex flex-col h-full absolute inset-0 bg-white p-5 z-20">
                        <div class="flex items-center justify-between mb-4 border-b pb-2">
                            <button onclick="toggleAnalysisView('table')" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded flex items-center gap-1 transition">
                                â¬…ï¸ è¿”å›åˆ—è¡¨
                            </button>
                            <h4 id="chart-question-title" class="text-md font-bold text-purple-800 truncate max-w-lg">é¡Œç›®æ¨™é¡Œ</h4>
                        </div>
                        <div class="flex-grow flex items-center justify-center bg-gray-50 rounded border border-gray-100 p-4">
                            <canvas id="analysis-chart"></canvas>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="grading-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex overflow-hidden relative">
            <div id="grading-left-panel" class="w-2/3 bg-gray-50 border-r relative transition-all duration-300 flex flex-col">
                <div class="absolute top-0 left-0 w-full flex justify-between items-start z-20 pointer-events-none">
                    <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-br-lg text-sm font-bold shadow-md pointer-events-auto border-b border-r border-blue-200">å­¸ç”Ÿä½œç­”å·</div>
                    <button onclick="document.getElementById('grading-modal').classList.add('hidden')" 
                            class="bg-gray-800 text-white px-4 py-2 rounded-bl-lg hover:bg-gray-700 pointer-events-auto shadow-md hidden flex items-center gap-2 transition" 
                            id="view-mode-close-btn">
                        <span>âœ•</span> é—œé–‰æª¢è¦–
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 pt-14"><div id="grading-worksheet-content" class="worksheet-preview bg-white shadow-sm min-h-full"></div></div>
            </div>
            <div id="grading-right-panel" class="w-1/3 flex flex-col bg-white transition-all duration-300 border-l">
                <div class="p-4 border-b bg-gray-50 shadow-sm z-10"><h3 class="text-lg font-bold text-gray-800" id="grading-student-name">å­¸ç”Ÿå§“å</h3><p class="text-xs text-gray-500">è«‹é‡å°å·¦å´é¡Œç›®é€²è¡Œ O/X æ¨™ç¤º</p></div>
                <div class="p-6 flex-grow overflow-y-auto space-y-6">
                    <div><label class="block text-gray-700 font-bold mb-2 text-lg">ç¸½åˆ† (0-100)</label><input type="number" id="grade-score" class="w-full border-2 border-blue-200 p-3 rounded-lg text-2xl font-bold text-center focus:border-blue-500 outline-none" placeholder="0"></div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">ç¸½è©•èª / å»ºè­°</label>
                        <textarea id="grade-comment" class="w-full border p-3 rounded-lg h-32 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="å¯«é»é¼“å‹µæˆ–å»ºè­°..."></textarea>
                        <div class="flex gap-2 mt-2"><button onclick="insertComment('åšå¾—å¾ˆå¥½ï¼')" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">åšå¾—å¾ˆå¥½</button><button onclick="insertComment('è«‹æª¢æŸ¥éŒ¯å­—')" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">æª¢æŸ¥éŒ¯å­—</button></div>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50 space-y-2 z-10">
                    <button id="submit-grade-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow transition">âœ… é€å‡ºæˆç¸¾</button>
                    <div class="grid grid-cols-2 gap-2"><button id="return-correction-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition">â†©ï¸ é€€å›è¨‚æ­£</button>
					<button onclick="confirmGradingExit()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
		// è¼”åŠ©å‡½å¼ï¼šå¼·åˆ¶åŸ·è¡Œè…³æœ¬ä¸¦é‡æ–°æ¸²æŸ“æ•¸å­¸å…¬å¼
		function executeEmbeddedScripts(container) {
			const scripts = container.querySelectorAll('script');
			scripts.forEach(oldScript => {
				const newScript = document.createElement('script');
				Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
				newScript.appendChild(document.createTextNode(oldScript.innerHTML));
				oldScript.parentNode.replaceChild(newScript, oldScript);
			});
			if (window.MathJax) {
				MathJax.typesetPromise([container]).catch((err) => console.log('MathJax error:', err));
			}
		}
		// è¼”åŠ©ï¼šè’é›†ç›®å‰æ‰¹æ”¹é¢æ¿çš„è³‡æ–™
		function collectCurrentGradingData() {
			const s = document.getElementById('grade-score').value;
			const c = document.getElementById('grade-comment').value;
			const gd = {};
			
			document.querySelectorAll('.grading-feedback-input').forEach(inp => {
				const n = inp.dataset.field; 
				const p = inp.closest('.grading-panel');
				// å–å¾— Radio ç‹€æ…‹
				const isC = p.querySelector('input[value="c"]').checked; 
				const isI = p.querySelector('input[value="i"]').checked;
				
				let finalC = null; 
				if(isC) finalC = true; 
				else if(isI) finalC = false;
				
				// åªè¦æœ‰æ”¹å‹•é (æœ‰å‹¾é¸æˆ–æœ‰è©•èª) å°±è¨˜éŒ„
				if(finalC !== null || inp.value.trim() !== '') {
					gd[n] = { is_correct: finalC, feedback: inp.value };
				}
			});
			
			return {
				score: s,
				comment: c,
				grading_details: gd,
				timestamp: new Date().getTime()
			};
		}

         // 1. Config
        const firebaseConfig = {
            apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
            authDomain: "classrecords-13902.firebaseapp.com",
            projectId: "classrecords-13902",
            storageBucket: "classrecords-13902.firebasestorage.app",
            messagingSenderId: "431747377367",
            appId: "1:431747377367:web:b157a485c59ce38091e892",
            measurementId: "G-JWTQGM9XMP"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let currentSchoolId = null;
        let availableClasses = [];
        let worksheetsCache = {}; 
        
        let currentGradingResponseId = null;
        let currentGradingWorksheetId = null;
		let editingWorksheetId = null;
        
        // ç”¨æ–¼åœ–è¡¨çš„å¯¦ä¾‹ (é¿å…é‡è¤‡å»ºç«‹)
        let analysisChartInstance = null;

        const CACHE_PREFIX = 'ws_sys_cache_';

        // 2. Auth Logic
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginMsg = document.getElementById('login-msg');
        const onboardingModal = document.getElementById('onboarding-modal');

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                loginMsg.textContent = 'é©—è­‰èº«åˆ†ä¸­...';
                currentUser = user;
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.schoolId) {
                            currentSchoolId = userData.schoolId;
                            const schoolDoc = await db.collection('schools').doc(currentSchoolId).get();
                            const schoolName = schoolDoc.exists ? (schoolDoc.data().name || currentSchoolId) : currentSchoolId;
                            
                            document.getElementById('header-school-name').textContent = schoolName;
                            document.getElementById('user-info').textContent = userData.displayName || user.displayName;
                            
                            loginView.classList.add('hidden');
                            appView.classList.remove('hidden');
                            
                            loadGradingList(); 
                            loadWorksheets();
                            analyzeClasses();
                        } else {
                            startOnboarding(user);
                        }
                    } else {
                        startOnboarding(user);
                    }
                } catch (e) {
                    console.error(e);
                    loginMsg.textContent = "ç™»å…¥éŒ¯èª¤: " + e.message;
                }
            } else {
                loginView.classList.remove('hidden');
                appView.classList.add('hidden');
                onboardingModal.classList.add('hidden');
            }
        });

        async function startOnboarding(user) {
            loginMsg.textContent = 'æ­£åœ¨æœå°‹æ‚¨çš„å­¸æ ¡...';
            const googleName = user.displayName;
            document.getElementById('onboarding-name').textContent = googleName;
            try {
                const snapshot = await db.collectionGroup('teachers').where('name', '==', googleName).get();
                if (snapshot.empty) throw new Error(`åœ¨æ‰€æœ‰å­¸æ ¡åå†Šä¸­æ‰¾ä¸åˆ°å§“åã€Œ${googleName}ã€ã€‚`);
                const schoolList = document.getElementById('school-list');
                schoolList.innerHTML = '';
                const promises = snapshot.docs.map(async (doc) => {
                    const schoolDocRef = doc.ref.parent.parent;
                    const schoolId = schoolDocRef.id;
                    const schoolDoc = await schoolDocRef.get();
                    const schoolName = schoolDoc.exists ? schoolDoc.data().name : schoolId;
                    return { schoolId, schoolName, teacherData: doc.data() };
                });
                const results = await Promise.all(promises);
                results.forEach(match => {
                    const div = document.createElement('div');
                    div.className = "school-select-item border rounded p-3 flex justify-between items-center";
                    div.innerHTML = `<div><div class="font-bold text-gray-800">${match.schoolName}</div><div class="text-xs text-gray-500">ID: ${match.schoolId}</div></div><button class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700">é¸æ“‡æ­¤æ ¡</button>`;
                    div.querySelector('button').onclick = () => confirmBind(match);
                    schoolList.appendChild(div);
                });
                loginView.classList.add('hidden');
                onboardingModal.classList.remove('hidden');
            } catch (e) {
                console.error(e);
                loginMsg.textContent = e.message;
                if(e.code === 'failed-precondition') loginMsg.innerHTML += '<br><span class="text-xs text-gray-400">(ç³»çµ±æç¤º: éœ€è¦å»ºç«‹ teachers çš„ name ç´¢å¼•)</span>';
                setTimeout(() => auth.signOut(), 5000);
            }
        }

        async function confirmBind(match) {
            if (!confirm(`æ‚¨ç¢ºå®šè¦ç¶å®šèº«åˆ†å—ï¼Ÿ\n\nå§“åï¼š${currentUser.displayName}\nå­¸æ ¡ï¼š${match.schoolName}\n\nâš ï¸ ç¶å®šå¾Œç„¡æ³•è‡ªè¡Œä¿®æ”¹ï¼`)) return;
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    role: 'teacher', displayName: match.teacherData.name, email: currentUser.email,
                    schoolId: match.schoolId, uid: currentUser.uid, boundAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('ç¶å®šæˆåŠŸï¼'); window.location.reload();
            } catch (e) { alert('ç¶å®šå¤±æ•—: ' + e.message); }
        }

        document.getElementById('cancel-bind-btn').addEventListener('click', () => {
            auth.signOut();
            onboardingModal.classList.add('hidden');
            loginView.classList.remove('hidden');
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            auth.signInWithPopup(provider);
        });
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut().then(() => window.location.reload()));

        document.getElementById('force-refresh-btn').addEventListener('click', async () => {
            if(!confirm('ç¢ºå®šè¦å¾é›²ç«¯é‡æ–°ä¸‹è¼‰æœ€æ–°è³‡æ–™å—ï¼Ÿ')) return;
            const btn = document.getElementById('force-refresh-btn');
            btn.classList.add('animate-spin', 'text-blue-600'); 
            
            try {
                await Promise.all([
                    loadWorksheets(true),
                    loadAssignmentsData(true), 
                    analyzeClasses(true)
                ]);
                loadGradingList(); 
                loadAssignments();
                alert('âœ… è³‡æ–™åŒæ­¥å®Œæˆï¼');
            } catch(e) {
                alert('âŒ åŒæ­¥å¤±æ•—: ' + e.message);
            } finally {
                btn.classList.remove('animate-spin', 'text-blue-600');
            }
        });

        async function fetchDataWithCache(keySuffix, forceRefresh, fetcher) {
            const cacheKey = CACHE_PREFIX + keySuffix;
            let data = null;
			const cacheHead = keySuffix.split("_")[0];
			let cacheName = null;
			if (cacheHead=='ws') cacheName = 'å­¸ç¿’å–®';
			else if (cacheHead=='assign') cacheName = 'ä»»å‹™æŒ‡æ´¾';
			else cacheName = 'ç­ç´šå­¸ç”Ÿ';
            
            if (!forceRefresh) {
                const cachedJson = localStorage.getItem(cacheKey);
                if (cachedJson) {
                    try {
                        data = JSON.parse(cachedJson);
                        console.log(`ğŸ“¦ [æœ¬åœ°å¿«å–] ${cacheName}... `);
                    } catch(e) {
                        console.warn('å¿«å–è§£æéŒ¯èª¤ï¼Œç§»é™¤å¿«å–:', e);
                        localStorage.removeItem(cacheKey);
                    }
                }
            }

            if (!data) {
                console.log(`â˜ï¸ [é›²ç«¯è¼‰å…¥] ${cacheName}...`);
                data = await fetcher();
                localStorage.setItem(cacheKey, JSON.stringify(data));
            }
            return data;
        }

        window.switchAppMenu = (tabName) => {
            document.querySelectorAll('.app-section-panel').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
                btn.classList.add('text-gray-500');
            });

            const targetBtn = document.getElementById(`btn-tab-${tabName}`);
            if (targetBtn) {
                targetBtn.classList.remove('text-gray-500');
                targetBtn.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
            }
            
            if (tabName === 'grading') loadGradingList();
            if (tabName === 'withdraw') loadAssignments();
        };
		
		document.getElementById('preview-btn').addEventListener('click', () => {
			document.getElementById('view-modal-content').innerHTML = '';
			document.getElementById('view-modal').classList.add('hidden'); 
			const previewDiv = document.getElementById('preview-content');
			const htmlContent = document.getElementById('ws-html').value;
			previewDiv.innerHTML = htmlContent;
			document.getElementById('preview-area').classList.remove('hidden');
			executeEmbeddedScripts(previewDiv);
		});

        document.getElementById('save-ws-btn').addEventListener('click', async () => {
            const title = document.getElementById('ws-title').value.trim();
            const html = document.getElementById('ws-html').value.trim();
            const jsonStr = document.getElementById('ws-json').value.trim();
            
            if(!title) return alert('è«‹è¼¸å…¥æ¨™é¡Œ');
            if(!html) return alert('è«‹è¼¸å…¥å…§å®¹(HTMLåŸå§‹ç¢¼)');
            
            let answerKey = null;
            if(jsonStr) {
                try { answerKey = JSON.parse(jsonStr); } catch(e) { return alert('ç­”æ¡ˆå· JSON æ ¼å¼éŒ¯èª¤: ' + e.message); }
            }

            const btn = document.getElementById('save-ws-btn');
            btn.disabled = true;

            try {
                if (editingWorksheetId) {
                    await db.collection('worksheets').doc(editingWorksheetId).update({
                        title: title,
                        html_content: html,
                        answer_key: answerKey,
                        updated_at: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('æ›´æ–°æˆåŠŸï¼');
                    resetEditMode(); 
                } else {
                    const dupSnap = await db.collection('worksheets')
                        .where('creator_id', '==', currentUser.uid)
                        .where('title', '==', title)
                        .get();

                    if (!dupSnap.empty) {
                        if (!confirm(`å­¸ç¿’å–® "${title}" å·²å­˜åœ¨ã€‚\nç¢ºå®šè¦è¦†è“‹å®ƒå—ï¼Ÿ(é€™å°‡è®Šæˆæ›´æ–°æ¨¡å¼)`)) {
                            btn.disabled = false; return;
                        }
                        const oldId = dupSnap.docs[0].id;
                        await db.collection('worksheets').doc(oldId).update({
                            html_content: html, answer_key: answerKey,
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        await db.collection('worksheets').add({
                            title, html_content: html, answer_key: answerKey,
                            creator_id: currentUser.uid, 
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    alert('å·²å„²å­˜ï¼');
                    resetEditMode(); 
                }

                document.getElementById('preview-area').classList.add('hidden');
                localStorage.removeItem(CACHE_PREFIX + 'ws_' + currentUser.uid);
                loadWorksheets(true);

            } catch(e) { 
                console.error(e);
                alert('æ“ä½œå¤±æ•—: ' + e.message); 
            } finally {
                btn.disabled = false;
            }
        });

		async function loadWorksheets(force = false) {
			const listEl = document.getElementById('ws-list');
			const selectEl = document.getElementById('assign-ws-select');
            
            const items = await fetchDataWithCache('ws_' + currentUser.uid, force, async () => {
                const snap = await db.collection('worksheets').where('creator_id', '==', currentUser.uid).orderBy('created_at', 'desc').get();
                const res = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    res.push({
                        id: doc.id,
                        title: d.title,
                        html_content: d.html_content,
                        answer_key: d.answer_key,
                        created_at_iso: d.created_at ? d.created_at.toDate().toISOString() : new Date().toISOString()
                    });
                });
                return res;
            });

			listEl.innerHTML = ''; selectEl.innerHTML = '<option value="">è«‹é¸æ“‡å­¸ç¿’å–®...</option>'; worksheetsCache = {};
			
            if (items.length === 0) { listEl.innerHTML = '<p class="text-center text-gray-500 py-4">ç„¡è³‡æ–™</p>'; return; }
			
            items.forEach(data => {
				worksheetsCache[data.id] = data; 
				
				const dateObj = new Date(data.created_at_iso);
				const dateStr = dateObj.toLocaleString('zh-TW', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
				const item = document.createElement('div');
				item.className = 'flex justify-between items-center p-4 border rounded bg-white shadow-sm';
				item.innerHTML = `
					<div>
						<div class="font-bold text-gray-700">ğŸ“„ ${data.title}</div>
						<div class="text-xs text-gray-400 mt-1">å»ºç«‹æ–¼ï¼š${dateStr}</div>
					</div>
					<div class="space-x-2">
                        <button class="bg-orange-100 text-orange-600 px-3 py-1 rounded text-sm font-bold hover:bg-orange-200" onclick="editWorksheet('${data.id}')">âœï¸ ç·¨è¼¯</button>
						<button class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-sm font-bold hover:bg-yellow-200" onclick="renameWorksheet('${data.id}', '${data.title}')">âœï¸ æ”¹å</button>
						<button class="bg-purple-100 text-purple-600 px-3 py-1 rounded text-sm font-bold hover:bg-purple-200" onclick="viewSourceCode('${data.id}')">ğŸ“ åŸå§‹ç¢¼</button>
						<button class="bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm font-bold hover:bg-blue-200" onclick="viewWorksheet('${data.id}')">ğŸ‘ï¸ é è¦½</button>
						<button class="bg-red-100 text-red-500 px-3 py-1 rounded text-sm font-bold hover:bg-red-200" onclick="deleteWorksheet('${data.id}')">åˆªé™¤</button>
					</div>`;

				listEl.appendChild(item);
				const opt = document.createElement('option'); opt.value = data.id; opt.textContent = data.title; selectEl.appendChild(opt);
			});
		}
		
        window.editWorksheet = (id) => {
            const data = worksheetsCache[id];
            if (!data) return alert('æ‰¾ä¸åˆ°å¿«å–è³‡æ–™ï¼Œè«‹å˜—è©¦é‡æ–°æ•´ç†é é¢');

            document.getElementById('ws-title').value = data.title;
            document.getElementById('ws-html').value = data.html_content;
            
            const jsonStr = data.answer_key ? JSON.stringify(data.answer_key, null, 4) : '';
            document.getElementById('ws-json').value = jsonStr;

            editingWorksheetId = id;

            const saveBtn = document.getElementById('save-ws-btn');
            saveBtn.textContent = 'ğŸ’¾ æ›´æ–°å­¸ç¿’å–® (ç·¨è¼¯ä¸­)';
            saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            saveBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
            
            document.getElementById('tab-library').scrollIntoView({ behavior: 'smooth' });
            alert('å·²è¼‰å…¥å…§å®¹ï¼\n\nè«‹åœ¨ä¸Šæ–¹ç·¨è¼¯å€ä¿®æ”¹ HTML æˆ– JSONï¼Œ\nå®Œæˆå¾ŒæŒ‰æ©˜è‰²çš„ã€Œæ›´æ–°å­¸ç¿’å–®ã€æŒ‰éˆ•ã€‚');
        };

        function resetEditMode() {
            editingWorksheetId = null;
            document.getElementById('ws-title').value = '';
            document.getElementById('ws-html').value = '';
            document.getElementById('ws-json').value = '';
            
            const saveBtn = document.getElementById('save-ws-btn');
            saveBtn.textContent = 'å„²å­˜åˆ°é¡Œåº«';
            saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            saveBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
        }

        window.renameWorksheet = async (id, oldTitle) => {
            const newTitle = prompt('è«‹è¼¸å…¥æ–°çš„æ¨™é¡Œï¼š', oldTitle);
            if (newTitle && newTitle.trim() !== '' && newTitle !== oldTitle) {
                try {
                    await db.collection('worksheets').doc(id).update({ title: newTitle.trim() });
                    localStorage.removeItem(CACHE_PREFIX + 'ws_' + currentUser.uid);
                    loadWorksheets(true);
                } catch (e) { alert('æ›´æ–°å¤±æ•—: ' + e.message); }
            }
        };

		window.viewWorksheet = (id) => {
			document.getElementById('preview-content').innerHTML = '';
			document.getElementById('preview-area').classList.add('hidden');
			const data = worksheetsCache[id]; if(!data) return;
			document.getElementById('view-modal-title').textContent = data.title;
			const contentDiv = document.getElementById('view-modal-content');
			contentDiv.innerHTML = data.html_content;
			executeEmbeddedScripts(contentDiv);
			document.getElementById('view-modal').classList.remove('hidden');
		};
        window.closeViewModal = () => document.getElementById('view-modal').classList.add('hidden');
        
        window.deleteWorksheet = async (id) => {
            if(!confirm('âš ï¸ è­¦å‘Šï¼šåˆªé™¤é€™ä»½å­¸ç¿’å–®ï¼Œå°‡æœƒä¸€ä½µã€Œæ’¤å›ã€æ‰€æœ‰å·²æ´¾ç™¼çµ¦å­¸ç”Ÿçš„ä»»å‹™ï¼\n\nç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) return;
            const btn = event.target; const originalText = btn.textContent;
            btn.textContent = 'åˆªé™¤ä¸­...'; btn.disabled = true;
            try {
                const batch = db.batch();
                batch.delete(db.collection('worksheets').doc(id));
                const assignSnap = await db.collection('assignments').where('worksheet_id', '==', id).get();
                assignSnap.forEach(doc => { batch.delete(doc.ref); });
                await batch.commit();
                alert(`åˆªé™¤æˆåŠŸï¼`);
                
                localStorage.removeItem(CACHE_PREFIX + 'ws_' + currentUser.uid);
                localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
                
                loadWorksheets(true); 
                loadAssignmentsData(true).then(() => {
                    loadAssignments(); 
                    loadGradingList();
                });

            } catch(e) {
                console.error(e); alert('åˆªé™¤å¤±æ•—: ' + e.message);
                btn.textContent = originalText; btn.disabled = false;
            }
        };

        async function analyzeClasses(force = false) {
            const container = document.getElementById('class-checkboxes');
            
            const classes = await fetchDataWithCache('classes_' + currentSchoolId, force, async () => {
                const s = await db.collection('schools').doc(currentSchoolId).collection('students').get();
                const set = new Set();
                s.forEach(d => { if(d.data().class_id) set.add(d.data().class_id); });
                return Array.from(set).sort();
            });
            
            availableClasses = classes;
            if(classes.length === 0) { container.innerHTML = '<p class="text-red-500 col-span-full text-center">ç„¡å­¸ç”Ÿè³‡æ–™</p>'; return; }

            const groups = {};
            classes.forEach(cls => {
                const grade = cls.charAt(0);
                if (!groups[grade]) groups[grade] = [];
                groups[grade].push(cls);
            });

            container.innerHTML = '';
            container.className = "p-4 bg-gray-50 rounded border max-h-60 overflow-y-auto space-y-4"; 

            Object.keys(groups).sort().forEach(grade => {
                const clsList = groups[grade];
                const section = document.createElement('div');
                section.className = "border-b border-gray-200 pb-2 last:border-0";
                const header = document.createElement('div');
                header.className = "flex items-center mb-2";
                header.innerHTML = `<label class="flex items-center space-x-2 cursor-pointer select-none"><input type="checkbox" class="grade-master-checkbox form-checkbox h-4 w-4 text-blue-600 rounded border-gray-400" data-grade="${grade}" onchange="toggleGradeGroup(this)"><span class="font-bold text-gray-800 text-sm">${grade} å¹´ç´š (${clsList.length} ç­)</span></label>`;
                section.appendChild(header);
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-4 md:grid-cols-5 gap-2"; 
                clsList.forEach(cls => {
                    grid.innerHTML += `<label class="flex items-center space-x-1 cursor-pointer p-1 hover:bg-blue-100 rounded transition select-none"><input type="checkbox" name="target_class" value="${cls}" class="grade-${grade}-item form-checkbox h-4 w-4 text-blue-500 rounded border-gray-300"><span class="text-gray-700 text-sm font-medium">${cls}</span></label>`;
                });
                section.appendChild(grid);
                container.appendChild(section);
            });
        }
        window.toggleGradeGroup = (btn) => {
            document.querySelectorAll(`.grade-${btn.dataset.grade}-item`).forEach(cb => cb.checked = btn.checked);
        };

        document.getElementById('submit-assign-btn').addEventListener('click', async () => {
            const selectEl = document.getElementById('assign-ws-select');
            const deadlineEl = document.getElementById('assign-deadline');
            
            const wid = selectEl.value;
            const dead = deadlineEl.value;
            const cls = Array.from(document.querySelectorAll('input[name="target_class"]:checked')).map(c => c.value);
            
            if(!wid || cls.length === 0) return alert('è«‹é¸æ“‡å­¸ç¿’å–®èˆ‡ç­ç´š');
            
            const btn = document.getElementById('submit-assign-btn');
            const originalText = btn.textContent;
            btn.disabled = true; 
            btn.textContent = 'è™•ç†ä¸­...';

            const wtitle = document.querySelector(`#assign-ws-select option[value="${wid}"]`).textContent;

            try {
                const checkPromises = cls.map(async (className) => {
                    const snapshot = await db.collection('assignments')
                        .where('worksheet_id', '==', wid)
                        .where('target_class', '==', className)
                        .where('school_id', '==', currentSchoolId)
                        .limit(1)
                        .get();
                    return { className, snapshot };
                });

                const results = await Promise.all(checkPromises);
                const batch = db.batch();
                let updatedCount = 0;
                let createdCount = 0;

                results.forEach(({ className, snapshot }) => {
                    if (!snapshot.empty) {
                        const docRef = snapshot.docs[0].ref;
                        batch.update(docRef, {
                            deadline: dead,
                            worksheet_title: wtitle,
                            updated_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        updatedCount++;
                    } else {
                        const newRef = db.collection('assignments').doc();
                        batch.set(newRef, {
                            worksheet_id: wid, 
                            worksheet_title: wtitle, 
                            target_class: className,
                            teacher_id: currentUser.uid, 
                            school_id: currentSchoolId, 
                            deadline: dead,
                            status: 'published', 
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        createdCount++;
                    }
                });

                await batch.commit(); 
                
                let msg = 'æ“ä½œæˆåŠŸï¼\n';
                if (createdCount > 0) msg += `âœ… æ–°ç™¼å¸ƒçµ¦ ${createdCount} å€‹ç­ç´š\n`;
                if (updatedCount > 0) msg += `ğŸ”„ æ›´æ–°äº† ${updatedCount} å€‹ç­ç´šçš„ä»»å‹™è¨­å®š`;
                alert(msg);

                localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
                await loadAssignmentsData(true);
                loadAssignments(); 
                loadGradingList();

                selectEl.value = ''; 
                deadlineEl.value = ''; 
                document.querySelectorAll('input[name="target_class"]').forEach(cb => cb.checked = false);
                document.querySelectorAll('.grade-master-checkbox').forEach(cb => cb.checked = false);

                switchAppMenu('withdraw'); 

            } catch(e) { 
                console.error(e);
                alert('ç™¼å¸ƒå¤±æ•—: ' + e.message); 
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
		
        async function loadAssignments() {
            const tb = document.getElementById('assignment-table-body');
            const items = await loadAssignmentsData(); 
            
            tb.innerHTML = '';
            if(items.length === 0) { tb.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-500">ç„¡ç´€éŒ„</td></tr>'; return; }
            
            const g = {};
            items.forEach(i => {
                if(!g[i.title]) g[i.title] = [];
                g[i.title].push(i);
            });

            Object.keys(g).forEach(t => {
                const list = g[t];
                let lastPubStr = 'æœªçŸ¥';
                if (list.length > 0) {
                    const dates = list.map(i => i.created_at_iso).filter(d => d).sort();
                    if (dates.length > 0) {
                        const lastIso = dates[dates.length - 1];
                        const dateObj = new Date(lastIso);
                        lastPubStr = dateObj.toLocaleString('zh-TW', { 
                            hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' 
                        });
                    }
                }

                list.sort((a,b) => a.target_class.localeCompare(b.target_class));
                
                const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-gray-50';
                const tdTitle = document.createElement('td'); tdTitle.className = "p-3 align-top";
                
                tdTitle.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <span class="font-bold text-gray-800 text-lg">${t}</span>
                        <span class="text-xs text-gray-500 font-mono tracking-wide">ğŸ•’ æœ€å¾Œç™¼å¸ƒï¼š${lastPubStr}</span>
                        <label class="inline-flex items-center text-xs text-gray-400 cursor-pointer select-none hover:text-blue-600 transition w-fit mt-1">
                            <input type="checkbox" class="form-checkbox h-3 w-3 text-blue-500 mr-1 rounded border-gray-300" onchange="toggleGroup(this)">
                            å…¨é¸ / å…¨å–æ¶ˆ
                        </label>
                    </div>`;
                
                const tdClasses = document.createElement('td'); tdClasses.className = "p-3 align-top";
                let clsHtml = '';
                list.forEach(i => {
                    const deadInfo = i.deadline ? `<span class="text-red-500 ml-1 font-bold">æœŸé™:${i.deadline.slice(5)}</span>` : '<span class="text-green-500 ml-1">ç„¡æœŸé™</span>';
                    clsHtml += `<label class="inline-flex items-center mr-3 mb-2 bg-white px-3 py-1.5 rounded border border-gray-200 shadow-sm hover:bg-blue-50 hover:border-blue-200 cursor-pointer select-none transition"><input type="checkbox" class="withdraw-checkbox form-checkbox h-4 w-4 text-red-500 mr-2 rounded border-gray-300 focus:ring-red-500" value="${i.id}"><span class="font-bold text-gray-700">${i.target_class} ç­</span><span class="text-xs text-gray-500 ml-1">(${deadInfo})</span></label>`;
                });
                tdClasses.innerHTML = clsHtml;
                tr.appendChild(tdTitle); tr.appendChild(tdClasses); tb.appendChild(tr);
            });
        }

        async function loadAssignmentsData(force = false) {
            return await fetchDataWithCache('assign_' + currentUser.uid, force, async () => {
                const s = await db.collection('assignments')
                    .where('teacher_id', '==', currentUser.uid)
                    .orderBy('created_at', 'desc')
                    .get();
                
                const res = [];
                s.forEach(d => {
                    const data = d.data();
                    res.push({
                        id: d.id,
                        worksheet_id: data.worksheet_id,
                        title: data.worksheet_title || 'æœªå‘½å',
                        target_class: data.target_class,
                        deadline: data.deadline,
                        created_at_iso: data.created_at ? data.created_at.toDate().toISOString() : null
                    });
                });
                return res;
            });
        }

		// -------------------------------------------------------------------------
        // 8. æ‰¹æ”¹åˆ—è¡¨ (å«ç¹³äº¤ç‹€æ³çµ±è¨ˆ + æ•´é«”åˆ†ææŒ‰éˆ•)
        // -------------------------------------------------------------------------
        async function loadGradingList() {
            const tb = document.getElementById('grading-list-body');
            
            // 1. å–å¾—ä»»å‹™åˆ—è¡¨
            const items = await loadAssignmentsData(); 
            
            tb.innerHTML = '';
            if(items.length === 0) { tb.innerHTML = '<tr><td colspan="2" class="p-8 text-center text-gray-500">ç›®å‰ç„¡ç™¼å¸ƒä½œæ¥­</td></tr>'; return; }
            
            // 2. åˆ†çµ„ï¼šä¾æ“šå­¸ç¿’å–®æ¨™é¡Œåˆ†çµ„
            const g = {};
            items.forEach(i => {
                if(!g[i.title]) g[i.title] = [];
                g[i.title].push(i);
            });

            // 3. é€ä¸€è™•ç†æ¯å€‹æ¨™é¡Œç¾¤çµ„
            const titles = Object.keys(g);
            for (const t of titles) {
                const list = g[t].sort((a,b) => a.target_class.localeCompare(b.target_class));
                const tr = document.createElement('tr'); 
                tr.className = 'border-b hover:bg-blue-50';
                
                // å–å¾—è©²ç¾¤çµ„çš„ç¬¬ä¸€å€‹ä»»å‹™è³‡è¨Š (ç”¨ä¾†æŠ“ worksheet_id)
                // å‡è¨­åŒä¸€æ¨™é¡Œçš„ä»»å‹™éƒ½å°æ‡‰åŒä¸€ä»½ worksheet_id (é€šå¸¸æ˜¯é€™æ¨£)
                const firstTask = list[0]; 
                const worksheetId = firstTask.worksheet_id;
                
                // æ”¶é›†è©²æ¨™é¡Œä¸‹æ‰€æœ‰çš„ assignment_id (ç”¨æ–¼æ•´é«”åˆ†æ)
                const allAssignmentIds = list.map(item => item.id);

                // ğŸ”¥ [æ–°å¢] å·¦å´æ¨™é¡Œæ¬„ä½ï¼šåŠ å…¥ã€Œæ•´é«”åˆ†æã€æŒ‰éˆ•
                // é»æ“Šæ™‚ï¼Œå‚³å…¥ null ä½œç‚º assignmentIdï¼Œä¸¦å‚³å…¥ id é™£åˆ—ä½œç‚º extraData
                // æˆ‘å€‘ç¨å¾Œæœƒä¿®æ”¹ openAnalysisModal ä¾†æ”¯æ´å‚³å…¥é™£åˆ—
                const titleHtml = `
                    <div class="flex flex-col gap-2">
                        <span class="font-bold text-gray-800 text-lg align-middle">${t}</span>
                        <button onclick="openOverallAnalysis('${worksheetId}', '${encodeURIComponent(JSON.stringify(allAssignmentIds))}', '${t} (å…¨é«”)')" 
                                class="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-1.5 rounded border border-indigo-200 w-fit flex items-center gap-1 transition">
                            ğŸ“Š æ•´é«”åˆ†æ (${list.length} å€‹ç­ç´š)
                        </button>
                    </div>
                `;

                // å³å´ç­ç´šæŒ‰éˆ• (é‚è¼¯ä¸è®Š)
                const classPromises = list.map(async (i) => {
                    const q = await db.collection('responses').where('assignment_id', '==', i.id).get();
                    let sub = 0; let corr = 0;
                    q.forEach(d => {
                        const st = d.data().status;
                        if(st === 'submitted') sub++;
                        if(st === 'needs_correction') corr++;
                    });
                    
                    const hasPending = (sub > 0 || corr > 0);
                    const badgeClass = hasPending ? 'bg-red-100 text-red-700 border-red-200 font-bold' : 'bg-gray-100 text-gray-400 border-gray-200';
                    const btnBorder = hasPending ? 'border-blue-400 ring-2 ring-blue-100' : 'border-gray-200';

                    return `
                        <button onclick="openSubmissionList('${i.id}', '${i.target_class}', '${i.worksheet_id}', '${i.title}')" 
                                class="m-1 bg-white hover:bg-white hover:shadow-lg border ${btnBorder} px-3 py-2 rounded shadow-sm transition flex flex-col items-center justify-center min-w-[110px] group">
                            <span class="font-bold text-blue-700 text-base mb-1 group-hover:text-blue-900">ğŸ« ${i.target_class} ç­</span>
                            <span class="text-xs px-2 py-0.5 rounded border ${badgeClass} w-full text-center">
                                å·²äº¤: ${sub} | è¨‚æ­£: ${corr}
                            </span>
                        </button>`;
                });

                const buttonsHtml = await Promise.all(classPromises);
                const clsBtns = buttonsHtml.join('');

                tr.innerHTML = `<td class="p-4 align-top">${titleHtml}</td><td class="p-4 align-middle flex flex-wrap">${clsBtns}</td>`;
                tb.appendChild(tr);
            }
        }

        // ğŸ”¥ [æ–°å¢] å°ˆé–€è™•ç†æ•´é«”åˆ†æçš„å…¥å£å‡½å¼
        async function openOverallAnalysis(worksheetId, assignmentIdsStr, title) {
            const assignmentIds = JSON.parse(decodeURIComponent(assignmentIdsStr));
            // å‘¼å«åŸæœ¬çš„åˆ†æ Modalï¼Œä½†å‚³å…¥ç‰¹æ®Šåƒæ•¸
            // é€™è£¡æˆ‘å€‘éœ€è¦å¾®èª¿ openAnalysisModal ä¾†æ”¯æ´ "assignmentIds æ˜¯é™£åˆ—" çš„æƒ…æ³
            await openAnalysisModal(assignmentIds, worksheetId, title);
        }

        window.toggleGroup = (master) => {
            master.closest('tr').querySelectorAll('.withdraw-checkbox').forEach(cb => cb.checked = master.checked);
        };
        
        document.getElementById('batch-withdraw-btn').addEventListener('click', async () => {
            const chk = document.querySelectorAll('.withdraw-checkbox:checked');
            if(chk.length === 0 || !confirm('ç¢ºå®šæ’¤å›ï¼Ÿ')) return;
            const b = db.batch(); chk.forEach(c => b.delete(db.collection('assignments').doc(c.value)));
            try { 
                await b.commit(); 
                alert('å·²æ’¤å›'); 
                localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
                await loadAssignmentsData(true);
                loadAssignments(); 
                loadGradingList();
            } catch(e) { alert(e.message); }
        });
        
        document.getElementById('batch-deadline-btn').addEventListener('click', () => {
            if(document.querySelectorAll('.withdraw-checkbox:checked').length === 0) return alert('è«‹å…ˆå‹¾é¸');
            document.getElementById('new-deadline-input').value = '';
            document.getElementById('deadline-modal').classList.remove('hidden');
        });
        document.getElementById('save-deadline-btn').addEventListener('click', async () => {
            const newDate = document.getElementById('new-deadline-input').value;
            const chk = document.querySelectorAll('.withdraw-checkbox:checked');
            const b = db.batch(); chk.forEach(c => b.update(db.collection('assignments').doc(c.value), { deadline: newDate || null }));
            try { 
                await b.commit(); alert('æ›´æ–°æˆåŠŸ'); document.getElementById('deadline-modal').classList.add('hidden'); 
                localStorage.removeItem(CACHE_PREFIX + 'assign_' + currentUser.uid);
                await loadAssignmentsData(true);
                loadAssignments(); 
            } catch(e) { alert(e.message); }
        });

        window.openSubmissionList = async (aid, cls, wid, title) => {
            const modal = document.getElementById('submission-list-modal');
            const tb = document.getElementById('submission-list-body');
            const masterChk = document.getElementById('submission-master-checkbox');
            const analysisBtn = document.getElementById('open-analysis-btn');
            
            // ç¶å®šåˆ†ææŒ‰éˆ•
            analysisBtn.onclick = () => openAnalysisModal(aid, wid, `${title} (${cls}ç­)`);

            if(masterChk) {
                masterChk.checked = false;
                masterChk.onclick = (e) => {
                    document.querySelectorAll('.sub-checkbox:not(:disabled)').forEach(cb => cb.checked = e.target.checked);
                };
            }

            document.getElementById('submission-modal-title').textContent = title;
            document.getElementById('submission-modal-subtitle').textContent = `ç­ç´šï¼š${cls} ç­`;
            tb.innerHTML = '<tr><td colspan="6" class="p-4 text-center">è¼‰å…¥ä¸­...</td></tr>';
            modal.classList.remove('hidden');
            
            const snap = await db.collection('responses').where('assignment_id', '==', aid).orderBy('student_no').get();
            tb.innerHTML = '';
            
            if(snap.empty) { tb.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">å°šç„¡ç¹³äº¤</td></tr>'; return; }
            
            snap.forEach(doc => {
                const d = doc.data();
                let st = '';
                if(d.status==='submitted') st='<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">å·²ç¹³äº¤</span>';
                else if(d.status==='graded') st='<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded font-bold">å·²æ‰¹æ”¹</span>';
                else if(d.status==='needs_correction') st='<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded font-bold">è¨‚æ­£ä¸­</span>';
                else st='<span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">è‰ç¨¿/æœªäº¤</span>';
                
                const canReturn = (d.status === 'submitted' || d.status === 'graded' || d.status === 'needs_correction');
                const checkboxHtml = `<input type="checkbox" class="sub-checkbox form-checkbox h-4 w-4 text-orange-500 cursor-pointer" value="${doc.id}" ${canReturn ? '' : 'disabled'}>`;

                const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="p-3 text-center">${checkboxHtml}</td>
                    <td class="p-3">${d.student_no||'?'}</td>
                    <td class="p-3 font-bold">${d.student_name}</td>
                    <td class="p-3">${st}</td>
                    <td class="p-3 font-mono font-bold text-blue-600">${d.score!==undefined?d.score:'-'}</td>
                    <td class="p-3 flex gap-2">
                        <button onclick="openGradingModal('${doc.id}', '${wid}', '${d.student_name}', 'view')" class="bg-gray-100 text-gray-600 px-3 py-1 rounded text-sm hover:bg-gray-200 border border-gray-300 font-bold">ğŸ‘ï¸ æª¢è¦–</button>
                        <button onclick="openGradingModal('${doc.id}', '${wid}', '${d.student_name}', 'edit')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 font-bold shadow-sm">æ‰¹æ”¹</button>
                    </td>`;
                tb.appendChild(tr);
            });
            
            const batchBtn = document.getElementById('batch-return-continue-btn');
            const newBtn = batchBtn.cloneNode(true);
            batchBtn.parentNode.replaceChild(newBtn, batchBtn);
            
            newBtn.addEventListener('click', async () => {
                const checkedBoxes = document.querySelectorAll('.sub-checkbox:checked');
                if(checkedBoxes.length === 0) return alert('è«‹å…ˆå‹¾é¸å­¸ç”Ÿï¼');
                if(!confirm(`ç¢ºå®šè¦å°‡é¸å–çš„ ${checkedBoxes.length} ä½å­¸ç”Ÿç™¼å›çºŒå¯«å—ï¼Ÿ`)) return;

                newBtn.disabled = true; newBtn.textContent = 'è™•ç†ä¸­...';
                try {
                    const batch = db.batch();
                    checkedBoxes.forEach(cb => {
                        const ref = db.collection('responses').doc(cb.value);
                        batch.update(ref, {
                            status: 'draft',
                            updated_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    await batch.commit();
                    alert('âœ… å·²æˆåŠŸç™¼å›çºŒå¯«ï¼');
                    openSubmissionList(aid, cls, wid, title);
                    loadGradingList();
                } catch(e) { alert('ç™¼ç”ŸéŒ¯èª¤: ' + e.message); } 
                finally { newBtn.disabled = false; newBtn.textContent = 'â†©ï¸ ç™¼å›çºŒå¯« (è§£é–)'; }
            });
        };

		// ğŸ”¥ [ä¿®æ”¹] ç­”é¡Œåˆ†æé‚è¼¯ï¼š(1) ä¿®æ­£åœ–è¡¨æ®˜ç•™ (2) è‡ªå‹•æ‰¹æ”¹ (3) å–®å…ƒæ¨™ç±¤
		// ğŸ”¥ [æ–°å¢] åˆ‡æ›åˆ†æè¦–åœ– (åˆ—è¡¨ <-> åœ–è¡¨)
        window.toggleAnalysisView = (viewName) => {
            const tableView = document.getElementById('analysis-table-view');
            const chartView = document.getElementById('analysis-chart-view');
            
            if (viewName === 'chart') {
                tableView.classList.add('hidden');
                chartView.classList.remove('hidden');
            } else {
                chartView.classList.add('hidden');
                tableView.classList.remove('hidden');
            }
        };

        // ğŸ”¥ [ä¿®æ”¹] ç­”é¡Œåˆ†æé‚è¼¯ï¼šç”Ÿæˆå³å´çµ±è¨ˆè¡¨æ ¼ + Top 5
        async function openAnalysisModal(assignmentIdOrArray, worksheetId, title) {
            const modal = document.getElementById('analysis-modal');
			const mainTitleEl = document.getElementById('analysis-main-title'); // æŠ“å–ä¸»æ¨™é¡Œ
            const leaderboardEl = document.getElementById('analysis-leaderboard');
            const tableBody = document.getElementById('analysis-table-body');
            
            // é‡ç½®ç‹€æ…‹
            if (analysisChartInstance) { analysisChartInstance.destroy(); analysisChartInstance = null; }
            toggleAnalysisView('table'); // é è¨­é¡¯ç¤ºè¡¨æ ¼
			
			if (Array.isArray(assignmentIdOrArray)) {
                mainTitleEl.textContent = 'ğŸ“Š å…¨é«”ç­”é¡Œåˆ†æ';
            } else {
                mainTitleEl.textContent = 'ğŸ“Š ç­ç´šç­”é¡Œåˆ†æ';
            }

            document.getElementById('analysis-subtitle').textContent = title;
            leaderboardEl.innerHTML = '<p class="text-center text-gray-400 py-10">è³‡æ–™é‹ç®—ä¸­...</p>';
            tableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">è¼‰å…¥ä¸­...</td></tr>';
            modal.classList.remove('hidden');

            try {
                // 1. ä¸‹è¼‰è³‡æ–™ (æ”¯æ´å–®ä¸€ ID æˆ– ID é™£åˆ—)
                let resPromise;
                
                // ğŸ”¥ ä¿®æ­£é»ï¼šé€™è£¡åƒæ•¸åç¨±å·²çµ±ä¸€ç‚º assignmentIdOrArray
                if (Array.isArray(assignmentIdOrArray)) {
                    // å¦‚æœæ˜¯é™£åˆ— (æ•´é«”åˆ†æ)ï¼Œä½¿ç”¨ 'in' æŸ¥è©¢ (åˆ†æ‰¹è™•ç†)
                    const chunks = [];
                    const ids = assignmentIdOrArray;
                    for (let i = 0; i < ids.length; i += 10) {
                        chunks.push(ids.slice(i, i + 10));
                    }
                    
                    const promises = chunks.map(chunk => 
                        db.collection('responses').where('assignment_id', 'in', chunk).get()
                    );
                    
                    resPromise = Promise.all(promises).then(snapshots => {
                        const allDocs = [];
                        snapshots.forEach(snap => snap.forEach(doc => allDocs.push(doc)));
                        return { 
                            size: allDocs.length, 
                            forEach: (cb) => allDocs.forEach(cb) 
                        };
                    });

                } else {
                    // åŸæœ¬çš„å–®ä¸€ç­ç´šæŸ¥è©¢
                    resPromise = db.collection('responses').where('assignment_id', '==', assignmentIdOrArray).get();
                }

                const [wsDoc, resSnap] = await Promise.all([
                    db.collection('worksheets').doc(worksheetId).get(),
                    resPromise
                ]);

                if (!wsDoc.exists) throw new Error('æ‰¾ä¸åˆ°å­¸ç¿’å–®');
                const wsData = wsDoc.data();
                const answerKey = wsData.answer_key || {}; 
                const totalStudents = resSnap.size;

                if (totalStudents === 0) {
                    const noDataHtml = '<p class="text-center text-gray-400 py-10">å°šç„¡å­¸ç”Ÿç¹³äº¤ï¼Œç„¡æ³•åˆ†æã€‚</p>';
                    leaderboardEl.innerHTML = noDataHtml;
                    tableBody.innerHTML = `<tr><td colspan="5">${noDataHtml}</td></tr>`;
                    return;
                }

                // 2. åˆå§‹åŒ–é¡Œç›®çµæ§‹
                const questionMeta = {};
                Object.keys(answerKey).forEach(key => {
                    const qData = answerKey[key];
                    // è§£æå–®å…ƒ
                    let unitLabel = '';
                    const parts = key.split('_');
                    if (parts.length > 0 && parts[0].startsWith('u')) {
                        const unitNum = parts[0].substring(1);
                        if (!isNaN(unitNum)) unitLabel = `ã€å–®å…ƒ ${unitNum}ã€‘`;
                    }
                    // æ¨™é¡Œ
                    let rawLabel = qData.label; 
                    if (!rawLabel) rawLabel = qData.note ? qData.note.substring(0, 15) + '...' : key;
                    
                    questionMeta[key] = { 
                        key: key,
                        unit: unitLabel, 
                        rawLabel: rawLabel,
                        fullLabel: unitLabel ? `${unitLabel} ${rawLabel}` : rawLabel,
                        stats: { answeredCount: 0, correct: 0, incorrect: 0, options: {} } 
                    };
                });

                // 3. çµ±è¨ˆæ•¸æ“š
                resSnap.forEach(doc => {
                    const d = doc.data();
                    const answers = d.answers || {};
                    const details = d.grading_details || {};

                    Object.keys(questionMeta).forEach(qKey => {
                        const qStat = questionMeta[qKey].stats;
                        const userAns = answers[qKey];
                        
                        const hasAnswered = (userAns !== undefined && userAns !== null && String(userAns).trim() !== '');

                        if (hasAnswered) {
                            qStat.answeredCount++; 
                            const val = String(userAns).trim();
                            qStat.options[val] = (qStat.options[val] || 0) + 1;

                            let isCorrect = null;
                            if (details[qKey] && details[qKey].is_correct !== undefined) {
                                isCorrect = details[qKey].is_correct;
                            } else {
                                const stdData = answerKey[qKey];
                                if (stdData && stdData.answer) {
                                    const studentStr = String(userAns).trim().toLowerCase();
                                    const stdStr = String(stdData.answer).trim().toLowerCase();
                                    isCorrect = (studentStr === stdStr);
                                }
                            }

                            if (isCorrect !== null) {
                                if (isCorrect) qStat.correct++;
                                else qStat.incorrect++;
                            }
                        }
                    });
                });

                // 4. è¨ˆç®—éŒ¯èª¤ç‡ä¸¦æ’åº (è‡ªç„¶æ’åº)
                const allQuestions = Object.values(questionMeta).map(q => {
                    const total = q.stats.answeredCount;
                    const errorRate = total > 0 ? (q.stats.incorrect / total) * 100 : 0;
                    return { ...q, total, errorRate };
                }).sort((a, b) => {
                    return a.key.localeCompare(b.key, undefined, { numeric: true, sensitivity: 'base' });
                });

                // 5. ç”¢ç”Ÿ Top 5 æ’è¡Œæ¦œ
                const top5 = [...allQuestions]
                    .filter(q => q.total > 0 && q.stats.incorrect > 0)
                    .sort((a, b) => b.errorRate - a.errorRate)
                    .slice(0, 5);

                leaderboardEl.innerHTML = '';
                if (top5.length === 0) {
                     leaderboardEl.innerHTML = `<div class="text-center py-8"><div class="text-4xl mb-2">ğŸ‰</div><p class="text-gray-500 font-bold">ç›®å‰æ²’æœ‰éŒ¯èª¤ç´€éŒ„</p></div>`;
                } else {
                    top5.forEach((q, idx) => {
                        const barWidth = `${q.errorRate}%`;
                        const colorClass = idx === 0 ? 'bg-red-500' : (idx === 1 ? 'bg-orange-500' : 'bg-yellow-500');
                        leaderboardEl.innerHTML += `
                            <div class="mb-3 cursor-pointer hover:bg-gray-50 p-1 rounded transition" onclick="showChartFromLeaderboard('${q.key}')">
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="font-bold text-gray-800 truncate w-3/4">${idx+1}. ${q.fullLabel}</span>
                                    <span class="text-red-600 font-bold">${Math.round(q.errorRate)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="${colorClass} h-2.5 rounded-full" style="width: ${barWidth}"></div>
                                </div>
                            </div>`;
                    });
                }

                // 6. ç”¢ç”Ÿå³å´çµ±è¨ˆè¡¨æ ¼
                tableBody.innerHTML = '';
                let lastUnit = null;

                allQuestions.forEach(q => {
                    // æ’å…¥å–®å…ƒæ¨™é¡Œåˆ—
                    if (q.unit !== lastUnit && q.unit) {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td colspan="5" class="bg-gray-200 font-bold text-gray-700 py-1 px-3 text-xs">${q.unit}</td>`;
                        tableBody.appendChild(row);
                        lastUnit = q.unit;
                    }

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-purple-50 cursor-pointer transition border-b border-gray-100 last:border-0";
                    tr.onclick = () => {
                        document.getElementById('chart-question-title').textContent = q.fullLabel;
                        renderChart(q);
                        toggleAnalysisView('chart');
                    };

                    const rateColor = q.errorRate > 50 ? 'text-red-600 font-bold' : (q.errorRate > 0 ? 'text-orange-500' : 'text-gray-400');
                    
                    tr.innerHTML = `
                        <td class="p-3 text-gray-700 font-medium">${q.rawLabel}</td>
                        <td class="p-3 text-center text-gray-500">${q.total}</td>
                        <td class="p-3 text-center text-green-600 bg-green-50/50">${q.stats.correct}</td>
                        <td class="p-3 text-center text-red-600 bg-red-50/50">${q.stats.incorrect}</td>
                        <td class="p-3 text-center ${rateColor}">${Math.round(q.errorRate)}%</td>
                    `;
                    tableBody.appendChild(tr);
                });

                window.showChartFromLeaderboard = (key) => {
                    const q = questionMeta[key];
                    if(q) {
                        document.getElementById('chart-question-title').textContent = q.fullLabel;
                        renderChart(q);
                        toggleAnalysisView('chart');
                    }
                };

            } catch (e) {
                console.error(e);
                leaderboardEl.innerHTML = `<p class="text-red-500">åˆ†æå¤±æ•—: ${e.message}</p>`;
            }
        }
 
        function renderChart(qData) {
            const ctx = document.getElementById('analysis-chart').getContext('2d');
            
            // éŠ·æ¯€èˆŠåœ–è¡¨
            if (analysisChartInstance) analysisChartInstance.destroy();

            const labels = Object.keys(qData.stats.options);
            const data = Object.values(qData.stats.options);
            
            // é¡è‰²ç”Ÿæˆ
            const bgColors = labels.map(() => 'rgba(54, 162, 235, 0.6)');
            const borderColors = labels.map(() => 'rgba(54, 162, 235, 1)');

            analysisChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é¸æ“‡äººæ•¸',
                        data: data,
                        backgroundColor: bgColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: `ä½œç­”åˆ†ä½ˆï¼š${qData.label}` }
                    }
                }
            });
        }

		window.openGradingModal = async (rid, wid, sname, mode = 'edit') => {
			currentGradingResponseId = rid; 
			currentGradingWorksheetId = wid;
			const modal = document.getElementById('grading-modal');
			const view = document.getElementById('grading-worksheet-content');
			const scoreIn = document.getElementById('grade-score');
			const commIn = document.getElementById('grade-comment');
			
			const leftPanel = document.getElementById('grading-left-panel');
			const rightPanel = document.getElementById('grading-right-panel');
			const viewCloseBtn = document.getElementById('view-mode-close-btn');

			document.getElementById('preview-content').innerHTML = ''; 
			document.getElementById('view-modal-content').innerHTML = ''; 

			document.getElementById('grading-student-name').textContent = sname;
			// å¢åŠ ä¸€å€‹æ¨™ç±¤é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
			const nameArea = document.getElementById('grading-student-name');
			const draftBadgeId = 'draft-badge-indicator';
			const oldBadge = document.getElementById(draftBadgeId);
			if(oldBadge) oldBadge.remove();

			view.innerHTML = '<p class="p-4 text-center">è¼‰å…¥ä¸­...</p>';
			scoreIn.value = ''; commIn.value = '';
			modal.classList.remove('hidden');

			// åˆ‡æ›æ¨¡å¼é¡¯ç¤º
			if (mode === 'view') {
				leftPanel.classList.remove('w-2/3'); leftPanel.classList.add('w-full');
				rightPanel.classList.add('hidden'); viewCloseBtn.classList.remove('hidden');
			} else {
				leftPanel.classList.remove('w-full'); leftPanel.classList.add('w-2/3');
				rightPanel.classList.remove('hidden'); viewCloseBtn.classList.add('hidden');
			}

			try {
				const [r, w] = await Promise.all([
					db.collection('responses').doc(rid).get(), 
					db.collection('worksheets').doc(wid).get()
				]);
				
				// 1. å–å¾—é›²ç«¯è³‡æ–™
				let rd = r.data(); 
				const wd = w.data();
				
				// ---------------------------------------------------------
				// ğŸ”¥ æ–°å¢ï¼šæª¢æŸ¥æœ¬åœ°æš«å­˜é‚è¼¯
				// ---------------------------------------------------------
				if (mode === 'edit') {
					const draftKey = `grading_draft_${rid}`;
					const localJson = localStorage.getItem(draftKey);
					
					if (localJson) {
						const draft = JSON.parse(localJson);
						// ç°¡å–®çš„æ™‚é–“æ¯”è¼ƒæˆ–ç›´æ¥è©¢å•
						const useDraft = confirm(`âš ï¸ ç³»çµ±ç™¼ç¾æ­¤ä½œæ¥­æœ‰ã€Œæœªé€å‡ºçš„æ‰¹æ”¹æš«å­˜ã€ã€‚\n\næ˜¯å¦è¼‰å…¥æš«å­˜æª”ï¼Ÿ\n(æŒ‰ã€Œå–æ¶ˆã€å‰‡è¼‰å…¥é›²ç«¯åŸå§‹è³‡æ–™)`);
						
						if (useDraft) {
							// ä½¿ç”¨æš«å­˜è³‡æ–™è¦†è“‹ rd (é›²ç«¯è³‡æ–™)
							console.log("è¼‰å…¥æš«å­˜:", draft);
							if (draft.score !== undefined) rd.score = draft.score;
							if (draft.comment !== undefined) rd.comment = draft.comment;
							// åˆä½µ grading_detailsï¼šä»¥æš«å­˜ç‚ºä¸»ï¼Œä¿ç•™åŸæœ‰çš„ key
							rd.grading_details = { ...(rd.grading_details || {}), ...draft.grading_details };
							
							// é¡¯ç¤ºæ¨™è¨˜
							nameArea.innerHTML += ` <span id="${draftBadgeId}" class="text-xs bg-gray-600 text-white px-2 py-0.5 rounded ml-2">ğŸ’¾ å·²è¼‰å…¥æš«å­˜</span>`;
						}
					}
				}
				// ---------------------------------------------------------

				view.innerHTML = wd.html_content;
				executeEmbeddedScripts(view);
				
				const ans = rd.answers || {}; 
				const details = rd.grading_details || {};
				
				let currentAutoScore = 0;
				let hasManualScore = (rd.score !== undefined && rd.score !== null && rd.score !== "");
				
				const calculatedQuestions = new Set(); 

				if(rd.comment) commIn.value = rd.comment;

				view.querySelectorAll('.worksheet-input').forEach(inp => {
					const n = inp.name; if(!n) return;
					
					// å¡«å…¥å­¸ç”Ÿç­”æ¡ˆ
					if(ans[n] !== undefined) {
						if(inp.type === 'radio' || inp.type === 'checkbox') { if(inp.value === ans[n]) inp.checked = true; }
						else inp.value = ans[n];
					}
					inp.disabled = true;

					// ç”¢ç”Ÿæ‰¹æ”¹é¢æ¿
					if (mode === 'edit') {
						let isCor = null, isInc = null, fb = '';
						let points = 0; 

						// å–å¾—è‡ªå‹•æ‰¹æ”¹é‚è¼¯èˆ‡é…åˆ†
						if (wd.answer_key && wd.answer_key[n]) {
							const key = wd.answer_key[n];
							points = parseInt(key.points) || 0; 
							if(key.note) fb = key.note;
							
							// å¦‚æœå°šæœªæœ‰äººå·¥æ‰¹æ”¹ (details[n])ï¼Œæ‰é€²è¡Œè‡ªå‹•ç®—åˆ†ç´¯åŠ 
							// ä½†å› ç‚ºæˆ‘å€‘å¯èƒ½è¼‰å…¥äº†æš«å­˜ï¼Œdetails[n] å¯èƒ½å·²ç¶“æœ‰å€¼äº†
							const stdAns = ans[n];
							if (key.answer !== null && key.answer !== undefined && stdAns !== undefined) {
								if (String(stdAns).trim() === String(key.answer).trim()) {
									if (!calculatedQuestions.has(n)) {
										currentAutoScore += points;
										calculatedQuestions.add(n);
									}
								}
							}
						}

						// æ‡‰ç”¨æ‰¹æ”¹ç‹€æ…‹ (ä¾†è‡ªé›²ç«¯ æˆ– æš«å­˜)
						if (details[n]) {
							isCor = details[n].is_correct === true;
							isInc = details[n].is_correct === false;
							// å¦‚æœæš«å­˜æœ‰è©•èªï¼Œå°±ç”¨æš«å­˜çš„ï¼Œå¦å‰‡ç”¨é è¨­/é›²ç«¯çš„
							if (details[n].feedback !== undefined) fb = details[n].feedback;
						}

						// é¿å… Radio é‡è¤‡æ¸²æŸ“
						if (inp.type === 'radio') {
							const all = view.querySelectorAll(`input[type="radio"][name="${n}"]`);
							if (inp !== all[all.length - 1]) return;
						}
						
						const panel = document.createElement('div');
						panel.className = `grading-panel ${isCor?'correct':(isInc?'incorrect':'')}`;
						if (inp.type === 'radio') panel.style.marginTop = "15px";

						const currentStatus = isCor ? 'c' : (isInc ? 'i' : '');
						panel.setAttribute('data-status', currentStatus);

						const pointsBadge = points > 0 ? `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded ml-2">é…åˆ†: ${points}</span>` : '';

						panel.innerHTML = `
							<div class="flex items-center justify-between mb-2">
								<div class="flex gap-2 items-center">
									<label class="grading-radio-label">
										<input type="radio" name="gs_${n}" value="c" data-points="${points}" ${isCor?'checked':''} onchange="updPanel(this)">
										<span class="ml-1 btn-text-correct">â­• æ­£ç¢º</span>
									</label>
									<label class="grading-radio-label">
										<input type="radio" name="gs_${n}" value="i" data-points="${points}" ${isInc?'checked':''} onchange="updPanel(this)">
										<span class="ml-1 btn-text-incorrect">âŒ éŒ¯èª¤</span>
									</label>
									${pointsBadge}
								</div>
								<button class="text-xs text-gray-400 hover:text-red-500 transition" onclick="clsGrade('${n}', this)">æ¸…é™¤è©•èª</button>
							</div>
							<input type="text" class="grading-feedback-input w-full border border-gray-300 rounded p-1 text-sm outline-none" placeholder="å€‹åˆ¥è©•èª..." value="${fb}" data-field="${n}">
						`;
						
						// æ’å…¥ DOM
						if (inp.type === 'radio') {
							panel.style.gridColumn = "1 / -1"; panel.style.width = "100%";
							const c = inp.parentNode;
							if(c.nextSibling) c.parentNode.insertBefore(panel, c.nextSibling); else c.parentNode.appendChild(panel);
						} else {
							if(inp.nextSibling) inp.parentNode.insertBefore(panel, inp.nextSibling); else inp.parentNode.appendChild(panel);
						}
					}
				});

				// è¨­å®šç¸½åˆ†æ¬„ä½
				if (mode === 'edit') {
					// å¦‚æœæš«å­˜/é›²ç«¯å·²æœ‰åˆ†æ•¸ï¼Œå°±ç”¨å·²æœ‰çš„ (hasManualScore åˆ¤æ–·é‚è¼¯éœ€ä¿®æ­£ï¼Œå› ç‚º rd å¯èƒ½è¢«æš«å­˜è¦†è“‹)
					// åªè¦ rd.score æœ‰å€¼ (åŒ…å«0)ï¼Œå°±é¡¯ç¤º rd.scoreï¼Œå¦å‰‡é¡¯ç¤ºè‡ªå‹•è¨ˆç®—çš„ currentAutoScore
					if (rd.score !== undefined && rd.score !== null && rd.score !== "") {
						scoreIn.value = rd.score;
					} else {
						scoreIn.value = currentAutoScore;
					}
				} else {
					scoreIn.value = rd.score !== undefined ? rd.score : '';
				}

			} catch(e) { console.error(e); alert(e.message); modal.classList.add('hidden'); }
		};		

        window.updPanel = (r) => { 
            const p = r.closest('.grading-panel'); 
            const oldStatus = p.getAttribute('data-status') || ''; 
            const newStatus = r.value; 
            const points = parseInt(r.getAttribute('data-points')) || 0; 
            
            p.classList.remove('correct', 'incorrect'); 
            if(newStatus==='c') p.classList.add('correct'); 
            if(newStatus==='i') p.classList.add('incorrect'); 
            
            if (oldStatus === newStatus) return; 

            const scoreInput = document.getElementById('grade-score');
            let currentTotal = parseInt(scoreInput.value) || 0;
            
            if (newStatus === 'c' && oldStatus !== 'c') {
                currentTotal += points;
            } else if (oldStatus === 'c' && newStatus !== 'c') {
                currentTotal -= points;
            }

            scoreInput.value = currentTotal;
            p.setAttribute('data-status', newStatus); 
        };

		// ğŸ”¥ [ä¿®æ”¹] æ¸…é™¤æŒ‰éˆ•é‚è¼¯ï¼šæ”¯æ´ã€Œæ¸…é™¤ã€èˆ‡ã€Œå¾©åŸ (Undo)ã€åˆ‡æ›
        window.clsGrade = (n, btn) => { 
            const p = btn.closest('.grading-panel'); 
            const input = p.querySelector('.grading-feedback-input');
            
            if (!input) return;

            // æª¢æŸ¥ç›®å‰æŒ‰éˆ•æ˜¯å¦è™•æ–¼ã€Œç­‰å¾…å¾©åŸã€ç‹€æ…‹
            const isUndoMode = btn.getAttribute('data-is-undo') === 'true';

            if (isUndoMode) {
                // ğŸŸ¢ [å¾©åŸæ¨¡å¼]ï¼šæŠŠä¹‹å‰çš„æ–‡å­—å¡«å›å»
                const prevText = input.getAttribute('data-prev-text') || '';
                input.value = prevText;

                // é‡ç½®æŒ‰éˆ•æ¨£å¼å›ã€Œæ¸…é™¤è©•èªã€
                btn.textContent = 'æ¸…é™¤è©•èª';
                btn.classList.remove('text-blue-600', 'font-bold');
                btn.classList.add('text-gray-400', 'hover:text-red-500');
                btn.setAttribute('data-is-undo', 'false');
                input.removeAttribute('data-prev-text'); // æ¸…é™¤æš«å­˜

            } else {
                // ğŸ”´ [æ¸…é™¤æ¨¡å¼]ï¼šå…ˆå‚™ä»½æ–‡å­—ï¼Œå†æ¸…ç©º
                const currentText = input.value;
                if (!currentText) return; // å¦‚æœæœ¬ä¾†å°±æ²’å­—ï¼Œå°±ä¸å‹•ä½œ

                // å‚™ä»½æ–‡å­—åˆ° input çš„å±¬æ€§ä¸­
                input.setAttribute('data-prev-text', currentText);
                input.value = '';

                // æ”¹è®ŠæŒ‰éˆ•è®Šæˆã€Œå¾©åŸã€
                btn.textContent = 'â†©ï¸ å¾©åŸ';
                btn.classList.remove('text-gray-400', 'hover:text-red-500');
                btn.classList.add('text-blue-600', 'font-bold'); // è®Šè—è‰²é¡¯çœ¼ä¸€é»
                btn.setAttribute('data-is-undo', 'true');
            }
            
            input.focus(); // ä¿æŒç„¦é»æ–¹ä¾¿æ“ä½œ
        };
		
        window.insertComment = (t) => { const el = document.getElementById('grade-comment'); el.value = el.value ? el.value+'ï¼Œ'+t : t; };

		const doGrade = async (status) => {
			const s = parseFloat(document.getElementById('grade-score').value);
			const c = document.getElementById('grade-comment').value;
			
			// å¦‚æœæ˜¯æ­£å¼çµ¦åˆ†ï¼Œå¿…é ˆå¡«å¯«åˆ†æ•¸
			if(status==='graded' && isNaN(s)) return alert('è«‹æ‰“åˆ†');
			
			// ä½¿ç”¨æ–°å¯«çš„ collectCurrentGradingData ä¾†ä¿æŒé‚è¼¯ä¸€è‡´ (ç¨å¾®ä¿®æ”¹ä»¥ç¬¦åˆ db å¯«å…¥æ ¼å¼)
			const btn = document.getElementById(status==='graded'?'submit-grade-btn':'return-correction-btn');
			btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­...';

			// é‡æ–°è’é›†ä¸€æ¬¡è³‡æ–™ï¼Œç¢ºä¿æ˜¯æœ€æ–°ç‹€æ…‹
			const data = collectCurrentGradingData();
			
			try {
				await db.collection('responses').doc(currentGradingResponseId).update({
					score: isNaN(s) ? 0 : s, 
					comment: c, 
					grading_details: data.grading_details, // ä½¿ç”¨ helper è’é›†çš„ details
					status: status,
					graded_at: firebase.firestore.FieldValue.serverTimestamp(), 
					graded_by: currentUser.uid
				});
				
				// ---------------------------------------------------------
				// ğŸ”¥ æ–°å¢ï¼šé€å‡ºæˆåŠŸå¾Œï¼Œæ¸…é™¤å°æ‡‰çš„ LocalStorage æš«å­˜
				// ---------------------------------------------------------
				const draftKey = `grading_draft_${currentGradingResponseId}`;
				localStorage.removeItem(draftKey);
				// ---------------------------------------------------------

				alert('å®Œæˆï¼');
				document.getElementById('grading-modal').classList.add('hidden');
				document.getElementById('submission-list-modal').classList.add('hidden'); 
				loadGradingList(); 
			} catch(e) { 
				alert(e.message); 
			} finally { 
				btn.disabled=false; 
				btn.textContent=status==='graded'?'âœ… é€å‡ºæˆç¸¾':'â†©ï¸ é€€å›è¨‚æ­£'; 
			}
		};
        document.getElementById('submit-grade-btn').onclick = () => doGrade('graded');
        document.getElementById('return-correction-btn').onclick = () => doGrade('needs_correction');
		
		window.viewSourceCode = (id) => {
			const data = worksheetsCache[id];
			if (!data) return;
			document.getElementById('view-src-html').value = data.html_content || '';
			const jsonStr = data.answer_key ? JSON.stringify(data.answer_key, null, 4) : '{}';
			document.getElementById('view-src-json').value = jsonStr;
			document.getElementById('source-code-modal').classList.remove('hidden');
		};

		window.copyToClipboard = (elementId, btn) => {
			const el = document.getElementById(elementId);
			if (!el) return;
			el.select();
			el.setSelectionRange(0, 99999); 
			navigator.clipboard.writeText(el.value).then(() => {
				const originalContent = btn.innerHTML;
				btn.textContent = 'âœ… å·²è¤‡è£½ï¼';
				setTimeout(() => {
					btn.innerHTML = originalContent;
				}, 1500);
			}).catch(err => {
				console.error('è¤‡è£½å¤±æ•—', err);
				alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚');
			});
		};
		
		// è§¸ç™¼é€€å‡ºç¢ºèª
		window.confirmGradingExit = () => {
			// ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœæ˜¯æª¢è¦–æ¨¡å¼ (view mode)ï¼Œç›´æ¥é—œé–‰å³å¯
			const rightPanel = document.getElementById('grading-right-panel');
			if (rightPanel.classList.contains('hidden')) {
				document.getElementById('grading-modal').classList.add('hidden');
				return;
			}
			document.getElementById('grading-exit-modal').classList.remove('hidden');
		};

		// æš«å­˜ä¸¦é€€å‡º
		window.saveDraftAndExit = () => {
			try {
				const data = collectCurrentGradingData();
				const key = `grading_draft_${currentGradingResponseId}`;
				localStorage.setItem(key, JSON.stringify(data));
				
				// è¦–è¦ºå›é¥‹ (å¯é¸)
				console.log('æ‰¹æ”¹æš«å­˜å·²å„²å­˜', data);
				
				document.getElementById('grading-exit-modal').classList.add('hidden');
				document.getElementById('grading-modal').classList.add('hidden');
			} catch (e) {
				alert('æš«å­˜å¤±æ•— (å¯èƒ½æ˜¯å„²å­˜ç©ºé–“å·²æ»¿)');
			}
		};

		// ç›´æ¥é€€å‡º
		window.discardAndExit = () => {
			document.getElementById('grading-exit-modal').classList.add('hidden');
			document.getElementById('grading-modal').classList.add('hidden');
		};
    </script>
	<div id="grading-exit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-[60]">
    <div class="bg-white rounded-lg shadow-xl w-96 p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">âš ï¸ å°šæœªé€å‡ºæˆç¸¾</h3>
        <p class="text-gray-600 mb-6">æ‚¨æ­£åœ¨æ‰¹æ”¹é€™ä»½ä½œæ¥­ï¼Œå°šæœªé€å‡ºåˆ°é›²ç«¯ã€‚è«‹å•è¦å¦‚ä½•è™•ç†ï¼Ÿ</p>
        
        <div class="flex flex-col gap-3">
            <button onclick="saveDraftAndExit()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                ğŸ’¾ æš«å­˜ä¸¦é€€å‡º <span class="text-xs font-normal opacity-80">(ä¸‹æ¬¡è¼‰å…¥)</span>
            </button>
            <button onclick="discardAndExit()" class="w-full bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 px-4 rounded transition">
                ğŸšª ç›´æ¥é€€å‡º <span class="text-xs font-normal opacity-70">(ä¸å„²å­˜)</span>
            </button>
            <button onclick="document.getElementById('grading-exit-modal').classList.add('hidden')" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded transition">
                â†©ï¸ å›åˆ°æ‰¹æ”¹
            </button>
        </div>
    </div>
</div>
</body>
</html>
